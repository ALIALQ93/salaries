<!DOCTYPE html>
<html lang="ar" dir="rtl" style="font-variant-numeric: lining-nums;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayRose | نظام الرواتب الاحترافي - Powered by ROSEMARY</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --gray: #6b7280;
            --light: #f3f4f6;
            --white: #ffffff;
            --border: #e5e7eb;
            
            /* متغيرات التحكم في المظهر */
            --row-height: 40px;
            --table-font-size: 11px;
            --column-padding: 6px;
            --header-height: 50px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            overflow-x: hidden;
        }
        
        /* فرض استخدام الأرقام الإنجليزية دائماً */
        body, input, select, td, th, span, div, p, h1, h2, h3, h4, h5, h6 {
            font-variant-numeric: lining-nums;
        }
        
        /* للتأكد من استخدام الأرقام الإنجليزية في اللغة العربية */
        html[lang="ar"] body,
        html[lang="ar"] input,
        html[lang="ar"] select,
        html[lang="ar"] td,
        html[lang="ar"] th,
        html[lang="ar"] span,
        html[lang="ar"] div {
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif !important;
        }
        
        /* منع تحويل الأرقام إلى الهندية-العربية */
        * {
            font-feature-settings: "tnum" 1;
            -moz-font-feature-settings: "tnum" 1;
            -webkit-font-feature-settings: "tnum" 1;
        }
        
        /* التأكد من عرض الأرقام اللاتينية */
        [lang="ar"] {
            font-variant-numeric: lining-nums tabular-nums;
        }
/* شاشة تسجيل الدخول */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 50px 40px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 100%;
            text-align: center;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-box .logo {
            font-size: 60px;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .login-box h1 {
            color: var(--primary);
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .login-box p {
            color: var(--gray);
            margin-bottom: 35px;
            font-size: 15px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--dark);
        }

        .form-group input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn-login {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .login-footer {
            margin-top: 25px;
            font-size: 13px;
            color: var(--gray);
        }

        .users-list {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            margin-top: 30px;
            text-align: right;
        }

        .users-list h3 {
            color: var(--dark);
            font-size: 14px;
            margin-bottom: 15px;
        }

        .user-item {
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
        }

        .user-item span {
            font-size: 13px;
            color: var(--dark);
        }

        .user-item .badge {
            background: var(--primary);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
        }
/* التطبيق الرئيسي */
        #app {
            display: none;
        }

        .lock-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 99999;
            align-items: center;
            justify-content: center;
        }

        .lock-overlay.active {
            display: flex;
        }

        .lock-message {
            background: white;
            padding: 60px;
            border-radius: 24px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .lock-message h2 {
            color: var(--danger);
            font-size: 32px;
            margin-bottom: 20px;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 99998;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .container {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0;
            background: var(--white);
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--white);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 22px;
            font-weight: 700;
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .user-info .avatar {
            width: 32px;
            height: 32px;
            background: white;
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .header-btn, .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: var(--white);
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header-btn:hover, .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .header-btn:active, .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8b 100%);
        }

        /* ========== Enhanced Header Components ========== */
        
        /* Top Bar Enhancements */
        .header {
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .brand-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-logo {
            font-size: 28px;
            animation: brandPulse 3s ease-in-out infinite;
        }

        @keyframes brandPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        .brand-info h1 {
            font-size: 22px;
            font-weight: 700;
            margin: 0;
            letter-spacing: 0.3px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .brand-info p {
            font-size: 10px;
            color: rgba(255,255,255,0.85);
            margin: -2px 0 0 0;
            font-weight: 500;
        }

        /* Quick Search */
        .quick-search {
            position: relative;
            display: flex;
            align-items: center;
        }

        .quick-search input {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            padding: 8px 35px 8px 15px;
            border-radius: 25px;
            color: white;
            font-size: 13px;
            width: 200px;
            transition: all 0.3s;
            outline: none;
        }

        .quick-search input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .quick-search input:focus {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            width: 260px;
        }

        .quick-search-icon {
            position: absolute;
            right: 12px;
            font-size: 16px;
            pointer-events: none;
        }

        /* Year Selector Enhanced */
        .year-selector-enhanced {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.2);
            padding: 6px 8px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .year-selector-enhanced button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 9px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            line-height: 1;
        }

        .year-selector-enhanced button:hover {
            background: rgba(255,255,255,0.35);
            transform: scale(1.08);
        }

        .year-selector-enhanced select {
            background: rgba(255,255,255,0.25);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            outline: none;
            min-width: 75px;
        }

        .year-selector-enhanced select option {
            background: #667eea;
            color: white;
        }

        /* Notifications Bell */
        .notification-bell {
            position: relative;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 9px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-bell:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: scale(1.05);
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* User Menu Enhanced */
        .user-menu {
            position: relative;
        }

        .user-info-enhanced {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px 5px 5px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .user-info-enhanced:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255,255,255,0.5);
        }

        .user-info-enhanced .avatar {
            width: 34px;
            height: 34px;
            background: white;
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .user-details {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            line-height: 1.3;
        }

        .user-name {
            font-size: 13px;
            font-weight: 700;
        }

        .user-role {
            font-size: 10px;
            opacity: 0.85;
            font-weight: 500;
        }

        .dropdown-arrow {
            font-size: 11px;
            transition: transform 0.3s;
            margin-left: 3px;
        }

        .user-menu.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        /* User Dropdown */
        .user-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.25);
            min-width: 240px;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s;
            z-index: 1001;
        }

        .user-menu.active .user-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-dropdown-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 18px;
            color: white;
            text-align: center;
        }

        .avatar-large {
            width: 55px;
            height: 55px;
            background: white;
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 22px;
            margin: 0 auto 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .user-dropdown-header h3 {
            margin: 0;
            font-size: 15px;
            font-weight: 700;
        }

        .user-dropdown-header p {
            margin: 4px 0 0 0;
            font-size: 12px;
            opacity: 0.9;
        }

        .user-dropdown-menu {
            padding: 6px;
        }

        .user-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            color: var(--dark);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
            font-size: 13px;
        }

        .user-dropdown-item:hover {
            background: #f3f4f6;
        }

        .user-dropdown-item span:first-child {
            font-size: 16px;
            width: 18px;
            text-align: center;
        }

        .user-dropdown-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 6px 0;
        }

        .user-dropdown-item.danger {
            color: #ef4444;
        }

        .user-dropdown-item.danger:hover {
            background: #fef2f2;
        }

        /* Navigation Bar */
        .nav-bar {
            display: flex;
            gap: 5px;
            padding: 0 25px 10px;
        }

        .nav-item {
            background: rgba(255,255,255,0.15);
            color: white;
            padding: 8px 18px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            font-weight: 600;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
        }

        .nav-item.active {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }

        .nav-item span:first-child {
            font-size: 16px;
        }

        /* Breadcrumbs */
        .breadcrumbs {
            background: rgba(255,255,255,0.1);
            padding: 8px 25px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .breadcrumb-item {
            color: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .breadcrumb-item.active {
            color: white;
            font-weight: 600;
        }

        .breadcrumb-separator {
            color: rgba(255,255,255,0.5);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: none;
            padding: 8px 16px;
            font-size: 13px;
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: none;
            color: white;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 13px;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
/* لوحة التحكم في المظهر */
        .appearance-panel {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 30px;
            border: 2px solid #bae6fd;
        }

        .appearance-panel h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .appearance-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .control-group input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #d1d5db;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }

        .control-value {
            display: inline-block;
            background: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 700;
            color: var(--primary);
            min-width: 50px;
            text-align: center;
        }

        .reset-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        /* القوائم */
        .nav-tabs {
            display: flex;
            gap: 8px;
            padding: 20px 30px;
            background: var(--light);
            border-bottom: 2px solid var(--border);
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: var(--white);
            color: var(--dark);
            cursor: pointer;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--white);
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background: var(--white);
            min-width: 280px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
            z-index: 1000;
            border-radius: 16px;
            margin-top: 8px;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            padding: 14px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: all 0.2s ease;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dropdown-item:hover {
            background: linear-gradient(90deg, var(--primary) 0%, transparent 100%);
            color: var(--white);
        }

        .dropdown-item .project-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .dropdown-item:hover .project-actions {
            opacity: 1;
        }

        .project-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .project-action-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        .project-switcher {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .project-switcher-label {
            color: rgba(15, 23, 42, 0.7);
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .project-switcher-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .project-switch-btn {
            border: none;
            border-radius: 999px;
            padding: 8px 18px;
            background: rgba(99, 102, 241, 0.12);
            color: #4338ca;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .project-switch-btn .count {
            background: rgba(67, 56, 202, 0.18);
            color: #312e81;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px;
        }

        .project-switch-btn:hover {
            background: rgba(99, 102, 241, 0.2);
            transform: translateY(-1px);
        }

        .project-switch-btn.active {
            background: linear-gradient(135deg, #6366f1 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.25);
        }

        .project-switch-btn.active .count {
            background: rgba(255, 255, 255, 0.25);
            color: white;
        }

        .dropdown-item.add-new {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: var(--white);
            font-weight: 600;
        }
/* المحتوى والجداول */
        .content {
            padding: 20px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .actions button {
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .actions button:active {
            transform: translateY(0);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--white);
            padding: 28px;
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border-top: 4px solid var(--primary);
        }

        .stat-card:hover {
            transform: translateY(-8px);
        }

        .stat-card h3 {
            font-size: 14px;
            margin-bottom: 16px;
            opacity: 0.8;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary);
        }

        .filter-section {
            background: white;
            padding: 24px;
            border-radius: 14px;
            margin-bottom: 25px;
            border: 2px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            min-width: 180px;
        }

        .filter-select, .search-box {
            padding: 12px 16px;
            border: 2px solid var(--primary);
            border-radius: 10px;
            font-size: 14px;
            background: var(--white);
            font-weight: 500;
        }

        .table-container {
            overflow-x: auto;
            overflow-y: auto;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            background: var(--white);
            border: 1px solid #e5e7eb;
            position: relative;
        }
        
        .table-container::-webkit-scrollbar {
            height: 10px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 10px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8b 100%);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--white);
            font-size: var(--table-font-size);
            font-family: 'Segoe UI', 'Arial', sans-serif;
            box-shadow: inset 0 0 0 1px #e5e7eb;
        }

        /* صف صناديق التحديد لتثبيت الأعمدة - مثبت في الأعلى */
        .pin-checkbox-row {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            position: sticky;
            top: 0;
            z-index: 101;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.25);
        }
        
        /* التأكد من أن صف صناديق التحديد يبقى في الأعلى عند التمرير العمودي */
        .table-container {
            position: relative;
        }
        
        .pin-checkbox-row th {
            padding: 6px var(--column-padding);
            text-align: center;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            height: auto;
        }
        
        .pin-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #f59e0b;
        }
        
        .pin-checkbox:checked {
            accent-color: #10b981;
        }
        
        /* الأعمدة المثبتة - للتمرير الأفقي فقط */
        /* ملاحظة: القيم left/right يتم تعيينها ديناميكياً من JavaScript */
        th.pinned-column,
        td.pinned-column {
            position: sticky;
            z-index: 10;
        }
        
        th.pinned-column {
            z-index: 102;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        [dir="rtl"] th.pinned-column {
            box-shadow: -2px 0 4px rgba(0,0,0,0.1);
        }
        
        td.pinned-column {
            z-index: 9;
            box-shadow: 2px 0 4px rgba(0,0,0,0.05);
            background: white;
        }
        
        [dir="rtl"] td.pinned-column {
            box-shadow: -2px 0 4px rgba(0,0,0,0.05);
        }
        
        tbody tr:nth-child(even) td.pinned-column {
            background: #f8fafc;
        }
        
        tbody tr:nth-child(odd) td.pinned-column {
            background: white;
        }
        
        .pin-checkbox-row th.pinned-column {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            z-index: 103;
        }
        
        /* عند وجود صف صناديق التحديد */
        table.has-pin-checkbox-row thead {
            position: relative;
        }
        
        table.has-pin-checkbox-row thead tr:not(.pin-checkbox-row) {
            position: sticky;
            top: 35px; /* ارتفاع صف صناديق التحديد */
            z-index: 100;
        }
        
        table.has-pin-checkbox-row thead tr:not(.pin-checkbox-row) th {
            position: relative;
        }
        
        table.has-pin-checkbox-row .pin-checkbox-row th.pinned-column {
            z-index: 103;
        }
        
        table.has-pin-checkbox-row thead tr:not(.pin-checkbox-row) th.pinned-column {
            z-index: 102;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.25);
        }

        th {
            padding: 10px var(--column-padding);
            text-align: center;
            font-weight: 700;
            font-size: calc(var(--table-font-size) + 1px);
            white-space: nowrap;
            height: var(--header-height);
            position: relative;
            user-select: none;
            border: 1px solid rgba(255,255,255,0.2);
            border-left: 1px solid rgba(255,255,255,0.1);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        th:first-child {
            border-left: none;
        }
        
        /* مقبض تغيير حجم العمود */
        .resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 8px;
            height: 100%;
            cursor: col-resize;
            user-select: none;
            background: transparent;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .resizer:hover {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
        }
        
        .resizer.resizing {
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.6), transparent);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            width: 3px;
        }
        
        th.resizing {
            border-right: 3px solid #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        /* Tooltip للمقبض */
        .resizer::before {
            content: attr(title);
            position: absolute;
            bottom: -30px;
            right: -40px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        
        .resizer:hover::before {
            opacity: 1;
        }

        td {
            padding: 8px var(--column-padding);
            text-align: center;
            border: 1px solid #e5e7eb;
            border-right: 1px solid #d1d5db;
            font-size: var(--table-font-size);
            height: var(--row-height);
            background: white;
            position: relative;
            cursor: default;
            transition: all 0.15s ease;
        }
        
        td:hover {
            background: #f0f9ff !important;
            box-shadow: inset 0 0 0 2px #bae6fd;
        }
        
        /* الخلية المحددة - تبدو مثل Excel */
        td.selected-cell {
            background: #dbeafe !important;
            box-shadow: inset 0 0 0 2px #3b82f6 !important;
            outline: 2px solid #3b82f6;
            outline-offset: -2px;
            z-index: 10;
        }
        
        /* تأثير الخلايا القابلة للتعديل */
        td.editable {
            cursor: cell;
        }
        
        td.editable:hover::after {
            content: '✎';
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 10px;
            color: #6366f1;
            opacity: 0.5;
        }
        
        /* الخلية في وضع التعديل */
        td.editing {
            padding: 0;
            background: white !important;
            box-shadow: inset 0 0 0 2px #6366f1 !important;
        }
        
        td.editing input {
            width: 100%;
            height: 100%;
            border: none;
            padding: 8px var(--column-padding);
            font-size: var(--table-font-size);
            text-align: center;
            background: white;
            outline: none;
        }

        tbody tr:nth-child(even) {
            background: #fafafa;
        }
        
        tbody tr:nth-child(even) td {
            background: #fafafa;
        }

        tbody tr:hover td {
            background: #f5f5f5;
        }

        tbody tr.dragging {
            opacity: 0.5;
        }

        tbody tr.drag-over {
            border-top: 3px solid var(--primary);
        }
        
        /* تحسين تصميم الصف المحدد */
        tbody tr.selected-row td {
            background: #eff6ff !important;
            font-weight: 500;
        }

        input[type="text"],
        input[type="number"],
        input[type="password"],
        input[type="checkbox"],
        select {
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: var(--table-font-size);
            text-align: center;
            background: white;
            transition: all 0.2s ease;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="password"]:focus,
        select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* تحسينات إضافية للخلايا القابلة للتعديل */
        td.excel-cell {
            font-weight: 600 !important;
            position: relative;
        }
        
        td.excel-cell:hover {
            background: #fde68a !important;
            cursor: cell;
            box-shadow: inset 0 0 0 2px #fbbf24 !important;
        }
        
        td.excel-cell.selected-cell {
            background: #fef3c7 !important;
            box-shadow: inset 0 0 0 2px #f59e0b !important;
            outline: 2px solid #f59e0b;
        }
        
        /* تأثير النبض للخلايا القابلة للتعديل */
        @keyframes cellHighlight {
            0%, 100% { box-shadow: inset 0 0 0 2px #fbbf24; }
            50% { box-shadow: inset 0 0 0 2px #f59e0b; }
        }
        
        td.excel-cell.editing {
            animation: cellHighlight 0.5s ease;
        }
        
        /* مؤشر الزاوية للخلايا القابلة للتعديل */
        td.excel-cell::before {
            content: '';
            position: absolute;
            top: 2px;
            right: 2px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 6px 6px 0;
            border-color: transparent #f59e0b transparent transparent;
            opacity: 0.4;
        }
        
        td.excel-cell:hover::before {
            opacity: 1;
        }

        .locked-field {
            background: #fee2e2 !important;
            border-color: #fca5a5 !important;
            cursor: not-allowed;
        }
        
        /* ========== Excel-Like Filter Dropdown ========== */
        .filter-icon {
            display: inline-block;
            margin-left: 8px;
            cursor: pointer;
            font-size: 14px;
            opacity: 0.6;
            transition: all 0.2s ease;
            color: rgba(255, 255, 255, 0.7);
            user-select: none;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .filter-icon:hover {
            opacity: 1;
            color: white;
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.15);
        }
        
        .filter-icon.active {
            opacity: 1;
            background: #10b981;
            color: white;
            font-weight: bold;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
        }
        
        th.filtered {
            background: linear-gradient(180deg, #d1fae5 0%, #a7f3d0 100%) !important;
            color: #065f46 !important;
        }
        
        .filter-dropdown {
            position: fixed !important;
            background: white !important;
            border: 3px solid #3b82f6 !important;
            border-radius: 12px !important;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3) !important;
            padding: 15px !important;
            min-width: 280px !important;
            max-width: 400px !important;
            max-height: 70vh !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            z-index: 999999 !important;
            display: none;
            margin-top: 0 !important;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }
        
        .filter-dropdown.show {
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* تحسين scrollbar للنافذة */
        .filter-dropdown::-webkit-scrollbar {
            width: 8px;
        }
        
        .filter-dropdown::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .filter-dropdown::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 4px;
        }
        
        .filter-dropdown::-webkit-scrollbar-thumb:hover {
            background: #2563eb;
        }
        
        /* التأكد من أن النافذة قابلة للتمرير حتى عند وجود عدد قليل من الأسطر */
        .filter-options {
            max-height: calc(70vh - 200px);
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .filter-options::-webkit-scrollbar {
            width: 6px;
        }
        
        .filter-options::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .filter-options::-webkit-scrollbar-thumb {
            background: #60a5fa;
            border-radius: 3px;
        }
        
        /* التأكد من أن النافذة تبقى في المقدمة حتى عند التمرير */
        .filter-dropdown.show {
            display: block !important;
            animation: filterFadeIn 0.3s ease;
        }
        
        /* منع أي عنصر آخر من إخفاء النافذة */
        .table-container,
        table,
        thead,
        tbody,
        th,
        td {
            position: relative;
        }
        
        .table-container {
            z-index: 1;
        }
        
        table {
            z-index: 1;
        }
        
        thead {
            z-index: 100;
        }
        
        th.pinned-column {
            z-index: 102;
        }
        
        @keyframes filterFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .filter-search {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 14px;
            background: #f9fafb;
            transition: all 0.2s;
        }
        
        .filter-search:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
            background: white;
        }
        
        .filter-options {
            max-height: 280px;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px;
            background: white;
        }
        
        .filter-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s ease;
            background: white;
            margin-bottom: 4px;
        }
        
        .filter-option:hover {
            background: #dbeafe;
            transform: translateX(-2px);
        }
        
        .filter-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #3b82f6;
        }
        
        .filter-option label {
            flex: 1;
            cursor: pointer;
            user-select: none;
            color: #1f2937;
        }
        
        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px solid #e5e7eb;
        }
        
        .filter-actions button {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 700;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .filter-apply {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .filter-apply:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }
        
        .filter-apply:active {
            transform: translateY(0);
        }
        
        .filter-clear {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .filter-clear:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }
        
        .filter-clear:active {
            transform: translateY(0);
        }
        
        .filter-select-all {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #1f2937;
            border: 2px solid #d1d5db;
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 700;
            transition: all 0.2s ease;
            display: block;
            width: 100%;
        }
        
        .filter-select-all:hover {
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            border-color: #9ca3af;
        }
        
        .filter-select-all:active {
            transform: scale(0.98);
        }
        
        .filter-count {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            padding: 8px 12px;
            text-align: center;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .currency-input-group {
            display: flex;
            gap: 4px;
        }

        .currency-input-group input {
            flex: 1;
            min-width: 50px;
        }

        .currency-input-group select {
            width: 55px;
            padding: 6px 2px;
        }
        
        /* تحسين أعمدة العملة المنفصلة */
        td select {
            width: 100%;
            min-width: 65px;
            padding: 6px 4px;
            text-align: center;
            font-weight: 600;
            background: #fef3c7;
            border: 1px solid #fbbf24;
        }
        
        td select:focus {
            background: #fde68a;
            border-color: #f59e0b;
        }
        
        td input[type="number"] {
            width: 100%;
            min-width: 70px;
            text-align: center;
        }
        
        /* تحسين مظهر خلية الدوام */
        td[title*="الدوام"] {
            min-width: 120px;
            cursor: pointer !important;
            transition: all 0.2s ease;
        }
        
        td[title*="الدوام"]:hover {
            background: #d1fae5 !important;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        }

        .reorder-btn {
            background: transparent;
            border: none;
            cursor: move;
            font-size: 16px;
            padding: 2px;
        }

        .reorder-btn:hover {
            transform: scale(1.2);
        }

        .selected-count {
            background: var(--warning);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
        }
/* النوافذ المنبثقة */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: var(--white);
            padding: 0;
            border-radius: 20px;
            max-width: 750px;
            width: 95%;
            max-height: 92vh;
            overflow: hidden;
            box-shadow: 0 25px 70px rgba(0,0,0,0.4);
            animation: slideUp 0.4s ease;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px 35px;
            margin: 0;
            border-radius: 20px 20px 0 0;
        }
        
        .modal-header h2 {
            color: white;
            font-size: 24px;
            margin: 0;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .modal-header p {
            color: rgba(255,255,255,0.9);
            margin: 8px 0 0 0;
            font-size: 13px;
        }
        
        .modal-body {
            padding: 30px 35px;
            max-height: calc(92vh - 180px);
            overflow-y: auto;
        }
        
        /* تحسين scrollbar */
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }
        
        .modal-body::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        
        .modal-body::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
            margin-bottom: 8px;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 13px;
            color: #374151;
        }
        
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 11px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }
        
        .form-group small {
            display: block;
            margin-top: 6px;
            font-size: 11px;
            color: #6b7280;
            line-height: 1.4;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 20px 35px;
            background: #f9fafb;
            border-radius: 0 0 20px 20px;
            border-top: 1px solid #e5e7eb;
        }
        
        .modal-actions button {
            min-width: 120px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--gray);
        }

        .empty-state::before {
            content: '📋';
            font-size: 80px;
            display: block;
            margin-bottom: 20px;
        }

        .summary-box {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            border: 2px solid #60a5fa;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #93c5fd;
        }

        .total-summary {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            padding: 28px;
            border-radius: 16px;
            margin: 30px 0;
            border: 3px solid #10b981;
        }

        .total-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .total-item {
            background: var(--white);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .total-item .label {
            font-size: 13px;
            color: var(--gray);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .total-item .value {
            font-size: 22px;
            font-weight: 700;
            color: #059669;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .checkbox-item:hover {
            background: var(--light);
        }

        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .comparison-card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .comparison-stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        /* تقويم الدوام */
        .attendance-day {
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .attendance-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .attendance-day.weekend {
            background: #fef3c7;
            border-color: #fbbf24;
        }

        .attendance-day.full-day {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #10b981;
            color: #065f46;
        }

        .attendance-day.half-day {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
            color: #92400e;
        }

        .attendance-day.paid-leave {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-color: #3b82f6;
            color: #1e40af;
        }

        .attendance-day.absent {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-color: #ef4444;
            color: #991b1b;
        }

        .attendance-day.custom-hours {
            background: linear-gradient(135deg, #e9d5ff 0%, #d8b4fe 100%);
            border-color: #a855f7;
            color: #6b21a8;
        }

        .attendance-day .day-number {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .attendance-day .day-name {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 8px;
        }

        .attendance-day .day-type {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(255,255,255,0.5);
            margin-bottom: 5px;
        }

        .attendance-day .day-hours {
            font-size: 11px;
            opacity: 0.8;
        }

        .attendance-day select {
            width: 100%;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.2);
            font-size: 11px;
            margin-top: 5px;
            background: white;
        }

        .attendance-day input[type="time"] {
            width: 100%;
            padding: 4px;
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.2);
            font-size: 11px;
            margin: 2px 0;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-box .value {
            font-size: 24px;
            font-weight: 700;
        }

        .info-tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            color: var(--primary);
            margin-left: 5px;
        }

        .info-tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: var(--dark);
            color: white;
            text-align: center;
            border-radius: 8px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .info-tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* الإشعارات */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 100000;
            animation: slideInRight 0.3s ease;
            min-width: 300px;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification.success {
            border-right: 4px solid #10b981;
        }

        .notification.error {
            border-right: 4px solid #ef4444;
        }

        .notification-icon {
            font-size: 24px;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 13px;
            color: var(--gray);
        }

        /* User Management Styles */
        .page-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary);
        }

        .page-header h1 {
            color: var(--dark);
            font-size: 32px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .page-header p {
            color: var(--gray);
            font-size: 16px;
            margin: 0;
        }

        .action-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .card {
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 25px 30px;
            border-bottom: 2px solid var(--border);
        }

        .card-header h3 {
            color: var(--dark);
            font-size: 20px;
            margin: 0 0 5px 0;
        }

        .card-body {
            padding: 30px;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
            font-size: 16px;
        }

        .loading:before {
            content: "⏳ ";
            font-size: 32px;
            display: block;
            margin-bottom: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 15px;
        }

        .empty-state p {
            color: var(--gray);
            font-size: 16px;
        }

/* ========================================================================== */
/* ======================== نظام الطباعة المُحسّن ========================== */
/* ========================================================================== */
/* تنسيقات CSS موحدة ومحسّنة للطباعة الاحترافية                              */
/* - إخفاء جميع عناصر الواجهة التفاعلية                                      */
/* - تنسيقات ألوان محسّنة مع دعم -webkit-print-color-adjust                 */
/* - تحكم في فواصل الصفحات لمنع تقطيع الجداول                               */
/* - دعم التدرجات اللونية والخلفيات الملونة للعناوين                         */
/* - تنسيق موحد لجميع الجداول والبطاقات                                     */
/* ========================================================================== */
        @media print {
            /* إعدادات الصفحة الأساسية */
            @page {
                size: A3 landscape; /* تغيير إلى A3 للطباعة على ورق أكبر */
                margin: 10mm 8mm 30mm 8mm; /* زيادة الهامش السفلي للتذييل الثابت بشكل أكبر */
            }
            
            /* إعادة تعيين الخلفية والتباعد */
            body { 
                background: white !important; 
                padding: 0;
                margin: 0;
                padding-bottom: 250px !important; /* مسافة كبيرة لمنع التداخل مع التذييل في A3 */
                min-height: 100vh !important;
                padding-bottom: 180px !important; /* مساحة للتذييل الثابت */
            }
            
            .container { 
                box-shadow: none; 
                border-radius: 0; 
                max-width: 100%;
                padding: 0;
            }
            
            /* ========== إخفاء عناصر الواجهة ========== */
            .header,
            .nav-tabs, 
            .actions, 
            .action-bar,
            .btn, 
            .filter-section, 
            .header-actions,
            .modal, 
            .dropdown, 
            input[type="checkbox"], 
            .reorder-btn,
            .appearance-panel, 
            .notification, 
            .user-info,
            .page-header p,
            .stat-card,
            .dashboard-stats,
            .header-btn,
            .no-print,
            .resizer,
            button,
            .modal-overlay,
            .column-visibility-panel { 
                display: none !important; 
                visibility: hidden !important;
            }
            
            /* ========== عرض العناوين ========== */
            .page-header h1,
            .card-header h3 {
                display: block !important;
                color: #1e293b !important;
                font-size: 14px !important; /* زيادة حجم الخط لـ A3 */
                text-align: center;
                margin: 8px 0 !important; /* زيادة المسافة لـ A3 */
                padding: 10px 8px !important; /* زيادة padding لـ A3 */
                background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%) !important;
                border: 1px solid #94a3b8;
                border-radius: 4px;
                font-weight: 700;
                page-break-after: avoid;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* تقليل ارتفاع رأس الصفحة ككل في الطباعة */
            .page-header {
                margin: 5px 0 !important;
                padding: 5px !important;
            }
            
            /* ========== تنسيق البطاقات ========== */
            .card {
                border: none;
                margin-bottom: 10px;
                page-break-inside: avoid;
                box-shadow: none;
            }
            
            .card-header {
                display: block !important;
                background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%) !important;
                padding: 8px 5px !important;
                border-bottom: 1px solid #94a3b8;
                page-break-after: avoid;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .card-body {
                padding: 0 !important;
            }
            
            /* ========== تنسيق الجداول - محسّن للطباعة المثالية ========== */
            .table-container {
                box-shadow: none;
                border: 2px solid #64748b;
                border-radius: 0;
                overflow: visible;
                page-break-inside: auto;
                margin-bottom: 10px;
            }
            
            /* مسافة منظمة للجداول العادية */
            .table-container:not(:last-child) {
                margin-bottom: 10px;
            }
            
            /* مسافة منظمة للجداول - مع تقسيم 25 صف لكل صفحة */
            .table-container {
                margin-bottom: 50px !important; /* مسافة بين الجداول */
            }
            
            .table-container:last-child {
                margin-bottom: 200px !important; /* مسافة كبيرة للجدول الأخير لمنع التداخل */
                padding-bottom: 0;
            }
            
            /* مسافة منظمة لآخر صف في الجدول */
            .table-container:last-child tbody tr:last-child td {
                padding-bottom: 30px !important; /* زيادة المسافة في آخر صف */
            }
            
            .table-container:last-child tfoot td {
                padding-bottom: 30px !important; /* زيادة المسافة في صف المجموع */
            }
            
            /* مسافة في آخر صف من كل جدول */
            tbody tr:last-child td {
                padding-bottom: 20px !important;
            }
            
            /* منع تقطيع الجدول قبل التذييل */
            .table-container:last-child table {
                page-break-after: avoid !important;
            }
            
            /* مسافات منظمة لصفوف المجموع */
            tfoot td { 
                padding: 3px 1px !important;
                padding-bottom: 10px !important;
            }
            
            /* مسافة منظمة لآخر صف في الجدول */
            tbody tr:last-child td {
                padding-bottom: 5px !important;
            }
            
            table { 
                width: 100% !important;
                font-size: 5px !important; /* زيادة حجم الخط لـ A3 */
                page-break-inside: auto;
                border-collapse: collapse;
                position: relative !important;
                z-index: 10 !important; /* الجدول في المقدمة */
                table-layout: fixed !important;
                max-width: 100% !important;
            }
            
            /* ========== رأس الجدول ========== */
            thead { 
                display: table-header-group !important;
                background: linear-gradient(135deg, #475569 0%, #334155 100%) !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* إظهار رأس الجدول في كل صفحة */
            thead tr {
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
            }
            
            /* إظهار رأس الجدول في أعلى كل صفحة عند التقسيم */
            table {
                thead {
                    display: table-header-group !important;
                }
            }
            
            th {
                background: linear-gradient(135deg, #475569 0%, #334155 100%) !important;
                color: white !important;
                padding: 3px 2px !important; /* زيادة padding لـ A3 */
                border: 1px solid #1e293b !important;
                font-weight: 700 !important;
                text-align: center !important;
                font-size: 4.5px !important; /* زيادة حجم الخط لـ A3 */
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                line-height: 1.2 !important;
                max-width: none !important;
            }
            
            /* ========== خلايا الجدول ========== */
            td {
                padding: 2px 1px !important; /* زيادة padding لـ A3 */
                border: 1px solid #cbd5e1 !important;
                font-size: 4.5px !important; /* زيادة حجم الخط لـ A3 */
                text-align: center !important;
                color: #1e293b !important;
                background: white !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                line-height: 1.3 !important;
                max-width: none !important;
            }
            
            /* تظليل الصفوف */
            tbody tr:nth-child(even) td {
                background: #f8fafc !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* منع تقطيع الصفوف */
            tr { 
                page-break-inside: avoid !important;
                page-break-after: auto;
            }
            
            /* الجدول والصفوف في المقدمة */
            tbody {
                position: relative !important;
                z-index: 10 !important;
            }
            
            tbody tr {
                position: relative !important;
                z-index: 10 !important;
            }
            
            thead {
                position: relative !important;
                z-index: 10 !important;
            }
            
            /* تقسيم الجدول: 25 صف في كل صفحة */
            tbody tr:nth-child(25n) {
                page-break-after: always !important; /* قطع الصفحة بعد كل 25 صف */
                border-bottom: 2px solid #cbd5e1 !important; /* حد مرئي في نهاية الصفحة */
            }
            
            /* منع تقطيع الصف الأخير في كل صفحة */
            tbody tr:nth-child(25n) td {
                padding-bottom: 10px !important;
            }
            
            /* حماية الصفوف الأخيرة من الاختفاء */
            tbody tr:nth-last-child(-n+3) {
                page-break-after: avoid !important;
            }
            /* إجبار تذييل الجدول (المجاميع) على الظهور مرة واحدة في نهاية الجدول */
            tfoot, tfoot tr, tfoot td {
                page-break-inside: avoid !important;
                page-break-before: avoid !important;
                page-break-after: avoid !important;
            }
            /* إذا لم تتوفر مساحة كافية، انقل المجاميع (tfoot و total-row) إلى الصفحة التالية */
            tfoot { page-break-before: auto !important; }
            tr.total-row, .total-summary { page-break-before: auto !important; }
            
            /* ========== صف المجموع ========== */
            .total-summary,
            tfoot tr,
            tr.total-row,
            tbody tr:last-child {
                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;
                font-weight: 800 !important;
                border-top: 3px solid #f59e0b !important;
                border-bottom: 3px solid #f59e0b !important;
                page-break-before: avoid !important;
                page-break-inside: avoid !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .total-summary td,
            tfoot td,
            tr.total-row td,
            tbody tr:last-child td {
                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;
                color: #92400e !important;
                font-weight: 800 !important;
                font-size: 5px !important; /* زيادة حجم الخط لـ A3 */
                padding: 3px 2px !important; /* زيادة padding لـ A3 */
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* ========== عرض الحقول النصية ========== */
            input[type="text"],
            input[type="number"],
            select {
                border: none !important;
                background: transparent !important;
                font-size: 4.5px !important; /* زيادة حجم الخط لـ A3 */
                padding: 0 !important;
                text-align: center !important;
                color: #1e293b !important;
                -webkit-appearance: none;
                appearance: none;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            /* ========== إخفاء العناصر التفاعلية بشكل شامل ========== */
            input[type="checkbox"],
            input[type="radio"],
            button,
            .btn,
            .btn-primary,
            .btn-success,
            .btn-warning,
            .btn-danger,
            .btn-small,
            td button,
            th button,
            .action-buttons,
            select::-ms-expand {
                display: none !important;
                visibility: hidden !important;
            }
            
            /* ========== إضافة أيقونة للعنوان ========== */
            .card-header h3::before {
                content: "📊 ";
                font-size: 12px;
            }
            
            /* ========== تذييل الصفحة مع التوقيعات - ثابت في أسفل الصفحة ========== */
            .print-footer {
                display: block !important;
                position: fixed !important; /* ثابت في أسفل الصفحة */
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                padding: 15px 10px !important;
                margin: 0 !important;
                box-sizing: border-box !important;
                background: white !important;
                border-top: 3px solid #64748b !important; /* حد واضح بين المحتوى والتذييل */
                font-size: 9px !important;
                color: #64748b !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                page-break-inside: avoid !important;
                page-break-before: avoid !important;
                page-break-after: avoid !important;
                min-height: 140px !important;
                z-index: 1 !important; /* التذييل في الخلف */
                box-shadow: 0 -3px 15px rgba(0,0,0,0.15) !important; /* ظل أقوى للفصل */
            }
            
            /* إضافة مسافة مرئية فارغة قبل التذييل - في الخلف */
            .print-footer::before {
                content: '';
                display: block;
                height: 60px !important; /* زيادة المسافة الفارغة بشكل كبير لـ A3 */
                background: white !important;
                width: 100%;
                position: absolute;
                bottom: 100%;
                left: 0;
                border-top: 3px solid #e2e8f0;
                box-shadow: 0 -3px 8px rgba(0,0,0,0.08);
                z-index: 1 !important; /* في الخلف */
            }
            
            /* قسم التوقيعات */
            .signatures-section {
                display: flex;
                justify-content: space-between;
                margin: 15px 0; /* زيادة المسافة لـ A3 */
                padding: 15px 0; /* زيادة padding لـ A3 */
                border-bottom: 1px solid #cbd5e1;
                gap: 20px; /* زيادة gap لـ A3 */
                page-break-inside: avoid;
                min-height: 90px; /* زيادة الارتفاع لـ A3 */
            }
            
            .signature-box {
                flex: 1;
                text-align: center;
                padding: 8px; /* زيادة padding لـ A3 */
            }
            
            .signature-box .title {
                font-size: 10px; /* زيادة حجم الخط لـ A3 */
                font-weight: 700;
                color: #1e293b;
                margin-bottom: 12px; /* زيادة المسافة لـ A3 */
            }
            
            .signature-box .line {
                border-top: 2px solid #64748b; /* زيادة سماكة الخط لـ A3 */
                width: 80%;
                margin: 15px auto 8px; /* زيادة المسافة لـ A3 */
            }
            
            .signature-box .name {
                font-size: 9px; /* زيادة حجم الخط لـ A3 */
                color: #475569;
                font-weight: 600;
            }
            
            /* معلومات حقوق النشر */
            .copyright-info {
                text-align: center;
                font-size: 9px; /* زيادة حجم الخط لـ A3 */
                color: #64748b;
                padding-top: 10px; /* زيادة padding لـ A3 */
                margin-top: 8px; /* زيادة المسافة لـ A3 */
            }
            
            .copyright-info strong {
                color: #1e293b;
                font-weight: 700;
            }
            
            /* ========== تحسينات إضافية ========== */
            /* إزالة الظلال والحدود المستديرة */
            * {
                box-shadow: none !important;
            }
            
            /* التأكد من عرض الألوان بدقة */
            * {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* ========== إظهار الأعمدة المخفية في الطباعة ========== */
            /* إظهار جميع الأعمدة المخفية لأنها مهمة في الطباعة */
            th[style*="display: none"],
            td[style*="display: none"],
            th[style*="display:none"],
            td[style*="display:none"],
            .hidden-column {
                display: table-cell !important;
                visibility: visible !important;
            }
        }
        
        /* Classes للطباعة */
        .print-only {
            display: none;
        }
        
        @media print {
            .print-only {
                display: block !important;
            }
            
            .no-print {
                display: none !important;
            }
        }

        /* التصميم المتجاوب */
        @media (max-width: 992px) {
            body {
                font-size: 14px;
            }

            .header {
                flex-direction: column;
                align-items: stretch;
                gap: 18px;
            }

            .header > div,
            .header-actions {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .actions,
            .filter-row {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .actions button,
            .filter-row > * {
                width: 100%;
            }

            .nav-tabs,
            .nav-bar {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }

            .nav-tabs .tab-btn,
            .nav-bar .nav-item {
                flex: 0 0 auto;
            }

            .card,
            .table-container {
                margin-left: 0;
                margin-right: 0;
            }

            .modal-content {
                width: 92vw;
                max-height: 92vh;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 13px;
            }

            .header {
                padding: 16px;
                gap: 12px;
            }

            .header h1 {
                font-size: 20px;
                text-align: center;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
                gap: 10px;
            }

            .appearance-controls {
                grid-template-columns: 1fr;
            }

            .content {
                padding: 15px;
            }

            .dashboard-grid { 
                grid-template-columns: 1fr; 
            }

            .form-row, .comparison-container { 
                grid-template-columns: 1fr; 
            }

            .nav-tabs,
            .nav-bar {
                padding-bottom: 6px;
            }

            .nav-tabs .tab-btn,
            .nav-bar .nav-item {
                padding: 10px 12px;
                font-size: 13px;
            }

            table {
                font-size: 11px;
            }

            th, td {
                padding: 6px;
                white-space: nowrap;
            }

            .modal-content {
                padding: 18px;
                width: 96vw;
                max-height: 95vh;
            }

            .login-box {
                padding: 30px 25px;
            }

            .stat-card .value {
                font-size: 26px;
            }

            .actions button,
            .btn {
                width: 100%;
            }

            .filter-section {
                padding: 18px;
            }

            .project-switcher {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .project-switcher-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }

            .header-btn, .btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            table {
                font-size: 9px;
            }

            .notification {
                min-width: 250px;
                right: 10px;
                top: 10px;
            }
        }
    </style>
</head>
<body>
<!-- شاشة تسجيل الدخول المحسّنة -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <!-- Logo with Rosemary -->
            <div style="position: relative; margin-bottom: 25px;">
                <div class="logo" style="font-size: 70px; margin-bottom: 10px;">🌿</div>
                <div style="height: 3px; width: 60px; background: linear-gradient(90deg, #667eea, #764ba2); margin: 0 auto; border-radius: 2px;"></div>
            </div>
            
            <!-- Title Section -->
            <h1 style="font-size: 28px; margin-bottom: 8px; color: #1f2937;">PayRose</h1>
            <p style="font-weight: 600; color: #667eea; font-size: 15px; margin-bottom: 8px; letter-spacing: 0.5px;">✨ ROSEMARY COMPANY</p>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 30px;">نظام إدارة الرواتب الاحترافي</p>
            
            <!-- Welcome Message -->
            <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 15px; border-radius: 12px; margin-bottom: 25px; border-right: 4px solid #667eea;">
                <p style="color: #667eea; font-weight: 600; font-size: 14px; margin: 0;">
                    👋 مرحباً بك! الرجاء تسجيل الدخول للمتابعة
                </p>
            </div>
            
            <form id="loginForm">
                <!-- Email Field -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 10px;">
                        <span>📧</span>
                        <span>البريد الإلكتروني</span>
                    </label>
                    <input type="email" id="email" placeholder="example@company.com" required 
                        style="padding-right: 15px; transition: all 0.3s;">
                </div>
                
                <!-- Password Field -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 10px;">
                        <span>🔒</span>
                        <span>كلمة المرور</span>
                    </label>
                    <input type="password" id="password" placeholder="••••••••" required
                        style="padding-right: 15px; transition: all 0.3s;">
                </div>
                
                <!-- Login Button -->
                <button type="submit" class="btn-login" style="position: relative; overflow: hidden;">
                    <span style="position: relative; z-index: 1;">🔐 تسجيل الدخول</span>
                </button>
            </form>
            
            <!-- Local Account Option -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                <button onclick="openLocalAccountModal()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                    💾 إنشاء حساب محلي (بدون إنترنت)
                </button>
                <p style="font-size: 11px; color: #6b7280; margin-top: 8px; text-align: center;">
                    للعمل بدون اتصال بالإنترنت
                </p>
            </div>
            
            <!-- Footer -->
            <div class="login-footer" style="margin-top: 25px; text-align: center; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                <p style="font-size: 12px; color: #9ca3af; margin: 0;">
                    🔒 تسجيل الدخول الآمن عبر Firebase Authentication
                </p>
                <p style="font-size: 11px; color: #d1d5db; margin-top: 8px;">
                    © 2024 PayRose - All Rights Reserved
                </p>
            </div>
        </div>
        
        <!-- Decorative Elements -->
        <div style="position: absolute; top: 20px; left: 20px; font-size: 80px; opacity: 0.05; pointer-events: none;">🌿</div>
        <div style="position: absolute; bottom: 20px; right: 20px; font-size: 80px; opacity: 0.05; pointer-events: none;">🌿</div>
    </div>

    <!-- التطبيق الرئيسي -->
    <div id="app">
        <!-- رسالة القفل -->
        <div class="lock-overlay" id="lockOverlay">
            <div class="lock-message">
                <h2>🔒 <span id="lockTitle">النظام مفتوح مسبقاً!</span></h2>
                <p id="lockMsg">النظام مفتوح بالفعل في نافذة أخرى. لا يمكن فتح أكثر من نسخة واحدة في نفس الوقت.</p>
            </div>
        </div>

        <!-- شاشة التحميل -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
        </div>

        <div class="container">
            <!-- الهيدر -->
            <!-- Enhanced Header -->
            <div class="header">
                <!-- Top Bar -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 25px; border-bottom: 1px solid rgba(255,255,255,0.15);">
                    <!-- Brand Section -->
                    <div class="brand-section">
                        <div class="brand-logo">🌿</div>
                        <div class="brand-info">
                            <h1><span id="headerTitle">PayRose</span></h1>
                            <p>✨ Powered by ROSEMARY</p>
                        </div>
                    </div>

                    <!-- Right Actions -->
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <!-- Year Selector Enhanced -->
                        <div class="year-selector-enhanced">
                            <button onclick="changeYear(-1)" title="السنة السابقة">⬅️</button>
                            <select id="yearSelector" onchange="selectYear(this.value)">
                                <!-- سيتم ملؤها من JavaScript -->
                            </select>
                            <button onclick="changeYear(1)" title="السنة التالية">➡️</button>
                            <button onclick="openAddYearModal()" title="إضافة سنة جديدة" style="background: rgba(76, 175, 80, 0.4);">➕</button>
                        </div>

                        <!-- Sync Status -->
                        <div class="sync-status" id="syncStatus">
                            <div class="sync-dot"></div>
                            <span>متصل</span>
                        </div>

                        <!-- Notifications Bell -->
                        <button class="notification-bell" onclick="showNotification('info', 'الإشعارات', 'لا توجد إشعارات جديدة')" title="الإشعارات">
                            🔔
                            <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
                        </button>

                        <!-- User Menu Enhanced -->
                        <div class="user-menu" id="userMenu">
                            <div class="user-info-enhanced" onclick="toggleUserMenu()">
                                <div class="avatar" id="userAvatar">A</div>
                                <div class="user-details">
                                    <span class="user-name" id="currentUser">Admin</span>
                                    <span class="user-role" id="userRole">مدير النظام</span>
                                </div>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            
                            <!-- User Dropdown -->
                            <div class="user-dropdown">
                                <div class="user-dropdown-header">
                                    <div class="avatar-large" id="userAvatarLarge">A</div>
                                    <h3 id="userNameDropdown">Admin</h3>
                                    <p id="userEmailDropdown">admin@payrose.com</p>
                                </div>
                                <div class="user-dropdown-menu">
                                    <div class="user-dropdown-item" onclick="showNotification('info', 'قريباً', 'الملف الشخصي قيد التطوير')">
                                        <span>👤</span>
                                        <span id="profileText">الملف الشخصي</span>
                                    </div>
                                    <div class="user-dropdown-item" onclick="openSignaturesModal(); toggleUserMenu();">
                                        <span>✍️</span>
                                        <span id="signaturesText">التوقيعات</span>
                                    </div>
                                    <div class="user-dropdown-item" onclick="toggleAppearancePanel(); toggleUserMenu();">
                                        <span>🎨</span>
                                        <span id="appearanceText">المظهر</span>
                                    </div>
                                    <div class="user-dropdown-item" onclick="toggleLanguage(); toggleUserMenu();">
                                        <span>🌐</span>
                                        <span id="languageText">English</span>
                                    </div>
                                    <div class="user-dropdown-item" onclick="exportToJSON(); toggleUserMenu();">
                                        <span>💾</span>
                                        <span id="backupText">نسخ احتياطي</span>
                                    </div>
                                    <div class="user-dropdown-item" onclick="importData(); toggleUserMenu();">
                                        <span>📥</span>
                                        <span id="importText">استيراد</span>
                                    </div>
                                    <div class="user-dropdown-item" onclick="migrateToSupabase(); toggleUserMenu();">
                                        <span>🔄</span>
                                        <span id="migrateText">نقل إلى Supabase</span>
                                    </div>
                                    <div class="user-dropdown-divider"></div>
                                    <div class="user-dropdown-item danger" onclick="logout()">
                                        <span>🚪</span>
                                        <span id="logoutText">تسجيل الخروج</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Bar -->
                <div class="nav-bar">
                    <div class="nav-item active" onclick="showTab('dashboard')" id="navDashboard">
                        <span>📊</span>
                        <span id="navDashboardText">لوحة التحكم</span>
                    </div>
                    <div class="nav-item" onclick="showTab('months')" id="navMonths">
                        <span>📅</span>
                        <span id="navMonthsText">الأشهر</span>
                    </div>
                    <div class="nav-item" onclick="showTab('projects')" id="navProjects">
                        <span>🏗️</span>
                        <span id="navProjectsText">المشاريع</span>
                    </div>
                    <div class="nav-item" onclick="showTab('years')" id="navYears">
                        <span>📆</span>
                        <span id="navYearsText">السنوات</span>
                    </div>
                    <div class="nav-item" onclick="showTab('users')" id="navUsers">
                        <span>👥</span>
                        <span id="navUsersText">المستخدمين</span>
                    </div>
                    <div class="nav-item" onclick="showTab('settings')" id="navSettings">
                        <span>⚙️</span>
                        <span id="navSettingsText">الإعدادات</span>
                    </div>
                    <div class="nav-item" onclick="openSummaryModal()" id="navReports">
                        <span>📑</span>
                        <span id="navReportsText">التقارير</span>
                    </div>
                    <div class="nav-item" onclick="openActivityLogModal()" id="navActivityLog">
                        <span>📋</span>
                        <span id="navActivityLogText">سجل التعديلات</span>
                    </div>
                    <div class="nav-item" onclick="openSalaryVouchersModal()" id="navVouchers">
                        <span>🎫</span>
                        <span id="navVouchersText">قسائم الراتب</span>
                    </div>
                    <div class="nav-item" onclick="showTab('bulkEdit')" id="navBulkEdit">
                        <span>✏️</span>
                        <span id="navBulkEditText">تعديل متعدد</span>
                    </div>
                </div>

                <!-- Breadcrumbs -->
                <div class="breadcrumbs" id="breadcrumbsContainer">
                    <span class="breadcrumb-item">
                        <span>🏠</span>
                        <span id="breadcrumbHome">الرئيسية</span>
                    </span>
                    <span class="breadcrumb-separator">›</span>
                    <span class="breadcrumb-item active" id="breadcrumbCurrent">لوحة التحكم</span>
                </div>
            </div>

            <!-- لوحة التحكم في المظهر -->
            <div class="appearance-panel" id="appearancePanel" style="display: none;">
                <h3>🎨 التحكم في مظهر الجداول</h3>
                <div class="appearance-controls">
                    <div class="control-group">
                        <label>📏 ارتفاع الصفوف: <span class="control-value" id="rowHeightValue">40px</span></label>
                        <input type="range" id="rowHeightSlider" min="30" max="80" value="40" oninput="updateRowHeight(this.value)">
                    </div>
                    
                    <div class="control-group">
                        <label>📝 حجم الخط: <span class="control-value" id="fontSizeValue">11px</span></label>
                        <input type="range" id="fontSizeSlider" min="8" max="16" value="11" oninput="updateFontSize(this.value)">
                    </div>
                    
                    <div class="control-group">
                        <label>📦 تباعد الأعمدة: <span class="control-value" id="paddingValue">6px</span></label>
                        <input type="range" id="paddingSlider" min="4" max="20" value="6" oninput="updatePadding(this.value)">
                    </div>
                    
                    <div class="control-group">
                        <label>📊 ارتفاع الرأس: <span class="control-value" id="headerHeightValue">50px</span></label>
                        <input type="range" id="headerHeightSlider" min="40" max="80" value="50" oninput="updateHeaderHeight(this.value)">
                    </div>
                    
                    <div class="control-group" style="grid-column: 1 / -1;">
                        <button class="btn btn-success" onclick="saveAppearanceSettings()" style="width: 32%; margin-right: 2%;">💾 حفظ المظهر</button>
                        <button class="reset-btn" onclick="resetAppearance()" style="width: 32%; margin-right: 2%;">↺ إعادة تعيين</button>
                        <button class="reset-btn" onclick="clearAllSavedSettings()" style="width: 32%; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">🗑️ مسح الكل</button>
                    </div>
                    <div style="grid-column: 1 / -1; font-size: 11px; color: #6b7280; text-align: center; margin-top: 8px; padding: 8px; background: #f0f9ff; border-radius: 6px;">
                        ℹ️ <strong>ملاحظة:</strong> التنسيقات تُطبق مباشرة، لكن الحفظ الدائم يتم عند الضغط على <strong>"💾 حفظ المظهر"</strong>
                        <br>
                        🔹 <strong>"💾 حفظ التنسيق"</strong> (فوق الجدول) يحفظ فقط عرض الأعمدة
                    </div>
                </div>
            </div>

            <!-- القوائم -->
            <div class="nav-tabs">
                <button class="tab-btn active" onclick="showTab('dashboard')">
                    <span id="dashboardTab">📊 لوحة التحكم</span>
                </button>
                <button class="tab-btn" onclick="showTab('users')">
                    <span id="usersTab">👥 إدارة المستخدمين</span>
                </button>
                <button class="tab-btn" onclick="showTab('years')">
                    <span id="yearsTab">📅 إدارة السنوات</span>
                </button>
                <button class="tab-btn" onclick="showTab('settings')">
                    <span id="settingsTab">⚙️ الإعدادات</span>
                </button>
                <button class="tab-btn" onclick="showTab('bulkEdit')">
                    <span id="bulkEditTab">✏️ تعديل متعدد</span>
                </button>
                <div class="dropdown">
                    <button class="tab-btn" onclick="toggleDropdown('monthsDropdown')">
                        <span id="monthsTab">📆 الأشهر ▼</span>
                    </button>
                    <div class="dropdown-content" id="monthsDropdown"></div>
                </div>
                <div class="dropdown">
                    <button class="tab-btn" onclick="toggleDropdown('projectsDropdown')">
                        <span id="projectsTab">🏗 المشاريع ▼</span>
                    </button>
                    <div class="dropdown-content" id="projectsDropdown"></div>
                </div>
            </div>

            <!-- المحتوى الرئيسي -->
            <div class="content" id="mainContent"></div>
        </div>
    </div>

    <!-- نافذة إدخال كلمة المرور -->
    <div class="modal" id="passwordModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2 id="passwordModalTitle">🔒 الحماية</h2>
                <p id="passwordModalDesc" style="color: rgba(255,255,255,0.9); font-size: 13px; margin-top: 5px;">
                    يرجى إدخال كلمة المرور للوصول إلى هذا القسم
                </p>
            </div>
            <div class="modal-body" style="padding: 30px;">
                <div class="form-group">
                    <label id="passwordLabel" style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                        🔑 كلمة المرور:
                    </label>
                    <input 
                        type="password" 
                        id="passwordInput" 
                        placeholder="أدخل كلمة المرور"
                        style="width: 100%; padding: 14px; font-size: 16px; border: 2px solid var(--border); border-radius: 8px;"
                        onkeypress="if(event.key === 'Enter') checkPassword()"
                        autofocus
                    >
                    <p id="passwordError" style="color: var(--danger); font-size: 12px; margin-top: 8px; display: none;">
                        ❌ كلمة المرور غير صحيحة
                    </p>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-primary" onclick="checkPassword()" style="width: 100%; padding: 14px; font-size: 16px; font-weight: 600;">
                    ✅ تأكيد
                </button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" style="display: none;" accept=".json">
<!-- النوافذ المنبثقة (Modals) -->
    
    <!-- نافذة إضافة موظف -->
    <div class="modal" id="employeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>✨ إضافة موظف جديد</h2>
                <p>🔖 سيتم توليد رمز الموظف تلقائياً بناءً على المشروع</p>
            </div>
            <form id="employeeForm">
            <div class="modal-body">
                <div class="form-group">
                    <label>الاسم بالعربية</label>
                    <input type="text" id="nameAr" required>
                </div>
                <div class="form-group">
                    <label>الاسم بالإنجليزية</label>
                    <input type="text" id="nameEn" required>
                </div>
                <div class="form-group">
                    <label>المنصب</label>
                    <input type="text" id="position" required>
                </div>
                <div class="form-group">
                    <label>نوع الموظف</label>
                    <select id="employeeType" required onchange="updateSalaryLabelByType('salary')">
                        <option value="monthly">شهري</option>
                        <option value="daily">يومي</option>
                        <option value="vehicle">سيارة</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>المشروع</label>
                    <select id="project" required></select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>الراتب الأساسي</label>
                        <input type="number" id="salary" required min="0">
                    </div>
                    <div class="form-group">
                        <label>عملة الراتب</label>
                        <select id="salaryCurrency" required>
                            <option value="USD">USD</option>
                            <option value="IQD">IQD</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>عملة الدفع</label>
                        <select id="paymentCurrency" required>
                            <option value="USD">USD</option>
                            <option value="IQD">IQD</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>سعر الصرف</label>
                        <input type="number" id="exchangeRate" value="1420" required min="0">
                    </div>
                </div>
                
                <!-- إعدادات نظام الدوام -->
                <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; margin: 20px 0; border: 2px solid #60a5fa;">
                    <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 16px;">⏰ إعدادات نظام الدوام</h4>
                    
                    <div class="form-group">
                        <label>نظام احتساب الدوام</label>
                        <select id="attendanceSystem">
                            <option value="hours" selected>⏱️ بالساعات - مع الأوفر تايم والخصومات</option>
                            <option value="fixed">💰 راتب ثابت - بدون النظر للدوام</option>
                        </select>
                        <small style="color: var(--gray); margin-top: 6px; display: block;">
                            <strong>بالساعات:</strong> يحسب حسب الساعات الفعلية مع الأوفر تايم والفترات المتقطعة<br>
                            <strong>ثابت:</strong> راتب كامل بغض النظر عن الدوام (للإدارة العليا)
                        </small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>⏱️ عدد ساعات العمل اليومية</label>
                            <input type="number" id="dailyWorkHours" value="8" min="1" max="24" step="0.5">
                            <small style="color: var(--gray);">لاحتساب الأوفر تايم والنقص</small>
                        </div>
                        <div class="form-group">
                            <label>🔢 معامل الأوفر تايم</label>
                            <select id="overtimeMultiplier">
                                <option value="1">1× (عادي)</option>
                                <option value="1.5" selected>1.5× (وقت ونصف)</option>
                                <option value="2">2× (مضاعف)</option>
                            </select>
                            <small style="color: var(--gray);">ضرب الساعات الإضافية</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>📅 أيام العمل الأسبوعية</label>
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 8px;">
                            <div style="text-align: center;">
                                <label style="font-size: 11px; display: block; margin-bottom: 4px;">الأحد</label>
                                <input type="checkbox" id="workDay_0" value="0" checked style="width: 20px; height: 20px;">
                            </div>
                            <div style="text-align: center;">
                                <label style="font-size: 11px; display: block; margin-bottom: 4px;">الاثنين</label>
                                <input type="checkbox" id="workDay_1" value="1" checked style="width: 20px; height: 20px;">
                            </div>
                            <div style="text-align: center;">
                                <label style="font-size: 11px; display: block; margin-bottom: 4px;">الثلاثاء</label>
                                <input type="checkbox" id="workDay_2" value="2" checked style="width: 20px; height: 20px;">
                            </div>
                            <div style="text-align: center;">
                                <label style="font-size: 11px; display: block; margin-bottom: 4px;">الأربعاء</label>
                                <input type="checkbox" id="workDay_3" value="3" checked style="width: 20px; height: 20px;">
                            </div>
                            <div style="text-align: center;">
                                <label style="font-size: 11px; display: block; margin-bottom: 4px;">الخميس</label>
                                <input type="checkbox" id="workDay_4" value="4" checked style="width: 20px; height: 20px;">
                            </div>
                            <div style="text-align: center;">
                                <label style="font-size: 11px; display: block; margin-bottom: 4px;">الجمعة</label>
                                <input type="checkbox" id="workDay_5" value="5" style="width: 20px; height: 20px;">
                            </div>
                            <div style="text-align: center;">
                                <label style="font-size: 11px; display: block; margin-bottom: 4px;">السبت</label>
                                <input type="checkbox" id="workDay_6" value="6" checked style="width: 20px; height: 20px;">
                            </div>
                        </div>
                        <small style="color: var(--gray); display: block; margin-top: 8px;">✓ = يوم عمل | ☐ = عطلة مدفوعة الأجر</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>📊 طريقة احتساب الشهر</label>
                            <select id="monthCalculationMethod">
                                <option value="30" selected>30 يوم دائماً</option>
                                <option value="actual">حسب أيام الشهر الفعلية (28-31)</option>
                            </select>
                            <small style="color: var(--gray);">لحساب الراتب اليومي</small>
                        </div>
                        <div class="form-group">
                            <label>💚 احتساب الإجازات المدفوعة</label>
                            <select id="paidLeaveCalculation">
                                <option value="full">كامل الراتب</option>
                                <option value="half">نصف الراتب</option>
                                <option value="none">بدون راتب</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-primary" onclick="closeModal('employeeModal')">❌ إلغاء</button>
                <button type="submit" class="btn btn-success">💾 حفظ الموظف</button>
            </div>
            </form>
        </div>
    </div>

    <!-- نافذة تعديل موظف -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>✏️ تعديل بيانات الموظف</h2>
                <p>🔖 رمز الموظف: <span id="editEmployeeCode" style="font-weight: 700;">-</span></p>
            </div>
            <form id="editForm">
            <div class="modal-body">
                <div class="form-group">
                    <label>الاسم بالعربية</label>
                    <input type="text" id="editNameAr" required>
                </div>
                <div class="form-group">
                    <label>الاسم بالإنجليزية</label>
                    <input type="text" id="editNameEn" required>
                </div>
                <div class="form-group">
                    <label>المنصب</label>
                    <input type="text" id="editPosition" required>
                </div>
                <div class="form-group">
                    <label>نوع الموظف</label>
                    <select id="editEmployeeType" required onchange="updateSalaryLabelByType('editSalary')">
                        <option value="monthly">شهري</option>
                        <option value="daily">يومي</option>
                        <option value="vehicle">سيارة</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>المشروع</label>
                    <select id="editProject" required></select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>الراتب الأساسي</label>
                        <input type="number" id="editSalary" required min="0">
                    </div>
                    <div class="form-group">
                        <label>عملة الراتب</label>
                        <select id="editSalaryCurrency" required>
                            <option value="USD">USD</option>
                            <option value="IQD">IQD</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>عملة الدفع</label>
                        <select id="editPaymentCurrency" required>
                            <option value="USD">USD</option>
                            <option value="IQD">IQD</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>سعر الصرف</label>
                        <input type="number" id="editExchangeRate" required min="0">
                    </div>
                </div>
                
                <!-- إعدادات نظام الدوام -->
                <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; margin: 20px 0; border: 2px solid #60a5fa;">
                    <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 16px;">⏰ إعدادات نظام الدوام</h4>
                    
                    <div class="form-group">
                        <label>نظام احتساب الدوام</label>
                        <select id="editAttendanceSystem">
                            <option value="hours" selected>⏱️ بالساعات - مع الأوفر تايم والخصومات</option>
                            <option value="fixed">💰 راتب ثابت - بدون النظر للدوام</option>
                        </select>
                        <small style="color: var(--gray); margin-top: 6px; display: block;">
                            <strong>بالساعات:</strong> يحسب حسب الساعات الفعلية مع الأوفر تايم والفترات المتقطعة<br>
                            <strong>ثابت:</strong> راتب كامل بغض النظر عن الدوام (للإدارة العليا)
                        </small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>⏱️ عدد ساعات العمل اليومية</label>
                            <input type="number" id="editDailyWorkHours" value="8" min="1" max="24" step="0.5">
                            <small style="color: var(--gray);">لاحتساب الأوفر تايم والنقص</small>
                        </div>
                        <div class="form-group">
                            <label>🔢 معامل الأوفر تايم</label>
                            <select id="editOvertimeMultiplier">
                                <option value="1">1× (عادي)</option>
                                <option value="1.5" selected>1.5× (وقت ونصف)</option>
                                <option value="2">2× (مضاعف)</option>
                            </select>
                            <small style="color: var(--gray);">ضرب الساعات الإضافية</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>📅 أيام العمل الأسبوعية</label>
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 8px;">
                            <div style="text-align: center;">
                                <label style="font-size: 11px; display: block; margin-bottom: 4px;">الأحد</label>
                                <input type="checkbox" id="editWorkDay_0" value="0" checked style="width: 20px; height: 20px;">
                            </div>
                            <div style="text-align: center;">
                                <label style="font-size: 11px; display: block; margin-bottom: 4px;">الاثنين</label>
                                <input type="checkbox" id="editWorkDay_1" value="1" checked style="width: 20px; height: 20px;">
                            </div>
                            <div style="text-align: center;">
                                <label style="font-size: 11px; display: block; margin-bottom: 4px;">الثلاثاء</label>
                                <input type="checkbox" id="editWorkDay_2" value="2" checked style="width: 20px; height: 20px;">
                            </div>
                            <div style="text-align: center;">
                                <label style="font-size: 11px; display: block; margin-bottom: 4px;">الأربعاء</label>
                                <input type="checkbox" id="editWorkDay_3" value="3" checked style="width: 20px; height: 20px;">
                            </div>
                            <div style="text-align: center;">
                                <label style="font-size: 11px; display: block; margin-bottom: 4px;">الخميس</label>
                                <input type="checkbox" id="editWorkDay_4" value="4" checked style="width: 20px; height: 20px;">
                            </div>
                            <div style="text-align: center;">
                                <label style="font-size: 11px; display: block; margin-bottom: 4px;">الجمعة</label>
                                <input type="checkbox" id="editWorkDay_5" value="5" style="width: 20px; height: 20px;">
                            </div>
                            <div style="text-align: center;">
                                <label style="font-size: 11px; display: block; margin-bottom: 4px;">السبت</label>
                                <input type="checkbox" id="editWorkDay_6" value="6" checked style="width: 20px; height: 20px;">
                            </div>
                        </div>
                        <small style="color: var(--gray); display: block; margin-top: 8px;">✓ = يوم عمل | ☐ = عطلة مدفوعة الأجر</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>📊 طريقة احتساب الشهر</label>
                            <select id="editMonthCalculationMethod">
                                <option value="30" selected>30 يوم دائماً</option>
                                <option value="actual">حسب أيام الشهر الفعلية (28-31)</option>
                            </select>
                            <small style="color: var(--gray);">لحساب الراتب اليومي</small>
                        </div>
                        <div class="form-group">
                            <label>💚 احتساب الإجازات المدفوعة</label>
                            <select id="editPaidLeaveCalculation">
                                <option value="full">كامل الراتب</option>
                                <option value="half">نصف الراتب</option>
                                <option value="none">بدون راتب</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-primary" onclick="closeModal('editModal')">❌ إلغاء</button>
                <button type="submit" class="btn btn-success">✅ حفظ التعديلات</button>
            </div>
            </form>
        </div>
    </div>

    <!-- نافذة نسخ موظف -->
    <div class="modal" id="copyModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>📋 نسخ الموظف</h2>
                <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-top: 5px;">
                    اختر الأشهر والسنة المستهدفة
                </p>
            </div>
            <div style="padding: 20px;">
                <!-- اختيار السنة -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">
                        📅 اختر السنة المستهدفة:
                    </label>
                    <select id="copyTargetYear" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--primary); border-radius: 8px;"></select>
                </div>
                
                <!-- اختيار الأشهر -->
                <div class="form-group">
                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">
                        🗓️ اختر الأشهر المستهدفة:
                    </label>
                    <div id="monthCheckboxes" style="max-height: 300px; overflow-y: auto; border: 2px solid #e5e7eb; border-radius: 8px; padding: 10px;"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeModal('copyModal')">إلغاء</button>
                <button class="btn btn-success" onclick="confirmCopy()">✓ نسخ</button>
            </div>
        </div>
    </div>

    <!-- نافذة نسخ جميع الموظفين -->
    <div class="modal" id="copyAllModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>📋 نسخ جميع الموظفين</h2>
                <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-top: 5px;">
                    اختر الشهر والسنة المستهدفة
                </p>
            </div>
            <div style="padding: 20px;">
                <!-- اختيار السنة -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">
                        📅 اختر السنة المستهدفة:
                    </label>
                    <select id="copyAllTargetYear" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--primary); border-radius: 8px;"></select>
                </div>
                
                <!-- اختيار الشهر -->
            <div class="form-group">
                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">
                        🗓️ اختر الشهر المستهدف:
                    </label>
                    <select id="targetMonth" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--primary); border-radius: 8px;"></select>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeModal('copyAllModal')">إلغاء</button>
                <button class="btn btn-success" onclick="confirmCopyAll()">✓ نسخ الجميع</button>
            </div>
        </div>
    </div>

    <!-- نافذة نسخ الموظفين المحددين -->
    <div class="modal" id="copySelectedModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>📋 نسخ الموظفين المحددين</h2>
                <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-top: 5px;">
                    اختر الشهر والسنة المستهدفة
                </p>
            </div>
            <div style="padding: 20px;">
                <!-- اختيار السنة -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">
                        📅 اختر السنة المستهدفة:
                    </label>
                    <select id="copySelectedTargetYear" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--primary); border-radius: 8px;"></select>
                </div>
                
                <!-- اختيار الشهر -->
                <div class="form-group">
                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">
                        🗓️ اختر الشهر المستهدف:
                    </label>
                    <select id="copySelectedTargetMonth" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--primary); border-radius: 8px;"></select>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeModal('copySelectedModal')">إلغاء</button>
                <button class="btn btn-success" onclick="confirmCopySelected()">✓ نسخ المحدد</button>
            </div>
        </div>
    </div>

    <!-- نافذة كلمة المرور للمكافآت والزيادات -->
    <div class="modal" id="bonusPasswordModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header"><h2>🔐 كلمة المرور</h2></div>
            <div class="form-group">
                <label>كلمة المرور</label>
                <input type="password" id="bonusPasswordInput">
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeModal('bonusPasswordModal')">إلغاء</button>
                <button class="btn btn-success" onclick="verifyPassword()">تأكيد</button>
            </div>
        </div>
    </div>

    <!-- نافذة إنشاء حساب محلي -->
    <div class="modal" id="localAccountModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>💾 إنشاء حساب محلي</h2>
                <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-top: 5px;">
                    حساب محلي يعمل بدون إنترنت - البيانات محفوظة في المتصفح فقط
                </p>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <div style="background: #fef3c7; border: 2px solid #f59e0b; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="color: #92400e; font-size: 13px; margin: 0;">
                        <strong>⚠️ ملاحظة مهمة:</strong><br>
                        • البيانات محفوظة في المتصفح الحالي فقط<br>
                        • عند مسح بيانات المتصفح، ستُحذف جميع البيانات<br>
                        • يُنصح بعمل نسخ احتياطية دورية
                    </p>
                </div>
                
                <form id="localAccountForm">
                    <div class="form-group">
                        <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                            📧 البريد الإلكتروني:
                        </label>
                        <input type="email" id="localAccountEmail" placeholder="example@company.com" required
                            style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--primary); border-radius: 8px;">
                    </div>
                    
                    <div class="form-group">
                        <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                            🔒 كلمة المرور:
                        </label>
                        <input type="password" id="localAccountPassword" placeholder="••••••••" required minlength="6"
                            style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--primary); border-radius: 8px;">
                    </div>
                    
                    <div class="form-group">
                        <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                            🔒 تأكيد كلمة المرور:
                        </label>
                        <input type="password" id="localAccountPasswordConfirm" placeholder="••••••••" required minlength="6"
                            style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--primary); border-radius: 8px;">
                    </div>
                    
                    <div class="form-group">
                        <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                            👤 الاسم الكامل:
                        </label>
                        <input type="text" id="localAccountName" placeholder="اسم المستخدم" required
                            style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--primary); border-radius: 8px;">
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeModal('localAccountModal')">إلغاء</button>
                <button class="btn btn-success" onclick="createLocalAccount()" style="font-weight: 600;">
                    💾 إنشاء الحساب
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة خيارات الطباعة المحسّنة -->
    <div class="modal" id="printOptionsModal">
        <div class="modal-content" style="max-width: 750px;">
            <div class="modal-header">
                <h2>🖨️ خيارات الطباعة المتقدمة</h2>
                <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-top: 5px;">
                    📋 اختر إعدادات الطباعة المناسبة لاحتياجاتك
                </p>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <!-- اختيار المشروع -->
                <div class="form-group">
                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                        🏗️ المشروع:
                    </label>
                    <select id="printProjectSelect" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--primary); border-radius: 8px;">
                        <option value="all">جميع المشاريع</option>
                    </select>
                </div>
                
                <!-- نوع التقرير -->
                <div class="form-group">
                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                        📄 نوع الموظفين:
                    </label>
                    <select id="printReportType" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--primary); border-radius: 8px;">
                        <option value="all">جميع الموظفين</option>
                        <option value="monthly">الموظفون الشهريون فقط</option>
                        <option value="daily">الموظفون اليوميون فقط</option>
                        <option value="vehicle">السيارات فقط</option>
                    </select>
                </div>
                
                <!-- حالة الدفع -->
                <div class="form-group">
                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                        💳 حالة الدفع:
                    </label>
                    <select id="printPaymentStatus" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--primary); border-radius: 8px;">
                        <option value="all">جميع الموظفين</option>
                        <option value="paid">الموظفون المدفوعون فقط</option>
                        <option value="unpaid">الموظفون غير المدفوعين فقط</option>
                    </select>
                </div>
                
                <!-- اتجاه الصفحة -->
                <div class="form-group">
                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                        📐 اتجاه الصفحة:
                    </label>
                    <div style="display: flex; gap: 20px; padding: 10px; background: #f0f9ff; border-radius: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px;">
                            <input type="radio" name="printOrientation" value="landscape" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span>📄 أفقي (Landscape) - للجداول العريضة</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px;">
                            <input type="radio" name="printOrientation" value="portrait" style="width: 18px; height: 18px; cursor: pointer;">
                            <span>📄 عمودي (Portrait) - للتقارير</span>
                        </label>
                    </div>
                </div>
                
                <!-- حجم الورق -->
                <div class="form-group">
                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                        📏 حجم الورق:
                    </label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 10px; background: #f0f9ff; border-radius: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px;">
                            <input type="radio" name="printPageSize" value="A4" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span>A4 (21×29.7 سم)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px;">
                            <input type="radio" name="printPageSize" value="A3" style="width: 18px; height: 18px; cursor: pointer;">
                            <span>A3 (29.7×42 سم) - للجداول الكبيرة ✨</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px;">
                            <input type="radio" name="printPageSize" value="Letter" style="width: 18px; height: 18px; cursor: pointer;">
                            <span>Letter (21.6×27.9 سم)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px;">
                            <input type="radio" name="printPageSize" value="Legal" style="width: 18px; height: 18px; cursor: pointer;">
                            <span>Legal (21.6×35.6 سم)</span>
                        </label>
                    </div>
                </div>
                
                
                <!-- ملاحظة -->
                <div style="padding: 15px; background: #dbeafe; border: 2px solid #3b82f6; border-radius: 8px; margin-top: 15px;">
                    <div style="display: flex; align-items: start; gap: 10px;">
                        <span style="font-size: 20px;">💡</span>
                        <div style="font-size: 12px; color: #1e40af;">
                            <strong>نصائح:</strong>
                            <ul style="margin: 8px 0; padding-right: 20px;">
                                <li>سيتم طباعة الجداول حسب اختيارك</li>
                                <li>التوقيعات ستظهر تلقائياً</li>
                                <li>استخدم أفقي للجداول الكبيرة</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeModal('printOptionsModal')">❌ إلغاء</button>
                <button class="btn" onclick="openPrintPreview()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-weight: 600;">
                    👁️ معاينة قبل الطباعة
                </button>
                <button class="btn btn-success" onclick="executePrintWithOptions(false)" style="font-weight: 600;">
                    🖨️ طباعة الآن
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة طباعة قسائم الراتب -->
    <div class="modal" id="salaryVouchersModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>🎫 طباعة قسائم ملخص الراتب</h2>
                <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-top: 5px;">
                    طباعة قسائم A3 مقسمة إلى 24 قسيمة (4 صفوف × 6 أعمدة)
                </p>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <!-- اختيار الشهر -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                        📅 الشهر:
                    </label>
                    <select id="voucherMonthSelect" style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;">
                        <!-- سيتم ملؤها ديناميكياً -->
                    </select>
                </div>
                
                <!-- اختيار السنة -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                        📆 السنة:
                    </label>
                    <select id="voucherYearSelect" style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;">
                        <!-- سيتم ملؤها ديناميكياً -->
                    </select>
                </div>
                
                <!-- اختيار المشروع -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                        🏗️ المشروع:
                    </label>
                    <select id="voucherProjectSelect" style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;">
                        <option value="all">جميع المشاريع</option>
                        <!-- سيتم ملؤها ديناميكياً -->
                    </select>
                </div>
                
                <!-- نوع الموظف -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                        👥 نوع الموظف:
                    </label>
                    <select id="voucherEmployeeType" style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;">
                        <option value="all">الكل</option>
                        <option value="monthly">شهري</option>
                        <option value="daily">يومي</option>
                        <option value="vehicle">مركبة</option>
                    </select>
                </div>
                
                <!-- معلومات مهمة -->
                <div style="padding: 15px; background: #f0f9ff; border-radius: 8px; border: 1px solid #bfdbfe; margin-bottom: 20px;">
                    <div style="font-size: 13px; color: #1e40af;">
                        <div style="font-weight: 600; margin-bottom: 8px;">ℹ️ معلومات مهمة:</div>
                        <ul style="margin: 0; padding-right: 20px; line-height: 1.8;">
                            <li>سيتم طباعة صفحة A3 مقسمة إلى 24 قسيمة (4 صفوف × 6 أعمدة)</li>
                            <li>كل قسيمة تحتوي على ملخص راتب موظف واحد</li>
                            <li>يمكنك قص القسائم بعد الطباعة</li>
                            <li>يتم توزيع الموظفين تلقائياً على الصفحات</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end; padding: 20px; border-top: 1px solid var(--border);">
                <button class="btn btn-primary" onclick="closeModal('salaryVouchersModal')">❌ إلغاء</button>
                <button class="btn btn-success" onclick="printSalaryVouchers()" style="font-weight: 600;">
                    🖨️ طباعة القسائم
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة معاينة الطباعة -->
    <div class="modal" id="printPreviewModal" style="background: rgba(0,0,0,0.95);">
        <div class="modal-content" style="max-width: 95vw; max-height: 95vh; background: #2d3748; border-radius: 15px; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #4c5fd5 0%, #6366f1 100%);">
                <h2>👁️ معاينة الطباعة</h2>
                <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-top: 5px;">
                    📋 تأكد من المحتوى قبل الطباعة النهائية
                </p>
            </div>
            <div style="flex: 1; overflow: auto; padding: 30px; background: #1a202c;">
                <div id="printPreviewContent" style="background: white; margin: 0 auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); min-height: 500px;">
                    <!-- سيتم ملؤها ديناميكياً -->
                </div>
            </div>
            <div class="modal-actions" style="background: #2d3748; padding: 20px; border-top: 2px solid #4a5568;">
                <button class="btn btn-primary" onclick="closeModal('printPreviewModal')">⬅️ رجوع للإعدادات</button>
                <button class="btn" onclick="adjustPrintSettings()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                    ⚙️ تعديل الإعدادات
                </button>
                <button class="btn btn-success" onclick="printFromPreview()" style="font-weight: 600;">
                    🖨️ طباعة الآن
                </button>
                <button class="btn" onclick="savePDFFromPreview()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; font-weight: 600;">
                    💾 حفظ كـ PDF
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة إعدادات التوقيعات -->
    <div class="modal" id="signaturesModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>✍️ إعدادات التوقيعات</h2>
                <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-top: 5px;">
                    📝 حدد المناصب والأسماء التي ستظهر في تذييل الطباعة (4 توقيعات)
                </p>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- التوقيع الأول -->
                    <div style="padding: 15px; background: #f0f9ff; border-radius: 8px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px; font-size: 14px;">📌 التوقيع الأول</h4>
                        <div class="form-group">
                            <label style="font-size: 13px; font-weight: 600;">المنصب:</label>
                            <input type="text" id="signature1Position" placeholder="مثال: المدير المالي" 
                                   style="width: 100%; padding: 8px; border: 2px solid var(--primary); border-radius: 6px;">
                        </div>
                        <div class="form-group" style="margin-top: 10px;">
                            <label style="font-size: 13px; font-weight: 600;">الاسم (اختياري):</label>
                            <input type="text" id="signature1Name" placeholder="اتركه فارغاً لعدم إظهار الاسم" 
                                   style="width: 100%; padding: 8px; border: 2px solid #cbd5e1; border-radius: 6px;">
                        </div>
                    </div>
                    
                    <!-- التوقيع الثاني -->
                    <div style="padding: 15px; background: #f0f9ff; border-radius: 8px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px; font-size: 14px;">📌 التوقيع الثاني</h4>
                        <div class="form-group">
                            <label style="font-size: 13px; font-weight: 600;">المنصب:</label>
                            <input type="text" id="signature2Position" placeholder="مثال: مدير الموارد البشرية" 
                                   style="width: 100%; padding: 8px; border: 2px solid var(--primary); border-radius: 6px;">
                        </div>
                        <div class="form-group" style="margin-top: 10px;">
                            <label style="font-size: 13px; font-weight: 600;">الاسم (اختياري):</label>
                            <input type="text" id="signature2Name" placeholder="اتركه فارغاً لعدم إظهار الاسم" 
                                   style="width: 100%; padding: 8px; border: 2px solid #cbd5e1; border-radius: 6px;">
                        </div>
                    </div>
                    
                    <!-- التوقيع الثالث -->
                    <div style="padding: 15px; background: #f0f9ff; border-radius: 8px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px; font-size: 14px;">📌 التوقيع الثالث</h4>
                        <div class="form-group">
                            <label style="font-size: 13px; font-weight: 600;">المنصب:</label>
                            <input type="text" id="signature3Position" placeholder="مثال: المدير التنفيذي" 
                                   style="width: 100%; padding: 8px; border: 2px solid var(--primary); border-radius: 6px;">
                        </div>
                        <div class="form-group" style="margin-top: 10px;">
                            <label style="font-size: 13px; font-weight: 600;">الاسم (اختياري):</label>
                            <input type="text" id="signature3Name" placeholder="اتركه فارغاً لعدم إظهار الاسم" 
                                   style="width: 100%; padding: 8px; border: 2px solid #cbd5e1; border-radius: 6px;">
                        </div>
                    </div>
                    
                    <!-- التوقيع الرابع -->
                    <div style="padding: 15px; background: #f0f9ff; border-radius: 8px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px; font-size: 14px;">📌 التوقيع الرابع</h4>
                        <div class="form-group">
                            <label style="font-size: 13px; font-weight: 600;">المنصب:</label>
                            <input type="text" id="signature4Position" placeholder="مثال: المحاسب" 
                                   style="width: 100%; padding: 8px; border: 2px solid var(--primary); border-radius: 6px;">
                        </div>
                        <div class="form-group" style="margin-top: 10px;">
                            <label style="font-size: 13px; font-weight: 600;">الاسم (اختياري):</label>
                            <input type="text" id="signature4Name" placeholder="اتركه فارغاً لعدم إظهار الاسم" 
                                   style="width: 100%; padding: 8px; border: 2px solid #cbd5e1; border-radius: 6px;">
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 12px; background: #fef3c7; border-radius: 8px; border: 1px solid #f59e0b;">
                    <p style="font-size: 12px; color: #92400e; margin: 0;">
                        💡 <strong>نصيحة:</strong> ستظهر هذه التوقيعات في تذييل كل صفحة مطبوعة. يمكنك ترك حقل الاسم فارغاً إذا كنت تريد إظهار المنصب فقط مع خط للتوقيع.
                    </p>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeModal('signaturesModal')">❌ إلغاء</button>
                <button class="btn btn-success" onclick="saveSignatures()" style="font-weight: 600;">
                    💾 حفظ الإعدادات
                </button>
            </div>
        </div>
    </div>

<!-- نافذة إضافة مشروع -->
    <div class="modal" id="projectModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header"><h2>إضافة مشروع جديد</h2></div>
            <form id="projectForm">
                <div class="form-group">
                    <label>كود المشروع</label>
                    <input type="text" id="projectCode" required>
                </div>
                <div class="form-group">
                    <label>اسم المشروع</label>
                    <input type="text" id="projectName" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="closeModal('projectModal')">إلغاء</button>
                    <button type="submit" class="btn btn-success">حفظ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- نافذة تعديل مشروع -->
    <div class="modal" id="editProjectModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header"><h2>تعديل المشروع</h2></div>
            <form id="editProjectForm">
                <div class="form-group">
                    <label>كود المشروع</label>
                    <input type="text" id="editProjectCode" required readonly style="background: #f3f4f6;">
                </div>
                <div class="form-group">
                    <label>اسم المشروع</label>
                    <input type="text" id="editProjectName" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="closeModal('editProjectModal')">إلغاء</button>
                    <button type="submit" class="btn btn-success">حفظ التعديلات</button>
                </div>
            </form>
        </div>
    </div>

    <!-- نافذة اختيار سنة/شهر عند فتح مشروع -->
    <div class="modal" id="projectPickerModal">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-header">
                <h2>📅 اختيار سنة وشهر المشروع</h2>
                <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-top: 5px;">اختر الفترة التي تريد عرضها لهذا المشروع</p>
            </div>
            <div class="modal-body" style="padding: 22px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="font-weight: 700; font-size: 13px; color: var(--dark);">السنة</label>
                        <select id="projectPickerYear" style="width: 100%; padding: 10px 12px; border: 2px solid var(--border); border-radius: 10px; font-weight: 600;"></select>
                    </div>
                    <div>
                        <label style="font-weight: 700; font-size: 13px; color: var(--dark);">الشهر</label>
                        <select id="projectPickerMonth" style="width: 100%; padding: 10px 12px; border: 2px solid var(--border); border-radius: 10px; font-weight: 600;"></select>
                    </div>
                </div>
                <div style="margin-top: 12px; font-size: 12px; color: #475569;">يتم تمييز الأشهر التي تحتوي موظفين لهذا المشروع بعدد بين قوسين.</div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeModal('projectPickerModal')">❌ إلغاء</button>
                <button class="btn btn-success" onclick="confirmProjectMonthYear(event)" style="font-weight: 700;">✅ المتابعة</button>
            </div>
        </div>
    </div>

    <!-- نافذة إدخال الدوام -->
    <div class="modal" id="attendanceModal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>⏰ إدخال الدوام - <span id="attendanceEmployeeName"></span></h2>
                <p style="color: var(--gray); font-size: 14px; margin-top: 5px;">
                    <strong>🔖 الرمز:</strong> <span id="attendanceEmployeeCode" style="color: var(--primary); font-weight: 600;"></span> | 
                    الشهر: <span id="attendanceMonth"></span> <span id="attendanceYear"></span>
                </p>
            </div>
            
            <!-- معلومات الموظف السريعة -->
            <div style="background: #f0f9ff; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; font-size: 12px;">
                    <div><strong>📋 نظام الاحتساب:</strong> <span id="empAttendanceSystem"></span></div>
                    <div><strong>⏱️ ساعات العمل اليومية:</strong> <span id="empDailyHours"></span></div>
                    <div><strong>⚡ معامل الأوفر تايم:</strong> <span id="empOvertimeMultiplier"></span></div>
                    <div><strong>📊 احتساب الشهر:</strong> <span id="empMonthCalcMethod"></span></div>
                    <div><strong>📅 أيام العمل:</strong> <span id="empWorkDays" style="font-size: 11px;"></span></div>
                    <div><strong>💚 الإجازات المدفوعة:</strong> <span id="empPaidLeaveCalc"></span></div>
                </div>
            </div>
            
            <!-- أزرار سريعة -->
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-success btn-small" onclick="fillAllWorkDays()">✓ تعبئة كل الأيام كدوام كامل</button>
                <button class="btn btn-warning btn-small" onclick="clearAllDays()">⊗ مسح الكل</button>
                <button class="btn btn-primary btn-small" onclick="autoCalculateAttendance()">🔄 حساب تلقائي</button>
            </div>
            
            <!-- شرح الألوان -->
            <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 2px solid var(--border);">
                <h4 style="color: var(--dark); font-size: 14px; margin-bottom: 10px;">🎨 دليل الألوان:</h4>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; font-size: 12px;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-radius: 4px; border: 2px solid #10b981;"></div>
                        <span>دوام كامل</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 4px; border: 2px solid #f59e0b;"></div>
                        <span>نصف يوم</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 4px; border: 2px solid #3b82f6;"></div>
                        <span>إجازة مدفوعة</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-radius: 4px; border: 2px solid #ef4444;"></div>
                        <span>غياب</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #e9d5ff 0%, #d8b4fe 100%); border-radius: 4px; border: 2px solid #a855f7;"></div>
                        <span>ساعات محددة</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 20px; height: 20px; background: #fef3c7; border-radius: 4px; border: 2px solid #fbbf24;"></div>
                        <span>عطلة أسبوعية</span>
                    </div>
                </div>
            </div>
            
            <!-- تقويم الدوام -->
            <div id="attendanceCalendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-bottom: 20px;">
                <!-- سيتم ملؤه بالجافاسكريبت -->
            </div>
            
            <!-- ملخص الدوام -->
            <div style="background: #d1fae5; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="color: var(--primary); margin-bottom: 15px;">📊 ملخص الدوام</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div><strong>✓ أيام الدوام الكامل:</strong> <span id="fullDaysCount">0</span></div>
                    <div><strong>⊕ أنصاف الأيام:</strong> <span id="halfDaysCount">0</span></div>
                    <div><strong>💚 الإجازات المدفوعة:</strong> <span id="paidLeaveDaysCount">0</span></div>
                    <div><strong>✗ الغياب:</strong> <span id="absentDaysCount">0</span></div>
                    <div><strong>⏱️ ساعات عادية:</strong> <span id="totalHoursCount">0</span></div>
                    <div style="background: #fef3c7; padding: 8px; border-radius: 6px; border: 2px solid #f59e0b;"><strong>⚡ ساعات أوفر تايم:</strong> <span id="overtimeHoursCount" style="color: #f59e0b; font-weight: 700;">0</span></div>
                    <div style="grid-column: 1/-1; font-size: 18px; color: #059669; background: white; padding: 12px; border-radius: 8px; border: 3px solid #10b981;"><strong>💰 الراتب المحسوب:</strong> <span id="calculatedSalary" style="font-size: 22px; font-weight: 800;">0</span> USD</div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-primary" onclick="closeModal('attendanceModal')">إلغاء</button>
                <button type="button" class="btn btn-success" onclick="saveAttendanceData()">💾 حفظ الدوام</button>
            </div>
        </div>
    </div>

    <!-- نافذة سجل التعديلات -->
    <div class="modal" id="activityLogModal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh;">
            <div class="modal-header">
                <h2>📋 سجل التعديلات والأنشطة</h2>
                <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-top: 5px;">
                    تتبع جميع التعديلات والإضافات والحذف في النظام
                </p>
            </div>
            <div class="filter-section" style="padding: 15px;">
                <div class="filter-row">
                    <div class="filter-group">
                        <label>🔍 نوع النشاط</label>
                        <select id="activityActionFilter" class="filter-select">
                            <option value="">الكل</option>
                            <option value="create">إضافة</option>
                            <option value="update">تعديل</option>
                            <option value="delete">حذف</option>
                            <option value="view">عرض</option>
                            <option value="export">تصدير</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>📦 نوع الكيان</label>
                        <select id="activityEntityFilter" class="filter-select">
                            <option value="">الكل</option>
                            <option value="employee">موظف</option>
                            <option value="project">مشروع</option>
                            <option value="settings">إعدادات</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>👤 المستخدم</label>
                        <input type="text" id="activityUserFilter" class="filter-select" placeholder="البحث بالبريد...">
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-primary" onclick="loadActivityLogs()" style="margin-top: 23px;">
                            🔄 تحديث
                        </button>
                    </div>
                </div>
            </div>
            <div id="activityLogResults" style="max-height: 60vh; overflow-y: auto; padding: 15px;">
                <div style="text-align: center; padding: 40px;">
                    <div class="loading-spinner" style="margin: 0 auto;"></div>
                    <p style="margin-top: 15px; color: var(--gray);">جارٍ تحميل السجل...</p>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeModal('activityLogModal')">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- نافذة الملخصات والمقارنات -->
    <div class="modal" id="summaryModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header"><h2 id="summaryModalTitle">📊 الملخصات والمقارنات</h2></div>
            <div class="filter-section">
                <div class="filter-row">
                    <div class="filter-group">
                        <label id="summaryProjectLabel">🏗 المشروع</label>
                        <select id="summaryProject" class="filter-select">
                            <option value="" id="summaryProjectPlaceholder">اختر المشروع</option>
                            <option value="ALL" id="summaryProjectAll">🌐 جميع المشاريع</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label id="summaryMonth1Label">📅 الشهر الأول</label>
                        <select id="summaryMonth1" class="filter-select"></select>
                    </div>
                    <div class="filter-group">
                        <label id="summaryMonth2Label">📅 الشهر الثاني (للمقارنة)</label>
                        <select id="summaryMonth2" class="filter-select">
                            <option value="" id="summaryMonth2Placeholder">بدون مقارنة</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-primary" onclick="generateSummary()" id="generateSummaryBtn" style="margin-top: 23px;">
                            عرض الملخص
                        </button>
                    </div>
                </div>
            </div>
            <div id="summaryResults"></div>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="printSummary()" id="printSummaryBtn" style="display: none;">
                    🖨️ <span id="printSummaryText">طباعة الملخص</span>
                </button>
                <button class="btn btn-primary" onclick="closeModal('summaryModal')" id="summaryCloseBtn">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- نافذة تقرير الموظف عبر الأشهر -->
    <div class="modal" id="employeeReportModal">
        <div class="modal-content" style="max-width: 1400px; max-height: 95vh;">
            <div class="modal-header">
                <h2 id="employeeReportTitle">📊 تقرير الموظف عبر الأشهر</h2>
            </div>
            <div class="modal-body" style="padding: 25px; overflow-y: auto; max-height: calc(95vh - 150px);">
                <div id="employeeReportContent">
                    <!-- سيتم ملؤه بالجافاسكريبت -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="printEmployeeReport()" id="printEmployeeReportBtn" style="display: none;">
                    🖨️ <span id="printEmployeeReportText">طباعة التقرير</span>
                </button>
                <button class="btn btn-primary" onclick="closeModal('employeeReportModal')" id="employeeReportCloseBtn">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة موظفين متعددين المحسّنة -->
    <div class="modal" id="multipleEmployeesModal">
        <div class="modal-content" style="max-width: 1400px; max-height: 95vh;">
            <div class="modal-header">
                <h2>➕ إضافة موظفين متعددين</h2>
                <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-top: 5px;">
                    📋 يمكنك النسخ واللصق مباشرة من Excel | ⌨️ اضغط Ctrl+V للصق البيانات
                </p>
            </div>
            
            <!-- أزرار التحكم -->
            <div style="padding: 20px; background: #f0f9ff; border-bottom: 2px solid #bae6fd; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <button type="button" class="btn btn-success btn-small" onclick="addMultiEmpRow()">
                    ➕ إضافة صف
                </button>
                <button type="button" class="btn btn-warning btn-small" onclick="clearAllMultiEmpRows()">
                    🗑️ مسح الكل
                </button>
                <button type="button" class="btn btn-primary btn-small" onclick="fillSampleData()">
                    📝 بيانات تجريبية
                </button>
                <div style="flex: 1;"></div>
                <span id="multiEmpRowCount" style="font-size: 13px; font-weight: 600; color: var(--primary);">
                    📊 عدد الصفوف: 5
                </span>
            </div>
            
            <!-- الجدول الذكي -->
            <div style="padding: 20px; max-height: 50vh; overflow-y: auto;">
                <div style="overflow-x: auto;">
                    <table id="multiEmpTable" style="width: 100%; font-size: 12px; border-collapse: collapse;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <th style="padding: 10px; min-width: 50px; position: sticky; top: 0; z-index: 10;">#</th>
                                <th style="padding: 10px; min-width: 150px; position: sticky; top: 0; z-index: 10;">
                                    الاسم بالعربية *
                                    <div style="font-size: 10px; opacity: 0.8; font-weight: normal;">اضغط واختر العمود ثم الصق</div>
                                </th>
                                <th style="padding: 10px; min-width: 150px; position: sticky; top: 0; z-index: 10;">الاسم بالإنجليزية</th>
                                <th style="padding: 10px; min-width: 120px; position: sticky; top: 0; z-index: 10;">المنصب *</th>
                                <th style="padding: 10px; min-width: 100px; position: sticky; top: 0; z-index: 10;">النوع *</th>
                                <th style="padding: 10px; min-width: 120px; position: sticky; top: 0; z-index: 10;">المشروع *</th>
                                <th style="padding: 10px; min-width: 100px; position: sticky; top: 0; z-index: 10;">الراتب *</th>
                                <th style="padding: 10px; min-width: 80px; position: sticky; top: 0; z-index: 10;">عملة الراتب</th>
                                <th style="padding: 10px; min-width: 100px; position: sticky; top: 0; z-index: 10;">عملة الدفع</th>
                                <th style="padding: 10px; min-width: 100px; position: sticky; top: 0; z-index: 10;">سعر الصرف</th>
                                <th style="padding: 10px; min-width: 120px; position: sticky; top: 0; z-index: 10;">نظام الدوام</th>
                                <th style="padding: 10px; min-width: 100px; position: sticky; top: 0; z-index: 10;">ساعات يومية</th>
                                <th style="padding: 10px; min-width: 100px; position: sticky; top: 0; z-index: 10;">معامل أوفر</th>
                                <th style="padding: 10px; min-width: 100px; position: sticky; top: 0; z-index: 10;">حساب الشهر</th>
                                <th style="padding: 10px; min-width: 100px; position: sticky; top: 0; z-index: 10;">الإجازات</th>
                                <th style="padding: 10px; min-width: 120px; position: sticky; top: 0; z-index: 10;">أيام العمل</th>
                                <th style="padding: 10px; min-width: 60px; position: sticky; top: 0; z-index: 10;">حذف</th>
                            </tr>
                        </thead>
                        <tbody id="multipleEmployeesTableBody">
                            <!-- سيتم ملؤه بالجافاسكريبت -->
                        </tbody>
                    </table>
                </div>
                </div>
            
            <!-- معلومات وتعليمات -->
            <div style="padding: 15px 20px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 10px; margin: 0 20px; font-size: 12px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <strong>📋 كيفية اللصق من Excel:</strong>
                        <ol style="margin: 5px 0 0 20px; line-height: 1.8;">
                            <li>انسخ البيانات من Excel (Ctrl+C)</li>
                            <li>اضغط على أول خلية في العمود المطلوب</li>
                            <li>الصق البيانات (Ctrl+V)</li>
                            <li>سيتم إضافة الصفوف تلقائياً</li>
                        </ol>
                    </div>
                    <div>
                        <strong>⚠️ ملاحظات هامة:</strong>
                        <ul style="margin: 5px 0 0 20px; line-height: 1.8;">
                            <li>الحقول المطلوبة: الاسم العربي، المنصب، النوع، المشروع، الراتب</li>
                            <li>الحقول الاختيارية: عملة الدفع، إعدادات نظام الدوام</li>
                            <li>سيتم تجاهل الصفوف الفارغة أو الناقصة</li>
                            <li>يمكنك لصق عدة أعمدة أو صفوف دفعة واحدة</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- ملخص قبل الحفظ -->
            <div id="multiEmpSummary" style="display: none; padding: 15px 20px; margin: 15px 20px; background: #d1fae5; border: 2px solid #10b981; border-radius: 10px;">
                <h4 style="color: #065f46; margin-bottom: 10px;">✅ جاهز للحفظ</h4>
                <div id="multiEmpSummaryContent" style="font-size: 13px; color: #047857;"></div>
            </div>
            
            <form id="multipleEmployeesForm">
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="closeModal('multipleEmployeesModal')">❌ إلغاء</button>
                    <button type="button" class="btn btn-warning" onclick="validateMultiEmpData()">👁️ معاينة</button>
                    <button type="submit" class="btn btn-success">💾 حفظ الموظفين</button>
                </div>
            </form>
        </div>
    </div>

    <!-- نافذة تحديد أيام العمل الأسبوعية -->
    <div class="modal" id="workDaysModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>📅 تحديد أيام العمل الأسبوعية</h2>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px; margin: 20px 0;">
                    <div style="text-align: center; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 2px solid #bae6fd;">
                        <label style="font-size: 14px; font-weight: 600; display: block; margin-bottom: 10px; color: #1e40af;">الأحد</label>
                        <input type="checkbox" id="modal_workDay_0" value="0" style="width: 24px; height: 24px; cursor: pointer;">
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 2px solid #bae6fd;">
                        <label style="font-size: 14px; font-weight: 600; display: block; margin-bottom: 10px; color: #1e40af;">الاثنين</label>
                        <input type="checkbox" id="modal_workDay_1" value="1" style="width: 24px; height: 24px; cursor: pointer;">
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 2px solid #bae6fd;">
                        <label style="font-size: 14px; font-weight: 600; display: block; margin-bottom: 10px; color: #1e40af;">الثلاثاء</label>
                        <input type="checkbox" id="modal_workDay_2" value="2" style="width: 24px; height: 24px; cursor: pointer;">
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 2px solid #bae6fd;">
                        <label style="font-size: 14px; font-weight: 600; display: block; margin-bottom: 10px; color: #1e40af;">الأربعاء</label>
                        <input type="checkbox" id="modal_workDay_3" value="3" style="width: 24px; height: 24px; cursor: pointer;">
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 2px solid #bae6fd;">
                        <label style="font-size: 14px; font-weight: 600; display: block; margin-bottom: 10px; color: #1e40af;">الخميس</label>
                        <input type="checkbox" id="modal_workDay_4" value="4" style="width: 24px; height: 24px; cursor: pointer;">
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 2px solid #bae6fd;">
                        <label style="font-size: 14px; font-weight: 600; display: block; margin-bottom: 10px; color: #1e40af;">الجمعة</label>
                        <input type="checkbox" id="modal_workDay_5" value="5" style="width: 24px; height: 24px; cursor: pointer;">
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 2px solid #bae6fd;">
                        <label style="font-size: 14px; font-weight: 600; display: block; margin-bottom: 10px; color: #1e40af;">السبت</label>
                        <input type="checkbox" id="modal_workDay_6" value="6" style="width: 24px; height: 24px; cursor: pointer;">
                    </div>
                </div>
                <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-top: 15px; border: 2px solid #f59e0b;">
                    <small style="color: #92400e; font-size: 12px;">
                        <strong>💡 ملاحظة:</strong> ✓ = يوم عمل | ☐ = عطلة مدفوعة الأجر
                    </small>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-primary" onclick="closeModal('workDaysModal')">❌ إلغاء</button>
                <button type="button" class="btn btn-success" onclick="saveWorkDays()">💾 حفظ</button>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة مستخدم جديد -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <div class="modal-header"><h2>➕ إضافة مستخدم جديد</h2></div>
            <form id="addUserForm">
                <div class="form-group">
                    <label>البريد الإلكتروني</label>
                    <input type="email" id="newUserEmail" placeholder="admin@example.com" required>
                </div>
                <div class="form-group">
                    <label>كلمة المرور</label>
                    <input type="password" id="newUserPassword" placeholder="على الأقل 6 أحرف" minlength="6" required>
                </div>
                <div class="form-group">
                    <label>الدور</label>
                    <select id="newUserRole" required>
                        <option value="مدير">مدير</option>
                        <option value="مستخدم">مستخدم</option>
                        <option value="محاسب">محاسب</option>
                        <option value="مشرف">مشرف</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>نوع الصلاحيات</label>
                    <select id="newUserPermissionType" required onchange="togglePermissionDetails()">
                        <option value="custom">صلاحيات مخصصة</option>
                        <option value="full">صلاحيات كاملة</option>
                        <option value="limited">صلاحيات محدودة</option>
                    </select>
                </div>
                
                <div id="permissionDetails" style="display: none;">
                    <h4 style="color: var(--primary); margin: 20px 0 15px 0;">🔐 الصلاحيات التفصيلية المتقدمة</h4>
                    
                    <!-- إدارة الموظفين حسب النوع -->
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #e2e8f0;">
                        <h5 style="color: var(--primary); margin-bottom: 15px; font-size: 16px;">👥 إدارة الموظفين حسب النوع</h5>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                            <!-- الموظفون الشهريون -->
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                <h6 style="color: var(--dark); margin-bottom: 10px; font-size: 14px;">📅 الموظفون الشهريون</h6>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="perm_monthly_view" checked> عرض
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="perm_monthly_add"> إضافة
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="perm_monthly_edit"> تعديل
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="perm_monthly_delete"> حذف
                                </label>
                            </div>
                            
                            <!-- الموظفون اليوميون -->
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                <h6 style="color: var(--dark); margin-bottom: 10px; font-size: 14px;">📆 الموظفون اليوميون</h6>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="perm_daily_view" checked> عرض
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="perm_daily_add"> إضافة
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="perm_daily_edit"> تعديل
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="perm_daily_delete"> حذف
                                </label>
                            </div>
                            
                            <!-- موظفو السيارات -->
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                <h6 style="color: var(--dark); margin-bottom: 10px; font-size: 14px;">🚗 موظفو السيارات</h6>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="perm_vehicle_view" checked> عرض
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="perm_vehicle_add"> إضافة
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="perm_vehicle_edit"> تعديل
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="perm_vehicle_delete"> حذف
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- إدارة المشاريع -->
                    <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #bae6fd;">
                        <h5 style="color: var(--primary); margin-bottom: 15px; font-size: 16px;">🏗️ إدارة المشاريع</h5>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="checkbox" id="perm_projects_view" checked> عرض المشاريع
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="checkbox" id="perm_projects_add"> إضافة مشاريع
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="checkbox" id="perm_projects_edit"> تعديل المشاريع
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="checkbox" id="perm_projects_delete"> حذف المشاريع
                                </label>
                            </div>
                            
                            <div>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="radio" name="projectAccess" id="perm_projects_all" value="all" checked onchange="toggleSpecificProjects()"> جميع المشاريع
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="radio" name="projectAccess" id="perm_projects_specific" value="specific" onchange="toggleSpecificProjects()"> مشاريع محددة
                                </label>
                                <div id="specificProjectsDiv" style="display: none; margin-top: 10px;">
                                    <select id="perm_projects_list" multiple style="width: 100%; height: 80px; font-size: 12px; padding: 5px; border: 1px solid var(--border); border-radius: 6px;">
                                        <!-- سيتم ملؤها بالكود -->
                                    </select>
                                    <small style="color: var(--gray); font-size: 11px;">اضغط Ctrl لاختيار عدة مشاريع</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- إدارة الأشهر -->
                    <div style="background: #fce7f3; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #f9a8d4;">
                        <h5 style="color: var(--primary); margin-bottom: 15px; font-size: 16px;">📅 التحكم بالأشهر</h5>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="radio" name="monthAccess" id="perm_months_all" value="all" checked onchange="toggleSpecificMonths()"> جميع الأشهر
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="radio" name="monthAccess" id="perm_months_specific" value="specific" onchange="toggleSpecificMonths()"> أشهر محددة
                                </label>
                                <div id="specificMonthsDiv" style="display: none; margin-top: 10px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: var(--dark); font-size: 12px;">اختر الأشهر المسموحة:</label>
                                    <div style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; padding: 8px; background: white;">
                                        <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 12px;">
                                            <input type="checkbox" class="month-checkbox" value="january"> يناير
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 12px;">
                                            <input type="checkbox" class="month-checkbox" value="february"> فبراير
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 12px;">
                                            <input type="checkbox" class="month-checkbox" value="march"> مارس
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 12px;">
                                            <input type="checkbox" class="month-checkbox" value="april"> أبريل
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 12px;">
                                            <input type="checkbox" class="month-checkbox" value="may"> مايو
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 12px;">
                                            <input type="checkbox" class="month-checkbox" value="june"> يونيو
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 12px;">
                                            <input type="checkbox" class="month-checkbox" value="july"> يوليو
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 12px;">
                                            <input type="checkbox" class="month-checkbox" value="august"> أغسطس
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 12px;">
                                            <input type="checkbox" class="month-checkbox" value="september"> سبتمبر
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 12px;">
                                            <input type="checkbox" class="month-checkbox" value="october"> أكتوبر
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 12px;">
                                            <input type="checkbox" class="month-checkbox" value="november"> نوفمبر
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 12px;">
                                            <input type="checkbox" class="month-checkbox" value="december"> ديسمبر
                                        </label>
                                    </div>
                                    <small style="color: var(--gray); font-size: 11px; display: block; margin-top: 5px;">حدد الأشهر التي يمكنه الوصول إليها</small>
                                </div>
                            </div>
                            
                            <div>
                                <h6 style="color: var(--dark); margin-bottom: 10px; font-size: 13px;">الصلاحيات على الأشهر:</h6>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="perm_months_view" checked> عرض بيانات الأشهر
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="perm_months_edit"> تعديل بيانات الأشهر
                                </label>
                                <p style="font-size: 11px; color: var(--gray); margin-top: 10px; line-height: 1.6;">
                                    💡 <strong>ملاحظة:</strong> إذا حددت أشهر معينة، سيتمكن المستخدم من رؤية وتعديل تلك الأشهر فقط.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- إدارة المستخدمين والتقارير -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border: 1px solid #fbbf24;">
                            <h5 style="color: var(--dark); margin-bottom: 10px; font-size: 14px;">👥 إدارة المستخدمين</h5>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                <input type="checkbox" id="perm_users_view"> عرض المستخدمين
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                <input type="checkbox" id="perm_users_add"> إضافة مستخدمين
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                <input type="checkbox" id="perm_users_edit"> تعديل المستخدمين
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                <input type="checkbox" id="perm_users_delete"> حذف المستخدمين
                            </label>
                        </div>
                        
                        <div style="background: #d1fae5; padding: 15px; border-radius: 8px; border: 1px solid #10b981;">
                            <h5 style="color: var(--dark); margin-bottom: 10px; font-size: 14px;">📊 التقارير والبيانات</h5>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                <input type="checkbox" id="perm_reports_view" checked> عرض التقارير
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                <input type="checkbox" id="perm_reports_export"> تصدير البيانات
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                <input type="checkbox" id="perm_reports_print"> طباعة التقارير
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                <input type="checkbox" id="perm_settings"> إعدادات النظام
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="closeModal('addUserModal')">إلغاء</button>
                    <button type="submit" class="btn btn-success">إضافة المستخدم</button>
                </div>
            </form>
        </div>
    </div>

    <!-- نافذة ربط UID بالصلاحيات -->
    <div class="modal" id="linkUserModal">
        <div class="modal-content">
            <div class="modal-header"><h2>🔗 ربط مستخدم بالصلاحيات</h2></div>
            <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 13px;">
                <strong>💡 تعليمات:</strong><br>
                1. أضف المستخدم أولاً في Firebase Authentication<br>
                2. انسخ الـ UID من Firebase Console<br>
                3. الصقه هنا وحدد الصلاحيات
            </div>
            <form id="linkUserForm">
                <div class="form-group">
                    <label>User UID (من Firebase Authentication)</label>
                    <input type="text" id="linkUserUID" placeholder="مثال: abc123xyz456..." required>
                </div>
                <div class="form-group">
                    <label>البريد الإلكتروني (اختياري)</label>
                    <input type="email" id="linkUserEmail" placeholder="للمرجعية فقط">
                </div>
                <div class="form-group">
                    <label>الدور</label>
                    <select id="linkUserRole" required>
                        <option value="مدير">مدير</option>
                        <option value="مستخدم">مستخدم</option>
                        <option value="محاسب">محاسب</option>
                        <option value="مشرف">مشرف</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>نوع الصلاحيات</label>
                    <select id="linkUserPermissionType" required onchange="toggleLinkPermissionDetails()">
                        <option value="custom">صلاحيات مخصصة</option>
                        <option value="full">صلاحيات كاملة</option>
                        <option value="limited">صلاحيات محدودة</option>
                    </select>
                </div>
                
                <div id="linkPermissionDetails" style="display: none;">
                    <h4 style="color: var(--primary); margin: 20px 0 15px 0;">🔐 الصلاحيات التفصيلية المتقدمة</h4>
                    
                    <!-- إدارة الموظفين حسب النوع -->
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #e2e8f0;">
                        <h5 style="color: var(--primary); margin-bottom: 15px; font-size: 16px;">👥 إدارة الموظفين حسب النوع</h5>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                            <!-- الموظفون الشهريون -->
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                <h6 style="color: var(--dark); margin-bottom: 10px; font-size: 14px;">📅 الموظفون الشهريون</h6>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="link_perm_monthly_view" checked> عرض
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="link_perm_monthly_add"> إضافة
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="link_perm_monthly_edit"> تعديل
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="link_perm_monthly_delete"> حذف
                                </label>
                            </div>
                            
                            <!-- الموظفون اليوميون -->
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                <h6 style="color: var(--dark); margin-bottom: 10px; font-size: 14px;">📆 الموظفون اليوميون</h6>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="link_perm_daily_view" checked> عرض
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="link_perm_daily_add"> إضافة
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="link_perm_daily_edit"> تعديل
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="link_perm_daily_delete"> حذف
                                </label>
                            </div>
                            
                            <!-- موظفو السيارات -->
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                <h6 style="color: var(--dark); margin-bottom: 10px; font-size: 14px;">🚗 موظفو السيارات</h6>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="link_perm_vehicle_view" checked> عرض
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="link_perm_vehicle_add"> إضافة
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="link_perm_vehicle_edit"> تعديل
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                    <input type="checkbox" id="link_perm_vehicle_delete"> حذف
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- إدارة المشاريع -->
                    <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #bae6fd;">
                        <h5 style="color: var(--primary); margin-bottom: 15px; font-size: 16px;">🏗️ إدارة المشاريع</h5>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="checkbox" id="link_perm_projects_view" checked> عرض المشاريع
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="checkbox" id="link_perm_projects_add"> إضافة مشاريع
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="checkbox" id="link_perm_projects_edit"> تعديل المشاريع
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="checkbox" id="link_perm_projects_delete"> حذف المشاريع
                                </label>
                            </div>
                            
                            <div>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="radio" name="linkProjectAccess" id="link_perm_projects_all" value="all" checked onchange="toggleLinkSpecificProjects()"> جميع المشاريع
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="radio" name="linkProjectAccess" id="link_perm_projects_specific" value="specific" onchange="toggleLinkSpecificProjects()"> مشاريع محددة
                                </label>
                                <div id="linkSpecificProjectsDiv" style="display: none; margin-top: 10px;">
                                    <select id="link_perm_projects_list" multiple style="width: 100%; height: 80px; font-size: 12px; padding: 5px; border: 1px solid var(--border); border-radius: 6px;">
                                        <!-- سيتم ملؤها بالكود -->
                                    </select>
                                    <small style="color: var(--gray); font-size: 11px;">اضغط Ctrl لاختيار عدة مشاريع</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- إدارة المستخدمين والتقارير -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border: 1px solid #fbbf24;">
                            <h5 style="color: var(--dark); margin-bottom: 10px; font-size: 14px;">👥 إدارة المستخدمين</h5>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                <input type="checkbox" id="link_perm_users_view"> عرض المستخدمين
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                <input type="checkbox" id="link_perm_users_add"> إضافة مستخدمين
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                <input type="checkbox" id="link_perm_users_edit"> تعديل المستخدمين
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                <input type="checkbox" id="link_perm_users_delete"> حذف المستخدمين
                            </label>
                        </div>
                        
                        <div style="background: #d1fae5; padding: 15px; border-radius: 8px; border: 1px solid #10b981;">
                            <h5 style="color: var(--dark); margin-bottom: 10px; font-size: 14px;">📊 التقارير والبيانات</h5>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                <input type="checkbox" id="link_perm_reports_view" checked> عرض التقارير
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                <input type="checkbox" id="link_perm_reports_export"> تصدير البيانات
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                <input type="checkbox" id="link_perm_reports_print"> طباعة التقارير
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                                <input type="checkbox" id="link_perm_settings"> إعدادات النظام
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="closeModal('linkUserModal')">إلغاء</button>
                    <button type="submit" class="btn btn-success">ربط المستخدم</button>
                </div>
            </form>
        </div>
    </div>

    <!-- نافذة تعديل صلاحيات المستخدم -->
    <div class="modal" id="editUserModal">
        <div class="modal-content" style="max-width: 1100px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>⚙️ تعديل صلاحيات المستخدم المتقدمة</h2>
                <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-top: 5px;">تحكم دقيق في جميع الصلاحيات</p>
            </div>
            <form id="editUserForm">
                <input type="hidden" id="editUserUID">
                
                <div class="form-group">
                    <label>📧 البريد الإلكتروني</label>
                    <input type="text" id="editUserEmail" disabled style="background: #f3f4f6;">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>👤 الدور</label>
                        <select id="editUserRole" required>
                            <option value="مدير">مدير</option>
                            <option value="محاسب">محاسب</option>
                            <option value="مشرف">مشرف</option>
                            <option value="مستخدم">مستخدم</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>🔐 نوع الصلاحيات</label>
                        <select id="editUserPermissionType" required onchange="toggleEditPermissionDetails()">
                            <option value="custom">صلاحيات مخصصة متقدمة</option>
                            <option value="full">صلاحيات كاملة</option>
                            <option value="limited">صلاحيات محدودة (قراءة فقط)</option>
                        </select>
                    </div>
                </div>
                
                <div id="editPermissionDetails" style="display: none;">
                    <div class="permissions-section">
                        <h4>📅 صلاحيات الأشهر</h4>
                        <div class="permissions-grid">
                            <label><input type="checkbox" id="edit_months_view" checked> عرض جدول الشهر</label>
                            <label><input type="checkbox" id="edit_months_viewDetails"> عرض تفاصيل الموظفين</label>
                            <label><input type="checkbox" id="edit_months_add"> إضافة موظفين جدد</label>
                            <label><input type="checkbox" id="edit_months_edit"> تعديل بيانات الموظفين</label>
                            <div class="sub-permissions">
                                <label><input type="checkbox" id="edit_months_editSalary"> تعديل الراتب</label>
                                <label><input type="checkbox" id="edit_months_editBonus"> تعديل البونص</label>
                                <label><input type="checkbox" id="edit_months_editDeductions"> تعديل الخصومات</label>
                                <label><input type="checkbox" id="edit_months_editAdvance"> تعديل السلفة</label>
                            </div>
                            <label><input type="checkbox" id="edit_months_delete"> حذف موظفين</label>
                            <label><input type="checkbox" id="edit_months_copy"> نسخ موظفين</label>
                            <label><input type="checkbox" id="edit_months_print"> طباعة التقارير</label>
                            <label><input type="checkbox" id="edit_months_export"> تصدير البيانات</label>
                            <label><input type="checkbox" id="edit_months_filter"> استخدام الفلاتر</label>
                            <label><input type="checkbox" id="edit_months_search"> البحث في البيانات</label>
                            <label><input type="checkbox" id="edit_months_lockMonths"> إدارة قفل الأشهر</label>
                        </div>
                        
                        <!-- قسم قفل الأشهر -->
                        <div id="monthLockSection" style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border: 2px solid #f59e0b;">
                            <h5 style="color: #92400e; margin: 0 0 15px 0; font-size: 14px; font-weight: 600;">
                                🔒 قفل الأشهر من التعديل
                            </h5>
                            <p style="font-size: 12px; color: #92400e; margin: 0 0 15px 0;">
                                المستخدم يمكنه رؤية المحتوى ولكن لا يمكنه تعديله
                            </p>
                            <div id="monthLockContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <!-- سيتم ملؤها بالجافاسكريبت -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="permissions-section">
                        <h4>🏗️ صلاحيات المشاريع</h4>
                        <div class="permissions-grid">
                            <label><input type="checkbox" id="edit_projects_view" checked> عرض قائمة المشاريع</label>
                            <label><input type="checkbox" id="edit_projects_viewAll" onchange="toggleEditProjectsList()"> عرض جميع المشاريع</label>
                            <div style="grid-column: 1/-1;" id="edit_specificProjectsContainer">
                                <label style="font-weight: 600; margin-bottom: 10px; display: block; color: var(--primary);">
                                    🎯 المشاريع المسموح بها (إذا لم يتم تحديد "جميع المشاريع"):
                                </label>
                                <div id="edit_allowedProjectsContainer" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #e2e8f0;"></div>
                            </div>
                            <label><input type="checkbox" id="edit_projects_viewDetails"> عرض تفاصيل المشروع</label>
                            <label><input type="checkbox" id="edit_projects_add"> إضافة مشروع جديد</label>
                            <label><input type="checkbox" id="edit_projects_edit"> تعديل بيانات المشروع</label>
                            <label><input type="checkbox" id="edit_projects_editEmployees"> تعديل موظفي المشروع</label>
                            <label><input type="checkbox" id="edit_projects_delete"> حذف مشروع</label>
                            <label><input type="checkbox" id="edit_projects_print"> طباعة تقرير المشروع</label>
                            <label><input type="checkbox" id="edit_projects_export"> تصدير بيانات المشروع</label>
                        </div>
                    </div>
                    
                    <div class="permissions-section">
                        <h4>👥 صلاحيات الموظفين (عامة)</h4>
                        <div class="permissions-grid">
                            <label><input type="checkbox" id="edit_employees_view" checked> عرض الموظفين</label>
                            <label><input type="checkbox" id="edit_employees_viewSalary"> عرض الرواتب</label>
                            <label><input type="checkbox" id="edit_employees_viewPersonal"> عرض البيانات الشخصية</label>
                            <label><input type="checkbox" id="edit_employees_add"> إضافة موظف</label>
                            <label><input type="checkbox" id="edit_employees_edit"> تعديل بيانات الموظف</label>
                            <label><input type="checkbox" id="edit_employees_delete"> حذف موظف</label>
                        </div>
                    </div>
                    
                    <div class="permissions-section">
                        <h4>💼 صلاحيات الموظفين الشهريين (Monthly)</h4>
                        <div class="permissions-grid">
                            <label><input type="checkbox" id="edit_employees_monthly_view"> عرض</label>
                            <label><input type="checkbox" id="edit_employees_monthly_add"> إضافة</label>
                            <label><input type="checkbox" id="edit_employees_monthly_edit"> تعديل</label>
                            <label><input type="checkbox" id="edit_employees_monthly_delete"> حذف</label>
                            <div class="sub-permissions">
                                <label><input type="checkbox" id="edit_employees_monthly_editSalary"> تعديل الراتب</label>
                                <label><input type="checkbox" id="edit_employees_monthly_editBonus"> تعديل البونص</label>
                                <label><input type="checkbox" id="edit_employees_monthly_editDeductions"> تعديل الخصومات</label>
                                <label><input type="checkbox" id="edit_employees_monthly_editAdvance"> تعديل السلفة</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="permissions-section">
                        <h4>📅 صلاحيات الموظفين اليوميين (Daily)</h4>
                        <div class="permissions-grid">
                            <label><input type="checkbox" id="edit_employees_daily_view"> عرض</label>
                            <label><input type="checkbox" id="edit_employees_daily_add"> إضافة</label>
                            <label><input type="checkbox" id="edit_employees_daily_edit"> تعديل</label>
                            <label><input type="checkbox" id="edit_employees_daily_delete"> حذف</label>
                            <div class="sub-permissions">
                                <label><input type="checkbox" id="edit_employees_daily_editSalary"> تعديل الراتب</label>
                                <label><input type="checkbox" id="edit_employees_daily_editBonus"> تعديل البونص</label>
                                <label><input type="checkbox" id="edit_employees_daily_editDeductions"> تعديل الخصومات</label>
                                <label><input type="checkbox" id="edit_employees_daily_editAdvance"> تعديل السلفة</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="permissions-section">
                        <h4>🚗 صلاحيات موظفي المركبات (Vehicle)</h4>
                        <div class="permissions-grid">
                            <label><input type="checkbox" id="edit_employees_vehicle_view"> عرض</label>
                            <label><input type="checkbox" id="edit_employees_vehicle_add"> إضافة</label>
                            <label><input type="checkbox" id="edit_employees_vehicle_edit"> تعديل</label>
                            <label><input type="checkbox" id="edit_employees_vehicle_delete"> حذف</label>
                            <div class="sub-permissions">
                                <label><input type="checkbox" id="edit_employees_vehicle_editSalary"> تعديل الراتب</label>
                                <label><input type="checkbox" id="edit_employees_vehicle_editBonus"> تعديل البونص</label>
                                <label><input type="checkbox" id="edit_employees_vehicle_editDeductions"> تعديل الخصومات</label>
                                <label><input type="checkbox" id="edit_employees_vehicle_editAdvance"> تعديل السلفة</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="permissions-section">
                        <h4>🔒 الحقول المقفولة</h4>
                        <div class="permissions-grid">
                            <label><input type="checkbox" id="edit_lockedFields_view"> رؤية الحقول المقفولة</label>
                            <label><input type="checkbox" id="edit_lockedFields_edit"> تعديل الحقول المقفولة</label>
                            <label><input type="checkbox" id="edit_lockedFields_unlock"> فتح القفل</label>
                            <label><input type="checkbox" id="edit_lockedFields_editSalaryIncrease"> تعديل الزيادة</label>
                            <label><input type="checkbox" id="edit_lockedFields_editCEOBonus"> تعديل مكافأة CEO</label>
                        </div>
                    </div>
                    
                    <div class="permissions-section">
                        <h4>📊 صلاحيات التقارير</h4>
                        <div class="permissions-grid">
                            <label><input type="checkbox" id="edit_reports_view" checked> عرض التقارير</label>
                            <label><input type="checkbox" id="edit_reports_viewMonthly"> تقارير شهرية</label>
                            <label><input type="checkbox" id="edit_reports_viewProject"> تقارير مشاريع</label>
                            <label><input type="checkbox" id="edit_reports_viewEmployee"> تقارير موظفين</label>
                            <label><input type="checkbox" id="edit_reports_viewFinancial"> التقارير المالية</label>
                            <label><input type="checkbox" id="edit_reports_print"> طباعة التقارير</label>
                            <label><input type="checkbox" id="edit_reports_printPreview"> معاينة الطباعة</label>
                            <label><input type="checkbox" id="edit_reports_export"> تصدير التقارير</label>
                            <label><input type="checkbox" id="edit_reports_exportPDF"> تصدير PDF</label>
                            <label><input type="checkbox" id="edit_reports_exportExcel"> تصدير Excel</label>
                        </div>
                    </div>
                    
                    <div class="permissions-section">
                        <h4>👤 صلاحيات المستخدمين</h4>
                        <div class="permissions-grid">
                            <label><input type="checkbox" id="edit_users_view"> عرض المستخدمين</label>
                            <label><input type="checkbox" id="edit_users_viewDetails"> عرض تفاصيل المستخدم</label>
                            <label><input type="checkbox" id="edit_users_add"> إضافة مستخدم</label>
                            <label><input type="checkbox" id="edit_users_edit"> تعديل مستخدم</label>
                            <label><input type="checkbox" id="edit_users_editPermissions"> تعديل صلاحيات</label>
                            <label><input type="checkbox" id="edit_users_editRole"> تعديل الدور</label>
                            <label><input type="checkbox" id="edit_users_delete"> حذف مستخدم</label>
                            <label><input type="checkbox" id="edit_users_viewActivity"> عرض سجل النشاطات</label>
                        </div>
                    </div>
                    
                    <div class="permissions-section">
                        <h4>⚙️ صلاحيات الإعدادات</h4>
                        <div class="permissions-grid">
                            <label><input type="checkbox" id="edit_settings_view"> عرض الإعدادات</label>
                            <label><input type="checkbox" id="edit_settings_editGeneral"> تعديل الإعدادات العامة</label>
                            <label><input type="checkbox" id="edit_settings_editProjects"> إدارة المشاريع</label>
                            <label><input type="checkbox" id="edit_settings_editSignatures"> تعديل التوقيعات</label>
                            <label><input type="checkbox" id="edit_settings_editAppearance"> تعديل المظهر</label>
                            <label><input type="checkbox" id="edit_settings_editLanguage"> تغيير اللغة</label>
                            <label><input type="checkbox" id="edit_settings_editBackup"> النسخ الاحتياطي</label>
                            <label><input type="checkbox" id="edit_settings_viewLogs"> عرض السجلات</label>
                        </div>
                    </div>
                    
                    <div class="permissions-section">
                        <h4>📈 صلاحيات لوحة التحكم</h4>
                        <div class="permissions-grid">
                            <label><input type="checkbox" id="edit_dashboard_view"> عرض لوحة التحكم</label>
                            <label><input type="checkbox" id="edit_dashboard_viewStatistics"> عرض الإحصائيات</label>
                            <label><input type="checkbox" id="edit_dashboard_viewCharts"> عرض الرسوم البيانية</label>
                            <label><input type="checkbox" id="edit_dashboard_viewRecentActivity"> النشاطات الأخيرة</label>
                            <label><input type="checkbox" id="edit_dashboard_viewFinancialSummary"> الملخص المالي</label>
                        </div>
                    </div>
                    
                    <div style="background: #dbeafe; padding: 15px; border-radius: 8px; margin-top: 20px; border: 2px solid #3b82f6;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="button" class="btn btn-secondary" onclick="selectAllEditPermissions(true)" style="font-size: 13px; padding: 8px 16px;">✅ تحديد الكل</button>
                            <button type="button" class="btn btn-secondary" onclick="selectAllEditPermissions(false)" style="font-size: 13px; padding: 8px 16px;">❌ إلغاء الكل</button>
                            <button type="button" class="btn btn-secondary" onclick="selectViewOnlyEditPermissions()" style="font-size: 13px; padding: 8px 16px;">👁️ عرض فقط</button>
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions" style="margin-top: 20px;">
                    <button type="button" class="btn btn-primary" onclick="closeModal('editUserModal')">❌ إلغاء</button>
                    <button type="submit" class="btn btn-success" style="font-weight: 700;">💾 حفظ التعديلات</button>
                </div>
            </form>
        </div>
    </div>
    <style>
    .permissions-section { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .permissions-section h4 { color: var(--primary); margin: 0 0 15px 0; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .permissions-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .permissions-grid label { display: flex; align-items: center; gap: 8px; font-size: 13px; padding: 10px; background: white; border-radius: 6px; cursor: pointer; transition: all 0.2s; border: 1px solid #e2e8f0; }
    .permissions-grid label:hover { background: #f0f9ff; border-color: var(--primary); }
    .permissions-grid input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .sub-permissions { grid-column: 1/-1; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin: 10px 0; padding: 15px; background: #f0f9ff; border-radius: 8px; border-right: 4px solid var(--primary); }
    .sub-permissions label { font-size: 12px; color: #64748b; background: white; }
    </style>

    <!-- نافذة تفاصيل الدفع -->
    <div class="modal" id="paymentDetailsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="paymentDetailsModalTitle">💳 تفاصيل الدفع</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label id="paymentPaidDateLabel">تاريخ الدفع:</label>
                    <input type="date" id="paymentPaidDate" class="form-control">
                </div>
                <div class="form-group">
                    <label id="paymentMethodLabel">طريقة الدفع:</label>
                    <select id="paymentMethod" class="form-control">
                        <option value="cash" id="paymentMethodCash">نقداً</option>
                        <option value="transfer" id="paymentMethodTransfer">تحويل بنكي</option>
                        <option value="check" id="paymentMethodCheck">شيك</option>
                        <option value="other" id="paymentMethodOther">أخرى</option>
                    </select>
                </div>
                <div class="form-group">
                    <label id="paymentNotesLabel">ملاحظات الدفع:</label>
                    <textarea id="paymentNotes" class="form-control" rows="4" placeholder="أدخل أي ملاحظات إضافية..."></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeModal('paymentDetailsModal')" id="paymentDetailsCancelBtn">إلغاء</button>
                <button class="btn btn-success" onclick="savePaymentDetails()" id="paymentDetailsSaveBtn">حفظ</button>
            </div>
        </div>
    </div>

    <!-- نافذة الدفع الجماعي -->
    <div class="modal" id="bulkPaymentModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="bulkPaymentModalTitle">💳 دفع جماعي</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label id="bulkPaymentDateLabel">تاريخ الدفع:</label>
                    <input type="date" id="bulkPaymentDate" class="form-control">
                </div>
                <div class="form-group">
                    <label id="bulkPaymentMethodLabel">طريقة الدفع:</label>
                    <select id="bulkPaymentMethod" class="form-control">
                        <option value="cash" id="bulkPaymentMethodCash">نقداً</option>
                        <option value="transfer" id="bulkPaymentMethodTransfer">تحويل بنكي</option>
                        <option value="check" id="bulkPaymentMethodCheck">شيك</option>
                        <option value="other" id="bulkPaymentMethodOther">أخرى</option>
                    </select>
                </div>
                <div class="form-group">
                    <label id="bulkPaymentNotesLabel">ملاحظات الدفع:</label>
                    <textarea id="bulkPaymentNotes" class="form-control" rows="4" placeholder="ملاحظات الدفع الجماعي..."></textarea>
                </div>
                <div id="bulkPaymentCount" style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-top: 15px; border: 2px solid #3b82f6;">
                    <strong style="color: #1e40af;" id="bulkPaymentCountText">عدد الموظفين المحددين: <span id="bulkPaymentCountValue">0</span></strong>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeModal('bulkPaymentModal')" id="bulkPaymentCancelBtn">إلغاء</button>
                <button class="btn btn-success" onclick="confirmBulkPayment()" id="bulkPaymentSaveBtn">✅ تحديد المحدد كمدفوع</button>
            </div>
        </div>
    </div>

    <!-- نافذة إدارة الحجز -->
    <div class="modal" id="reservationModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="reservationModalTitle">💰 حجز الراتب</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="reservationEnabled" onchange="toggleReservationEnabled()">
                        <span id="reservationEnabledLabel">تفعيل الحجز</span>
                    </label>
                </div>
                <div id="reservationSettings" style="display: none;">
                    <div class="form-group">
                        <label id="reservationPercentageLabel">نسبة الحجز (%):</label>
                        <input type="number" id="reservationPercentage" class="form-control" min="0" max="100" step="0.1" onchange="updateReservationCalculation()">
                    </div>
                    <div class="form-group">
                        <label id="previousReservedAmountLabel">الرصيد السابق (من أشهر غير موجودة في قاعدة البيانات):</label>
                        <input type="number" id="previousReservedAmount" class="form-control" min="0" step="0.01" style="background: #fff; font-weight: 600;" title="رصيد الحجز من الأشهر التي لم يتم حفظها في قاعدة البيانات">
                        <small style="color: #666; font-size: 11px;" id="previousReservedAmountNote">أدخل الرصيد السابق للموظف من الأشهر التي لم يتم حفظها في قاعدة البيانات</small>
                    </div>
                    <div class="form-group">
                        <label id="accumulatedReservedAmountLabel">المبلغ المحجوز من قاعدة البيانات:</label>
                        <input type="number" id="accumulatedReservedAmount" class="form-control" min="0" step="0.01" readonly style="background: #e5e7eb; font-weight: 600;" title="يتم حسابه تلقائياً من الأشهر السابقة في قاعدة البيانات">
                        <small style="color: #666; font-size: 11px;" id="accumulatedReservedAmountNote">يتم حسابه تلقائياً من الأشهر السابقة في قاعدة البيانات</small>
                    </div>
                    <div class="form-group">
                        <label id="targetReservedAmountLabel">الهدف (راتب أساسي واحد):</label>
                        <input type="number" id="targetReservedAmount" class="form-control" min="0" step="0.01" readonly style="background: #f3f4f6;">
                        <small style="color: #666;" id="targetReservedAmountNote">يُحسب تلقائياً من الراتب الأساسي</small>
                    </div>
                    <div class="form-group">
                        <label id="reservationCurrencyLabel">عملة الحجز:</label>
                        <select id="reservationCurrency" class="form-control">
                            <option value="USD">USD</option>
                            <option value="IQD">IQD</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label id="reservationNotesLabel">ملاحظات الحجز:</label>
                        <textarea id="reservationNotes" class="form-control" rows="3" placeholder="ملاحظات إضافية..."></textarea>
                    </div>
                    <div id="reservationCalcDetails" style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-left: 4px solid var(--primary); border-radius: 8px;">
                        <!-- Calculation details will be rendered here -->
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeModal('reservationModal')" id="reservationCancelBtn">إلغاء</button>
                <button class="btn btn-success" onclick="saveReservation()" id="reservationSaveBtn">حفظ</button>
            </div>
        </div>
    </div>

    <!-- Chart.js Library for Dashboard Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script type="module">
// ========== Firebase Configuration ==========
        // استخدام dynamic imports مع معالجة الأخطاء
        let initializeApp, getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, updateDoc, query, orderBy, addDoc;
        let getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, deleteUser;
        let createClient;
        
        // تحميل Firebase modules بشكل آمن
        try {
            const firebaseApp = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
            initializeApp = firebaseApp.initializeApp;
            
            const firebaseFirestore = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            getFirestore = firebaseFirestore.getFirestore;
            collection = firebaseFirestore.collection;
            doc = firebaseFirestore.doc;
            setDoc = firebaseFirestore.setDoc;
            getDoc = firebaseFirestore.getDoc;
            getDocs = firebaseFirestore.getDocs;
            deleteDoc = firebaseFirestore.deleteDoc;
            updateDoc = firebaseFirestore.updateDoc;
            query = firebaseFirestore.query;
            orderBy = firebaseFirestore.orderBy;
            addDoc = firebaseFirestore.addDoc;
            
            const firebaseAuth = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
            getAuth = firebaseAuth.getAuth;
            signInWithEmailAndPassword = firebaseAuth.signInWithEmailAndPassword;
            signOut = firebaseAuth.signOut;
            onAuthStateChanged = firebaseAuth.onAuthStateChanged;
            createUserWithEmailAndPassword = firebaseAuth.createUserWithEmailAndPassword;
            deleteUser = firebaseAuth.deleteUser;
            
            console.log('✅ Firebase modules loaded successfully');
        } catch (error) {
            console.error('❌ خطأ في تحميل Firebase modules:', error);
            console.warn('⚠️ سيتم استخدام الوضع المحلي فقط');
            // التبديل التلقائي إلى الوضع المحلي عند فشل تحميل Firebase
            if (typeof localStorage !== 'undefined') {
                localStorage.setItem('payrose_storage_mode', 'local');
            }
        }
        
        // ========== Supabase Configuration ==========
        try {
            const supabaseModule = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
            createClient = supabaseModule.createClient;
            console.log('✅ Supabase module loaded successfully');
        } catch (error) {
            console.error('❌ خطأ في تحميل Supabase module:', error);
            console.warn('⚠️ Supabase لن يكون متاحاً');
        }

        const DEFAULT_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAuRPgQrAcK7QAdGaaANncbyo53O3y3m0U",
            authDomain: "salary-system-v2.firebaseapp.com",
            databaseURL: "https://salary-system-v2-default-rtdb.firebaseio.com",
            projectId: "salary-system-v2",
            storageBucket: "salary-system-v2.firebasestorage.app",
            messagingSenderId: "1068277791957",
            appId: "1:1068277791957:web:d948c942e6d45cc936765c",
            measurementId: "G-EQ05SM8NCJ"
        };

        const DB_CONFIG_STORAGE_KEY = 'payrose_db_config';

        function loadSavedDbConfig() {
            try {
                const stored = localStorage.getItem(DB_CONFIG_STORAGE_KEY);
                if (!stored) return null;
                const parsed = JSON.parse(stored);
                if (parsed && typeof parsed === 'object') {
                    return parsed;
                }
            } catch (error) {
                console.error('⚠️ فشل في قراءة إعدادات قاعدة البيانات المحفوظة', error);
            }
            return null;
        }

        function mergeDbConfigs(base, override) {
            if (!override || typeof override !== 'object') {
                return { ...base };
            }
            const merged = { ...base };
            Object.keys(override).forEach(key => {
                if (override[key]) {
                    merged[key] = override[key];
                }
            });
            return merged;
        }

        function saveDatabaseConfigToStorage(config) {
            localStorage.setItem(DB_CONFIG_STORAGE_KEY, JSON.stringify(config));
            isCustomFirebaseConfig = true;
        }

        function clearDatabaseConfigFromStorage() {
            localStorage.removeItem(DB_CONFIG_STORAGE_KEY);
            isCustomFirebaseConfig = false;
        }

        function getActiveDatabaseConfig() {
            return { ...firebaseConfig };
        }

        function getDefaultDatabaseConfig() {
            return { ...DEFAULT_FIREBASE_CONFIG };
        }

        function isCustomDatabaseConfig() {
            return isCustomFirebaseConfig;
        }
        
        // ========== Local Storage Mode (Offline Mode) ==========
        const STORAGE_MODE_KEY = 'payrose_storage_mode';
        const LOCAL_STORAGE_PREFIX = 'payrose_local_';
        
        // تحديد وضع التخزين: 'firebase' أو 'local'
        let storageMode = localStorage.getItem(STORAGE_MODE_KEY) || 'firebase';
        
        function setStorageMode(mode) {
            if (mode === 'firebase' || mode === 'local') {
                storageMode = mode;
                localStorage.setItem(STORAGE_MODE_KEY, mode);
                console.log('✅ تم تغيير وضع التخزين إلى:', mode);
                return true;
            }
            return false;
        }
        
        function getStorageMode() {
            return storageMode;
        }
        
        // ========== Local Storage Functions ==========
        const LocalStorage = {
            // حفظ البيانات
            save: function(key, data) {
                try {
                    const fullKey = LOCAL_STORAGE_PREFIX + key;
                    localStorage.setItem(fullKey, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('❌ خطأ في حفظ البيانات محلياً:', error);
                    return false;
                }
            },
            
            // قراءة البيانات
            load: function(key) {
                try {
                    const fullKey = LOCAL_STORAGE_PREFIX + key;
                    const data = localStorage.getItem(fullKey);
                    if (data) {
                        return JSON.parse(data);
                    }
                    return null;
                } catch (error) {
                    console.error('❌ خطأ في قراءة البيانات محلياً:', error);
                    return null;
                }
            },
            
            // حذف البيانات
            delete: function(key) {
                try {
                    const fullKey = LOCAL_STORAGE_PREFIX + key;
                    localStorage.removeItem(fullKey);
                    return true;
                } catch (error) {
                    console.error('❌ خطأ في حذف البيانات محلياً:', error);
                    return false;
                }
            },
            
            // الحصول على جميع المفاتيح
            getAllKeys: function() {
                const keys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(LOCAL_STORAGE_PREFIX)) {
                        keys.push(key.replace(LOCAL_STORAGE_PREFIX, ''));
                    }
                }
                return keys;
            },
            
            // مسح جميع البيانات المحلية
            clearAll: function() {
                try {
                    const keys = this.getAllKeys();
                    keys.forEach(key => this.delete(key));
                    return true;
                } catch (error) {
                    console.error('❌ خطأ في مسح البيانات المحلية:', error);
                    return false;
                }
            }
        };
        
        // ========== Local Authentication ==========
        const LocalAuth = {
            // حفظ المستخدمين
            users: LocalStorage.load('users') || {},
            
            // تسجيل مستخدم جديد
            register: function(email, password, userData = {}) {
                if (this.users[email]) {
                    return { success: false, error: 'المستخدم موجود بالفعل' };
                }
                
                const user = {
                    email: email,
                    password: btoa(password), // تشفير بسيط (Base64)
                    ...userData,
                    createdAt: new Date().toISOString(),
                    uid: Date.now().toString() + Math.random().toString(36).substr(2, 9)
                };
                
                this.users[email] = user;
                LocalStorage.save('users', this.users);
                
                return { success: true, user: { ...user, password: undefined } };
            },
            
            // تسجيل الدخول
            login: function(email, password) {
                const user = this.users[email];
                if (!user) {
                    return { success: false, error: 'البريد الإلكتروني أو كلمة المرور غير صحيحة' };
                }
                
                if (user.password !== btoa(password)) {
                    return { success: false, error: 'البريد الإلكتروني أو كلمة المرور غير صحيحة' };
                }
                
                // حفظ جلسة المستخدم
                LocalStorage.save('currentUser', { ...user, password: undefined });
                
                return { success: true, user: { ...user, password: undefined } };
            },
            
            // تسجيل الخروج
            logout: function() {
                LocalStorage.delete('currentUser');
                return true;
            },
            
            // الحصول على المستخدم الحالي
            getCurrentUser: function() {
                return LocalStorage.load('currentUser');
            },
            
            // تحديث بيانات المستخدم
            updateUser: function(email, userData) {
                if (!this.users[email]) {
                    return { success: false, error: 'المستخدم غير موجود' };
                }
                
                this.users[email] = { ...this.users[email], ...userData };
                LocalStorage.save('users', this.users);
                
                // تحديث المستخدم الحالي إذا كان هو نفسه
                const current = this.getCurrentUser();
                if (current && current.email === email) {
                    LocalStorage.save('currentUser', { ...this.users[email], password: undefined });
                }
                
                return { success: true, user: { ...this.users[email], password: undefined } };
            },
            
            // حذف مستخدم
            deleteUser: function(email) {
                if (!this.users[email]) {
                    return { success: false, error: 'المستخدم غير موجود' };
                }
                
                delete this.users[email];
                LocalStorage.save('users', this.users);
                
                return { success: true };
            },
            
            // الحصول على جميع المستخدمين
            getAllUsers: function() {
                return Object.values(this.users).map(u => ({ ...u, password: undefined }));
            }
        };
        
        // ========== Local Data Storage Functions ==========
        const LocalData = {
            // حفظ الموظفين
            saveEmployees: function(year, month, employees) {
                const key = `employees_${year}_${month}`;
                return LocalStorage.save(key, employees);
            },
            
            // تحميل الموظفين
            loadEmployees: function(year, month) {
                const key = `employees_${year}_${month}`;
                return LocalStorage.load(key) || [];
            },
            
            // حفظ جميع بيانات الموظفين
            saveAllEmployees: function(employeeData) {
                return LocalStorage.save('all_employees', employeeData);
            },
            
            // تحميل جميع بيانات الموظفين
            loadAllEmployees: function() {
                return LocalStorage.load('all_employees') || {};
            },
            
            // حفظ المشاريع
            saveProjects: function(projects) {
                return LocalStorage.save('projects', projects);
            },
            
            // تحميل المشاريع
            loadProjects: function() {
                return LocalStorage.load('projects') || {};
            },
            
            // حفظ إعدادات الشركة
            saveCompanySettings: function(settings) {
                return LocalStorage.save('company_settings', settings);
            },
            
            // تحميل إعدادات الشركة
            loadCompanySettings: function() {
                return LocalStorage.load('company_settings') || {};
            },
            
            // حفظ التوقيعات
            saveSignatures: function(signatures) {
                return LocalStorage.save('signatures', signatures);
            },
            
            // تحميل التوقيعات
            loadSignatures: function() {
                return LocalStorage.load('signatures') || {};
            },
            
            // حفظ السنوات المتاحة
            saveYears: function(years) {
                return LocalStorage.save('available_years', years);
            },
            
            // تحميل السنوات المتاحة
            loadYears: function() {
                return LocalStorage.load('available_years') || [];
            }
        };
        
        // ========== Column Pinning Functions ==========
        // حفظ الأعمدة المثبتة لكل مستخدم
        function savePinnedColumns(tableType, pinnedColumns) {
            // استخدام المتغير العام currentUser (يعمل مع Firebase و LocalAuth)
            if (!currentUser || !currentUser.email) {
                // محاولة استخدام LocalAuth كبديل
                const localUser = LocalAuth.getCurrentUser();
                if (!localUser || !localUser.email) {
                    console.warn('⚠️ لا يوجد مستخدم مسجل دخول - لن يتم حفظ الأعمدة المثبتة');
                    return;
                }
                const key = `pinned_columns_${localUser.email}_${tableType}`;
                LocalStorage.save(key, pinnedColumns);
                console.log('✅ تم حفظ الأعمدة المثبتة للمستخدم:', localUser.email, 'النوع:', tableType, 'الأعمدة:', pinnedColumns);
                return;
            }
            
            const key = `pinned_columns_${currentUser.email}_${tableType}`;
            LocalStorage.save(key, pinnedColumns);
            console.log('✅ تم حفظ الأعمدة المثبتة للمستخدم:', currentUser.email, 'النوع:', tableType, 'الأعمدة:', pinnedColumns);
        }
        
        // تحميل الأعمدة المثبتة لكل مستخدم
        function loadPinnedColumns(tableType) {
            // استخدام المتغير العام currentUser (يعمل مع Firebase و LocalAuth)
            if (!currentUser || !currentUser.email) {
                // محاولة استخدام LocalAuth كبديل
                const localUser = LocalAuth.getCurrentUser();
                if (!localUser || !localUser.email) {
                    return [];
                }
                const key = `pinned_columns_${localUser.email}_${tableType}`;
                const loaded = LocalStorage.load(key) || [];
                console.log('📥 تم تحميل الأعمدة المثبتة للمستخدم:', localUser.email, 'النوع:', tableType, 'الأعمدة:', loaded);
                return loaded;
            }
            
            const key = `pinned_columns_${currentUser.email}_${tableType}`;
            const loaded = LocalStorage.load(key) || [];
            console.log('📥 تم تحميل الأعمدة المثبتة للمستخدم:', currentUser.email, 'النوع:', tableType, 'الأعمدة:', loaded);
            return loaded;
        }
        
        // تبديل حالة تثبيت العمود
        function toggleColumnPin(tableId, columnIndex, columnName) {
            // تحديد نوع الجدول بشكل أفضل
            let tableType = 'month'; // افتراضي
            if (tableId.includes('project') || tableId.includes('Project')) {
                tableType = 'project';
            } else if (tableId.includes('bulkEdit') || tableId.includes('BulkEdit')) {
                tableType = 'bulkEdit';
            } else if (tableId.includes('month') || tableId.includes('Month') || tableId.includes('employeeTable')) {
                tableType = 'month';
            }
            
            let pinnedColumns = loadPinnedColumns(tableType);
            
            const columnKey = columnName || `column_${columnIndex}`;
            const index = pinnedColumns.indexOf(columnKey);
            
            if (index > -1) {
                pinnedColumns.splice(index, 1);
                console.log('📌 تم إلغاء تثبيت العمود:', columnKey, 'من الجدول:', tableType);
            } else {
                pinnedColumns.push(columnKey);
                console.log('📌 تم تثبيت العمود:', columnKey, 'في الجدول:', tableType);
            }
            
            // حفظ الأعمدة المثبتة
            savePinnedColumns(tableType, pinnedColumns);
            
            // تطبيق التغييرات على الجدول
            applyPinnedColumns(tableId, tableType);
        }
        
        // تطبيق الأعمدة المثبتة على الجدول
        function applyPinnedColumns(tableId, tableType) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const pinnedColumns = loadPinnedColumns(tableType);
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            const pinCheckboxRow = table.querySelector('.pin-checkbox-row');
            
            if (!thead || !tbody) return;
            
            // إضافة class للجدول إذا كان يحتوي على صف صناديق التحديد
            if (pinCheckboxRow) {
                table.classList.add('has-pin-checkbox-row');
            } else {
                table.classList.remove('has-pin-checkbox-row');
            }
            
            // تحديد اتجاه النص (RTL أو LTR)
            const isRTL = document.documentElement.dir === 'rtl' || 
                         getComputedStyle(document.documentElement).direction === 'rtl' ||
                         currentLang === 'ar';
            
            // إزالة التثبيت السابق
            const allThs = thead.querySelectorAll('th');
            const allTds = tbody.querySelectorAll('td');
            
            allThs.forEach((th) => {
                th.classList.remove('pinned-column');
                th.style.left = '';
                th.style.right = '';
            });
            
            allTds.forEach((td) => {
                td.classList.remove('pinned-column');
                td.style.left = '';
                td.style.right = '';
            });
            
            // تطبيق التثبيت على الأعمدة المحددة
            let offset = 0;
            const headerRows = thead.querySelectorAll('tr:not(.pin-checkbox-row)');
            
            // الحصول على أعمدة رأس الجدول (تجاهل صف صناديق التحديد)
            const headerRow = headerRows[0];
            if (!headerRow) return;
            
            const headerCells = headerRow.querySelectorAll('th');
            
            // جمع الأعمدة المثبتة مع مواضعها (بالترتيب من البداية)
            const pinnedColumnsData = [];
            headerCells.forEach((th, colIndex) => {
                const columnKey = th.getAttribute('data-column') || `column_${colIndex}`;
                const checkbox = pinCheckboxRow ? 
                    pinCheckboxRow.querySelectorAll('th')[colIndex + 1]?.querySelector('.pin-checkbox') : null;
                
                const isPinned = pinnedColumns.includes(columnKey) || (checkbox && checkbox.checked);
                
                if (isPinned) {
                    // حساب العرض الفعلي للعمود - استخدام عدة طرق لضمان الدقة
                    let width = th.offsetWidth;
                    if (!width || width === 0) {
                        const rect = th.getBoundingClientRect();
                        width = rect.width;
                    }
                    if (!width || width === 0) {
                        // محاولة الحصول من computed style
                        const computedStyle = window.getComputedStyle(th);
                        width = parseFloat(computedStyle.width) || parseFloat(computedStyle.minWidth) || 100;
                    }
                    if (!width || width === 0) {
                        width = 100; // قيمة افتراضية
                    }
                    
                    pinnedColumnsData.push({
                        colIndex: colIndex,
                        columnKey: columnKey,
                        th: th,
                        width: Math.max(width, 50) // حد أدنى 50px
                    });
                }
            });
            
            // تطبيق التثبيت على الأعمدة المثبتة بالترتيب
            pinnedColumnsData.forEach((colData, pinnedIndex) => {
                const { colIndex, th, width } = colData;
                
                // تطبيق التثبيت على جميع صفوف thead (للتمرير الأفقي فقط)
                // z-index يزداد مع كل عمود مثبت لضمان الترتيب الصحيح
                const headerZIndex = 102 + pinnedIndex;
                headerRows.forEach(row => {
                    const cell = row.querySelectorAll('th')[colIndex];
                    if (cell) {
                        cell.classList.add('pinned-column');
                        if (isRTL) {
                            cell.style.right = `${offset}px`;
                            cell.style.left = 'auto';
                        } else {
                            cell.style.left = `${offset}px`;
                            cell.style.right = 'auto';
                        }
                        cell.style.zIndex = headerZIndex.toString();
                        // التأكد من وجود خلفية للأعمدة المثبتة
                        cell.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                        cell.style.position = 'sticky';
                    }
                });
                
                // تطبيق التثبيت على صف صناديق التحديد
                if (pinCheckboxRow) {
                    const checkboxCell = pinCheckboxRow.querySelectorAll('th')[colIndex + 1];
                    if (checkboxCell) {
                        checkboxCell.classList.add('pinned-column');
                        if (isRTL) {
                            checkboxCell.style.right = `${offset}px`;
                            checkboxCell.style.left = 'auto';
                        } else {
                            checkboxCell.style.left = `${offset}px`;
                            checkboxCell.style.right = 'auto';
                        }
                        // z-index أعلى لصف صناديق التحديد
                        checkboxCell.style.zIndex = (103 + pinnedIndex).toString();
                        checkboxCell.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                        checkboxCell.style.position = 'sticky';
                    }
                }
                
                // تطبيق نفس التثبيت على جميع صفوف tbody (للتمرير الأفقي فقط)
                const rows = tbody.querySelectorAll('tr');
                rows.forEach((tr, rowIndex) => {
                    const td = tr.querySelectorAll('td')[colIndex];
                    if (td) {
                        td.classList.add('pinned-column');
                        if (isRTL) {
                            td.style.right = `${offset}px`;
                            td.style.left = 'auto';
                        } else {
                            td.style.left = `${offset}px`;
                            td.style.right = 'auto';
                        }
                        // z-index للخلايا أقل من رأس الجدول
                        td.style.zIndex = (9 + pinnedIndex).toString();
                        td.style.position = 'sticky';
                        // إضافة خلفية حسب نوع الصف
                        if (rowIndex % 2 === 0) {
                            td.style.background = '#f8fafc';
                        } else {
                            td.style.background = 'white';
                        }
                    }
                });
                
                // حساب العرض للعمود التالي (للتمرير الأفقي)
                // استخدام العرض الفعلي المحسوب مع إضافة مسافة صغيرة لضمان عدم التداخل
                offset += width;
            });
            
            // إعادة حساب المواضع بعد تطبيق التثبيت لضمان الدقة
            if (pinnedColumnsData.length > 0) {
                setTimeout(() => {
                    let recalcOffset = 0;
                    pinnedColumnsData.forEach((colData, pinnedIndex) => {
                        const { colIndex, th } = colData;
                        const currentWidth = th.getBoundingClientRect().width || th.offsetWidth || 100;
                        
                        // إعادة تطبيق المواضع مع العرض المحدث
                        headerRows.forEach(row => {
                            const cell = row.querySelectorAll('th')[colIndex];
                            if (cell && cell.classList.contains('pinned-column')) {
                                if (isRTL) {
                                    cell.style.right = `${recalcOffset}px`;
                                } else {
                                    cell.style.left = `${recalcOffset}px`;
                                }
                            }
                        });
                        
                        if (pinCheckboxRow) {
                            const checkboxCell = pinCheckboxRow.querySelectorAll('th')[colIndex + 1];
                            if (checkboxCell && checkboxCell.classList.contains('pinned-column')) {
                                if (isRTL) {
                                    checkboxCell.style.right = `${recalcOffset}px`;
                                } else {
                                    checkboxCell.style.left = `${recalcOffset}px`;
                                }
                            }
                        }
                        
                        const rows = tbody.querySelectorAll('tr');
                        rows.forEach(tr => {
                            const td = tr.querySelectorAll('td')[colIndex];
                            if (td && td.classList.contains('pinned-column')) {
                                if (isRTL) {
                                    td.style.right = `${recalcOffset}px`;
                                } else {
                                    td.style.left = `${recalcOffset}px`;
                                }
                            }
                        });
                        
                        recalcOffset += currentWidth;
                    });
                }, 50);
            }
        }
        
        // إنشاء صف صناديق التحديد
        function createPinCheckboxRow(columns, tableId, tableType) {
            const pinnedColumns = loadPinnedColumns(tableType);
            let html = '<tr class="pin-checkbox-row"><th>';
            html += '<span style="font-size: 10px; color: white; font-weight: 600;">📌</span>';
            html += '</th>';
            
            columns.forEach((col, index) => {
                const columnKey = col.dataColumn || `column_${index}`;
                const isPinned = pinnedColumns.includes(columnKey);
                html += `<th>
                    <input type="checkbox" 
                           class="pin-checkbox" 
                           ${isPinned ? 'checked' : ''}
                           data-column-index="${index}"
                           data-column-key="${columnKey}"
                           onchange="toggleColumnPin('${tableId}', ${index}, '${columnKey}')"
                           title="${currentLang === 'ar' ? 'تثبيت العمود' : 'Pin column'}">
                </th>`;
            });
            
            html += '</tr>';
            return html;
        }
        
        // جعل الدوال متاحة عالمياً
        window.toggleColumnPin = toggleColumnPin;
        window.applyPinnedColumns = applyPinnedColumns;

        const savedDbConfig = loadSavedDbConfig();
        const firebaseConfig = mergeDbConfigs(DEFAULT_FIREBASE_CONFIG, savedDbConfig);
        let isCustomFirebaseConfig = !!savedDbConfig;

        window.getActiveDatabaseConfig = getActiveDatabaseConfig;
        window.getDefaultDatabaseConfig = getDefaultDatabaseConfig;
        window.isCustomDatabaseConfig = isCustomDatabaseConfig;
        window.saveDatabaseConfigToStorage = saveDatabaseConfigToStorage;
        window.clearDatabaseConfigFromStorage = clearDatabaseConfigFromStorage;
        
        // Export storage mode functions
        window.setStorageMode = setStorageMode;
        window.getStorageMode = getStorageMode;
        
        // دالة التبديل بين الأوضاع
        function switchStorageMode(mode) {
            if (mode !== 'firebase' && mode !== 'local') {
                showNotification('error', 'خطأ', 'وضع تخزين غير صالح');
                return;
            }
            
            if (confirm(currentLang === 'ar' 
                ? `⚠️ هل أنت متأكد من التبديل إلى الوضع ${mode === 'local' ? 'المحلي' : 'السحابي'}؟\n\nسيتم إعادة تحميل الصفحة.`
                : `⚠️ Are you sure you want to switch to ${mode === 'local' ? 'Local' : 'Firebase'} mode?\n\nThe page will reload.`)) {
                setStorageMode(mode);
                location.reload();
            } else {
                // إعادة تحديد الزر السابق
                const currentMode = getStorageMode();
                document.querySelector(`input[name="storageMode"][value="${currentMode}"]`).checked = true;
            }
        }
        
        window.switchStorageMode = switchStorageMode;

        // التحقق من صحة firebaseConfig قبل التهيئة
        let app, db, auth;
        
        // التأكد من أن Firebase modules محملة بشكل صحيح
        function initializeFirebase() {
            try {
                // التحقق من أن الدوال متاحة
                if (typeof initializeApp === 'undefined' || typeof getFirestore === 'undefined' || typeof getAuth === 'undefined') {
                    console.error('❌ Firebase modules غير محملة بشكل صحيح');
                    return false;
                }
                
                // التحقق من أن firebaseConfig صحيح
                if (!firebaseConfig || typeof firebaseConfig !== 'object' || !firebaseConfig.apiKey) {
                    console.warn('⚠️ إعدادات Firebase غير صحيحة، استخدام الإعدادات الافتراضية');
                    app = initializeApp(DEFAULT_FIREBASE_CONFIG);
                } else {
                    app = initializeApp(firebaseConfig);
                }
                
                if (!app) {
                    console.error('❌ فشل في تهيئة Firebase app');
                    return false;
                }
                
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (!auth) {
                    console.error('❌ فشل في الحصول على Firebase auth');
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('❌ خطأ في تهيئة Firebase:', error);
                // محاولة استخدام الإعدادات الافتراضية كبديل
                try {
                    if (typeof initializeApp !== 'undefined') {
                        app = initializeApp(DEFAULT_FIREBASE_CONFIG);
                        if (app && typeof getFirestore !== 'undefined' && typeof getAuth !== 'undefined') {
                            db = getFirestore(app);
                            auth = getAuth(app);
                            return true;
                        }
                    }
                } catch (fallbackError) {
                    console.error('❌ خطأ في تهيئة Firebase بالإعدادات الافتراضية:', fallbackError);
                }
                // إنشاء كائنات وهمية لتجنب الأخطاء
                app = null;
                db = null;
                auth = null;
                return false;
            }
        }
        
        // محاولة تهيئة Firebase
        const firebaseInitialized = initializeFirebase();
        
        if (!firebaseInitialized) {
            console.warn('⚠️ Firebase غير متاح، سيتم استخدام الوضع المحلي');
        }
        
        // ========== Supabase Client Initialization ==========
        // إعدادات Supabase (يمكن تخصيصها من localStorage)
        const SUPABASE_CONFIG_KEY = 'payrose_supabase_config';
        const DEFAULT_SUPABASE_CONFIG = {
            url: '', // سيتم ملؤها من localStorage أو إعدادات المستخدم
            anonKey: '' // سيتم ملؤها من localStorage أو إعدادات المستخدم
        };
        
        function loadSupabaseConfig() {
            try {
                const stored = localStorage.getItem(SUPABASE_CONFIG_KEY);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    if (parsed && parsed.url && parsed.anonKey) {
                        return parsed;
                    }
                }
            } catch (error) {
                console.warn('⚠️ فشل في قراءة إعدادات Supabase:', error);
            }
            return null;
        }
        
        const supabaseConfig = loadSupabaseConfig() || DEFAULT_SUPABASE_CONFIG;
        let supabase = null;
        
        // تهيئة Supabase فقط إذا كانت الإعدادات موجودة
        if (supabaseConfig.url && supabaseConfig.anonKey) {
            try {
                supabase = createClient(supabaseConfig.url, supabaseConfig.anonKey);
                console.log('✅ Supabase initialized successfully');
            } catch (error) {
                console.warn('⚠️ Failed to initialize Supabase:', error);
            }
        } else {
            console.log('ℹ️ Supabase not configured. Activity logs will use Firebase.');
        }
        
        // دالة لتحديد نوع قاعدة البيانات الحالية
        function getCurrentDbType() {
            // إذا كان Supabase مهيأ ومتصل، استخدم Supabase
            if (supabase) {
                // يمكن إضافة منطق للتحقق من الاتصال
                return 'supabase';
            }
            return 'firebase';
        }
        
        // دالة لتعيين نوع قاعدة البيانات
        function setDbType(type) {
            if (type === 'supabase' || type === 'firebase') {
                localStorage.setItem('payrose_db_type', type);
                console.log('✅ Database type set to:', type);
            }
        }
        
        // دالة للحصول على نوع قاعدة البيانات المحفوظ
        function getDbType() {
            return localStorage.getItem('payrose_db_type') || 'firebase';
        }
        
        // دالة لتعيين إعدادات Supabase
        function setSupabaseConfig(url, anonKey) {
            if (!url || !anonKey) {
                console.error('❌ Supabase URL and anon key are required');
                return false;
            }
            
            try {
                const config = { url, anonKey };
                localStorage.setItem(SUPABASE_CONFIG_KEY, JSON.stringify(config));
                
                // إعادة تهيئة Supabase
                supabase = createClient(url, anonKey);
                console.log('✅ Supabase configured and initialized');
                return true;
            } catch (error) {
                console.error('❌ Failed to configure Supabase:', error);
                return false;
            }
        }
        
        // دالة للحصول على إعدادات Supabase
        function getSupabaseConfig() {
            return loadSupabaseConfig();
        }
        
        const currentDbType = getDbType();
        
        // دالة للتبديل بين قواعد البيانات
        async function switchDatabaseType(type) {
            if (type === 'supabase') {
                // التحقق من إعدادات Supabase
                const supabaseConfig = getSupabaseConfig();
                if (!supabaseConfig || !supabaseConfig.url || !supabaseConfig.anonKey) {
                    const msg = currentLang === 'ar'
                        ? '⚠️ يجب إعداد Supabase أولاً!\n\nيرجى إدخال Supabase URL و Anon Key في قسم الإعدادات.'
                        : '⚠️ Supabase must be configured first!\n\nPlease enter Supabase URL and Anon Key in settings.';
                    alert(msg);
                    return;
                }
                
                // تأكيد من المستخدم
                const confirmMsg = currentLang === 'ar'
                    ? '🔄 التبديل إلى Supabase\n\nسيتم:\n• حفظ جميع السجلات الجديدة في Supabase\n• استخدام Supabase كقاعدة البيانات الرئيسية\n\nهل تريد المتابعة؟'
                    : '🔄 Switch to Supabase\n\nWill:\n• Save all new logs to Supabase\n• Use Supabase as main database\n\nDo you want to continue?';
                
                if (!confirm(confirmMsg)) return;
            } else {
                // التبديل إلى Firebase
                const confirmMsg = currentLang === 'ar'
                    ? '🔄 التبديل إلى Firebase\n\nسيتم:\n• حفظ جميع السجلات الجديدة في Firebase\n• استخدام Firebase كقاعدة البيانات الرئيسية\n\nهل تريد المتابعة؟'
                    : '🔄 Switch to Firebase\n\nWill:\n• Save all new logs to Firebase\n• Use Firebase as main database\n\nDo you want to continue?';
                
                if (!confirm(confirmMsg)) return;
            }
            
            setDbType(type);
            
            // إعادة تهيئة Supabase إذا تم التبديل إليه
            if (type === 'supabase') {
                const supabaseConfig = getSupabaseConfig();
                if (supabaseConfig && supabaseConfig.url && supabaseConfig.anonKey) {
                    try {
                        supabase = createClient(supabaseConfig.url, supabaseConfig.anonKey);
                        console.log('✅ Supabase reinitialized after switch');
                    } catch (error) {
                        console.error('❌ Failed to reinitialize Supabase:', error);
                    }
                }
            }
            
            showNotification('success', 
                currentLang === 'ar' ? 'تم التبديل' : 'Switched',
                currentLang === 'ar' 
                    ? `تم التبديل إلى ${type === 'supabase' ? 'Supabase' : 'Firebase'} بنجاح!`
                    : `Successfully switched to ${type === 'supabase' ? 'Supabase' : 'Firebase'}!`
            );
            
            // إعادة تحميل قسم الإعدادات
            if (currentView === 'settings') {
                renderSettingsView();
            }
        }
        
        // دالة لحفظ إعدادات Supabase
        async function saveSupabaseConfig() {
            const url = document.getElementById('supabaseUrl')?.value.trim();
            const anonKey = document.getElementById('supabaseAnonKey')?.value.trim();
            
            if (!url || !anonKey) {
                showNotification('error', 
                    currentLang === 'ar' ? 'خطأ' : 'Error',
                    currentLang === 'ar' ? 'يرجى إدخال جميع الحقول المطلوبة' : 'Please fill all required fields'
                );
                return;
            }
            
            // التحقق من صحة URL
            if (!url.startsWith('https://') || !url.includes('.supabase.co')) {
                showNotification('error', 
                    currentLang === 'ar' ? 'خطأ' : 'Error',
                    currentLang === 'ar' ? 'يرجى إدخال URL صحيح لـ Supabase' : 'Please enter a valid Supabase URL'
                );
                return;
            }
            
            try {
                // محاولة إنشاء اتصال تجريبي
                const testClient = createClient(url, anonKey);
                
                // اختبار الاتصال
                const { error } = await testClient.from('projects').select('id').limit(1);
                
                if (error && error.code !== 'PGRST116') { // PGRST116 = table not found (مقبول)
                    throw error;
                }
                
                // حفظ الإعدادات
                if (setSupabaseConfig(url, anonKey)) {
                    showNotification('success', 
                        currentLang === 'ar' ? 'تم الحفظ' : 'Saved',
                        currentLang === 'ar' ? 'تم حفظ إعدادات Supabase بنجاح!' : 'Supabase settings saved successfully!'
                    );
                    
                    // إعادة تحميل قسم الإعدادات
                    if (currentView === 'settings') {
                        renderSettingsView();
                    }
                } else {
                    throw new Error('Failed to save settings');
                }
            } catch (error) {
                console.error('❌ Error saving Supabase config:', error);
                showNotification('error', 
                    currentLang === 'ar' ? 'خطأ' : 'Error',
                    currentLang === 'ar' 
                        ? `فشل حفظ إعدادات Supabase: ${error.message || 'خطأ غير معروف'}`
                        : `Failed to save Supabase settings: ${error.message || 'Unknown error'}`
                );
            }
        }
        
        // دالة لاختبار اتصال Supabase
        async function testSupabaseConnection() {
            const supabaseConfig = getSupabaseConfig();
            if (!supabaseConfig || !supabaseConfig.url || !supabaseConfig.anonKey) {
                showNotification('error', 
                    currentLang === 'ar' ? 'خطأ' : 'Error',
                    currentLang === 'ar' ? 'Supabase غير مهيأ' : 'Supabase not configured'
                );
                return;
            }
            
            showLoading();
            try {
                const testClient = createClient(supabaseConfig.url, supabaseConfig.anonKey);
                
                // اختبار الاتصال بجداول مختلفة
                const tests = [
                    { table: 'projects', name: currentLang === 'ar' ? 'المشاريع' : 'Projects' },
                    { table: 'employees', name: currentLang === 'ar' ? 'الموظفين' : 'Employees' },
                    { table: 'activity_logs', name: currentLang === 'ar' ? 'سجل الأنشطة' : 'Activity Logs' }
                ];
                
                const results = [];
                for (const test of tests) {
                    try {
                        const { error } = await testClient.from(test.table).select('id').limit(1);
                        results.push({
                            name: test.name,
                            success: !error || error.code === 'PGRST116' // PGRST116 = table not found (مقبول)
                        });
                    } catch (err) {
                        results.push({ name: test.name, success: false });
                    }
                }
                
                hideLoading();
                
                const successCount = results.filter(r => r.success).length;
                const totalCount = results.length;
                
                if (successCount === totalCount) {
                    showNotification('success', 
                        currentLang === 'ar' ? 'نجح الاختبار' : 'Test Successful',
                        currentLang === 'ar' 
                            ? `✅ الاتصال بـ Supabase يعمل بشكل صحيح!\n\nتم اختبار ${totalCount} جدول بنجاح.`
                            : `✅ Supabase connection is working correctly!\n\nSuccessfully tested ${totalCount} tables.`
                    );
                } else {
                    showNotification('warning', 
                        currentLang === 'ar' ? 'تحذير' : 'Warning',
                        currentLang === 'ar' 
                            ? `⚠️ بعض الجداول غير موجودة:\n\n${results.filter(r => !r.success).map(r => `• ${r.name}`).join('\n')}\n\nيرجى التأكد من إنشاء جميع الجداول في Supabase.`
                            : `⚠️ Some tables are missing:\n\n${results.filter(r => !r.success).map(r => `• ${r.name}`).join('\n')}\n\nPlease make sure all tables are created in Supabase.`
                    );
                }
            } catch (error) {
                hideLoading();
                console.error('❌ Error testing Supabase connection:', error);
                showNotification('error', 
                    currentLang === 'ar' ? 'خطأ' : 'Error',
                    currentLang === 'ar' 
                        ? `فشل اختبار الاتصال: ${error.message || 'خطأ غير معروف'}`
                        : `Connection test failed: ${error.message || 'Unknown error'}`
                );
            }
        }
        
        // تصدير الوظائف للاستخدام العالمي
        window.setDbType = setDbType;
        window.getDbType = getDbType;
        window.setSupabaseConfig = setSupabaseConfig;
        window.getSupabaseConfig = getSupabaseConfig;
        window.switchDatabaseType = switchDatabaseType;
        window.saveSupabaseConfig = saveSupabaseConfig;
        window.testSupabaseConnection = testSupabaseConnection;

        // قمع تحذيرات Firestore WebChannel غير الضرورية وتحسين معالجة الأخطاء
        const originalWarn = console.warn;
        const originalError = console.error;
        
        // قمع تحذيرات WebChannel غير الضرورية
        console.warn = function(...args) {
            const message = args.join(' ');
            // تجاهل تحذيرات WebChannel و Listen stream و 404 في Firestore
            if (message.includes('WebChannelConnection') || 
                message.includes('Listen stream') || 
                message.includes('transport errored') ||
                (message.includes('404') && (message.includes('Listen') || message.includes('firestore.googleapis.com'))) ||
                message.includes('gsessionid') ||
                message.includes('VER=8') && message.includes('database=')) {
                // هذه تحذيرات طبيعية من Firebase WebChannel - لا تؤثر على وظائف النظام
                return;
            }
            originalWarn.apply(console, args);
        };
        
        // قمع أخطاء 404 في Firestore WebChannel (لا تؤثر على الوظائف)
        console.error = function(...args) {
            const message = args.join(' ');
            // تجاهل أخطاء 404 في Firestore WebChannel
            if ((message.includes('404') || message.includes('Not Found')) && 
                (message.includes('firestore.googleapis.com') || 
                 message.includes('Listen/channel') ||
                 message.includes('gsessionid') ||
                 message.includes('VER=8') ||
                 message.includes('fetchxmlhttpfactory'))) {
                // هذا خطأ طبيعي في محاولة الاتصال الأولية - Firebase سيعيد المحاولة تلقائياً
                // الخطأ يظهر في Network tab لكن لا يؤثر على وظائف النظام
                return;
            }
            originalError.apply(console, args);
        };
        
        // قمع أخطاء Network requests في Console (إذا أمكن)
        // ملاحظة: الأخطاء في Network tab لا يمكن قمعها برمجياً
        // لكن يمكننا قمع الرسائل في Console إذا حاول Firebase طباعتها
        const originalLog = console.log;
        console.log = function(...args) {
            const message = args.join(' ');
            // تجاهل رسائل 404 من Firebase WebChannel
            if (message.includes('404') && 
                (message.includes('firestore.googleapis.com') || 
                 message.includes('Listen/channel') ||
                 message.includes('gsessionid'))) {
                return;
            }
            originalLog.apply(console, args);
        };
        
        // إعداد Firestore لمعالجة الأخطاء بشكل أفضل
        try {
            // تفعيل وضع offline persistence (اختياري)
            // enableIndexedDbPersistence(db).catch((err) => {
            //     if (err.code == 'failed-precondition') {
            //         console.warn('⚠️ Multiple tabs open, persistence can only be enabled in one tab at a time.');
            //     } else if (err.code == 'unimplemented') {
            //         console.warn('⚠️ The current browser does not support all of the features required for persistence.');
            //     }
            // });
        } catch (error) {
            console.warn('⚠️ Could not enable persistence:', error);
        }

        // استعادة console.log الأصلي للرسائل المهمة
        const safeLog = originalLog;
        safeLog('✅ Firebase initialized successfully');
        safeLog('📊 Database:', db);
        safeLog('🔐 Auth:', auth);
        
        // ملاحظة مهمة حول أخطاء 404
        safeLog('%cℹ️ ملاحظة: أخطاء 404 في Network tab من Firebase WebChannel هي طبيعية ويمكن تجاهلها', 
            'color: #3b82f6; font-weight: bold;');
        safeLog('%cNote: 404 errors from Firebase WebChannel in Network tab are normal and can be ignored', 
            'color: #3b82f6; font-weight: bold;');
        safeLog('Firebase يستخدم WebChannel للاستماع للتغييرات في الوقت الفعلي. قد تفشل بعض محاولات الاتصال الأولية، لكن Firebase سيعيد المحاولة تلقائياً.');
        
        // ملاحظة: قد تظهر أخطاء 404 في Network tab من Firebase WebChannel
        // هذه الأخطاء طبيعية ولا تؤثر على وظائف النظام
        // Firebase يستخدم WebChannel للاستماع للتغييرات في الوقت الفعلي
        // وقد تفشل بعض محاولات الاتصال الأولية، لكن Firebase سيعيد المحاولة تلقائياً
        console.log('ℹ️ Note: 404 errors from Firebase WebChannel in Network tab are normal and can be ignored.');

        // ========== Security & Protection System ==========
        
        // معلومات الترخيص والحماية
        const SYSTEM_INFO = {
            name: 'PayRose',
            version: '2.0.9',
            developer: 'ROSEMARY',
            copyright: '© 2024 ROSEMARY - All Rights Reserved',
            licensed: true,
            licenseKey: 'PAYROSE-2024-' + btoa(window.location.hostname).substr(0, 8).toUpperCase()
        };
        
        // منع النقر بالزر الأيمن
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
                showNotification('warning', `⚠️ ${t('warning')}`, t('rightClickDisabled'));
            return false;
        }, false);
        
        // منع اختصارات لوحة المفاتيح الحساسة
        document.addEventListener('keydown', function(e) {
            // منع Ctrl+U (عرض المصدر)
            if (e.ctrlKey && e.key === 'u') {
                e.preventDefault();
                showNotification('warning', '⚠️ محمي', 'عرض المصدر معطّل');
                return false;
            }
            
            // منع Ctrl+S (حفظ الصفحة)
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                showNotification('info', 'ℹ️ معلومة', 'البيانات محفوظة تلقائياً في Firebase');
                return false;
            }
            
            // السماح بـ F12 للمطورين المصرح لهم فقط (يمكن تعطيله)
            // if (e.key === 'F12') {
            //     e.preventDefault();
            //     return false;
            // }
        }, false);
        
        // منع السحب والإفلات للملف
        document.addEventListener('dragstart', function(e) {
            if (e.target.tagName !== 'TR' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                return false;
            }
        }, false);
        
        // إضافة Watermark
        function addSystemWatermark() {
            const watermark = document.createElement('div');
            watermark.id = 'systemWatermark';
            watermark.style.cssText = `
                position: fixed;
                bottom: 5px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 9px;
                color: rgba(0,0,0,0.15);
                pointer-events: none;
                z-index: 9999;
                background: rgba(255,255,255,0.7);
                padding: 2px 8px;
                border-radius: 3px;
                font-weight: 600;
                letter-spacing: 0.5px;
            `;
            watermark.textContent = `${SYSTEM_INFO.name} v${SYSTEM_INFO.version} | ${SYSTEM_INFO.copyright}`;
            document.body.appendChild(watermark);
        }
        
        // حماية الكود من التعديل
        Object.freeze(SYSTEM_INFO);
        
        // إضافة معلومات في Console
        console.log(`
╔═══════════════════════════════════════════════════╗
║                                                   ║
║              🌿 PayRose System v2.0.9            ║
║           Professional Payroll Management         ║
║                                                   ║
╠═══════════════════════════════════════════════════╣
║  Developer: ROSEMARY                              ║
║  © 2024 All Rights Reserved                       ║
║  License: ${SYSTEM_INFO.licenseKey}                             ║
╠═══════════════════════════════════════════════════╣
║  ⚠️  WARNING - PROTECTED SYSTEM                   ║
║  Unauthorized modification is prohibited          ║
║  This system is protected by license              ║
╚═══════════════════════════════════════════════════╝
        `);
        
        // استدعاء Watermark بعد تحميل الصفحة
        setTimeout(addSystemWatermark, 1000);

        // ========== Utilities ==========
        function sanitizeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text == null ? '' : String(text);
            return div.innerHTML;
        }

        function setHTML(element, html) {
            if (!element) return;
            element.innerHTML = html;
        }

        // Minimal namespace for future-safe access
        window.App = window.App || {};
        window.App.sanitizeHTML = sanitizeHTML;
        window.App.setHTML = setHTML;

        // ========== Global Variables ==========
        let currentUser = null;
        let currentLang = 'ar';
        let currentView = 'dashboard';
        let currentYear = new Date().getFullYear(); // السنة الحالية
        let currentMonth = 'august'; // سيتم تحديثها لاحقاً بناءً على أحدث تعديل
        let paymentFilter = 'all'; // 'all', 'paid', 'unpaid' - فلترة حسب حالة الدفع
        let reservationFilter = 'all'; // 'all', 'enabled', 'disabled', 'shortage', 'completed' - فلترة حسب حالة الحجز
        let currentProject = null;
        let selectedProjectMonth = 'august';
        let dashboardSelectedMonth = 'august';
        let initialPeriodSet = false;
        let isUnlocked = false;
        let employeeIndexToEdit = null;
        let employeeIndexToCopy = null;
        let projectCodeToEdit = null;
        let monthFilterSearch = '';
        let monthFilterProject = 'all';
        let monthFilterType = 'all';
        let selectedEmployees = new Set();
        
        // إعدادات الشركة والتوقيعات المشتركة
        let companySettings = {};
        let printSignatures = {};
        
        const months = ['january', 'february', 'march', 'april', 'may', 'june', 
                       'july', 'august', 'september', 'october', 'november', 'december'];

        currentMonth = months[new Date().getMonth()];
        selectedProjectMonth = currentMonth;
        dashboardSelectedMonth = currentMonth;
        
        // نظام السنوات - يديناميكي - يضيفه المستخدم
        let availableYears = []; // سيتم تحميلها من Firebase

        // المستخدمون القدامى - تم استبدالهم بـ Firebase Authentication
        // const users = {
        //     'admin': { password: '123456', role: 'مدير', fullAccess: true },
        //     'user': { password: '123456', role: 'مستخدم', fullAccess: false }
        // };

        const translations = {
            ar: {
                monthNames: {january: 'يناير', february: 'فبراير', march: 'مارس', april: 'أبريل',
                    may: 'مايو', june: 'يونيو', july: 'يوليو', august: 'أغسطس',
                    september: 'سبتمبر', october: 'أكتوبر', november: 'نوفمبر', december: 'ديسمبر'},
                year: 'السنة', currentYear: 'السنة الحالية', selectYear: 'اختر السنة',
                previousYear: 'السنة السابقة', nextYear: 'السنة التالية',
                yearsManagement: 'إدارة السنوات', addYear: 'إضافة سنة', deleteYear: 'حذف السنة',
                totalSalaries: 'إجمالي الرواتب', totalEmployees: 'إجمالي الموظفين',
                projectsCount: 'عدد المشاريع', avgSalary: 'متوسط الراتب',
                employees: 'موظفين', activeProjects: 'مشاريع نشطة',
                addEmployee: '➕ إضافة موظف', copyAll: '📋 نسخ الجميع',
                copySelected: '📋 نسخ المحدد', deleteSelected: '🗑️ حذف المحدد', selectAll: '☑️ تحديد الكل',
                unselectAll: '☐ إلغاء التحديد', noData: 'لا توجد بيانات',
                name: 'الاسم', position: 'المنصب', type: 'النوع', project: 'المشروع',
                salary: 'الراتب', salaryCurrency: 'عملة الراتب',
                paymentCurrency: 'عملة الدفع', exchangeRate: 'سعر الصرف',
                workDays: '⏰ الدوام', dailySalary: 'الراتب اليومي',
                actualSalaryUSD: 'الفعلي (USD)', actualSalaryIQD: 'الفعلي (IQD)',
                bonus: 'بونص', phoneBills: 'فواتير', deductions: 'خصومات',
                advance: 'سلفة', netSalary: 'الصافي', actions: 'إجراءات',
                monthly: 'شهري', daily: 'يومي', vehicle: 'سيارة',
                edit: '✏️', copy: '📋', delete: '🗑️', print: '🖨️ طباعة',
                search: '🔍 البحث', all: 'الكل', total: 'المجموع',
                selected: 'محدد', allProjects: 'جميع المشاريع',
                // User Management
                userManagement: 'إدارة المستخدمين',
                addNewUser: 'إضافة مستخدم جديد',
                linkExistingUser: 'ربط مستخدم موجود',
                refreshList: 'تحديث القائمة',
                usersList: 'قائمة المستخدمين',
                email: 'البريد الإلكتروني',
                password: 'كلمة المرور',
                role: 'الدور',
                permissions: 'الصلاحيات',
                permissionDetails: 'التفاصيل',
                createdAt: 'تاريخ الإنشاء',
                actions: 'الإجراءات',
                fullPermissions: 'صلاحيات كاملة',
                limitedPermissions: 'صلاحيات محدودة',
                customPermissions: 'صلاحيات مخصصة',
                cancel: 'إلغاء',
                save: 'حفظ',
                add: 'إضافة',
                editPermissions: 'تعديل الصلاحيات',
                // Dashboard
                smartDashboard: 'لوحة التحكم الذكية',
                comprehensiveAnalysis: 'تحليل شامل للبيانات المالية والموارد البشرية',
                lastUpdate: 'آخر تحديث',
                totalSalariesLabel: 'إجمالي الرواتب',
                employeesDistribution: 'توزيع الموظفين حسب النوع',
                employeesOverYear: 'عدد الموظفين خلال السنة',
                salariesOverYear: 'إجمالي الرواتب خلال السنة',
                salariesByProjects: 'توزيع الرواتب حسب المشاريع',
                salariesDistribution: 'نسبة توزيع الرواتب',
                employee: 'موظف',
                comparedTo: 'مقارنة بـ',
                noChange: 'لا تغيير',
                // Header Navigation
                navDashboard: 'لوحة التحكم',
                navMonths: 'الأشهر',
                navProjects: 'المشاريع',
                navYears: 'السنوات',
                navUsers: 'المستخدمين',
                navSettings: 'الإعدادات',
                navReports: 'التقارير',
                breadcrumbHome: 'الرئيسية',
                // User Menu
                profile: 'الملف الشخصي',
                signatures: 'التوقيعات',
                appearance: 'المظهر',
                language: 'اللغة',
                backup: 'نسخ احتياطي',
                import: 'استيراد',
                migrate: 'نقل إلى Supabase',
                logout: 'تسجيل الخروج',
                systemManager: 'مدير النظام',
                // Summary Print
                printSummary: 'طباعة الملخص',
                selectMonth: 'اختر الشهر',
                // Error and Success Messages
                error: 'خطأ',
                success: 'نجح',
                warning: 'تحذير',
                info: 'معلومة',
                notAuthorized: 'غير مصرح',
                loginRequired: 'يجب تسجيل الدخول أولاً',
                noPermission: 'ليس لديك صلاحية',
                monthLocked: 'الشهر الحالي مقفل من التعديل',
                employeeNotFound: 'الموظف غير موجود',
                noProjectAccess: 'ليس لديك صلاحية للوصول إلى هذا المشروع',
                noEditPermission: 'ليس لديك صلاحية لتعديل',
                noDeletePermission: 'ليس لديك صلاحية لحذف',
                noAddPermission: 'ليس لديك صلاحية لإضافة',
                noEditSalaryPermission: 'ليس لديك صلاحية لتعديل الراتب',
                noEditBonusPermission: 'ليس لديك صلاحية لتعديل البونص',
                noEditDeductionsPermission: 'ليس لديك صلاحية لتعديل الخصومات',
                noEditAdvancePermission: 'ليس لديك صلاحية لتعديل السلفة',
                confirmDeleteEmployee: 'هل أنت متأكد من حذف هذا الموظف؟',
                confirmLogout: 'هل أنت متأكد من تسجيل الخروج؟',
                deleteYearConfirm: 'هل تريد حذف السنة {year} وجميع بياناتها؟',
                deleteProjectConfirm: 'هل أنت متأكد من حذف المشروع "{project}"?\n\n⚠️ هذا الإجراء لا يمكن التراجع عنه!',
                deleteProjectError: '❌ لا يمكن حذف هذا المشروع!\n\n📊 المشروع يحتوي على {count} موظف\n📅 في السنوات: {years}\n\n⚠️ الرجاء حذف أو نقل جميع الموظفين أولاً.',
                deleteYearError: 'لا يمكن حذف السنة المستخدمة حالياً',
                deleteYearSuccess: 'تم حذف السنة {year} بنجاح',
                addYearSuccess: 'تمت إضافة السنة {year} بنجاح ✅',
                loginError: 'خطأ في تسجيل الدخول',
                loginErrorMessage: 'حدث خطأ أثناء تسجيل الدخول',
                logoutError: 'حدث خطأ أثناء تسجيل الخروج',
                loadProjectsError: 'فشل تحميل المشاريع',
                loadYearsError: 'فشل تحميل السنوات',
                addYearError: 'فشل إضافة السنة',
                deleteYearError2: 'فشل حذف السنة',
                loadEmployeesError: 'فشل تحميل الموظفين',
                saveEmployeeError: 'فشل حفظ الموظف',
                updateEmployeeError: 'فشل تحديث الموظف',
                deleteEmployeeError: 'فشل حذف الموظف',
                saveProjectError: 'فشل حفظ المشروع',
                deleteProjectError2: 'فشل حذف المشروع',
                employeeType: 'من نوع',
                fullAccessRequired: 'هذه العملية تتطلب صلاحيات كاملة',
                rightClickDisabled: 'النقر بالزر الأيمن معطّل لحماية النظام',
                // Permission related
                permissionsTitle: 'صلاحيات',
                // Database settings
                databaseSettingsPermission: 'ليس لديك صلاحية لتعديل إعدادات قاعدة البيانات.',
                defaultValuesLoaded: 'تمت تعبئة الحقول بالقيم الافتراضية. عدّلها ثم احفظ لتطبيقها.',
                done: 'تم',
                // Additional messages
                monthDataNotFound: 'بيانات الشهر غير موجودة',
                editWindowError: 'حدث خطأ في فتح نافذة التعديل',
                noMonthSelected: 'لا يوجد شهر محدد لفتح الدوام',
                monthLockedWarning: 'الشهر المحدد مقفل من التعديل',
                employeeDataNotFound: 'تعذر العثور على بيانات هذا الموظف في الشهر المحدد',
                employeeIdNotFound: 'لم يتم العثور على معرف الموظف',
                attendanceSaveError: 'فشل حفظ بيانات الدوام',
                loadUsersError: 'فشل تحميل قائمة المستخدمين',
                userAddedSuccess: 'تم إضافة المستخدم بنجاح',
                userLinkedSuccess: 'تم ربط المستخدم بالصلاحيات بنجاح',
                linkUserError: 'فشل ربط المستخدم',
                loadUserDataError: 'فشل تحميل بيانات المستخدم',
                permissionsUpdatedSuccess: 'تم تحديث الصلاحيات بنجاح ✅',
                updatePermissionsError: 'فشل تحديث الصلاحيات',
                permissionsDeletedSuccess: 'تم حذف صلاحيات المستخدم من النظام',
                deletePermissionsError: 'فشل حذف الصلاحيات',
                imageFileOnly: 'الرجاء اختيار ملف صورة فقط',
                imageTooLarge: 'حجم الصورة كبير جداً. الحد الأقصى 2 ميجابايت',
                imageCompressError: 'تعذر ضغط الصورة. جرّب صورة أصغر أو مختلفة.',
                noTablesData: 'لا توجد جداول تحتوي على بيانات للطباعة',
                tableNotFound: 'لم يتم العثور على الجدول',
                noDataToPrint: 'لا توجد بيانات للطباعة',
                noMatchingData: 'لا توجد بيانات مطابقة للطباعة',
                printWindowError: 'تعذر فتح نافذة الطباعة. تأكد من السماح بالنوافذ المنبثقة.',
                databaseConnectionError: 'حدث خطأ في الاتصال بقاعدة البيانات',
                firebaseIdMissing: 'لا يمكن تحديث الموظف - معرّف Firebase غير موجود',
                userCreatedSuccess: 'تم إنشاء المستخدم وربطه بالصلاحيات ✅',
                projectContainsEmployees: 'المشروع يحتوي على {count} موظف في السنوات: {years}',
                // Payment Status
                paymentStatus: 'حالة الدفع',
                paid: 'تم الدفع',
                unpaid: 'لم يتم الدفع',
                markAsPaid: 'تحديد كمدفوع',
                markAsUnpaid: 'تحديد كغير مدفوع',
                paidDate: 'تاريخ الدفع',
                paymentMethod: 'طريقة الدفع',
                paymentNotes: 'ملاحظات الدفع',
                cash: 'نقداً',
                transfer: 'تحويل بنكي',
                check: 'شيك',
                other: 'أخرى',
                filterByPayment: 'فلترة حسب الدفع',
                showAll: 'عرض الكل',
                showPaid: 'عرض المدفوعين فقط',
                showUnpaid: 'عرض غير المدفوعين فقط',
                bulkPayment: 'دفع جماعي',
                markSelectedAsPaid: 'تحديد المحدد كمدفوع',
                markSelectedAsUnpaid: 'تحديد المحدد كغير مدفوع',
                paymentDetails: 'تفاصيل الدفع',
                editPaymentDetails: 'تعديل تفاصيل الدفع',
                paymentStatistics: 'إحصائيات الدفع',
                paidEmployees: 'الموظفون المدفوعون',
                unpaidEmployees: 'الموظفون غير المدفوعين',
                paidAmount: 'المبلغ المدفوع',
                unpaidAmount: 'المبلغ غير المدفوع',
                paymentSuccess: 'تم تحديث حالة الدفع بنجاح',
                paymentError: 'فشل تحديث حالة الدفع',
                bulkPaymentSuccess: 'تم تحديث حالة الدفع لـ {count} موظف بنجاح',
                bulkPaymentError: 'فشل تحديث حالة الدفع',
                confirmBulkPayment: 'هل أنت متأكد من تحديث حالة الدفع لـ {count} موظف؟',
                noEmployeesSelected: 'لم يتم تحديد أي موظف',
                // Salary Reservation
                salaryReservation: 'حجز الراتب',
                reservationEnabled: 'تفعيل الحجز',
                reservationPercentage: 'نسبة الحجز (%)',
                reservedAmount: 'المبلغ المحجوز',
                previousReservedAmount: 'المبلغ المحجوز سابقاً',
                targetReservedAmount: 'الهدف (راتب أساسي واحد)',
                totalReservedAmount: 'إجمالي المحجوز',
                reservationCurrency: 'عملة الحجز',
                reservationStatus: 'حالة الحجز',
                reservationActive: 'نشط',
                reservationInactive: 'معطل',
                reservationCompleted: 'مكتمل',
                reservationShortage: 'نقص في الحجز',
                reservationReport: 'تقرير الرواتب المحجوزة',
                reservationStatistics: 'إحصائيات الحجز',
                manageReservation: 'إدارة الحجز',
                editReservation: 'تعديل الحجز',
                reservationWarning: 'تحذير: صافي الراتب أقل من مبلغ الحجز المطلوب',
                reservationShortageAmount: 'المبلغ الناقص',
                reservationNotes: 'ملاحظات الحجز',
                reservationDelivered: 'تم التسليم',
                deliverReservation: 'تسليم المبلغ المحجوز',
                reservationDeliveryDate: 'تاريخ التسليم',
                reservationSuccess: 'تم تحديث إعدادات الحجز بنجاح',
                reservationError: 'فشل تحديث إعدادات الحجز',
                reservationCalculated: 'المبلغ المحجوز المحسوب',
                reservationActual: 'المبلغ المحجوز فعلياً',
                reservationAvailable: 'المبلغ المتاح',
                reservationRequested: 'المبلغ المطلوب',
                totalEmployeesWithReservation: 'إجمالي الموظفين مع حجز',
                totalReservedThisMonth: 'إجمالي المحجوز هذا الشهر',
                totalReservedOverall: 'إجمالي المحجوز الإجمالي',
                reservationProgress: 'تقدم الحجز',
                // Settings Page
                settingsTitle: 'إعدادات النظام',
                settingsDescription: 'إدارة معلومات الشركة وإعدادات الطباعة',
                companyInfo: 'معلومات الشركة',
                companyInfoDescription: 'ستظهر هذه المعلومات في جميع التقارير والمستندات المطبوعة',
                companyLogo: 'لوغو الشركة',
                uploadNewLogo: 'رفع لوغو جديد',
                deleteLogo: 'حذف اللوغو',
                noLogo: 'لا يوجد لوغو',
                logoRecommendation: 'يُفضل استخدام صورة بخلفية شفافة (PNG) بحجم 500×500 بكسل',
                companyNameAr: 'اسم الشركة (بالعربية)',
                companyNameEn: 'اسم الشركة (بالإنجليزية)',
                companyAddress: 'عنوان الشركة',
                companyPhone: 'هاتف الشركة',
                companyEmail: 'إيميل الشركة',
                saveSettings: 'حفظ الإعدادات',
                databaseSettings: 'إعدادات قاعدة البيانات',
                databaseSettingsDescription: 'التبديل بين Firebase و Supabase وإدارة إعدادات الاتصال',
                globalReservationSettings: 'إعدادات الحجز العامة',
                globalReservationSettingsDescription: 'تفعيل الحجز لجميع الموظفين وتحديد النسبة أو المبلغ',
                enableReservationForAll: 'تفعيل الحجز لجميع الموظفين',
                reservationMethod: 'طريقة الحجز',
                percentage: 'نسبة مئوية (%)',
                fixedAmount: 'مبلغ ثابت',
                reservationPercentage: 'نسبة الحجز (%)',
                reservationAmount: 'مبلغ الحجز',
                reservationNote: 'عند تفعيل الحجز، سيتم تطبيقه تلقائياً على جميع الموظفين عند حفظ بياناتهم. الحجز التراكمي لا يتجاوز الراتب الأساسي للموظف.',
                saveReservationSettings: 'حفظ إعدادات الحجز',
                dangerousZone: 'منطقة خطرة - تصفير الحجوزات',
                resetReservationsWarning: 'تحذير: هذا الإجراء سيقوم بتصفير جميع الحجوزات في جميع الأشهر لجميع الموظفين.',
                resetReservationsInfo: 'استخدم هذا الزر إذا أردت إعادة تعيين جميع الحجوزات وإدخال البيانات الفعلية من جديد.',
                resetAllReservations: 'تصفير جميع الحجوزات',
                previewInReports: 'معاينة في التقارير',
                previewDescription: 'هكذا ستظهر معلومات الشركة في التقارير المطبوعة',
                signaturesSettings: 'إعدادات التوقيعات',
                signaturesDescription: 'إعداد التوقيعات التي ستظهر في التقارير المطبوعة',
                signature1: 'التوقيع الأول',
                signature2: 'التوقيع الثاني',
                signature3: 'التوقيع الثالث',
                signature4: 'التوقيع الرابع',
                signaturePosition: 'المنصب',
                signatureName: 'اسم الموقع',
                saveSignatures: 'حفظ التوقيعات',
                termsManagement: 'إدارة المصطلحات والترجمات',
                termsDescription: 'تخصيص المصطلحات المستخدمة في النظام. اترك الحقل فارغاً للاحتفاظ بالنص الافتراضي',
                searchTerm: 'بحث عن مصطلح...',
                saveAllChanges: 'حفظ جميع التغييرات',
                resetAllTerms: 'إعادة تعيين الكل',
                termKey: 'المفتاح',
                defaultAr: 'الافتراضي (عربي)',
                defaultEn: 'الافتراضي (English)',
                customAr: 'المخصص (عربي)',
                customEn: 'المخصص (English)',
                termsNote: 'عند ترك حقل "المخصص" فارغاً، سيتم استخدام النص الافتراضي تلقائياً. التغييرات لا تُطبق حتى تضغط على "حفظ جميع التغييرات".',
                storageMode: 'وضع التخزين الحالي',
                firebaseCloud: 'Firebase (سحابي)',
                firebaseCloudDesc: 'يتطلب اتصال بالإنترنت',
                localStorage: 'Local (محلي)',
                localStorageDesc: 'يعمل بدون إنترنت',
                storageWarning: 'عند التبديل بين الأوضاع، سيتم استخدام البيانات المحفوظة في الوضع المختار. تأكد من عمل نسخة احتياطية قبل التبديل.',
                currentConfig: 'الإعداد الحالي',
                usingCustomConfig: 'يتم استخدام إعدادات مخصصة محفوظة محلياً',
                usingDefaultConfig: 'يتم استخدام الإعداد الافتراضي المضمّن',
                returnToDefault: 'العودة للإعداد الافتراضي',
                noPermissionDbSettings: 'ليس لديك صلاحية لتعديل إعدادات قاعدة البيانات. تواصل مع المسؤول.',
                saveAndReload: 'حفظ و إعادة التحميل',
                fillDefaultConfig: 'تعبئة الإعداد الافتراضي',
                configNote: 'يتم حفظ هذه الإعدادات في المتصفح فقط. أعد تحميل الصفحة بعد الحفظ لتطبيق الاتصال الجديد.',
                localMode: 'الوضع المحلي (Local Mode)',
                localModeDesc: 'يتم حفظ جميع البيانات محلياً في المتصفح. لا حاجة لاتصال بالإنترنت.',
                savedData: 'البيانات المحفوظة',
                employeesData: 'الموظفون',
                projectsData: 'المشاريع',
                settingsData: 'الإعدادات',
                signaturesData: 'التوقيعات',
                saved: 'محفوظة',
                notSaved: 'غير محفوظة',
                updateOldData: 'تحديث البيانات القديمة',
                updateOldDataDescription: 'تحديث البيانات القديمة التي تم إنشاؤها قبل إضافة نظام الحجوزات',
                importantNote: 'ملاحظة مهمة',
                updateOldDataNote: 'تقوم هذه الأداة بتحديث البيانات القديمة التي قد لا تحتوي على: month و year (الشهر والسنة), previousReservedAmount (المبلغ المحجوز سابقاً), targetReservedAmount (الهدف من الحجز)',
                updateOldDataTip: 'نصيحة: يُفضل تشغيل هذه الأداة مرة واحدة فقط بعد التحديث. بعد ذلك، سيتم حفظ البيانات بشكل صحيح تلقائياً.',
                whatItDoes: 'ما تفعله الأداة',
                updateOldDataList: 'إضافة month و year للبيانات القديمة, حساب previousReservedAmount من الحجوزات السابقة, إضافة targetReservedAmount إذا كان الحجز مفعلاً, تحديث جميع السجلات في قاعدة البيانات',
                updateOldDataButton: 'تحديث البيانات القديمة',
                expectedDuration: 'المدة المتوقعة',
                expectedDurationDesc: 'قد تستغرق العملية بضع دقائق حسب عدد الموظفين في قاعدة البيانات.',
                result: 'النتيجة',
                resultDesc: 'ستظهر رسالة تأكيد بعد اكتمال التحديث مع عدد السجلات المحدثة.',
                // Bulk Edit Page
                bulkEditTitle: 'تعديل متعدد للموظفين',
                bulkEditDescription: 'اختر الشهر والسنة ثم حدد الموظفين للتعديل',
                selectMonthYear: 'اختر الشهر والسنة',
                year: 'السنة',
                month: 'الشهر',
                filterByProject: 'فلترة حسب المشروع',
                allProjects: 'جميع المشاريع',
                filterByType: 'فلترة حسب نوع الموظف',
                allTypes: 'جميع الأنواع',
                monthly: 'شهري',
                daily: 'يومي',
                vehicle: 'سيارة',
                displayedEmployees: 'عدد الموظفين المعروضين',
                resetFilters: 'إعادة تعيين الفلاتر',
                employeesList: 'قائمة الموظفين - تعديل مباشر',
                employeesListDescription: 'يمكنك التعديل مباشرة على الجدول ثم الضغط على زر الحفظ في عمود الإجراءات',
                nameAr: 'الاسم بالعربية',
                nameEn: 'الاسم بالإنجليزية',
                position: 'المنصب',
                employeeType: 'نوع الموظف',
                project: 'المشروع',
                basicSalary: 'الراتب الأساسي',
                salaryCurrency: 'عملة الراتب',
                paymentCurrency: 'عملة الدفع',
                exchangeRate: 'سعر الصرف',
                attendanceSystem: 'نظام الدوام',
                byHours: 'بالساعات',
                fixed: 'ثابت',
                dailyWorkHours: 'ساعات العمل/يوم',
                overtimeMultiplier: 'معامل الأوفر تايم',
                normal: 'عادي',
                timeAndHalf: 'وقت ونصف',
                double: 'مضاعف',
                monthCalculationMethod: 'طريقة احتساب الشهر',
                always30Days: '30 يوم دائماً',
                actualDays: 'حسب أيام الشهر الفعلية',
                paidLeaveCalculation: 'احتساب الإجازات',
                fullSalary: 'كامل الراتب',
                halfSalary: 'نصف الراتب',
                noSalary: 'بدون راتب',
                actions: 'الإجراءات',
                save: 'حفظ',
                saveChanges: 'حفظ التعديلات',
                noEmployeesInMonth: 'لا يوجد موظفين في'
            },
            en: {
                monthNames: {january: 'January', february: 'February', march: 'March', april: 'April',
                    may: 'May', june: 'June', july: 'July', august: 'August',
                    september: 'September', october: 'October', november: 'November', december: 'December'},
                year: 'Year', currentYear: 'Current Year', selectYear: 'Select Year',
                previousYear: 'Previous Year', nextYear: 'Next Year',
                yearsManagement: 'Years Management', addYear: 'Add Year', deleteYear: 'Delete Year',
                totalSalaries: 'Total Salaries', totalEmployees: 'Total Employees',
                projectsCount: 'Projects Count', avgSalary: 'Average Salary',
                employees: 'Employees', activeProjects: 'Active Projects',
                addEmployee: '➕ Add Employee', copyAll: '📋 Copy All',
                copySelected: '📋 Copy Selected', deleteSelected: '🗑️ Delete Selected', selectAll: '☑️ Select All',
                unselectAll: '☐ Unselect All', noData: 'No Data',
                name: 'Name', position: 'Position', type: 'Type', project: 'Project',
                salary: 'Salary', salaryCurrency: 'Salary Currency',
                paymentCurrency: 'Payment Currency', exchangeRate: 'Exchange Rate',
                workDays: '⏰ Attendance', dailySalary: 'Daily Salary',
                actualSalaryUSD: 'Actual (USD)', actualSalaryIQD: 'Actual (IQD)',
                bonus: 'Bonus', phoneBills: 'Bills', deductions: 'Deductions',
                advance: 'Advance', netSalary: 'Net', actions: 'Actions',
                monthly: 'Monthly', daily: 'Daily', vehicle: 'Vehicle',
                edit: '✏️', copy: '📋', delete: '🗑️', print: '🖨️ Print',
                search: '🔍 Search', all: 'All', total: 'Total',
                selected: 'selected', allProjects: 'All Projects',
                // User Management
                userManagement: 'User Management',
                addNewUser: 'Add New User',
                linkExistingUser: 'Link Existing User',
                refreshList: 'Refresh List',
                usersList: 'Users List',
                email: 'Email',
                password: 'Password',
                role: 'Role',
                permissions: 'Permissions',
                permissionDetails: 'Details',
                createdAt: 'Created At',
                actions: 'Actions',
                fullPermissions: 'Full Permissions',
                limitedPermissions: 'Limited Permissions',
                customPermissions: 'Custom Permissions',
                cancel: 'Cancel',
                save: 'Save',
                add: 'Add',
                editPermissions: 'Edit Permissions',
                // Dashboard
                smartDashboard: 'Smart Dashboard',
                comprehensiveAnalysis: 'Comprehensive Financial & HR Analysis',
                lastUpdate: 'Last Update',
                totalSalariesLabel: 'Total Salaries',
                employeesDistribution: 'Employees Distribution by Type',
                employeesOverYear: 'Employees Throughout the Year',
                salariesOverYear: 'Total Salaries Throughout the Year',
                salariesByProjects: 'Salaries Distribution by Projects',
                salariesDistribution: 'Salaries Distribution Ratio',
                employee: 'employee',
                comparedTo: 'compared to',
                noChange: 'No Change',
                // Header Navigation
                navDashboard: 'Dashboard',
                navMonths: 'Months',
                navProjects: 'Projects',
                navYears: 'Years',
                navUsers: 'Users',
                navSettings: 'Settings',
                navReports: 'Reports',
                breadcrumbHome: 'Home',
                // User Menu
                profile: 'Profile',
                signatures: 'Signatures',
                appearance: 'Appearance',
                language: 'Language',
                backup: 'Backup',
                import: 'Import',
                migrate: 'Migrate to Supabase',
                logout: 'Logout',
                systemManager: 'System Manager',
                // Summary Print
                printSummary: 'Print Summary',
                selectMonth: 'Select Month',
                // Error and Success Messages
                error: 'Error',
                success: 'Success',
                warning: 'Warning',
                info: 'Info',
                notAuthorized: 'Not Authorized',
                loginRequired: 'Login required',
                noPermission: 'You do not have permission',
                monthLocked: 'Current month is locked from editing',
                employeeNotFound: 'Employee not found',
                noProjectAccess: 'You do not have access to this project',
                noEditPermission: 'You do not have permission to edit',
                noDeletePermission: 'You do not have permission to delete',
                noAddPermission: 'You do not have permission to add',
                noEditSalaryPermission: 'You do not have permission to edit salary',
                noEditBonusPermission: 'You do not have permission to edit bonus',
                noEditDeductionsPermission: 'You do not have permission to edit deductions',
                noEditAdvancePermission: 'You do not have permission to edit advance',
                confirmDeleteEmployee: 'Are you sure you want to delete this employee?',
                confirmLogout: 'Are you sure you want to logout?',
                deleteYearConfirm: 'Do you want to delete year {year} and all its data?',
                deleteProjectConfirm: 'Are you sure you want to delete project "{project}"?\n\n⚠️ This action cannot be undone!',
                deleteProjectError: '❌ Cannot delete this project!\n\n📊 Project contains {count} employees\n📅 In years: {years}\n\n⚠️ Please delete or move all employees first.',
                deleteYearError: 'Cannot delete the currently used year',
                deleteYearSuccess: 'Year {year} deleted successfully',
                addYearSuccess: 'Year {year} added successfully ✅',
                loginError: 'Login Error',
                loginErrorMessage: 'An error occurred during login',
                logoutError: 'An error occurred during logout',
                loadProjectsError: 'Failed to load projects',
                loadYearsError: 'Failed to load years',
                addYearError: 'Failed to add year',
                deleteYearError2: 'Failed to delete year',
                loadEmployeesError: 'Failed to load employees',
                saveEmployeeError: 'Failed to save employee',
                updateEmployeeError: 'Failed to update employee',
                deleteEmployeeError: 'Failed to delete employee',
                saveProjectError: 'Failed to save project',
                deleteProjectError2: 'Failed to delete project',
                employeeType: 'of type',
                fullAccessRequired: 'This operation requires full access',
                rightClickDisabled: 'Right-click is disabled to protect the system',
                // Permission related
                permissionsTitle: 'Permissions',
                // Database settings
                databaseSettingsPermission: 'You do not have permission to edit database settings.',
                defaultValuesLoaded: 'Fields have been filled with default values. Edit them then save to apply.',
                done: 'Done',
                // Additional messages
                monthDataNotFound: 'Month data not found',
                editWindowError: 'Error opening edit window',
                noMonthSelected: 'No month selected to open attendance',
                monthLockedWarning: 'Selected month is locked from editing',
                employeeDataNotFound: 'Could not find this employee data in the selected month',
                employeeIdNotFound: 'Employee ID not found',
                attendanceSaveError: 'Failed to save attendance data',
                loadUsersError: 'Failed to load users list',
                userAddedSuccess: 'User added successfully',
                userLinkedSuccess: 'User linked to permissions successfully',
                linkUserError: 'Failed to link user',
                loadUserDataError: 'Failed to load user data',
                permissionsUpdatedSuccess: 'Permissions updated successfully ✅',
                updatePermissionsError: 'Failed to update permissions',
                permissionsDeletedSuccess: 'User permissions deleted from system',
                deletePermissionsError: 'Failed to delete permissions',
                imageFileOnly: 'Please select an image file only',
                imageTooLarge: 'Image size is too large. Maximum 2 MB',
                imageCompressError: 'Unable to compress image. Try a smaller or different image.',
                noTablesData: 'No tables containing data to print',
                tableNotFound: 'Table not found',
                noDataToPrint: 'No data to print',
                noMatchingData: 'No matching data to print',
                printWindowError: 'Unable to open print window. Make sure to allow popups.',
                databaseConnectionError: 'Database connection error occurred',
                firebaseIdMissing: 'Cannot update employee - Firebase ID not found',
                userCreatedSuccess: 'User created and linked to permissions successfully ✅',
                projectContainsEmployees: 'Project contains {count} employees in years: {years}',
                // Payment Status
                paymentStatus: 'Payment Status',
                paid: 'Paid',
                unpaid: 'Unpaid',
                markAsPaid: 'Mark as Paid',
                markAsUnpaid: 'Mark as Unpaid',
                paidDate: 'Payment Date',
                paymentMethod: 'Payment Method',
                paymentNotes: 'Payment Notes',
                cash: 'Cash',
                transfer: 'Bank Transfer',
                check: 'Check',
                other: 'Other',
                filterByPayment: 'Filter by Payment',
                showAll: 'Show All',
                showPaid: 'Show Paid Only',
                showUnpaid: 'Show Unpaid Only',
                bulkPayment: 'Bulk Payment',
                markSelectedAsPaid: 'Mark Selected as Paid',
                markSelectedAsUnpaid: 'Mark Selected as Unpaid',
                paymentDetails: 'Payment Details',
                editPaymentDetails: 'Edit Payment Details',
                paymentStatistics: 'Payment Statistics',
                paidEmployees: 'Paid Employees',
                unpaidEmployees: 'Unpaid Employees',
                paidAmount: 'Paid Amount',
                unpaidAmount: 'Unpaid Amount',
                paymentSuccess: 'Payment status updated successfully',
                paymentError: 'Failed to update payment status',
                bulkPaymentSuccess: 'Payment status updated for {count} employees successfully',
                bulkPaymentError: 'Failed to update payment status',
                confirmBulkPayment: 'Are you sure you want to update payment status for {count} employees?',
                noEmployeesSelected: 'No employees selected',
                // Salary Reservation
                salaryReservation: 'Salary Reservation',
                reservationEnabled: 'Enable Reservation',
                reservationPercentage: 'Reservation Percentage (%)',
                reservedAmount: 'Reserved Amount',
                previousReservedAmount: 'Previously Reserved Amount',
                targetReservedAmount: 'Target (One Basic Salary)',
                totalReservedAmount: 'Total Reserved',
                reservationCurrency: 'Reservation Currency',
                reservationStatus: 'Reservation Status',
                reservationActive: 'Active',
                reservationInactive: 'Inactive',
                reservationCompleted: 'Completed',
                reservationShortage: 'Reservation Shortage',
                reservationReport: 'Reserved Salaries Report',
                reservationStatistics: 'Reservation Statistics',
                manageReservation: 'Manage Reservation',
                editReservation: 'Edit Reservation',
                reservationWarning: 'Warning: Net salary is less than required reservation amount',
                reservationShortageAmount: 'Shortage Amount',
                reservationNotes: 'Reservation Notes',
                reservationDelivered: 'Delivered',
                deliverReservation: 'Deliver Reserved Amount',
                reservationDeliveryDate: 'Delivery Date',
                reservationSuccess: 'Reservation settings updated successfully',
                reservationError: 'Failed to update reservation settings',
                reservationCalculated: 'Calculated Reservation',
                reservationActual: 'Actual Reserved',
                reservationAvailable: 'Available Amount',
                reservationRequested: 'Requested Amount',
                totalEmployeesWithReservation: 'Total Employees with Reservation',
                totalReservedThisMonth: 'Total Reserved This Month',
                totalReservedOverall: 'Total Reserved Overall',
                reservationProgress: 'Reservation Progress',
                // Settings Page
                settingsTitle: 'System Settings',
                settingsDescription: 'Manage company information and print settings',
                companyInfo: 'Company Information',
                companyInfoDescription: 'This information will appear in all printed reports and documents',
                companyLogo: 'Company Logo',
                uploadNewLogo: 'Upload New Logo',
                deleteLogo: 'Delete Logo',
                noLogo: 'No Logo',
                logoRecommendation: 'Preferably use a transparent background image (PNG) with size 500×500 pixels',
                companyNameAr: 'Company Name (Arabic)',
                companyNameEn: 'Company Name (English)',
                companyAddress: 'Company Address',
                companyPhone: 'Company Phone',
                companyEmail: 'Company Email',
                saveSettings: 'Save Settings',
                databaseSettings: 'Database Settings',
                databaseSettingsDescription: 'Switch between Firebase and Supabase and manage connection settings',
                globalReservationSettings: 'Global Reservation Settings',
                globalReservationSettingsDescription: 'Enable reservation for all employees and set percentage or amount',
                enableReservationForAll: 'Enable Reservation for All Employees',
                reservationMethod: 'Reservation Method',
                percentage: 'Percentage (%)',
                fixedAmount: 'Fixed Amount',
                reservationPercentage: 'Reservation Percentage (%)',
                reservationAmount: 'Reservation Amount',
                reservationNote: 'When reservation is enabled, it will be automatically applied to all employees when saving their data. Accumulated reservation does not exceed the employee\'s basic salary.',
                saveReservationSettings: 'Save Reservation Settings',
                dangerousZone: 'Dangerous Zone - Reset Reservations',
                resetReservationsWarning: 'Warning: This action will reset all reservations in all months for all employees.',
                resetReservationsInfo: 'Use this button if you want to reset all reservations and enter actual data again.',
                resetAllReservations: 'Reset All Reservations',
                previewInReports: 'Preview in Reports',
                previewDescription: 'This is how company information will appear in printed reports',
                signaturesSettings: 'Signatures Settings',
                signaturesDescription: 'Set signatures that will appear in printed reports',
                signature1: 'First Signature',
                signature2: 'Second Signature',
                signature3: 'Third Signature',
                signature4: 'Fourth Signature',
                signaturePosition: 'Position',
                signatureName: 'Signer Name',
                saveSignatures: 'Save Signatures',
                termsManagement: 'Terms and Translations Management',
                termsDescription: 'Customize terms used in the system. Leave field empty to keep default text',
                searchTerm: 'Search for term...',
                saveAllChanges: 'Save All Changes',
                resetAllTerms: 'Reset All',
                termKey: 'Key',
                defaultAr: 'Default (Arabic)',
                defaultEn: 'Default (English)',
                customAr: 'Custom (Arabic)',
                customEn: 'Custom (English)',
                termsNote: 'When leaving "Custom" field empty, default text will be used automatically. Changes are not applied until you click "Save All Changes".',
                storageMode: 'Current Storage Mode',
                firebaseCloud: 'Firebase (Cloud)',
                firebaseCloudDesc: 'Requires internet connection',
                localStorage: 'Local (Offline)',
                localStorageDesc: 'Works without internet',
                storageWarning: 'When switching between modes, data saved in the selected mode will be used. Make sure to backup before switching.',
                currentConfig: 'Current Configuration',
                usingCustomConfig: 'Using custom settings saved locally',
                usingDefaultConfig: 'Using default embedded configuration',
                returnToDefault: 'Return to Default',
                noPermissionDbSettings: 'You do not have permission to edit database settings. Contact administrator.',
                saveAndReload: 'Save and Reload',
                fillDefaultConfig: 'Fill Default Configuration',
                configNote: 'These settings are saved in browser only. Reload page after saving to apply new connection.',
                localMode: 'Local Mode',
                localModeDesc: 'All data is saved locally in browser. No internet connection needed.',
                savedData: 'Saved Data',
                employeesData: 'Employees',
                projectsData: 'Projects',
                settingsData: 'Settings',
                signaturesData: 'Signatures',
                saved: 'Saved',
                notSaved: 'Not Saved',
                updateOldData: 'Update Old Data',
                updateOldDataDescription: 'Update old data created before reservation system was added',
                importantNote: 'Important Note',
                updateOldDataNote: 'This tool updates old data that may not contain: month and year, previousReservedAmount (previously reserved amount), targetReservedAmount (reservation target)',
                updateOldDataTip: 'Tip: It is recommended to run this tool only once after update. After that, data will be saved correctly automatically.',
                whatItDoes: 'What the Tool Does',
                updateOldDataList: 'Add month and year to old data, calculate previousReservedAmount from previous reservations, add targetReservedAmount if reservation is enabled, update all records in database',
                updateOldDataButton: 'Update Old Data',
                expectedDuration: 'Expected Duration',
                expectedDurationDesc: 'The process may take a few minutes depending on number of employees in database.',
                result: 'Result',
                resultDesc: 'A confirmation message will appear after completion with number of updated records.',
                // Bulk Edit Page
                bulkEditTitle: 'Bulk Employee Edit',
                bulkEditDescription: 'Select month and year then choose employees to edit',
                selectMonthYear: 'Select Month and Year',
                year: 'Year',
                month: 'Month',
                filterByProject: 'Filter by Project',
                allProjects: 'All Projects',
                filterByType: 'Filter by Employee Type',
                allTypes: 'All Types',
                monthly: 'Monthly',
                daily: 'Daily',
                vehicle: 'Vehicle',
                displayedEmployees: 'Displayed Employees Count',
                resetFilters: 'Reset Filters',
                employeesList: 'Employees List - Direct Edit',
                employeesListDescription: 'You can edit directly in the table then click save button in actions column',
                nameAr: 'Name (Arabic)',
                nameEn: 'Name (English)',
                position: 'Position',
                employeeType: 'Employee Type',
                project: 'Project',
                basicSalary: 'Basic Salary',
                salaryCurrency: 'Salary Currency',
                paymentCurrency: 'Payment Currency',
                exchangeRate: 'Exchange Rate',
                attendanceSystem: 'Attendance System',
                byHours: 'By Hours',
                fixed: 'Fixed',
                dailyWorkHours: 'Work Hours/Day',
                overtimeMultiplier: 'Overtime Multiplier',
                normal: 'Normal',
                timeAndHalf: 'Time and Half',
                double: 'Double',
                monthCalculationMethod: 'Month Calculation Method',
                always30Days: 'Always 30 Days',
                actualDays: 'According to Actual Month Days',
                paidLeaveCalculation: 'Paid Leave Calculation',
                fullSalary: 'Full Salary',
                halfSalary: 'Half Salary',
                noSalary: 'No Salary',
                actions: 'Actions',
                save: 'Save',
                saveChanges: 'Save Changes',
                noEmployeesInMonth: 'No employees in'
            }
        };

        let projects = {};
        let employeeData = {};
        
        // المصطلحات المخصصة (Custom Translations)
        let customTranslations = {
            ar: {},
            en: {}
        };
        
        // تحميل المصطلحات المخصصة من localStorage
        function loadCustomTranslations() {
            try {
                const saved = localStorage.getItem('customTranslations');
                if (saved) {
                    customTranslations = JSON.parse(saved);
                }
            } catch (error) {
                console.error('خطأ في تحميل المصطلحات المخصصة:', error);
                customTranslations = { ar: {}, en: {} };
            }
        }
        
        // حفظ المصطلحات المخصصة في localStorage
        function saveCustomTranslations() {
            try {
                localStorage.setItem('customTranslations', JSON.stringify(customTranslations));
                return true;
            } catch (error) {
                console.error('خطأ في حفظ المصطلحات المخصصة:', error);
                return false;
            }
        }
        
        // تحميل المصطلحات المخصصة عند بدء التشغيل
        loadCustomTranslations();
        
        // تهيئة بنية البيانات: employeeData[year][month] = []
        const initializeEmployeeData = () => {
            availableYears.forEach(year => {
                if (!employeeData[year]) {
                    employeeData[year] = {};
                    months.forEach(month => {
                        employeeData[year][month] = [];
                    });
                }
            });
        };
        initializeEmployeeData();

        // ========== Helper Functions ==========
        function t(key, variables = {}) {
            // أولاً: التحقق من وجود مصطلح مخصص
            let text = null;
            if (customTranslations[currentLang] && customTranslations[currentLang][key] && customTranslations[currentLang][key].trim() !== '') {
                text = customTranslations[currentLang][key];
            }
            
            // إذا لم يكن هناك مصطلح مخصص، استخدم الافتراضي
            if (!text) {
                text = translations[currentLang][key] || key;
            }
            
            // استبدال المتغيرات مثل {year}, {count}, etc.
            Object.keys(variables).forEach(varName => {
                text = text.replace(new RegExp(`\\{${varName}\\}`, 'g'), variables[varName]);
            });
            
            return text;
        }
        
        // دالة لتوليد رمز الموظف التلقائي
        async function generateEmployeeCode(projectCode) {
            try {
                // جلب جميع الموظفين في هذا المشروع
                const employeesRef = collection(db, 'employees');
                const snapshot = await getDocs(employeesRef);
                
                let maxNumber = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.project === projectCode && data.employeeCode) {
                        // استخراج الرقم من الكود (مثلاً: PRJ001-015 → 15)
                        const match = data.employeeCode.match(/-(\d+)$/);
                        if (match) {
                            const num = parseInt(match[1]);
                            if (num > maxNumber) maxNumber = num;
                        }
                    }
                });
                
                // إنشاء الرمز الجديد
                const newNumber = (maxNumber + 1).toString().padStart(3, '0');
                return `${projectCode}-${newNumber}`;
                
            } catch (error) {
                console.error('Error generating employee code:', error);
                // في حالة الخطأ، استخدام رقم عشوائي
                return `${projectCode}-${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}`;
            }
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showNotification(type, title, message) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icon = type === 'success' ? '✅' : '❌';
            
            notification.innerHTML = `
                <div class="notification-icon">${icon}</div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function formatCurrency(value) {
            // استخدام الأرقام الإنجليزية دائماً (0-9) مع فواصل الآلاف
            const numValue = parseFloat(value) || 0;
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
                useGrouping: true // تفعيل فواصل الآلاف (1,000 بدلاً من 1000)
            }).format(numValue);
        }
// ========== Authentication System ==========
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            try {
                if (!auth || typeof signInWithEmailAndPassword === 'undefined') {
                    throw new Error('Firebase Auth غير متاح. يرجى تحديث الصفحة.');
                }
                showLoading();
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // لا نحتاج لعمل أي شيء هنا، onAuthStateChanged سيتولى الأمر
                console.log('تم تسجيل الدخول بنجاح:', user.email);
                
            } catch (error) {
                hideLoading();
                console.error('خطأ في تسجيل الدخول:', error);
                console.error('كود الخطأ:', error.code);
                console.error('رسالة الخطأ:', error.message);
                
                let errorMessage = 'حدث خطأ أثناء تسجيل الدخول';
                let errorDetails = '';
                
                if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'البريد الإلكتروني أو كلمة المرور غير صحيحة';
                    errorDetails = '⚠️ تأكد من:\n• صحة البريد الإلكتروني\n• صحة كلمة المرور\n• أن الحساب موجود في النظام\n\n💡 إذا كنت مدير النظام، يمكنك إنشاء حساب جديد من إعدادات المستخدمين';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'كلمة المرور غير صحيحة';
                    errorDetails = 'يرجى التحقق من كلمة المرور والمحاولة مرة أخرى';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = 'المستخدم غير موجود';
                    errorDetails = 'هذا البريد الإلكتروني غير مسجل في النظام. يرجى التواصل مع المدير لإنشاء حساب جديد';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'البريد الإلكتروني غير صالح';
                    errorDetails = 'يرجى إدخال بريد إلكتروني صحيح';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'تم تجاوز عدد المحاولات المسموح بها';
                    errorDetails = 'تم حظر تسجيل الدخول مؤقتاً بسبب كثرة المحاولات الفاشلة. يرجى المحاولة مرة أخرى بعد بضع دقائق';
                } else if (error.code === 'auth/user-disabled') {
                    errorMessage = 'تم تعطيل هذا الحساب';
                    errorDetails = 'يرجى التواصل مع المدير لتفعيل الحساب';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'خطأ في الاتصال بالإنترنت';
                    errorDetails = 'يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى';
                } else {
                    errorDetails = `تفاصيل الخطأ: ${error.message || 'خطأ غير معروف'}`;
                }
                
                // عرض رسالة مفصلة للمستخدم
                const fullMessage = errorDetails ? `${errorMessage}\n\n${errorDetails}` : errorMessage;
                showNotification('error', t('loginError'), fullMessage || t('loginErrorMessage'));
            }
        });

        async function logout() {
            if (confirm(t('confirmLogout'))) {
                try {
                    if (auth && typeof signOut !== 'undefined') {
                        await signOut(auth);
                    }
                    currentUser = null;
                    document.getElementById('app').style.display = 'none';
                    document.getElementById('loginScreen').style.display = 'flex';
                    document.getElementById('loginForm').reset();
                    showNotification('success', 'تم تسجيل الخروج', 'إلى اللقاء! 👋');
                } catch (error) {
                    console.error('خطأ في تسجيل الخروج:', error);
                    showNotification('error', t('error'), t('logoutError'));
                }
            }
        }

        // مراقبة حالة تسجيل الدخول
        // التحقق من أن auth موجود قبل استخدامه
        if (auth && typeof onAuthStateChanged !== 'undefined') {
            try {
                onAuthStateChanged(auth, async (user) => {
            if (user) {
                // المستخدم مسجل دخول
                console.log('المستخدم مسجل الدخول:', user.email);
                
                // الحصول على بيانات المستخدم من Firestore
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                let userData = { role: 'مستخدم', fullAccess: false };
                
                if (userDoc.exists()) {
                    userData = userDoc.data();
                }
                
                currentUser = {
                    uid: user.uid,
                    email: user.email,
                    role: userData.role || 'مستخدم',
                    fullAccess: userData.fullAccess || false,
                    permissions: userData.permissions || {
                        employees: {
                            monthly: { view: true, add: false, edit: false, delete: false },
                            daily: { view: true, add: false, edit: false, delete: false },
                            vehicle: { view: true, add: false, edit: false, delete: false }
                        },
                        projects: { 
                            view: true, 
                            add: false, 
                            edit: false, 
                            delete: false,
                            allowedProjects: []
                        },
                        users: { view: false, add: false, edit: false, delete: false },
                        reports: { view: true, export: false, print: false },
                        settings: false
                    }
                };
                
                // تحديث رقم الإصدار وآخر نشاط
                try {
                    await updateDoc(doc(db, 'users', user.uid), {
                        appVersion: '2.0.9',
                        lastAppUpdate: new Date(),
                        lastLogin: new Date().toISOString()
                    });
                    console.log('✅ تم تحديث معلومات الإصدار');
                } catch (error) {
                    console.log('⚠️ لم يتم تحديث معلومات الإصدار (مستخدم جديد أو صلاحيات محدودة)');
                }
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                document.getElementById('currentUser').textContent = currentUser.role;
                document.getElementById('userAvatar').textContent = user.email[0].toUpperCase();
                
                showNotification('success', 'تم تسجيل الدخول', `مرحباً ${currentUser.role}! 🎉`);
                
                // تحميل الإعدادات والتوقيعات المشتركة
                await loadCompanySettings();
                await loadPrintSignatures();
                
                hideLoading();
                init();
            } else {
                // المستخدم غير مسجل دخول
                console.log('المستخدم غير مسجل الدخول');
                currentUser = null;
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
                hideLoading();
            }
        });
            } catch (authError) {
                console.error('❌ خطأ في onAuthStateChanged:', authError);
                currentUser = null;
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
                hideLoading();
            }
        } else {
            console.warn('⚠️ Firebase Auth غير متاح، استخدام الوضع المحلي');
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
            hideLoading();
        }

        // ========== Session Lock ==========
        const SESSION_KEY = 'salarySystemActiveTab';
        let sessionId = Date.now() + '_' + Math.random();
        let isTabActive = false;

        function initTabLock() {
            const existing = localStorage.getItem(SESSION_KEY);
            if (existing) {
                try {
                    const session = JSON.parse(existing);
                    if (Date.now() - session.timestamp < 3000) {
                        document.getElementById('lockOverlay').classList.add('active');
                        return;
                    }
                } catch(e) {}
            }
            isTabActive = true;
            localStorage.setItem(SESSION_KEY, JSON.stringify({id: sessionId, timestamp: Date.now()}));
            setInterval(() => {
                if (isTabActive) {
                    localStorage.setItem(SESSION_KEY, JSON.stringify({id: sessionId, timestamp: Date.now()}));
                }
            }, 1000);
            window.addEventListener('beforeunload', () => {
                const existing = localStorage.getItem(SESSION_KEY);
                if (existing) {
                    try {
                        const session = JSON.parse(existing);
                        if (session.id === sessionId) localStorage.removeItem(SESSION_KEY);
                    } catch(e) {}
                }
            });
        }

        // ========== Appearance Control ==========
        function toggleAppearancePanel() {
            const panel = document.getElementById('appearancePanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function updateRowHeight(value) {
            document.documentElement.style.setProperty('--row-height', value + 'px');
            document.getElementById('rowHeightValue').textContent = value + 'px';
            // لا يحفظ تلقائياً - سيحفظ عند الضغط على زر "حفظ التنسيق"
        }

        function updateFontSize(value) {
            document.documentElement.style.setProperty('--table-font-size', value + 'px');
            document.getElementById('fontSizeValue').textContent = value + 'px';
            // لا يحفظ تلقائياً
        }

        function updatePadding(value) {
            document.documentElement.style.setProperty('--column-padding', value + 'px');
            document.getElementById('paddingValue').textContent = value + 'px';
            // لا يحفظ تلقائياً
        }

        function updateHeaderHeight(value) {
            document.documentElement.style.setProperty('--header-height', value + 'px');
            document.getElementById('headerHeightValue').textContent = value + 'px';
            // لا يحفظ تلقائياً
        }
        
        // حفظ إعدادات المظهر يدوياً
        function saveAppearanceSettings() {
            const rowHeight = document.getElementById('rowHeightSlider').value;
            const fontSize = document.getElementById('fontSizeSlider').value;
            const padding = document.getElementById('paddingSlider').value;
            const headerHeight = document.getElementById('headerHeightSlider').value;
            
            localStorage.setItem('rowHeight', rowHeight);
            localStorage.setItem('fontSize', fontSize);
            localStorage.setItem('padding', padding);
            localStorage.setItem('headerHeight', headerHeight);
            
            showNotification('success', 'تم الحفظ', 'تم حفظ إعدادات المظهر بنجاح! 🎨');
        }

        function resetAppearance() {
            updateRowHeight(40);
            updateFontSize(11);
            updatePadding(6);
            updateHeaderHeight(50);
            document.getElementById('rowHeightSlider').value = 40;
            document.getElementById('fontSizeSlider').value = 11;
            document.getElementById('paddingSlider').value = 6;
            document.getElementById('headerHeightSlider').value = 50;
            showNotification('success', 'تم إعادة التعيين', 'تم استعادة الإعدادات الافتراضية');
        }

        function loadAppearanceSettings() {
            const rowHeight = localStorage.getItem('rowHeight') || 40;
            const fontSize = localStorage.getItem('fontSize') || 11;
            const padding = localStorage.getItem('padding') || 6;
            const headerHeight = localStorage.getItem('headerHeight') || 50;
            
            updateRowHeight(rowHeight);
            updateFontSize(fontSize);
            updatePadding(padding);
            updateHeaderHeight(headerHeight);
            
            document.getElementById('rowHeightSlider').value = rowHeight;
            document.getElementById('fontSizeSlider').value = fontSize;
            document.getElementById('paddingSlider').value = padding;
            document.getElementById('headerHeightSlider').value = headerHeight;
        }

        // ========== Column Resizing Functions ==========
        function makeColumnsResizable() {
            const tables = document.querySelectorAll('table');
            
            tables.forEach(table => {
                // إزالة table-layout: fixed إذا كان موجوداً
                table.style.tableLayout = 'auto';
                
                const headers = table.querySelectorAll('th');
                
                headers.forEach((header, index) => {
                    // إزالة المقبض القديم إن وُجد
                    const oldResizer = header.querySelector('.resizer');
                    if (oldResizer) oldResizer.remove();
                    
                    // إضافة مقبض جديد
                    const resizer = document.createElement('div');
                    resizer.className = 'resizer';
                    resizer.title = 'اسحب لتغيير عرض العمود';
                    header.appendChild(resizer);
                    
                    let startX, startWidth, startTableWidth;
                    
                    resizer.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        startX = e.pageX;
                        startWidth = header.offsetWidth;
                        startTableWidth = table.offsetWidth;
                        
                        resizer.classList.add('resizing');
                        header.classList.add('resizing');
                        
                        document.body.style.cursor = 'col-resize';
                        document.body.style.userSelect = 'none';
                        
                        // إضافة overlay شفاف لمنع تداخل الأحداث
                        const overlay = document.createElement('div');
                        overlay.id = 'resize-overlay';
                        overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; cursor: col-resize;';
                        document.body.appendChild(overlay);
                        
                        const onMouseMove = (e) => {
                            const diff = e.pageX - startX;
                            const newWidth = startWidth + diff;
                            
                            // بدون حد أدنى - حرية كاملة
                            if (newWidth > 20) { // حد أدنى معقول جداً فقط لمنع الاختفاء
                                // تطبيق العرض على العمود
                                header.style.width = newWidth + 'px';
                                header.style.minWidth = newWidth + 'px';
                                header.style.maxWidth = newWidth + 'px';
                                
                                // تطبيق نفس العرض على جميع خلايا العمود
                                const rows = table.querySelectorAll('tbody tr');
                                rows.forEach(row => {
                                    const cell = row.cells[index];
                                    if (cell) {
                                        cell.style.width = newWidth + 'px';
                                        cell.style.minWidth = newWidth + 'px';
                                        cell.style.maxWidth = newWidth + 'px';
                                        cell.style.overflow = 'hidden';
                                        cell.style.textOverflow = 'ellipsis';
                                        cell.style.whiteSpace = 'nowrap';
                                    }
                                });
                                
                                // تحديث عرض الجدول
                                const newTableWidth = startTableWidth + diff;
                                table.style.width = newTableWidth + 'px';
                            }
                        };
                        
                        const onMouseUp = () => {
                            resizer.classList.remove('resizing');
                            header.classList.remove('resizing');
                            document.body.style.cursor = '';
                            document.body.style.userSelect = '';
                            
                            // إزالة overlay
                            const overlay = document.getElementById('resize-overlay');
                            if (overlay) overlay.remove();
                            
                            document.removeEventListener('mousemove', onMouseMove);
                            document.removeEventListener('mouseup', onMouseUp);
                            
                            // حفظ عرض العمود
                            const tableId = table.id || 'employeeTable'; // يجب أن يكون متطابقاً مع loadColumnWidths
                            saveColumnWidth(tableId, index, header.offsetWidth);
                            
                            // إعادة تطبيق التثبيت بعد تغيير حجم العمود
                            setTimeout(() => {
                                if (tableId.includes('project')) {
                                    applyPinnedColumns(tableId, 'project');
                                } else {
                                    applyPinnedColumns(tableId, 'month');
                                }
                            }, 50);
                            
                            console.log('✅ Column resized:', index, '→', header.offsetWidth + 'px');
                        };
                        
                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onMouseUp);
                    });
                    
                    // إضافة double-click لإعادة تعيين العرض التلقائي
                    resizer.addEventListener('dblclick', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        header.style.width = '';
                        header.style.minWidth = '';
                        header.style.maxWidth = '';
                        
                        const rows = table.querySelectorAll('tbody tr');
                        rows.forEach(row => {
                            const cell = row.cells[index];
                            if (cell) {
                                cell.style.width = '';
                                cell.style.minWidth = '';
                                cell.style.maxWidth = '';
                                cell.style.overflow = '';
                                cell.style.textOverflow = '';
                                cell.style.whiteSpace = '';
                            }
                        });
                        
                        console.log('✅ Column width reset to auto:', index);
                        showNotification('info', 'تم إعادة التعيين', 'تم إعادة عرض العمود للحجم التلقائي');
                    });
                });
            });
            
            console.log('✅ Column resizing enabled for', tables.length, 'tables');
        }
        
        // ========== نظام حفظ التنسيقات ==========
        let pendingColumnWidths = {}; // تخزين مؤقت للتغييرات قبل الحفظ
        
        function saveColumnWidth(tableId, columnIndex, width) {
            // حفظ مؤقت فقط (لا يحفظ في localStorage حتى يضغط المستخدم على زر الحفظ)
            if (!pendingColumnWidths[tableId]) {
                pendingColumnWidths[tableId] = {};
            }
            pendingColumnWidths[tableId][columnIndex] = width;
            console.log(`📝 تغيير عرض العمود (مؤقت): ${tableId} [${columnIndex}] = ${width}px`);
        }
        
        // حفظ تنسيق الجدول (عرض الأعمدة فقط)
        function saveCurrentFormatting() {
            let columnCount = 0;
            
            // أولاً: حفظ التغييرات المعلقة
            for (const tableId in pendingColumnWidths) {
                for (const columnIndex in pendingColumnWidths[tableId]) {
                    const width = pendingColumnWidths[tableId][columnIndex];
                    const key = `columnWidth_${tableId}_${columnIndex}`;
                    localStorage.setItem(key, width);
                    columnCount++;
                }
            }
            
            // ثانياً: حفظ الأعمدة الحالية الظاهرة (حتى لو لم تتغير)
            const tables = document.querySelectorAll('table');
            tables.forEach(table => {
                const tableId = table.id || 'employeeTable';
                const headers = table.querySelectorAll('thead th');
                
                headers.forEach((header, index) => {
                    // إذا كان للعمود عرض محدد، احفظه
                    const currentWidth = header.offsetWidth;
                    if (currentWidth && currentWidth > 20) {
                        const key = `columnWidth_${tableId}_${index}`;
                        // حفظ فقط إذا كان مختلفاً عن القيمة المحفوظة أو إذا كان في pendingColumnWidths
                        const savedWidth = localStorage.getItem(key);
                        if (!savedWidth || pendingColumnWidths[tableId]?.[index]) {
                            localStorage.setItem(key, currentWidth);
                            columnCount++;
                        }
                    }
                });
            });
            
                pendingColumnWidths = {}; // مسح التخزين المؤقت
            
            if (columnCount > 0) {
                showNotification('success', 'تم الحفظ', `تم حفظ تنسيق ${columnCount} عمود ✅`);
                console.log(`✅ تم حفظ ${columnCount} عرض عمود`);
            } else {
                showNotification('info', 'تم الحفظ', 'تم حفظ التنسيق الحالي');
            }
        }
        
        function loadColumnWidths() {
            const tables = document.querySelectorAll('table');
            let loadedCount = 0;
            
            tables.forEach(table => {
                const headers = table.querySelectorAll('thead th');
                const tableId = table.id || 'employeeTable';
                
                headers.forEach((header, index) => {
                    const key = `columnWidth_${tableId}_${index}`;
                    const savedWidth = localStorage.getItem(key);
                    
                    if (savedWidth && parseFloat(savedWidth) > 0) {
                        const width = parseFloat(savedWidth);
                        
                        // تطبيق على الرأس
                        header.style.width = width + 'px';
                        header.style.minWidth = width + 'px';
                        header.style.maxWidth = width + 'px';
                        
                        // تطبيق على جميع خلايا العمود
                        const rows = table.querySelectorAll('tbody tr');
                        rows.forEach(row => {
                            const cell = row.cells[index];
                            if (cell) {
                                cell.style.width = width + 'px';
                                cell.style.minWidth = width + 'px';
                                cell.style.maxWidth = width + 'px';
                                cell.style.overflow = 'hidden';
                                cell.style.textOverflow = 'ellipsis';
                                cell.style.whiteSpace = 'nowrap';
                            }
                        });
                        loadedCount++;
                    }
                });
            });
            
            if (loadedCount > 0) {
                console.log(`✅ تم تحميل ${loadedCount} عرض عمود محفوظ`);
            }
        }
        
        // ملاحظة: تم إلغاء حفظ/تحميل الفلاتر
        // الفلاتر تُطبق مؤقتاً فقط ولا تُحفظ
        
        // ملاحظة: تم إلغاء حفظ/تحميل حالة العرض
        // البرنامج يبدأ دائماً من لوحة التحكم عند تسجيل الدخول
        
        // مسح جميع التنسيقات المحفوظة
        function clearAllSavedSettings() {
            if (confirm('هل تريد مسح جميع التنسيقات المحفوظة والعودة للإعدادات الافتراضية؟')) {
                // مسح أعراض الأعمدة
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('columnWidth_')) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                // إعادة تعيين المظهر
                resetAppearance();
                
                showNotification('success', 'تم إعادة التعيين', 'سيتم إعادة تحميل الصفحة...');
                setTimeout(() => location.reload(), 1500);
            }
        }

        // ========== Language Functions ==========
        function toggleLanguage() {
            currentLang = currentLang === 'ar' ? 'en' : 'ar';
            document.documentElement.lang = currentLang;
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            localStorage.setItem('appLanguage', currentLang);
            updateLanguage();
            renderContent();
        }

        function loadLanguage() {
            const saved = localStorage.getItem('appLanguage');
            if (saved) {
                currentLang = saved;
                document.documentElement.lang = currentLang;
                document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            }
            updateLanguage();
        }

        function updateLanguage() {
            // تحديث العناصر الموجودة فقط
            const elements = {
                // Header
                'headerTitle': 'PayRose',
                'userRole': t('systemManager'),
                // Navigation Bar
                'navDashboardText': t('navDashboard'),
                'navMonthsText': t('navMonths'),
                'navProjectsText': t('navProjects'),
                'navYearsText': t('navYears'),
                'navUsersText': t('navUsers'),
                'navSettingsText': t('navSettings'),
                'navBulkEditText': currentLang === 'ar' ? 'تعديل متعدد' : 'Bulk Edit',
                'navReportsText': t('navReports')
            };
            
            // تحديث نافذة كلمة المرور إذا كانت مفتوحة
            const passwordModal = document.getElementById('passwordModal');
            if (passwordModal && passwordModal.classList.contains('active')) {
                const headerText = passwordModal.querySelector('#passwordModalTitle');
                const descText = passwordModal.querySelector('#passwordModalDesc');
                const labelText = passwordModal.querySelector('#passwordLabel');
                const inputPlaceholder = passwordModal.querySelector('#passwordInput');
                const errorText = passwordModal.querySelector('#passwordError');
                const buttonText = passwordModal.querySelector('.modal-actions button');
                
                if (headerText) {
                    headerText.textContent = `🔒 ${currentLang === 'ar' ? 'حماية' : 'Protection'}`;
                }
                
                if (labelText) {
                    labelText.textContent = currentLang === 'ar' ? '🔑 كلمة المرور:' : '🔑 Password:';
                }
                
                if (inputPlaceholder) {
                    inputPlaceholder.placeholder = currentLang === 'ar' ? 'أدخل كلمة المرور' : 'Enter password';
                }
                
                if (errorText) {
                    errorText.textContent = currentLang === 'ar' ? '❌ كلمة المرور غير صحيحة' : '❌ Incorrect password';
                }
                
                if (buttonText) {
                    buttonText.textContent = currentLang === 'ar' ? '✅ تأكيد' : '✅ Confirm';
                }
                
                if (descText && pendingTab) {
                    const tabName = pendingTab === 'settings' 
                        ? (currentLang === 'ar' ? 'الإعدادات' : 'Settings')
                        : (currentLang === 'ar' ? 'المستخدمين' : 'Users');
                    descText.textContent = currentLang === 'ar' 
                        ? `يرجى إدخال كلمة المرور للوصول إلى ${tabName}`
                        : `Please enter password to access ${tabName}`;
                }
            }
            
            // Breadcrumbs
            elements['breadcrumbHome'] = t('breadcrumbHome');
            // User Dropdown
            elements['profileText'] = t('profile');
            elements['signaturesText'] = t('signatures');
            elements['appearanceText'] = t('appearance');
            elements['languageText'] = currentLang === 'ar' ? 'English' : 'العربية';
            elements['backupText'] = t('backup');
            elements['importText'] = t('import');
            elements['migrateText'] = t('migrate');
            elements['logoutText'] = t('logout');
            elements['printSummaryText'] = t('printSummary');
            // Summary Modal Elements
            elements['summaryModalTitle'] = currentLang === 'ar' ? '📊 الملخصات والمقارنات' : '📊 Summaries & Comparisons';
            elements['summaryProjectLabel'] = currentLang === 'ar' ? '🏗 المشروع' : '🏗 Project';
            elements['summaryMonth1Label'] = currentLang === 'ar' ? '📅 الشهر الأول' : '📅 First Month';
            elements['summaryMonth2Label'] = currentLang === 'ar' ? '📅 الشهر الثاني (للمقارنة)' : '📅 Second Month (for Comparison)';
            elements['summaryProjectPlaceholder'] = currentLang === 'ar' ? 'اختر المشروع' : 'Select Project';
            elements['summaryProjectAll'] = currentLang === 'ar' ? '🌐 جميع المشاريع' : '🌐 All Projects';
            elements['summaryMonth2Placeholder'] = currentLang === 'ar' ? 'بدون مقارنة' : 'No Comparison';
            elements['generateSummaryBtn'] = currentLang === 'ar' ? 'عرض الملخص' : 'Generate Summary';
            elements['summaryCloseBtn'] = t('close') || (currentLang === 'ar' ? 'إغلاق' : 'Close');
            // Old Elements (compatibility)
            elements['langIcon'] = currentLang === 'ar' ? '🌐 English' : '🌐 العربية';
            elements['summaryBtn'] = currentLang === 'ar' ? '📊 الملخصات والمقارنات' : '📊 Summaries & Comparisons';
            elements['navActivityLogText'] = currentLang === 'ar' ? 'سجل التعديلات' : 'Activity Log';
            elements['navVouchersText'] = currentLang === 'ar' ? 'قسائم الراتب' : 'Salary Vouchers';
            elements['excelText'] = 'Excel';
            elements['printText'] = currentLang === 'ar' ? 'طباعة' : 'Print';
            elements['jsonText'] = 'JSON';
            elements['dashboardTab'] = currentLang === 'ar' ? '📊 لوحة التحكم' : '📊 Dashboard';
            elements['usersTab'] = currentLang === 'ar' ? '👥 إدارة المستخدمين' : '👥 User Management';
            elements['yearsTab'] = currentLang === 'ar' ? '📅 إدارة السنوات' : '📅 Years Management';
            elements['settingsTab'] = currentLang === 'ar' ? '⚙️ الإعدادات' : '⚙️ Settings';
            elements['monthsTab'] = currentLang === 'ar' ? '📆 الأشهر ▼' : '📆 Months ▼';
            elements['projectsTab'] = currentLang === 'ar' ? '🏗 المشاريع ▼' : '🏗 Projects ▼';
            elements['bulkEditTab'] = currentLang === 'ar' ? '✏️ تعديل متعدد' : '✏️ Bulk Edit';
            elements['appearanceBtn'] = currentLang === 'ar' ? 'التحكم في المظهر' : 'Appearance Control';
            
            // تحديث عناصر نافذة الملخصات
            const summaryProjectSelect = document.getElementById('summaryProject');
            if (summaryProjectSelect) {
                const placeholder = summaryProjectSelect.querySelector('#summaryProjectPlaceholder');
                const allOption = summaryProjectSelect.querySelector('#summaryProjectAll');
                if (placeholder) placeholder.textContent = elements.summaryProjectPlaceholder || (currentLang === 'ar' ? 'اختر المشروع' : 'Select Project');
                if (allOption) allOption.textContent = elements.summaryProjectAll || (currentLang === 'ar' ? '🌐 جميع المشاريع' : '🌐 All Projects');
            }
            
            const summaryMonth2Select = document.getElementById('summaryMonth2');
            if (summaryMonth2Select) {
                const placeholder = summaryMonth2Select.querySelector('#summaryMonth2Placeholder');
                if (placeholder) placeholder.textContent = elements.summaryMonth2Placeholder || (currentLang === 'ar' ? 'بدون مقارنة' : 'No Comparison');
            }
            
            Object.entries(elements).forEach(([id, text]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = text;
                }
            });
            
            // Update breadcrumb current based on active view
            updateNavigation(currentView);
            
            populateDropdowns();
        }
// ========== Firebase Functions ==========

        // ========== Utilities: Image compression for logo ==========
        function estimateDataUrlBytes(dataUrl) {
            // Base64 payload length after comma
            const base64 = (dataUrl.split(',')[1] || '');
            // 4 base64 chars -> 3 bytes
            return Math.floor(base64.length * 3 / 4);
        }

        function compressImage(file, maxWidth, maxHeight, mimeType, quality) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const reader = new FileReader();
                reader.onload = e => {
                    img.onload = () => {
                        try {
                            let { width, height } = img;
                            const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
                            const canvas = document.createElement('canvas');
                            canvas.width = Math.round(width * ratio);
                            canvas.height = Math.round(height * ratio);
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            const dataUrl = canvas.toDataURL(mimeType || 'image/jpeg', quality == null ? 0.8 : quality);
                            resolve(dataUrl);
                        } catch (err) {
                            reject(err);
                        }
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ========== إدارة الإعدادات والتوقيعات المشتركة ==========
        
        /**
         * تحميل إعدادات الشركة من Firebase
         */
        async function loadCompanySettings() {
            try {
                if (getStorageMode() === 'local') {
                    // الوضع المحلي
                    const settings = LocalData.loadCompanySettings();
                    if (settings && Object.keys(settings).length > 0) {
                        companySettings = settings;
                        console.log('✅ تم تحميل إعدادات الشركة (محلي):', companySettings);
                    } else {
                        // إعدادات افتراضية
                        companySettings = {
                            companyNameAr: 'شركة روزماري',
                            companyNameEn: 'ROSEMARY COMPANY',
                            companyLogo: '',
                            companyAddress: '',
                            companyPhone: '',
                            companyEmail: ''
                        };
                        console.log('📝 استخدام الإعدادات الافتراضية (محلي)');
                    }
                } else {
                    // الوضع السحابي (Firebase)
                const settingsDoc = await getDoc(doc(db, 'settings', 'company'));
                if (settingsDoc.exists()) {
                    companySettings = settingsDoc.data();
                    console.log('✅ تم تحميل إعدادات الشركة:', companySettings);
                } else {
                    // إعدادات افتراضية
                    companySettings = {
                        companyNameAr: 'شركة روزماري',
                        companyNameEn: 'ROSEMARY COMPANY',
                        companyLogo: '',
                        companyAddress: '',
                        companyPhone: '',
                        companyEmail: ''
                    };
                    console.log('📝 استخدام الإعدادات الافتراضية');
                    }
                }
            } catch (error) {
                console.error('❌ خطأ في تحميل إعدادات الشركة:', error);
                companySettings = {};
            }
        }
        
        /**
         * حفظ إعدادات الشركة في Firebase
         */
        async function saveCompanySettings(settings) {
            try {
                if (getStorageMode() === 'local') {
                    // الوضع المحلي
                    const user = LocalAuth.getCurrentUser();
                    const settingsToSave = {
                        ...settings,
                        updatedAt: new Date().toISOString(),
                        updatedBy: user?.email || 'local_user'
                    };
                    LocalData.saveCompanySettings(settingsToSave);
                    companySettings = settings;
                    console.log('✅ تم حفظ إعدادات الشركة (محلي)');
                    return true;
                } else {
                    // الوضع السحابي (Firebase)
                await setDoc(doc(db, 'settings', 'company'), {
                    ...settings,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser?.email || 'unknown'
                });
                companySettings = settings;
                console.log('✅ تم حفظ إعدادات الشركة');
                return true;
                }
            } catch (error) {
                console.error('❌ خطأ في حفظ إعدادات الشركة:', error);
                return false;
            }
        }
        
        /**
         * تحميل التوقيعات من Firebase
         */
        async function loadPrintSignatures() {
            try {
                if (getStorageMode() === 'local') {
                    // الوضع المحلي
                    const sigs = LocalData.loadSignatures();
                    if (sigs && Object.keys(sigs).length > 0) {
                        printSignatures = sigs;
                        console.log('✅ تم تحميل التوقيعات (محلي):', printSignatures);
                    } else {
                        printSignatures = {};
                        console.log('📝 لا توجد توقيعات محفوظة (محلي)');
                    }
                } else {
                    // الوضع السحابي (Firebase)
                const signaturesDoc = await getDoc(doc(db, 'settings', 'signatures'));
                if (signaturesDoc.exists()) {
                    printSignatures = signaturesDoc.data();
                    console.log('✅ تم تحميل التوقيعات:', printSignatures);
                } else {
                    printSignatures = {};
                    console.log('📝 لا توجد توقيعات محفوظة');
                    }
                }
            } catch (error) {
                console.error('❌ خطأ في تحميل التوقيعات:', error);
                printSignatures = {};
            }
        }
        
        /**
         * حفظ التوقيعات في Firebase أو Local
         */
        async function savePrintSignatures(signatures) {
            try {
                if (getStorageMode() === 'local') {
                    // الوضع المحلي
                    const user = LocalAuth.getCurrentUser();
                    const sigsToSave = {
                        ...signatures,
                        updatedAt: new Date().toISOString(),
                        updatedBy: user?.email || 'local_user'
                    };
                    LocalData.saveSignatures(sigsToSave);
                    printSignatures = signatures;
                    console.log('✅ تم حفظ التوقيعات (محلي)');
                    return true;
                } else {
                    // الوضع السحابي (Firebase)
                await setDoc(doc(db, 'settings', 'signatures'), {
                    ...signatures,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser?.email || 'unknown'
                });
                printSignatures = signatures;
                console.log('✅ تم حفظ التوقيعات');
                return true;
                }
            } catch (error) {
                console.error('❌ خطأ في حفظ التوقيعات:', error);
                return false;
            }
        }

        async function loadProjectsFromFirebase() {
            try {
                if (getStorageMode() === 'local') {
                    // الوضع المحلي
                    console.log('🔄 Loading projects from Local Storage...');
                    const localProjects = LocalData.loadProjects();
                    projects = localProjects || {};
                    
                    console.log('📊 Total projects (local):', Object.keys(projects).length);
                    
                    // إذا لم توجد مشاريع، إضافة مشروع افتراضي
                    if (Object.keys(projects).length === 0) {
                        console.log('⚠️ No projects found, creating default project...');
                        projects['DEFAULT'] = 'المشروع الافتراضي';
                        LocalData.saveProjects(projects);
                        console.log('✅ Default project created (local)');
                    }
                    
                    populateDropdowns();
                    console.log('✅ Projects loaded and dropdowns populated (local)');
                } else {
                    // الوضع السحابي (Firebase)
                console.log('🔄 Loading projects from Firebase...');
                const projectsRef = collection(db, 'projects');
                const snapshot = await getDocs(projectsRef);
                projects = {};
                snapshot.forEach(doc => {
                    projects[doc.id] = doc.data().name;
                    console.log('✅ Project loaded:', doc.id, '=', doc.data().name);
                });
                
                console.log('📊 Total projects:', Object.keys(projects).length);
                
                // إذا لم توجد مشاريع، إضافة مشروع افتراضي
                if (Object.keys(projects).length === 0) {
                    console.log('⚠️ No projects found, creating default project...');
                    const defaultProject = {
                        code: 'DEFAULT',
                        name: 'المشروع الافتراضي',
                        description: 'مشروع تجريبي',
                        status: 'active',
                        createdAt: new Date().toISOString()
                    };
                    
                    await setDoc(doc(db, 'projects', 'DEFAULT'), defaultProject);
                    projects['DEFAULT'] = defaultProject.name;
                    console.log('✅ Default project created');
                }
                
                populateDropdowns();
                console.log('✅ Projects loaded and dropdowns populated');
                }
            } catch (error) {
                console.error('❌ Error loading projects:', error);
                showNotification('error', t('error'), t('loadProjectsError') + ': ' + error.message);
            }
        }

        // ========== Years Management Functions ==========
        async function loadYearsFromFirebase() {
            try {
                console.log('🔄 Loading years from Firebase...');
                const yearsRef = collection(db, 'years');
                const snapshot = await getDocs(yearsRef);
                availableYears = [];
                
                snapshot.forEach(doc => {
                    const yearData = doc.data();
                    availableYears.push(parseInt(yearData.year));
                    console.log('✅ Year loaded:', yearData.year);
                });
                
                // ترتيب السنوات
                availableYears.sort((a, b) => a - b);
                
                console.log('📅 Total years:', availableYears.length);
                
                // إذا لم توجد سنوات، إضافة السنة الحالية
                if (availableYears.length === 0) {
                    console.log('⚠️ No years found, creating current year...');
                    await addYearToFirebase(currentYear);
                }
                
                // التأكد من وجود السنة الحالية في القائمة
                if (!availableYears.includes(currentYear)) {
                    currentYear = availableYears[availableYears.length - 1] || new Date().getFullYear();
                }
                
                populateYearSelector();
                initializeEmployeeData();
                console.log('✅ Years loaded successfully');
            } catch (error) {
                console.error('❌ Error loading years:', error);
                showNotification('error', t('error'), t('loadYearsError') + ': ' + error.message);
            }
        }

        async function addYearToFirebase(year) {
            try {
                showLoading();
                const yearStr = year.toString();
                
                // التحقق من عدم وجود السنة مسبقاً
                if (availableYears.includes(year)) {
                    hideLoading();
                    showNotification('warning', 'تنبيه', `السنة ${year} موجودة بالفعل`);
                    return;
                }
                
                await setDoc(doc(db, 'years', yearStr), {
                    year: year,
                    createdAt: new Date().toISOString()
                });
                
                await loadYearsFromFirebase();
                hideLoading();
                showNotification('success', t('success'), t('addYearSuccess', {year: year}));
                console.log('✅ Year added:', year);
            } catch (error) {
                console.error('❌ Error adding year:', error);
                hideLoading();
                showNotification('error', t('error'), t('addYearError'));
            }
        }

        async function deleteYearFromFirebase(year) {
            try {
                // التحقق من وجود المستخدم
                if (!currentUser) {
                    showNotification('error', t('notAuthorized'), t('loginRequired'));
                    return;
                }
                
                // التحقق من الصلاحيات - حذف السنوات يتطلب صلاحيات كاملة
                // لأنها عملية خطيرة جداً (تحذف جميع البيانات)
                if (!hasFullAccess()) {
                    // يمكن إضافة صلاحية محددة للسنوات لاحقاً إذا لزم الأمر
                    showNotification('error', t('notAuthorized'), t('noDeletePermission') + ' ' + t('yearsManagement').toLowerCase() + '. ' + t('fullAccessRequired'));
                    return;
                }
                
                // عدم السماح بحذف السنة الحالية المستخدمة
                if (year === currentYear) {
                    showNotification('error', t('error'), t('deleteYearError'));
                    return;
                }
                
                if (confirm(t('deleteYearConfirm', {year: year}))) {
                    showLoading();
                    
                    // حذف السنة من قاعدة البيانات
                    await deleteDoc(doc(db, 'years', year.toString()));
                    
                    // حذف جميع موظفي هذه السنة
                    const employeesRef = collection(db, 'employees');
                    const snapshot = await getDocs(employeesRef);
                    
                    for (const empDoc of snapshot.docs) {
                        const empData = empDoc.data();
                        if (empData.year === year) {
                            await deleteDoc(doc(db, 'employees', empDoc.id));
                        }
                    }
                    
                    await loadYearsFromFirebase();
                    await loadEmployeesFromFirebase();
                    hideLoading();
                    showNotification('success', t('success'), t('deleteYearSuccess', {year: year}));
                }
            } catch (error) {
                console.error('❌ Error deleting year:', error);
                hideLoading();
                showNotification('error', t('error'), t('deleteYearError2'));
            }
        }

        function openAddYearModal() {
            const yearInput = prompt(currentLang === 'ar' ? 'أدخل السنة الجديدة:' : 'Enter new year:', new Date().getFullYear());
            if (yearInput) {
                const year = parseInt(yearInput);
                if (year && year > 1900 && year < 2100) {
                    addYearToFirebase(year);
                } else {
                    alert(currentLang === 'ar' ? 'السنة غير صحيحة' : 'Invalid year');
                }
            }
        }

        async function loadEmployeesFromFirebase() {
            try {
                if (getStorageMode() === 'local') {
                    // الوضع المحلي
                    console.log('🔄 Loading employees from Local Storage...');
                    showLoading();
                    const allEmployees = LocalData.loadAllEmployees();
                    employeeData = allEmployees || {};
                    
                    // التأكد من تهيئة البيانات
                    if (Object.keys(employeeData).length === 0) {
                        initializeEmployeeData();
                    }
                    
                    console.log('✅ Employees loaded successfully (local)');
                    
                    if (!initialPeriodSet) {
                        const latestPeriod = getLatestUpdatedPeriod();
                        if (latestPeriod && latestPeriod.year && latestPeriod.month) {
                            currentYear = latestPeriod.year;
                            currentMonth = latestPeriod.month;
                            dashboardSelectedMonth = latestPeriod.month;
                            selectedProjectMonth = latestPeriod.month;
                            updateYearSelector();
                        }
                        initialPeriodSet = true;
                    }
                    
                    hideLoading();
                    renderContent();
                    return;
                }
                
                // الوضع السحابي (Firebase)
                console.log('🔄 Loading employees from Firebase...');
                showLoading();
                
                // تتبع استخدام Firebase (قراءة)
                trackFirebaseUsage('read', 1);
                
                const employeesRef = collection(db, 'employees');
                
                // إضافة معالجة أخطاء أفضل مع إعادة المحاولة
                let snapshot;
                let retryCount = 0;
                const maxRetries = 3;
                
                while (retryCount < maxRetries) {
                    try {
                        snapshot = await getDocs(employeesRef);
                        break; // نجح، اخرج من الحلقة
                    } catch (fetchError) {
                        retryCount++;
                        const errorMessage = fetchError.message || fetchError.toString();
                        
                        // تجاهل أخطاء 404 في WebChannel (لا تؤثر على الوظائف)
                        if (errorMessage.includes('404') && errorMessage.includes('Listen')) {
                            console.warn('⚠️ WebChannel 404 error (ignored, will retry):', errorMessage);
                            // انتظار قصير ثم إعادة المحاولة
                            await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                            continue;
                        }
                        
                        // إذا كانت المحاولة الأخيرة، أظهر الخطأ
                        if (retryCount >= maxRetries) {
                            console.error('❌ Failed to load employees after', maxRetries, 'attempts:', fetchError);
                            hideLoading();
                            showNotification('error', 
                                currentLang === 'ar' ? 'خطأ في التحميل' : 'Load Error',
                                currentLang === 'ar' 
                                    ? 'فشل تحميل بيانات الموظفين من Firebase. يرجى التحقق من الاتصال بالإنترنت وإعادة المحاولة.'
                                    : 'Failed to load employees from Firebase. Please check your internet connection and try again.'
                            );
                            return;
                        }
                        
                        console.warn(`⚠️ Attempt ${retryCount} failed, retrying... (${maxRetries - retryCount} attempts left)`, fetchError);
                        await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                    }
                }
                
                console.log('📊 Total employee documents:', snapshot.size);
                
                // ⚠️ إعادة تهيئة البيانات بشكل كامل (مسح جميع البيانات القديمة)
                employeeData = {};
                initializeEmployeeData();
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const month = data.month || 'august';
                    const year = data.year || currentYear; // استخدام السنة الحالية للبيانات القديمة
                    
                    // التأكد من وجود السنة في البنية
                    if (!employeeData[year]) {
                        employeeData[year] = {};
                        months.forEach(m => employeeData[year][m] = []);
                    }
                    
                    if (!employeeData[year][month]) {
                        employeeData[year][month] = [];
                    }
                    
                    // تهيئة بيانات الحجز للبيانات القديمة
                    const globalReservationEnabled = companySettings.globalReservationEnabled || false;
                    const globalReservationType = companySettings.globalReservationType || 'percentage';
                    const globalReservationPercentage = companySettings.globalReservationPercentage || 10;
                    const globalReservationAmount = companySettings.globalReservationAmount || 0;
                    
                    // إذا كانت البيانات القديمة لا تحتوي على معلومات الحجز، نطبق الإعدادات العامة
                    const employeeEntry = {
                        firebaseId: doc.id,
                        ...data,
                        month: month, // التأكد من وجود month
                        year: year,     // التأكد من وجود year
                        // تهيئة بيانات الحجز للبيانات القديمة
                        salaryReservationEnabled: data.salaryReservationEnabled !== undefined ? data.salaryReservationEnabled : (globalReservationEnabled ? true : false),
                        reservationPercentage: data.reservationPercentage !== undefined ? data.reservationPercentage : (globalReservationEnabled && globalReservationType === 'percentage' ? globalReservationPercentage : 10),
                        previousReservedAmount: data.previousReservedAmount !== undefined ? data.previousReservedAmount : 0,
                        reservedAmount: data.reservedAmount !== undefined ? data.reservedAmount : 0,
                        targetReservedAmount: data.targetReservedAmount !== undefined ? data.targetReservedAmount : 0,
                        reservationCurrency: data.reservationCurrency || data.paymentCurrency || 'IQD',
                        reservationNotes: data.reservationNotes || null
                    };
                    
                    employeeData[year][month].push(employeeEntry);
                });
                
                // تهيئة بيانات الحجز للبيانات القديمة بعد التحميل
                initializeReservationDataForOldEmployees();
                
                console.log('✅ Employees loaded successfully');

                if (!initialPeriodSet) {
                    const latestPeriod = getLatestUpdatedPeriod();
                    if (latestPeriod && latestPeriod.year && latestPeriod.month) {
                        currentYear = latestPeriod.year;
                        currentMonth = latestPeriod.month;
                        dashboardSelectedMonth = latestPeriod.month;
                        selectedProjectMonth = latestPeriod.month;
                        updateYearSelector();
                    }
                    initialPeriodSet = true;
                }

                hideLoading();
                renderContent();
            } catch (error) {
                console.error('Error loading employees:', error);
                hideLoading();
                showNotification('error', t('error'), t('loadEmployeesError'));
            }
        }

        async function saveEmployeeToFirebase(employeeData, month, year = currentYear) {
            try {
                if (getStorageMode() === 'local') {
                    // الوضع المحلي
                    showLoading();
                    const employeeId = employeeData.firebaseId || Date.now().toString() + Math.random().toString(36).substr(2, 9);
                    const isNew = !employeeData.firebaseId;
                    
                    // التأكد من وجود البنية
                    if (!employeeData[year]) {
                        employeeData[year] = {};
                    }
                    if (!employeeData[year][month]) {
                        employeeData[year][month] = [];
                    }
                    
                    // إعداد البيانات للحفظ
                    const dataToSave = {
                        ...employeeData,
                        month: month,
                        year: year,
                        firebaseId: employeeId,
                        updatedAt: new Date().toISOString()
                    };
                    
                    if (isNew) {
                        dataToSave.createdAt = new Date().toISOString();
                    }
                    
                    // إضافة أو تحديث الموظف في المصفوفة
                    const existingIndex = employeeData[year][month].findIndex(emp => emp.firebaseId === employeeId);
                    if (existingIndex >= 0) {
                        employeeData[year][month][existingIndex] = dataToSave;
                    } else {
                        employeeData[year][month].push(dataToSave);
                    }
                    
                    // حفظ جميع البيانات
                    LocalData.saveAllEmployees(employeeData);
                    
                    // إعادة تحميل البيانات
                    await loadEmployeesFromFirebase();
                    hideLoading();
                    showNotification('success', 'تم الحفظ', 'تم حفظ الموظف بنجاح! ✅');
                    return;
                }
                
                // الوضع السحابي (Firebase)
                showLoading();
                
                // تحديد ما إذا كان الموظف جديداً أم تعديلاً
                const isNew = !employeeData.firebaseId && !employeeData.id;
                
                // إنشاء معرف جديد للموظفين الجدد (عند النسخ أو الإضافة)
                // إذا كان الموظف جديداً (لا يوجد firebaseId)، ننشئ معرف جديد
                // إذا كان تعديلاً، يجب أن يكون firebaseId موجوداً
                let employeeId = employeeData.firebaseId || employeeData.id;
                
                if (isNew) {
                    // موظف جديد - إنشاء معرف جديد
                    employeeId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                    console.log('✅ إنشاء موظف جديد مع معرف:', employeeId);
                } else if (!employeeId) {
                    // محاولة تعديل موظف بدون معرف - خطأ
                    console.error('⚠️ محاولة تعديل موظف بدون firebaseId:', employeeData);
                    hideLoading();
                    showNotification('error', 'خطأ', 'لا يمكن تعديل الموظف - معرف الموظف مفقود.');
                    return;
                }
                
                // حفظ البيانات القديمة للتتبع (إذا كان تعديل)
                let oldData = null;
                if (!isNew) {
                    try {
                        const oldDoc = await getDoc(doc(db, 'employees', employeeId));
                        if (oldDoc.exists()) {
                            oldData = oldDoc.data();
                        }
                    } catch (e) {
                        console.warn('Could not load old data for comparison:', e);
                    }
                }
                
                // تطبيق الإعدادات العامة للحجز إذا كانت مفعّلة
                const globalReservationEnabled = companySettings.globalReservationEnabled || false;
                const shouldEnableReservation = employeeData.salaryReservationEnabled !== undefined ? 
                    employeeData.salaryReservationEnabled : 
                    globalReservationEnabled;
                
                // تطبيق الإعدادات العامة إذا كانت مفعّلة والموظف لا يحتوي على إعدادات محلية
                if (shouldEnableReservation && employeeData.salaryReservationEnabled === undefined) {
                    employeeData.salaryReservationEnabled = true;
                    if (!employeeData.reservationPercentage || employeeData.reservationPercentage === 0) {
                        if (companySettings.globalReservationType === 'percentage') {
                            employeeData.reservationPercentage = companySettings.globalReservationPercentage || 10;
                        } else if (companySettings.globalReservationType === 'amount') {
                            // سيتم حساب النسبة لاحقاً من الراتب الصافي
                            employeeData.reservationPercentage = 0;
                        }
                    }
                }
                
                // حساب المبلغ المحجوز تلقائياً إذا كان الحجز مفعلاً
                if (shouldEnableReservation) {
                    const netBeforeReservation = calculateActualSalary(employeeData, month, year);
                    const netInPaymentCurrency = convertToPaymentCurrency(netBeforeReservation, 'USD', employeeData);
                    const bonus = convertToPaymentCurrency(employeeData.bonus || 0, employeeData.bonusCurrency || 'IQD', employeeData);
                    const phoneBills = convertToPaymentCurrency(employeeData.phoneBills || 0, employeeData.phoneBillsCurrency || 'IQD', employeeData);
                    const ceoBonus = convertToPaymentCurrency(employeeData.ceoBonus || 0, employeeData.ceoBonusCurrency || 'IQD', employeeData);
                    const deductions = convertToPaymentCurrency(employeeData.deductions || 0, employeeData.deductionsCurrency || 'IQD', employeeData);
                    const advance = convertToPaymentCurrency(employeeData.advance || 0, employeeData.advanceCurrency || 'IQD', employeeData);
                    const netSalary = netInPaymentCurrency + bonus + phoneBills + ceoBonus - deductions - advance;
                    
                    // استخدام calculateReservation مع الشهر والسنة لضمان حساب الحجز التراكمي
                    const reservation = calculateReservation(employeeData, netSalary, month, year);
                    employeeData.reservedAmount = reservation.actual;
                    
                    // تحديث النسبة إذا كانت 0 وتم استخدام مبلغ ثابت
                    if (employeeData.reservationPercentage === 0 && companySettings.globalReservationType === 'amount' && netSalary > 0) {
                        employeeData.reservationPercentage = (companySettings.globalReservationAmount / netSalary) * 100;
                    }
                    
                    // حساب الهدف إذا لم يكن محدداً
                    if (!employeeData.targetReservedAmount || employeeData.targetReservedAmount === 0) {
                        employeeData.targetReservedAmount = calculateTargetReservation(employeeData);
                    }
                    
                    // الحفاظ على previousReservedAmount (الرصيد السابق) - لا نستبدله إلا إذا كان undefined
                    if (employeeData.previousReservedAmount === undefined) {
                        employeeData.previousReservedAmount = 0;
                    }
                } else {
                    // إلغاء الحجز إذا كان معطلاً
                    employeeData.reservedAmount = 0;
                    // الحفاظ على previousReservedAmount (الرصيد السابق) حتى لو كان الحجز معطلاً
                    if (employeeData.previousReservedAmount === undefined) {
                        employeeData.previousReservedAmount = 0;
                    }
                }
                
                const dataToSave = {
                    ...employeeData,
                    month: month,
                    year: year, // حفظ السنة
                    updatedAt: new Date().toISOString()
                };
                
                // فقط إضافة createdAt للموظفين الجدد - لا نضيفه عند التعديل
                if (isNew) {
                    dataToSave.createdAt = new Date().toISOString();
                    // إضافة firebaseId للموظفين الجدد (سيتم استخدامه كمعرف الوثيقة)
                    dataToSave.firebaseId = employeeId;
                } else if (employeeData.createdAt) {
                    // الحفاظ على تاريخ الإنشاء الأصلي عند التعديل
                    dataToSave.createdAt = employeeData.createdAt;
                }
                
                // حفظ firebaseId قبل الحذف (يستخدم كمعرف الوثيقة في Firebase)
                const firebaseIdToUse = dataToSave.firebaseId || employeeId;
                // حذف firebaseId من البيانات المحفوظة (يستخدم كمعرف الوثيقة في Firebase)
                delete dataToSave.firebaseId;
                
                if (getStorageMode() === 'local') {
                    // الوضع المحلي - تم التعامل معه في البداية
                    return;
                }
                
                // التأكد من أن employeeId موجود قبل الحفظ (للتعديل)
                if (!isNew && !employeeId) {
                    console.error('⚠️ محاولة تحديث موظف بدون employeeId:', employeeData);
                    hideLoading();
                    showNotification('error', 'خطأ', 'لا يمكن تحديث الموظف - معرف الموظف مفقود.');
                    return;
                }
                
                // استخدام setDoc - إذا كان employeeId موجوداً، سيحدث الوثيقة
                // إذا كان جديداً، سيُنشئ وثيقة جديدة
                // استخدام firebaseIdToUse كمعرف الوثيقة
                await setDoc(doc(db, 'employees', firebaseIdToUse), dataToSave);
                
                // التحقق من أن التعديل تم بشكل صحيح (ليس إنشاء جديد)
                if (!isNew) {
                    console.log(`✅ تم تحديث الموظف ${employeeId} في ${month} ${year} - لم يتم إنشاء موظف جديد`);
                } else {
                    console.log(`✅ تم إنشاء موظف جديد ${employeeId} في ${month} ${year}`);
                }
                
                await loadEmployeesFromFirebase();
                
                // تسجيل النشاط
                const employeeName = employeeData.name || employeeData.nameAr || employeeData.employeeCode || 'Unknown';
                if (isNew) {
                    await logActivity(
                        'create',
                        'employee',
                        employeeId,
                        employeeName,
                        {},
                        `تم إضافة موظف جديد: ${employeeName} - ${t('monthNames')[month]} ${year}`
                    );
                } else {
                    const changes = getChanges(oldData, dataToSave);
                    await logActivity(
                        'update',
                        'employee',
                        employeeId,
                        employeeName,
                        changes,
                        `تم تحديث موظف: ${employeeName} - ${t('monthNames')[month]} ${year}`
                    );
                }
                
                hideLoading();
                showNotification('success', 'تم الحفظ', 'تم حفظ الموظف بنجاح! ✅');
            } catch (error) {
                console.error('Error saving employee:', error);
                hideLoading();
                showNotification('error', t('error'), t('saveEmployeeError'));
            }
        }

        async function updateEmployeeInFirebase(firebaseId, updates, options = {}) {
            const {
                skipReload = false,
                skipLoading = false,
                skipNotification = false,
                skipActivityLog = false
            } = options;
            
            try {
                console.log('🔄 تحديث بيانات الموظف في Firebase...', firebaseId);
                console.log('📝 التحديثات:', updates);
                
                if (!skipLoading) {
                showLoading();
                }
                
                // الحصول على البيانات القديمة للتتبع
                let oldData = null;
                let employeeName = 'Unknown';
                try {
                    const oldDoc = await getDoc(doc(db, 'employees', firebaseId));
                    if (oldDoc.exists()) {
                        oldData = oldDoc.data();
                        employeeName = oldData.name || oldData.nameAr || oldData.employeeCode || 'Unknown';
                    }
                } catch (e) {
                    console.warn('Could not load old data:', e);
                }
                
                await updateDoc(doc(db, 'employees', firebaseId), {
                    ...updates,
                    updatedAt: new Date().toISOString()
                });
                
                // تسجيل النشاط
                if (!skipActivityLog) {
                    try {
                const changes = oldData ? getChanges(oldData, { ...oldData, ...updates }) : {};
                await logActivity(
                    'update',
                    'employee',
                    firebaseId,
                    employeeName,
                    changes,
                    `تم تحديث موظف: ${employeeName}`
                );
                    } catch (logError) {
                        console.warn('Could not log activity:', logError);
                    }
                }
                
                console.log('✅ تم التحديث في Firebase بنجاح');
                
                // إعادة تحميل البيانات
                if (!skipReload) {
                await loadEmployeesFromFirebase();
                }
                
                if (!skipLoading) {
                hideLoading();
                }
                
                if (!skipNotification) {
                showNotification('success', 'تم التحديث', 'تم تحديث بيانات الموظف بنجاح! ✅');
                }
                
            } catch (error) {
                console.error('❌ خطأ في تحديث الموظف:', error);
                if (!skipLoading) {
                hideLoading();
                }
                if (!skipNotification) {
                showNotification('error', t('error'), t('updateEmployeeError') + ': ' + error.message);
                }
                throw error; // إعادة رمي الخطأ للتعامل معه في الدالة المستدعية
            }
        }

        async function deleteEmployeeFromFirebase(firebaseId) {
            try {
                showLoading();
                
                // الحصول على بيانات الموظف قبل الحذف للتتبع
                let employeeData = null;
                let employeeName = 'Unknown';
                try {
                    const empDoc = await getDoc(doc(db, 'employees', firebaseId));
                    if (empDoc.exists()) {
                        employeeData = empDoc.data();
                        employeeName = employeeData.name || employeeData.employeeCode || 'Unknown';
                    }
                } catch (e) {
                    console.warn('Could not load employee data before delete:', e);
                }
                
                await deleteDoc(doc(db, 'employees', firebaseId));
                await loadEmployeesFromFirebase();
                
                // تسجيل النشاط
                await logActivity(
                    'delete',
                    'employee',
                    firebaseId,
                    employeeName,
                    { deletedData: employeeData },
                    `تم حذف موظف: ${employeeName}`
                );
                
                hideLoading();
                showNotification('success', 'تم الحذف', 'تم حذف الموظف بنجاح! ✅');
            } catch (error) {
                console.error('Error deleting employee:', error);
                hideLoading();
                showNotification('error', t('error'), t('deleteEmployeeError'));
            }
        }

        async function saveProjectToFirebase(code, name) {
            try {
                showLoading();
                
                // التحقق إذا كان المشروع موجوداً (تعديل) أو جديد
                let oldData = null;
                const isNew = !projects[code];
                if (!isNew) {
                    try {
                        const oldDoc = await getDoc(doc(db, 'projects', code));
                        if (oldDoc.exists()) {
                            oldData = oldDoc.data();
                        }
                    } catch (e) {
                        console.warn('Could not load old project data:', e);
                    }
                }
                
                await setDoc(doc(db, 'projects', code), { 
                    name,
                    updatedAt: new Date().toISOString()
                });
                await loadProjectsFromFirebase();
                
                // تسجيل النشاط
                if (isNew) {
                    await logActivity(
                        'create',
                        'project',
                        code,
                        name,
                        {},
                        `تم إضافة مشروع جديد: ${name}`
                    );
                } else {
                    const changes = oldData ? getChanges(oldData, { name }) : {};
                    await logActivity(
                        'update',
                        'project',
                        code,
                        name,
                        changes,
                        `تم تحديث مشروع: ${name}`
                    );
                }
                
                hideLoading();
                showNotification('success', 'تم الحفظ', 'تم حفظ المشروع بنجاح! ✅');
            } catch (error) {
                console.error('Error saving project:', error);
                hideLoading();
                showNotification('error', t('error'), t('saveProjectError'));
            }
        }

        async function deleteProjectFromFirebase(code) {
            try {
                showLoading();
                
                // الحصول على بيانات المشروع قبل الحذف
                let projectData = null;
                let projectName = projects[code] || code;
                try {
                    const projectDoc = await getDoc(doc(db, 'projects', code));
                    if (projectDoc.exists()) {
                        projectData = projectDoc.data();
                        projectName = projectData.name || projectName;
                    }
                } catch (e) {
                    console.warn('Could not load project data before delete:', e);
                }
                
                await deleteDoc(doc(db, 'projects', code));
                await loadProjectsFromFirebase();
                
                // تسجيل النشاط
                await logActivity(
                    'delete',
                    'project',
                    code,
                    projectName,
                    { deletedData: projectData },
                    `تم حذف مشروع: ${projectName}`
                );
                
                hideLoading();
                showNotification('success', 'تم الحذف', 'تم حذف المشروع بنجاح! ✅');
            } catch (error) {
                console.error('Error deleting project:', error);
                hideLoading();
                showNotification('error', t('error'), t('deleteProjectError2'));
            }
        }

        // ========== Helper Functions ==========
        // دالة مساعدة لتحويل نوع الموظف إلى نص
        function getEmployeeTypeText(employeeType) {
            if (!employeeType) return currentLang === 'ar' ? 'غير محدد' : 'N/A';
            
            switch(employeeType) {
                case 'monthly':
                    return currentLang === 'ar' ? 'شهري' : 'Monthly';
                case 'daily':
                    return currentLang === 'ar' ? 'يومي' : 'Daily';
                case 'vehicle':
                    return currentLang === 'ar' ? 'سيارة' : 'Vehicle';
                default:
                    return employeeType;
            }
        }
        
        // دالة مساعدة للحصول على اسم الموظف
        function getEmployeeName(emp) {
            return emp.name || emp.nameAr || emp.nameEn || (currentLang === 'ar' ? 'بدون اسم' : 'No Name');
        }
        
        // التحقق من تكرار اسم الموظف في جميع المشاريع والسنوات
        function checkDuplicateEmployeeName(nameAr, nameEn, excludeFirebaseId = null, currentMonthKey = null, currentYearKey = null, excludeIndex = null) {
            // البحث في جميع السنوات والمشاريع
            for (const year of availableYears) {
                if (!employeeData[year]) continue;
                
                for (const month of months) {
                    if (!employeeData[year][month]) continue;
                    
                    const monthEmployees = employeeData[year][month];
                    
                    // السماح بنفس الاسم في شهر مختلف (لنقل الموظف بين المشاريع في أشهر مختلفة)
                    // إذا تم تحديد الشهر والسنة الحالية، نتحقق فقط من نفس الشهر
                    if (currentMonthKey !== null && currentYearKey !== null) {
                        // إذا كان الموظف في شهر مختلف، لا يعتبر تكراراً
                        if (year != currentYearKey || month != currentMonthKey) {
                            continue; // شهر مختلف - السماح بنفس الاسم
                        }
                        // نفس الشهر - نستمر في التحقق من التكرار
                    }
                    
                    // استثناء الموظف الحالي عند التعديل (باستخدام الفهرس أو firebaseId)
                    const isCurrentMonth = (currentMonthKey !== null && currentYearKey !== null) && 
                                          (year == currentYearKey && month == currentMonthKey);
                    
                    for (let i = 0; i < monthEmployees.length; i++) {
                        const emp = monthEmployees[i];
                        
                        // تخطي الموظف الحالي عند التعديل
                        if (isCurrentMonth && excludeIndex !== null && i === excludeIndex) {
                            continue; // هذا هو الموظف الحالي - تخطيه
                        }
                        
                        // تخطي الموظف الحالي باستخدام firebaseId (كحل بديل)
                        if (excludeFirebaseId && emp.firebaseId && emp.firebaseId === excludeFirebaseId) {
                            continue;
                        }
                        
                        // التحقق من تطابق الاسم العربي (يجب أن يكون في نفس المشروع)
                        if (nameAr && nameAr.trim() !== '' && emp.nameAr && emp.nameAr.trim() !== '') {
                            if (emp.nameAr.trim().toLowerCase() === nameAr.trim().toLowerCase()) {
                                // فقط في نفس الشهر والسنة - نتحقق من المشروع أيضاً
                                if (isCurrentMonth) {
                                    // في نفس الشهر، نتحقق من المشروع أيضاً
                                    // لكن هنا نرجع النتيجة لأنه قد يكون نفس الاسم في مشروع مختلف
                                    return {
                                        duplicate: true,
                                        existingEmployee: emp,
                                        message: currentLang === 'ar' 
                                            ? `اسم الموظف "${nameAr}" موجود بالفعل في المشروع "${projects[emp.project] || emp.project}" في نفس الشهر`
                                            : `Employee name "${nameAr}" already exists in project "${projects[emp.project] || emp.project}" in the same month`
                                    };
                                }
                            }
                        }
                        
                        // التحقق من تطابق الاسم الإنجليزي
                        if (nameEn && nameEn.trim() !== '' && emp.nameEn && emp.nameEn.trim() !== '') {
                            if (emp.nameEn.trim().toLowerCase() === nameEn.trim().toLowerCase()) {
                                if (isCurrentMonth) {
                                    return {
                                        duplicate: true,
                                        existingEmployee: emp,
                                        message: currentLang === 'ar' 
                                            ? `اسم الموظف "${nameEn}" موجود بالفعل في المشروع "${projects[emp.project] || emp.project}" في نفس الشهر`
                                            : `Employee name "${nameEn}" already exists in project "${projects[emp.project] || emp.project}" in the same month`
                                    };
                                }
                            }
                        }
                    }
                }
            }
            
            return { duplicate: false };
        }
        
        // دالة مساعدة لعرض حالة الدوام بشكل موحد
        function renderAttendanceCell(emp, index, fontSize = '11px', monthKey = null, year = null) {
            const targetMonth = monthKey || emp?.month || currentMonth;
            const targetYear = year || emp?.year || currentYear;
            const attendance = emp.attendance || {};
            const attendanceDays = Object.values(attendance);
            const fullDays = attendanceDays.filter(d => d.type === 'full').length;
            const halfDays = attendanceDays.filter(d => d.type === 'half').length;
            const paidLeave = attendanceDays.filter(d => d.type === 'paid-leave').length;
            const absent = attendanceDays.filter(d => d.type === 'absent').length;
            const totalDays = fullDays + (halfDays * 0.5) + paidLeave;
            const hasAttendance = attendanceDays.length > 0;
            
            return `<td style="text-align: center; font-size: ${fontSize}; cursor: pointer;" onclick="openAttendanceModal(${index}, '${targetMonth}', ${targetYear})" title="اضغط لتعديل الدوام">
                ${hasAttendance ? `
                    <div style="background: #d1fae5; padding: 6px; border-radius: 6px; margin-bottom: 2px;">
                        <strong style="color: #065f46; font-size: calc(${fontSize} + 1px);">${totalDays.toFixed(1)}</strong> يوم
                    </div>
                    <div style="font-size: calc(${fontSize} - 1px); color: var(--gray);">
                        ${fullDays > 0 ? `✓${fullDays}` : ''}
                        ${halfDays > 0 ? ` ⊕${halfDays}` : ''}
                        ${paidLeave > 0 ? ` 💚${paidLeave}` : ''}
                        ${absent > 0 ? ` ✗${absent}` : ''}
                    </div>
                ` : `<span style="color: var(--gray);">-- اضغط لإدخال --</span>`}
            </td>`;
        }
        
        // دالة مساعدة لإنشاء قائمة اختيار العملة
        function createCurrencySelect(value, fieldName, index, isLocked = false, onchangeHandler = 'updateField') {
            const disabled = isLocked ? 'disabled class="locked-field"' : '';
            return `<select ${disabled} onchange="${onchangeHandler}(${index}, '${fieldName}', this.value)" style="width: 100%;">
                <option value="USD" ${(value || 'IQD') === 'USD' ? 'selected' : ''}>$</option>
                <option value="IQD" ${(value || 'IQD') === 'IQD' ? 'selected' : ''}>IQD</option>
            </select>`;
        }

        // ========== Calculation Functions ==========
        function calculateDailySalary(emp, monthKey = null, year = null) {
            // للموظف اليومي: الراتب هو أجر اليوم مباشرة
            if (emp.employeeType === 'daily') {
                let dailyWageUSD = emp.salary;
                const exchangeRate = parseFloat(emp.exchangeRate) || 1;
                if (emp.salaryCurrency === 'IQD') dailyWageUSD = emp.salary / exchangeRate;
                return dailyWageUSD;
            }
            
            // للموظف الشهري والسيارة: حساب الراتب اليومي من الراتب الشهري
            let baseSalaryUSD = emp.salary;
            const exchangeRate = parseFloat(emp.exchangeRate) || 1;
            if (emp.salaryCurrency === 'IQD') baseSalaryUSD = emp.salary / exchangeRate;
            let salaryIncreaseUSD = emp.salaryIncrease || 0;
            if (emp.salaryIncreaseCurrency === 'IQD') salaryIncreaseUSD = salaryIncreaseUSD / exchangeRate;
            
            // استخدام طريقة احتساب الشهر (30 دائماً أو حسب أيام الشهر)
            const effectiveMonth = monthKey || emp.month || currentMonth;
            const effectiveYear = year || emp.year || currentYear;
            const divisor = emp.monthCalculationMethod === 'actual' ? getActualDaysInMonth(effectiveYear, effectiveMonth) : 30;
            return (baseSalaryUSD + salaryIncreaseUSD) / divisor;
        }
        
        // الحصول على عدد الأيام الفعلية في الشهر المحدد
        function getActualDaysInMonth(year = currentYear, monthKey = currentMonth) {
            const effectiveMonth = monthKey || currentMonth;
            const effectiveYear = year || currentYear;
            const monthIndex = months.indexOf(effectiveMonth);
            if (monthIndex === -1) return 30;
            return new Date(effectiveYear, monthIndex + 1, 0).getDate();
        }

        function calculateActualSalary(emp, monthKey = null, year = null) {
            // للموظف اليومي: أجر اليوم × أيام العمل الفعلية
            if (emp.employeeType === 'daily') {
                const dailyWage = calculateDailySalary(emp, monthKey, year);
                const workDays = calculateWorkDaysFromAttendance(emp);
                return dailyWage * workDays;
            }
            
            // للموظف الشهري والسيارة: الاعتماد على بيانات الدوام
            const workDaysFromAttendance = calculateWorkDaysFromAttendance(emp);
            return calculateDailySalary(emp, monthKey, year) * workDaysFromAttendance;
        }
        
        // حساب أيام العمل من بيانات الدوام (مع احتساب الأوفر تايم)
        function calculateWorkDaysFromAttendance(emp) {
            const attendance = emp.attendance || {};
            const attendanceDays = Object.values(attendance);
            const attendanceSystem = emp.attendanceSystem || 'hours';
            
            // للراتب الثابت: دائماً 30 يوم (بغض النظر عن الدوام)
            if (attendanceSystem === 'fixed') {
                return 30;
            }
            
                // إذا لم يُدخل الدوام
            if (attendanceDays.length === 0) {
                // نظام بالساعات: يجب إدخال الدوام
                if (attendanceSystem === 'hours') {
                    return 0; // ✅ لا راتب بدون دوام للنظام بالساعات
                }
                
                // للتوافق مع النظام القديم (إذا لم يُحدد نظام الاحتساب)
                if (emp.employeeType === 'daily') return 0; // لا راتب بدون دوام
                if (emp.employeeType === 'vehicle') return emp.workDays || 0;
                // تعديل: إرجاع 0 بدلاً من 30 للموظفين الشهريين بدون دوام
                if (emp.employeeType === 'monthly') return 0; // لا دوام بدون بيانات دوام فعلية
            }
            
            let totalDays = 0;
            const dailyWorkHours = emp.dailyWorkHours || 8;
            const overtimeMultiplier = emp.overtimeMultiplier || 1.5;
            
            Object.values(attendanceDays).forEach(dayData => {
                if (dayData.type === 'full') {
                    totalDays += 1;
                } else if (dayData.type === 'half') {
                    totalDays += 0.5;
                } else if (dayData.type === 'paid-leave') {
                    // للموظف اليومي: لا إجازة مدفوعة
                    if (emp.employeeType !== 'daily') {
                        totalDays += 1;
                    }
                } else if (dayData.type === 'custom-hours') {
                    // حساب الساعات من الفترات المتقطعة
                    let dayTotalHours = 0;
                    
                    if (dayData.periods && dayData.periods.length > 0) {
                        // فترات متقطعة
                        dayData.periods.forEach(period => {
                            if (period.startTime && period.endTime) {
                                const start = new Date(`2000-01-01T${period.startTime}`);
                                const end = new Date(`2000-01-01T${period.endTime}`);
                                const hours = (end - start) / (1000 * 60 * 60);
                                dayTotalHours += Math.max(0, hours);
                            }
                        });
                    } else if (dayData.startTime && dayData.endTime) {
                        // للتوافق الخلفي: فترة واحدة
                        const start = new Date(`2000-01-01T${dayData.startTime}`);
                        const end = new Date(`2000-01-01T${dayData.endTime}`);
                        dayTotalHours = Math.max(0, (end - start) / (1000 * 60 * 60));
                    }
                    
                    // التحقق من الخيارات الجديدة
                    const countAsLeave = dayData.countAsLeave !== false; // افتراضياً true
                    const countOvertime = dayData.countOvertime !== false; // افتراضياً true
                    
                    // تحويل الساعات إلى أيام مع احتساب الأوفر تايم
                    if (dayTotalHours < dailyWorkHours) {
                        // حالة النقص
                        if (countAsLeave) {
                            // احتساب كإجازة زمنية - يوم كامل
                            totalDays += 1;
                        } else {
                            // احتساب الساعات الفعلية فقط
                            totalDays += dayTotalHours / dailyWorkHours;
                        }
                    } else if (dayTotalHours > dailyWorkHours) {
                        // حالة الزيادة
                        const regularDays = 1; // يوم كامل
                        if (countOvertime) {
                            // احتساب الزيادة كأوفر تايم
                        const overtimeHours = dayTotalHours - dailyWorkHours;
                        const overtimeDays = (overtimeHours * overtimeMultiplier) / dailyWorkHours;
                        totalDays += regularDays + overtimeDays;
                    } else {
                            // عدم احتساب الأوفر تايم
                            totalDays += regularDays;
                        }
                    } else {
                        // الساعات مطابقة تماماً
                        totalDays += 1;
                    }
                }
            });
            
            return totalDays;
        }

        function convertToPaymentCurrency(value, fromCurrency, emp) {
            if (!value || value === 0) return 0;
            if (fromCurrency === emp.paymentCurrency) return value;
            const exchangeRate = parseFloat(emp.exchangeRate) || 1;
            if (fromCurrency === 'USD' && emp.paymentCurrency === 'IQD') return value * exchangeRate;
            if (fromCurrency === 'IQD' && emp.paymentCurrency === 'USD') return value / exchangeRate;
            return value;
        }

        function calculateNetSalary(emp, monthKey = null, year = null) {
            let actualSalaryUSD = calculateActualSalary(emp, monthKey, year);
            let actualSalaryInPayment = convertToPaymentCurrency(actualSalaryUSD, 'USD', emp);
            const bonus = convertToPaymentCurrency(emp.bonus || 0, emp.bonusCurrency || 'IQD', emp);
            const phoneBills = convertToPaymentCurrency(emp.phoneBills || 0, emp.phoneBillsCurrency || 'IQD', emp);
            const deductions = convertToPaymentCurrency(emp.deductions || 0, emp.deductionsCurrency || 'IQD', emp);
            const advance = convertToPaymentCurrency(emp.advance || 0, emp.advanceCurrency || 'IQD', emp);
            const ceoBonus = convertToPaymentCurrency(emp.ceoBonus || 0, emp.ceoBonusCurrency || 'IQD', emp);
            const netBeforeReservation = actualSalaryInPayment + bonus + phoneBills + ceoBonus - deductions - advance;
            
            // خصم مبلغ الحجز إذا كان مفعلاً (محلياً أو عاماً)
            const isReservationEnabled = emp.salaryReservationEnabled !== undefined ? 
                emp.salaryReservationEnabled : 
                (companySettings.globalReservationEnabled || false);
            
            if (isReservationEnabled) {
                const reservation = calculateReservation(emp, netBeforeReservation, monthKey, year);
                return netBeforeReservation - reservation.actual;
            }
            
            return netBeforeReservation;
        }
        
        // دالة حساب الحجز
        function calculateReservation(emp, netSalary, monthKey = null, yearKey = null) {
            // التحقق من تفعيل الحجز (إما محلياً أو عاماً)
            const isReservationEnabled = emp.salaryReservationEnabled !== undefined ? 
                emp.salaryReservationEnabled : 
                (companySettings.globalReservationEnabled || false);
            
            if (!isReservationEnabled) {
                return {
                    requested: 0,
                    actual: 0,
                    available: netSalary,
                    shortage: 0,
                    isShortage: false,
                    percentage: 0,
                    previousReserved: 0,
                    accumulated: 0,
                    total: 0,
                    target: 0
                };
            }
            
            // استخدام النسبة المحلية أو العامة
            let percentage = parseFloat(emp.reservationPercentage) || 0;
            if (percentage === 0 && companySettings.globalReservationEnabled) {
                if (companySettings.globalReservationType === 'percentage') {
                    percentage = companySettings.globalReservationPercentage || 10;
                } else if (companySettings.globalReservationType === 'amount' && netSalary > 0) {
                    // إذا كان المبلغ ثابت، نحسب النسبة من الراتب الصافي
                    percentage = (companySettings.globalReservationAmount / netSalary) * 100;
                }
            }
            const requestedAmount = netSalary * (percentage / 100);
            const availableAmount = netSalary;
            
            // حساب الحجز التراكمي
            // الرصيد السابق (من أشهر غير موجودة في قاعدة البيانات)
            const previousReserved = parseFloat(emp.previousReservedAmount) || 0;
            
            // المبلغ المحجوز من قاعدة البيانات (من الأشهر السابقة)
            // استخدام دالة calculateAccumulatedReservation الموحدة لضمان الاتساق
            let accumulatedReservation = 0;
            if (monthKey && yearKey && emp.firebaseId) {
                accumulatedReservation = calculateAccumulatedReservation(emp, monthKey, yearKey);
            }
            
            // الإجمالي = الرصيد السابق + المبلغ المحجوز من قاعدة البيانات
            const totalAccumulatedReservation = previousReserved + accumulatedReservation;
            
            // حساب الهدف (الراتب الأساسي)
            const target = parseFloat(emp.targetReservedAmount) || calculateTargetReservation(emp);
            
            // الحجز الفعلي = الحد الأدنى بين:
            // 1. المبلغ المطلوب (نسبة من الراتب الصافي)
            // 2. الراتب الصافي المتاح
            // 3. الفرق بين الهدف والمحجوز سابقاً (الرصيد السابق + المحجوز من قاعدة البيانات) (لضمان عدم تجاوز الراتب الأساسي)
            const remainingToTarget = Math.max(0, target - totalAccumulatedReservation);
            const maxAllowedReservation = Math.min(availableAmount, remainingToTarget);
            const actualReservation = Math.min(requestedAmount, maxAllowedReservation);
            const shortage = requestedAmount - actualReservation;
            
            return {
                requested: requestedAmount,
                actual: actualReservation,
                available: availableAmount,
                shortage: shortage,
                isShortage: shortage > 0,
                percentage: percentage,
                previousReserved: previousReserved, // الرصيد السابق
                accumulated: accumulatedReservation, // المحجوز من قاعدة البيانات
                total: totalAccumulatedReservation + actualReservation, // الإجمالي (رصيد سابق + محجوز من قاعدة البيانات + حالي)
                target: target
            };
        }
        
        // دالة حساب المبلغ الإجمالي المحجوز (سابقاً + الحالي)
        function getTotalReservedAmount(emp, monthKey = null, yearKey = null) {
            // الرصيد السابق (من أشهر غير موجودة في قاعدة البيانات)
            const previousReserved = parseFloat(emp.previousReservedAmount) || 0;
            
            // إذا تم تحديد الشهر والسنة، استخدم الحجز التراكمي من قاعدة البيانات
            let accumulated = 0;
            if (monthKey && yearKey) {
                accumulated = calculateAccumulatedReservation(emp, monthKey, yearKey);
            }
            
            const current = parseFloat(emp.reservedAmount) || 0;
            
            // الإجمالي = الرصيد السابق + المحجوز من قاعدة البيانات + الحالي
            return previousReserved + accumulated + current;
        }
        
        // دالة حساب الحجز التراكمي من جميع الأشهر السابقة
        // المبدأ: الحجز التراكمي يبدأ من أول شهر تم تفعيل الحجز فيه (salaryReservationEnabled = true)
        // وليس من أول شهر تم إضافة الموظف فيه
        // أي: إذا كان الموظف موجوداً في يناير لكن الحجز لم يُفعّل إلا في مارس،
        // فسيبدأ الحجز التراكمي من مارس فقط
        function calculateAccumulatedReservation(emp, currentMonthKey, currentYearKey) {
            if (!emp || !emp.firebaseId) {
                console.log(`⚠️ لا يوجد firebaseId للموظف`);
                return 0;
            }
            
            const months = ['january', 'february', 'march', 'april', 'may', 'june', 
                          'july', 'august', 'september', 'october', 'november', 'december'];
            
            let totalReserved = 0;
            const currentMonthIndex = months.indexOf(currentMonthKey);
            const currentYearInt = parseInt(currentYearKey);
            const processedEntries = new Set(); // لتجنب حساب نفس السجل مرتين
            
            console.log(`🔍 البحث عن الحجز التراكمي للموظف ${emp.nameAr || emp.employeeCode} (${emp.firebaseId})`);
            console.log(`📅 الشهر الحالي: ${currentMonthKey} ${currentYearKey}`);
            console.log(`📦 السنوات المتاحة في البيانات:`, Object.keys(employeeData));
            console.log(`⚙️ الإعدادات العامة للحجز:`, {
                enabled: companySettings.globalReservationEnabled,
                type: companySettings.globalReservationType,
                percentage: companySettings.globalReservationPercentage,
                amount: companySettings.globalReservationAmount
            });
            
            // البحث في جميع السنوات والأشهر السابقة
            for (const year of Object.keys(employeeData).sort((a, b) => parseInt(a) - parseInt(b))) {
                const yearData = employeeData[year];
                if (!yearData) continue;
                
                const yearInt = parseInt(year);
                
                for (let i = 0; i < months.length; i++) {
                    const month = months[i];
                    const monthData = yearData[month];
                    if (!monthData || monthData.length === 0) continue;
                    
                    // تخطي الشهر الحالي والأشهر اللاحقة
                    if (yearInt > currentYearInt || 
                        (yearInt === currentYearInt && i >= currentMonthIndex)) {
                        continue;
                    }
                    
                    console.log(`  📆 فحص ${month} ${year} (${monthData.length} موظف)`);
                    
                    // البحث عن الموظف في هذا الشهر
                    const empInMonth = monthData.find(e => e.firebaseId === emp.firebaseId);
                    if (empInMonth) {
                        // استخدام firebaseId + month + year كمعرف فريد لتجنب التكرار
                        const entryKey = `${empInMonth.firebaseId}_${month}_${year}`;
                        
                        // تخطي إذا تم معالجته مسبقاً (في حالة وجود نفس الموظف في نفس الشهر/السنة)
                        if (processedEntries.has(entryKey)) {
                            continue;
                        }
                        processedEntries.add(entryKey);
                        
                        // التحقق من أن الحجز مفعّل وأن هناك مبلغ محجوز
                        // ملاحظة: الحجز التراكمي يبدأ من أول شهر تم تفعيل الحجز فيه، وليس من أول شهر تم إضافة الموظف فيه
                        const localEnabled = empInMonth.salaryReservationEnabled;
                        const globalEnabled = companySettings.globalReservationEnabled || false;
                        const isReservationEnabled = localEnabled !== undefined ? localEnabled : globalEnabled;
                        
                        const reserved = parseFloat(empInMonth.reservedAmount) || 0;
                        
                        console.log(`    👤 الموظف موجود في ${month} ${year}:`, {
                            localEnabled: localEnabled,
                            globalEnabled: globalEnabled,
                            isReservationEnabled: isReservationEnabled,
                            reservedAmount: reserved,
                            reservationPercentage: empInMonth.reservationPercentage,
                            firebaseId: empInMonth.firebaseId
                        });
                        
                        // الحل العملي: إذا كان هناك مبلغ محجوز (reservedAmount > 0)، نعتبره حجز صالح
                        // حتى لو كان الحجز غير مفعّل في ذلك الشهر (لأنه قد يكون تم إلغاء التفعيل لاحقاً)
                        // هذا يضمن أننا نحسب جميع الحجوزات الفعلية بغض النظر عن حالة التفعيل
                        if (reserved > 0) {
                            totalReserved += reserved;
                            console.log(`      ✅ حجز: ${reserved.toFixed(2)}, الإجمالي: ${totalReserved.toFixed(2)}`);
                            if (!isReservationEnabled) {
                                console.log(`      ℹ️ ملاحظة: الحجز غير مفعّل لكن يوجد مبلغ محجوز (تم إضافته)`);
                            }
                        } else if (isReservationEnabled) {
                            console.log(`      ⚠️ الحجز مفعّل لكن المبلغ = 0 (قد يكون تم تصفيره)`);
                        } else {
                            console.log(`      ⏭️ تخطي - لا يوجد حجز (المبلغ = 0 والحجز غير مفعّل)`);
                        }
                    } else {
                        console.log(`    ❌ الموظف غير موجود في ${month} ${year}`);
                    }
                }
            }
            
            // إذا لم نجد أي حجز، قد تكون البيانات القديمة لا تحتوي على month/year بشكل صحيح
            // أو قد تكون جميع البيانات في نفس الشهر/السنة
            if (totalReserved === 0) {
                console.log(`⚠️ لم يتم العثور على حجز في البيانات المنظمة، البحث في جميع البيانات...`);
                console.log(`  🔍 البحث عن الموظف ${emp.nameAr || emp.employeeCode} (${emp.firebaseId}) في جميع الأشهر...`);
                
                let foundInMonths = [];
                
                for (const year of Object.keys(employeeData)) {
                    const yearData = employeeData[year];
                    if (!yearData) continue;
                    
                    for (const month of months) {
                        const monthData = yearData[month];
                        if (!monthData) continue;
                        
                        // تخطي الشهر الحالي
                        const yearInt = parseInt(year);
                        const monthIndex = months.indexOf(month);
                        if (yearInt > currentYearInt || 
                            (yearInt === currentYearInt && monthIndex >= currentMonthIndex)) {
                            continue;
                        }
                        
                        // البحث عن الموظف في هذا الشهر (باستخدام firebaseId أو nameAr + nameEn كبديل للبيانات القديمة)
                        let foundEmp = monthData.find(e => e.firebaseId === emp.firebaseId);
                        
                        // إذا لم نجد بـ firebaseId، نبحث بالاسم (للبيانات القديمة)
                        if (!foundEmp && emp.nameAr && emp.nameEn) {
                            foundEmp = monthData.find(e => 
                                (e.nameAr && e.nameAr.trim().toLowerCase() === emp.nameAr.trim().toLowerCase()) &&
                                (e.nameEn && e.nameEn.trim().toLowerCase() === emp.nameEn.trim().toLowerCase())
                            );
                        }
                        
                        if (foundEmp) {
                            const entryKey = `${foundEmp.firebaseId || 'no-id'}_${month}_${year}`;
                            
                            // تخطي إذا تم معالجته مسبقاً
                            if (processedEntries.has(entryKey)) {
                                continue;
                            }
                            
                            foundInMonths.push({ month, year, emp: foundEmp });
                            
                            const localEnabled = foundEmp.salaryReservationEnabled;
                            const globalEnabled = companySettings.globalReservationEnabled || false;
                            const isReservationEnabled = localEnabled !== undefined ? localEnabled : globalEnabled;
                            
                            const reserved = parseFloat(foundEmp.reservedAmount) || 0;
                            
                            console.log(`    📍 وجد في ${month} ${year}:`, {
                                localEnabled: localEnabled,
                                globalEnabled: globalEnabled,
                                isReservationEnabled: isReservationEnabled,
                                reservedAmount: reserved,
                                reservationPercentage: foundEmp.reservationPercentage,
                                foundBy: foundEmp.firebaseId === emp.firebaseId ? 'firebaseId' : 'name'
                            });
                            
                            // الحل العملي: إذا كان هناك مبلغ محجوز، نعتبره حجز صالح
                            if (reserved > 0) {
                                totalReserved += reserved;
                                processedEntries.add(entryKey);
                                console.log(`      ✅ حجز: ${reserved.toFixed(2)}, الإجمالي: ${totalReserved.toFixed(2)}`);
                                if (!isReservationEnabled) {
                                    console.log(`      ℹ️ ملاحظة: الحجز غير مفعّل لكن يوجد مبلغ محجوز (تم إضافته)`);
                                }
                            } else if (isReservationEnabled) {
                                console.log(`      ⚠️ الحجز مفعّل لكن المبلغ = 0`);
                            } else {
                                console.log(`      ⏭️ لا يوجد حجز (المبلغ = 0 والحجز غير مفعّل)`);
                            }
                        }
                    }
                }
                
                if (foundInMonths.length > 0) {
                    console.log(`  📊 الموظف موجود في ${foundInMonths.length} شهر/سنة:`, foundInMonths.map(m => `${m.month} ${m.year}`).join(', '));
                } else {
                    console.log(`  ❌ الموظف غير موجود في أي شهر سابق`);
                }
            }
            
            console.log(`✅ الحجز التراكمي الإجمالي للموظف ${emp.nameAr || emp.employeeCode}: ${totalReserved.toFixed(2)}`);
            console.log(`📊 ملخص الحساب:`, {
                firebaseId: emp.firebaseId,
                name: emp.nameAr || emp.employeeCode,
                currentMonth: currentMonthKey,
                currentYear: currentYearKey,
                totalReserved: totalReserved.toFixed(2),
                processedEntries: processedEntries.size,
                globalReservationEnabled: companySettings.globalReservationEnabled
            });
            return totalReserved;
        }
        
        // دالة حساب الهدف (راتب أساسي واحد)
        function calculateTargetReservation(emp) {
            const basicSalary = parseFloat(emp.salary) || 0;
            const salaryCurrency = emp.salaryCurrency || 'IQD';
            const paymentCurrency = emp.paymentCurrency || 'IQD';
            const exchangeRate = parseFloat(emp.exchangeRate) || 1420;
            
            // تحويل الراتب الأساسي إلى عملة الدفع
            let targetAmount = basicSalary;
            if (salaryCurrency !== paymentCurrency) {
                if (salaryCurrency === 'USD' && paymentCurrency === 'IQD') {
                    targetAmount = basicSalary * exchangeRate;
                } else if (salaryCurrency === 'IQD' && paymentCurrency === 'USD') {
                    targetAmount = basicSalary / exchangeRate;
                }
            }
            
            return targetAmount;
        }
        
        // دالة حساب تقدم الحجز
        function getReservationProgress(emp, monthKey = null, yearKey = null) {
            const totalReserved = getTotalReservedAmount(emp, monthKey, yearKey);
            const target = parseFloat(emp.targetReservedAmount) || calculateTargetReservation(emp);
            const progress = target > 0 ? (totalReserved / target) * 100 : 0;
            
            return {
                totalReserved: totalReserved,
                target: target,
                progress: Math.min(progress, 100),
                remaining: Math.max(0, target - totalReserved),
                isCompleted: totalReserved >= target
            };
        }
// ========== View Functions ==========
        // كلمة المرور للوصول إلى الإعدادات والمستخدمين
        const PROTECTED_TABS_PASSWORD = 'Am9875321';
        let pendingTab = null; // التبويب المعلق في انتظار كلمة المرور
        
        function showTab(tab) {
            // التحقق من كلمة المرور للتبويبات المحمية
            if (tab === 'settings' || tab === 'users') {
                // التحقق من وجود كلمة مرور محفوظة في الجلسة
                const isAuthorized = sessionStorage.getItem(`tab_${tab}_authorized`) === 'true';
                
                if (!isAuthorized) {
                    // حفظ التبويب المطلوب وفتح نافذة كلمة المرور
                    pendingTab = tab;
                    openPasswordModal(tab);
                    return;
                }
            }
            
            // إذا كانت كلمة المرور صحيحة أو التبويب غير محمي، المتابعة بشكل طبيعي
            currentView = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const tabButtons = document.querySelectorAll('.tab-btn');
            if (tab === 'dashboard' && tabButtons[0]) tabButtons[0].classList.add('active');
            else if (tab === 'users' && tabButtons[1]) tabButtons[1].classList.add('active');
            else if (tab === 'years' && tabButtons[2]) tabButtons[2].classList.add('active');
            else if (tab === 'settings' && tabButtons[3]) tabButtons[3].classList.add('active');
            else if (tab === 'bulkEdit') {
                // البحث عن زر التعديل المتعدد
                const bulkEditBtn = Array.from(tabButtons).find(btn => btn.textContent.includes('تعديل متعدد') || btn.textContent.includes('Bulk Edit'));
                if (bulkEditBtn) bulkEditBtn.classList.add('active');
            }
            renderContent();
        }
        
        function openPasswordModal(tab) {
            const modal = document.getElementById('passwordModal');
            const passwordInput = document.getElementById('passwordInput');
            const passwordError = document.getElementById('passwordError');
            
            if (modal && passwordInput) {
                // تحديث النص حسب التبويب
                const tabName = tab === 'settings' 
                    ? (currentLang === 'ar' ? 'الإعدادات' : 'Settings')
                    : (currentLang === 'ar' ? 'المستخدمين' : 'Users');
                
                // تحديث جميع النصوص
                const headerText = modal.querySelector('#passwordModalTitle');
                const descText = modal.querySelector('#passwordModalDesc');
                const labelText = modal.querySelector('#passwordLabel');
                const buttonText = modal.querySelector('.modal-actions button');
                
                if (headerText) {
                    headerText.textContent = `🔒 ${currentLang === 'ar' ? 'حماية' : 'Protection'}`;
                }
                
                if (descText) {
                    descText.textContent = currentLang === 'ar' 
                        ? `يرجى إدخال كلمة المرور للوصول إلى ${tabName}`
                        : `Please enter password to access ${tabName}`;
                }
                
                if (labelText) {
                    labelText.textContent = currentLang === 'ar' ? '🔑 كلمة المرور:' : '🔑 Password:';
                }
                
                if (passwordInput) {
                    passwordInput.placeholder = currentLang === 'ar' ? 'أدخل كلمة المرور' : 'Enter password';
                }
                
                if (passwordError) {
                    passwordError.textContent = currentLang === 'ar' ? '❌ كلمة المرور غير صحيحة' : '❌ Incorrect password';
                    passwordError.style.display = 'none';
                }
                
                if (buttonText) {
                    buttonText.textContent = currentLang === 'ar' ? '✅ تأكيد' : '✅ Confirm';
                }
                
                // إعادة تعيين الحقول
                passwordInput.value = '';
                
                // فتح النافذة (استخدام نفس طريقة النوافذ الأخرى)
                modal.classList.add('active');
                setTimeout(() => passwordInput.focus(), 100);
            }
        }
        
        function checkPassword() {
            const passwordInput = document.getElementById('passwordInput');
            const passwordError = document.getElementById('passwordError');
            
            if (!passwordInput) return;
            
            const enteredPassword = passwordInput.value;
            
            if (enteredPassword === PROTECTED_TABS_PASSWORD) {
                // كلمة المرور صحيحة - حفظ التخويل في الجلسة
                if (pendingTab) {
                    sessionStorage.setItem(`tab_${pendingTab}_authorized`, 'true');
                }
                
                // إغلاق النافذة
                closeModal('passwordModal');
                
                // فتح التبويب المطلوب
                if (pendingTab) {
                    const tab = pendingTab;
                    pendingTab = null;
                    showTab(tab);
                }
            } else {
                // كلمة المرور خاطئة
                if (passwordError) {
                    passwordError.style.display = 'block';
                }
                passwordInput.value = '';
                passwordInput.focus();
                
                // إضافة تأثير اهتزاز
                passwordInput.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    passwordInput.style.animation = '';
                }, 500);
            }
        }
        
        // إضافة تأثير الاهتزاز في CSS
        if (!document.getElementById('passwordShakeStyle')) {
            const style = document.createElement('style');
            style.id = 'passwordShakeStyle';
            style.textContent = `
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
                    20%, 40%, 60%, 80% { transform: translateX(10px); }
                }
            `;
            document.head.appendChild(style);
        }

        function selectMonth(month) {
            currentMonth = month;
            currentView = 'month';
            monthFilterSearch = '';
            monthFilterProject = 'all';
            monthFilterType = 'all';
            selectedEmployees.clear();
            // لا يحفظ تلقائياً
            renderContent();
        }

        function selectYear(year) {
            currentYear = parseInt(year);
            selectedEmployees.clear();
            
            // التأكد من وجود السنة في البيانات
            if (!employeeData[currentYear]) {
                initializeEmployeeData();
            }
            
            // لا يحفظ تلقائياً
            renderContent();
            updateYearSelector();
            console.log(`📅 تم التبديل إلى السنة: ${currentYear}`);
        }

        function changeYear(direction) {
            const currentIndex = availableYears.indexOf(currentYear);
            const newIndex = currentIndex + direction;
            
            if (newIndex >= 0 && newIndex < availableYears.length) {
                selectYear(availableYears[newIndex]);
            }
        }

        function updateYearSelector() {
            const yearSelector = document.getElementById('yearSelector');
            if (yearSelector) {
                yearSelector.value = currentYear;
            }
        }

        function populateYearSelector() {
            const yearSelector = document.getElementById('yearSelector');
            if (yearSelector) {
                yearSelector.innerHTML = '';
                availableYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = `📅 ${year}`;
                    option.selected = year === currentYear;
                    yearSelector.appendChild(option);
                });
                console.log('✅ Year selector populated with', availableYears.length, 'years');
            }
        }

        function selectProject(projectCode) {
            // بدلاً من الانتقال مباشرةً إلى أغسطس، نعرض نافذة لاختيار السنة والشهر
            showProjectMonthYearModal(projectCode);
        }

        function showProjectMonthYearModal(projectCode) {
            try {
                currentProject = projectCode;
                // تهيئة القوائم
                const yearSelect = document.getElementById('projectPickerYear');
                const monthSelect = document.getElementById('projectPickerMonth');
                if (!yearSelect || !monthSelect) {
                    console.warn('projectPicker modal not found');
                    currentView = 'project';
                    selectedProjectMonth = currentMonth;
                    renderContent();
                    return;
                }
                // تعبئة السنوات المتاحة
                yearSelect.innerHTML = '';
                availableYears.forEach(y => {
                    const opt = document.createElement('option');
                    opt.value = y;
                    opt.textContent = `📅 ${y}`;
                    if (y === currentYear) opt.selected = true;
                    yearSelect.appendChild(opt);
                });
                // تعبئة الأشهر
                monthSelect.innerHTML = '';
                months.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    const count = (employeeData[currentYear] && employeeData[currentYear][m])
                        ? employeeData[currentYear][m].filter(emp => emp.project === projectCode).length : 0;
                    opt.textContent = `${t('monthNames')[m]}${count ? ` (${count})` : ''}`;
                    if (m === currentMonth) opt.selected = true;
                    monthSelect.appendChild(opt);
                });
                openModal('projectPickerModal');
            } catch (e) {
                console.error('showProjectMonthYearModal error', e);
                currentView = 'project';
                selectedProjectMonth = currentMonth;
                renderContent();
            }
        }

        function confirmProjectMonthYear(ev) {
            try { if (ev && ev.preventDefault) ev.preventDefault(); } catch (e) {}
            const yearSelect = document.getElementById('projectPickerYear');
            const monthSelect = document.getElementById('projectPickerMonth');
            const year = parseInt(yearSelect?.value || currentYear);
            const month = monthSelect?.value || currentMonth;
            currentYear = isNaN(year) ? currentYear : year;
            selectedProjectMonth = month;
            currentMonth = month;
            currentView = 'project';
            closeModal('projectPickerModal');
            updateYearSelector();
            renderContent();
        }

        // التأكد من توفر الدوال على الكائن window للاستخدام من الـ HTML
        window.showProjectMonthYearModal = showProjectMonthYearModal;
        window.confirmProjectMonthYear = confirmProjectMonthYear;

        function renderContent() {
            const content = document.getElementById('mainContent');
            if (currentView === 'dashboard') {
                setHTML(content, renderDashboard());
            } else if (currentView === 'month') {
                setHTML(content, renderMonthView());
            } else if (currentView === 'project') {
                setHTML(content, renderProjectView());
            } else if (currentView === 'users') {
                renderUsersView();
            } else if (currentView === 'years') {
                renderYearsView();
            } else if (currentView === 'settings') {
                renderSettingsView();
            } else if (currentView === 'bulkEdit') {
                renderBulkEditView();
            }
            
            // تفعيل تغيير حجم الأعمدة بعد رسم المحتوى
            setTimeout(() => {
                makeColumnsResizable(); // تفعيل إمكانية تغيير حجم الأعمدة
                loadColumnWidths(); // ✅ تحميل التنسيقات المحفوظة بعد تفعيل النظام
                applyColumnVisibility(); // ✅ تطبيق إعدادات إظهار/إخفاء الأعمدة
                activateExcelLikeEditing(); // تفعيل نظام التعديل المباشر
                addFilterIcons(); // إضافة أيقونات الفلتر
                
                // تطبيق الأعمدة المثبتة بعد تحميل جميع التنسيقات
                setTimeout(() => {
                    if (currentView === 'month') {
                        const table = document.getElementById('employeeTable');
                        if (table) {
                            applyPinnedColumns('employeeTable', 'month');
                        }
                    } else if (currentView === 'project') {
                        const projectTables = document.querySelectorAll('[id^="projectSectionTable"]');
                        projectTables.forEach(table => {
                            if (table) {
                                applyPinnedColumns(table.id, 'project');
                            }
                        });
                    }
                }, 100);
            }, 150); // زيادة الوقت قليلاً
        }

        // اختيار السنة والشهر الافتراضيين عند بدء التشغيل: آخر فترة تم تحديثها عبر جميع السنوات
        function getLatestUpdatedPeriod() {
            let best = { year: currentYear, month: currentMonth, ts: 0 };
            availableYears.forEach((y, yIdx) => {
                months.forEach((m, mIdx) => {
                    const arr = (employeeData[y] && employeeData[y][m]) ? employeeData[y][m] : [];
                    if (arr.length === 0) return;
                    let maxTs = 0;
                    arr.forEach(emp => {
                        const ts = emp.updatedAt ? (new Date(emp.updatedAt).getTime() || 0) : 0;
                        if (ts > maxTs) maxTs = ts;
                    });
                    // إذا لا توجد طوابع زمنية، نستخدم ترتيب الزمن: سنة وشهر أحدث يأخذ أولوية
                    if (maxTs === 0) {
                        maxTs = (y * 100 + (mIdx + 1));
                    }
                    if (maxTs >= best.ts) best = { year: y, month: m, ts: maxTs };
                });
            });
            return best;
        }

        // دالة لتغيير الشهر في لوحة التحكم
        function changeDashboardMonth(month) {
            dashboardSelectedMonth = month;
            renderContent(); // إعادة رسم لوحة التحكم
        }

        // دالة لتغيير السنة في لوحة التحكم وإظهار أشهر تلك السنة
        function changeDashboardYear(year) {
            const y = parseInt(year);
            if (!isNaN(y)) {
                currentYear = y;
            }
            // تحديث اختيار السنة في عناصر أخرى إن وجدت
            updateYearSelector();
            // عند تغيير السنة، اترك الشهر المحدد كما هو إن أردت؛ وإلا أعده للحالي
            // dashboardSelectedMonth = currentMonth; // يمكن تفعيلها إن لزم
            renderContent();
        }

        function renderDashboard() {
            // ==================== جمع بيانات الشهر الحالي ====================
            const currentMonthEmployees = (employeeData[currentYear] && employeeData[currentYear][dashboardSelectedMonth]) 
                ? employeeData[currentYear][dashboardSelectedMonth].filter(emp => hasProjectAccess(emp.project))
                : [];
            
            // ==================== جمع بيانات الشهر السابق للمقارنة ====================
            const currentMonthIndex = months.indexOf(dashboardSelectedMonth);
            const previousMonthIndex = currentMonthIndex > 0 ? currentMonthIndex - 1 : 11;
            const previousMonth = months[previousMonthIndex];
            const previousMonthYear = currentMonthIndex > 0 ? currentYear : currentYear - 1;
            
            const previousMonthEmployees = (employeeData[previousMonthYear] && employeeData[previousMonthYear][previousMonth])
                ? employeeData[previousMonthYear][previousMonth].filter(emp => hasProjectAccess(emp.project))
                : [];
            
            // ==================== حساب الإحصائيات الشهر الحالي ====================
            let currentStats = {
                totalEmployees: currentMonthEmployees.length,
                totalSalaryUSD: 0,
                totalSalaryIQD: 0,
                monthly: 0,
                daily: 0,
                vehicle: 0,
                projectsData: {},
                avgSalary: 0
            };
            
            currentMonthEmployees.forEach(emp => {
                const netSalaryInPaymentCurrency = calculateNetSalary(emp, dashboardSelectedMonth, currentYear);
                const exchangeRate = emp.exchangeRate || 1420;
                
                // تحويل الراتب الصافي إلى USD و IQD بشكل صحيح
                let netSalaryUSD = 0;
                let netSalaryIQD = 0;
                
                if (emp.paymentCurrency === 'USD') {
                    // الراتب الصافي بالدولار
                    netSalaryUSD = netSalaryInPaymentCurrency;
                    netSalaryIQD = netSalaryInPaymentCurrency * exchangeRate;
                } else {
                    // الراتب الصافي بالدينار
                    netSalaryIQD = netSalaryInPaymentCurrency;
                    netSalaryUSD = netSalaryInPaymentCurrency / exchangeRate;
                }
                
                currentStats.totalSalaryUSD += netSalaryUSD;
                currentStats.totalSalaryIQD += netSalaryIQD;
                
                // تصنيف حسب النوع
                if (emp.employeeType === 'monthly') currentStats.monthly++;
                else if (emp.employeeType === 'daily') currentStats.daily++;
                else if (emp.employeeType === 'vehicle') currentStats.vehicle++;
                
                // تصنيف حسب المشروع
                const projectCode = emp.project;
                if (!currentStats.projectsData[projectCode]) {
                    currentStats.projectsData[projectCode] = {
                        name: projects[projectCode] || projectCode,
                        count: 0,
                        totalSalary: 0
                    };
                }
                currentStats.projectsData[projectCode].count++;
                currentStats.projectsData[projectCode].totalSalary += netSalaryUSD; // حفظ بـ USD للمقارنة
            });
            
            currentStats.avgSalary = currentStats.totalEmployees > 0 
                ? currentStats.totalSalaryUSD / currentStats.totalEmployees 
                : 0;
            
            // ==================== حساب الإحصائيات الشهر السابق ====================
            let previousStats = {
                totalEmployees: previousMonthEmployees.length,
                totalSalaryUSD: 0
            };
            
            previousMonthEmployees.forEach(emp => {
                const netSalaryInPaymentCurrency = calculateNetSalary(emp, previousMonth, previousMonthYear);
                const exchangeRate = emp.exchangeRate || 1420;
                
                // تحويل إلى USD بشكل صحيح
                if (emp.paymentCurrency === 'USD') {
                    previousStats.totalSalaryUSD += netSalaryInPaymentCurrency;
                } else {
                    previousStats.totalSalaryUSD += netSalaryInPaymentCurrency / exchangeRate;
                }
            });
            
            // ==================== حساب التغييرات ====================
            const employeesChange = currentStats.totalEmployees - previousStats.totalEmployees;
            const employeesChangePercent = previousStats.totalEmployees > 0 
                ? ((employeesChange / previousStats.totalEmployees) * 100).toFixed(1)
                : 0;
            
            const salaryChange = currentStats.totalSalaryUSD - previousStats.totalSalaryUSD;
            const salaryChangePercent = previousStats.totalSalaryUSD > 0
                ? ((salaryChange / previousStats.totalSalaryUSD) * 100).toFixed(1)
                : 0;
            
            // ==================== جمع بيانات السنة كاملة للرسم البياني ====================
            const monthlyData = {
                labels: [],
                employees: [],
                salaries: []
            };
            
            months.forEach(month => {
                const monthEmps = (employeeData[currentYear] && employeeData[currentYear][month])
                    ? employeeData[currentYear][month].filter(emp => hasProjectAccess(emp.project))
                    : [];
                
                let monthSalaryUSD = 0;
                monthEmps.forEach(emp => {
                    const netSalaryInPaymentCurrency = calculateNetSalary(emp, month, currentYear);
                    const exchangeRate = emp.exchangeRate || 1420;
                    
                    // تحويل إلى USD بشكل صحيح
                    if (emp.paymentCurrency === 'USD') {
                        monthSalaryUSD += netSalaryInPaymentCurrency;
                    } else {
                        monthSalaryUSD += netSalaryInPaymentCurrency / exchangeRate;
                    }
                });
                
                monthlyData.labels.push(t('monthNames')[month]);
                monthlyData.employees.push(monthEmps.length);
                monthlyData.salaries.push(monthSalaryUSD);
            });
            
            // ==================== ملخص المشاريع (حسب النوع وعملة الدفع) ====================
            const projectSummary = {};
            currentMonthEmployees.forEach(emp => {
                const p = emp.project;
                if (!projectSummary[p]) {
                    projectSummary[p] = {
                        name: projects[p] || p,
                        total: 0,
                        monthly: 0,
                        daily: 0,
                        vehicle: 0,
                        usdCount: 0,
                        iqdCount: 0,
                        usdNet: 0,
                        iqdNet: 0
                    };
                }
                const s = projectSummary[p];
                s.total++;
                if (emp.employeeType === 'monthly') s.monthly++; else if (emp.employeeType === 'daily') s.daily++; else if (emp.employeeType === 'vehicle') s.vehicle++;
                const net = calculateNetSalary(emp, dashboardSelectedMonth, currentYear);
                const rate = emp.exchangeRate || 1420;
                if ((emp.paymentCurrency || 'IQD') === 'USD') { s.usdCount++; s.usdNet += net; s.iqdNet += net * rate; } else { s.iqdCount++; s.iqdNet += net; s.usdNet += net / rate; }
            });
            
            // ==================== بناء HTML ====================
            let html = `
            <!-- عنوان لوحة التحكم -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4); text-align: center;">
                <h1 style="color: white; margin: 0 0 10px 0; font-size: 36px; font-weight: 900; text-shadow: 0 4px 8px rgba(0,0,0,0.3);">
                    📊 ${t('smartDashboard')}
                </h1>
                <p style="color: rgba(255,255,255,0.95); font-size: 16px; margin: 0 0 20px 0;">
                    ${t('comprehensiveAnalysis')}
                </p>
                
                <!-- Year + Month Selectors -->
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 15px; flex-wrap: wrap;">
                    <label style="color: white; font-size: 15px; font-weight: 600;">📆 ${currentLang === 'ar' ? 'السنة:' : 'Year:'}</label>
                    <select id="dashboardYearSelector" onchange="changeDashboardYear(this.value)"
                        style="background: rgba(255,255,255,0.25); color: white; border: 2px solid rgba(255,255,255,0.4); padding: 10px 16px; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; min-width: 140px;">
                        ${availableYears.map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''} style="background:#667eea;color:white;">${y}</option>`).join('')}
                    </select>
                    <label style="color: white; font-size: 15px; font-weight: 600;">📅 ${currentLang === 'ar' ? 'الشهر:' : 'Month:'}</label>
                    <select id="dashboardMonthSelector" onchange="changeDashboardMonth(this.value)" 
                        style="background: rgba(255,255,255,0.25); color: white; border: 2px solid rgba(255,255,255,0.4); padding: 10px 20px; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; min-width: 220px;">
                        ${months.map(m => {
                            const emps = (employeeData[currentYear] && employeeData[currentYear][m]) ? employeeData[currentYear][m].filter(emp => hasProjectAccess(emp.project)).length : 0;
                            return `<option value="${m}" ${m === dashboardSelectedMonth ? 'selected' : ''} style="background:#667eea;color:white;">${t('monthNames')[m]}${emps?` (${emps})`:''}</option>`;
                        }).join('')}
                    </select>
                </div>
                
                <div style="display: inline-flex; gap: 15px; background: rgba(255,255,255,0.15); padding: 10px 20px; border-radius: 50px; backdrop-filter: blur(10px);">
                    <span style="color: white; font-size: 13px; font-weight: 600;">📅 ${t('lastUpdate')}: ${new Date().toLocaleDateString(currentLang === 'ar' ? 'ar-EG' : 'en-US')}</span>
                </div>
            </div>
            
            <!-- بطاقات الإحصائيات الرئيسية -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <!-- إجمالي الموظفين -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 16px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -20px; right: -20px; font-size: 120px; opacity: 0.1;">👥</div>
                    <div style="position: relative; z-index: 1;">
                        <div style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 600; margin-bottom: 8px;">👥 ${t('totalEmployees')}</div>
                        <div style="color: white; font-size: 42px; font-weight: 900; margin-bottom: 8px;">${currentStats.totalEmployees}</div>
                        <div style="display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.9); font-size: 13px;">
                            ${employeesChange !== 0 ? `
                                <span style="background: ${employeesChange > 0 ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'}; padding: 4px 10px; border-radius: 12px; font-weight: 700;">
                                    ${employeesChange > 0 ? '↑' : '↓'} ${Math.abs(employeesChange)} (${Math.abs(employeesChangePercent)}%)
                                </span>
                            ` : `<span style="opacity: 0.7;">${t('noChange')}</span>`}
                            <span style="opacity: 0.8;">${t('comparedTo')} ${t('monthNames')[previousMonth]}</span>
                        </div>
                    </div>
                </div>
                
                <!-- إجمالي الرواتب USD -->
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 25px; border-radius: 16px; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -20px; right: -20px; font-size: 120px; opacity: 0.1;">💰</div>
                    <div style="position: relative; z-index: 1;">
                        <div style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 600; margin-bottom: 8px;">💰 ${t('totalSalariesLabel')}</div>
                        <div style="color: white; font-size: 38px; font-weight: 900; margin-bottom: 5px;">${formatCurrency(currentStats.totalSalaryUSD)}</div>
                        <div style="color: rgba(255,255,255,0.85); font-size: 14px; font-weight: 600; margin-bottom: 8px;">USD</div>
                        <div style="display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.9); font-size: 13px;">
                            ${salaryChange !== 0 ? `
                                <span style="background: ${salaryChange > 0 ? 'rgba(255, 255, 255, 0.25)' : 'rgba(239, 68, 68, 0.3)'}; padding: 4px 10px; border-radius: 12px; font-weight: 700;">
                                    ${salaryChange > 0 ? '↑' : '↓'} ${formatCurrency(Math.abs(salaryChange))} (${Math.abs(salaryChangePercent)}%)
                                </span>
                            ` : `<span style="opacity: 0.7;">${t('noChange')}</span>`}
                        </div>
                    </div>
                </div>
                
                <!-- إجمالي الرواتب IQD -->
                <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 25px; border-radius: 16px; box-shadow: 0 10px 30px rgba(245, 158, 11, 0.3); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -20px; right: -20px; font-size: 120px; opacity: 0.1;">💵</div>
                    <div style="position: relative; z-index: 1;">
                        <div style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 600; margin-bottom: 8px;">💵 ${t('totalSalariesLabel')}</div>
                        <div style="color: white; font-size: 38px; font-weight: 900; margin-bottom: 5px;">${formatCurrency(currentStats.totalSalaryIQD)}</div>
                        <div style="color: rgba(255,255,255,0.85); font-size: 14px; font-weight: 600;">IQD</div>
                    </div>
                </div>
                
                <!-- متوسط الراتب -->
                <div style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); padding: 25px; border-radius: 16px; box-shadow: 0 10px 30px rgba(6, 182, 212, 0.3); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -20px; right: -20px; font-size: 120px; opacity: 0.1;">📊</div>
                    <div style="position: relative; z-index: 1;">
                        <div style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 600; margin-bottom: 8px;">📊 ${t('avgSalary')}</div>
                        <div style="color: white; font-size: 38px; font-weight: 900; margin-bottom: 5px;">${formatCurrency(currentStats.avgSalary)}</div>
                        <div style="color: rgba(255,255,255,0.85); font-size: 14px; font-weight: 600;">USD</div>
                    </div>
                </div>
            </div>
            
            <!-- توزيع أنواع الموظفين -->
            <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px;">
                <h3 style="color: var(--primary); margin: 0 0 25px 0; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                    <span>👥</span> ${t('employeesDistribution')}
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #3b82f6;">
                        <div style="font-size: 48px; font-weight: 900; color: #1e40af; margin-bottom: 8px;">${currentStats.monthly}</div>
                        <div style="color: #1e40af; font-size: 15px; font-weight: 600;">📋 ${t('monthly')}</div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #93c5fd; color: #3b82f6; font-size: 13px; font-weight: 600;">
                            ${currentStats.totalEmployees > 0 ? ((currentStats.monthly / currentStats.totalEmployees) * 100).toFixed(1) : 0}%
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #10b981;">
                        <div style="font-size: 48px; font-weight: 900; color: #065f46; margin-bottom: 8px;">${currentStats.daily}</div>
                        <div style="color: #065f46; font-size: 15px; font-weight: 600;">📅 ${t('daily')}</div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #86efac; color: #059669; font-size: 13px; font-weight: 600;">
                            ${currentStats.totalEmployees > 0 ? ((currentStats.daily / currentStats.totalEmployees) * 100).toFixed(1) : 0}%
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #f59e0b;">
                        <div style="font-size: 48px; font-weight: 900; color: #92400e; margin-bottom: 8px;">${currentStats.vehicle}</div>
                        <div style="color: #92400e; font-size: 15px; font-weight: 600;">🚗 ${t('vehicle')}</div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #fcd34d; color: #d97706; font-size: 13px; font-weight: 600;">
                            ${currentStats.totalEmployees > 0 ? ((currentStats.vehicle / currentStats.totalEmployees) * 100).toFixed(1) : 0}%
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- الرسوم البيانية -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 25px; margin-bottom: 30px;">
                <!-- رسم بياني: عدد الموظفين عبر الأشهر -->
                <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                    <h3 style="color: var(--primary); margin: 0 0 20px 0; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                        <span>📈</span> ${t('employeesOverYear')}
                    </h3>
                    <canvas id="employeesChart" style="max-height: 300px;"></canvas>
                </div>
                
                <!-- رسم بياني: الرواتب عبر الأشهر -->
                <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                    <h3 style="color: var(--primary); margin: 0 0 20px 0; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                        <span>💰</span> ${t('salariesOverYear')}
                    </h3>
                    <canvas id="salariesChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
            
            <!-- توزيع الرواتب حسب المشاريع -->
            <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px;">
                <h3 style="color: var(--primary); margin: 0 0 25px 0; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                    <span>🏗️</span> ${t('salariesByProjects')}
                </h3>
                <div style="display: grid; gap: 15px;">
            `;
            
            // ترتيب المشاريع حسب إجمالي الرواتب
            const sortedProjects = Object.entries(currentStats.projectsData)
                .sort((a, b) => b[1].totalSalary - a[1].totalSalary);
            
            sortedProjects.forEach(([projectCode, projectData], index) => {
                const percentage = (projectData.totalSalary / currentStats.totalSalaryUSD * 100).toFixed(1);
                const colors = [
                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                    'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
                    'linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)',
                    'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',
                    'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'
                ];
                const color = colors[index % colors.length];
                
                html += `
                <div style="background: linear-gradient(to right, #f8fafc 0%, white 100%); padding: 20px; border-radius: 12px; border-right: 5px solid ${color.includes('667eea') ? '#667eea' : color.includes('10b981') ? '#10b981' : color.includes('f59e0b') ? '#f59e0b' : color.includes('06b6d4') ? '#06b6d4' : color.includes('8b5cf6') ? '#8b5cf6' : '#ef4444'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <div style="font-size: 18px; font-weight: 700; color: var(--dark); margin-bottom: 5px;">${projectData.name}</div>
                            <div style="font-size: 13px; color: var(--gray);">👥 ${projectData.count} ${t('employee')}</div>
                        </div>
                        <div style="text-align: left;">
                            <div style="font-size: 24px; font-weight: 800; color: var(--primary);">${formatCurrency(projectData.totalSalary)}</div>
                            <div style="font-size: 12px; color: var(--gray); font-weight: 600;">USD</div>
                </div>
                </div>
                    <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: ${color}; height: 100%; width: ${percentage}%; transition: width 0.5s ease;"></div>
                </div>
                    <div style="text-align: right; margin-top: 8px; font-size: 14px; font-weight: 700; color: var(--primary);">${percentage}%</div>
                </div>
                `;
            });
            
            html += `
                </div>
            </div>
            
            <!-- جدول إحصائي لملخص المشاريع (حسب الشهر، النوع، عملة الدفع) -->
            <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px;">
                <h3 style="color: var(--primary); margin: 0 0 20px 0; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                    <span>📋</span> ${currentLang === 'ar' ? 'جدول ملخص المشاريع حسب النوع وعملة الدفع' : 'Projects Summary by Type & Payment Currency'} - ${t('monthNames')[dashboardSelectedMonth]} ${currentYear}
                </h3>
                <div class="table-container">
                    <table id="dashboardProjectsSummary">
                        <thead>
                            <tr>
                                <th>${t('project')}</th>
                                <th>${t('totalEmployees')}</th>
                                <th>${t('monthly')}</th>
                                <th>${t('daily')}</th>
                                <th>${t('vehicle')}</th>
                                <th>USD ${currentLang === 'ar' ? 'موظفين' : 'Emp'}</th>
                                <th>USD ${currentLang === 'ar' ? 'إجمالي' : 'Total'}</th>
                                <th>IQD ${currentLang === 'ar' ? 'موظفين' : 'Emp'}</th>
                                <th>IQD ${currentLang === 'ar' ? 'إجمالي' : 'Total'}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(() => {
                                const rows = Object.entries(projectSummary)
                                    .sort((a, b) => a[1].name.localeCompare(b[1].name))
                                    .map(([code, s]) => `
                                        <tr>
                                            <td style="font-weight: 700; color: var(--primary);">${s.name}</td>
                                            <td>${s.total}</td>
                                            <td>${s.monthly}</td>
                                            <td>${s.daily}</td>
                                            <td>${s.vehicle}</td>
                                            <td>${s.usdCount}</td>
                                            <td>${formatCurrency(s.usdNet)} USD</td>
                                            <td>${s.iqdCount}</td>
                                            <td>${formatCurrency(s.iqdNet)} IQD</td>
                                        </tr>
                                    `).join('');
                                // إجماليات الصف الأخير
                                const totals = Object.values(projectSummary).reduce((acc, s) => ({
                                    total: acc.total + s.total,
                                    monthly: acc.monthly + s.monthly,
                                    daily: acc.daily + s.daily,
                                    vehicle: acc.vehicle + s.vehicle,
                                    usdCount: acc.usdCount + s.usdCount,
                                    iqdCount: acc.iqdCount + s.iqdCount,
                                    usdNet: acc.usdNet + s.usdNet,
                                    iqdNet: acc.iqdNet + s.iqdNet
                                }), {total:0, monthly:0, daily:0, vehicle:0, usdCount:0, iqdCount:0, usdNet:0, iqdNet:0});
                                return rows + `
                                    <tr class="total-row" style="font-weight: 800; background: #f8fafc;">
                                        <td>${currentLang === 'ar' ? 'الإجمالي' : 'Total'}</td>
                                        <td>${totals.total}</td>
                                        <td>${totals.monthly}</td>
                                        <td>${totals.daily}</td>
                                        <td>${totals.vehicle}</td>
                                        <td>${totals.usdCount}</td>
                                        <td>${formatCurrency(totals.usdNet)} USD</td>
                                        <td>${totals.iqdCount}</td>
                                        <td>${formatCurrency(totals.iqdNet)} IQD</td>
                                    </tr>`;
                            })()}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- رسم بياني: توزيع المشاريع -->
            <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto;">
                <h3 style="color: var(--primary); margin: 0 0 20px 0; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; justify-content: center;">
                    <span>🎯</span> ${t('salariesDistribution')}
                </h3>
                <canvas id="projectsChart" style="max-height: 350px;"></canvas>
            </div>
            
            <!-- إحصائيات استخدام قاعدة البيانات -->
            <div id="databaseUsageStats" style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px;">
                <h3 style="color: var(--primary); margin: 0 0 25px 0; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                    <span>💾</span> ${currentLang === 'ar' ? 'إحصائيات استخدام قاعدة البيانات' : 'Database Usage Statistics'}
                </h3>
                <div id="databaseStatsContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div style="text-align: center; padding: 20px; color: #64748b;">
                        <div style="font-size: 48px; margin-bottom: 10px;">⏳</div>
                        <div>${currentLang === 'ar' ? 'جاري التحميل...' : 'Loading...'}</div>
                    </div>
                </div>
            </div>
            `;
            
            // تهيئة الرسوم البيانية بعد رسم HTML
            setTimeout(() => {
                // رسم بياني: عدد الموظفين
                const employeesCtx = document.getElementById('employeesChart');
                if (employeesCtx) {
                    new Chart(employeesCtx, {
                        type: 'line',
                        data: {
                            labels: monthlyData.labels,
                            datasets: [{
                                label: t('totalEmployees'),
                                data: monthlyData.employees,
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                pointBackgroundColor: '#667eea',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    titleFont: { size: 14, weight: 'bold' },
                                    bodyFont: { size: 13 },
                                    cornerRadius: 8
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { 
                                        font: { size: 12, weight: 'bold' },
                                        color: '#64748b'
                                    },
                                    grid: { color: '#e5e7eb' }
                                },
                                x: {
                                    ticks: { 
                                        font: { size: 11 },
                                        color: '#64748b'
                                    },
                                    grid: { display: false }
                                }
                            }
                        }
                    });
                }
                
                // رسم بياني: الرواتب
                const salariesCtx = document.getElementById('salariesChart');
                if (salariesCtx) {
                    new Chart(salariesCtx, {
                        type: 'bar',
                        data: {
                            labels: monthlyData.labels,
                            datasets: [{
                                label: t('totalSalariesLabel') + ' (USD)',
                                data: monthlyData.salaries,
                                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                                borderColor: '#10b981',
                                borderWidth: 2,
                                borderRadius: 8,
                                barThickness: 30
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    titleFont: { size: 14, weight: 'bold' },
                                    bodyFont: { size: 13 },
                                    cornerRadius: 8,
                                    callbacks: {
                                        label: function(context) {
                                            return formatCurrency(context.parsed.y) + ' USD';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { 
                                        font: { size: 12, weight: 'bold' },
                                        color: '#64748b',
                                        callback: function(value) {
                                            return formatCurrency(value);
                                        }
                                    },
                                    grid: { color: '#e5e7eb' }
                                },
                                x: {
                                    ticks: { 
                                        font: { size: 11 },
                                        color: '#64748b'
                                    },
                                    grid: { display: false }
                                }
                            }
                        }
                    });
                }
                
                // رسم بياني: توزيع المشاريع (Pie Chart)
                const projectsCtx = document.getElementById('projectsChart');
                if (projectsCtx && sortedProjects.length > 0) {
                    new Chart(projectsCtx, {
                        type: 'doughnut',
                        data: {
                            labels: sortedProjects.map(([code, data]) => data.name),
                            datasets: [{
                                data: sortedProjects.map(([code, data]) => data.totalSalary),
                                backgroundColor: [
                                    '#667eea',
                                    '#10b981',
                                    '#f59e0b',
                                    '#06b6d4',
                                    '#8b5cf6',
                                    '#ef4444'
                                ],
                                borderWidth: 3,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        font: { size: 13, weight: 'bold' },
                                        color: '#1f2937',
                                        padding: 15,
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    titleFont: { size: 14, weight: 'bold' },
                                    bodyFont: { size: 13 },
                                    cornerRadius: 8,
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return formatCurrency(value) + ' USD (' + percentage + '%)';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // تحميل إحصائيات قاعدة البيانات
                loadDatabaseUsageStats();
            }, 100);

            // ========== ملخص المشاريع للسنة كاملة - مفصل شهرياً (حسب النوع وعملة الدفع) ==========
            html += `
            <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px;">
                <h3 style="color: var(--primary); margin: 0 0 20px 0; font-size: 18px; font-weight: 800; display: flex; align-items: center; gap: 10px;">
                    <span>🏗️</span> ${currentLang === 'ar' ? 'ملخص المشاريع السنوي مفصل على الأشهر' : 'Yearly Projects Summary by Month'} (${currentYear})
                </h3>
                <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                    ${months.map(m => {
                        const emps = (employeeData[currentYear] && employeeData[currentYear][m]) ? employeeData[currentYear][m].filter(emp => hasProjectAccess(emp.project)) : [];
                        const summary = {};
                        emps.forEach(emp => {
                            const p = emp.project;
                            if (!summary[p]) {
                                summary[p] = { name: projects[p] || p, total:0, monthly:0, daily:0, vehicle:0, usdCount:0, iqdCount:0, usdNet:0, iqdNet:0 };
                            }
                            const s = summary[p];
                            s.total++;
                            if (emp.employeeType === 'monthly') s.monthly++; else if (emp.employeeType === 'daily') s.daily++; else if (emp.employeeType === 'vehicle') s.vehicle++;
                            const net = calculateNetSalary(emp, m, currentYear);
                            const rate = emp.exchangeRate || 1420;
                            if ((emp.paymentCurrency||'IQD') === 'USD') { s.usdCount++; s.usdNet += net; s.iqdNet += net*rate; } else { s.iqdCount++; s.iqdNet += net; s.usdNet += net/rate; }
                        });
                        const rows = Object.entries(summary).sort((a,b)=>a[1].name.localeCompare(b[1].name)).map(([code,s]) => `
                            <tr>
                                <td style=\"font-weight:700; color: var(--primary);\">${s.name}</td>
                                <td>${s.total}</td>
                                <td>${s.monthly}</td>
                                <td>${s.daily}</td>
                                <td>${s.vehicle}</td>
                                <td>${s.usdCount}</td>
                                <td>${formatCurrency(s.usdNet)} USD</td>
                                <td>${s.iqdCount}</td>
                                <td>${formatCurrency(s.iqdNet)} IQD</td>
                            </tr>
                        `).join('');
                        const totals = Object.values(summary).reduce((acc, s) => ({
                            total: acc.total + s.total,
                            monthly: acc.monthly + s.monthly,
                            daily: acc.daily + s.daily,
                            vehicle: acc.vehicle + s.vehicle,
                            usdCount: acc.usdCount + s.usdCount,
                            iqdCount: acc.iqdCount + s.iqdCount,
                            usdNet: acc.usdNet + s.usdNet,
                            iqdNet: acc.iqdNet + s.iqdNet
                        }), {total:0, monthly:0, daily:0, vehicle:0, usdCount:0, iqdCount:0, usdNet:0, iqdNet:0});
                        return `
                        <div class=\"table-container\">
                            <h4 style=\"margin: 0 0 10px 0; color: #334155;\">${t('monthNames')[m]} ${currentYear}</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>${t('project')}</th>
                                        <th>${t('totalEmployees')}</th>
                                        <th>${t('monthly')}</th>
                                        <th>${t('daily')}</th>
                                        <th>${t('vehicle')}</th>
                                        <th>USD ${currentLang === 'ar' ? 'موظفين' : 'Emp'}</th>
                                        <th>USD ${currentLang === 'ar' ? 'إجمالي' : 'Total'}</th>
                                        <th>IQD ${currentLang === 'ar' ? 'موظفين' : 'Emp'}</th>
                                        <th>IQD ${currentLang === 'ar' ? 'إجمالي' : 'Total'}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows}
                                    <tr class=\"total-row\" style=\"font-weight:800; background:#f8fafc;\">
                                        <td>${currentLang === 'ar' ? 'الإجمالي' : 'Total'}</td>
                                        <td>${totals.total}</td>
                                        <td>${totals.monthly}</td>
                                        <td>${totals.daily}</td>
                                        <td>${totals.vehicle}</td>
                                        <td>${totals.usdCount}</td>
                                        <td>${formatCurrency(totals.usdNet)} USD</td>
                                        <td>${totals.iqdCount}</td>
                                        <td>${formatCurrency(totals.iqdNet)} IQD</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>`;
                    }).join('')}
                </div>
            </div>`;

            return html;
        }

        function renderMonthView() {
            // استخدام السنة الحالية
            let employees = (employeeData[currentYear] && employeeData[currentYear][currentMonth]) ? employeeData[currentYear][currentMonth] : [];
            
            // تطبيق فلتر الصلاحيات أولاً
            employees = employees.filter(emp => hasProjectAccess(emp.project));
            
            // تطبيق فلاتر الأعمدة
            employees = applyFiltersToData(employees);
            
            if (monthFilterSearch) {
                const search = monthFilterSearch.toLowerCase();
                employees = employees.filter(emp => {
                    const nameAr = emp.nameAr || emp.name || '';
                    const nameEn = emp.nameEn || emp.name || '';
                    const position = emp.position || '';
                    
                    return nameAr.toLowerCase().includes(search) ||
                           nameEn.toLowerCase().includes(search) ||
                           position.toLowerCase().includes(search);
                });
            }
            if (monthFilterProject !== 'all') employees = employees.filter(emp => emp.project === monthFilterProject);
            if (monthFilterType !== 'all') employees = employees.filter(emp => {
                const empType = emp.employeeType || emp.type || '';
                return empType === monthFilterType;
            });
            // فلترة حسب حالة الدفع
            if (paymentFilter === 'paid') {
                employees = employees.filter(emp => emp.isPaid === true);
            } else if (paymentFilter === 'unpaid') {
                employees = employees.filter(emp => !emp.isPaid);
            }
            // فلترة حسب حالة الحجز
            if (reservationFilter === 'enabled') {
                employees = employees.filter(emp => emp.salaryReservationEnabled === true);
            } else if (reservationFilter === 'disabled') {
                employees = employees.filter(emp => !emp.salaryReservationEnabled);
            } else if (reservationFilter === 'shortage') {
                employees = employees.filter(emp => {
                    if (!emp.salaryReservationEnabled) return false;
                    const netBeforeReservation = calculateActualSalary(emp, currentMonth, currentYear);
                    const netInPaymentCurrency = convertToPaymentCurrency(netBeforeReservation, 'USD', emp);
                    const bonus = convertToPaymentCurrency(emp.bonus || 0, emp.bonusCurrency || 'IQD', emp);
                    const phoneBills = convertToPaymentCurrency(emp.phoneBills || 0, emp.phoneBillsCurrency || 'IQD', emp);
                    const ceoBonus = convertToPaymentCurrency(emp.ceoBonus || 0, emp.ceoBonusCurrency || 'IQD', emp);
                    const deductions = convertToPaymentCurrency(emp.deductions || 0, emp.deductionsCurrency || 'IQD', emp);
                    const advance = convertToPaymentCurrency(emp.advance || 0, emp.advanceCurrency || 'IQD', emp);
                    const netSalary = netInPaymentCurrency + bonus + phoneBills + ceoBonus - deductions - advance;
                    const reservation = calculateReservation(emp, netSalary, currentMonth, currentYear);
                    return reservation.isShortage;
                });
            } else if (reservationFilter === 'completed') {
                employees = employees.filter(emp => {
                    if (!emp.salaryReservationEnabled) return false;
                    const progress = getReservationProgress(emp, currentMonth, currentYear);
                    return progress.isCompleted;
                });
            }

            const allEmployees = (employeeData[currentYear] && employeeData[currentYear][currentMonth]) ? employeeData[currentYear][currentMonth] : [];
            
            // حساب الإحصائيات
            let totalNetSalary = 0;
            let totalMonthly = 0, totalDaily = 0, totalVehicle = 0;
            allEmployees.forEach(emp => {
                totalNetSalary += calculateNetSalary(emp, currentMonth, currentYear);
                if (emp.employeeType === 'monthly') totalMonthly++;
                else if (emp.employeeType === 'daily') totalDaily++;
                else if (emp.employeeType === 'vehicle') totalVehicle++;
            });
            
            // عنوان محسّن مع إحصائيات
            let html = `
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 20px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                    <div>
                        <h2 style="color: white; margin: 0 0 8px 0; font-size: 32px; font-weight: 800; display: flex; align-items: center; gap: 12px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                    📅 ${t('monthNames')[currentMonth]} ${currentYear}
                </h2>
                        <div style="display: flex; gap: 20px; flex-wrap: wrap; color: rgba(255,255,255,0.95); font-size: 14px; font-weight: 500;">
                            <div style="display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 20px;">
                                <span>👥 الموظفين:</span>
                                <strong style="font-size: 16px;">${allEmployees.length}</strong>
                            </div>
                            ${employees.length !== allEmployees.length ? `
                            <div style="display: flex; align-items: center; gap: 6px; background: rgba(16, 185, 129, 0.3); padding: 6px 12px; border-radius: 20px;">
                                <span>📊 المعروضين:</span>
                                <strong style="font-size: 16px;">${employees.length}</strong>
                            </div>` : ''}
                            ${Object.keys(columnFilters).length > 0 ? `
                            <div style="display: flex; align-items: center; gap: 6px; background: rgba(251, 191, 36, 0.3); padding: 6px 12px; border-radius: 20px;">
                                <span>🔍 فلاتر نشطة:</span>
                                <strong style="font-size: 16px;">${Object.keys(columnFilters).length}</strong>
                            </div>` : ''}
                        </div>
                    </div>
                    <div style="text-align: left;">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                            <div style="font-size: 13px; color: rgba(255,255,255,0.9); margin-bottom: 4px;">💰 إجمالي الرواتب</div>
                            <div style="font-size: 28px; font-weight: 800; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                ${formatCurrency(totalNetSalary)}
                            </div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 4px;">USD</div>
                        </div>
                    </div>
                </div>
                
                <!-- إحصائيات سريعة -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 20px;">
                    <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px; text-align: center; backdrop-filter: blur(5px);">
                        <div style="font-size: 24px; font-weight: 700; color: white;">${totalMonthly}</div>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 4px;">📋 ${currentLang === 'ar' ? 'موظف شهري' : 'Monthly'}</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px; text-align: center; backdrop-filter: blur(5px);">
                        <div style="font-size: 24px; font-weight: 700; color: white;">${totalDaily}</div>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 4px;">📅 ${currentLang === 'ar' ? 'موظف يومي' : 'Daily'}</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px; text-align: center; backdrop-filter: blur(5px);">
                        <div style="font-size: 24px; font-weight: 700; color: white;">${totalVehicle}</div>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 4px;">🚗 ${currentLang === 'ar' ? 'سيارات' : 'Vehicles'}</div>
                    </div>
                    <div style="background: rgba(16, 185, 129, 0.25); padding: 12px; border-radius: 10px; text-align: center; backdrop-filter: blur(5px); border: 2px solid rgba(16, 185, 129, 0.5);">
                        <div style="font-size: 24px; font-weight: 700; color: white;">${Object.keys(projects).length}</div>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 4px;">🏗️ ${currentLang === 'ar' ? 'المشاريع' : 'Projects'}</div>
                    </div>
                </div>
            </div>`;
            
            // إحصائيات الدفع
            const paidEmployees = allEmployees.filter(emp => emp.isPaid === true);
            const unpaidEmployees = allEmployees.filter(emp => !emp.isPaid);
            let paidAmount = 0;
            let unpaidAmount = 0;
            
            paidEmployees.forEach(emp => {
                paidAmount += calculateNetSalary(emp, currentMonth, currentYear);
            });
            
            unpaidEmployees.forEach(emp => {
                unpaidAmount += calculateNetSalary(emp, currentMonth, currentYear);
            });
            
            html += `
            <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px;">
                <h3 style="color: var(--primary); margin: 0 0 25px 0; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                    <span>💳</span> ${t('paymentStatistics')}
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 25px; border-radius: 16px; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);">
                        <div style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 600; margin-bottom: 8px;">✅ ${t('paidEmployees')}</div>
                        <div style="color: white; font-size: 38px; font-weight: 900; margin-bottom: 5px;">${paidEmployees.length}</div>
                        <div style="color: rgba(255,255,255,0.85); font-size: 14px; font-weight: 600; margin-top: 10px;">${t('paidAmount')}: ${formatCurrency(paidAmount)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 25px; border-radius: 16px; box-shadow: 0 10px 30px rgba(245, 158, 11, 0.3);">
                        <div style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 600; margin-bottom: 8px;">⏳ ${t('unpaidEmployees')}</div>
                        <div style="color: white; font-size: 38px; font-weight: 900; margin-bottom: 5px;">${unpaidEmployees.length}</div>
                        <div style="color: rgba(255,255,255,0.85); font-size: 14px; font-weight: 600; margin-top: 10px;">${t('unpaidAmount')}: ${formatCurrency(unpaidAmount)}</div>
                    </div>
                </div>
            </div>`;
            
            // إحصائيات الحجز
            const employeesWithReservation = allEmployees.filter(emp => emp.salaryReservationEnabled);
            let totalReservedThisMonth = 0;
            let totalReservedOverall = 0;
            let totalPreviousReserved = 0;
            
            employeesWithReservation.forEach(emp => {
                const netBeforeReservation = calculateActualSalary(emp, currentMonth, currentYear);
                const netInPaymentCurrency = convertToPaymentCurrency(netBeforeReservation, 'USD', emp);
                const bonus = convertToPaymentCurrency(emp.bonus || 0, emp.bonusCurrency || 'IQD', emp);
                const phoneBills = convertToPaymentCurrency(emp.phoneBills || 0, emp.phoneBillsCurrency || 'IQD', emp);
                const ceoBonus = convertToPaymentCurrency(emp.ceoBonus || 0, emp.ceoBonusCurrency || 'IQD', emp);
                const deductions = convertToPaymentCurrency(emp.deductions || 0, emp.deductionsCurrency || 'IQD', emp);
                const advance = convertToPaymentCurrency(emp.advance || 0, emp.advanceCurrency || 'IQD', emp);
                const netSalary = netInPaymentCurrency + bonus + phoneBills + ceoBonus - deductions - advance;
                
                const reservation = calculateReservation(emp, netSalary, currentMonth, currentYear);
                totalReservedThisMonth += reservation.actual;
                totalReservedOverall += getTotalReservedAmount(emp, currentMonth, currentYear);
                totalPreviousReserved += reservation.accumulated || 0;
            });
            
            if (employeesWithReservation.length > 0) {
                html += `
                <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px;">
                    <h3 style="color: var(--primary); margin: 0 0 25px 0; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                        <span>💰</span> ${t('reservationStatistics')}
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); padding: 25px; border-radius: 16px; box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3);">
                            <div style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 600; margin-bottom: 8px;">👥 ${t('totalEmployeesWithReservation')}</div>
                            <div style="color: white; font-size: 38px; font-weight: 900; margin-bottom: 5px;">${employeesWithReservation.length}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); padding: 25px; border-radius: 16px; box-shadow: 0 10px 30px rgba(6, 182, 212, 0.3);">
                            <div style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 600; margin-bottom: 8px;">📅 ${t('totalReservedThisMonth')}</div>
                            <div style="color: white; font-size: 38px; font-weight: 900; margin-bottom: 5px;">${formatCurrency(totalReservedThisMonth)}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 25px; border-radius: 16px; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);">
                            <div style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 600; margin-bottom: 8px;">💰 ${t('totalReservedOverall')}</div>
                            <div style="color: white; font-size: 38px; font-weight: 900; margin-bottom: 5px;">${formatCurrency(totalReservedOverall)}</div>
                            <div style="color: rgba(255,255,255,0.85); font-size: 12px; font-weight: 600; margin-top: 8px;">${currentLang === 'ar' ? 'منها محجوز سابقاً:' : 'Previously:'} ${formatCurrency(totalPreviousReserved)}</div>
                        </div>
                    </div>
                </div>`;
            }
            
            // أزرار الإجراءات محسّنة
            const isMonthLocked = !canEditCurrentMonth(currentMonth, currentYear);
            const lockMessage = isMonthLocked ? `<div style="background: #fef3c7; border: 2px solid #f59e0b; color: #92400e; padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-weight: 600;">
                🔒 الشهر الحالي مقفل من التعديل - يمكنك فقط عرض البيانات
            </div>` : '';
            
            html += `<div class="actions" style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                ${lockMessage}
                <button class="btn btn-success" onclick="openModal('employeeModal')" style="font-weight: 600;" ${isMonthLocked ? 'disabled' : ''}>➕ ${t('addEmployee')}</button>
                <button class="btn btn-success" onclick="openMultipleEmployeesModal()" style="font-weight: 600;" ${isMonthLocked ? 'disabled' : ''}>➕➕ ${currentLang === 'ar' ? 'إضافة متعدد' : 'Add Multiple'}</button>
                <button class="btn btn-primary" onclick="openCopyAllModal()" style="font-weight: 600;" ${isMonthLocked ? 'disabled' : ''}>${t('copyAll')}</button>
                ${selectedEmployees.size > 0 ? `<button class="btn btn-primary" onclick="openCopySelectedModal()" style="font-weight: 600;">${t('copySelected')}</button>` : ''}
                <button class="btn btn-warning" onclick="toggleSelectAll()" style="font-weight: 600;" ${isMonthLocked ? 'disabled' : ''}>${t('selectAll')}</button>
                <button class="btn btn-primary" onclick="openPrintOptionsModal()" style="font-weight: 600;">🖨️ ${t('print')}</button>
                <button class="btn" onclick="openReservationReport()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; font-weight: 600;">💰 ${t('reservationReport')}</button>
                <button class="btn" onclick="toggleColumnVisibilityPanel()" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; font-weight: 600;">👁️ ${currentLang === 'ar' ? 'إظهار/إخفاء الأعمدة' : 'Show/Hide Columns'}</button>
                <button class="btn" onclick="saveCurrentFormatting()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; font-weight: 600;">💾 ${currentLang === 'ar' ? 'حفظ التنسيق' : 'Save Format'}</button>
                ${Object.keys(columnFilters).length > 0 ? `<button class="btn" onclick="clearAllFilters()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-weight: 600;">🔄 ${currentLang === 'ar' ? 'مسح الفلاتر' : 'Clear Filters'} (${Object.keys(columnFilters).length})</button>` : ''}
                ${selectedEmployees.size > 0 ? `<span class="selected-count" style="background: #8b5cf6; animation: pulse 2s infinite;">${selectedEmployees.size} ${t('selected')}</span>` : ''}
                ${selectedEmployees.size > 0 ? `<button class="btn btn-danger" onclick="deleteSelectedEmployees()" style="font-weight: 600;" ${isMonthLocked ? 'disabled' : ''}>${t('deleteSelected')}</button>` : ''}
                ${selectedEmployees.size > 0 ? `<button class="btn btn-success" onclick="bulkMarkAsPaid()" style="font-weight: 600;">✅ ${t('markSelectedAsPaid')}</button>` : ''}
                ${selectedEmployees.size > 0 ? `<button class="btn btn-warning" onclick="bulkMarkAsUnpaid()" style="font-weight: 600;">⏳ ${t('markSelectedAsUnpaid')}</button>` : ''}
            </div>`;
            
            // فلترة حسب حالة الدفع
            html += `<div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <span style="font-weight: 600; color: #333;">${t('filterByPayment')}:</span>
                    <button class="btn ${paymentFilter === 'all' ? 'btn-primary' : 'btn'}" onclick="setPaymentFilter('all')" style="font-weight: 600;">${t('showAll')}</button>
                    <button class="btn ${paymentFilter === 'paid' ? 'btn-success' : 'btn'}" onclick="setPaymentFilter('paid')" style="font-weight: 600;">✅ ${t('showPaid')}</button>
                    <button class="btn ${paymentFilter === 'unpaid' ? 'btn-warning' : 'btn'}" onclick="setPaymentFilter('unpaid')" style="font-weight: 600;">⏳ ${t('showUnpaid')}</button>
                </div>
            </div>`;
            
            // فلترة حسب حالة الحجز
            html += `<div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <span style="font-weight: 600; color: #333;">💰 ${t('salaryReservation')}:</span>
                    <button class="btn ${reservationFilter === 'all' ? 'btn-primary' : 'btn'}" onclick="setReservationFilter('all')" style="font-weight: 600;">${t('showAll')}</button>
                    <button class="btn ${reservationFilter === 'enabled' ? 'btn-success' : 'btn'}" onclick="setReservationFilter('enabled')" style="font-weight: 600;">✅ ${t('reservationActive')}</button>
                    <button class="btn ${reservationFilter === 'disabled' ? 'btn-secondary' : 'btn'}" onclick="setReservationFilter('disabled')" style="font-weight: 600;">⚙️ ${t('reservationInactive')}</button>
                    <button class="btn ${reservationFilter === 'shortage' ? 'btn-warning' : 'btn'}" onclick="setReservationFilter('shortage')" style="font-weight: 600;">⚠️ ${t('reservationShortage')}</button>
                    <button class="btn ${reservationFilter === 'completed' ? 'btn-info' : 'btn'}" onclick="setReservationFilter('completed')" style="font-weight: 600;">🎉 ${t('reservationCompleted')}</button>
                </div>
            </div>`;

            // لوحة التحكم في الأعمدة
            html += `<div id="columnVisibilityPanel" style="display: none; background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #0ea5e9;">
                <h4 style="color: #075985; margin-bottom: 15px; font-size: 16px;">👁️ ${currentLang === 'ar' ? 'التحكم في الأعمدة' : 'Column Visibility'}</h4>
                <div id="columnToggles" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn btn-success btn-small" onclick="showAllColumns()">✅ ${currentLang === 'ar' ? 'إظهار الكل' : 'Show All'}</button>
                    <button class="btn btn-warning btn-small" onclick="hideAllColumns()">❌ ${currentLang === 'ar' ? 'إخفاء الكل' : 'Hide All'}</button>
                    <button class="btn btn-primary btn-small" onclick="resetColumnVisibility()">🔄 ${currentLang === 'ar' ? 'إعادة تعيين' : 'Reset'}</button>
                </div>
            </div>`;

            // قسم الفلاتر المحسّن
            html += `
            <div style="background: white; padding: 25px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 2px solid #e5e7eb;">
                <h3 style="color: var(--primary); margin: 0 0 20px 0; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                    🔍 ${currentLang === 'ar' ? 'الفلاتر السريعة' : 'Quick Filters'}
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div class="filter-group">
                        <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 10px; font-weight: 600; color: var(--dark);">
                            <span>🔎</span> ${t('search')}
                        </label>
                        <input type="text" class="search-box" id="searchBox" placeholder="${currentLang === 'ar' ? '🔍 ابحث عن موظف...' : '🔍 Search employee...'}" 
                            value="${monthFilterSearch}" oninput="handleSearch(this.value)"
                            style="width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; transition: all 0.3s;">
                </div>
                <div class="filter-group">
                        <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 10px; font-weight: 600; color: var(--dark);">
                            <span>🏗️</span> ${t('project')}
                        </label>
                        <select class="filter-select" id="projectFilter" onchange="handleProjectFilter(this.value)"
                            style="width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; background: white; cursor: pointer; transition: all 0.3s;">
                            <option value="all">🌐 ${t('all')}</option>
                        ${(() => {
                            const allowedProjects = getAllowedProjects();
                            const filteredProjects = allowedProjects === null ? projects : 
                                Object.fromEntries(Object.entries(projects).filter(([code]) => allowedProjects.includes(code)));
                            return Object.entries(filteredProjects).map(([code, name]) => 
                            `<option value="${code}" ${monthFilterProject === code ? 'selected' : ''}>${name}</option>`
                            ).join('');
                        })()}
                    </select>
                </div>
                <div class="filter-group">
                        <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 10px; font-weight: 600; color: var(--dark);">
                            <span>👥</span> ${t('type')}
                        </label>
                        <select class="filter-select" id="typeFilter" onchange="handleTypeFilter(this.value)"
                            style="width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; background: white; cursor: pointer; transition: all 0.3s;">
                            <option value="all">🌐 ${t('all')}</option>
                            <option value="monthly" ${monthFilterType === 'monthly' ? 'selected' : ''}>📋 ${t('monthly')}</option>
                            <option value="daily" ${monthFilterType === 'daily' ? 'selected' : ''}>📅 ${t('daily')}</option>
                            <option value="vehicle" ${monthFilterType === 'vehicle' ? 'selected' : ''}>🚗 ${t('vehicle')}</option>
                    </select>
                </div>
                </div>
                </div>`;

            if (employees.length === 0) {
                html += `<div class="empty-state"><h3>${t('noData')}</h3></div>`;
            } else {
                html += '<div class="table-container"><table id="employeeTable"><thead>';
                
                // تعريف الأعمدة
                const monthColumns = [
                    { dataColumn: 'select', label: '☑️', minWidth: '40px' },
                    { dataColumn: 'reorder', label: '⬆️⬇️', minWidth: '60px' },
                    { dataColumn: 'number', label: '#', minWidth: '50px' },
                    { dataColumn: 'code', label: `🔖 ${currentLang === 'ar' ? 'الرمز' : 'Code'}`, minWidth: '80px' },
                    { dataColumn: 'name', label: t('name'), minWidth: '120px' },
                    { dataColumn: 'position', label: t('position'), minWidth: '100px' },
                    { dataColumn: 'employeeType', label: t('type'), minWidth: '80px' },
                    { dataColumn: 'project', label: t('project'), minWidth: '100px' },
                    { dataColumn: 'salary', label: `💵 ${t('salary')}`, minWidth: '90px' },
                    { dataColumn: 'salaryCurrency', label: `💱 ${currentLang === 'ar' ? 'عملة الراتب' : 'Salary Curr.'}`, minWidth: '70px' },
                    { dataColumn: 'paymentCurrency', label: `💳 ${currentLang === 'ar' ? 'عملة الدفع' : 'Pay Curr.'}`, minWidth: '70px' },
                    { dataColumn: 'exchangeRate', label: `🔄 ${t('exchangeRate')}`, minWidth: '90px' },
                    { dataColumn: 'attendance', label: `⏰ ${currentLang === 'ar' ? 'الدوام' : 'Attendance'}`, minWidth: '120px' },
                    { dataColumn: 'dailySalary', label: `📅 ${t('dailySalary')}`, minWidth: '90px' },
                    { dataColumn: 'actualUSD', label: `💵 ${t('actualSalaryUSD')}`, minWidth: '100px' },
                    { dataColumn: 'actualIQD', label: `💰 ${t('actualSalaryIQD')}`, minWidth: '100px' },
                    { dataColumn: 'bonus', label: `🎁 ${t('bonus')}`, minWidth: '90px' },
                    { dataColumn: 'bonusCurrency', label: `💱 ${currentLang === 'ar' ? 'عملة البونص' : 'Bonus Curr.'}`, minWidth: '70px' },
                    { dataColumn: 'phoneBills', label: `📞 ${t('phoneBills')}`, minWidth: '90px' },
                    { dataColumn: 'phoneBillsCurrency', label: `💱 ${currentLang === 'ar' ? 'عملة الفواتير' : 'Bills Curr.'}`, minWidth: '70px' },
                    { dataColumn: 'deductions', label: `➖ ${t('deductions')}`, minWidth: '90px' },
                    { dataColumn: 'deductionsCurrency', label: `💱 ${currentLang === 'ar' ? 'عملة الخصومات' : 'Ded. Curr.'}`, minWidth: '70px' },
                    { dataColumn: 'advance', label: `💳 ${t('advance')}`, minWidth: '90px' },
                    { dataColumn: 'advanceCurrency', label: `💱 ${currentLang === 'ar' ? 'عملة السلفة' : 'Adv. Curr.'}`, minWidth: '70px' },
                    { dataColumn: 'netSalary', label: `✅ ${t('netSalary')}`, minWidth: '120px' },
                    { dataColumn: 'paymentStatus', label: `💳 ${t('paymentStatus')}`, minWidth: '120px' },
                    { dataColumn: 'reservationPercentage', label: `📊 ${t('reservationPercentage')}`, minWidth: '100px' },
                    { dataColumn: 'reservedAmount', label: `💰 ${t('reservedAmount')}`, minWidth: '120px' },
                    { dataColumn: 'reservation', label: `📈 ${t('reservationStatus')}`, minWidth: '150px' },
                    { dataColumn: 'actions', label: `⚙️ ${t('actions')}`, minWidth: '280px' }
                ];
                
                // إضافة صف صناديق التحديد
                html += createPinCheckboxRow(monthColumns, 'employeeTable', 'month');
                
                // إضافة رأس الجدول
                html += '<tr>';
                monthColumns.forEach(col => {
                    html += `<th data-column="${col.dataColumn}" style="min-width: ${col.minWidth};">${col.label}</th>`;
                });
                html += '</tr></thead><tbody id="employeeTableBody">';

                employees.forEach((emp, idx) => {
                    const index = allEmployees.indexOf(emp);
                    const dailySalaryUSD = calculateDailySalary(emp, selectedProjectMonth, currentYear);
                    const actualSalaryUSD = calculateActualSalary(emp, selectedProjectMonth, currentYear);
                    const actualSalaryIQD = actualSalaryUSD * emp.exchangeRate;
                    const netSalary = calculateNetSalary(emp, selectedProjectMonth, currentYear);
                    const empName = currentLang === 'ar' ? emp.nameAr : emp.nameEn;
                    const empType = emp.employeeType === 'monthly' ? t('monthly') : emp.employeeType === 'daily' ? t('daily') : t('vehicle');
                    
                    html += `<tr draggable="true" data-index="${index}" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" ondragend="handleDragEnd(event)">
                        <td><input type="checkbox" ${selectedEmployees.has(index) ? 'checked' : ''} onchange="toggleEmployeeSelection(${index})"></td>
                        <td style="cursor: move;">
                            <button class="reorder-btn" onclick="moveEmployeeUp(${index})" title="${currentLang === 'ar' ? 'تحريك لأعلى' : 'Move up'}">⬆️</button>
                            <button class="reorder-btn" onclick="moveEmployeeDown(${index})" title="${currentLang === 'ar' ? 'تحريك لأسفل' : 'Move down'}">⬇️</button>
                        </td>
                        <td>${idx + 1}</td>
                        <td style="font-weight: 600; color: var(--primary); font-size: 12px;">
                            ${emp.employeeCode || '-'}
                        </td>
                        <td>${empName}</td><td>${emp.position}</td><td>${empType}</td><td>${projects[emp.project] || emp.project}</td>
                        <td>${formatCurrency(emp.salary)}</td><td>${emp.salaryCurrency}</td><td>${emp.paymentCurrency}</td>
                        <td class="editable excel-cell" data-field="exchangeRate" data-index="${index}" style="font-weight: 600; background: #fef3c7;">${emp.exchangeRate}</td>
                        ${renderAttendanceCell(emp, index, '11px', currentMonth, currentYear)}
                        <td>${formatCurrency(dailySalaryUSD)}</td><td>${formatCurrency(actualSalaryUSD)}</td><td>${formatCurrency(actualSalaryIQD)}</td>
                        <td><input type="number" value="${emp.bonus || 0}" min="0" ${emp.isPaid ? 'disabled' : ''} onchange="updateField(${index}, 'bonus', this.value)" style="width: 100%; ${emp.isPaid ? 'background: #f3f4f6; cursor: not-allowed;' : ''}" title="${emp.isPaid ? (currentLang === 'ar' ? 'تم الدفع - لا يمكن التعديل' : 'Paid - Cannot edit') : ''}"></td>
                        <td><select ${emp.isPaid ? 'disabled' : ''} onchange="updateField(${index}, 'bonusCurrency', this.value)" style="width: 100%; ${emp.isPaid ? 'background: #f3f4f6; cursor: not-allowed;' : ''}" title="${emp.isPaid ? (currentLang === 'ar' ? 'تم الدفع - لا يمكن التعديل' : 'Paid - Cannot edit') : ''}">
                            <option value="USD" ${(emp.bonusCurrency || 'IQD') === 'USD' ? 'selected' : ''}>$</option>
                            <option value="IQD" ${(emp.bonusCurrency || 'IQD') === 'IQD' ? 'selected' : ''}>IQD</option>
                        </select></td>
                        <td><input type="number" value="${emp.phoneBills || 0}" min="0" ${emp.isPaid ? 'disabled' : ''} onchange="updateField(${index}, 'phoneBills', this.value)" style="width: 100%; ${emp.isPaid ? 'background: #f3f4f6; cursor: not-allowed;' : ''}" title="${emp.isPaid ? (currentLang === 'ar' ? 'تم الدفع - لا يمكن التعديل' : 'Paid - Cannot edit') : ''}"></td>
                        <td><select ${emp.isPaid ? 'disabled' : ''} onchange="updateField(${index}, 'phoneBillsCurrency', this.value)" style="width: 100%; ${emp.isPaid ? 'background: #f3f4f6; cursor: not-allowed;' : ''}" title="${emp.isPaid ? (currentLang === 'ar' ? 'تم الدفع - لا يمكن التعديل' : 'Paid - Cannot edit') : ''}">
                            <option value="USD" ${(emp.phoneBillsCurrency || 'IQD') === 'USD' ? 'selected' : ''}>$</option>
                            <option value="IQD" ${(emp.phoneBillsCurrency || 'IQD') === 'IQD' ? 'selected' : ''}>IQD</option>
                        </select></td>
                        <td><input type="number" value="${emp.deductions || 0}" min="0" ${emp.isPaid ? 'disabled' : ''} onchange="updateField(${index}, 'deductions', this.value)" style="width: 100%; ${emp.isPaid ? 'background: #f3f4f6; cursor: not-allowed;' : ''}" title="${emp.isPaid ? (currentLang === 'ar' ? 'تم الدفع - لا يمكن التعديل' : 'Paid - Cannot edit') : ''}"></td>
                        <td><select ${emp.isPaid ? 'disabled' : ''} onchange="updateField(${index}, 'deductionsCurrency', this.value)" style="width: 100%; ${emp.isPaid ? 'background: #f3f4f6; cursor: not-allowed;' : ''}" title="${emp.isPaid ? (currentLang === 'ar' ? 'تم الدفع - لا يمكن التعديل' : 'Paid - Cannot edit') : ''}">
                            <option value="USD" ${(emp.deductionsCurrency || 'IQD') === 'USD' ? 'selected' : ''}>$</option>
                            <option value="IQD" ${(emp.deductionsCurrency || 'IQD') === 'IQD' ? 'selected' : ''}>IQD</option>
                        </select></td>
                        <td><input type="number" value="${emp.advance || 0}" min="0" ${emp.isPaid ? 'disabled' : ''} onchange="updateField(${index}, 'advance', this.value)" style="width: 100%; ${emp.isPaid ? 'background: #f3f4f6; cursor: not-allowed;' : ''}" title="${emp.isPaid ? (currentLang === 'ar' ? 'تم الدفع - لا يمكن التعديل' : 'Paid - Cannot edit') : ''}"></td>
                        <td><select ${emp.isPaid ? 'disabled' : ''} onchange="updateField(${index}, 'advanceCurrency', this.value)" style="width: 100%; ${emp.isPaid ? 'background: #f3f4f6; cursor: not-allowed;' : ''}" title="${emp.isPaid ? (currentLang === 'ar' ? 'تم الدفع - لا يمكن التعديل' : 'Paid - Cannot edit') : ''}">
                            <option value="USD" ${(emp.advanceCurrency || 'IQD') === 'USD' ? 'selected' : ''}>$</option>
                            <option value="IQD" ${(emp.advanceCurrency || 'IQD') === 'IQD' ? 'selected' : ''}>IQD</option>
                        </select></td>
                        <td style="font-weight: bold; background: #dcfce7;">${formatCurrency(netSalary)} ${emp.paymentCurrency}</td>
                        <td style="text-align: center; padding: 8px;">
                            <button class="btn ${emp.isPaid ? 'btn-success' : 'btn-warning'}" 
                                    onclick="togglePaymentStatus(${index})" 
                                    style="min-width: 100px; font-size: 12px; padding: 6px 12px;"
                                    title="${emp.isPaid ? (emp.paidDate ? t('paid') + ' - ' + new Date(emp.paidDate).toLocaleDateString(currentLang === 'ar' ? 'ar-EG' : 'en-US') : t('paid')) : t('unpaid')}">
                                ${emp.isPaid ? '✅ ' + t('paid') : '⏳ ' + t('unpaid')}
                            </button>
                            ${emp.isPaid && emp.paidDate ? `<div style="font-size: 10px; color: #666; margin-top: 4px;">${new Date(emp.paidDate).toLocaleDateString(currentLang === 'ar' ? 'ar-EG' : 'en-US')}</div>` : ''}
                            ${emp.isPaid ? `<button class="btn btn-small" onclick="openPaymentDetailsModal(${index})" style="margin-top: 4px; font-size: 10px; padding: 4px 8px;" title="${t('editPaymentDetails')}">📝</button>` : ''}
                        </td>
                        <td style="text-align: center; padding: 4px;">
                            ${(() => {
                                if (!emp.salaryReservationEnabled) {
                                    return `<button class="btn btn-secondary btn-small" onclick="enableReservationQuick(${index})" style="font-size: 10px; padding: 4px 8px;" title="${t('reservationInactive')}">⚙️</button>`;
                                }
                                const netBeforeReservation = calculateActualSalary(emp, currentMonth, currentYear);
                                const netInPaymentCurrency = convertToPaymentCurrency(netBeforeReservation, 'USD', emp);
                                const bonus = convertToPaymentCurrency(emp.bonus || 0, emp.bonusCurrency || 'IQD', emp);
                                const phoneBills = convertToPaymentCurrency(emp.phoneBills || 0, emp.phoneBillsCurrency || 'IQD', emp);
                                const ceoBonus = convertToPaymentCurrency(emp.ceoBonus || 0, emp.ceoBonusCurrency || 'IQD', emp);
                                const deductions = convertToPaymentCurrency(emp.deductions || 0, emp.deductionsCurrency || 'IQD', emp);
                                const advance = convertToPaymentCurrency(emp.advance || 0, emp.advanceCurrency || 'IQD', emp);
                                const netSalary = netInPaymentCurrency + bonus + phoneBills + ceoBonus - deductions - advance;
                                return `
                                    <input type="number" 
                                           value="${emp.reservationPercentage || 0}" 
                                           min="0" 
                                           max="100" 
                                           step="0.1" 
                                           ${emp.isPaid ? 'disabled' : ''}
                                           oninput="updateReservationPercentage(${index}, this.value, ${netSalary})" 
                                           style="width: 80px; padding: 4px; text-align: center; font-size: 11px; border: 1px solid #ddd; border-radius: 4px; ${emp.isPaid ? 'background: #f3f4f6; cursor: not-allowed;' : ''}"
                                           title="${emp.isPaid ? (currentLang === 'ar' ? 'تم الدفع - لا يمكن التعديل' : 'Paid - Cannot edit') : t('reservationPercentage')}">
                                    <div style="font-size: 9px; color: #666; margin-top: 2px;">%</div>
                                `;
                            })()}
                        </td>
                        <td style="text-align: center; padding: 4px;">
                            ${(() => {
                                if (!emp.salaryReservationEnabled) {
                                    return `<span style="color: #999; font-size: 11px;">-</span>`;
                                }
                                const netBeforeReservation = calculateActualSalary(emp, currentMonth, currentYear);
                                const netInPaymentCurrency = convertToPaymentCurrency(netBeforeReservation, 'USD', emp);
                                const bonus = convertToPaymentCurrency(emp.bonus || 0, emp.bonusCurrency || 'IQD', emp);
                                const phoneBills = convertToPaymentCurrency(emp.phoneBills || 0, emp.phoneBillsCurrency || 'IQD', emp);
                                const ceoBonus = convertToPaymentCurrency(emp.ceoBonus || 0, emp.ceoBonusCurrency || 'IQD', emp);
                                const deductions = convertToPaymentCurrency(emp.deductions || 0, emp.deductionsCurrency || 'IQD', emp);
                                const advance = convertToPaymentCurrency(emp.advance || 0, emp.advanceCurrency || 'IQD', emp);
                                const netSalary = netInPaymentCurrency + bonus + phoneBills + ceoBonus - deductions - advance;
                                const currentReserved = parseFloat(emp.reservedAmount) || 0;
                                // حساب الحجز التراكمي من الأشهر السابقة
                                const accumulatedReservation = calculateAccumulatedReservation(emp, currentMonth, currentYear);
                                const totalReserved = accumulatedReservation + currentReserved;
                                return `
                                    <input type="number" 
                                           value="${currentReserved.toFixed(2)}" 
                                           min="0" 
                                           step="0.01" 
                                           ${emp.isPaid ? 'disabled' : ''}
                                           oninput="updateReservedAmount(${index}, this.value, ${netSalary})" 
                                           style="width: 100px; padding: 4px; text-align: center; font-size: 11px; border: 1px solid #ddd; border-radius: 4px; font-weight: 600; ${emp.isPaid ? 'background: #f3f4f6; cursor: not-allowed;' : ''}"
                                           title="${emp.isPaid ? (currentLang === 'ar' ? 'تم الدفع - لا يمكن التعديل' : 'Paid - Cannot edit') : t('reservedAmount')}">
                                    <div style="font-size: 9px; color: #666; margin-top: 2px;">${emp.paymentCurrency || 'IQD'}</div>
                                    ${accumulatedReservation > 0 ? `<div style="font-size: 8px; color: #3b82f6; margin-top: 2px;" title="${currentLang === 'ar' ? 'المحجوز تراكمياً من الأشهر السابقة' : 'Accumulated from previous months'}">📊 ${formatCurrency(accumulatedReservation)}</div>` : ''}
                                `;
                            })()}
                        </td>
                        <td style="text-align: center; padding: 8px;">
                            ${(() => {
                                if (!emp.salaryReservationEnabled) {
                                    return `<button class="btn btn-secondary btn-small" onclick="openReservationModal(${index})" style="font-size: 11px; padding: 6px 12px;" title="${t('manageReservation')}">⚙️ ${t('reservationInactive')}</button>`;
                                }
                                const netBeforeReservation = calculateActualSalary(emp, currentMonth, currentYear);
                                const netInPaymentCurrency = convertToPaymentCurrency(netBeforeReservation, 'USD', emp);
                                const bonus = convertToPaymentCurrency(emp.bonus || 0, emp.bonusCurrency || 'IQD', emp);
                                const phoneBills = convertToPaymentCurrency(emp.phoneBills || 0, emp.phoneBillsCurrency || 'IQD', emp);
                                const ceoBonus = convertToPaymentCurrency(emp.ceoBonus || 0, emp.ceoBonusCurrency || 'IQD', emp);
                                const deductions = convertToPaymentCurrency(emp.deductions || 0, emp.deductionsCurrency || 'IQD', emp);
                                const advance = convertToPaymentCurrency(emp.advance || 0, emp.advanceCurrency || 'IQD', emp);
                                const netSalary = netInPaymentCurrency + bonus + phoneBills + ceoBonus - deductions - advance;
                                const reservation = calculateReservation(emp, netSalary, currentMonth, currentYear);
                                const totalReserved = reservation.total || (reservation.accumulated + reservation.actual);
                                const target = reservation.target || parseFloat(emp.targetReservedAmount) || calculateTargetReservation(emp);
                                const progress = {
                                    totalReserved: totalReserved,
                                    target: target,
                                    progress: target > 0 ? Math.min((totalReserved / target) * 100, 100) : 0,
                                    remaining: Math.max(0, target - totalReserved),
                                    isCompleted: totalReserved >= target
                                };
                                const reservationStatus = progress.isCompleted ? 'completed' : (reservation.isShortage ? 'shortage' : 'active');
                                const statusColor = reservationStatus === 'completed' ? '#10b981' : (reservationStatus === 'shortage' ? '#f59e0b' : '#3b82f6');
                                return `
                                    <button class="btn" onclick="openReservationModal(${index})" ${emp.isPaid ? 'disabled' : ''} style="background: ${statusColor}; color: white; font-size: 11px; padding: 6px 12px; font-weight: 600; ${emp.isPaid ? 'opacity: 0.6; cursor: not-allowed;' : ''}" title="${emp.isPaid ? (currentLang === 'ar' ? 'تم الدفع - لا يمكن التعديل' : 'Paid - Cannot edit') : t('manageReservation')}">
                                        📊 ${formatCurrency(totalReserved)} / ${formatCurrency(progress.target)}
                                    </button>
                                    <div style="font-size: 10px; color: #666; margin-top: 4px;">
                                        ${Math.round(progress.progress)}%
                                    </div>
                                    ${reservation.isShortage ? `<div style="font-size: 9px; color: #f59e0b; margin-top: 2px;">⚠️ ${t('reservationShortage')}</div>` : ''}
                                `;
                            })()}
                        </td>
                        <td style="white-space: nowrap;">
                            <button class="btn btn-primary btn-small" onclick="openEditModal(${index})" ${!canEditCurrentMonth(currentMonth, currentYear) ? 'disabled title="الشهر مقفل من التعديل"' : (emp.isPaid ? 'disabled title="' + (currentLang === 'ar' ? 'تم الدفع - لا يمكن التعديل' : 'Paid - Cannot edit') + '"' : '')}>${t('edit')}</button>
                            <button class="btn btn-warning btn-small" onclick="openAttendanceModal(${index}, '${currentMonth}', ${currentYear})" title="${currentLang === 'ar' ? 'إدخال الدوام' : 'Enter Attendance'}" ${!canEditCurrentMonth(currentMonth, currentYear) ? 'disabled title="الشهر مقفل من التعديل"' : (emp.isPaid ? 'disabled title="' + (currentLang === 'ar' ? 'تم الدفع - لا يمكن التعديل' : 'Paid - Cannot edit') + '"' : '')}>⏰</button>
                            <button class="btn btn-info btn-small" onclick="openEmployeeReportModal(${index}, '${currentMonth}', ${currentYear})" title="${currentLang === 'ar' ? 'تقرير الموظف عبر الأشهر' : 'Employee Monthly Report'}" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white;">📊</button>
                            <button class="btn btn-success btn-small" onclick="openCopyModal(${index})" ${!canEditCurrentMonth(currentMonth, currentYear) ? 'disabled title="الشهر مقفل من التعديل"' : ''}>${t('copy')}</button>
                            ${currentUser && currentUser.fullAccess ? `<button class="btn btn-danger btn-small" onclick="deleteEmployee(${index})" ${!canEditCurrentMonth(currentMonth, currentYear) ? 'disabled title="الشهر مقفل من التعديل"' : (emp.isPaid ? 'disabled title="' + (currentLang === 'ar' ? 'تم الدفع - لا يمكن الحذف' : 'Paid - Cannot delete') + '"' : '')}>${t('delete')}</button>` : ''}
                        </td>
                    </tr>`;
                });
                
                // إضافة صفوف المجموع - سطر لكل عملة دفع
                // المجاميع الخاصة بعملة الدفع USD
                let usdActual = 0, usdBonus = 0, usdPhoneBills = 0, usdDeductions = 0, usdAdvance = 0, usdNet = 0;
                let usdCount = 0;
                
                // المجاميع الخاصة بعملة الدفع IQD
                let iqdActual = 0, iqdBonus = 0, iqdPhoneBills = 0, iqdDeductions = 0, iqdAdvance = 0, iqdNet = 0;
                let iqdCount = 0;
                
                employees.forEach(emp => {
                    const paymentCurrency = emp.paymentCurrency || 'IQD';
                    const exchangeRate = parseFloat(emp.exchangeRate) || 1420;
                    
                    if (paymentCurrency === 'USD') {
                        // حساب الموظفين بعملة دفع USD
                        usdCount++;
                        
                        // الراتب الفعلي بـ USD
                        const actualSalaryUSD = calculateActualSalary(emp, selectedProjectMonth, currentYear);
                        usdActual += actualSalaryUSD;
                        
                        // تحويل كل الأعمدة إلى USD
                        usdBonus += convertToPaymentCurrency(emp.bonus || 0, emp.bonusCurrency || 'IQD', emp);
                        usdPhoneBills += convertToPaymentCurrency(emp.phoneBills || 0, emp.phoneBillsCurrency || 'IQD', emp);
                        usdDeductions += convertToPaymentCurrency(emp.deductions || 0, emp.deductionsCurrency || 'IQD', emp);
                        usdAdvance += convertToPaymentCurrency(emp.advance || 0, emp.advanceCurrency || 'IQD', emp);
                        
                        // الصافي النهائي
                        usdNet += calculateNetSalary(emp, selectedProjectMonth, currentYear);
                        
                    } else {
                        // حساب الموظفين بعملة دفع IQD
                        iqdCount++;
                        
                        // الراتب الفعلي بـ IQD
                        const actualSalaryUSD = calculateActualSalary(emp, selectedProjectMonth, currentYear);
                        iqdActual += actualSalaryUSD * exchangeRate;
                        
                        // تحويل كل الأعمدة إلى IQD
                        iqdBonus += convertToPaymentCurrency(emp.bonus || 0, emp.bonusCurrency || 'IQD', emp);
                        iqdPhoneBills += convertToPaymentCurrency(emp.phoneBills || 0, emp.phoneBillsCurrency || 'IQD', emp);
                        iqdDeductions += convertToPaymentCurrency(emp.deductions || 0, emp.deductionsCurrency || 'IQD', emp);
                        iqdAdvance += convertToPaymentCurrency(emp.advance || 0, emp.advanceCurrency || 'IQD', emp);
                        
                        // الصافي النهائي
                        iqdNet += calculateNetSalary(emp, selectedProjectMonth, currentYear);
                    }
                });
                
                html += `<tfoot>`;
                
                // السطر الأول: المجموع بالدولار (USD)
                if (usdCount > 0) {
                    html += `
                    <tr style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); font-weight: 700; border-top: 3px solid #3b82f6;">
                        <td colspan="4" style="text-align: center; font-size: 14px; padding: 12px; color: #1e40af;">
                            💵 ${currentLang === 'ar' ? 'المجموع (عملة دفع USD)' : 'Total (Payment: USD)'} 
                            <span style="font-size: 11px; opacity: 0.8;">(${usdCount} ${currentLang === 'ar' ? 'موظف' : 'emp'})</span>
                        </td>
                        <td colspan="10"></td>
                        <td style="color: #1e40af; font-size: 13px;">${formatCurrency(usdActual)}</td>
                        <td style="color: #1e40af; font-size: 13px;">${formatCurrency(usdActual * 1420)}</td>
                        <td style="color: #1e40af; font-size: 13px;">${formatCurrency(usdBonus)}</td>
                        <td style="font-size: 10px; color: #1e3a8a;">USD</td>
                        <td style="color: #1e40af; font-size: 13px;">${formatCurrency(usdPhoneBills)}</td>
                        <td style="font-size: 10px; color: #1e3a8a;">USD</td>
                        <td style="color: #1e40af; font-size: 13px;">${formatCurrency(usdDeductions)}</td>
                        <td style="font-size: 10px; color: #1e3a8a;">USD</td>
                        <td style="color: #1e40af; font-size: 13px;">${formatCurrency(usdAdvance)}</td>
                        <td style="font-size: 10px; color: #1e3a8a;">USD</td>
                        <td style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; font-size: 16px; padding: 12px; text-align: center; font-weight: 800;">
                            💵 ${formatCurrency(usdNet)} USD
                        </td>
                        <td></td>
                    </tr>`;
                }
                
                // السطر الثاني: المجموع بالدينار (IQD)
                if (iqdCount > 0) {
                    html += `
                    <tr style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); font-weight: 700; border-bottom: 3px solid #f59e0b;">
                        <td colspan="4" style="text-align: center; font-size: 14px; padding: 12px; color: #92400e;">
                            💰 ${currentLang === 'ar' ? 'المجموع (عملة دفع IQD)' : 'Total (Payment: IQD)'} 
                            <span style="font-size: 11px; opacity: 0.8;">(${iqdCount} ${currentLang === 'ar' ? 'موظف' : 'emp'})</span>
                        </td>
                        <td colspan="10"></td>
                        <td style="color: #92400e; font-size: 13px;">${formatCurrency(iqdActual / 1420)}</td>
                        <td style="color: #92400e; font-size: 13px;">${formatCurrency(iqdActual)}</td>
                        <td style="color: #92400e; font-size: 13px;">${formatCurrency(iqdBonus)}</td>
                        <td style="font-size: 10px; color: #78350f;">IQD</td>
                        <td style="color: #92400e; font-size: 13px;">${formatCurrency(iqdPhoneBills)}</td>
                        <td style="font-size: 10px; color: #78350f;">IQD</td>
                        <td style="color: #92400e; font-size: 13px;">${formatCurrency(iqdDeductions)}</td>
                        <td style="font-size: 10px; color: #78350f;">IQD</td>
                        <td style="color: #92400e; font-size: 13px;">${formatCurrency(iqdAdvance)}</td>
                        <td style="font-size: 10px; color: #78350f;">IQD</td>
                        <td style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-size: 16px; padding: 12px; text-align: center; font-weight: 800;">
                            💰 ${formatCurrency(iqdNet)} IQD
                        </td>
                        <td></td>
                    </tr>`;
                }
                
                // السطر الثالث: الإجمالي العام (اختياري - للمعلومات فقط)
                if (usdCount > 0 && iqdCount > 0) {
                    const grandTotalUSD = usdNet + (iqdNet / 1420);
                    const grandTotalIQD = (usdNet * 1420) + iqdNet;
                    html += `
                    <tr style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); font-weight: 800; border-top: 2px solid #10b981; border-bottom: 3px solid #10b981;">
                        <td colspan="4" style="text-align: center; font-size: 15px; padding: 15px; color: #065f46;">
                            🌐 ${currentLang === 'ar' ? 'الإجمالي العام' : 'Grand Total'} 
                            <span style="font-size: 11px; opacity: 0.8;">(${usdCount + iqdCount} ${currentLang === 'ar' ? 'موظف' : 'emp'})</span>
                        </td>
                        <td colspan="20"></td>
                        <td style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 14px; padding: 15px; text-align: center;">
                            <div style="font-size: 17px; font-weight: 900; margin-bottom: 3px;">💵 ${formatCurrency(grandTotalUSD)} USD</div>
                            <div style="font-size: 17px; font-weight: 900;">💰 ${formatCurrency(grandTotalIQD)} IQD</div>
                        </td>
                        <td></td>
                    </tr>`;
                }
                
                html += `</tfoot></table></div>`;
            }
            return html;
        }
function renderProjectView() {
            // التحقق من صلاحية الوصول للمشروع
            if (!hasProjectAccess(currentProject)) {
                return `<div class="empty-state"><h3>❌ غير مسموح لك بالوصول لهذا المشروع</h3></div>`;
            }
            
            if (!projects[currentProject]) return `<div class="empty-state"><h3>❌ ${t('noData')}</h3></div>`;
            
            // استخدام السنة الحالية
            let monthData = (employeeData[currentYear] && employeeData[currentYear][selectedProjectMonth]) ? employeeData[currentYear][selectedProjectMonth] : [];
            // تطبيق فلتر الصلاحيات أولاً
            monthData = monthData.filter(emp => hasProjectAccess(emp.project));
            // تصفية الموظفين حسب المشروع الحالي
            let monthEmployees = monthData.filter(emp => emp.project === currentProject);
            // تطبيق فلاتر الأعمدة على الموظفين المصفّين
            monthEmployees = applyFiltersToData(monthEmployees);
            const monthlyEmps = monthEmployees.filter(emp => emp.employeeType === 'monthly');
            const dailyEmps = monthEmployees.filter(emp => emp.employeeType === 'daily');
            const vehicleEmps = monthEmployees.filter(emp => emp.employeeType === 'vehicle');

            const allowedProjects = getAllowedProjects();
            const navigationProjects = Object.entries(projects)
                .filter(([code]) => allowedProjects === null || allowedProjects.includes(code))
                .map(([code, name]) => {
                    const count = monthData.filter(emp => emp.project === code).length;
                    return { code, name, count };
                })
                .filter(project => project.count > 0 || project.code === currentProject)
                .sort((a, b) => a.name.localeCompare(b.name, currentLang === 'ar' ? 'ar' : 'en', { sensitivity: 'base' }));
            const showProjectSwitcher = navigationProjects.length > 1;
            const projectSwitcherLabel = currentLang === 'ar' ? 'المشاريع في نفس الفترة' : 'Projects this period';
            const projectSwitcherButtons = navigationProjects.map(project => {
                const safeCode = project.code.replace(/'/g, "\\'");
                const activeClass = project.code === currentProject ? ' active' : '';
                const countBadge = project.count ? `<span class="count">${project.count}</span>` : '';
                return `<button type="button" class="project-switch-btn${activeClass}" onclick="switchProject('${safeCode}')">${project.name}${countBadge}</button>`;
            }).join('');

            let totalUSD = 0, totalIQD = 0;
            monthEmployees.forEach(emp => {
                const netSalary = calculateNetSalary(emp, selectedProjectMonth, currentYear);
                const exchangeRate = parseFloat(emp.exchangeRate) || 1;
                if (emp.paymentCurrency === 'USD') {
                    totalUSD += netSalary;
                    totalIQD += netSalary * exchangeRate;
                } else {
                    totalIQD += netSalary;
                    totalUSD += netSalary / exchangeRate;
                }
            });

            // Header محسّن مع بطاقة احترافية
            let html = `
            <div style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); padding: 24px; border-radius: 16px; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.06);">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                    <!-- معلومات المشروع -->
                    <div style="flex: 1; min-width: 250px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);">
                                📊
                            </div>
                            <div>
                                <h2 style="color: var(--dark); margin: 0; font-size: 22px; font-weight: 800;">
                                    ${projects[currentProject]}
                                </h2>
                                <p style="color: var(--gray); margin: 4px 0 0 0; font-size: 13px; font-weight: 500;">
                                    📅 ${t('monthNames')[selectedProjectMonth]} ${currentYear} | 👥 ${monthEmployees.length} ${currentLang === 'ar' ? 'موظف' : 'employees'}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- أدوات التحكم -->
                    <div class="actions" style="margin: 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <select onchange="changeProjectMonth(this.value)" 
                                style="padding: 12px 16px; border-radius: 10px; border: 2px solid var(--primary); font-weight: 600; font-size: 14px; cursor: pointer; background: white; transition: all 0.3s;"
                                onmouseover="this.style.borderColor='var(--primary-dark)'; this.style.boxShadow='0 0 0 3px rgba(99,102,241,0.1)'"
                                onmouseout="this.style.borderColor='var(--primary)'; this.style.boxShadow='none'">
                            ${months.map(m => {
                                const mData = (employeeData[currentYear] && employeeData[currentYear][m]) ? employeeData[currentYear][m] : [];
                                const count = mData.filter(emp => emp.project === currentProject).length;
                                return `<option value="${m}" ${m === selectedProjectMonth ? 'selected' : ''}>${t('monthNames')[m]} (${count})</option>`;
                            }).join('')}
                        </select>
                        <button class="btn ${isUnlocked ? 'btn-success' : 'btn-warning'}" 
                                onclick="openModal('bonusPasswordModal')" 
                                style="padding: 12px 20px; font-weight: 600; font-size: 14px;">
                            ${isUnlocked ? '🔓 مفتوح' : '🔒 مقفل'}
                        </button>
                    </div>
                </div>
                ${showProjectSwitcher ? `
                <div class="project-switcher">
                    <div class="project-switcher-label">🏗️ ${projectSwitcherLabel}</div>
                    <div class="project-switcher-buttons">
                        ${projectSwitcherButtons}
                    </div>
                </div>
                ` : ''}
            </div>`;

            // صندوق إحصائيات محسّن
            html += `
            <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 24px; border-radius: 16px; margin-bottom: 30px; border: 3px solid #fbbf24; box-shadow: 0 6px 16px rgba(251, 191, 36, 0.2);">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <div style="width: 42px; height: 42px; background: rgba(245, 158, 11, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                        💰
                    </div>
                    <h3 style="color: #92400e; margin: 0; font-size: 18px; font-weight: 800;">
                        ${currentLang === 'ar' ? 'الإحصائيات المالية' : 'Financial Statistics'}
                    </h3>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <!-- إجمالي الموظفين -->
                    <div style="background: rgba(255,255,255,0.7); padding: 16px; border-radius: 12px; text-align: center; border: 2px solid rgba(245,158,11,0.3);">
                        <div style="font-size: 12px; color: #92400e; font-weight: 600; margin-bottom: 6px;">👥 ${t('totalEmployees')}</div>
                        <div style="font-size: 28px; font-weight: 800; color: #1f2937;">${monthEmployees.length}</div>
                        <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                            📅 ${monthlyEmps.length} • ⏰ ${dailyEmps.length} • 🚗 ${vehicleEmps.length}
                        </div>
                    </div>
                    
                    <!-- إجمالي USD -->
                    <div style="background: rgba(255,255,255,0.7); padding: 16px; border-radius: 12px; text-align: center; border: 2px solid rgba(34,197,94,0.3);">
                        <div style="font-size: 12px; color: #166534; font-weight: 600; margin-bottom: 6px;">💵 ${t('total')} USD</div>
                        <div style="font-size: 26px; font-weight: 800; color: #047857;">${formatCurrency(totalUSD)}</div>
                        <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">دولار أمريكي</div>
                    </div>
                    
                    <!-- إجمالي IQD -->
                    <div style="background: rgba(255,255,255,0.7); padding: 16px; border-radius: 12px; text-align: center; border: 2px solid rgba(59,130,246,0.3);">
                        <div style="font-size: 12px; color: #1e40af; font-weight: 600; margin-bottom: 6px;">💴 ${t('total')} IQD</div>
                        <div style="font-size: 26px; font-weight: 800; color: #1d4ed8;">${formatCurrency(totalIQD)}</div>
                        <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">دينار عراقي</div>
                    </div>
                </div>
                
                <!-- أدوات التحكم -->
                <div style="display: flex; gap: 12px; margin-top: 20px; justify-content: center; flex-wrap: wrap;">
                    <select onchange="changeProjectMonth(this.value)" 
                            style="padding: 12px 20px; border-radius: 10px; border: 2px solid #92400e; font-weight: 600; font-size: 14px; cursor: pointer; background: white; transition: all 0.3s; min-width: 180px;"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(146,64,14,0.2)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        ${months.map(m => {
                            const mData = (employeeData[currentYear] && employeeData[currentYear][m]) ? employeeData[currentYear][m] : [];
                            const count = mData.filter(emp => emp.project === currentProject).length;
                            return `<option value="${m}" ${m === selectedProjectMonth ? 'selected' : ''}>${t('monthNames')[m]} (${count})</option>`;
                        }).join('')}
                    </select>
                    <button class="btn btn-primary" onclick="openPrintOptionsModal()" 
                            style="padding: 12px 24px; font-weight: 700; font-size: 14px;">
                        🖨️ ${currentLang === 'ar' ? 'طباعة التقرير' : 'Print Report'}
                    </button>
                    <button class="btn ${isUnlocked ? 'btn-success' : 'btn-warning'}" 
                            onclick="openModal('bonusPasswordModal')" 
                            style="padding: 12px 24px; font-weight: 700; font-size: 14px;">
                        ${isUnlocked ? '🔓 المكافآت مفتوحة' : '🔒 فتح المكافآت'}
                    </button>
                    <button class="btn" onclick="saveCurrentFormatting()" 
                            style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; font-weight: 700; font-size: 14px;">
                        💾 ${currentLang === 'ar' ? 'حفظ التنسيق' : 'Save Format'}
                    </button>
                </div>
            </div>`;

            html += renderProjectSection(currentLang === 'ar' ? '📅 الموظفون الشهريون' : '📅 Monthly Employees', monthlyEmps, 'projectMonthlyTable');
            html += renderProjectSection(currentLang === 'ar' ? '📆 الموظفون اليوميون' : '📆 Daily Employees', dailyEmps, 'projectDailyTable');
            html += renderProjectSection(currentLang === 'ar' ? '🚗 السيارات' : '🚗 Vehicles', vehicleEmps, 'projectVehicleTable');
            return html;
        }

        function renderProjectSection(title, employees, tableId) {
            // التحقق من حالة القفل
            console.log('🔍 renderProjectSection - isUnlocked:', isUnlocked, 'type:', typeof isUnlocked);
            let sectionTotalUSD = 0, sectionTotalIQD = 0;
            employees.forEach(emp => {
                const netSalary = calculateNetSalary(emp, emp.month || currentMonth, emp.year || currentYear);
                if (emp.paymentCurrency === 'USD') {
                    sectionTotalUSD += netSalary;
                    sectionTotalIQD += netSalary * emp.exchangeRate;
                } else {
                    sectionTotalIQD += netSalary;
                    sectionTotalUSD += netSalary / emp.exchangeRate;
                }
            });

            let html = `<div class="table-container" style="margin-bottom: 35px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-radius: 16px; overflow-x: auto; overflow-y: hidden;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 28px; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="font-size: 20px; font-weight: 800; display: flex; align-items: center; gap: 10px;">
                        ${title}
                    </h3>
                    <span style="background: rgba(255,255,255,0.25); padding: 6px 16px; border-radius: 20px; font-size: 14px; font-weight: 700; box-shadow: 0 2px 6px rgba(0,0,0,0.15);">
                        ${employees.length} ${currentLang === 'ar' ? 'موظف' : 'employees'}
                    </span>
                </div>`;
            
            if (employees.length > 0) {
                const projectTableId = tableId || 'projectSectionTable';
                html += '<table id="' + projectTableId + '"><thead>';
                
                // تعريف أعمدة جدول المشروع
                const projectColumns = [
                    { dataColumn: 'number', label: '#' },
                    { dataColumn: 'name', label: t('name') },
                    { dataColumn: 'position', label: t('position') },
                    { dataColumn: 'salary', label: t('salary') },
                    { dataColumn: 'salaryCurrency', label: t('salaryCurrency') },
                    { dataColumn: 'paymentCurrency', label: t('paymentCurrency') },
                    { dataColumn: 'exchangeRate', label: t('exchangeRate') },
                    { dataColumn: 'attendance', label: `⏰ ${currentLang === 'ar' ? 'الدوام' : 'Attendance'}` },
                    { dataColumn: 'dailySalary', label: t('dailySalary') },
                    { dataColumn: 'actualSalaryUSD', label: t('actualSalaryUSD') },
                    { dataColumn: 'actualSalaryIQD', label: t('actualSalaryIQD') },
                    { dataColumn: 'bonus', label: t('bonus') },
                    { dataColumn: 'bonusCurrency', label: 'عملة' },
                    { dataColumn: 'phoneBills', label: t('phoneBills') },
                    { dataColumn: 'phoneBillsCurrency', label: 'عملة' },
                    { dataColumn: 'deductions', label: t('deductions') },
                    { dataColumn: 'deductionsCurrency', label: 'عملة' },
                    { dataColumn: 'advance', label: t('advance') },
                    { dataColumn: 'advanceCurrency', label: 'عملة' },
                    { dataColumn: 'salaryIncrease', label: `🔒 ${currentLang === 'ar' ? 'زيادة راتب' : 'Salary Inc.'}` },
                    { dataColumn: 'salaryIncreaseCurrency', label: 'عملة' },
                    { dataColumn: 'ceoBonus', label: `🔒 ${currentLang === 'ar' ? 'مكافأة CEO' : 'CEO Bonus'}` },
                    { dataColumn: 'ceoBonusCurrency', label: 'عملة' },
                    { dataColumn: 'netSalary', label: t('netSalary') }
                ];
                
                // إضافة صف صناديق التحديد
                html += createPinCheckboxRow(projectColumns, projectTableId, 'project');
                
                // إضافة رأس الجدول
                html += '<tr>';
                projectColumns.forEach(col => {
                    html += `<th data-column="${col.dataColumn}">${col.label}</th>`;
                });
                html += '</tr></thead><tbody>';

                employees.forEach((emp, index) => {
                    const monthData = (employeeData[currentYear] && employeeData[currentYear][selectedProjectMonth]) ? employeeData[currentYear][selectedProjectMonth] : [];
                    const globalIndex = monthData.indexOf(emp);
                    const dailySalaryUSD = calculateDailySalary(emp);
                    const actualSalaryUSD = calculateActualSalary(emp, selectedProjectMonth, currentYear);
                    const actualSalaryIQD = actualSalaryUSD * emp.exchangeRate;
                    const netSalary = calculateNetSalary(emp, selectedProjectMonth, currentYear);
                    const empName = currentLang === 'ar' ? emp.nameAr : emp.nameEn;
                    
                    html += `<tr>
                        <td>${index + 1}</td><td>${empName}</td><td>${emp.position}</td><td>${formatCurrency(emp.salary)}</td><td>${emp.salaryCurrency}</td><td>${emp.paymentCurrency}</td>
                        <td><input type="number" value="${emp.exchangeRate}" min="0" onchange="updateProjectField(${globalIndex}, 'exchangeRate', this.value)" style="width: 100%;"></td>
                        ${renderAttendanceCell(emp, globalIndex, '11px', selectedProjectMonth, currentYear)}
                        <td>${formatCurrency(dailySalaryUSD)}</td><td>${formatCurrency(actualSalaryUSD)}</td><td>${formatCurrency(actualSalaryIQD)}</td>
                        <td><input type="number" value="${emp.bonus || 0}" min="0" onchange="updateProjectField(${globalIndex}, 'bonus', this.value)" style="width: 100%;"></td>
                        <td><select onchange="updateProjectField(${globalIndex}, 'bonusCurrency', this.value)" style="width: 100%;">
                            <option value="USD" ${(emp.bonusCurrency || 'IQD') === 'USD' ? 'selected' : ''}>$</option>
                            <option value="IQD" ${(emp.bonusCurrency || 'IQD') === 'IQD' ? 'selected' : ''}>IQD</option>
                        </select></td>
                        <td><input type="number" value="${emp.phoneBills || 0}" min="0" onchange="updateProjectField(${globalIndex}, 'phoneBills', this.value)" style="width: 100%;"></td>
                        <td><select onchange="updateProjectField(${globalIndex}, 'phoneBillsCurrency', this.value)" style="width: 100%;">
                            <option value="USD" ${(emp.phoneBillsCurrency || 'IQD') === 'USD' ? 'selected' : ''}>$</option>
                            <option value="IQD" ${(emp.phoneBillsCurrency || 'IQD') === 'IQD' ? 'selected' : ''}>IQD</option>
                        </select></td>
                        <td><input type="number" value="${emp.deductions || 0}" min="0" onchange="updateProjectField(${globalIndex}, 'deductions', this.value)" style="width: 100%;"></td>
                        <td><select onchange="updateProjectField(${globalIndex}, 'deductionsCurrency', this.value)" style="width: 100%;">
                            <option value="USD" ${(emp.deductionsCurrency || 'IQD') === 'USD' ? 'selected' : ''}>$</option>
                            <option value="IQD" ${(emp.deductionsCurrency || 'IQD') === 'IQD' ? 'selected' : ''}>IQD</option>
                        </select></td>
                        <td><input type="number" value="${emp.advance || 0}" min="0" onchange="updateProjectField(${globalIndex}, 'advance', this.value)" style="width: 100%;"></td>
                        <td><select onchange="updateProjectField(${globalIndex}, 'advanceCurrency', this.value)" style="width: 100%;">
                            <option value="USD" ${(emp.advanceCurrency || 'IQD') === 'USD' ? 'selected' : ''}>$</option>
                            <option value="IQD" ${(emp.advanceCurrency || 'IQD') === 'IQD' ? 'selected' : ''}>IQD</option>
                        </select></td>
                        <td><input type="number" value="${emp.salaryIncrease || 0}" min="0" ${isUnlocked === true ? '' : 'disabled class="locked-field"'} 
                            onchange="updateProjectField(${globalIndex}, 'salaryIncrease', this.value)" style="width: 100%; ${isUnlocked === true ? '' : 'background: #fee2e2; border-color: #fca5a5; cursor: not-allowed;'}"></td>
                        <td><select ${isUnlocked === true ? '' : 'disabled class="locked-field"'} onchange="updateProjectField(${globalIndex}, 'salaryIncreaseCurrency', this.value)" style="width: 100%; ${isUnlocked === true ? '' : 'background: #fee2e2; border-color: #fca5a5; cursor: not-allowed;'}">
                            <option value="USD" ${(emp.salaryIncreaseCurrency || 'IQD') === 'USD' ? 'selected' : ''}>$</option>
                            <option value="IQD" ${(emp.salaryIncreaseCurrency || 'IQD') === 'IQD' ? 'selected' : ''}>IQD</option>
                        </select></td>
                        <td><input type="number" value="${emp.ceoBonus || 0}" min="0" ${isUnlocked === true ? '' : 'disabled class="locked-field"'} 
                            onchange="updateProjectField(${globalIndex}, 'ceoBonus', this.value)" style="width: 100%; ${isUnlocked === true ? '' : 'background: #fee2e2; border-color: #fca5a5; cursor: not-allowed;'}"></td>
                        <td><select ${isUnlocked === true ? '' : 'disabled class="locked-field"'} onchange="updateProjectField(${globalIndex}, 'ceoBonusCurrency', this.value)" style="width: 100%; ${isUnlocked === true ? '' : 'background: #fee2e2; border-color: #fca5a5; cursor: not-allowed;'}">
                            <option value="USD" ${(emp.ceoBonusCurrency || 'IQD') === 'USD' ? 'selected' : ''}>$</option>
                            <option value="IQD" ${(emp.ceoBonusCurrency || 'IQD') === 'IQD' ? 'selected' : ''}>IQD</option>
                        </select></td>
                        <td style="font-weight: bold; background: #dcfce7;">${formatCurrency(netSalary)} ${emp.paymentCurrency}</td>
                    </tr>`;
                });

                html += '</tbody></table>';
                html += `
                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px 28px; border-radius: 0 0 14px 14px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 24px; border: 3px solid #fbbf24; border-top: 3px solid #f59e0b; box-shadow: inset 0 2px 8px rgba(245,158,11,0.15);">
                    <!-- عدد الموظفين -->
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 10px; border: 2px solid rgba(245,158,11,0.2);">
                        <div style="font-size: 13px; color: #92400e; font-weight: 700; margin-bottom: 6px;">👥 ${t('totalEmployees')}</div>
                        <div style="font-size: 32px; font-weight: 800; color: #1f2937; line-height: 1;">${employees.length}</div>
                        <div style="font-size: 10px; color: #6b7280; margin-top: 4px; font-weight: 500;">موظف</div>
                    </div>
                    
                    <!-- إجمالي دولار -->
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 10px; border: 2px solid rgba(34,197,94,0.3);">
                        <div style="font-size: 13px; color: #166534; font-weight: 700; margin-bottom: 6px;">💵 ${t('total')} USD</div>
                        <div style="font-size: 28px; font-weight: 800; color: #047857; line-height: 1; direction: ltr;">${formatCurrency(sectionTotalUSD)}</div>
                        <div style="font-size: 10px; color: #6b7280; margin-top: 4px; font-weight: 500;">دولار</div>
                    </div>
                    
                    <!-- إجمالي دينار -->
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 10px; border: 2px solid rgba(59,130,246,0.3);">
                        <div style="font-size: 13px; color: #1e40af; font-weight: 700; margin-bottom: 6px;">💴 ${t('total')} IQD</div>
                        <div style="font-size: 28px; font-weight: 800; color: #1d4ed8; line-height: 1; direction: ltr;">${formatCurrency(sectionTotalIQD)}</div>
                        <div style="font-size: 10px; color: #6b7280; margin-top: 4px; font-weight: 500;">دينار</div>
                    </div>
                </div>`;
            } else {
                html += `
                <div style="background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); padding: 40px; border-radius: 0 0 14px 14px; text-align: center; border: 2px dashed #cbd5e1; border-top: none;">
                    <div style="font-size: 48px; margin-bottom: 12px; opacity: 0.5;">📭</div>
                    <p style="font-size: 16px; color: #64748b; font-weight: 600; margin: 0;">
                        ${currentLang === 'ar' ? 'لا يوجد موظفين في هذا القسم' : 'No Employees in this section'}
                    </p>
                </div>`;
            }
            html += '</div>';
            return html;
        }

        function changeProjectMonth(month) {
            selectedProjectMonth = month;
            currentMonth = month;
            renderContent();
        }

        function switchProject(projectCode) {
            if (!projectCode || projectCode === currentProject) return;

            if (!hasProjectAccess(projectCode)) {
                showNotification('error', t('notAuthorized'), t('noProjectAccess'));
                return;
            }

            currentProject = projectCode;
            currentMonth = selectedProjectMonth;
            currentView = 'project';
            renderContent();
            console.log(`🏗️ تم الانتقال إلى المشروع: ${projectCode}`);
        }
// ========== Employee Actions ==========
        function toggleEmployeeSelection(index) {
            // التحقق من قفل الشهر
            if (!canEditCurrentMonth()) {
                showNotification('warning', t('warning'), t('monthLocked'));
                return;
            }
            
            if (selectedEmployees.has(index)) {
                selectedEmployees.delete(index);
            } else {
                selectedEmployees.add(index);
            }
            renderContent();
        }

        function toggleSelectAll() {
            // التحقق من قفل الشهر
            if (!canEditCurrentMonth()) {
                showNotification('warning', t('warning'), t('monthLocked'));
                return;
            }
            
            const allEmployees = (employeeData[currentYear] && employeeData[currentYear][currentMonth]) ? employeeData[currentYear][currentMonth] : [];
            if (selectedEmployees.size === allEmployees.length) {
                selectedEmployees.clear();
            } else {
                selectedEmployees.clear();
                allEmployees.forEach((_, idx) => selectedEmployees.add(idx));
            }
            renderContent();
        }

        async function deleteSelectedEmployees() {
            // التحقق من قفل الشهر
            if (!canEditCurrentMonth()) {
                showNotification('warning', t('warning'), t('monthLocked'));
                return;
            }
            
            if (selectedEmployees.size === 0) return;
            if (confirm(currentLang === 'ar' ? `هل تريد حذف ${selectedEmployees.size} موظف؟` : `Delete ${selectedEmployees.size} employees?`)) {
                showLoading();
                const sortedIndices = Array.from(selectedEmployees).sort((a, b) => b - a);
                for (const index of sortedIndices) {
                    const emp = employeeData[currentYear][currentMonth][index];
                    if (emp.firebaseId) {
                        await deleteEmployeeFromFirebase(emp.firebaseId);
                    }
                }
                selectedEmployees.clear();
                hideLoading();
            }
        }

        function moveEmployeeUp(index) {
            if (index > 0) {
                const temp = employeeData[currentYear][currentMonth][index];
                employeeData[currentYear][currentMonth][index] = employeeData[currentYear][currentMonth][index - 1];
                employeeData[currentYear][currentMonth][index - 1] = temp;
                renderContent();
            }
        }

        function moveEmployeeDown(index) {
            if (index < employeeData[currentYear][currentMonth].length - 1) {
                const temp = employeeData[currentYear][currentMonth][index];
                employeeData[currentYear][currentMonth][index] = employeeData[currentYear][currentMonth][index + 1];
                employeeData[currentYear][currentMonth][index + 1] = temp;
                renderContent();
            }
        }

        // Drag and Drop
        let draggedIndex = null;

        function handleDragStart(e) {
            // تجنب بدء السحب عند النقر على الأزرار أو العناصر التفاعلية
            if (e.target.closest('button') || e.target.closest('select') || e.target.closest('input') || e.target.closest('a')) {
                e.preventDefault();
                return false;
            }
            
            const row = e.target.closest('tr');
            if (!row || row.dataset.index === undefined) {
                e.preventDefault();
                return false;
            }
            
            draggedIndex = parseInt(row.dataset.index);
            if (isNaN(draggedIndex) || draggedIndex < 0) {
                e.preventDefault();
                return false;
            }
            
            row.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedIndex.toString());
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'move';
            const targetRow = e.target.closest('tr');
            if (targetRow && targetRow.dataset.index !== undefined) {
                const targetIndex = parseInt(targetRow.dataset.index);
                // لا تظهر drag-over إذا كانت نفس الصف
                if (draggedIndex !== null && draggedIndex !== targetIndex) {
                document.querySelectorAll('#employeeTableBody tr').forEach(row => row.classList.remove('drag-over'));
                targetRow.classList.add('drag-over');
                } else {
                    document.querySelectorAll('#employeeTableBody tr').forEach(row => row.classList.remove('drag-over'));
                }
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            const targetRow = e.target.closest('tr');
            if (targetRow && targetRow.dataset.index !== undefined) {
                const targetIndex = parseInt(targetRow.dataset.index);
                if (draggedIndex !== null && draggedIndex !== targetIndex && draggedIndex >= 0 && targetIndex >= 0) {
                    // التحقق من وجود البيانات
                    if (!employeeData[currentYear] || !employeeData[currentYear][currentMonth]) {
                        console.error('❌ لا توجد بيانات للشهر المحدد');
                        return;
                    }
                    if (draggedIndex >= employeeData[currentYear][currentMonth].length || targetIndex >= employeeData[currentYear][currentMonth].length) {
                        console.error('❌ فهرس غير صحيح');
                        return;
                    }
                    
                    const draggedEmp = employeeData[currentYear][currentMonth][draggedIndex];
                    employeeData[currentYear][currentMonth].splice(draggedIndex, 1);
                    const newTargetIndex = draggedIndex < targetIndex ? targetIndex - 1 : targetIndex;
                    employeeData[currentYear][currentMonth].splice(newTargetIndex, 0, draggedEmp);
                    
                    // تحديث الترتيب في Firebase إذا كان هناك firebaseId
                    if (draggedEmp.firebaseId) {
                        updateEmployeeInFirebase(draggedEmp.firebaseId, { order: newTargetIndex }).catch(err => {
                            console.error('❌ خطأ في تحديث الترتيب:', err);
                        });
                    }
                    
                    renderContent();
                }
            }
            document.querySelectorAll('#employeeTableBody tr').forEach(row => row.classList.remove('drag-over'));
            draggedIndex = null;
        }

        function handleDragEnd(e) {
            const row = e.target.closest('tr');
            if (row) {
                row.classList.remove('dragging');
            }
            document.querySelectorAll('#employeeTableBody tr').forEach(row => {
                row.classList.remove('drag-over');
                row.classList.remove('dragging');
            });
            draggedIndex = null;
        }

        // Field Updates
        async function updateField(index, field, value) {
            const emp = employeeData[currentYear][currentMonth][index];
            
            // التحقق من حالة الدفع - منع التعديل إذا تم الدفع
            if (emp.isPaid === true) {
                showNotification('error', currentLang === 'ar' ? 'تم الدفع' : 'Paid', currentLang === 'ar' ? '⚠️ لا يمكن تعديل بيانات الموظف الذي تم الدفع له' : '⚠️ Cannot edit paid employee data');
                return;
            }
            
            if (field.includes('Currency')) {
                emp[field] = value;
            } else {
                emp[field] = parseFloat(value) || 0;
            }
            
            // إعادة حساب المبلغ المحجوز تلقائياً إذا كان الحجز مفعلاً
            // وذلك عند تعديل أي حقل يؤثر على الراتب الصافي
            const fieldsAffectingSalary = ['salary', 'bonus', 'phoneBills', 'deductions', 'advance', 'ceoBonus', 
                                          'salaryIncrease', 'exchangeRate', 'bonusCurrency', 'phoneBillsCurrency', 
                                          'deductionsCurrency', 'advanceCurrency', 'ceoBonusCurrency', 'salaryIncreaseCurrency'];
            
            if (emp.salaryReservationEnabled && fieldsAffectingSalary.includes(field)) {
                const netBeforeReservation = calculateActualSalary(emp, currentMonth, currentYear);
                const netInPaymentCurrency = convertToPaymentCurrency(netBeforeReservation, 'USD', emp);
                const bonus = convertToPaymentCurrency(emp.bonus || 0, emp.bonusCurrency || 'IQD', emp);
                const phoneBills = convertToPaymentCurrency(emp.phoneBills || 0, emp.phoneBillsCurrency || 'IQD', emp);
                const ceoBonus = convertToPaymentCurrency(emp.ceoBonus || 0, emp.ceoBonusCurrency || 'IQD', emp);
                const deductions = convertToPaymentCurrency(emp.deductions || 0, emp.deductionsCurrency || 'IQD', emp);
                const advance = convertToPaymentCurrency(emp.advance || 0, emp.advanceCurrency || 'IQD', emp);
                const netSalary = netInPaymentCurrency + bonus + phoneBills + ceoBonus - deductions - advance;
                
                const reservation = calculateReservation(emp, netSalary, currentMonth, currentYear);
                emp.reservedAmount = reservation.actual;
            }
            
            const updates = { [field]: emp[field] };
            if (emp.salaryReservationEnabled && fieldsAffectingSalary.includes(field)) {
                updates.reservedAmount = emp.reservedAmount;
            }
            
            if (emp.firebaseId) {
                await updateEmployeeInFirebase(emp.firebaseId, updates);
            }
            renderContent();
        }
        
        // ========== Payment Status Functions ==========
        async function togglePaymentStatus(index) {
            try {
                const emp = employeeData[currentYear][currentMonth][index];
                if (!emp) {
                    showNotification('error', t('error'), t('employeeNotFound'));
                    return;
                }
                
                // إذا كان الموظف غير مدفوع، افتح نافذة تفاصيل الدفع
                if (!emp.isPaid) {
                    openPaymentDetailsModal(index);
                    return;
                }
                
                // إذا كان الموظف مدفوعاً، قم بإلغاء الدفع مباشرة
                const confirmMsg = currentLang === 'ar' 
                    ? 'هل أنت متأكد من إلغاء حالة الدفع لهذا الموظف؟'
                    : 'Are you sure you want to mark this employee as unpaid?';
                
                if (!confirm(confirmMsg)) return;
                
                showLoading();
                
                const updates = {
                    isPaid: false,
                    paidDate: null,
                    paymentMethod: null,
                    paymentNotes: null
                };
                
                if (emp.firebaseId) {
                    await updateEmployeeInFirebase(emp.firebaseId, updates, {
                        skipReload: false,
                        skipLoading: true,
                        skipNotification: true,
                        skipActivityLog: false
                    });
                } else {
                    emp.isPaid = false;
                    emp.paidDate = null;
                    emp.paymentMethod = null;
                    emp.paymentNotes = null;
                }
                
                hideLoading();
                showNotification('success', t('success'), t('paymentSuccess'));
                renderContent();
            } catch (error) {
                console.error('Error toggling payment status:', error);
                hideLoading();
                showNotification('error', t('error'), t('paymentError'));
            }
        }
        
        function setPaymentFilter(filter) {
            paymentFilter = filter;
            renderContent();
        }
        
        function setReservationFilter(filter) {
            reservationFilter = filter;
            renderContent();
        }
        
        async function bulkMarkAsPaid() {
            if (selectedEmployees.size === 0) {
                showNotification('warning', t('warning'), t('noEmployeesSelected'));
                return;
            }
            
            // تحديث النصوص ديناميكياً
            document.getElementById('bulkPaymentModalTitle').textContent = '💳 ' + t('bulkPayment');
            document.getElementById('bulkPaymentDateLabel').textContent = t('paidDate') + ':';
            document.getElementById('bulkPaymentMethodLabel').textContent = t('paymentMethod') + ':';
            document.getElementById('bulkPaymentNotesLabel').textContent = t('paymentNotes') + ':';
            document.getElementById('bulkPaymentCancelBtn').textContent = t('cancel');
            document.getElementById('bulkPaymentSaveBtn').textContent = '✅ ' + t('markSelectedAsPaid');
            
            // تحديث خيارات طريقة الدفع
            document.getElementById('bulkPaymentMethodCash').textContent = t('cash');
            document.getElementById('bulkPaymentMethodTransfer').textContent = t('transfer');
            document.getElementById('bulkPaymentMethodCheck').textContent = t('check');
            document.getElementById('bulkPaymentMethodOther').textContent = t('other');
            
            // تحديث placeholder
            document.getElementById('bulkPaymentNotes').placeholder = currentLang === 'ar' ? 'ملاحظات الدفع الجماعي...' : 'Bulk payment notes...';
            
            // تحديث نص عدد الموظفين
            const countText = currentLang === 'ar' ? 'عدد الموظفين المحددين:' : 'Selected Employees:';
            const countTextElement = document.getElementById('bulkPaymentCountText');
            if (countTextElement) {
                countTextElement.innerHTML = `<strong style="color: #1e40af;">${countText} <span id="bulkPaymentCountValue">${selectedEmployees.size}</span></strong>`;
            } else {
            document.getElementById('bulkPaymentCountValue').textContent = selectedEmployees.size;
            }
            
            // عرض نافذة لتحديد تاريخ الدفع والملاحظات
            document.getElementById('bulkPaymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('bulkPaymentMethod').value = 'cash';
            document.getElementById('bulkPaymentNotes').value = '';
            openModal('bulkPaymentModal');
        }
        
        async function confirmBulkPayment() {
            const count = selectedEmployees.size;
            if (count === 0) {
                showNotification('warning', t('warning'), t('noEmployeesSelected'));
                closeModal('bulkPaymentModal');
                return;
            }
            
            try {
                showLoading();
                const paidDate = document.getElementById('bulkPaymentDate').value;
                const paymentMethod = document.getElementById('bulkPaymentMethod').value;
                const paymentNotes = document.getElementById('bulkPaymentNotes').value;
                
                const updates = {
                    isPaid: true,
                    paidDate: paidDate ? new Date(paidDate).toISOString() : new Date().toISOString(),
                    paymentMethod: paymentMethod,
                    paymentNotes: paymentNotes || null
                };
                
                const employees = employeeData[currentYear][currentMonth];
                let updatedCount = 0;
                const updatePromises = [];
                
                // تحديث جميع الموظفين في نفس الوقت (بدون إعادة تحميل)
                for (const index of selectedEmployees) {
                    const emp = employees[index];
                    if (emp && emp.firebaseId) {
                        updatePromises.push(
                            updateEmployeeInFirebase(emp.firebaseId, updates, {
                                skipReload: true,
                                skipLoading: true,
                                skipNotification: true,
                                skipActivityLog: false
                            }).catch(err => {
                                console.error(`Error updating employee ${emp.firebaseId}:`, err);
                                return null;
                            })
                        );
                        updatedCount++;
                    } else if (emp) {
                        emp.isPaid = true;
                        emp.paidDate = updates.paidDate;
                        emp.paymentMethod = updates.paymentMethod;
                        emp.paymentNotes = updates.paymentNotes;
                        updatedCount++;
                    }
                }
                
                // انتظار اكتمال جميع التحديثات
                await Promise.all(updatePromises);
                
                // إعادة تحميل البيانات مرة واحدة فقط
                await loadEmployeesFromFirebase();
                
                hideLoading();
                closeModal('bulkPaymentModal');
                showNotification('success', t('success'), t('bulkPaymentSuccess').replace('{count}', updatedCount));
                selectedEmployees.clear();
                renderContent();
            } catch (error) {
                console.error('Error in bulk mark as paid:', error);
                hideLoading();
                closeModal('bulkPaymentModal');
                showNotification('error', t('error'), t('bulkPaymentError'));
            }
        }
        
        async function bulkMarkAsUnpaid() {
            if (selectedEmployees.size === 0) {
                showNotification('warning', t('warning'), t('noEmployeesSelected'));
                return;
            }
            
            const count = selectedEmployees.size;
            const confirmMsg = t('confirmBulkPayment').replace('{count}', count);
            if (!confirm(confirmMsg)) return;
            
            try {
                showLoading();
                const updates = {
                    isPaid: false,
                    paidDate: null,
                    paymentMethod: null,
                    paymentNotes: null
                };
                
                const employees = employeeData[currentYear][currentMonth];
                let updatedCount = 0;
                const updatePromises = [];
                
                // تحديث جميع الموظفين في نفس الوقت (بدون إعادة تحميل)
                for (const index of selectedEmployees) {
                    const emp = employees[index];
                    if (emp && emp.firebaseId) {
                        updatePromises.push(
                            updateEmployeeInFirebase(emp.firebaseId, updates, {
                                skipReload: true,
                                skipLoading: true,
                                skipNotification: true,
                                skipActivityLog: false
                            }).catch(err => {
                                console.error(`Error updating employee ${emp.firebaseId}:`, err);
                                return null;
                            })
                        );
                        updatedCount++;
                    } else if (emp) {
                        emp.isPaid = false;
                        emp.paidDate = null;
                        emp.paymentMethod = null;
                        emp.paymentNotes = null;
                        updatedCount++;
                    }
                }
                
                // انتظار اكتمال جميع التحديثات
                await Promise.all(updatePromises);
                
                // إعادة تحميل البيانات مرة واحدة فقط
                await loadEmployeesFromFirebase();
                
                hideLoading();
                showNotification('success', t('success'), t('bulkPaymentSuccess').replace('{count}', updatedCount));
                selectedEmployees.clear();
                renderContent();
            } catch (error) {
                console.error('Error in bulk mark as unpaid:', error);
                hideLoading();
                showNotification('error', t('error'), t('bulkPaymentError'));
            }
        }
        
        function openPaymentDetailsModal(index) {
            const emp = employeeData[currentYear][currentMonth][index];
            if (!emp) {
                showNotification('error', t('error'), t('employeeNotFound'));
                return;
            }
            
            employeeIndexToEdit = index;
            
            // تحديث النصوص ديناميكياً
            document.getElementById('paymentDetailsModalTitle').textContent = '💳 ' + t('paymentDetails');
            document.getElementById('paymentPaidDateLabel').textContent = t('paidDate') + ':';
            document.getElementById('paymentMethodLabel').textContent = t('paymentMethod') + ':';
            document.getElementById('paymentNotesLabel').textContent = t('paymentNotes') + ':';
            document.getElementById('paymentDetailsCancelBtn').textContent = t('cancel');
            document.getElementById('paymentDetailsSaveBtn').textContent = t('save');
            
            // تحديث خيارات طريقة الدفع
            document.getElementById('paymentMethodCash').textContent = t('cash');
            document.getElementById('paymentMethodTransfer').textContent = t('transfer');
            document.getElementById('paymentMethodCheck').textContent = t('check');
            document.getElementById('paymentMethodOther').textContent = t('other');
            
            // تحديث placeholder
            document.getElementById('paymentNotes').placeholder = currentLang === 'ar' ? 'أدخل أي ملاحظات إضافية...' : 'Enter any additional notes...';
            
            // ملء الحقول
            const paidDateValue = emp.paidDate ? new Date(emp.paidDate).toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
            document.getElementById('paymentPaidDate').value = paidDateValue;
            document.getElementById('paymentMethod').value = emp.paymentMethod || 'cash';
            document.getElementById('paymentNotes').value = emp.paymentNotes || '';
            
            openModal('paymentDetailsModal');
        }
        
        async function savePaymentDetails() {
            const index = employeeIndexToEdit;
            if (index === null || index === undefined) return;
            
            const emp = employeeData[currentYear][currentMonth][index];
            if (!emp) {
                showNotification('error', t('error'), t('employeeNotFound'));
                return;
            }
            
            try {
                showLoading();
                const paidDate = document.getElementById('paymentPaidDate').value;
                const paymentMethod = document.getElementById('paymentMethod').value;
                const paymentNotes = document.getElementById('paymentNotes').value;
                
                const updates = {
                    isPaid: true,
                    paidDate: paidDate ? new Date(paidDate).toISOString() : new Date().toISOString(),
                    paymentMethod: paymentMethod,
                    paymentNotes: paymentNotes
                };
                
                if (emp.firebaseId) {
                    await updateEmployeeInFirebase(emp.firebaseId, updates, {
                        skipReload: false,
                        skipLoading: true,
                        skipNotification: true,
                        skipActivityLog: false
                    });
                } else {
                    Object.assign(emp, updates);
                }
                
                hideLoading();
                showNotification('success', t('success'), t('paymentSuccess'));
                closeModal('paymentDetailsModal');
                renderContent();
            } catch (error) {
                console.error('Error saving payment details:', error);
                hideLoading();
                showNotification('error', t('error'), t('paymentError'));
            }
        }
        
        // ========== Salary Reservation Functions ==========
        let employeeIndexForReservation = null;
        
        function openReservationModal(index) {
            employeeIndexForReservation = index;
            const emp = employeeData[currentYear][currentMonth][index];
            if (!emp) {
                showNotification('error', t('error'), t('employeeNotFound'));
                return;
            }
            
            // التحقق من حالة الدفع - منع تعديل الحجز إذا تم الدفع
            if (emp.isPaid === true) {
                const paidDate = emp.paidDate ? new Date(emp.paidDate).toLocaleDateString(currentLang === 'ar' ? 'ar-EG' : 'en-US') : '';
                const message = currentLang === 'ar' 
                    ? `⚠️ لا يمكن تعديل حجز الموظف الذي تم الدفع له${paidDate ? ' في ' + paidDate : ''}`
                    : `⚠️ Cannot edit reservation for employee who has been paid${paidDate ? ' on ' + paidDate : ''}`;
                showNotification('error', currentLang === 'ar' ? 'تم الدفع' : 'Paid', message);
                return;
            }
            
            // تحديث النصوص ديناميكياً
            document.getElementById('reservationModalTitle').textContent = '💰 ' + t('salaryReservation');
            document.getElementById('reservationEnabledLabel').textContent = t('reservationEnabled');
            document.getElementById('reservationPercentageLabel').textContent = t('reservationPercentage') + ':';
            document.getElementById('previousReservedAmountLabel').textContent = t('previousReservedAmount') + ':';
            document.getElementById('targetReservedAmountLabel').textContent = t('targetReservedAmount') + ':';
            document.getElementById('reservationCurrencyLabel').textContent = t('reservationCurrency') + ':';
            document.getElementById('reservationNotesLabel').textContent = t('reservationNotes') + ':';
            document.getElementById('reservationCancelBtn').textContent = t('cancel');
            document.getElementById('reservationSaveBtn').textContent = t('save');
            
            // تحديث الملاحظات
            document.getElementById('previousReservedAmountNote').textContent = currentLang === 'ar' ? 'رصيد الحجز من الأشهر التي لم يتم حفظها في قاعدة البيانات' : 'Reservation balance from months not saved in database';
            document.getElementById('accumulatedReservedAmountNote').textContent = currentLang === 'ar' ? 'يتم حسابه تلقائياً من الأشهر السابقة في قاعدة البيانات' : 'Calculated automatically from previous months in database';
            document.getElementById('targetReservedAmountNote').textContent = currentLang === 'ar' ? 'يُحسب تلقائياً من الراتب الأساسي' : 'Calculated automatically from basic salary';
            document.getElementById('reservationNotes').placeholder = currentLang === 'ar' ? 'ملاحظات إضافية...' : 'Additional notes...';
            
            // حساب الحجز التراكمي من الأشهر السابقة في قاعدة البيانات
            const accumulatedReservation = calculateAccumulatedReservation(emp, currentMonth, currentYear);
            
            // ملء الحقول
            // استخدام الإعدادات العامة إذا كانت مفعّلة
            const globalEnabled = companySettings.globalReservationEnabled || false;
            document.getElementById('reservationEnabled').checked = emp.salaryReservationEnabled !== undefined ? emp.salaryReservationEnabled : globalEnabled;
            
            // استخدام الإعدادات العامة إذا كانت مفعّلة
            if (globalEnabled && !emp.reservationPercentage) {
                if (companySettings.globalReservationType === 'percentage') {
                    document.getElementById('reservationPercentage').value = companySettings.globalReservationPercentage || 10;
                } else {
                    // إذا كان المبلغ ثابت، نحسب النسبة من الراتب الصافي
                    const netBeforeReservation = calculateActualSalary(emp, currentMonth, currentYear);
                    const netInPaymentCurrency = convertToPaymentCurrency(netBeforeReservation, 'USD', emp);
                    const bonus = convertToPaymentCurrency(emp.bonus || 0, emp.bonusCurrency || 'IQD', emp);
                    const phoneBills = convertToPaymentCurrency(emp.phoneBills || 0, emp.phoneBillsCurrency || 'IQD', emp);
                    const ceoBonus = convertToPaymentCurrency(emp.ceoBonus || 0, emp.ceoBonusCurrency || 'IQD', emp);
                    const deductions = convertToPaymentCurrency(emp.deductions || 0, emp.deductionsCurrency || 'IQD', emp);
                    const advance = convertToPaymentCurrency(emp.advance || 0, emp.advanceCurrency || 'IQD', emp);
                    const netSalary = netInPaymentCurrency + bonus + phoneBills + ceoBonus - deductions - advance;
                    const percentage = netSalary > 0 ? (companySettings.globalReservationAmount / netSalary) * 100 : 0;
                    document.getElementById('reservationPercentage').value = percentage.toFixed(2);
                }
            } else {
            document.getElementById('reservationPercentage').value = emp.reservationPercentage || 10;
            }
            
            // الرصيد السابق (من أشهر غير موجودة في قاعدة البيانات)
            document.getElementById('previousReservedAmount').value = (emp.previousReservedAmount || 0).toFixed(2);
            // المبلغ المحجوز من قاعدة البيانات (للعرض فقط)
            document.getElementById('accumulatedReservedAmount').value = accumulatedReservation.toFixed(2);
            document.getElementById('reservationCurrency').value = emp.reservationCurrency || emp.paymentCurrency || 'IQD';
            document.getElementById('reservationNotes').value = emp.reservationNotes || '';
            
            // حساب الهدف تلقائياً
            const target = calculateTargetReservation(emp);
            document.getElementById('targetReservedAmount').value = target.toFixed(2);
            
            toggleReservationEnabled();
            updateReservationCalculation();
            openModal('reservationModal');
        }
        
        function toggleReservationEnabled() {
            const enabled = document.getElementById('reservationEnabled').checked;
            document.getElementById('reservationSettings').style.display = enabled ? 'block' : 'none';
            if (enabled) {
                updateReservationCalculation();
            }
        }
        
        function updateReservationCalculation() {
            const index = employeeIndexForReservation;
            if (index === null || index === undefined) return;
            
            const emp = employeeData[currentYear][currentMonth][index];
            if (!emp) return;
            
            const enabled = document.getElementById('reservationEnabled').checked;
            if (!enabled) return;
            
            const percentage = parseFloat(document.getElementById('reservationPercentage').value) || 0;
            // الرصيد السابق (من أشهر غير موجودة في قاعدة البيانات)
            const previousReserved = parseFloat(document.getElementById('previousReservedAmount').value) || 0;
            // المبلغ المحجوز من قاعدة البيانات
            const accumulatedReserved = parseFloat(document.getElementById('accumulatedReservedAmount').value) || 0;
            // الإجمالي = الرصيد السابق + المبلغ المحجوز من قاعدة البيانات
            const totalPreviousReserved = previousReserved + accumulatedReserved;
            const target = parseFloat(document.getElementById('targetReservedAmount').value) || 0;
            
            // حساب الراتب الصافي قبل الحجز
            const netBeforeReservation = calculateActualSalary(emp, currentMonth, currentYear);
            const netInPaymentCurrency = convertToPaymentCurrency(netBeforeReservation, 'USD', emp);
            const bonus = convertToPaymentCurrency(emp.bonus || 0, emp.bonusCurrency || 'IQD', emp);
            const phoneBills = convertToPaymentCurrency(emp.phoneBills || 0, emp.phoneBillsCurrency || 'IQD', emp);
            const ceoBonus = convertToPaymentCurrency(emp.ceoBonus || 0, emp.ceoBonusCurrency || 'IQD', emp);
            const deductions = convertToPaymentCurrency(emp.deductions || 0, emp.deductionsCurrency || 'IQD', emp);
            const advance = convertToPaymentCurrency(emp.advance || 0, emp.advanceCurrency || 'IQD', emp);
            const netSalary = netInPaymentCurrency + bonus + phoneBills + ceoBonus - deductions - advance;
            
            // حساب الحجز - لا يتجاوز الراتب الأساسي (الهدف)
            const requestedAmount = netSalary * (percentage / 100);
            // الحجز الفعلي = الحد الأدنى بين: المطلوب، الراتب الصافي، والفرق بين الهدف والمحجوز سابقاً (الرصيد السابق + المحجوز من قاعدة البيانات)
            const remainingToTarget = Math.max(0, target - totalPreviousReserved);
            const maxAllowedReservation = Math.min(netSalary, remainingToTarget);
            const actualReservation = Math.min(requestedAmount, maxAllowedReservation);
            const shortage = requestedAmount - actualReservation;
            const totalReserved = totalPreviousReserved + actualReservation;
            const progress = target > 0 ? (totalReserved / target) * 100 : 0;
            const remaining = Math.max(0, target - totalReserved);
            
            // عرض النتائج
            const calcDetails = document.getElementById('reservationCalcDetails');
            const isArabic = currentLang === 'ar';
            calcDetails.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                    <div><strong>${isArabic ? 'الراتب الصافي:' : 'Net Salary:'}</strong> ${formatCurrency(netSalary)}</div>
                    <div><strong>${isArabic ? 'المبلغ المطلوب:' : 'Requested:'}</strong> ${formatCurrency(requestedAmount)}</div>
                    <div><strong>${isArabic ? 'المبلغ المتاح:' : 'Available:'}</strong> ${formatCurrency(netSalary)}</div>
                    <div><strong>${isArabic ? 'المبلغ المحجوز فعلياً:' : 'Actual Reserved:'}</strong> ${formatCurrency(actualReservation)}</div>
                </div>
                ${shortage > 0 ? `
                <div style="background: #fef3c7; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 2px solid #f59e0b;">
                    <strong style="color: #92400e;">⚠️ ${t('reservationWarning')}</strong><br>
                    <span style="color: #78350f;">${t('reservationShortageAmount')}: ${formatCurrency(shortage)}</span>
                </div>
                ` : ''}
                <div style="background: #dbeafe; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 2px solid #3b82f6;">
                    <strong style="color: #1e40af;">${isArabic ? 'إجمالي المحجوز:' : 'Total Reserved:'}</strong> ${formatCurrency(totalReserved)} / ${formatCurrency(target)}<br>
                    <strong style="color: #1e40af;">${isArabic ? 'التقدم:' : 'Progress:'}</strong> ${Math.round(progress)}%<br>
                    <strong style="color: #1e40af;">${isArabic ? 'المتبقي:' : 'Remaining:'}</strong> ${formatCurrency(remaining)}
                </div>
            `;
        }
        
        async function saveReservation() {
            const index = employeeIndexForReservation;
            if (index === null || index === undefined) return;
            
            const emp = employeeData[currentYear][currentMonth][index];
            if (!emp) {
                showNotification('error', t('error'), t('employeeNotFound'));
                return;
            }
            
            try {
                showLoading();
                const enabled = document.getElementById('reservationEnabled').checked;
                const percentage = parseFloat(document.getElementById('reservationPercentage').value) || 0;
                const previousReserved = parseFloat(document.getElementById('previousReservedAmount').value) || 0;
                const target = parseFloat(document.getElementById('targetReservedAmount').value) || calculateTargetReservation(emp);
                const currency = document.getElementById('reservationCurrency').value;
                const notes = document.getElementById('reservationNotes').value;
                
                // حساب المبلغ المحجوز لهذا الشهر
                const netBeforeReservation = calculateActualSalary(emp, currentMonth, currentYear);
                const netInPaymentCurrency = convertToPaymentCurrency(netBeforeReservation, 'USD', emp);
                const bonus = convertToPaymentCurrency(emp.bonus || 0, emp.bonusCurrency || 'IQD', emp);
                const phoneBills = convertToPaymentCurrency(emp.phoneBills || 0, emp.phoneBillsCurrency || 'IQD', emp);
                const ceoBonus = convertToPaymentCurrency(emp.ceoBonus || 0, emp.ceoBonusCurrency || 'IQD', emp);
                const deductions = convertToPaymentCurrency(emp.deductions || 0, emp.deductionsCurrency || 'IQD', emp);
                const advance = convertToPaymentCurrency(emp.advance || 0, emp.advanceCurrency || 'IQD', emp);
                const netSalary = netInPaymentCurrency + bonus + phoneBills + ceoBonus - deductions - advance;
                
                // حساب الحجز التراكمي من الأشهر السابقة (يجب استخدام القيمة المحسوبة وليس المدخلة)
                const accumulatedReservation = calculateAccumulatedReservation(emp, currentMonth, currentYear);
                
                const requestedAmount = netSalary * (percentage / 100);
                // الحجز الفعلي = الحد الأدنى بين: المطلوب، الراتب الصافي، والفرق بين الهدف والمحجوز سابقاً
                const remainingToTarget = Math.max(0, target - accumulatedReservation);
                const maxAllowedReservation = Math.min(netSalary, remainingToTarget);
                const actualReservation = Math.min(requestedAmount, maxAllowedReservation);
                
                // حفظ الحجز
                // previousReservedAmount: حقل يدوي للمستخدم لإدخال الرصيد من الأشهر التي ليست في قاعدة البيانات
                // accumulatedReservation: يُحسب تلقائياً من قاعدة البيانات (لا يُحفظ، يُحسب في كل مرة)
                // reservedAmount: المبلغ المحجوز للشهر الحالي
                const updates = {
                    salaryReservationEnabled: enabled,
                    reservationPercentage: enabled ? percentage : 0,
                    previousReservedAmount: enabled ? previousReserved : 0, // حفظ القيمة اليدوية التي أدخلها المستخدم
                    reservedAmount: enabled ? actualReservation : 0,
                    targetReservedAmount: enabled ? target : 0,
                    reservationCurrency: enabled ? currency : null,
                    reservationNotes: notes || null
                };
                
                if (emp.firebaseId) {
                    await updateEmployeeInFirebase(emp.firebaseId, updates);
                } else {
                    Object.assign(emp, updates);
                }
                
                hideLoading();
                showNotification('success', t('success'), t('reservationSuccess'));
                closeModal('reservationModal');
                renderContent();
            } catch (error) {
                console.error('Error saving reservation:', error);
                hideLoading();
                showNotification('error', t('error'), t('reservationError'));
            }
        }
        
        // دالة تحديث نسبة الحجز (من العمود)
        async function updateReservationPercentage(index, percentage, netSalary) {
            const emp = employeeData[currentYear][currentMonth][index];
            if (!emp) return;
            
            // التحقق من حالة الدفع - منع التعديل إذا تم الدفع
            if (emp.isPaid === true) {
                showNotification('error', currentLang === 'ar' ? 'تم الدفع' : 'Paid', currentLang === 'ar' ? '⚠️ لا يمكن تعديل الحجز للموظف الذي تم الدفع له' : '⚠️ Cannot edit reservation for paid employee');
                return;
            }
            
            const percentageValue = parseFloat(percentage) || 0;
            const requestedAmount = netSalary * (percentageValue / 100);
            
            // حساب الحجز التراكمي من الأشهر السابقة
            const accumulatedReservation = calculateAccumulatedReservation(emp, currentMonth, currentYear);
            
            // حساب الهدف (الراتب الأساسي)
            const target = parseFloat(emp.targetReservedAmount) || calculateTargetReservation(emp);
            
            // الحجز الفعلي = الحد الأدنى بين: المطلوب، الراتب الصافي، والفرق بين الهدف والمحجوز سابقاً
            const remainingToTarget = Math.max(0, target - accumulatedReservation);
            const maxAllowedReservation = Math.min(netSalary, remainingToTarget);
            const actualReservation = Math.min(requestedAmount, maxAllowedReservation);
            
            // تحديث النسبة والمبلغ
            emp.reservationPercentage = percentageValue;
            emp.reservedAmount = actualReservation;
            emp.salaryReservationEnabled = true;
            
            // حساب الهدف إذا لم يكن محدداً
            if (!emp.targetReservedAmount || emp.targetReservedAmount === 0) {
                emp.targetReservedAmount = target;
            }
            
            // حفظ في Firebase
            if (emp.firebaseId) {
                await updateEmployeeInFirebase(emp.firebaseId, {
                    salaryReservationEnabled: true,
                    reservationPercentage: percentageValue,
                    reservedAmount: actualReservation,
                    targetReservedAmount: emp.targetReservedAmount
                }, {
                    skipReload: true,
                    skipLoading: true,
                    skipNotification: true
                });
            }
            
            renderContent();
        }
        
        // دالة تحديث مبلغ الحجز (من العمود)
        async function updateReservedAmount(index, amount, netSalary) {
            const emp = employeeData[currentYear][currentMonth][index];
            if (!emp) return;
            
            // التحقق من حالة الدفع - منع التعديل إذا تم الدفع
            if (emp.isPaid === true) {
                showNotification('error', currentLang === 'ar' ? 'تم الدفع' : 'Paid', currentLang === 'ar' ? '⚠️ لا يمكن تعديل الحجز للموظف الذي تم الدفع له' : '⚠️ Cannot edit reservation for paid employee');
                return;
            }
            
            const amountValue = parseFloat(amount) || 0;
            
            // حساب الحجز التراكمي من الأشهر السابقة
            const accumulatedReservation = calculateAccumulatedReservation(emp, currentMonth, currentYear);
            
            // حساب الهدف (الراتب الأساسي)
            const target = parseFloat(emp.targetReservedAmount) || calculateTargetReservation(emp);
            
            // الحد الأقصى = الحد الأدنى بين: الراتب الصافي، والفرق بين الهدف والمحجوز سابقاً
            const remainingToTarget = Math.max(0, target - accumulatedReservation);
            const maxAmount = Math.min(netSalary, remainingToTarget);
            
            // إذا كان المبلغ أكبر من الحد الأقصى، نحدده للحد الأقصى
            const actualReservation = Math.min(amountValue, maxAmount);
            
            // حساب النسبة من المبلغ
            const calculatedPercentage = netSalary > 0 ? (actualReservation / netSalary) * 100 : 0;
            
            // تحديث المبلغ والنسبة
            emp.reservedAmount = actualReservation;
            emp.reservationPercentage = calculatedPercentage;
            emp.salaryReservationEnabled = true;
            
            // حساب الهدف إذا لم يكن محدداً
            if (!emp.targetReservedAmount || emp.targetReservedAmount === 0) {
                emp.targetReservedAmount = target;
            }
            
            // حفظ في Firebase
            if (emp.firebaseId) {
                await updateEmployeeInFirebase(emp.firebaseId, {
                    salaryReservationEnabled: true,
                    reservedAmount: actualReservation,
                    reservationPercentage: calculatedPercentage,
                    targetReservedAmount: emp.targetReservedAmount
                }, {
                    skipReload: true,
                    skipLoading: true,
                    skipNotification: true
                });
            }
            
            renderContent();
        }
        
        // دالة تفعيل الحجز بسرعة
        async function enableReservationQuick(index) {
            const emp = employeeData[currentYear][currentMonth][index];
            if (!emp) return;
            
            // تفعيل الحجز بنسبة افتراضية 10%
            const defaultPercentage = 10;
            const netBeforeReservation = calculateActualSalary(emp, currentMonth, currentYear);
            const netInPaymentCurrency = convertToPaymentCurrency(netBeforeReservation, 'USD', emp);
            const bonus = convertToPaymentCurrency(emp.bonus || 0, emp.bonusCurrency || 'IQD', emp);
            const phoneBills = convertToPaymentCurrency(emp.phoneBills || 0, emp.phoneBillsCurrency || 'IQD', emp);
            const ceoBonus = convertToPaymentCurrency(emp.ceoBonus || 0, emp.ceoBonusCurrency || 'IQD', emp);
            const deductions = convertToPaymentCurrency(emp.deductions || 0, emp.deductionsCurrency || 'IQD', emp);
            const advance = convertToPaymentCurrency(emp.advance || 0, emp.advanceCurrency || 'IQD', emp);
            const netSalary = netInPaymentCurrency + bonus + phoneBills + ceoBonus - deductions - advance;
            
            // حساب الحجز التراكمي من الأشهر السابقة
            const accumulatedReservation = calculateAccumulatedReservation(emp, currentMonth, currentYear);
            
            // حساب الهدف (الراتب الأساسي)
            const target = calculateTargetReservation(emp);
            
            const requestedAmount = netSalary * (defaultPercentage / 100);
            // الحجز الفعلي = الحد الأدنى بين: المطلوب، الراتب الصافي، والفرق بين الهدف والمحجوز سابقاً
            const remainingToTarget = Math.max(0, target - accumulatedReservation);
            const maxAllowedReservation = Math.min(netSalary, remainingToTarget);
            const actualReservation = Math.min(requestedAmount, maxAllowedReservation);
            
            const updates = {
                salaryReservationEnabled: true,
                reservationPercentage: defaultPercentage,
                reservedAmount: actualReservation,
                targetReservedAmount: target,
                reservationCurrency: emp.paymentCurrency || 'IQD'
            };
            
            if (emp.firebaseId) {
                await updateEmployeeInFirebase(emp.firebaseId, updates, {
                    skipReload: true,
                    skipLoading: true,
                    skipNotification: true
                });
            } else {
                Object.assign(emp, updates);
            }
            
            renderContent();
        }
        
        // دالة فتح تقرير الرواتب المحجوزة
        function openReservationReport() {
            const employees = (employeeData[currentYear] && employeeData[currentYear][currentMonth]) 
                ? employeeData[currentYear][currentMonth].filter(emp => hasProjectAccess(emp.project))
                : [];
            
            const employeesWithReservation = employees.filter(emp => emp.salaryReservationEnabled);
            
            if (employeesWithReservation.length === 0) {
                showNotification('info', t('info'), currentLang === 'ar' ? 'لا يوجد موظفين مع حجز رواتب' : 'No employees with salary reservation');
                return;
            }
            
            // إنشاء تقرير
            let reportHTML = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>${t('reservationReport')}</title>
                    <style>
                        body { font-family: Arial; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
                        th { background: #667eea; color: white; font-weight: bold; }
                        .total { background: #f0f9ff; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <h1>${t('reservationReport')} - ${t('monthNames')[currentMonth]} ${currentYear}</h1>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>${t('name')}</th>
                                <th>${t('reservationPercentage')}</th>
                                <th>${t('previousReservedAmount')}</th>
                                <th>${t('reservedAmount')}</th>
                                <th>${t('totalReservedAmount')}</th>
                                <th>${t('targetReservedAmount')}</th>
                                <th>${t('reservationProgress')}</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let totalPrevious = 0;
            let totalCurrent = 0;
            let totalOverall = 0;
            
            employeesWithReservation.forEach((emp, idx) => {
                const previous = parseFloat(emp.previousReservedAmount) || 0;
                const current = parseFloat(emp.reservedAmount) || 0;
                const total = previous + current;
                const target = parseFloat(emp.targetReservedAmount) || calculateTargetReservation(emp);
                const progress = target > 0 ? (total / target) * 100 : 0;
                
                totalPrevious += previous;
                totalCurrent += current;
                totalOverall += total;
                
                reportHTML += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${currentLang === 'ar' ? (emp.nameAr || emp.name) : (emp.nameEn || emp.name)}</td>
                        <td>${emp.reservationPercentage || 0}%</td>
                        <td>${formatCurrency(previous)}</td>
                        <td>${formatCurrency(current)}</td>
                        <td>${formatCurrency(total)}</td>
                        <td>${formatCurrency(target)}</td>
                        <td>${Math.round(progress)}%</td>
                    </tr>
                `;
            });
            
            reportHTML += `
                        </tbody>
                        <tfoot class="total">
                            <tr>
                                <td colspan="3"><strong>${t('total')}</strong></td>
                                <td><strong>${formatCurrency(totalPrevious)}</strong></td>
                                <td><strong>${formatCurrency(totalCurrent)}</strong></td>
                                <td><strong>${formatCurrency(totalOverall)}</strong></td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(reportHTML);
            printWindow.document.close();
            printWindow.print();
        }

        // ========== Employee Monthly Report ==========
        
        // دالة البحث عن الموظف في جميع الأشهر
        function findEmployeeAcrossMonths(employeeIndex, searchMonth, searchYear) {
            const months = ['january', 'february', 'march', 'april', 'may', 'june', 
                          'july', 'august', 'september', 'october', 'november', 'december'];
            
            // الحصول على الموظف الحالي
            const currentEmp = employeeData[searchYear][searchMonth][employeeIndex];
            if (!currentEmp) return [];
            
            // معايير البحث: اسم + اسم إنجليزي (للتأكد من نفس الشخص حتى لو تغير المشروع)
            const searchNameAr = currentEmp.nameAr && currentEmp.nameAr.trim();
            const searchNameEn = currentEmp.nameEn && currentEmp.nameEn.trim();
            const searchEmployeeCode = currentEmp.employeeCode; // كمعيار أساسي إذا كان متوفراً
            const searchProject = currentEmp.project; // للمساعدة في التمييز عند الحاجة
            
            const foundEmployees = [];
            const processedKeys = new Set(); // لتجنب التكرار
            
            // البحث في جميع السنوات والأشهر
            for (const year of Object.keys(employeeData).sort((a, b) => parseInt(a) - parseInt(b))) {
                const yearData = employeeData[year];
                if (!yearData) continue;
                
                for (const month of months) {
                    const monthData = yearData[month];
                    if (!monthData || monthData.length === 0) continue;
                    
                    // البحث عن الموظف
                    let foundEmp = null;
                    
                    // الطريقة 1: البحث بـ employeeCode (الأفضل - فريد لكل موظف)
                    if (searchEmployeeCode) {
                        foundEmp = monthData.find(e => e.employeeCode === searchEmployeeCode);
                    }
                    
                    // الطريقة 2: إذا لم نجد بـ employeeCode، نبحث بالاسم العربي + الإنجليزي (للتأكد من نفس الشخص)
                    // هذا يضمن إيجاد الموظف حتى لو انتقل لمشروع آخر
                    if (!foundEmp && searchNameAr && searchNameEn) {
                        foundEmp = monthData.find(e => 
                            e.nameAr && e.nameAr.trim().toLowerCase() === searchNameAr.toLowerCase() &&
                            e.nameEn && e.nameEn.trim().toLowerCase() === searchNameEn.toLowerCase()
                        );
                    }
                    
                    // الطريقة 3: إذا لم نجد، نبحث بالاسم العربي فقط (كحل بديل)
                    if (!foundEmp && searchNameAr) {
                        foundEmp = monthData.find(e => 
                            e.nameAr && e.nameAr.trim().toLowerCase() === searchNameAr.toLowerCase()
                        );
                    }
                    
                    // تجنب التكرار (نفس الموظف في نفس الشهر/السنة)
                    if (foundEmp) {
                        const uniqueKey = `${foundEmp.firebaseId || foundEmp.nameAr}_${month}_${year}`;
                        if (!processedKeys.has(uniqueKey)) {
                            processedKeys.add(uniqueKey);
                            foundEmployees.push({
                                employee: foundEmp,
                                month: month,
                                year: parseInt(year),
                                monthIndex: months.indexOf(month)
                            });
                        }
                    }
                }
            }
            
            // ترتيب حسب السنة والشهر
            foundEmployees.sort((a, b) => {
                if (a.year !== b.year) return a.year - b.year;
                return a.monthIndex - b.monthIndex;
            });
            
            return foundEmployees;
        }
        
        // دالة فتح نافذة تقرير الموظف
        function openEmployeeReportModal(employeeIndex, monthKey = currentMonth, year = currentYear) {
            const months = ['january', 'february', 'march', 'april', 'may', 'june', 
                          'july', 'august', 'september', 'october', 'november', 'december'];
            
            // البحث عن الموظف في جميع الأشهر
            const employeeRecords = findEmployeeAcrossMonths(employeeIndex, monthKey, year);
            
            if (employeeRecords.length === 0) {
                showNotification('warning', '⚠️ تنبيه', currentLang === 'ar' 
                    ? 'لم يتم العثور على بيانات الموظف في أي شهر'
                    : 'Employee data not found in any month');
                return;
            }
            
            const firstRecord = employeeRecords[0];
            const emp = firstRecord.employee;
            const empName = currentLang === 'ar' ? (emp.nameAr || emp.nameEn) : (emp.nameEn || emp.nameAr);
            
            // تحديث عنوان النافذة
            document.getElementById('employeeReportTitle').textContent = 
                `📊 تقرير الموظف: ${empName}`;
            
            // إنشاء محتوى التقرير
            let reportHTML = `
                <div style="margin-bottom: 30px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h2 style="margin: 0 0 15px 0; font-size: 24px;">${empName}</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 14px;">
                            <div><strong>🔖 الرمز:</strong> ${emp.employeeCode || '-'}</div>
                            <div><strong>💼 المنصب:</strong> ${emp.position || '-'}</div>
                            <div><strong>🏗 المشاريع:</strong> ${(() => {
                                const uniqueProjects = [...new Set(employeeRecords.map(r => r.employee.project))];
                                return uniqueProjects.map(p => projects[p] || p).join(', ');
                            })()}</div>
                            <div><strong>📋 النوع:</strong> ${emp.employeeType === 'monthly' ? (currentLang === 'ar' ? 'شهري' : 'Monthly') : emp.employeeType === 'daily' ? (currentLang === 'ar' ? 'يومي' : 'Daily') : (currentLang === 'ar' ? 'سيارة' : 'Vehicle')}</div>
                            <div><strong>📊 عدد الأشهر:</strong> ${employeeRecords.length}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // جدول البيانات الشهرية
            reportHTML += `
                <div style="overflow-x: auto; margin-bottom: 30px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <th style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">الشهر</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">الراتب الأساسي</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">زيادة الراتب</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">الراتب الفعلي</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">البونص</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">مكافأة CEO</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">الخصومات</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">السلف</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">الصافي</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">حالة الدفع</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">الحجز</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let totalBasic = 0, totalSalaryIncrease = 0, totalActual = 0, totalBonus = 0, totalCEOBonus = 0, totalDeductions = 0, totalAdvance = 0, totalNet = 0, totalReserved = 0;
            
            employeeRecords.forEach(record => {
                const empRec = record.employee;
                const monthName = t('monthNames')[record.month];
                
                // حساب القيم
                const basicSalary = parseFloat(empRec.salary) || 0;
                const salaryIncrease = convertToPaymentCurrency(empRec.salaryIncrease || 0, empRec.salaryIncreaseCurrency || 'IQD', empRec);
                const actualSalary = calculateActualSalary(empRec, record.month, record.year);
                const bonus = convertToPaymentCurrency(empRec.bonus || 0, empRec.bonusCurrency || 'IQD', empRec);
                const ceoBonus = convertToPaymentCurrency(empRec.ceoBonus || 0, empRec.ceoBonusCurrency || 'IQD', empRec);
                const deductions = convertToPaymentCurrency(empRec.deductions || 0, empRec.deductionsCurrency || 'IQD', empRec);
                const advance = convertToPaymentCurrency(empRec.advance || 0, empRec.advanceCurrency || 'IQD', empRec);
                const netSalary = calculateNetSalary(empRec, record.month, record.year);
                const reserved = parseFloat(empRec.reservedAmount) || 0;
                
                // إضافة للمجاميع
                totalBasic += basicSalary;
                totalSalaryIncrease += salaryIncrease;
                totalActual += actualSalary;
                totalBonus += bonus;
                totalCEOBonus += ceoBonus;
                totalDeductions += deductions;
                totalAdvance += advance;
                totalNet += netSalary;
                totalReserved += reserved;
                
                // حساب أيام الدوام
                const attendance = empRec.attendance || {};
                const attendanceDays = Object.values(attendance);
                const fullDays = attendanceDays.filter(d => d.type === 'full').length;
                const halfDays = attendanceDays.filter(d => d.type === 'half').length;
                const paidLeave = attendanceDays.filter(d => d.type === 'paid-leave').length;
                const absent = attendanceDays.filter(d => d.type === 'absent').length;
                const workDays = fullDays + (halfDays * 0.5);
                
                const paymentStatus = empRec.isPaid ? 
                    `✅ ${currentLang === 'ar' ? 'مدفوع' : 'Paid'}${empRec.paidDate ? '<br><small>' + new Date(empRec.paidDate).toLocaleDateString(currentLang === 'ar' ? 'ar-EG' : 'en-US') + '</small>' : ''}` : 
                    `⏳ ${currentLang === 'ar' ? 'غير مدفوع' : 'Unpaid'}`;
                
                // التحقق من تغيير المشروع
                const projectChanged = record.employee.project !== firstRecord.employee.project;
                const projectName = projects[record.employee.project] || record.employee.project;
                
                reportHTML += `
                    <tr style="border-bottom: 1px solid #e5e7eb; ${projectChanged ? 'background: #fef3c7;' : ''}">
                        <td style="padding: 10px; text-align: center; font-weight: 600; background: #f3f4f6;">
                            ${monthName} ${record.year}
                            <br><small style="color: #6b7280;">${workDays} ${currentLang === 'ar' ? 'يوم' : 'days'}</small>
                            ${projectChanged ? `<br><small style="color: #f59e0b; font-weight: 600;">🏗 ${projectName}</small>` : ''}
                        </td>
                        <td style="padding: 10px; text-align: center;">${formatCurrency(basicSalary)} ${empRec.salaryCurrency || 'IQD'}</td>
                        <td style="padding: 10px; text-align: center; color: #10b981;">${formatCurrency(salaryIncrease)} ${empRec.paymentCurrency || 'IQD'}</td>
                        <td style="padding: 10px; text-align: center;">${formatCurrency(actualSalary)} USD</td>
                        <td style="padding: 10px; text-align: center;">${formatCurrency(bonus)} ${empRec.paymentCurrency || 'IQD'}</td>
                        <td style="padding: 10px; text-align: center; color: #8b5cf6;">${formatCurrency(ceoBonus)} ${empRec.paymentCurrency || 'IQD'}</td>
                        <td style="padding: 10px; text-align: center; color: #ef4444;">-${formatCurrency(deductions)} ${empRec.paymentCurrency || 'IQD'}</td>
                        <td style="padding: 10px; text-align: center; color: #f59e0b;">-${formatCurrency(advance)} ${empRec.paymentCurrency || 'IQD'}</td>
                        <td style="padding: 10px; text-align: center; font-weight: 700; background: #dcfce7; color: #059669;">${formatCurrency(netSalary)} ${empRec.paymentCurrency || 'IQD'}</td>
                        <td style="padding: 10px; text-align: center;">${paymentStatus}</td>
                        <td style="padding: 10px; text-align: center;">${empRec.salaryReservationEnabled ? formatCurrency(reserved) + ' ' + (empRec.paymentCurrency || 'IQD') : '-'}</td>
                    </tr>
                `;
            });
            
            // صف المجاميع
            reportHTML += `
                        </tbody>
                        <tfoot style="background: linear-gradient(135deg, #1f2937 0%, #374151 100%); color: white; font-weight: 700;">
                            <tr>
                                <td style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">المجموع</td>
                                <td style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">${formatCurrency(totalBasic)}</td>
                                <td style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">${formatCurrency(totalSalaryIncrease)}</td>
                                <td style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">${formatCurrency(totalActual)} USD</td>
                                <td style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">${formatCurrency(totalBonus)}</td>
                                <td style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">${formatCurrency(totalCEOBonus)}</td>
                                <td style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">-${formatCurrency(totalDeductions)}</td>
                                <td style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">-${formatCurrency(totalAdvance)}</td>
                                <td style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2); background: #10b981;">${formatCurrency(totalNet)}</td>
                                <td style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">-</td>
                                <td style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">${formatCurrency(totalReserved)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            
            // إحصائيات إضافية
            const avgSalary = employeeRecords.length > 0 ? totalNet / employeeRecords.length : 0;
            const paidMonths = employeeRecords.filter(r => r.employee.isPaid).length;
            const paidPercentage = employeeRecords.length > 0 ? (paidMonths / employeeRecords.length) * 100 : 0;
            
            reportHTML += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 30px;">
                    <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; border: 2px solid #3b82f6;">
                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">متوسط الراتب الصافي</div>
                        <div style="font-size: 24px; font-weight: 700; color: #1e40af;">${formatCurrency(avgSalary)}</div>
                    </div>
                    <div style="background: #fef3c7; padding: 20px; border-radius: 12px; border: 2px solid #f59e0b;">
                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">إجمالي الراتب الصافي</div>
                        <div style="font-size: 24px; font-weight: 700; color: #92400e;">${formatCurrency(totalNet)}</div>
                    </div>
                    <div style="background: #dcfce7; padding: 20px; border-radius: 12px; border: 2px solid #10b981;">
                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">الشهور المدفوعة</div>
                        <div style="font-size: 24px; font-weight: 700; color: #059669;">${paidMonths} / ${employeeRecords.length} (${Math.round(paidPercentage)}%)</div>
                    </div>
                    <div style="background: #f3e8ff; padding: 20px; border-radius: 12px; border: 2px solid #8b5cf6;">
                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">إجمالي الحجز</div>
                        <div style="font-size: 24px; font-weight: 700; color: #6b21a8;">${formatCurrency(totalReserved)}</div>
                    </div>
                </div>
            `;
            
            // حفظ البيانات للطباعة
            window.currentEmployeeReport = {
                employeeName: empName,
                employeeCode: emp.employeeCode,
                records: employeeRecords,
                totals: {
                    basic: totalBasic,
                    salaryIncrease: totalSalaryIncrease,
                    actual: totalActual,
                    bonus: totalBonus,
                    ceoBonus: totalCEOBonus,
                    deductions: totalDeductions,
                    advance: totalAdvance,
                    net: totalNet,
                    reserved: totalReserved,
                    avgSalary: avgSalary,
                    paidMonths: paidMonths,
                    totalMonths: employeeRecords.length,
                    paidPercentage: paidPercentage
                }
            };
            
            document.getElementById('employeeReportContent').innerHTML = reportHTML;
            document.getElementById('printEmployeeReportBtn').style.display = 'inline-block';
            openModal('employeeReportModal');
        }
        
        // دالة طباعة تقرير الموظف
        function printEmployeeReport() {
            if (!window.currentEmployeeReport) {
                showNotification('error', 'خطأ', currentLang === 'ar' ? 'لا يوجد تقرير للطباعة' : 'No report to print');
                return;
            }
            
            const report = window.currentEmployeeReport;
            const months = ['january', 'february', 'march', 'april', 'may', 'june', 
                          'july', 'august', 'september', 'october', 'november', 'december'];
            
            let printHTML = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>تقرير الموظف: ${report.employeeName}</title>
                    <style>
                        @media print {
                            @page { size: A4 landscape; margin: 15mm; }
                        }
                        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; direction: rtl; }
                        h1 { color: #667eea; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 11px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                        th { background: #667eea; color: white; font-weight: bold; }
                        tfoot { background: #1f2937; color: white; font-weight: bold; }
                        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 30px; }
                        .stat-box { padding: 15px; border-radius: 8px; border: 2px solid; }
                    </style>
                </head>
                <body>
                    <h1>📊 تقرير الموظف: ${report.employeeName}</h1>
                    <div style="margin-bottom: 20px;">
                        <strong>🔖 الرمز:</strong> ${report.employeeCode || '-'} | 
                        <strong>📊 عدد الأشهر:</strong> ${report.totalMonths}
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>الشهر</th>
                                <th>الراتب الأساسي</th>
                                <th>زيادة الراتب</th>
                                <th>الراتب الفعلي</th>
                                <th>البونص</th>
                                <th>مكافأة CEO</th>
                                <th>الخصومات</th>
                                <th>السلف</th>
                                <th>الصافي</th>
                                <th>حالة الدفع</th>
                                <th>الحجز</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            report.records.forEach(record => {
                const empRec = record.employee;
                const monthName = t('monthNames')[record.month];
                const salaryIncrease = convertToPaymentCurrency(empRec.salaryIncrease || 0, empRec.salaryIncreaseCurrency || 'IQD', empRec);
                const actualSalary = calculateActualSalary(empRec, record.month, record.year);
                const bonus = convertToPaymentCurrency(empRec.bonus || 0, empRec.bonusCurrency || 'IQD', empRec);
                const ceoBonus = convertToPaymentCurrency(empRec.ceoBonus || 0, empRec.ceoBonusCurrency || 'IQD', empRec);
                const deductions = convertToPaymentCurrency(empRec.deductions || 0, empRec.deductionsCurrency || 'IQD', empRec);
                const advance = convertToPaymentCurrency(empRec.advance || 0, empRec.advanceCurrency || 'IQD', empRec);
                const netSalary = calculateNetSalary(empRec, record.month, record.year);
                const reserved = parseFloat(empRec.reservedAmount) || 0;
                const paymentStatus = empRec.isPaid ? '✅ مدفوع' : '⏳ غير مدفوع';
                
                printHTML += `
                    <tr>
                        <td>${monthName} ${record.year}</td>
                        <td>${formatCurrency(parseFloat(empRec.salary) || 0)} ${empRec.salaryCurrency || 'IQD'}</td>
                        <td>${formatCurrency(salaryIncrease)} ${empRec.paymentCurrency || 'IQD'}</td>
                        <td>${formatCurrency(actualSalary)} USD</td>
                        <td>${formatCurrency(bonus)} ${empRec.paymentCurrency || 'IQD'}</td>
                        <td>${formatCurrency(ceoBonus)} ${empRec.paymentCurrency || 'IQD'}</td>
                        <td>-${formatCurrency(deductions)} ${empRec.paymentCurrency || 'IQD'}</td>
                        <td>-${formatCurrency(advance)} ${empRec.paymentCurrency || 'IQD'}</td>
                        <td><strong>${formatCurrency(netSalary)} ${empRec.paymentCurrency || 'IQD'}</strong></td>
                        <td>${paymentStatus}</td>
                        <td>${empRec.salaryReservationEnabled ? formatCurrency(reserved) + ' ' + (empRec.paymentCurrency || 'IQD') : '-'}</td>
                    </tr>
                `;
            });
            
            printHTML += `
                        </tbody>
                        <tfoot>
                            <tr>
                                <td><strong>المجموع</strong></td>
                                <td>${formatCurrency(report.totals.basic)}</td>
                                <td>${formatCurrency(report.totals.salaryIncrease || 0)}</td>
                                <td>${formatCurrency(report.totals.actual)} USD</td>
                                <td>${formatCurrency(report.totals.bonus)}</td>
                                <td>${formatCurrency(report.totals.ceoBonus || 0)}</td>
                                <td>-${formatCurrency(report.totals.deductions)}</td>
                                <td>-${formatCurrency(report.totals.advance)}</td>
                                <td><strong>${formatCurrency(report.totals.net)}</strong></td>
                                <td>-</td>
                                <td>${formatCurrency(report.totals.reserved)}</td>
                            </tr>
                        </tfoot>
                    </table>
                    <div class="stats">
                        <div class="stat-box" style="border-color: #3b82f6;">
                            <div>متوسط الراتب الصافي</div>
                            <div style="font-size: 20px; font-weight: bold; margin-top: 10px;">${formatCurrency(report.totals.avgSalary)}</div>
                        </div>
                        <div class="stat-box" style="border-color: #f59e0b;">
                            <div>إجمالي الراتب الصافي</div>
                            <div style="font-size: 20px; font-weight: bold; margin-top: 10px;">${formatCurrency(report.totals.net)}</div>
                        </div>
                        <div class="stat-box" style="border-color: #10b981;">
                            <div>الشهور المدفوعة</div>
                            <div style="font-size: 20px; font-weight: bold; margin-top: 10px;">${report.totals.paidMonths} / ${report.totals.totalMonths}</div>
                        </div>
                        <div class="stat-box" style="border-color: #8b5cf6;">
                            <div>إجمالي الحجز</div>
                            <div style="font-size: 20px; font-weight: bold; margin-top: 10px;">${formatCurrency(report.totals.reserved)}</div>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printHTML);
            printWindow.document.close();
            printWindow.print();
        }

        // ========== Excel-Like Cell Editing System ==========
        let currentEditingCell = null;
        let selectedCell = null;

        // تفعيل التعديل المباشر للخلايا القابلة للتعديل
        let tableEventHandlers = {
            dblclick: null,
            keydown: null,
            click: null
        };

        function enableInlineCellEditing() {
            const table = document.querySelector('#employeeTableBody');
            if (!table) return;

            // إزالة الـ listeners القديمة إذا كانت موجودة
            if (tableEventHandlers.dblclick) {
                table.removeEventListener('dblclick', tableEventHandlers.dblclick);
            }
            if (tableEventHandlers.keydown) {
                table.removeEventListener('keydown', tableEventHandlers.keydown);
            }
            if (tableEventHandlers.click) {
                table.removeEventListener('click', tableEventHandlers.click);
            }

            // إنشاء الـ handlers الجديدة
            tableEventHandlers.dblclick = (e) => {
                // تجنب التفعيل عند النقر على الأزرار أو العناصر التفاعلية
                if (e.target.closest('button') || e.target.closest('select') || e.target.closest('input') || e.target.closest('a')) {
                    return;
                }
                const cell = e.target.closest('td');
                if (!cell || !cell.classList.contains('editable')) return;
                startCellEdit(cell);
            };

            tableEventHandlers.keydown = (e) => {
                // تجنب التفعيل عند الكتابة في حقول الإدخال
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }
                handleTableKeyNavigation(e);
            };

            tableEventHandlers.click = (e) => {
                // تجنب التفعيل عند النقر على الأزرار أو العناصر التفاعلية
                if (e.target.closest('button') || e.target.closest('select') || e.target.closest('input[type="number"]') || e.target.closest('a')) {
                    return;
                }
                const cell = e.target.closest('td');
                if (!cell) return;
                selectCell(cell);
            };

            // إضافة الـ listeners الجديدة
            table.addEventListener('dblclick', tableEventHandlers.dblclick);
            table.addEventListener('keydown', tableEventHandlers.keydown);
            table.addEventListener('click', tableEventHandlers.click);
        }

        // بدء تعديل الخلية
        function startCellEdit(cell) {
            if (currentEditingCell === cell) return;
            
            // إيقاف أي تعديل سابق
            if (currentEditingCell) {
                finishCellEdit(currentEditingCell, true);
            }

            const currentValue = cell.textContent.trim();
            const input = cell.querySelector('input');
            
            if (input) {
                // إذا كانت تحتوي على input مسبقاً، فقط ركز عليه
                input.focus();
                input.select();
            } else {
                // إنشاء حقل إدخال جديد
                cell.classList.add('editing');
                const originalContent = cell.innerHTML;
                
                const editInput = document.createElement('input');
                editInput.type = 'text';
                editInput.value = currentValue;
                editInput.dataset.originalContent = originalContent;
                editInput.dataset.field = cell.dataset.field;
                editInput.dataset.index = cell.dataset.index;
                
                cell.innerHTML = '';
                cell.appendChild(editInput);
                editInput.focus();
                editInput.select();

                // حفظ عند الضغط على Enter
                editInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        finishCellEdit(cell);
                        moveToNextCell(cell, 'down');
                    } else if (e.key === 'Escape') {
                        cancelCellEdit(cell);
                    } else if (e.key === 'Tab') {
                        e.preventDefault();
                        finishCellEdit(cell);
                        moveToNextCell(cell, e.shiftKey ? 'left' : 'right');
                    }
                });

                // حفظ عند فقدان التركيز
                editInput.addEventListener('blur', () => {
                    setTimeout(() => finishCellEdit(cell), 100);
                });

                currentEditingCell = cell;
            }
        }

        // إنهاء تعديل الخلية وحفظ القيمة
        async function finishCellEdit(cell, cancel = false) {
            if (!cell || !cell.classList.contains('editing')) return;

            const input = cell.querySelector('input');
            if (!input) return;

            cell.classList.remove('editing');

            if (!cancel) {
                const newValue = input.value;
                const field = input.dataset.field;
                const index = parseInt(input.dataset.index);

                // تحديث القيمة
                if (field && index >= 0) {
                    await updateField(index, field, newValue);
                    cell.textContent = newValue;
                } else {
                    cell.textContent = newValue;
                }
            } else {
                // إلغاء التعديل واستعادة المحتوى الأصلي
                const originalContent = input.dataset.originalContent;
                cell.innerHTML = originalContent;
            }

            currentEditingCell = null;
        }

        // إلغاء تعديل الخلية
        function cancelCellEdit(cell) {
            finishCellEdit(cell, true);
        }

        // تحديد خلية
        function selectCell(cell) {
            if (selectedCell) {
                selectedCell.classList.remove('selected-cell');
            }
            cell.classList.add('selected-cell');
            selectedCell = cell;
        }

        // التنقل بين الخلايا باستخدام لوحة المفاتيح
        function handleTableKeyNavigation(e) {
            if (!selectedCell || currentEditingCell) return;

            const key = e.key;
            
            // بدء التعديل بالضغط على Enter أو F2
            if (key === 'Enter' || key === 'F2') {
                if (selectedCell.classList.contains('editable')) {
                    e.preventDefault();
                    startCellEdit(selectedCell);
                }
                return;
            }

            // التنقل بالأسهم
            const directions = {
                'ArrowUp': 'up',
                'ArrowDown': 'down',
                'ArrowLeft': 'left',
                'ArrowRight': 'right'
            };

            if (directions[key]) {
                e.preventDefault();
                moveToNextCell(selectedCell, directions[key]);
            }
        }

        // التحرك إلى الخلية التالية
        function moveToNextCell(currentCell, direction) {
            const row = currentCell.parentElement;
            const cells = Array.from(row.children);
            const currentIndex = cells.indexOf(currentCell);

            let nextCell = null;

            switch (direction) {
                case 'right':
                    nextCell = cells[currentIndex + 1];
                    break;
                case 'left':
                    nextCell = cells[currentIndex - 1];
                    break;
                case 'down':
                    const nextRow = row.nextElementSibling;
                    if (nextRow) {
                        nextCell = nextRow.children[currentIndex];
                    }
                    break;
                case 'up':
                    const prevRow = row.previousElementSibling;
                    if (prevRow) {
                        nextCell = prevRow.children[currentIndex];
                    }
                    break;
            }

            if (nextCell && nextCell.tagName === 'TD') {
                selectCell(nextCell);
                nextCell.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // تفعيل النظام بعد رسم الجدول
        function activateExcelLikeEditing() {
            setTimeout(() => {
                enableInlineCellEditing();
                markEditableCells();
            }, 200);
        }

        // تحديد الخلايا القابلة للتعديل
        function markEditableCells() {
            // الخلايا القابلة للتعديل: سعر الصرف فقط (تم إزالة workDays)
            const editableFields = ['exchangeRate'];
            
            document.querySelectorAll('#employeeTableBody td[data-field]').forEach(td => {
                const fieldName = td.dataset.field;
                if (editableFields.includes(fieldName)) {
                    if (!td.classList.contains('editable')) {
                        td.classList.add('editable');
                    }
                    if (!td.classList.contains('excel-cell')) {
                        td.classList.add('excel-cell');
                    }
                }
            });
        }

        // ========== تحديث تسميات حسب نوع الموظف ==========
        function updateSalaryLabelByType(fieldPrefix) {
            try {
                const typeSelect = document.getElementById(fieldPrefix === 'salary' ? 'employeeType' : 'editEmployeeType');
                if (!typeSelect) return;
                
                const employeeType = typeSelect.value;
                
                // البحث عن label الراتب
                let salaryLabel = null;
                const allLabels = document.querySelectorAll(fieldPrefix === 'salary' ? '#employeeModal label' : '#editModal label');
                allLabels.forEach(label => {
                    if (label.textContent.includes('الراتب الأساسي') || 
                        label.textContent.includes('أجر اليوم') || 
                        label.textContent.includes('راتب السيارة') ||
                        label.textContent.includes('الراتب الشهري')) {
                        salaryLabel = label;
                    }
                });
                
                if (!salaryLabel) return;
                
                // البحث عن قسم إعدادات الدوام
                const modalId = fieldPrefix === 'salary' ? 'employeeModal' : 'editModal';
                const allDivs = document.querySelectorAll(`#${modalId} div[style*="background"]`);
                let attendanceSection = null;
                allDivs.forEach(div => {
                    const heading = div.querySelector('h4');
                    if (heading && heading.textContent.includes('إعدادات نظام الدوام')) {
                        attendanceSection = div;
                    }
                });
                
                // تغيير التسمية حسب النوع
                if (employeeType === 'daily') {
                    salaryLabel.innerHTML = '💵 أجر اليوم <span style="color: #10b981; font-size: 11px;">(المبلغ المدفوع لكل يوم عمل)</span>';
                    if (attendanceSection) attendanceSection.style.display = 'none';
                } else if (employeeType === 'monthly') {
                    salaryLabel.innerHTML = '💰 الراتب الشهري <span style="color: #6366f1; font-size: 11px;">(الراتب الشهري الأساسي)</span>';
                    if (attendanceSection) attendanceSection.style.display = 'block';
                } else if (employeeType === 'vehicle') {
                    salaryLabel.innerHTML = '🚗 راتب السيارة <span style="color: #f59e0b; font-size: 11px;">(التكلفة الشهرية)</span>';
                    if (attendanceSection) attendanceSection.style.display = 'block';
                }
            } catch (error) {
                console.error('Error in updateSalaryLabelByType:', error);
                // لا تعطل العمل إذا حدث خطأ
            }
        }

        // ========== Excel-Like Column Filters ==========
        let columnFilters = {}; // {columnName: [selectedValues]}
        let activeFilterDropdown = null;

        // إضافة أيقونات الفلتر إلى رؤوس الأعمدة
        function addFilterIcons() {
            // الأعمدة القابلة للفلترة - جميع الأعمدة الآن قابلة للفلترة
            const filterableColumns = {
                'select': '☑️ التحديد',
                'reorder': '⬆️⬇️ الترتيب',
                'number': '# الرقم',
                'code': '🔖 الرمز',
                'name': '👤 الاسم',
                'position': '💼 المنصب',
                'employeeType': '📋 النوع',
                'project': '🏗️ المشروع',
                'salary': '💵 الراتب',
                'salaryCurrency': '💱 عملة الراتب',
                'paymentCurrency': '💳 عملة الدفع',
                'exchangeRate': '🔄 سعر الصرف',
                'attendance': '⏰ الدوام',
                'dailySalary': '📅 الراتب اليومي',
                'actualUSD': '💵 الراتب الفعلي USD',
                'actualIQD': '💰 الراتب الفعلي IQD',
                'bonus': '🎁 البونص',
                'bonusCurrency': '💱 عملة البونص',
                'phoneBills': '📞 الفواتير',
                'phoneBillsCurrency': '💱 عملة الفواتير',
                'deductions': '➖ الخصومات',
                'deductionsCurrency': '💱 عملة الخصومات',
                'advance': '💳 السلفة',
                'advanceCurrency': '💱 عملة السلفة',
                'netSalary': '✅ الصافي',
                'paymentStatus': '💳 حالة الدفع',
                'reservationPercentage': '📊 نسبة الحجز',
                'reservedAmount': '💰 المبلغ المحجوز',
                'reservation': '📈 حالة الحجز',
                'actions': '⚙️ الإجراءات'
            };

            const table = document.querySelector('#employeeTable');
            if (!table) {
                console.log('⚠️ لم يتم العثور على جدول الموظفين');
                return;
            }

            const headers = table.querySelectorAll('thead th[data-column]');
            console.log('🔍 تم العثور على', headers.length, 'رأس عمود');

            headers.forEach((th, index) => {
                const columnName = th.dataset.column;
                
                if (columnName && filterableColumns[columnName]) {
                    // إزالة أي أيقونة فلتر موجودة
                    const existingIcon = th.querySelector('.filter-icon');
                    if (existingIcon) existingIcon.remove();
                    
                    const filterIcon = document.createElement('span');
                    filterIcon.className = 'filter-icon';
                    filterIcon.innerHTML = ' 🔽';
                    filterIcon.dataset.column = columnName;
                    filterIcon.title = `فلتر ${filterableColumns[columnName]}`;
                    
                    if (columnFilters[columnName] && columnFilters[columnName].length > 0) {
                        filterIcon.classList.add('active');
                        th.classList.add('filtered');
                    }
                    
                    filterIcon.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showFilterDropdown(columnName, th, index);
                    });
                    
                    th.appendChild(filterIcon);
                    th.style.position = 'relative';
                    
                    console.log('✅ تمت إضافة فلتر للعمود:', columnName);
                }
            });
            
            if (headers.length === 0) {
                console.warn('⚠️ لم يتم العثور على رؤوس أعمدة بـ data-column');
                console.log('📝 جميع رؤوس الأعمدة:', table.querySelectorAll('thead th').length);
            } else {
                console.log('✅ تمت إضافة أيقونات الفلتر بنجاح');
            }
        }

        // عرض نافذة الفلتر
        function showFilterDropdown(columnName, headerCell, columnIndex) {
            console.log('🔽 فتح فلتر العمود:', columnName);
            // إغلاق أي نافذة فلتر مفتوحة
            closeAllFilterDropdowns();

            const employees = (employeeData[currentYear] && employeeData[currentYear][currentMonth]) 
                ? employeeData[currentYear][currentMonth] : [];
            
            // جمع القيم الفريدة للعمود
            const uniqueValues = new Set();
            employees.forEach(emp => {
                let value;
                switch(columnName) {
                    case 'name':
                        value = currentLang === 'ar' ? (emp.nameAr || emp.name) : (emp.nameEn || emp.name);
                        break;
                    case 'nameAr':
                        value = emp.nameAr || emp.name || '';
                        break;
                    case 'nameEn':
                        value = emp.nameEn || '';
                        break;
                    case 'position':
                        value = emp.position;
                        break;
                    case 'employeeType':
                        value = getEmployeeTypeText(emp.employeeType);
                        break;
                    case 'project':
                        value = projects[emp.project] || emp.project;
                        break;
                    case 'code':
                        value = emp.employeeCode || '-';
                        break;
                    case 'number':
                        // للرقم، نستخدم الفهرس
                        value = null; // سنتخطى هذا العمود
                        break;
                    case 'salary':
                    case 'bonus':
                    case 'phoneBills':
                    case 'deductions':
                    case 'advance':
                    case 'netSalary':
                    case 'reservedAmount':
                    case 'reservationPercentage':
                    case 'exchangeRate':
                    case 'dailySalary':
                    case 'dailyWorkHours':
                    case 'actualUSD':
                    case 'actualIQD':
                        // للأرقام، نستخدم القيمة المباشرة
                        value = emp[columnName] !== undefined && emp[columnName] !== null ? String(emp[columnName]) : '0';
                        break;
                    case 'salaryCurrency':
                    case 'paymentCurrency':
                    case 'bonusCurrency':
                    case 'phoneBillsCurrency':
                    case 'deductionsCurrency':
                    case 'advanceCurrency':
                        value = emp[columnName] || 'IQD';
                        break;
                    case 'attendanceSystem':
                        value = emp.attendanceSystem === 'hours' ? 'بالساعات' : emp.attendanceSystem === 'fixed' ? 'ثابت' : '';
                        break;
                    case 'overtimeMultiplier':
                        value = String(emp.overtimeMultiplier || 1.5);
                        break;
                    case 'monthCalculationMethod':
                        value = emp.monthCalculationMethod === '30' ? '30 يوم دائماً' : emp.monthCalculationMethod === 'actual' ? 'حسب أيام الشهر الفعلية' : '';
                        break;
                    case 'paidLeaveCalculation':
                        value = emp.paidLeaveCalculation === 'full' ? 'كامل الراتب' : emp.paidLeaveCalculation === 'half' ? 'نصف الراتب' : emp.paidLeaveCalculation === 'none' ? 'بدون راتب' : '';
                        break;
                    case 'paymentStatus':
                        value = emp.isPaid ? 'مدفوع' : 'غير مدفوع';
                        break;
                    case 'reservation':
                        value = emp.salaryReservationEnabled ? 'نشط' : 'معطل';
                        break;
                    case 'attendance':
                        // للدوام، نستخدم حالة الدوام
                        value = emp.attendanceStatus || 'عادي';
                        break;
                    default:
                        value = emp[columnName] !== undefined && emp[columnName] !== null ? String(emp[columnName]) : '';
                }
                if (value !== null && value !== undefined && value !== '') {
                    uniqueValues.add(String(value));
                }
            });

            const sortedValues = Array.from(uniqueValues).sort();
            const currentFilter = columnFilters[columnName] || [];

            // حساب موضع النافذة بناءً على موقع headerCell
            const headerRect = headerCell.getBoundingClientRect();
            const isRTL = document.documentElement.dir === 'rtl' || currentLang === 'ar';
            
            // إنشاء نافذة الفلتر
            const dropdown = document.createElement('div');
            dropdown.className = 'filter-dropdown';
            
            // إضافة عنوان النافذة
            const filterableColumns = {
                'select': '☑️ التحديد',
                'reorder': '⬆️⬇️ الترتيب',
                'number': '# الرقم',
                'code': '🔖 الرمز',
                'name': '👤 الاسم',
                'nameAr': '👤 الاسم بالعربية',
                'nameEn': '👤 الاسم بالإنجليزية',
                'position': '💼 المنصب',
                'employeeType': '📋 النوع',
                'project': '🏗️ المشروع',
                'salary': '💵 الراتب',
                'salaryCurrency': '💱 عملة الراتب',
                'paymentCurrency': '💳 عملة الدفع',
                'exchangeRate': '🔄 سعر الصرف',
                'attendance': '⏰ الدوام',
                'attendanceSystem': '⏰ نظام الدوام',
                'dailyWorkHours': '⏱️ ساعات العمل',
                'overtimeMultiplier': '🔢 معامل الأوفر تايم',
                'monthCalculationMethod': '📊 طريقة احتساب الشهر',
                'paidLeaveCalculation': '💚 احتساب الإجازات',
                'dailySalary': '📅 الراتب اليومي',
                'actualUSD': '💵 الراتب الفعلي USD',
                'actualIQD': '💰 الراتب الفعلي IQD',
                'bonus': '🎁 البونص',
                'bonusCurrency': '💱 عملة البونص',
                'phoneBills': '📞 الفواتير',
                'phoneBillsCurrency': '💱 عملة الفواتير',
                'deductions': '➖ الخصومات',
                'deductionsCurrency': '💱 عملة الخصومات',
                'advance': '💳 السلفة',
                'advanceCurrency': '💱 عملة السلفة',
                'netSalary': '✅ الصافي',
                'paymentStatus': '💳 حالة الدفع',
                'reservationPercentage': '📊 نسبة الحجز',
                'reservedAmount': '💰 المبلغ المحجوز',
                'reservation': '📈 حالة الحجز',
                'actions': '⚙️ الإجراءات'
            };
            
            const titleDiv = document.createElement('div');
            titleDiv.style.cssText = 'font-size: 15px; font-weight: 700; color: #1f2937; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb; text-align: center;';
            titleDiv.textContent = `🔽 فلتر: ${filterableColumns[columnName] || columnName}`;
            
            // إنشاء العناصر بشكل برمجي بدلاً من innerHTML (لضمان عمل الأزرار)
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.className = 'filter-search';
            searchInput.placeholder = '🔍 ابحث...';
            searchInput.addEventListener('keyup', function() {
                filterDropdownSearch(this);
            });
            
            const countDiv = document.createElement('div');
            countDiv.className = 'filter-count';
            countDiv.textContent = `عرض ${sortedValues.length} من ${sortedValues.length} قيمة`;
            
            const selectAllBtn = document.createElement('button');
            selectAllBtn.className = 'filter-select-all';
            selectAllBtn.textContent = currentFilter.length === 0 || currentFilter.length === sortedValues.length 
                ? '☑️ إلغاء تحديد الكل' : '☐ تحديد الكل';
            selectAllBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                toggleAllFilterOptions(this);
            });
            
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'filter-options';
            optionsDiv.id = 'filterOptions';
            
            sortedValues.forEach((value, idx) => {
                        const isChecked = currentFilter.length === 0 || currentFilter.includes(value);
                
                const optionDiv = document.createElement('div');
                optionDiv.className = 'filter-option';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `filter_${columnName}_${idx}`;
                checkbox.value = value;
                checkbox.checked = isChecked;
                
                const label = document.createElement('label');
                label.htmlFor = `filter_${columnName}_${idx}`;
                label.textContent = value;
                label.style.cursor = 'pointer';
                label.style.fontSize = '14px';
                label.style.fontWeight = '500';
                label.style.color = '#1f2937';
                
                // جعل كامل الصف قابل للنقر
                optionDiv.addEventListener('click', function(e) {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }
                });
                
                optionDiv.appendChild(checkbox);
                optionDiv.appendChild(label);
                optionsDiv.appendChild(optionDiv);
            });
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'filter-actions';
            
            const applyBtn = document.createElement('button');
            applyBtn.className = 'filter-apply';
            applyBtn.textContent = '✓ تطبيق';
            applyBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                applyColumnFilter(columnName);
            });
            
            const clearBtn = document.createElement('button');
            clearBtn.className = 'filter-clear';
            clearBtn.textContent = '✗ مسح';
            clearBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                clearColumnFilter(columnName);
            });
            
            actionsDiv.appendChild(applyBtn);
            actionsDiv.appendChild(clearBtn);
            
            // تجميع كل العناصر
            dropdown.appendChild(titleDiv);
            dropdown.appendChild(searchInput);
            dropdown.appendChild(countDiv);
            dropdown.appendChild(selectAllBtn);
            dropdown.appendChild(optionsDiv);
            dropdown.appendChild(actionsDiv);

            // إضافة النافذة إلى body
            document.body.appendChild(dropdown);
            activeFilterDropdown = dropdown;
            
            // استخدام requestAnimationFrame لضمان حساب الموضع بعد إضافة العنصر إلى DOM
            requestAnimationFrame(() => {
                // إعادة حساب موقع headerCell (قد يكون تغير بسبب التمرير)
                const currentHeaderRect = headerCell.getBoundingClientRect();
                
                // حساب أبعاد النافذة الفعلية
                const dropdownRect = dropdown.getBoundingClientRect();
                const dropdownWidth = dropdownRect.width || 320;
                const dropdownHeight = Math.min(dropdownRect.height || 500, window.innerHeight * 0.7);
                const spacing = 8; // المسافة بين headerCell والنافذة
                
                // حساب الموضع الأفضل للنافذة
                let leftPos, rightPos, topPos;
                
                if (isRTL) {
                    // في RTL، نضع النافذة على اليمين من headerCell
                    const rightFromHeader = window.innerWidth - currentHeaderRect.right;
                    const leftFromHeader = currentHeaderRect.left;
                    
                    // إذا كان هناك مساحة كافية على اليمين، نضعها هناك
                    if (rightFromHeader >= dropdownWidth || rightFromHeader > leftFromHeader) {
                        rightPos = Math.max(10, window.innerWidth - currentHeaderRect.right);
                        leftPos = 'auto';
                    } else {
                        // وإلا نضعها على اليسار
                        leftPos = Math.max(10, currentHeaderRect.left - dropdownWidth);
                        rightPos = 'auto';
                    }
                } else {
                    // في LTR، نضع النافذة على اليسار من headerCell
                    const leftFromHeader = currentHeaderRect.left;
                    const rightFromHeader = window.innerWidth - currentHeaderRect.right;
                    
                    // إذا كان هناك مساحة كافية على اليسار، نضعها هناك
                    if (leftFromHeader >= dropdownWidth || leftFromHeader > rightFromHeader) {
                        leftPos = Math.max(10, currentHeaderRect.left);
                        rightPos = 'auto';
                    } else {
                        // وإلا نضعها على اليمين
                        rightPos = Math.max(10, window.innerWidth - currentHeaderRect.right);
                        leftPos = 'auto';
                    }
                }
                
                // حساب الموضع العمودي
                const bottomSpace = window.innerHeight - currentHeaderRect.bottom;
                const topSpace = currentHeaderRect.top;
                
                if (bottomSpace >= dropdownHeight + spacing) {
                    // إذا كان هناك مساحة كافية في الأسفل
                    topPos = currentHeaderRect.bottom + spacing;
                } else if (topSpace >= dropdownHeight + spacing) {
                    // إذا كان هناك مساحة كافية في الأعلى
                    topPos = currentHeaderRect.top - dropdownHeight - spacing;
                } else {
                    // إذا لم تكن هناك مساحة كافية، نضعها في الأسفل ونضبط الارتفاع
                    topPos = currentHeaderRect.bottom + spacing;
                    dropdown.style.maxHeight = `${Math.max(200, bottomSpace - spacing - 20)}px`;
                }
                
                // تطبيق المواضع
                dropdown.style.position = 'fixed';
                dropdown.style.zIndex = '999999';
                dropdown.style.top = `${Math.max(10, topPos)}px`;
                
                if (leftPos !== 'auto') {
                    dropdown.style.left = `${leftPos}px`;
                    dropdown.style.right = 'auto';
                } else {
                    dropdown.style.right = `${rightPos}px`;
                    dropdown.style.left = 'auto';
                }
                
                // إظهار النافذة بعد تحديد الموضع
                dropdown.classList.add('show');
            });
            
            console.log('✅ تم إنشاء نافذة الفلتر بنجاح للعمود:', columnName, 'مع', sortedValues.length, 'قيمة');

            // إضافة مستمع لإغلاق النافذة عند النقر خارجها
            setTimeout(() => {
                document.addEventListener('click', closeFilterOnOutsideClick);
            }, 100);
        }

        // البحث داخل نافذة الفلتر
        function filterDropdownSearch(input) {
            const searchTerm = input.value.toLowerCase();
            const options = input.parentElement.querySelectorAll('.filter-option');
            let visibleCount = 0;
            
            options.forEach(option => {
                const label = option.querySelector('label').textContent.toLowerCase();
                if (label.includes(searchTerm)) {
                    option.style.display = 'flex';
                    visibleCount++;
                } else {
                    option.style.display = 'none';
                }
            });
            
            const countElement = input.parentElement.querySelector('.filter-count');
            countElement.textContent = `عرض ${visibleCount} من ${options.length} قيمة`;
        }

        // تحديد/إلغاء تحديد جميع الخيارات
        function toggleAllFilterOptions(button) {
            const dropdown = button.closest('.filter-dropdown');
            if (!dropdown) {
                console.error('❌ لم يتم العثور على dropdown');
                return;
            }
            
            const checkboxes = dropdown.querySelectorAll('.filter-option input[type="checkbox"]');
            const visibleCheckboxes = Array.from(checkboxes).filter(cb => {
                const optionDiv = cb.closest('.filter-option');
                return optionDiv && optionDiv.style.display !== 'none';
            });
            
            if (visibleCheckboxes.length === 0) {
                console.warn('⚠️ لا توجد checkboxes ظاهرة');
                return;
            }
            
            const allChecked = visibleCheckboxes.every(cb => cb.checked);
            
            visibleCheckboxes.forEach(cb => {
                cb.checked = !allChecked;
            });
            
            button.textContent = allChecked ? '☐ تحديد الكل' : '☑️ إلغاء تحديد الكل';
            
            console.log(`✅ تم ${allChecked ? 'إلغاء تحديد' : 'تحديد'} ${visibleCheckboxes.length} عنصر`);
        }

        // تطبيق الفلتر على العمود
        function applyColumnFilter(columnName) {
            console.log('🔽 تطبيق فلتر للعمود:', columnName);
            
            const dropdown = document.querySelector('.filter-dropdown.show');
            if (!dropdown) {
                console.error('❌ لم يتم العثور على نافذة الفلتر');
                return;
            }

            // جمع جميع checkboxes (بما فيها المخفية من البحث)
            const allCheckboxes = dropdown.querySelectorAll('.filter-option input[type="checkbox"]');
            const checkedBoxes = dropdown.querySelectorAll('.filter-option input[type="checkbox"]:checked');
            const selectedValues = Array.from(checkedBoxes).map(cb => String(cb.value).trim()).filter(v => v !== '');
            
            console.log('📊 القيم المحددة:', selectedValues.length, 'من', allCheckboxes.length);
            console.log('📋 القيم:', selectedValues);

            if (selectedValues.length === 0) {
                // إذا لم يتم تحديد أي قيمة، إظهار جميع الصفوف
                delete columnFilters[columnName];
                console.log('⚠️ لا توجد قيم محددة - إزالة الفلتر');
            } else {
                // حساب عدد القيم الظاهرة (غير المخفية)
                const visibleCheckboxes = Array.from(allCheckboxes).filter(cb => {
                    const optionDiv = cb.closest('.filter-option');
                    return optionDiv && optionDiv.style.display !== 'none';
                });
                
                if (selectedValues.length === visibleCheckboxes.length) {
                    // إذا تم تحديد جميع القيم الظاهرة، إزالة الفلتر
                    delete columnFilters[columnName];
                    console.log('✅ جميع القيم محددة - إزالة الفلتر');
                } else {
                    columnFilters[columnName] = selectedValues;
                    console.log('✅ تم تطبيق الفلتر:', selectedValues);
                }
            }

            closeAllFilterDropdowns();
            renderContent();
            
            const filterCount = Object.keys(columnFilters).length;
            showNotification('success', 'تم التطبيق', 
                `✅ تم تطبيق الفلتر${filterCount > 0 ? ` (${filterCount} فلتر نشط)` : ''}`);
        }

        // مسح فلتر العمود
        function clearColumnFilter(columnName) {
            console.log('🗑️ مسح فلتر العمود:', columnName);
            
            delete columnFilters[columnName];
            
            closeAllFilterDropdowns();
            renderContent();
            
            const filterCount = Object.keys(columnFilters).length;
            showNotification('info', 'تم المسح', 
                `تم مسح الفلتر${filterCount > 0 ? ` (${filterCount} فلتر متبقي)` : ''}`);
        }

        // مسح جميع الفلاتر
        function clearAllFilters() {
            columnFilters = {};
            // لا يحفظ تلقائياً
            renderContent();
            showNotification('info', 'تم المسح', 'تم مسح جميع الفلاتر');
        }

        // إغلاق جميع نوافذ الفلتر
        function closeAllFilterDropdowns() {
            document.querySelectorAll('.filter-dropdown').forEach(dropdown => {
                dropdown.remove();
            });
            activeFilterDropdown = null;
            document.removeEventListener('click', closeFilterOnOutsideClick);
        }

        // إغلاق الفلتر عند النقر خارجه
        function closeFilterOnOutsideClick(e) {
            if (!e.target.closest('.filter-dropdown') && !e.target.closest('.filter-icon')) {
                closeAllFilterDropdowns();
            }
        }

        // تطبيق الفلاتر على البيانات
        function applyFiltersToData(employees) {
            if (Object.keys(columnFilters).length === 0) {
                return employees;
            }

            return employees.filter(emp => {
                return Object.entries(columnFilters).every(([columnName, selectedValues]) => {
                    if (!selectedValues || selectedValues.length === 0) return true; // إذا كانت القائمة فارغة، عرض الكل
                    
                    let empValue;
                    switch(columnName) {
                        case 'name':
                            empValue = currentLang === 'ar' ? (emp.nameAr || emp.name || '') : (emp.nameEn || emp.name || '');
                            break;
                        case 'nameAr':
                            empValue = emp.nameAr || emp.name || '';
                            break;
                        case 'nameEn':
                            empValue = emp.nameEn || '';
                            break;
                        case 'position':
                            empValue = emp.position || '';
                            break;
                        case 'employeeType':
                            empValue = getEmployeeTypeText(emp.employeeType);
                            break;
                        case 'project':
                            empValue = projects[emp.project] || emp.project || '';
                            break;
                        case 'code':
                            empValue = emp.employeeCode || '-';
                            break;
                        case 'number':
                            // للرقم، نتخطى هذا العمود لأنه الفهرس
                            return true;
                        case 'salary':
                        case 'bonus':
                        case 'phoneBills':
                        case 'deductions':
                        case 'advance':
                        case 'netSalary':
                        case 'reservedAmount':
                        case 'reservationPercentage':
                        case 'exchangeRate':
                        case 'dailySalary':
                        case 'dailyWorkHours':
                        case 'actualUSD':
                        case 'actualIQD':
                            // للأرقام، نستخدم القيمة المباشرة
                            empValue = emp[columnName] !== undefined && emp[columnName] !== null ? String(emp[columnName]) : '0';
                            break;
                        case 'salaryCurrency':
                        case 'paymentCurrency':
                        case 'bonusCurrency':
                        case 'phoneBillsCurrency':
                        case 'deductionsCurrency':
                        case 'advanceCurrency':
                            empValue = emp[columnName] || 'IQD';
                            break;
                        case 'attendanceSystem':
                            empValue = emp.attendanceSystem === 'hours' ? 'بالساعات' : emp.attendanceSystem === 'fixed' ? 'ثابت' : '';
                            break;
                        case 'overtimeMultiplier':
                            empValue = String(emp.overtimeMultiplier || 1.5);
                            break;
                        case 'monthCalculationMethod':
                            empValue = emp.monthCalculationMethod === '30' ? '30 يوم دائماً' : emp.monthCalculationMethod === 'actual' ? 'حسب أيام الشهر الفعلية' : '';
                            break;
                        case 'paidLeaveCalculation':
                            empValue = emp.paidLeaveCalculation === 'full' ? 'كامل الراتب' : emp.paidLeaveCalculation === 'half' ? 'نصف الراتب' : emp.paidLeaveCalculation === 'none' ? 'بدون راتب' : '';
                            break;
                        case 'paymentStatus':
                            empValue = emp.isPaid ? 'مدفوع' : 'غير مدفوع';
                            break;
                        case 'reservation':
                            empValue = emp.salaryReservationEnabled ? 'نشط' : 'معطل';
                            break;
                        case 'attendance':
                            // للدوام، نستخدم حالة الدوام
                            empValue = emp.attendanceStatus || 'عادي';
                            break;
                        default:
                            empValue = emp[columnName] !== undefined && emp[columnName] !== null ? String(emp[columnName]) : '';
                    }
                    
                    // تحويل القيمة إلى string للمقارنة
                    const empValueStr = String(empValue || '');
                    
                    // المقارنة مع القيم المحددة
                    return selectedValues.some(selectedValue => {
                        const selectedStr = String(selectedValue || '');
                        // مقارنة مباشرة أو مقارنة case-insensitive للنصوص
                        return empValueStr === selectedStr || 
                               empValueStr.toLowerCase() === selectedStr.toLowerCase();
                    });
                });
            });
        }

        async function updateProjectField(index, field, value) {
            // التحقق من وجود المستخدم
            if (!currentUser) {
                showNotification('error', t('notAuthorized'), t('loginRequired'));
                return;
            }
            
            // التحقق من قفل الشهر
            if (!canEditCurrentMonth(selectedProjectMonth, currentYear)) {
                showNotification('warning', t('warning'), t('monthLocked'));
                return;
            }
            
            const emp = employeeData[currentYear][selectedProjectMonth][index];
            
            if (!emp) {
                showNotification('error', t('error'), t('employeeNotFound'));
                return;
            }
            
            // التحقق من حالة الدفع - منع التعديل إذا تم الدفع
            if (emp.isPaid === true) {
                const paidDate = emp.paidDate ? new Date(emp.paidDate).toLocaleDateString(currentLang === 'ar' ? 'ar-EG' : 'en-US') : '';
                const message = currentLang === 'ar' 
                    ? `⚠️ لا يمكن تعديل بيانات الموظف الذي تم الدفع له${paidDate ? ' في ' + paidDate : ''}`
                    : `⚠️ Cannot edit employee who has been paid${paidDate ? ' on ' + paidDate : ''}`;
                showNotification('error', currentLang === 'ar' ? 'تم الدفع' : 'Paid', message);
                return;
            }
            
            // التحقق من صلاحية الوصول للمشروع
            if (!hasProjectAccess(emp.project)) {
                showNotification('error', t('notAuthorized'), t('noProjectAccess'));
                return;
            }
            
            // التحقق من صلاحية تعديل الموظفين
            const employeeType = emp.employeeType || 'monthly';
            if (!hasDetailedPermission('employees', 'edit', null, employeeType)) {
                showNotification('error', t('notAuthorized'), `${t('noEditPermission')} ${t('employees')} ${t('employeeType')}: ${employeeType}`);
                return;
            }
            
            // التحقق من صلاحيات التعديل التفصيلية للحقول الحساسة
            if (field === 'salary' && !hasDetailedPermission('months', 'edit', 'editSalary')) {
                showNotification('error', t('notAuthorized'), t('noEditSalaryPermission'));
                return;
            }
            if (field === 'bonus' && !hasDetailedPermission('months', 'edit', 'editBonus')) {
                showNotification('error', t('notAuthorized'), t('noEditBonusPermission'));
                return;
            }
            if (field === 'deductions' && !hasDetailedPermission('months', 'edit', 'editDeductions')) {
                showNotification('error', t('notAuthorized'), t('noEditDeductionsPermission'));
                return;
            }
            if (field === 'advance' && !hasDetailedPermission('months', 'edit', 'editAdvance')) {
                showNotification('error', t('notAuthorized'), t('noEditAdvancePermission'));
                return;
            }
            
            if (field.includes('Currency')) {
                emp[field] = value;
            } else {
                emp[field] = parseFloat(value) || 0;
            }
            
            if (emp.firebaseId) {
                await updateEmployeeInFirebase(emp.firebaseId, { [field]: emp[field] });
            }
            renderContent();
        }

        async function deleteEmployee(index) {
            // التحقق من قفل الشهر
            if (!canEditCurrentMonth()) {
                showNotification('warning', t('warning'), t('monthLocked'));
                return;
            }
            
            // التحقق من وجود المستخدم
            if (!currentUser) {
                showNotification('error', t('notAuthorized'), t('loginRequired'));
                return;
            }
            
            // الحصول على نوع الموظف للتحقق من الصلاحية المناسبة
            const emp = employeeData[currentYear] && employeeData[currentYear][currentMonth] ? 
                       employeeData[currentYear][currentMonth][index] : null;
            
            if (!emp) {
                showNotification('error', t('error'), t('employeeNotFound'));
                return;
            }
            
            // التحقق من حالة الدفع - منع الحذف إذا تم الدفع
            if (emp.isPaid === true) {
                const paidDate = emp.paidDate ? new Date(emp.paidDate).toLocaleDateString(currentLang === 'ar' ? 'ar-EG' : 'en-US') : '';
                const message = currentLang === 'ar' 
                    ? `⚠️ لا يمكن حذف الموظف الذي تم الدفع له${paidDate ? ' في ' + paidDate : ''}`
                    : `⚠️ Cannot delete employee who has been paid${paidDate ? ' on ' + paidDate : ''}`;
                showNotification('error', currentLang === 'ar' ? 'تم الدفع' : 'Paid', message);
                return;
            }
            
            const employeeType = emp.employeeType || 'monthly';
            
            // التحقق من الصلاحيات التفصيلية
            if (!hasDetailedPermission('employees', 'delete', null, employeeType)) {
                showNotification('error', t('notAuthorized'), `${t('noDeletePermission')} ${t('employees')} ${t('employeeType')}: ${employeeType}`);
                return;
            }
            
            if (confirm(t('confirmDeleteEmployee'))) {
                if (emp.firebaseId) {
                    await deleteEmployeeFromFirebase(emp.firebaseId);
                }
            }
        }

        async function deleteProject(code) {
            // التحقق من قفل الشهر
            if (!canEditCurrentMonth()) {
                showNotification('warning', t('warning'), t('monthLocked'));
                return;
            }
            
            // التحقق من وجود المستخدم
            if (!currentUser) {
                showNotification('error', t('notAuthorized'), t('loginRequired'));
                return;
            }
            
            // التحقق من الصلاحيات التفصيلية
            if (!hasDetailedPermission('projects', 'delete')) {
                showNotification('error', 'غير مصرح', 'ليس لديك صلاحية لحذف المشاريع');
                return;
            }
            
            // التحقق من وجود موظفين في هذا المشروع في أي سنة أو شهر
            let hasEmployees = false;
            let employeeCount = 0;
            let foundInYears = [];
            
            Object.keys(employeeData).forEach(year => {
            months.forEach(month => {
                    if (employeeData[year] && employeeData[year][month]) {
                        const empsInProject = employeeData[year][month].filter(emp => emp.project === code);
                        if (empsInProject.length > 0) {
                    hasEmployees = true;
                            employeeCount += empsInProject.length;
                            if (!foundInYears.includes(year)) {
                                foundInYears.push(year);
                            }
                        }
                }
                });
            });

            if (hasEmployees) {
                const message = currentLang === 'ar' ? 
                    `❌ لا يمكن حذف هذا المشروع!\n\n` +
                    `📊 المشروع يحتوي على ${employeeCount} موظف\n` +
                    `📅 في السنوات: ${foundInYears.join(', ')}\n\n` +
                    `⚠️ الرجاء حذف أو نقل جميع الموظفين أولاً.` : 
                    `❌ Cannot delete this project!\n\n` +
                    `📊 Project contains ${employeeCount} employees\n` +
                    `📅 In years: ${foundInYears.join(', ')}\n\n` +
                    `⚠️ Please delete or move all employees first.`;
                
                showNotification('error', '🚫 لا يمكن الحذف', message);
                closeAllDropdowns();
                console.warn(`⚠️ محاولة حذف مشروع "${projects[code]}" لكنه يحتوي على ${employeeCount} موظف`);
                return;
            }

            if (confirm(currentLang === 'ar' ? 
                `🗑️ هل أنت متأكد من حذف المشروع "${projects[code]}"?\n\n⚠️ هذا الإجراء لا يمكن التراجع عنه!` : 
                `🗑️ Are you sure you want to delete project "${projects[code]}"?\n\n⚠️ This action cannot be undone!`)) {
                
                console.log(`🗑️ حذف المشروع: ${code} - ${projects[code]}`);
                await deleteProjectFromFirebase(code);
                closeAllDropdowns();
                
                // إذا كان المشروع المحذوف هو المشروع الحالي المعروض، العودة للوحة التحكم
                if (currentProject === code) {
                    console.log('🔄 المشروع المحذوف كان معروضاً، العودة للوحة التحكم');
                    showTab('dashboard');
                }
                
                // إعادة تحميل المشاريع لتحديث القوائم
                await loadProjectsFromFirebase();
                renderContent();
            }
        }
// ========== Modal Functions ==========
        function openModal(modalId) {
            // التحقق من قفل الشهر للمودالات الحساسة
            // ملاحظة: copySelectedModal و copyAllModal لا تحتاجان للتحقق من canEditCurrentMonth لأن النسخ لا يعدل البيانات الأصلية
            if ((modalId === 'employeeModal' || modalId === 'editModal' || modalId === 'attendanceModal' || modalId === 'copyModal' || modalId === 'projectModal' || modalId === 'editProjectModal') && !canEditCurrentMonth()) {
                showNotification('warning', t('warning'), t('monthLocked'));
                return;
            }
            
            const modalElement = document.getElementById(modalId);
            if (!modalElement) {
                console.error('❌ لم يتم العثور على النافذة:', modalId);
                showNotification('error', 'خطأ', 'لم يتم العثور على النافذة: ' + modalId);
                return;
            }
            
            modalElement.classList.add('active');
            if (modalId === 'employeeModal' || modalId === 'editModal') {
                populateProjectSelects();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openEditModal(index) {
            try {
                console.log('🔧 فتح نافذة التعديل للموظف:', index);
                
                // التحقق من قفل الشهر
                if (!canEditCurrentMonth()) {
                    showNotification('warning', t('warning'), t('monthLocked'));
                    return;
                }
                
                employeeIndexToEdit = index;
                
                // التحقق من وجود البيانات
                if (!employeeData[currentYear] || !employeeData[currentYear][currentMonth]) {
                    console.error('❌ بيانات الشهر غير موجودة');
                    showNotification('error', t('error'), t('monthDataNotFound'));
                    return;
                }
                
                const emp = employeeData[currentYear][currentMonth][index];
                
                if (!emp) {
                    console.error('❌ الموظف غير موجود في index:', index);
                    showNotification('error', t('error'), t('employeeNotFound'));
                    return;
                }
                
                // التحقق من حالة الدفع - منع التعديل إذا تم الدفع
                if (emp.isPaid === true) {
                    const paidDate = emp.paidDate ? new Date(emp.paidDate).toLocaleDateString(currentLang === 'ar' ? 'ar-EG' : 'en-US') : '';
                    const message = currentLang === 'ar' 
                        ? `⚠️ لا يمكن تعديل بيانات الموظف الذي تم الدفع له${paidDate ? ' في ' + paidDate : ''}`
                        : `⚠️ Cannot edit employee who has been paid${paidDate ? ' on ' + paidDate : ''}`;
                    showNotification('error', currentLang === 'ar' ? 'تم الدفع' : 'Paid', message);
                    return;
                }
                
                console.log('✅ بيانات الموظف المُحمّلة:', {
                    name: emp.nameAr,
                    type: emp.employeeType,
                    attendanceSystem: emp.attendanceSystem,
                    firebaseId: emp.firebaseId
                });
                
                // عرض الرمز
                document.getElementById('editEmployeeCode').textContent = emp.employeeCode || 'غير محدد';
            
                // ✅ الخطوة 1: ملء قوائم المشاريع أولاً
                populateProjectSelects();
                
                // ✅ الخطوة 2: فتح النافذة
                openModal('editModal');
                
                // ✅ الخطوة 3: تعيين القيم بعد فتح النافذة وملء القوائم
                setTimeout(() => {
                    // البيانات الأساسية
                    document.getElementById('editNameAr').value = emp.nameAr || '';
                    document.getElementById('editNameEn').value = emp.nameEn || '';
                    document.getElementById('editPosition').value = emp.position || '';
                    document.getElementById('editEmployeeType').value = emp.employeeType || 'monthly';
                    document.getElementById('editSalary').value = emp.salary || 0;
                    document.getElementById('editSalaryCurrency').value = emp.salaryCurrency || 'USD';
                    document.getElementById('editPaymentCurrency').value = emp.paymentCurrency || 'IQD';
                    document.getElementById('editExchangeRate').value = emp.exchangeRate || 1420;
                    
                    // ✅ حقل المشروع - التعيين المباشر بعد ملء القائمة
                    const projectSelect = document.getElementById('editProject');
                    if (projectSelect && emp.project) {
                        // التحقق من وجود المشروع في القائمة
                        const projectExists = Array.from(projectSelect.options).some(opt => opt.value === emp.project);
                        
                        if (projectExists) {
                            projectSelect.value = emp.project;
                            console.log('✅ تم تعيين المشروع بنجاح:', emp.project, '→', projects[emp.project]);
                        } else {
                            console.warn('⚠️ المشروع غير موجود في القائمة:', emp.project);
                            // إضافة المشروع للقائمة إذا لم يكن موجوداً
                            const option = document.createElement('option');
                            option.value = emp.project;
                            option.textContent = `${emp.project} - ${projects[emp.project] || 'غير معروف'}`;
                            projectSelect.appendChild(option);
                            projectSelect.value = emp.project;
                        }
                    }
            
            // إعدادات الدوام
                    document.getElementById('editAttendanceSystem').value = emp.attendanceSystem || 'hours';
            document.getElementById('editDailyWorkHours').value = emp.dailyWorkHours || 8;
            
            // تحميل معامل الأوفر تايم
            const overtimeSelect = document.getElementById('editOvertimeMultiplier');
                    if (overtimeSelect) {
                        overtimeSelect.value = emp.overtimeMultiplier || 1.5;
                    }
            
            // تحميل طريقة احتساب الشهر
            const monthCalcSelect = document.getElementById('editMonthCalculationMethod');
                    if (monthCalcSelect) {
                        monthCalcSelect.value = emp.monthCalculationMethod || '30';
                    }
            
            // تحميل أيام العمل الأسبوعية
            const workDaysOfWeek = emp.workDaysOfWeek || [true, true, true, true, true, false, true];
            for (let i = 0; i < 7; i++) {
                const checkbox = document.getElementById(`editWorkDay_${i}`);
                        if (checkbox) {
                            checkbox.checked = workDaysOfWeek[i] === true;
                        }
                    }
                    
                    // تحميل احتساب الإجازات المدفوعة
                    const paidLeaveSelect = document.getElementById('editPaidLeaveCalculation');
                    if (paidLeaveSelect) {
                        paidLeaveSelect.value = emp.paidLeaveCalculation || 'full';
                    }
                    
                    // تحديث التسميات
                    updateSalaryLabelByType('editSalary');
                    
                }, 100);
                
                console.log('✅ تم فتح نافذة التعديل بنجاح');
                
            } catch (error) {
                console.error('❌ خطأ في openEditModal:', error);
                showNotification('error', t('error'), t('editWindowError') + ': ' + error.message);
            }
        }

        function openCopyModal(index) {
            // التحقق من قفل الشهر
            if (!canEditCurrentMonth()) {
                showNotification('warning', t('warning'), t('monthLocked'));
                return;
            }
            
            employeeIndexToCopy = index;
            
            // ملء قائمة السنوات
            const yearSelect = document.getElementById('copyTargetYear');
            yearSelect.innerHTML = '';
            const availableYears = Object.keys(employeeData).sort((a, b) => b - a);
            availableYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year == currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            });
            
            // ملء الأشهر
            const checkboxContainer = document.getElementById('monthCheckboxes');
            checkboxContainer.innerHTML = '';
            months.forEach(month => {
                    const item = document.createElement('div');
                    item.className = 'checkbox-item';
                item.style.cssText = 'display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 6px; transition: all 0.2s; cursor: pointer;';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `month_${month}`;
                checkbox.value = month;
                checkbox.style.cssText = 'width: 18px; height: 18px; cursor: pointer;';
                
                const label = document.createElement('label');
                label.htmlFor = `month_${month}`;
                label.textContent = t('monthNames')[month];
                label.style.cssText = 'cursor: pointer; flex: 1; font-size: 14px;';
                
                // تمييز الشهر الحالي
                if (month === currentMonth) {
                    item.style.background = '#fef3c7';
                    item.style.border = '2px solid #f59e0b';
                    const currentBadge = document.createElement('span');
                    currentBadge.textContent = '(الحالي)';
                    currentBadge.style.cssText = 'font-size: 11px; color: #92400e; font-weight: 600;';
                    label.appendChild(currentBadge);
                    checkbox.disabled = true;
                } else {
                    item.addEventListener('mouseenter', () => {
                        item.style.background = '#dbeafe';
                    });
                    item.addEventListener('mouseleave', () => {
                        item.style.background = '';
                    });
                }
                
                // عند النقر على الصف، تبديل الـ checkbox
                item.addEventListener('click', (e) => {
                    if (e.target !== checkbox && !checkbox.disabled) {
                        checkbox.checked = !checkbox.checked;
                    }
                });
                
                item.appendChild(checkbox);
                item.appendChild(label);
                checkboxContainer.appendChild(item);
            });
            
            openModal('copyModal');
        }

        async function confirmCopy() {
            const targetYear = document.getElementById('copyTargetYear').value;
            if (!targetYear) {
                showNotification('warning', '⚠️ تنبيه', 'الرجاء اختيار السنة المستهدفة');
                return;
            }
            
            const selectedMonths = [];
            months.forEach(month => {
                const checkbox = document.getElementById(`month_${month}`);
                if (checkbox && checkbox.checked) selectedMonths.push(month);
            });
            if (selectedMonths.length === 0) {
                showNotification('warning', '⚠️ تنبيه', 'الرجاء اختيار شهر واحد على الأقل');
                return;
            }
            
            showLoading();
            const emp = employeeData[currentYear][currentMonth][employeeIndexToCopy];
            const empName = emp.nameAr || emp.name;
            let copiedCount = 0;
            let skippedCount = 0;
            
            // تأكد من وجود بيانات للسنة المستهدفة
            if (!employeeData[targetYear]) {
                employeeData[targetYear] = {};
            }
            
            for (const month of selectedMonths) {
                if (!employeeData[targetYear][month]) {
                    employeeData[targetYear][month] = [];
                }
                
                const monthData = employeeData[targetYear][month];
                const exists = monthData.some(e => e.nameAr === emp.nameAr && e.project === emp.project);
                if (!exists) {
                    const copiedEmployee = {
                        ...emp,
                        workDays: 30,
                        bonus: 0,
                        phoneBills: 0,
                        deductions: 0,
                        advance: 0,
                        ceoBonus: 0,
                        attendance: {}, // إعادة تعيين الدوام
                        isPaid: false // إعادة تعيين حالة الدفع
                    };
                    // حذف الحقول التي لا يجب أن تكون موجودة في النسخة الجديدة
                    delete copiedEmployee.firebaseId;
                    delete copiedEmployee.paidDate; // حذف تاريخ الدفع (بدلاً من undefined)
                    delete copiedEmployee.paymentMethod; // حذف طريقة الدفع
                    await saveEmployeeToFirebase(copiedEmployee, month, targetYear);
                    copiedCount++;
                    console.log(`✅ تم نسخ ${empName} إلى ${t('monthNames')[month]} ${targetYear}`);
                } else {
                    skippedCount++;
                    console.log(`⚠️ تم تخطي ${empName} في ${t('monthNames')[month]} ${targetYear} (موجود مسبقاً)`);
                }
            }
            
            hideLoading();
            closeModal('copyModal');
            
            // رسالة تفصيلية
            let message = `✅ تم نسخ الموظف "${empName}"\n`;
            message += `📋 إلى ${copiedCount} شهر`;
            if (targetYear != currentYear) {
                message += ` في سنة ${targetYear}`;
            }
            if (skippedCount > 0) {
                message += `\n⚠️ تم تخطي ${skippedCount} شهر (موجود مسبقاً)`;
            }
            
            showNotification('success', '✓ تم النسخ', message);
            
            // إعادة تحميل البيانات إذا كانت السنة المستهدفة هي السنة الحالية
            if (targetYear == currentYear) {
                await loadEmployeesFromFirebase();
                renderContent();
            }
        }

        // ========== Attendance System Functions ==========
        let currentAttendanceEmployee = null;
        let currentAttendanceMonth = null;
        let currentAttendanceYear = null;
        let attendanceData = {}; // {day: {type, hours, startTime, endTime}}
        
        function openAttendanceModal(index, monthKey = currentMonth, year = currentYear) {
            const targetMonth = monthKey || currentMonth;
            const targetYear = year || currentYear;

            if (!targetMonth) {
                showNotification('error', t('error'), t('noMonthSelected'));
                return;
            }

            // التحقق من قفل الشهر
            if (!canEditCurrentMonth(targetMonth, targetYear)) {
                showNotification('warning', t('warning'), t('monthLockedWarning'));
                return;
            }

            const yearBucket = employeeData[targetYear] || {};
            const monthEmployees = yearBucket[targetMonth] || [];
            if (!monthEmployees[index]) {
                showNotification('error', t('error'), t('employeeDataNotFound'));
                return;
            }
            
            const emp = monthEmployees[index];
            
            // التحقق من حالة الدفع - منع تعديل الدوام إذا تم الدفع
            if (emp.isPaid === true) {
                const paidDate = emp.paidDate ? new Date(emp.paidDate).toLocaleDateString(currentLang === 'ar' ? 'ar-EG' : 'en-US') : '';
                const message = currentLang === 'ar' 
                    ? `⚠️ لا يمكن تعديل دوام الموظف الذي تم الدفع له${paidDate ? ' في ' + paidDate : ''}`
                    : `⚠️ Cannot edit attendance for employee who has been paid${paidDate ? ' on ' + paidDate : ''}`;
                showNotification('error', currentLang === 'ar' ? 'تم الدفع' : 'Paid', message);
                return;
            }

            currentMonth = targetMonth;
            currentYear = targetYear;
            currentAttendanceMonth = targetMonth;
            currentAttendanceYear = targetYear;
            currentAttendanceEmployee = emp;
            attendanceData = currentAttendanceEmployee.attendance || {};
            updateYearSelector();
            
            // تعبئة معلومات الموظف
            document.getElementById('attendanceEmployeeName').textContent = currentAttendanceEmployee.nameAr || currentAttendanceEmployee.name;
            document.getElementById('attendanceEmployeeCode').textContent = currentAttendanceEmployee.employeeCode || 'غير محدد';
            document.getElementById('attendanceMonth').textContent = t('monthNames')[targetMonth];
            document.getElementById('attendanceYear').textContent = targetYear;
            
            const attendanceSystem = currentAttendanceEmployee.attendanceSystem || 'days';
            const dailyHours = currentAttendanceEmployee.dailyWorkHours || 8;
            const overtimeMultiplier = currentAttendanceEmployee.overtimeMultiplier || 1.5;
            const monthCalcMethod = currentAttendanceEmployee.monthCalculationMethod || '30';
            const paidLeaveCalc = currentAttendanceEmployee.paidLeaveCalculation || 'full';
            const workDaysOfWeek = currentAttendanceEmployee.workDaysOfWeek || [true, true, true, true, true, false, true];
            
            document.getElementById('empAttendanceSystem').textContent = 
                attendanceSystem === 'hours' ? '⏱️ بالساعات (مع الأوفر تايم)' : '💰 راتب ثابت';
            document.getElementById('empDailyHours').textContent = dailyHours + ' ساعة';
            document.getElementById('empOvertimeMultiplier').textContent = overtimeMultiplier + '×';
            document.getElementById('empMonthCalcMethod').textContent = 
                monthCalcMethod === '30' ? '30 يوم دائماً' : 'حسب أيام الشهر الفعلية';
            
            // عرض أيام العمل الأسبوعية
            const dayNames = ['أحد', 'اثنين', 'ثلاثاء', 'أربعاء', 'خميس', 'جمعة', 'سبت'];
            const workDaysText = workDaysOfWeek.map((isWork, i) => isWork ? dayNames[i] : null).filter(d => d).join('، ');
            document.getElementById('empWorkDays').textContent = workDaysText || 'غير محدد';
            
            document.getElementById('empPaidLeaveCalc').textContent = 
                paidLeaveCalc === 'full' ? 'كامل الراتب' : paidLeaveCalc === 'half' ? 'نصف الراتب' : 'بدون راتب';
            
            renderAttendanceCalendar();
            updateAttendanceSummary();
            openModal('attendanceModal');
        }
        
        function renderAttendanceCalendar() {
            const calendar = document.getElementById('attendanceCalendar');
            calendar.innerHTML = '';
            const monthKey = currentAttendanceMonth || currentAttendanceEmployee?.month || currentMonth;
            const yearKey = currentAttendanceYear || currentAttendanceEmployee?.year || currentYear;
            if (!monthKey) return;
            
            // أسماء الأيام
            const dayNames = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            
            // إضافة رؤوس أيام الأسبوع
            dayNames.forEach(dayName => {
                const header = document.createElement('div');
                header.style.cssText = 'font-weight: 700; padding: 10px; text-align: center; background: var(--primary); color: white; border-radius: 8px; font-size: 12px;';
                header.textContent = dayName;
                calendar.appendChild(header);
            });
            
            // الحصول على عدد أيام الشهر
            const monthIndex = months.indexOf(monthKey);
            const daysInMonth = new Date(yearKey, monthIndex + 1, 0).getDate();
            const firstDay = new Date(yearKey, monthIndex, 1).getDay();
            
            // إضافة خلايا فارغة للأيام قبل بداية الشهر
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                calendar.appendChild(emptyCell);
            }
            
            // إضافة أيام الشهر
            for (let day = 1; day <= daysInMonth; day++) {
                const dayData = attendanceData[day] || { type: 'not-set' };
                const dayDiv = document.createElement('div');
                dayDiv.className = 'attendance-day';
                
                // تحديد اللون بناءً على النوع
                if (dayData.type === 'full') dayDiv.classList.add('full-day');
                else if (dayData.type === 'half') dayDiv.classList.add('half-day');
                else if (dayData.type === 'paid-leave') dayDiv.classList.add('paid-leave');
                else if (dayData.type === 'absent') dayDiv.classList.add('absent');
                else if (dayData.type === 'custom-hours') dayDiv.classList.add('custom-hours');
                
                const dayOfWeek = new Date(yearKey, monthIndex, day).getDay();
                const isWeekend = dayOfWeek === 5; // الجمعة
                if (isWeekend && dayData.type === 'not-set') dayDiv.classList.add('weekend');
                
                // تحديد الخيارات حسب نوع الموظف
                const isDailyEmployee = currentAttendanceEmployee.employeeType === 'daily';
                const paidLeaveOption = isDailyEmployee ? '' : `<option value="paid-leave" ${dayData.type === 'paid-leave' ? 'selected' : ''}>💚 إجازة مدفوعة</option>`;
                
                // عرض الفترات المتقطعة
                let periodsHTML = '';
                if (dayData.type === 'custom-hours') {
                    const periods = dayData.periods || [{ startTime: '08:00', endTime: '16:00' }];
                    
                    // حساب إجمالي ساعات اليوم
                    let totalDayHours = 0;
                    periods.forEach(period => {
                        if (period.startTime && period.endTime) {
                            const start = new Date(`2000-01-01T${period.startTime}`);
                            const end = new Date(`2000-01-01T${period.endTime}`);
                            totalDayHours += Math.max(0, (end - start) / (1000 * 60 * 60));
                        }
                    });
                    
                    const dailyWorkHours = currentAttendanceEmployee.dailyWorkHours || 8;
                    const isLessThanRequired = totalDayHours < dailyWorkHours;
                    const isMoreThanRequired = totalDayHours > dailyWorkHours;
                    
                    periods.forEach((period, idx) => {
                        periodsHTML += `
                            <div style="margin-top: 6px; padding: 6px; background: white; border-radius: 4px; font-size: 10px;">
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <input type="time" value="${period.startTime}" onchange="updatePeriodTime(${day}, ${idx}, 'start', this.value)" style="width: 65px; padding: 2px;" />
                                    <span>→</span>
                                    <input type="time" value="${period.endTime}" onchange="updatePeriodTime(${day}, ${idx}, 'end', this.value)" style="width: 65px; padding: 2px;" />
                                    ${periods.length > 1 ? `<button onclick="removePeriod(${day}, ${idx})" style="background: #ef4444; color: white; border: none; border-radius: 3px; padding: 2px 6px; cursor: pointer; font-size: 10px;">✗</button>` : ''}
                                </div>
                            </div>`;
                    });
                    
                    periodsHTML += `<button onclick="addPeriod(${day})" style="width: 100%; margin-top: 4px; background: #10b981; color: white; border: none; border-radius: 4px; padding: 4px; cursor: pointer; font-size: 10px;">➕ فترة</button>`;
                    
                    // عرض إجمالي الساعات
                    periodsHTML += `
                        <div style="margin-top: 6px; padding: 6px; background: ${isLessThanRequired ? '#fee2e2' : isMoreThanRequired ? '#fef3c7' : '#d1fae5'}; border-radius: 4px; font-size: 10px; text-align: center; font-weight: 600; color: ${isLessThanRequired ? '#991b1b' : isMoreThanRequired ? '#92400e' : '#065f46'};">
                            ⏱️ المجموع: ${totalDayHours.toFixed(1)} ساعة ${isLessThanRequired ? '(نقص ' + (dailyWorkHours - totalDayHours).toFixed(1) + ' ⬇️)' : isMoreThanRequired ? '(زيادة ' + (totalDayHours - dailyWorkHours).toFixed(1) + ' ⬆️)' : '(مطابق ✓)'}
                        </div>`;
                    
                    // خيارات الاحتساب - تظهر فقط عند النقص أو الزيادة
                    if (isLessThanRequired) {
                        const countAsLeave = dayData.countAsLeave !== false; // افتراضياً true
                        periodsHTML += `
                            <div style="margin-top: 6px; padding: 8px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 6px; font-size: 10px;">
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 600; color: #92400e;">
                                    <input type="checkbox" ${countAsLeave ? 'checked' : ''} onchange="toggleCountAsLeave(${day}, this.checked)" style="width: 16px; height: 16px; cursor: pointer;">
                                    <span>💚 احتساب كإجازة زمنية (لا تخفض الراتب)</span>
                                </label>
                                <div style="margin-top: 4px; font-size: 9px; color: #78350f; opacity: 0.8;">
                                    ${countAsLeave ? '✅ سيُحتسب يوم كامل' : '⚠️ سيُحتسب ' + totalDayHours.toFixed(1) + '÷' + dailyWorkHours + ' = ' + (totalDayHours/dailyWorkHours).toFixed(2) + ' يوم'}
                                </div>
                            </div>`;
                    } else if (isMoreThanRequired) {
                        const countOvertime = dayData.countOvertime !== false; // افتراضياً true
                        const overtimeMultiplier = currentAttendanceEmployee.overtimeMultiplier || 1.5;
                        periodsHTML += `
                            <div style="margin-top: 6px; padding: 8px; background: #e0f2fe; border: 2px solid #0ea5e9; border-radius: 6px; font-size: 10px;">
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 600; color: #075985;">
                                    <input type="checkbox" ${countOvertime ? 'checked' : ''} onchange="toggleCountOvertime(${day}, this.checked)" style="width: 16px; height: 16px; cursor: pointer;">
                                    <span>⚡ احتساب الزيادة كأوفر تايم (×${overtimeMultiplier})</span>
                                </label>
                                <div style="margin-top: 4px; font-size: 9px; color: #0c4a6e; opacity: 0.8;">
                                    ${countOvertime ? '✅ ' + dailyWorkHours + ' عادية + ' + (totalDayHours - dailyWorkHours).toFixed(1) + '×' + overtimeMultiplier + ' أوفر تايم' : '⚠️ سيُحتسب ' + dailyWorkHours + ' ساعة فقط'}
                                </div>
                            </div>`;
                    }
                }
                
                dayDiv.innerHTML = `
                    <div class="day-number">${day}</div>
                    <div class="day-name">${dayNames[dayOfWeek]}</div>
                    <select onchange="updateDayAttendance(${day}, this.value)">
                        <option value="not-set" ${dayData.type === 'not-set' ? 'selected' : ''}>-- اختر --</option>
                        <option value="full" ${dayData.type === 'full' ? 'selected' : ''}>✓ ${isDailyEmployee ? 'حضر' : 'دوام كامل'}</option>
                        <option value="half" ${dayData.type === 'half' ? 'selected' : ''}>⊕ نصف يوم</option>
                        ${paidLeaveOption}
                        <option value="absent" ${dayData.type === 'absent' ? 'selected' : ''}>✗ غياب</option>
                        <option value="custom-hours" ${dayData.type === 'custom-hours' ? 'selected' : ''}>🕐 ساعات/فترات</option>
                    </select>
                    ${dayData.type === 'custom-hours' ? periodsHTML : ''}
                `;
                
                calendar.appendChild(dayDiv);
            }
        }
        
        function updateDayAttendance(day, type) {
            if (!attendanceData[day]) attendanceData[day] = {};
            attendanceData[day].type = type;
            
            // إذا اختار ساعات محددة، تعيين فترة افتراضية
            if (type === 'custom-hours') {
                if (!attendanceData[day].periods) {
                    attendanceData[day].periods = [{ startTime: '08:00', endTime: '16:00' }];
                }
            }
            
            renderAttendanceCalendar();
            updateAttendanceSummary();
        }
        
        // إدارة الفترات المتقطعة
        function updatePeriodTime(day, periodIndex, timeType, value) {
            if (!attendanceData[day]) attendanceData[day] = { type: 'custom-hours', periods: [] };
            if (!attendanceData[day].periods) attendanceData[day].periods = [];
            if (!attendanceData[day].periods[periodIndex]) {
                attendanceData[day].periods[periodIndex] = { startTime: '08:00', endTime: '16:00' };
            }
            
            if (timeType === 'start') {
                attendanceData[day].periods[periodIndex].startTime = value;
            } else {
                attendanceData[day].periods[periodIndex].endTime = value;
            }
            
            updateAttendanceSummary();
        }
        
        function addPeriod(day) {
            if (!attendanceData[day]) attendanceData[day] = { type: 'custom-hours', periods: [] };
            if (!attendanceData[day].periods) attendanceData[day].periods = [];
            
            // إضافة فترة جديدة
            attendanceData[day].periods.push({ startTime: '08:00', endTime: '16:00' });
            renderAttendanceCalendar();
            updateAttendanceSummary();
        }
        
        function removePeriod(day, periodIndex) {
            if (attendanceData[day] && attendanceData[day].periods) {
                attendanceData[day].periods.splice(periodIndex, 1);
                if (attendanceData[day].periods.length === 0) {
                    // إذا تم حذف جميع الفترات، العودة لفترة واحدة
                    attendanceData[day].periods = [{ startTime: '08:00', endTime: '16:00' }];
                }
                renderAttendanceCalendar();
                updateAttendanceSummary();
            }
        }
        
        // دوال التحكم في خيارات الاحتساب
        function toggleCountAsLeave(day, isChecked) {
            if (!attendanceData[day]) attendanceData[day] = { type: 'custom-hours' };
            attendanceData[day].countAsLeave = isChecked;
            renderAttendanceCalendar();
            updateAttendanceSummary();
        }
        
        function toggleCountOvertime(day, isChecked) {
            if (!attendanceData[day]) attendanceData[day] = { type: 'custom-hours' };
            attendanceData[day].countOvertime = isChecked;
            renderAttendanceCalendar();
            updateAttendanceSummary();
        }
        
        // للتوافق الخلفي
        function updateCustomHours(day, timeType, value) {
            updatePeriodTime(day, 0, timeType, value);
        }
        
        function updateAttendanceSummary() {
            let fullDays = 0, halfDays = 0, paidLeaveDays = 0, absentDays = 0;
            let totalRegularHours = 0; // ساعات عادية
            let totalOvertimeHours = 0; // ساعات أوفر تايم
            
            const dailyWorkHours = parseFloat(currentAttendanceEmployee.dailyWorkHours || 8);
            const overtimeMultiplier = parseFloat(currentAttendanceEmployee.overtimeMultiplier || 1.5);
            
            Object.values(attendanceData).forEach(dayData => {
                if (dayData.type === 'full') {
                    fullDays++;
                    totalRegularHours += dailyWorkHours;
                } else if (dayData.type === 'half') {
                    halfDays++;
                    totalRegularHours += dailyWorkHours / 2;
                } else if (dayData.type === 'paid-leave') {
                    paidLeaveDays++;
                    const paidLeaveCalc = currentAttendanceEmployee.paidLeaveCalculation || 'full';
                    if (paidLeaveCalc === 'full') totalRegularHours += dailyWorkHours;
                    else if (paidLeaveCalc === 'half') totalRegularHours += dailyWorkHours / 2;
                } else if (dayData.type === 'absent') {
                    absentDays++;
                } else if (dayData.type === 'custom-hours') {
                    // حساب الساعات من الفترات المتقطعة
                    let dayTotalHours = 0;
                    
                    if (dayData.periods && dayData.periods.length > 0) {
                        // فترات متقطعة
                        dayData.periods.forEach(period => {
                            if (period.startTime && period.endTime) {
                                const start = new Date(`2000-01-01T${period.startTime}`);
                                const end = new Date(`2000-01-01T${period.endTime}`);
                                const hours = (end - start) / (1000 * 60 * 60);
                                dayTotalHours += Math.max(0, hours);
                            }
                        });
                    } else if (dayData.startTime && dayData.endTime) {
                        // للتوافق الخلفي: فترة واحدة قديمة
                        const start = new Date(`2000-01-01T${dayData.startTime}`);
                        const end = new Date(`2000-01-01T${dayData.endTime}`);
                        dayTotalHours = Math.max(0, (end - start) / (1000 * 60 * 60));
                    }
                    
                    // التحقق من الخيارات الجديدة
                    const countAsLeave = dayData.countAsLeave !== false; // افتراضياً true
                    const countOvertime = dayData.countOvertime !== false; // افتراضياً true
                    
                    // تقسيم الساعات: عادية وأوفر تايم
                    if (dayTotalHours < dailyWorkHours) {
                        // حالة النقص
                        if (countAsLeave) {
                            // احتساب كإجازة زمنية - يوم كامل
                        totalRegularHours += dailyWorkHours;
                        } else {
                            // احتساب الساعات الفعلية فقط
                            totalRegularHours += dayTotalHours;
                        }
                    } else if (dayTotalHours > dailyWorkHours) {
                        // حالة الزيادة
                        totalRegularHours += dailyWorkHours;
                        if (countOvertime) {
                            // احتساب الزيادة كأوفر تايم
                        totalOvertimeHours += (dayTotalHours - dailyWorkHours) * overtimeMultiplier;
                        }
                        // إذا لم يكن countOvertime، الساعات الزائدة تُهمل
                    } else {
                        // الساعات مطابقة تماماً
                        totalRegularHours += dayTotalHours;
                    }
                }
            });
            
            const totalHours = totalRegularHours + totalOvertimeHours;
            const totalDays = fullDays + (halfDays * 0.5) + paidLeaveDays;
            
            document.getElementById('fullDaysCount').textContent = fullDays;
            document.getElementById('halfDaysCount').textContent = halfDays;
            document.getElementById('paidLeaveDaysCount').textContent = paidLeaveDays;
            document.getElementById('absentDaysCount').textContent = absentDays;
            document.getElementById('totalHoursCount').textContent = totalRegularHours.toFixed(1);
            
            // عرض ساعات الأوفر تايم
            const overtimeElement = document.getElementById('overtimeHoursCount');
            if (overtimeElement) {
                overtimeElement.textContent = totalOvertimeHours.toFixed(1);
            }
            
            // حساب الراتب مع الأوفر تايم
            const calculatedSalary = calculateAttendanceSalary(totalRegularHours, totalOvertimeHours, totalDays);
            document.getElementById('calculatedSalary').textContent = formatCurrency(calculatedSalary);
        }
        
        function calculateAttendanceSalary(regularHours, overtimeHours, totalDays) {
            const emp = currentAttendanceEmployee;
            const attendanceSystem = emp.attendanceSystem || 'hours';
            const salary = parseFloat(emp.salary || 0);
            const monthCalculationMethod = emp.monthCalculationMethod || '30';
            const dailyWorkHours = parseFloat(emp.dailyWorkHours || 8);
            
            // حساب الأيام الفعلية في الشهر
            const monthKey = currentAttendanceMonth || emp.month || currentMonth;
            const yearKey = currentAttendanceYear || emp.year || currentYear;
            const monthIndex = months.indexOf(monthKey);
            const actualDaysInMonth = monthIndex === -1 ? 30 : new Date(yearKey, monthIndex + 1, 0).getDate();
            const divisor = monthCalculationMethod === '30' ? 30 : actualDaysInMonth;
            
            if (attendanceSystem === 'fixed') {
                // راتب ثابت - بدون النظر للدوام
                return salary;
            } else {
                // بالساعات - مع الأوفر تايم والخصومات
                const expectedMonthlyHours = divisor * dailyWorkHours;
                const hourlyRate = salary / expectedMonthlyHours;
                
                // الراتب = (ساعات عادية × أجر الساعة) + (ساعات أوفر تايم × أجر الساعة)
                // ملاحظة: ساعات الأوفر تايم مضروبة مسبقاً بالمعامل
                return (regularHours * hourlyRate) + (overtimeHours * hourlyRate);
            }
        }
        
        function fillAllWorkDays() {
            const monthKey = currentAttendanceMonth || currentAttendanceEmployee?.month || currentMonth;
            const yearKey = currentAttendanceYear || currentAttendanceEmployee?.year || currentYear;
            const monthIndex = months.indexOf(monthKey);
            const daysInMonth = monthIndex === -1 ? 30 : new Date(yearKey, monthIndex + 1, 0).getDate();
            const workDaysOfWeek = currentAttendanceEmployee.workDaysOfWeek || [true, true, true, true, true, false, true];
            const employeeType = currentAttendanceEmployee.employeeType || 'monthly';
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayOfWeek = new Date(yearKey, monthIndex, day).getDay();
                
                // التحقق من أيام العمل المحددة في بطاقة الموظف
                if (workDaysOfWeek[dayOfWeek]) {
                    // يوم عمل → دوام كامل
                    attendanceData[day] = { type: 'full' };
                } else {
                    // ليس يوم عمل (عطلة أسبوعية)
                    // للموظف الشهري والسيارة: إجازة مدفوعة
                    // للموظف اليومي: لا شيء (لا راتب)
                    if (employeeType === 'monthly' || employeeType === 'vehicle') {
                        attendanceData[day] = { type: 'paid-leave' };
                    } else {
                        attendanceData[day] = { type: 'not-set' };
                    }
                }
            }
            
            renderAttendanceCalendar();
            updateAttendanceSummary();
            
            const workDaysCount = Object.values(attendanceData).filter(d => d.type === 'full').length;
            const paidLeaveCount = Object.values(attendanceData).filter(d => d.type === 'paid-leave').length;
            
            showNotification('success', 'تم التعبئة', 
                `✅ ${workDaysCount} يوم دوام كامل${paidLeaveCount > 0 ? ` + ${paidLeaveCount} يوم إجازة مدفوعة` : ''}`);
        }
        
        function clearAllDays() {
            if (confirm(currentLang === 'ar' ? 'هل تريد مسح جميع بيانات الدوام؟' : 'Clear all attendance data?')) {
                attendanceData = {};
                renderAttendanceCalendar();
                updateAttendanceSummary();
            }
        }
        
        function autoCalculateAttendance() {
            // حساب تلقائي ذكي بناءً على أيام العمل المحددة
            const monthIndex = months.indexOf(currentMonth);
            const daysInMonth = new Date(currentYear, monthIndex + 1, 0).getDate();
            const workDaysOfWeek = currentAttendanceEmployee.workDaysOfWeek || [true, true, true, true, true, false, true];
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayOfWeek = new Date(currentYear, monthIndex, day).getDay();
                
                // التحقق من قائمة أيام العمل
                if (workDaysOfWeek[dayOfWeek]) {
                    // يوم عمل
                    attendanceData[day] = { type: 'full' };
                } else {
                    // عطلة مدفوعة الأجر (للموظف الشهري فقط)
                    if (currentAttendanceEmployee.employeeType === 'monthly' || currentAttendanceEmployee.employeeType === 'vehicle') {
                        attendanceData[day] = { type: 'paid-leave' };
                    } else {
                        attendanceData[day] = { type: 'not-set' };
                    }
                }
            }
            
            renderAttendanceCalendar();
            updateAttendanceSummary();
            showNotification('success', 'تم', 'تم حساب الدوام تلقائياً بناءً على أيام العمل المحددة');
        }
        
        async function saveAttendanceData() {
            if (!currentAttendanceEmployee || !currentAttendanceEmployee.firebaseId) {
                showNotification('error', 'خطأ', 'لم يتم العثور على معرف الموظف');
                return;
            }
            
            try {
                showLoading();
                
                // حساب أيام العمل من الدوام
                const workDaysCalculated = calculateWorkDaysFromAttendance({attendance: attendanceData});
                
                // حفظ بيانات الدوام + workDays احتياطياً في Firebase
                await updateDoc(doc(db, 'employees', currentAttendanceEmployee.firebaseId), {
                    attendance: attendanceData,
                    workDays: workDaysCalculated, // حفظ احتياطي للتوافق
                    attendanceUpdatedAt: new Date().toISOString()
                });
                
                // تحديث البيانات المحلية
                currentAttendanceEmployee.attendance = attendanceData;
                currentAttendanceEmployee.workDays = workDaysCalculated;
                
                hideLoading();
                closeModal('attendanceModal');
                showNotification('success', 'تم الحفظ', `تم حفظ بيانات الدوام بنجاح! (${workDaysCalculated.toFixed(1)} يوم) ✅`);
                
                renderContent(); // تحديث العرض
                
            } catch (error) {
                console.error('❌ Error saving attendance:', error);
                hideLoading();
                showNotification('error', 'خطأ', 'فشل حفظ بيانات الدوام');
            }
        }

        function openCopyAllModal() {
            // التحقق من قفل الشهر
            if (!canEditCurrentMonth()) {
                showNotification('warning', t('warning'), t('monthLocked'));
                return;
            }
            
            // ملء قائمة السنوات
            const yearSelect = document.getElementById('copyAllTargetYear');
            yearSelect.innerHTML = '';
            const availableYears = Object.keys(employeeData).sort((a, b) => b - a);
            availableYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year == currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            });
            
            // ملء قائمة الأشهر
            const monthSelect = document.getElementById('targetMonth');
            monthSelect.innerHTML = '';
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = t('monthNames')[month];
                // تحديد الشهر الحالي كقيمة افتراضية
                if (month === currentMonth) {
                    option.textContent += ' (الحالي)';
                    option.disabled = true;
                    option.style.color = '#999';
                }
                monthSelect.appendChild(option);
            });
            
            // اختيار أول شهر غير الحالي
            const firstNonCurrentMonth = months.find(m => m !== currentMonth);
            if (firstNonCurrentMonth) {
                monthSelect.value = firstNonCurrentMonth;
            }
            
            populateProjectSelects();
            openModal('copyAllModal');
        }

        async function confirmCopyAll() {
            const targetMonth = document.getElementById('targetMonth').value;
            const targetYear = document.getElementById('copyAllTargetYear').value;
            
            if (!targetMonth) {
                showNotification('warning', '⚠️ تنبيه', 'الرجاء اختيار الشهر المستهدف');
                return;
            }
            
            if (!targetYear) {
                showNotification('warning', '⚠️ تنبيه', 'الرجاء اختيار السنة المستهدفة');
                return;
            }
            
            // منع النسخ إلى نفس الشهر والسنة
            if (targetMonth === currentMonth && targetYear == currentYear) {
                showNotification('warning', '⚠️ تنبيه', 'لا يمكن النسخ إلى نفس الشهر والسنة');
                return;
            }
            
            const employees = employeeData[currentYear][currentMonth] || [];
            if (employees.length === 0) {
                showNotification('warning', '⚠️ تنبيه', 'لا يوجد موظفين لنسخهم في الشهر الحالي');
                return;
            }
            
            showLoading();
            let copiedCount = 0;
            let skippedCount = 0;
            
            // تأكد من وجود بيانات للسنة المستهدفة
            if (!employeeData[targetYear]) {
                employeeData[targetYear] = {};
            }
            
            if (!employeeData[targetYear][targetMonth]) {
                employeeData[targetYear][targetMonth] = [];
            }
            
            const targetMonthData = employeeData[targetYear][targetMonth];
            for (const emp of employees) {
                const exists = targetMonthData.some(e => e.nameAr === emp.nameAr && e.project === emp.project);
                if (!exists) {
                    const copiedEmployee = {
                        ...emp,
                        workDays: 30,
                        bonus: 0,
                        phoneBills: 0,
                        deductions: 0,
                        advance: 0,
                        ceoBonus: 0,
                        attendance: {}, // إعادة تعيين الدوام
                        isPaid: false // إعادة تعيين حالة الدفع
                    };
                    // حذف الحقول التي لا يجب أن تكون موجودة في النسخة الجديدة
                    delete copiedEmployee.firebaseId;
                    delete copiedEmployee.paidDate; // حذف تاريخ الدفع (بدلاً من undefined)
                    delete copiedEmployee.paymentMethod; // حذف طريقة الدفع
                    await saveEmployeeToFirebase(copiedEmployee, targetMonth, targetYear);
                    copiedCount++;
                } else {
                    skippedCount++;
                }
            }
            
            hideLoading();
            closeModal('copyAllModal');
            
            // رسالة تفصيلية
            let message = `✅ تم نسخ ${copiedCount} موظف\n`;
            message += `📋 إلى ${t('monthNames')[targetMonth]}`;
            if (targetYear != currentYear) {
                message += ` ${targetYear}`;
            }
            if (skippedCount > 0) {
                message += `\n⚠️ تم تخطي ${skippedCount} موظف (موجودين مسبقاً)`;
            }
            
            showNotification('success', '✓ تم النسخ', message);
            
            console.log(`✅ نسخ جماعي: ${copiedCount} موظف من ${t('monthNames')[currentMonth]} ${currentYear} إلى ${t('monthNames')[targetMonth]} ${targetYear}`);
            
            // إعادة تحميل البيانات إذا كانت السنة المستهدفة هي السنة الحالية
            if (targetYear == currentYear) {
                await loadEmployeesFromFirebase();
                renderContent();
            }
        }

        function openCopySelectedModal() {
            try {
                // التحقق من وجود موظفين محددين
                // ملاحظة: السماح بالنسخ حتى لو كان الشهر مقفل أو الموظف مدفوع، لأن النسخ لا يعدل البيانات الأصلية
                if (selectedEmployees.size === 0) {
                    showNotification('warning', '⚠️ تنبيه', 'الرجاء تحديد موظفين أولاً');
                    return;
                }
                
                console.log('📋 فتح نافذة نسخ الموظفين المحددين:', selectedEmployees.size, 'موظف');
                
                // ملء قائمة السنوات
                const yearSelect = document.getElementById('copySelectedTargetYear');
                if (!yearSelect) {
                    console.error('❌ لم يتم العثور على copySelectedTargetYear');
                    showNotification('error', 'خطأ', 'خطأ في تحميل النافذة');
                    return;
                }
                yearSelect.innerHTML = '';
                const availableYears = Object.keys(employeeData).sort((a, b) => b - a);
                if (availableYears.length === 0) {
                    showNotification('warning', '⚠️ تنبيه', 'لا توجد سنوات متاحة');
                    return;
                }
                availableYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year == currentYear) {
                        option.selected = true;
                    }
                    yearSelect.appendChild(option);
                });
                
                // ملء قائمة الأشهر
                const monthSelect = document.getElementById('copySelectedTargetMonth');
                if (!monthSelect) {
                    console.error('❌ لم يتم العثور على copySelectedTargetMonth');
                    showNotification('error', 'خطأ', 'خطأ في تحميل النافذة');
                    return;
                }
                monthSelect.innerHTML = '';
                months.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = t('monthNames')[month];
                    // تحديد الشهر الحالي كقيمة افتراضية
                    if (month === currentMonth) {
                        option.textContent += ' (الحالي)';
                        option.disabled = true;
                        option.style.color = '#999';
                    }
                    monthSelect.appendChild(option);
                });
                
                // اختيار أول شهر غير الحالي
                const firstNonCurrentMonth = months.find(m => m !== currentMonth);
                if (firstNonCurrentMonth) {
                    monthSelect.value = firstNonCurrentMonth;
                }
                
                // ملء قوائم المشاريع إذا كانت الدالة موجودة
                if (typeof populateProjectSelects === 'function') {
                    populateProjectSelects();
                }
                
                openModal('copySelectedModal');
                console.log('✅ تم فتح نافذة نسخ الموظفين المحددين بنجاح');
            } catch (error) {
                console.error('❌ خطأ في openCopySelectedModal:', error);
                showNotification('error', 'خطأ', 'حدث خطأ أثناء فتح النافذة: ' + error.message);
            }
        }

        async function confirmCopySelected() {
            try {
                console.log('🔍 confirmCopySelected - بدء العملية');
                console.log('🔍 selectedEmployees:', selectedEmployees);
                console.log('🔍 selectedEmployees.size:', selectedEmployees ? selectedEmployees.size : 0);
                
                const targetMonth = document.getElementById('copySelectedTargetMonth')?.value;
                const targetYear = document.getElementById('copySelectedTargetYear')?.value;
                
                console.log('🔍 targetMonth:', targetMonth, 'targetYear:', targetYear);
                
                if (!targetMonth) {
                    showNotification('warning', '⚠️ تنبيه', 'الرجاء اختيار الشهر المستهدف');
                    return;
                }
                
                if (!targetYear) {
                    showNotification('warning', '⚠️ تنبيه', 'الرجاء اختيار السنة المستهدفة');
                    return;
                }
                
                // منع النسخ إلى نفس الشهر والسنة
                if (targetMonth === currentMonth && targetYear == currentYear) {
                    showNotification('warning', '⚠️ تنبيه', 'لا يمكن النسخ إلى نفس الشهر والسنة');
                    return;
                }
                
                // التحقق من وجود موظفين محددين
                if (!selectedEmployees || selectedEmployees.size === 0) {
                    console.error('❌ لا يوجد موظفين محددين - selectedEmployees:', selectedEmployees);
                    showNotification('warning', '⚠️ تنبيه', 'لا يوجد موظفين محددين. الرجاء تحديد موظفين أولاً.');
                    return;
                }
                
                const employees = employeeData[currentYear]?.[currentMonth] || [];
                if (employees.length === 0) {
                    showNotification('warning', '⚠️ تنبيه', 'لا يوجد موظفين في الشهر الحالي');
                    return;
                }
                
                console.log(`📋 بدء نسخ ${selectedEmployees.size} موظف إلى ${t('monthNames')[targetMonth]} ${targetYear}`);
                console.log('🔍 الموظفون المحددون:', Array.from(selectedEmployees));
                console.log('🔍 عدد الموظفين في الشهر الحالي:', employees.length);
                console.log('🔍 currentYear:', currentYear, 'currentMonth:', currentMonth);
                
                showLoading();
                let copiedCount = 0;
                let skippedCount = 0;
                
                // تأكد من وجود بيانات للسنة المستهدفة
                if (!employeeData[targetYear]) {
                    employeeData[targetYear] = {};
                }
                
                if (!employeeData[targetYear][targetMonth]) {
                    employeeData[targetYear][targetMonth] = [];
                }
                
                const targetMonthData = employeeData[targetYear][targetMonth];
                const sortedIndices = Array.from(selectedEmployees).sort((a, b) => a - b);
                
                for (const index of sortedIndices) {
                    if (index >= 0 && index < employees.length) {
                        const emp = employees[index];
                        const exists = targetMonthData.some(e => e.nameAr === emp.nameAr && e.project === emp.project);
                        if (!exists) {
                            const copiedEmployee = {
                                ...emp,
                                workDays: 30,
                                bonus: 0,
                                phoneBills: 0,
                                deductions: 0,
                                advance: 0,
                                ceoBonus: 0,
                                attendance: {}, // إعادة تعيين الدوام
                                isPaid: false // إعادة تعيين حالة الدفع
                            };
                            // حذف الحقول التي لا يجب أن تكون موجودة في النسخة الجديدة
                            delete copiedEmployee.firebaseId;
                            delete copiedEmployee.paidDate; // حذف تاريخ الدفع (بدلاً من undefined)
                            delete copiedEmployee.paymentMethod; // حذف طريقة الدفع
                            await saveEmployeeToFirebase(copiedEmployee, targetMonth, targetYear);
                            copiedCount++;
                            console.log(`✅ تم نسخ ${emp.nameAr || emp.name} إلى ${t('monthNames')[targetMonth]} ${targetYear}`);
                        } else {
                            skippedCount++;
                            console.log(`⚠️ تم تخطي ${emp.nameAr || emp.name} (موجود مسبقاً)`);
                        }
                    }
                }
                
                hideLoading();
                closeModal('copySelectedModal');
                
                // رسالة تفصيلية
                let message = `✅ تم نسخ ${copiedCount} موظف\n`;
                message += `📋 إلى ${t('monthNames')[targetMonth]}`;
                if (targetYear != currentYear) {
                    message += ` ${targetYear}`;
                }
                if (skippedCount > 0) {
                    message += `\n⚠️ تم تخطي ${skippedCount} موظف (موجودين مسبقاً)`;
                }
                
                showNotification('success', '✓ تم النسخ', message);
                
                console.log(`✅ نسخ المحدد: ${copiedCount} موظف من ${t('monthNames')[currentMonth]} ${currentYear} إلى ${t('monthNames')[targetMonth]} ${targetYear}`);
                
                // إعادة تحميل البيانات إذا كانت السنة المستهدفة هي السنة الحالية
                if (targetYear == currentYear) {
                    await loadEmployeesFromFirebase();
                    renderContent();
                }
            } catch (error) {
                console.error('❌ خطأ في confirmCopySelected:', error);
                hideLoading();
                showNotification('error', 'خطأ', 'حدث خطأ أثناء النسخ: ' + error.message);
            }
        }

        // ========== نظام إظهار/إخفاء الأعمدة ==========
        let hiddenColumns = new Set(JSON.parse(localStorage.getItem('hiddenColumns') || '[]'));
        
        function toggleColumnVisibilityPanel() {
            const panel = document.getElementById('columnVisibilityPanel');
            if (panel) {
                const isVisible = panel.style.display !== 'none';
                panel.style.display = isVisible ? 'none' : 'block';
                
                if (!isVisible) {
                    // ملء قائمة الأعمدة
                    populateColumnToggles();
                }
            }
        }
        
        function populateColumnToggles() {
            const container = document.getElementById('columnToggles');
            if (!container) return;
            
            const table = document.querySelector('#employeeTable');
            if (!table) return;
            
            const headers = table.querySelectorAll('thead th[data-column]');
            container.innerHTML = '';
            
            const columnNames = {
                'name': '👤 الاسم',
                'position': '💼 المنصب',
                'employeeType': '📋 النوع',
                'project': '🏗️ المشروع',
                'salary': '💵 الراتب',
                'salaryCurrency': '💱 عملة الراتب',
                'paymentCurrency': '💳 عملة الدفع',
                'exchangeRate': '🔄 سعر الصرف',
                'attendance': '⏰ الدوام',
                'dailySalary': '📅 الراتب اليومي',
                'actualUSD': '💵 الفعلي USD',
                'actualIQD': '💰 الفعلي IQD',
                'bonus': '🎁 البونص',
                'bonusCurrency': '💱 عملة البونص',
                'phoneBills': '📞 الفواتير',
                'phoneBillsCurrency': '💱 عملة الفواتير',
                'deductions': '➖ الخصومات',
                'deductionsCurrency': '💱 عملة الخصومات',
                'advance': '💳 السلفة',
                'advanceCurrency': '💱 عملة السلفة',
                'netSalary': '✅ الصافي',
                'actions': '⚙️ الإجراءات'
            };
            
            headers.forEach(header => {
                const colName = header.dataset.column;
                if (!colName || colName === 'select' || colName === 'reorder' || colName === 'number' || colName === 'code') return;
                
                const isHidden = hiddenColumns.has(colName);
                const displayName = columnNames[colName] || colName;
                
                const toggle = document.createElement('label');
                toggle.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 10px; background: white; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: 2px solid #e5e7eb;';
                toggle.onmouseenter = function() { this.style.background = '#f0f9ff'; this.style.borderColor = '#0ea5e9'; };
                toggle.onmouseleave = function() { this.style.background = 'white'; this.style.borderColor = '#e5e7eb'; };
                
                toggle.innerHTML = `
                    <input type="checkbox" ${!isHidden ? 'checked' : ''} 
                        onchange="toggleColumnVisibility('${colName}', this.checked)" 
                        style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-size: 13px; font-weight: 500;">${displayName}</span>
                `;
                
                container.appendChild(toggle);
            });
        }
        
        function toggleColumnVisibility(columnName, show) {
            if (show) {
                hiddenColumns.delete(columnName);
            } else {
                hiddenColumns.add(columnName);
            }
            
            // حفظ في localStorage
            localStorage.setItem('hiddenColumns', JSON.stringify([...hiddenColumns]));
            
            // تطبيق التغيير
            applyColumnVisibility();
        }
        
        function applyColumnVisibility() {
            const table = document.querySelector('#employeeTable');
            if (!table) return;
            
            const headers = table.querySelectorAll('thead th[data-column]');
            headers.forEach((header, index) => {
                const colName = header.dataset.column;
                const isHidden = hiddenColumns.has(colName);
                
                // إخفاء/إظهار الرأس
                header.style.display = isHidden ? 'none' : '';
                
                // إخفاء/إظهار جميع خلايا العمود
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cell = row.cells[index];
                    if (cell) {
                        cell.style.display = isHidden ? 'none' : '';
                    }
                });
            });
            
            console.log('✅ تم تطبيق إعدادات الأعمدة:', hiddenColumns.size, 'أعمدة مخفية');
        }
        
        function showAllColumns() {
            const checkboxes = document.querySelectorAll('#columnToggles input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = true;
                const colName = cb.onchange.toString().match(/'([^']+)'/)[1];
                hiddenColumns.delete(colName);
            });
            
            localStorage.setItem('hiddenColumns', JSON.stringify([]));
            applyColumnVisibility();
            showNotification('success', 'تم', 'تم إظهار جميع الأعمدة');
        }
        
        function hideAllColumns() {
            const checkboxes = document.querySelectorAll('#columnToggles input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
                const match = cb.onchange.toString().match(/'([^']+)'/);
                if (match) {
                    hiddenColumns.add(match[1]);
                }
            });
            
            localStorage.setItem('hiddenColumns', JSON.stringify([...hiddenColumns]));
            applyColumnVisibility();
            showNotification('warning', 'تم', 'تم إخفاء جميع الأعمدة');
        }
        
        function resetColumnVisibility() {
            hiddenColumns = new Set();
            localStorage.removeItem('hiddenColumns');
            
            const checkboxes = document.querySelectorAll('#columnToggles input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            
            applyColumnVisibility();
            showNotification('success', 'تم', 'تم إعادة تعيين الأعمدة للوضع الافتراضي');
        }
        
        // ========== نظام الإضافة المتعددة المحسّن ==========

        function openMultipleEmployeesModal() {
            // التحقق من قفل الشهر
            if (!canEditCurrentMonth()) {
                showNotification('warning', t('warning'), t('monthLocked'));
                return;
            }
            
            // إنشاء 5 صفوف افتراضية
            const tbody = document.getElementById('multipleEmployeesTableBody');
            tbody.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                addMultiEmpRow();
            }
            updateMultiEmpRowCount();
            openModal('multipleEmployeesModal');
        }
        
        function addMultiEmpRow() {
            const tbody = document.getElementById('multipleEmployeesTableBody');
            const rowIndex = tbody.children.length + 1;
            
            const tr = document.createElement('tr');
            tr.style.cssText = 'border-bottom: 1px solid #e5e7eb; transition: all 0.2s;';
            tr.onmouseenter = function() { this.style.background = '#f9fafb'; };
            tr.onmouseleave = function() { this.style.background = ''; };
            
            // بناء خيارات المشاريع
            let projectOptions = '';
                Object.entries(projects).forEach(([code, name]) => {
                projectOptions += `<option value="${code}">${code} - ${name}</option>`;
            });
            
            tr.innerHTML = `
                <td style="text-align: center; font-weight: 600; color: var(--gray);">${rowIndex}</td>
                <td><input type="text" class="multi-emp-cell" data-field="nameAr" data-col="1" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px;"></td>
                <td><input type="text" class="multi-emp-cell" data-field="nameEn" data-col="2" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px;"></td>
                <td><input type="text" class="multi-emp-cell" data-field="position" data-col="3" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px;"></td>
                <td>
                    <select class="multi-emp-cell" data-field="employeeType" data-col="4" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px;">
                        <option value="monthly">شهري</option>
                        <option value="daily">يومي</option>
                        <option value="vehicle">سيارة</option>
                    </select>
                </td>
                <td>
                    <select class="multi-emp-cell" data-field="project" data-col="5" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px;">
                        ${projectOptions}
                    </select>
                </td>
                <td><input type="number" class="multi-emp-cell" data-field="salary" data-col="6" min="0" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px;"></td>
                <td>
                    <select class="multi-emp-cell" data-field="salaryCurrency" data-col="7" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px;">
                        <option value="USD">USD</option>
                        <option value="IQD">IQD</option>
                    </select>
                </td>
                <td>
                    <select class="multi-emp-cell" data-field="paymentCurrency" data-col="8" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px;">
                        <option value="USD">USD</option>
                        <option value="IQD" selected>IQD</option>
                    </select>
                </td>
                <td><input type="number" class="multi-emp-cell" data-field="exchangeRate" data-col="9" value="1420" min="0" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px;"></td>
                <td>
                    <select class="multi-emp-cell" data-field="attendanceSystem" data-col="10" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px;">
                        <option value="hours" selected>بالساعات</option>
                        <option value="fixed">ثابت</option>
                    </select>
                </td>
                <td><input type="number" class="multi-emp-cell" data-field="dailyWorkHours" data-col="11" value="8" min="1" max="24" step="0.5" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px;"></td>
                <td>
                    <select class="multi-emp-cell" data-field="overtimeMultiplier" data-col="12" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px;">
                        <option value="1">1×</option>
                        <option value="1.5" selected>1.5×</option>
                        <option value="2">2×</option>
                    </select>
                </td>
                <td>
                    <select class="multi-emp-cell" data-field="monthCalculationMethod" data-col="13" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px;">
                        <option value="30" selected>30 يوم</option>
                        <option value="actual">أيام فعلية</option>
                    </select>
                </td>
                <td>
                    <select class="multi-emp-cell" data-field="paidLeaveCalculation" data-col="14" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px;">
                        <option value="full" selected>كامل</option>
                        <option value="half">نصف</option>
                        <option value="none">بدون</option>
                    </select>
                </td>
                <td style="text-align: center;">
                    <button type="button" onclick="openWorkDaysModal(this)" class="work-days-btn" data-row-index="${rowIndex - 1}" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; width: 100%;">📅 تحديد</button>
                    <div class="work-days-summary" data-row-index="${rowIndex - 1}" style="font-size: 10px; color: #059669; margin-top: 4px; display: none;">6 أيام</div>
                </td>
                <td style="text-align: center;">
                    <button type="button" onclick="removeMultiEmpRow(this)" style="background: #ef4444; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 11px;">🗑️</button>
                </td>
            `;
            
            tbody.appendChild(tr);
            
            // إضافة مستمع اللصق لكل خلية
            tr.querySelectorAll('.multi-emp-cell').forEach(cell => {
                cell.addEventListener('paste', handleSmartPaste);
                cell.addEventListener('focus', function() {
                    this.style.borderColor = '#667eea';
                    this.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.1)';
                });
                cell.addEventListener('blur', function() {
                    this.style.borderColor = '#d1d5db';
                    this.style.boxShadow = 'none';
                });
            });
            
            updateMultiEmpRowCount();
            renumberMultiEmpRows();
        }
        
        function removeMultiEmpRow(btn) {
            const row = btn.closest('tr');
            const tbody = document.getElementById('multipleEmployeesTableBody');
            const removedIndex = Array.from(tbody.children).indexOf(row);
            
            // حذف الصف
            row.remove();
            
            // إعادة ترتيب workDaysData بعد الحذف
            const newWorkDaysData = {};
            Array.from(tbody.children).forEach((tr, newIndex) => {
                const oldIndex = newIndex < removedIndex ? newIndex : newIndex + 1;
                if (workDaysData[oldIndex] !== undefined) {
                    newWorkDaysData[newIndex] = workDaysData[oldIndex];
                }
            });
            workDaysData = newWorkDaysData;
            
            updateMultiEmpRowCount();
            renumberMultiEmpRows();
        }
        
        function renumberMultiEmpRows() {
            const tbody = document.getElementById('multipleEmployeesTableBody');
            Array.from(tbody.children).forEach((tr, index) => {
                tr.children[0].textContent = index + 1;
                
                // تحديث data-row-index في زر أيام العمل والملخص
                const workDaysBtn = tr.querySelector('.work-days-btn');
                const workDaysSummary = tr.querySelector('.work-days-summary');
                if (workDaysBtn) {
                    workDaysBtn.dataset.rowIndex = index;
                }
                if (workDaysSummary) {
                    workDaysSummary.dataset.rowIndex = index;
                }
            });
        }
        
        function updateMultiEmpRowCount() {
            const tbody = document.getElementById('multipleEmployeesTableBody');
            const count = tbody.children.length;
            const countSpan = document.getElementById('multiEmpRowCount');
            if (countSpan) {
                countSpan.textContent = `📊 عدد الصفوف: ${count}`;
            }
        }
        
        function clearAllMultiEmpRows() {
            if (confirm('هل تريد مسح جميع البيانات؟')) {
                const tbody = document.getElementById('multipleEmployeesTableBody');
                tbody.innerHTML = '';
                for (let i = 0; i < 5; i++) {
                    addMultiEmpRow();
                }
            }
        }
        
        // ========== نظام اللصق الذكي من Excel ==========

        // تحويل نص أيام العمل (من Excel) إلى مصفوفة من 7 قيم منطقية [أحد..سبت]
        function parseWorkDaysFromString(input) {
            if (!input) {
                // الافتراضي: أحد-خميس + سبت (الجمعة عطلة)
                return [true, true, true, true, true, false, true];
            }

            const text = input.toString().trim().toLowerCase();
            if (!text) {
                return [true, true, true, true, true, false, true];
            }

            // مصفوفة النتيجة
            const days = [false, false, false, false, false, false, false];

            // تقسيم حسب الفواصل أو الفراغات أو الشرطات
            const parts = text
                .replace(/\s+/g, ' ')
                .split(/[,،\-–؛]| /)
                .map(p => p.trim())
                .filter(p => p.length > 0);

            const mapTokenToIndex = (token) => {
                // أرقام 0-6
                if (/^[0-6]$/.test(token)) return parseInt(token, 10);

                // إنجليزي
                if (token.startsWith('sun')) return 0;
                if (token.startsWith('mon')) return 1;
                if (token.startsWith('tue')) return 2;
                if (token.startsWith('wed')) return 3;
                if (token.startsWith('thu')) return 4;
                if (token.startsWith('fri')) return 5;
                if (token.startsWith('sat')) return 6;

                // عربي (أشكال مختلفة)
                if (token.includes('احد') || token.includes('أحد')) return 0;
                if (token.includes('اثنين')) return 1;
                if (token.includes('ثلاثاء')) return 2;
                if (token.includes('اربعاء') || token.includes('أربعاء')) return 3;
                if (token.includes('خميس')) return 4;
                if (token.includes('جمعه') || token.includes('جمعة')) return 5;
                if (token.includes('سبت')) return 6;

                return null;
            };

            parts.forEach(token => {
                const idx = mapTokenToIndex(token);
                if (idx !== null && idx >= 0 && idx <= 6) {
                    days[idx] = true;
                }
            });

            // إذا لم يتم التعرف على أي يوم، نرجع الافتراضي
            if (!days.some(Boolean)) {
                return [true, true, true, true, true, false, true];
            }

            return days;
        }

        // تحديث زر وملخص أيام العمل لصف معيّن
        function applyWorkDaysToRow(rowIndex, workDaysArray) {
            if (typeof rowIndex !== 'number' || rowIndex < 0) return;

            workDaysData[rowIndex] = workDaysArray;

            const dayNames = ['أحد', 'اثنين', 'ثلاثاء', 'أربعاء', 'خميس', 'جمعة', 'سبت'];
            const count = workDaysArray.filter(Boolean).length;
            const selectedDayNames = workDaysArray
                .map((selected, index) => selected ? dayNames[index] : null)
                .filter(Boolean);

            const summaryDiv = document.querySelector(`.work-days-summary[data-row-index="${rowIndex}"]`);
            if (summaryDiv) {
                summaryDiv.textContent = `${count} أيام (${selectedDayNames.join(', ')})`;
                summaryDiv.style.display = 'block';
            }

            const btn = document.querySelector(`.work-days-btn[data-row-index="${rowIndex}"]`);
            if (btn) {
                btn.style.background = count > 0 ? '#10b981' : '#3b82f6';
                btn.textContent = count > 0 ? '✓ محدّد' : '📅 تحديد';
            }
        }

        function handleSmartPaste(e) {
            e.preventDefault();
            
            const pastedData = (e.clipboardData || window.clipboardData).getData('text');
            if (!pastedData) return;
            
            const targetCell = e.target;
            const currentRow = targetCell.closest('tr');
            const currentCol = parseInt(targetCell.dataset.col) || 0;
            const tbody = document.getElementById('multipleEmployeesTableBody');
            
            // تقسيم البيانات إلى صفوف وأعمدة
            const rows = pastedData.split('\n').map(row => row.split('\t'));
            
            // إزالة الصفوف الفارغة
            const cleanRows = rows.filter(row => row.some(cell => cell.trim() !== ''));
            
            if (cleanRows.length === 0) return;
            
            const currentRowIndex = Array.from(tbody.children).indexOf(currentRow);
            
            // التأكد من وجود صفوف كافية
            const neededRows = currentRowIndex + cleanRows.length;
            const existingRows = tbody.children.length;
            
            if (neededRows > existingRows) {
                const rowsToAdd = neededRows - existingRows;
                for (let i = 0; i < rowsToAdd; i++) {
                    addMultiEmpRow();
                }
            }
            
            // لصق البيانات
            cleanRows.forEach((rowData, rowOffset) => {
                const targetRow = tbody.children[currentRowIndex + rowOffset];
                if (!targetRow) return;
                
                const cells = targetRow.querySelectorAll('.multi-emp-cell');
                
                const rowIndexInTbody = Array.from(tbody.children).indexOf(targetRow);

                rowData.forEach((cellValue, colOffset) => {
                    const targetCellIndex = currentCol + colOffset - 1; // -1 لأن العمود الأول هو الرقم
                    const cleanValue = cellValue.trim();

                    // أعمدة داخل نموذج الإضافة المتعددة (الحقول العادية)
                    if (targetCellIndex >= 0 && targetCellIndex < cells.length) {
                        const cell = cells[targetCellIndex];
                        
                        if (cell.tagName === 'SELECT') {
                            // معالجة القوائم المنسدلة
                            const field = cell.dataset.field;
                            
                            if (field === 'employeeType') {
                                // تحويل النص إلى القيمة المناسبة
                                if (cleanValue.includes('شهري') || cleanValue.toLowerCase().includes('monthly')) {
                                    cell.value = 'monthly';
                                } else if (cleanValue.includes('يومي') || cleanValue.toLowerCase().includes('daily')) {
                                    cell.value = 'daily';
                                } else if (cleanValue.includes('سيارة') || cleanValue.toLowerCase().includes('vehicle')) {
                                    cell.value = 'vehicle';
                                }
                            } else if (field === 'salaryCurrency' || field === 'paymentCurrency') {
                                if (cleanValue.toUpperCase() === 'USD' || cleanValue.includes('دولار')) {
                                    cell.value = 'USD';
                                } else if (cleanValue.toUpperCase() === 'IQD' || cleanValue.includes('دينار')) {
                                    cell.value = 'IQD';
                                }
                            } else if (field === 'attendanceSystem') {
                                if (cleanValue.includes('ساعات') || cleanValue.toLowerCase().includes('hours')) {
                                    cell.value = 'hours';
                                } else if (cleanValue.includes('ثابت') || cleanValue.toLowerCase().includes('fixed')) {
                                    cell.value = 'fixed';
                                }
                            } else if (field === 'monthCalculationMethod') {
                                if (cleanValue.includes('30') || cleanValue.includes('ثلاثين')) {
                                    cell.value = '30';
                                } else if (cleanValue.includes('فعلي') || cleanValue.toLowerCase().includes('actual')) {
                                    cell.value = 'actual';
                                }
                            } else if (field === 'paidLeaveCalculation') {
                                if (cleanValue.includes('كامل') || cleanValue.toLowerCase().includes('full')) {
                                    cell.value = 'full';
                                } else if (cleanValue.includes('نصف') || cleanValue.toLowerCase().includes('half')) {
                                    cell.value = 'half';
                                } else if (cleanValue.includes('بدون') || cleanValue.toLowerCase().includes('none')) {
                                    cell.value = 'none';
                                }
                            } else if (field === 'overtimeMultiplier') {
                                if (cleanValue.includes('1.5') || cleanValue.includes('1.5')) {
                                    cell.value = '1.5';
                                } else if (cleanValue.includes('2') || cleanValue.includes('مضاعف')) {
                                    cell.value = '2';
                                } else {
                                    cell.value = '1';
                                }
                            } else if (field === 'project') {
                                // البحث عن المشروع المطابق
                                const options = Array.from(cell.options);
                                const match = options.find(opt => 
                                    opt.value === cleanValue || 
                                    opt.textContent.includes(cleanValue)
                                );
                                if (match) cell.value = match.value;
                            }
                        } else {
                            cell.value = cleanValue;
                        }
                        
                        // تأثير بصري للصق
                        cell.style.background = '#d1fae5';
                        setTimeout(() => {
                            cell.style.background = '';
                        }, 500);
                    }
                    // عمود خاص بأيام العمل الأسبوعية (خارج .multi-emp-cell، بعد آخر حقل)
                    else if (targetCellIndex === cells.length) {
                        const workDaysArray = parseWorkDaysFromString(cleanValue);
                        applyWorkDaysToRow(rowIndexInTbody, workDaysArray);
                    }
                });
            });
            
            updateMultiEmpRowCount();
            showNotification('success', 'تم اللصق', `تم لصق ${cleanRows.length} صف بنجاح! ✅`);
        }
        
        function fillSampleData() {
            const tbody = document.getElementById('multipleEmployeesTableBody');
            tbody.innerHTML = '';
            
            const sampleData = [
                { nameAr: 'أحمد محمد', nameEn: 'Ahmed Mohammed', position: 'مهندس', type: 'monthly', salary: 1500 },
                { nameAr: 'فاطمة علي', nameEn: 'Fatima Ali', position: 'محاسب', type: 'monthly', salary: 1200 },
                { nameAr: 'خالد حسن', nameEn: 'Khalid Hassan', position: 'فني', type: 'daily', salary: 50 },
            ];
            
            sampleData.forEach(data => {
                addMultiEmpRow();
                const lastRow = tbody.lastElementChild;
                const cells = lastRow.querySelectorAll('.multi-emp-cell');
                
                cells[0].value = data.nameAr;
                cells[1].value = data.nameEn;
                cells[2].value = data.position;
                cells[3].value = data.type;
                cells[5].value = data.salary;
            });
            
            showNotification('success', 'تم', 'تم إضافة بيانات تجريبية');
        }
        
        function validateMultiEmpData() {
            const tbody = document.getElementById('multipleEmployeesTableBody');
            const rows = Array.from(tbody.children);
            
            let validCount = 0;
            let errors = [];
            
            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('.multi-emp-cell');
                const nameAr = cells[0].value.trim();
                const position = cells[2].value.trim();
                const salary = cells[5].value.trim();
                
                if (nameAr && position && salary) {
                    validCount++;
                } else if (nameAr || position || salary) {
                    errors.push(`الصف ${index + 1}: بيانات ناقصة`);
                }
            });
            
            const summary = document.getElementById('multiEmpSummary');
            const content = document.getElementById('multiEmpSummaryContent');
            
            if (validCount > 0) {
                summary.style.display = 'block';
                content.innerHTML = `
                    <strong>✅ عدد الموظفين الصحيحة: ${validCount}</strong><br>
                    ${errors.length > 0 ? `<div style="margin-top: 10px; color: #dc2626;">⚠️ تحذيرات:<br>${errors.join('<br>')}</div>` : ''}
                `;
            } else {
                summary.style.display = 'none';
                showNotification('error', 'لا توجد بيانات', 'الرجاء إدخال بيانات صحيحة');
            }
        }

        function openEditProjectModal(code) {
            // التحقق من قفل الشهر
            if (!canEditCurrentMonth()) {
                showNotification('warning', t('warning'), t('monthLocked'));
                return;
            }
            
            projectCodeToEdit = code;
            document.getElementById('editProjectCode').value = code;
            document.getElementById('editProjectName').value = projects[code];
            closeAllDropdowns();
            openModal('editProjectModal');
        }

        function openSummaryModal() {
            openModal('summaryModal');
            populateProjectSelects();
            document.getElementById('summaryResults').innerHTML = '';
            // إخفاء زر الطباعة عند فتح النافذة
            const printBtn = document.getElementById('printSummaryBtn');
            if (printBtn) {
                printBtn.style.display = 'none';
            }
        }

        function verifyPassword() {
            const passwordInput = document.getElementById('bonusPasswordInput');
            if (!passwordInput) {
                console.error('❌ لم يتم العثور على bonusPasswordInput');
                return;
            }
            const password = passwordInput.value;
            // كلمة المرور للحقول المكافئات والزيادات في المشاريع
            if (password === '2020') {
                // تبديل حالة القفل
                isUnlocked = !isUnlocked;
                console.log('🔓 حالة القفل:', isUnlocked ? 'مفتوح' : 'مقفل');
                console.log('🔓 isUnlocked =', isUnlocked);
                
                // إغلاق النافذة ومسح كلمة المرور
                closeModal('bonusPasswordModal');
                passwordInput.value = '';
                
                // إعادة رسم الصفحة لتطبيق التغييرات على الحقول
                console.log('🔄 إعادة رسم الصفحة...');
                renderContent();
                
                // رسالة تأكيد
                const message = isUnlocked 
                    ? (currentLang === 'ar' ? '✅ تم فتح القفل - يمكنك الآن تعديل حقول الزيادات والمكافآت' : '✅ Unlocked - You can now edit increments and bonuses')
                    : (currentLang === 'ar' ? '🔒 تم إغلاق القفل' : '🔒 Locked');
                alert(message);
            } else {
                alert(currentLang === 'ar' ? '❌ كلمة المرور غير صحيحة!' : '❌ Incorrect password!');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        // ========== Filter Functions ==========
        function handleSearch(value) {
            monthFilterSearch = value;
            console.log('🔍 Search filter:', value);
            renderContent();
        }
        
        function handleProjectFilter(value) {
            monthFilterProject = value;
            console.log('🏗️ Project filter:', value);
            renderContent();
        }
        
        function handleTypeFilter(value) {
            monthFilterType = value;
            console.log('👥 Type filter:', value);
            renderContent();
        }

        // ========== Dropdown Functions ==========
        function populateDropdowns() {
            console.log('🔄 Populating dropdowns...');
            
            // ملء اختيار السنوات
            populateYearSelector();
            
            const monthsDropdown = document.getElementById('monthsDropdown');
            if (monthsDropdown) {
            monthsDropdown.innerHTML = '';
            months.forEach(month => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = t('monthNames')[month];
                item.onclick = () => {
                    selectMonth(month);
                    closeAllDropdowns();
                };
                monthsDropdown.appendChild(item);
            });
                console.log('✅ Months dropdown populated with', months.length, 'months');
            } else {
                console.error('❌ monthsDropdown element not found!');
            }

            const projectsDropdown = document.getElementById('projectsDropdown');
            if (projectsDropdown) {
            projectsDropdown.innerHTML = '';
                
                // الحصول على المشاريع المسموح بها للمستخدم
                const allowedProjects = getAllowedProjects();
                const filteredProjects = allowedProjects === null ? projects : 
                    Object.fromEntries(Object.entries(projects).filter(([code]) => allowedProjects.includes(code)));
                
                if (Object.keys(filteredProjects).length === 0) {
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'dropdown-item';
                    emptyItem.style.color = 'var(--gray)';
                    emptyItem.textContent = allowedProjects === null ? 'لا توجد مشاريع - أضف مشروعاً جديداً' : 'لا توجد مشاريع مسموح بها';
                    projectsDropdown.appendChild(emptyItem);
                    console.log('⚠️ No projects to display');
                } else {
            Object.entries(filteredProjects).forEach(([code, name]) => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = name;
                nameSpan.onclick = (e) => {
                    e.stopPropagation();
                    selectProject(code);
                    closeAllDropdowns();
                };
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'project-actions';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'project-action-btn';
                editBtn.innerHTML = '✏️';
                editBtn.title = currentLang === 'ar' ? 'تعديل' : 'Edit';
                editBtn.onclick = (e) => {
                    e.stopPropagation();
                    openEditProjectModal(code);
                };
                
                actionsDiv.appendChild(editBtn);
                
                // إضافة زر الحذف فقط للمستخدمين الذين لديهم صلاحيات كاملة
                if (currentUser && currentUser.fullAccess) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'project-action-btn';
                deleteBtn.innerHTML = '🗑️';
                deleteBtn.title = currentLang === 'ar' ? 'حذف' : 'Delete';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteProject(code);
                };
                actionsDiv.appendChild(deleteBtn);
                }
                
                item.appendChild(nameSpan);
                item.appendChild(actionsDiv);
                projectsDropdown.appendChild(item);
            });
                    console.log('✅ Projects dropdown populated with', Object.keys(projects).length, 'projects');
                }
            } else {
                console.error('❌ projectsDropdown element not found!');
            }
            
            if (projectsDropdown) {
            const addItem = document.createElement('div');
            addItem.className = 'dropdown-item add-new';
            addItem.textContent = currentLang === 'ar' ? '➕ إضافة مشروع' : '➕ Add Project';
            addItem.onclick = () => {
                // التحقق من قفل الشهر
                if (!canEditCurrentMonth()) {
                    showNotification('warning', t('warning'), t('monthLocked'));
                    return;
                }
                openModal('projectModal');
                closeAllDropdowns();
            };
            projectsDropdown.appendChild(addItem);
            }
            
            console.log('✅ Dropdowns population completed');
            populateProjectSelects();
        }

        function populateProjectSelects() {
            // الحصول على المشاريع المسموح بها للمستخدم
            const allowedProjects = getAllowedProjects();
            const filteredProjects = allowedProjects === null ? projects : 
                Object.fromEntries(Object.entries(projects).filter(([code]) => allowedProjects.includes(code)));
            
            ['project', 'editProject', 'summaryProject'].forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    if (selectId === 'summaryProject') {
                        select.innerHTML = '<option value="">اختر المشروع</option><option value="ALL">🌐 ' + t('allProjects') + '</option>';
                    } else {
                        select.innerHTML = '';
                    }
                    Object.entries(filteredProjects).forEach(([code, name]) => {
                        const option = document.createElement('option');
                        option.value = code;
                        option.textContent = `${code} - ${name}`;
                        select.appendChild(option);
                    });
                }
            });

            ['summaryMonth1', 'summaryMonth2', 'targetMonth'].forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    if (selectId === 'summaryMonth2') {
                        select.innerHTML = '<option value="">بدون مقارنة</option>';
                    } else {
                        select.innerHTML = '';
                    }
                    months.forEach(month => {
                        const option = document.createElement('option');
                        option.value = month;
                        option.textContent = t('monthNames')[month];
                        if (selectId === 'summaryMonth1' && month === 'august') option.selected = true;
                        select.appendChild(option);
                    });
                }
            });
        }

        function toggleDropdown(id) {
            closeAllDropdowns();
            document.getElementById(id).classList.toggle('show');
        }

        function closeAllDropdowns() {
            document.querySelectorAll('.dropdown-content').forEach(dd => dd.classList.remove('show'));
        }
// ========== Form Handlers (Project Forms Only) ==========
        document.getElementById('projectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // التحقق من وجود المستخدم
            if (!currentUser) {
                showNotification('error', t('notAuthorized'), t('loginRequired'));
                return;
            }
            
            // التحقق من صلاحية إضافة المشاريع
            if (!hasDetailedPermission('projects', 'add')) {
                showNotification('error', t('notAuthorized'), t('noAddPermission') + ' ' + t('projects').toLowerCase());
                return;
            }
            
            const code = document.getElementById('projectCode').value.trim().toUpperCase();
            const name = document.getElementById('projectName').value.trim();
            
            if (projects[code]) {
                alert(currentLang === 'ar' ? 'هذا الكود موجود مسبقاً! ❌' : 'This code already exists! ❌');
                return;
            }
            
            await saveProjectToFirebase(code, name);
            closeModal('projectModal');
            e.target.reset();
        });

        document.getElementById('editProjectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // التحقق من وجود المستخدم
            if (!currentUser) {
                showNotification('error', t('notAuthorized'), t('loginRequired'));
                return;
            }
            
            // التحقق من صلاحية الوصول للمشروع
            if (projectCodeToEdit && !hasProjectAccess(projectCodeToEdit)) {
                showNotification('error', t('notAuthorized'), t('noProjectAccess'));
                return;
            }
            
            // التحقق من صلاحية تعديل المشاريع
            if (!hasDetailedPermission('projects', 'edit')) {
                showNotification('error', t('notAuthorized'), t('noEditPermission') + ' ' + t('projects').toLowerCase());
                return;
            }
            
            const newName = document.getElementById('editProjectName').value.trim();
            if (!newName) {
                alert(currentLang === 'ar' ? 'الرجاء إدخال اسم المشروع' : 'Please enter project name');
                return;
            }
            
            await saveProjectToFirebase(projectCodeToEdit, newName);
            closeModal('editProjectModal');
        });

        document.getElementById('multipleEmployeesForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const rows = document.querySelectorAll('#multipleEmployeesTableBody tr');
            let addedCount = 0;
            
            showLoading();
            const tbody = document.getElementById('multipleEmployeesTableBody');
            for (let index = 0; index < rows.length; index++) {
                const row = rows[index];
                // دعم النظامين القديم والجديد
                const inputs = row.querySelectorAll('.multi-emp-input, .multi-emp-cell');
                const data = {};
                let hasData = false;
                
                inputs.forEach(input => {
                    const field = input.dataset.field;
                    const value = input.value.trim();
                    if (value) hasData = true;
                    data[field] = value;
                });
                
                if (hasData && data.nameAr && data.project && data.salary) {
                    // التحقق من تكرار الاسم في جميع المشاريع (في نفس الشهر فقط)
                    const nameAr = data.nameAr.trim();
                    const nameEn = (data.nameEn || data.nameAr).trim();
                    const duplicateCheck = checkDuplicateEmployeeName(nameAr, nameEn, null, currentMonth, currentYear);
                    if (duplicateCheck.duplicate) {
                        showNotification('warning', currentLang === 'ar' ? 'اسم مكرر' : 'Duplicate Name', 
                            `${currentLang === 'ar' ? 'تم تخطي' : 'Skipped'}: ${duplicateCheck.message}`);
                        continue; // تخطي هذا الموظف
                    }
                    
                    // توليد رمز الموظف تلقائياً
                    const employeeCode = await generateEmployeeCode(data.project);
                    
                    // الحصول على أيام العمل الأسبوعية للصف الحالي
                    const workDaysOfWeek = workDaysData[index] || [true, true, true, true, true, false, true];
                    
                    const newEmployee = {
                        employeeCode: employeeCode,
                        nameAr: nameAr,
                        nameEn: nameEn,
                        position: data.position || '-',
                        employeeType: data.employeeType || 'monthly',
                        project: data.project,
                        salary: parseFloat(data.salary) || 0,
                        salaryCurrency: data.salaryCurrency || 'USD',
                        paymentCurrency: data.paymentCurrency || data.salaryCurrency || 'IQD',
                        exchangeRate: parseFloat(data.exchangeRate) || 1420,
                        workDays: 30,
                        bonus: 0, bonusCurrency: 'IQD',
                        phoneBills: 0, phoneBillsCurrency: 'IQD',
                        deductions: 0, deductionsCurrency: 'IQD',
                        advance: 0, advanceCurrency: 'IQD',
                        salaryIncrease: 0, salaryIncreaseCurrency: 'IQD',
                        ceoBonus: 0, ceoBonusCurrency: 'IQD',
                        // إعدادات الدوام من النموذج
                        attendanceSystem: data.attendanceSystem || 'hours',
                        dailyWorkHours: parseFloat(data.dailyWorkHours) || 8,
                        overtimeMultiplier: parseFloat(data.overtimeMultiplier) || 1.5,
                        monthCalculationMethod: data.monthCalculationMethod || '30',
                        workDaysOfWeek: workDaysOfWeek, // أيام العمل المحددة من النافذة
                        paidLeaveCalculation: data.paidLeaveCalculation || 'full',
                        attendance: {}
                    };
                    await saveEmployeeToFirebase(newEmployee, currentMonth, currentYear);
                    addedCount++;
                }
            }
            
            hideLoading();
            closeModal('multipleEmployeesModal');
            document.getElementById('multipleEmployeesForm').reset();
            // مسح أيام العمل بعد إرسال النموذج
            workDaysData = {};
            // مسح الجدول
            tbody.innerHTML = '';
            updateMultiEmpRowCount();
            
            if (addedCount > 0) {
                alert(currentLang === 'ar' ? `تم إضافة ${addedCount} موظف بنجاح! ✅` : `Added ${addedCount} employees successfully! ✅`);
            } else {
                alert(currentLang === 'ar' ? 'الرجاء ملء البيانات المطلوبة (الاسم، المشروع، الراتب)' : 'Please fill required fields (Name, Project, Salary)');
            }
        });

        // ========== إدارة أيام العمل الأسبوعية في الإضافة المتعددة ==========
        let currentWorkDaysRowIndex = null;
        let workDaysData = {}; // تخزين أيام العمل لكل صف
        
        function openWorkDaysModal(btn) {
            const row = btn.closest('tr');
            const tbody = document.getElementById('multipleEmployeesTableBody');
            // الحصول على الفهرس الفعلي من موضع الصف في الجدول
            const rowIndex = Array.from(tbody.children).indexOf(row);
            currentWorkDaysRowIndex = rowIndex;
            
            // تحديث data-row-index في الزر والملخص
            btn.dataset.rowIndex = rowIndex;
            const summaryDiv = row.querySelector('.work-days-summary');
            if (summaryDiv) {
                summaryDiv.dataset.rowIndex = rowIndex;
            }
            
            // الحصول على القيم الحالية أو استخدام القيم الافتراضية
            const currentDays = workDaysData[rowIndex] || [true, true, true, true, true, false, true];
            
            // تعيين القيم في النافذة
            for (let i = 0; i < 7; i++) {
                document.getElementById(`modal_workDay_${i}`).checked = currentDays[i];
            }
            
            openModal('workDaysModal');
        }
        
        function saveWorkDays() {
            if (currentWorkDaysRowIndex === null) return;
            
            // جمع أيام العمل المحددة
            const selectedDays = [];
            for (let i = 0; i < 7; i++) {
                selectedDays.push(document.getElementById(`modal_workDay_${i}`).checked);
            }
            
            // حفظ القيم
            workDaysData[currentWorkDaysRowIndex] = selectedDays;
            
            // تحديث الملخص في الجدول
            const summaryDiv = document.querySelector(`.work-days-summary[data-row-index="${currentWorkDaysRowIndex}"]`);
            const count = selectedDays.filter(d => d).length;
            const dayNames = ['أحد', 'اثنين', 'ثلاثاء', 'أربعاء', 'خميس', 'جمعة', 'سبت'];
            const selectedDayNames = selectedDays.map((selected, index) => selected ? dayNames[index] : null).filter(n => n);
            
            if (summaryDiv) {
                summaryDiv.textContent = `${count} أيام (${selectedDayNames.join(', ')})`;
                summaryDiv.style.display = 'block';
            }
            
            // تحديث لون الزر والنص
            const btn = document.querySelector(`.work-days-btn[data-row-index="${currentWorkDaysRowIndex}"]`);
            if (btn) {
                btn.style.background = count > 0 ? '#10b981' : '#3b82f6';
                btn.textContent = count > 0 ? '✓ محدّد' : '📅 تحديد';
            }
            
            closeModal('workDaysModal');
            currentWorkDaysRowIndex = null;
        }
        
        // ========== Advanced Permission Functions ==========
        async function togglePermissionDetails() {
            const permissionType = document.getElementById('newUserPermissionType').value;
            const detailsDiv = document.getElementById('permissionDetails');
            
            if (permissionType === 'custom') {
                detailsDiv.style.display = 'block';
                // تحميل قائمة المشاريع
                await loadProjectsList('perm_projects_list');
            } else {
                detailsDiv.style.display = 'none';
                // تعيين الصلاحيات حسب النوع
                if (permissionType === 'full') {
                    setAllPermissions(true);
                } else if (permissionType === 'limited') {
                    setAllPermissions(false);
                    // الصلاحيات المحدودة: عرض فقط
                    document.getElementById('perm_monthly_view').checked = true;
                    document.getElementById('perm_daily_view').checked = true;
                    document.getElementById('perm_vehicle_view').checked = true;
                    document.getElementById('perm_projects_view').checked = true;
                    document.getElementById('perm_reports_view').checked = true;
                }
            }
        }
        
        // دالة لإظهار/إخفاء قائمة المشاريع المحددة
        // ========== دالة موحدة لإظهار/إخفاء قسم التحديد المخصص ==========
        function toggleSpecificSection(radioId, divId) {
            const specificRadio = document.getElementById(radioId);
            const specificDiv = document.getElementById(divId);
            
            if (specificRadio && specificRadio.checked && specificDiv) {
                specificDiv.style.display = 'block';
            } else if (specificDiv) {
                specificDiv.style.display = 'none';
            }
        }
        
        // دوال wrapper للتوافق مع الكود الموجود
        function toggleSpecificProjects() {
            toggleSpecificSection('perm_projects_specific', 'specificProjectsDiv');
        }
        
        function toggleSpecificMonths() {
            toggleSpecificSection('perm_months_specific', 'specificMonthsDiv');
        }
        
        function toggleLinkSpecificProjects() {
            toggleSpecificSection('link_perm_projects_specific', 'linkSpecificProjectsDiv');
        }
        
        async function toggleLinkPermissionDetails() {
            const permissionType = document.getElementById('linkUserPermissionType').value;
            const detailsDiv = document.getElementById('linkPermissionDetails');
            
            if (permissionType === 'custom') {
                detailsDiv.style.display = 'block';
                // تحميل قائمة المشاريع
                await loadProjectsList('link_perm_projects_list');
            } else {
                detailsDiv.style.display = 'none';
                // تعيين الصلاحيات حسب النوع
                if (permissionType === 'full') {
                    setAllLinkPermissions(true);
                } else if (permissionType === 'limited') {
                    setAllLinkPermissions(false);
                    // الصلاحيات المحدودة: عرض فقط
                    document.getElementById('link_perm_monthly_view').checked = true;
                    document.getElementById('link_perm_daily_view').checked = true;
                    document.getElementById('link_perm_vehicle_view').checked = true;
                    document.getElementById('link_perm_projects_view').checked = true;
                    document.getElementById('link_perm_reports_view').checked = true;
                }
            }
        }
        
        // دالة لتحميل قائمة المشاريع
        async function loadProjectsList(selectId) {
            try {
                const projectsSnapshot = await getDocs(collection(db, 'projects'));
                const selectElement = document.getElementById(selectId);
                
                if (!selectElement) return;
                
                selectElement.innerHTML = '';
                
                projectsSnapshot.forEach((doc) => {
                    const projectData = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${projectData.name} (${doc.id})`;
                    selectElement.appendChild(option);
                });
                
                if (projectsSnapshot.empty) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'لا توجد مشاريع';
                    option.disabled = true;
                    selectElement.appendChild(option);
                }
            } catch (error) {
                console.error('خطأ في تحميل المشاريع:', error);
            }
        }
        
        // (تم استبدال دوال نافذة التعديل القديمة بدوال النظام المتقدم لاحقاً)
        
        // ========== دالة موحدة للحصول على الصلاحيات من النماذج ==========
        function getPermissionsFromForm(prefix = '') {
            // تحديد البادئة (فارغ للنموذج الأساسي، 'link_' أو 'edit_' للنماذج الأخرى)
            const projectAccessName = prefix ? `${prefix}ProjectAccess` : 'projectAccess';
            const monthAccessName = prefix ? `${prefix}MonthAccess` : 'monthAccess';
            const projectListId = prefix ? `${prefix}perm_projects_list` : 'perm_projects_list';
            const monthCheckboxClass = prefix ? `.${prefix}month-checkbox` : '.month-checkbox';
            
            // الحصول على المشاريع المحددة
            const projectAccessType = document.querySelector(`input[name="${projectAccessName}"]:checked`)?.value || 'all';
            let allowedProjects = [];
            
            if (projectAccessType === 'specific') {
                const projectSelect = document.getElementById(projectListId);
                if (projectSelect) {
                allowedProjects = Array.from(projectSelect.selectedOptions).map(option => option.value);
                }
            }
            
            // الحصول على الأشهر المحددة (إن وُجدت)
            const monthAccessType = document.querySelector(`input[name="${monthAccessName}"]:checked`)?.value || 'all';
            let allowedMonths = [];
            
            if (monthAccessType === 'specific') {
                const monthCheckboxes = document.querySelectorAll(`${monthCheckboxClass}:checked`);
                allowedMonths = Array.from(monthCheckboxes).map(cb => cb.value);
            }
            
            // بناء كائن الصلاحيات
            const permPrefix = prefix ? `${prefix}perm_` : 'perm_';
            
            const permissions = {
                employees: {
                    monthly: {
                        view: document.getElementById(`${permPrefix}monthly_view`)?.checked || false,
                        add: document.getElementById(`${permPrefix}monthly_add`)?.checked || false,
                        edit: document.getElementById(`${permPrefix}monthly_edit`)?.checked || false,
                        delete: document.getElementById(`${permPrefix}monthly_delete`)?.checked || false
                    },
                    daily: {
                        view: document.getElementById(`${permPrefix}daily_view`)?.checked || false,
                        add: document.getElementById(`${permPrefix}daily_add`)?.checked || false,
                        edit: document.getElementById(`${permPrefix}daily_edit`)?.checked || false,
                        delete: document.getElementById(`${permPrefix}daily_delete`)?.checked || false
                    },
                    vehicle: {
                        view: document.getElementById(`${permPrefix}vehicle_view`)?.checked || false,
                        add: document.getElementById(`${permPrefix}vehicle_add`)?.checked || false,
                        edit: document.getElementById(`${permPrefix}vehicle_edit`)?.checked || false,
                        delete: document.getElementById(`${permPrefix}vehicle_delete`)?.checked || false
                    }
                },
                projects: {
                    view: document.getElementById(`${permPrefix}projects_view`)?.checked || false,
                    add: document.getElementById(`${permPrefix}projects_add`)?.checked || false,
                    edit: document.getElementById(`${permPrefix}projects_edit`)?.checked || false,
                    delete: document.getElementById(`${permPrefix}projects_delete`)?.checked || false,
                    allowedProjects: projectAccessType === 'all' ? [] : allowedProjects
                },
                users: {
                    view: document.getElementById(`${permPrefix}users_view`)?.checked || false,
                    add: document.getElementById(`${permPrefix}users_add`)?.checked || false,
                    edit: document.getElementById(`${permPrefix}users_edit`)?.checked || false,
                    delete: document.getElementById(`${permPrefix}users_delete`)?.checked || false
                },
                reports: {
                    view: document.getElementById(`${permPrefix}reports_view`)?.checked || false,
                    export: document.getElementById(`${permPrefix}reports_export`)?.checked || false,
                    print: document.getElementById(`${permPrefix}reports_print`)?.checked || false
                },
                settings: document.getElementById(`${permPrefix}settings`)?.checked || false
            };
            
            // إضافة صلاحيات الأشهر إذا كانت موجودة
            if (document.getElementById(`${permPrefix}months_view`)) {
                permissions.months = {
                    view: document.getElementById(`${permPrefix}months_view`)?.checked || false,
                    edit: document.getElementById(`${permPrefix}months_edit`)?.checked || false,
                    allowedMonths: monthAccessType === 'all' ? [] : allowedMonths
                };
            }
            
            return permissions;
        }
        
        // دوال wrapper للتوافق مع الكود الموجود
        function getPermissions() {
            return getPermissionsFromForm('');
        }
        
        function getLinkPermissions() {
            return getPermissionsFromForm('link_');
        }
        
        function getEditPermissions() {
            return getPermissionsFromForm('edit_');
        }
        
        // ========== دالة موحدة لتحديد/إلغاء تحديد جميع الصلاحيات ==========
        function setAllPermissions(checked, containerId = 'permissionDetails') {
            const checkboxes = document.querySelectorAll(`#${containerId} input[type="checkbox"]`);
            checkboxes.forEach(checkbox => {
                checkbox.checked = checked;
            });
        }
        
        function setAllLinkPermissions(checked) {
            setAllPermissions(checked, 'linkPermissionDetails');
        }
        
        // دالة للتحقق من الصلاحيات
        function hasPermission(permission) {
            if (!currentUser) return false;
            
            // إذا كان لديه صلاحيات كاملة، السماح بكل شيء
            if (currentUser.fullAccess === true) return true;
            
            if (!currentUser.permissions) return false;
            
            const parts = permission.split('.');
            let current = currentUser.permissions;
            
            for (const part of parts) {
                if (current && typeof current === 'object' && part in current) {
                    current = current[part];
                } else {
                    return false;
                }
            }
            
            return current === true;
        }
        
        // دالة للتحقق من الصلاحيات الكاملة (للتوافق مع النظام القديم)
        function hasFullAccess() {
            return currentUser && currentUser.fullAccess === true;
        }
        
        // ========== نظام الصلاحيات المتقدم ==========
        
        /**
         * التحقق من الصلاحيات التفصيلية
         * @param {string} module - الوحدة (months, projects, employees, reports, users, settings, dashboard, lockedFields)
         * @param {string} action - الإجراء (view, add, edit, delete, print, export, etc.)
         * @param {string} subAction - الإجراء الفرعي الاختياري (editSalary, editBonus, etc.)
         * @returns {boolean}
         */
        function hasDetailedPermission(module, action, subAction = null, employeeType = null) {
            if (!currentUser) return false;
            
            // إذا كان لديه صلاحيات كاملة، السماح بكل شيء
            if (currentUser.fullAccess === true) return true;
            
            if (!currentUser.permissions) return false;
            
            const modulePerms = currentUser.permissions[module];
            if (!modulePerms) return false;
            
            // صلاحيات الموظفين حسب النوع
            if (module === 'employees' && employeeType && modulePerms[employeeType]) {
                const typePerms = modulePerms[employeeType];
                if (subAction) {
                    return typePerms[action] === true && typePerms[subAction] === true;
                }
                return typePerms[action] === true;
            }
            
            // التحقق من الإجراء الفرعي
            if (subAction) {
                return modulePerms[action] === true && modulePerms[subAction] === true;
            }
            
            return modulePerms[action] === true;
        }

        /**
         * التحقق من قفل الشهر من التعديل
         * @param {string} year - السنة
         * @param {string} month - الشهر
         * @returns {boolean} - true إذا كان الشهر مقفل
         */
        function isMonthLocked(year, month) {
            if (!month) return false;
            if (!currentUser) return false;
            
            // إذا كان لديه صلاحيات كاملة، لا يوجد قفل
            if (currentUser.fullAccess === true) return false;
            
            if (!currentUser.permissions || !currentUser.permissions.months) return false;
            
            const monthPerms = currentUser.permissions.months;
            const targetYear = parseInt(year, 10) || currentYear;
            
            // التحقق من قفل الشهر المحدد
            if (monthPerms.lockedMonths && Array.isArray(monthPerms.lockedMonths)) {
                const monthKey = `${targetYear}-${month}`;
                return monthPerms.lockedMonths.includes(monthKey);
            }
            
            return false;
        }

        /**
         * التحقق من إمكانية تعديل الشهر الحالي
         * @returns {boolean}
         */
        function canEditCurrentMonth(monthKey = currentMonth, year = currentYear) {
            if (!monthKey) return false;
            return !isMonthLocked(year, monthKey);
        }
        
        /**
         * التحقق من الوصول للمشروع
         * @param {string} projectId - معرف المشروع
         * @returns {boolean}
         */
        function hasProjectAccess(projectId) {
            if (!currentUser) return false;
            
            // إذا كان لديه صلاحيات كاملة
            if (currentUser.fullAccess === true) return true;
            
            if (!currentUser.permissions || !currentUser.permissions.projects) return false;
            
            const projectPerms = currentUser.permissions.projects;
            
            // إذا كان لديه حق الوصول لجميع المشاريع
            if (projectPerms.viewAll === true) return true;
            
            // التحقق من قائمة المشاريع المسموح بها
            if (Array.isArray(projectPerms.allowedProjects)) {
                return projectPerms.allowedProjects.includes(projectId);
            }
            
            return false;
        }
        
        /**
         * الحصول على قائمة المشاريع المسموح بها
         * @returns {Array} - قائمة معرفات المشاريع أو null إذا كان لديه حق الوصول لجميع المشاريع
         */
        function getAllowedProjects() {
            if (!currentUser) return [];
            
            // إذا كان لديه صلاحيات كاملة أو حق الوصول لجميع المشاريع
            if (currentUser.fullAccess === true) return null;
            
            if (!currentUser.permissions || !currentUser.permissions.projects) return [];
            
            const projectPerms = currentUser.permissions.projects;
            
            if (projectPerms.viewAll === true) return null; // null يعني الكل
            
            return projectPerms.allowedProjects || [];
        }

        function canManageDatabaseSettings() {
            if (hasFullAccess()) return true;
            if (!currentUser) return false;
            if (hasPermission('settings.editGeneral') || hasPermission('settings.editProjects') || hasPermission('settings.editBackup')) {
                return true;
            }
            if (!currentUser.permissions || !currentUser.permissions.settings) return false;
            const settingsPerms = currentUser.permissions.settings;
            if (settingsPerms === true) return true;
            const possibleKeys = ['editGeneral', 'editProjects', 'editBackup', 'editConnection', 'edit'];
            return possibleKeys.some(key => settingsPerms[key] === true);
        }
        
        /**
         * تطبيق الصلاحيات على عنصر DOM
         * @param {string} elementId - معرف العنصر
         * @param {string} module - الوحدة
         * @param {string} action - الإجراء
         */
        function applyPermissionToElement(elementId, module, action) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (!hasDetailedPermission(module, action)) {
                element.style.display = 'none';
            } else {
                element.style.display = '';
            }
        }
        
        /**
         * جعل الحقل للقراءة فقط بناءً على الصلاحيات
         * @param {string} fieldId - معرف الحقل
         * @param {string} module - الوحدة
         * @param {string} action - الإجراء
         */
        function applyReadOnlyPermission(fieldId, module, action) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            
            if (!hasDetailedPermission(module, action)) {
                field.readOnly = true;
                field.disabled = true;
                field.style.backgroundColor = '#f5f5f5';
                field.style.cursor = 'not-allowed';
            } else {
                field.readOnly = false;
                field.disabled = false;
                field.style.backgroundColor = '';
                field.style.cursor = '';
            }
        }

        // ========== User Management Functions ==========
        function renderYearsView() {
            const content = document.getElementById('mainContent');
            
            let html = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: var(--primary); font-size: 32px; margin-bottom: 10px;">📅 ${t('yearsManagement')}</h2>
                    <p style="color: var(--gray); font-size: 16px;">${currentLang === 'ar' ? 'إضافة وإدارة السنوات المتاحة في النظام' : 'Add and manage available years in the system'}</p>
                </div>
                
                <!-- بطاقة إضافة سنة جديدة -->
                <div style="max-width: 800px; margin: 0 auto 30px auto;">
                    <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                        <h3 style="color: white; font-size: 24px; margin-bottom: 15px;">➕ ${t('addYear')}</h3>
                        <p style="color: rgba(255,255,255,0.9); margin-bottom: 20px; font-size: 14px;">
                            ${currentLang === 'ar' ? 'أضف سنة جديدة لإدارة رواتب الموظفين' : 'Add a new year to manage employee salaries'}
                        </p>
                        <button onclick="openAddYearModal()" 
                                style="background: white; 
                                       color: #38f9d7; 
                                       border: none; 
                                       padding: 15px 40px; 
                                       border-radius: 12px; 
                                       font-weight: 700; 
                                       font-size: 16px;
                                       cursor: pointer;
                                       box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                                       transition: all 0.3s;">
                            ➕ ${currentLang === 'ar' ? 'إضافة سنة جديدة' : 'Add New Year'}
                        </button>
                    </div>
                </div>
                
                <!-- قائمة السنوات -->
                <div style="max-width: 1200px; margin: 0 auto;">
                    <h3 style="color: var(--primary); font-size: 22px; margin-bottom: 20px; text-align: center;">
                        📋 ${currentLang === 'ar' ? 'السنوات المتاحة' : 'Available Years'} (${availableYears.length})
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        ${availableYears.length === 0 ? `
                            <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
                                <div style="font-size: 80px; margin-bottom: 20px;">📅</div>
                                <h3 style="color: var(--gray); font-size: 20px; margin-bottom: 10px;">
                                    ${currentLang === 'ar' ? 'لا توجد سنوات' : 'No Years Available'}
                                </h3>
                                <p style="color: var(--gray);">
                                    ${currentLang === 'ar' ? 'ابدأ بإضافة سنة جديدة' : 'Start by adding a new year'}
                                </p>
                            </div>
                        ` : availableYears.map(year => {
                            const isCurrentYear = year === currentYear;
                            
                            // حساب عدد الموظفين في هذه السنة
                            let employeeCount = 0;
                            if (employeeData[year]) {
                                months.forEach(month => {
                                    if (employeeData[year][month]) {
                                        employeeCount += employeeData[year][month].length;
                                    }
                                });
                            }
                            
                            return `
                                <div class="year-card" style="
                                    background: ${isCurrentYear ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'white'}; 
                                    color: ${isCurrentYear ? 'white' : 'var(--dark)'}; 
                                    padding: 30px; 
                                    border-radius: 20px; 
                                    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                                    border: 3px solid ${isCurrentYear ? '#667eea' : 'var(--border)'};
                                    transition: all 0.3s;
                                    position: relative;
                                    overflow: hidden;">
                                    
                                    ${isCurrentYear ? `
                                        <div style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.3); padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                            ✓ ${currentLang === 'ar' ? 'السنة الحالية' : 'Current'}
                                        </div>
                                    ` : ''}
                                    
                                    <div style="text-align: center; margin-bottom: 20px;">
                                        <div style="font-size: 48px; font-weight: 800; margin-bottom: 10px;">
                                            ${year}
                                        </div>
                                        <div style="font-size: 14px; opacity: 0.8;">
                                            📊 ${employeeCount} ${currentLang === 'ar' ? 'موظف' : 'employees'}
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                                        ${!isCurrentYear ? `
                                            <button onclick="selectYear(${year}); showTab('dashboard');" 
                                                    style="flex: 1;
                                                           background: ${isCurrentYear ? 'rgba(255,255,255,0.2)' : 'var(--primary)'}; 
                                                           color: white; 
                                                           border: none; 
                                                           padding: 12px 20px; 
                                                           border-radius: 10px; 
                                                           font-weight: 600; 
                                                           cursor: pointer;
                                                           transition: all 0.3s;">
                                                👁️ ${currentLang === 'ar' ? 'عرض' : 'View'}
                                            </button>
                                        ` : `
                                            <button onclick="showTab('dashboard');" 
                                                    style="flex: 1;
                                                           background: rgba(255,255,255,0.2); 
                                                           color: white; 
                                                           border: none; 
                                                           padding: 12px 20px; 
                                                           border-radius: 10px; 
                                                           font-weight: 600; 
                                                           cursor: pointer;">
                                                📊 ${currentLang === 'ar' ? 'Dashboard' : 'Dashboard'}
                                            </button>
                                        `}
                                        
                                        ${!isCurrentYear && currentUser && currentUser.fullAccess ? `
                                            <button onclick="deleteYearFromFirebase(${year})" 
                                                    style="background: rgba(239, 68, 68, 0.9); 
                                                           color: white; 
                                                           border: none; 
                                                           padding: 12px 20px; 
                                                           border-radius: 10px; 
                                                           font-weight: 600; 
                                                           cursor: pointer;">
                                                🗑️ ${currentLang === 'ar' ? 'حذف' : 'Delete'}
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- معلومات إضافية -->
                    <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary);">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">💡 ${currentLang === 'ar' ? 'معلومات' : 'Information'}</h4>
                        <ul style="color: var(--dark); line-height: 2;">
                            <li>${currentLang === 'ar' ? 'كل سنة تحتوي على بيانات مستقلة للموظفين' : 'Each year contains independent employee data'}</li>
                            <li>${currentLang === 'ar' ? 'يمكنك التبديل بين السنوات من الأعلى' : 'You can switch between years from the top'}</li>
                            <li>${currentLang === 'ar' ? 'حذف السنة يحذف جميع بياناتها نهائياً' : 'Deleting a year permanently removes all its data'}</li>
                            <li>${currentLang === 'ar' ? 'لا يمكن حذف السنة المستخدمة حالياً' : 'Cannot delete the currently active year'}</li>
                        </ul>
                    </div>
                </div>
            `;
            
            setHTML(content, html);
        }

        async function renderUsersView() {
            const content = document.getElementById('mainContent');
            
            // إزالة التحقق من الصلاحيات - متاح للجميع
            const managementTitle = currentLang === 'ar' ? 'إدارة المستخدمين' : 'User Management';
            const managementDesc = currentLang === 'ar' ? 'إدارة المستخدمين والصلاحيات المتقدمة في النظام' : 'Manage users and advanced permissions in the system';
            const addUserBtn = currentLang === 'ar' ? '➕ إضافة مستخدم جديد' : '➕ Add New User';
            const linkUserBtn = currentLang === 'ar' ? '🔗 ربط مستخدم موجود' : '🔗 Link Existing User';
            const refreshBtn = currentLang === 'ar' ? '🔄 تحديث القائمة' : '🔄 Refresh List';
            const usersListTitle = currentLang === 'ar' ? '📋 قائمة المستخدمين' : '📋 Users List';
            const usersListDesc = currentLang === 'ar' ? 'المستخدمون المربوطون بصلاحيات في النظام (المحفوظون في Firestore)' : 'Users linked with permissions in the system (Stored in Firestore)';
            const loadingText = currentLang === 'ar' ? 'جاري تحميل المستخدمين...' : 'Loading users...';
            
            setHTML(content, `
                <div class="page-header">
                    <h1>👥 ${managementTitle}</h1>
                    <p>${managementDesc}</p>
                </div>
                
                <div class="action-bar">
                    ${hasPermission('users.add') ? `
                        <button class="btn btn-primary" onclick="openModal('addUserModal')">
                            ${addUserBtn}
                        </button>
                    ` : ''}
                    ${hasPermission('users.add') ? `
                        <button class="btn btn-secondary" onclick="openModal('linkUserModal')">
                            ${linkUserBtn}
                        </button>
                    ` : ''}
                    <button class="btn btn-info" onclick="loadUsersData()">
                        ${refreshBtn}
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3>${usersListTitle}</h3>
                        <p style="font-size: 13px; color: var(--gray); margin: 5px 0 0 0;">
                            ${usersListDesc}
                        </p>
                    </div>
                    <div class="card-body">
                        <div id="usersListContainer">
                            <div class="loading">${loadingText}</div>
                        </div>
                    </div>
                </div>
            `);
            
            loadUsersData();
        }
        
        async function loadUsersData() {
            try {
                console.log('🔄 Loading users data...');
                console.log('📊 Database object:', db);
                
                const usersSnapshot = await getDocs(collection(db, 'users'));
                console.log('✅ Users snapshot loaded:', usersSnapshot.size, 'users');
                
                const usersListContainer = document.getElementById('usersListContainer');
                
                if (!usersListContainer) {
                    console.error('❌ usersListContainer not found!');
                    return;
                }
                
                if (usersSnapshot.empty) {
                    const noUsersTitle = currentLang === 'ar' ? '📭 لا توجد مستخدمين' : '📭 No Users';
                    const noUsersText = currentLang === 'ar' ? 'لم يتم ربط أي مستخدمين بصلاحيات بعد' : 'No users have been linked with permissions yet';
                    const noUsersHint = currentLang === 'ar' ? 
                        'استخدم الأزرار أعلاه لإضافة مستخدمين جدد أو ربط مستخدمين موجودين' :
                        'Use the buttons above to add new users or link existing users';
                    
                    usersListContainer.innerHTML = `
                        <div class="empty-state">
                            <h3>${noUsersTitle}</h3>
                            <p>${noUsersText}</p>
                            <p style="font-size: 13px; color: var(--gray); margin-top: 10px;">
                                ${noUsersHint}
                            </p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="table-container"><table><thead><tr>';
                const idLabel = currentLang === 'ar' ? '🆔' : '🆔 ID';
                const emailLabel = currentLang === 'ar' ? '📧 البريد الإلكتروني' : '📧 Email';
                const roleLabel = currentLang === 'ar' ? '👤 الدور' : '👤 Role';
                const permLabel = currentLang === 'ar' ? '🔐 الصلاحيات' : '🔐 Permissions';
                const detailsLabel = currentLang === 'ar' ? '📊 التفاصيل' : '📊 Details';
                const createdLabel = currentLang === 'ar' ? '📅 تاريخ الإنشاء' : '📅 Created At';
                const actionsLabel = currentLang === 'ar' ? '⚙️ الإجراءات' : '⚙️ Actions';
                
                html += `<th style="width: 50px;">${idLabel}</th>`;
                html += `<th>${emailLabel}</th>`;
                html += `<th>${roleLabel}</th>`;
                html += `<th>${permLabel}</th>`;
                html += `<th>${detailsLabel}</th>`;
                html += `<th>${createdLabel}</th>`;
                html += `<th style="width: 200px;">${actionsLabel}</th>`;
                html += '</tr></thead><tbody>';
                
                let index = 1;
                usersSnapshot.forEach((doc) => {
                    const userData = doc.data();
                    const uid = doc.id;
                    
                    const notSpecified = currentLang === 'ar' ? 'غير محدد' : 'Not Specified';
                    const defaultRole = currentLang === 'ar' ? 'مستخدم' : 'User';
                    const fullText = currentLang === 'ar' ? '🔓 كاملة' : '🔓 Full';
                    const limitedText = currentLang === 'ar' ? '🔒 محدودة' : '🔒 Limited';
                    
                    html += '<tr>';
                    html += `<td>${index++}</td>`;
                    html += `<td style="text-align: left; direction: ltr;">${userData.email || notSpecified}</td>`;
                    html += `<td><span style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">${userData.role || defaultRole}</span></td>`;
                    html += `<td>${userData.fullAccess ? fullText : limitedText}</td>`;
                    
                    // عرض تفاصيل الصلاحيات المتقدمة
                    let permissionDetails = '';
                    const allPermsText = currentLang === 'ar' ? '✅ جميع الصلاحيات' : '✅ All Permissions';
                    const viewOnlyText = currentLang === 'ar' ? 'عرض فقط' : 'View Only';
                    
                    if (userData.fullAccess) {
                        permissionDetails = `<span style="color: var(--success); font-weight: 600;">${allPermsText}</span>`;
                    } else if (userData.permissions) {
                        const perms = userData.permissions;
                        const details = [];
                        
                        // صلاحيات الموظفين حسب النوع
                        if (perms.employees) {
                            if (perms.employees.monthly) {
                                if (perms.employees.monthly.add) details.push('📅+');
                                if (perms.employees.monthly.edit) details.push('📅✏️');
                                if (perms.employees.monthly.delete) details.push('📅🗑️');
                            }
                            if (perms.employees.daily) {
                                if (perms.employees.daily.add) details.push('📆+');
                                if (perms.employees.daily.edit) details.push('📆✏️');
                                if (perms.employees.daily.delete) details.push('📆🗑️');
                            }
                            if (perms.employees.vehicle) {
                                if (perms.employees.vehicle.add) details.push('🚗+');
                                if (perms.employees.vehicle.edit) details.push('🚗✏️');
                                if (perms.employees.vehicle.delete) details.push('🚗🗑️');
                            }
                        }
                        
                        // صلاحيات المشاريع
                        if (perms.projects) {
                            if (perms.projects.add) details.push('🏗️+');
                            if (perms.projects.edit) details.push('🏗️✏️');
                            if (perms.projects.delete) details.push('🏗️🗑️');
                            if (perms.projects.allowedProjects && perms.projects.allowedProjects.length > 0) {
                                details.push(`🏗️[${perms.projects.allowedProjects.length}]`);
                            }
                        }
                        
                        // صلاحيات المستخدمين
                        if (perms.users) {
                            if (perms.users.view) details.push('👥👁️');
                            if (perms.users.add) details.push('👥+');
                            if (perms.users.edit) details.push('👥✏️');
                            if (perms.users.delete) details.push('👥🗑️');
                        }
                        
                        // صلاحيات التقارير
                        if (perms.reports) {
                            if (perms.reports.export) details.push('📊📤');
                            if (perms.reports.print) details.push('📊🖨️');
                        }
                        
                        if (perms.settings) details.push('⚙️');
                        
                        permissionDetails = details.length > 0 ? details.join(' ') : `<span style="color: var(--gray);">${viewOnlyText}</span>`;
                    }
                    html += `<td style="font-size: 11px;">${permissionDetails || `<span style="color: var(--gray);">${viewOnlyText}</span>`}</td>`;
                    
                    const locale = currentLang === 'ar' ? 'ar-EG' : 'en-US';
                    const dateText = userData.createdAt ? new Date(userData.createdAt).toLocaleDateString(locale) : notSpecified;
                    const editBtnText = currentLang === 'ar' ? '✏️ تعديل' : '✏️ Edit';
                    const deleteBtnText = currentLang === 'ar' ? '🗑️ حذف' : '🗑️ Delete';
                    const editTitle = currentLang === 'ar' ? 'تعديل الصلاحيات' : 'Edit Permissions';
                    const deleteTitle = currentLang === 'ar' ? 'حذف الربط' : 'Delete Link';
                    
                    html += `<td>${dateText}</td>`;
                    html += `<td>
                        <button class="btn btn-small btn-primary" onclick="editUserPermissions('${uid}', '${userData.email || ''}', '${userData.role || defaultRole}', ${userData.fullAccess || false})" title="${editTitle}">
                            ${editBtnText}
                        </button>
                        <button class="btn btn-small btn-danger" onclick="deleteUserPermissions('${uid}', '${userData.email || ''}')" title="${deleteTitle}">
                            ${deleteBtnText}
                        </button>
                    </td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                
                const notesTitle = currentLang === 'ar' ? '📖 ملاحظات هامة:' : '📖 Important Notes:';
                const note1 = currentLang === 'ar' ? 
                    'لإضافة مستخدم جديد: استخدم زر "إضافة مستخدم جديد" لإنشاء حساب في Firebase Authentication وربطه تلقائياً' :
                    'To add new user: Use "Add New User" button to create account in Firebase Authentication and link it automatically';
                const note2 = currentLang === 'ar' ? 
                    'لربط مستخدم موجود: أضفه أولاً في Firebase Console ثم استخدم زر "ربط مستخدم موجود" مع UID' :
                    'To link existing user: Add it first in Firebase Console then use "Link Existing User" button with UID';
                const note3 = currentLang === 'ar' ? 
                    'حذف الربط هنا يحذف الصلاحيات من النظام فقط، الحساب في Firebase Authentication يبقى موجوداً' :
                    'Deleting link here removes permissions from system only, the account in Firebase Authentication remains';
                const note4 = currentLang === 'ar' ? 
                    'تعديل الصلاحيات يؤثر فوراً على المستخدم في الجلسة التالية' :
                    'Permission changes take effect immediately in the next session';
                
                html += `
                    <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 20px; border-radius: 12px; margin-top: 20px; border: 2px solid #bae6fd;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">${notesTitle}</h4>
                        <ul style="font-size: 13px; color: var(--gray); line-height: 1.8; padding-${currentLang === 'ar' ? 'right' : 'left'}: 20px;">
                            <li>${note1}</li>
                            <li>${note2}</li>
                            <li>${note3}</li>
                            <li>${note4}</li>
                        </ul>
                    </div>
                `;
                
                usersListContainer.innerHTML = html;
                
            } catch (error) {
                console.error('❌ خطأ في تحميل المستخدمين:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                showNotification('error', t('error'), t('loadUsersError') + ': ' + error.message);
                
                const container = document.getElementById('usersListContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3 style="color: var(--danger);">❌ خطأ في الاتصال</h3>
                            <p>حدث خطأ في تحميل المستخدمين من Firestore</p>
                            <div style="background: #fee2e2; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: right;">
                                <p style="font-size: 14px; color: #991b1b; margin: 5px 0;"><strong>رسالة الخطأ:</strong></p>
                                <p style="font-size: 13px; color: #dc2626; font-family: monospace;">${error.message}</p>
                                ${error.code ? `<p style="font-size: 13px; color: #dc2626; margin-top: 10px;"><strong>كود الخطأ:</strong> ${error.code}</p>` : ''}
                            </div>
                            <div style="text-align: right; background: #dbeafe; padding: 15px; border-radius: 8px;">
                                <p style="font-size: 14px; color: #1e40af; margin: 5px 0;"><strong>الحلول المحتملة:</strong></p>
                                <ul style="text-align: right; font-size: 13px; color: #1e40af; margin: 10px 0;">
                                    <li>تحقق من اتصالك بالإنترنت</li>
                                    <li>تأكد من إعدادات Firestore Security Rules</li>
                                    <li>تحقق من Console في المتصفح (F12) للتفاصيل</li>
                                    <li>تأكد من فتح الملف عبر خادم ويب (http://) وليس مباشرة (file://)</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        // إضافة مستخدم جديد في Firebase Auth + Firestore
        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            const permissionType = document.getElementById('newUserPermissionType').value;
            
            try {
                showLoading();
                
                // إنشاء المستخدم في Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // تحديد الصلاحيات
                let permissions = {};
                let fullAccess = false;
                
                if (permissionType === 'full') {
                    fullAccess = true;
                    permissions = {
                        employees: { view: true, add: true, edit: true, delete: true },
                        projects: { view: true, add: true, edit: true, delete: true },
                        users: { view: true, add: true, edit: true, delete: true },
                        reports: { view: true, export: true, print: true },
                        settings: true
                    };
                } else if (permissionType === 'limited') {
                    fullAccess = false;
                    permissions = {
                        employees: { view: true, add: false, edit: false, delete: false },
                        projects: { view: true, add: false, edit: false, delete: false },
                        users: { view: false, add: false, edit: false, delete: false },
                        reports: { view: true, export: false, print: false },
                        settings: false
                    };
                } else if (permissionType === 'custom') {
                    permissions = getPermissions();
                    // تحديد fullAccess بناءً على الصلاحيات
                    fullAccess = permissions.users.add && permissions.users.edit && permissions.users.delete;
                }
                
                // حفظ بيانات المستخدم في Firestore
                await setDoc(doc(db, 'users', user.uid), {
                    email: email,
                    role: role,
                    fullAccess: fullAccess,
                    permissions: permissions,
                    appVersion: '2.0.9',
                    lastAppUpdate: new Date(),
                    createdAt: new Date().toISOString(),
                    status: 'active'
                });
                
                hideLoading();
                closeModal('addUserModal');
                document.getElementById('addUserForm').reset();
                document.getElementById('permissionDetails').style.display = 'none';
                showNotification('success', t('success'), `${t('userAddedSuccess')}: ${email}`);
                
                // تحديث القائمة
                if (currentView === 'users') {
                    loadUsersData();
                }
                
            } catch (error) {
                console.error('خطأ في إضافة المستخدم:', error);
                hideLoading();
                
                let errorMessage = 'حدث خطأ أثناء إضافة المستخدم';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'هذا البريد الإلكتروني مستخدم بالفعل';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'البريد الإلكتروني غير صالح';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'كلمة المرور ضعيفة جداً (يجب أن تكون 6 أحرف على الأقل)';
                }
                
                showNotification('error', 'خطأ', errorMessage);
            }
        });
        
        // ربط مستخدم موجود بالصلاحيات
        document.getElementById('linkUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const uid = document.getElementById('linkUserUID').value.trim();
            const email = document.getElementById('linkUserEmail').value.trim();
            const role = document.getElementById('linkUserRole').value;
            const permissionType = document.getElementById('linkUserPermissionType').value;
            
            try {
                showLoading();
                
                // تحديد الصلاحيات
                let permissions = {};
                let fullAccess = false;
                
                if (permissionType === 'full') {
                    fullAccess = true;
                    permissions = {
                        employees: { view: true, add: true, edit: true, delete: true },
                        projects: { view: true, add: true, edit: true, delete: true },
                        users: { view: true, add: true, edit: true, delete: true },
                        reports: { view: true, export: true, print: true },
                        settings: true
                    };
                } else if (permissionType === 'limited') {
                    fullAccess = false;
                    permissions = {
                        employees: { view: true, add: false, edit: false, delete: false },
                        projects: { view: true, add: false, edit: false, delete: false },
                        users: { view: false, add: false, edit: false, delete: false },
                        reports: { view: true, export: false, print: false },
                        settings: false
                    };
                } else if (permissionType === 'custom') {
                    permissions = getLinkPermissions();
                    // تحديد fullAccess بناءً على الصلاحيات
                    fullAccess = permissions.users.add && permissions.users.edit && permissions.users.delete;
                }
                
                // حفظ بيانات المستخدم في Firestore
                await setDoc(doc(db, 'users', uid), {
                    email: email || 'غير محدد',
                    role: role,
                    fullAccess: fullAccess,
                    permissions: permissions,
                    appVersion: '2.0.9',
                    lastAppUpdate: new Date(),
                    createdAt: new Date().toISOString(),
                    status: 'active'
                });
                
                hideLoading();
                closeModal('linkUserModal');
                document.getElementById('linkUserForm').reset();
                document.getElementById('linkPermissionDetails').style.display = 'none';
                showNotification('success', t('success'), t('userLinkedSuccess'));
                
                // تحديث القائمة
                if (currentView === 'users') {
                    loadUsersData();
                }
                
            } catch (error) {
                console.error('خطأ في ربط المستخدم:', error);
                hideLoading();
                showNotification('error', t('error'), t('linkUserError') + ': ' + error.message);
            }
        });
        
        // تعديل صلاحيات المستخدم - النظام المتقدم
        async function editUserPermissions(uid, email, role, fullAccess) {
            try {
                const userDoc = await getDoc(doc(db, 'users', uid));
                const userData = userDoc.exists() ? userDoc.data() : {};
                document.getElementById('editUserUID').value = uid;
                document.getElementById('editUserEmail').value = email;
                document.getElementById('editUserRole').value = role || 'مستخدم';
                if (fullAccess) {
                    document.getElementById('editUserPermissionType').value = 'full';
                    document.getElementById('editPermissionDetails').style.display = 'none';
                } else if (userData.permissions) {
                    document.getElementById('editUserPermissionType').value = 'custom';
                    document.getElementById('editPermissionDetails').style.display = 'block';
                    populateAdvancedPermissions(userData.permissions);
                } else {
                    document.getElementById('editUserPermissionType').value = 'limited';
                    document.getElementById('editPermissionDetails').style.display = 'none';
                }
                openModal('editUserModal');
            } catch (error) {
                console.error('خطأ في تحميل بيانات المستخدم:', error);
                showNotification('error', t('error'), t('loadUserDataError'));
            }
        }
        
        // حفظ نموذج الصلاحيات المتقدمة
        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const uid = document.getElementById('editUserUID').value;
            const role = document.getElementById('editUserRole').value;
            const permissionType = document.getElementById('editUserPermissionType').value;
            try {
                showLoading();
                let fullAccess = false;
                let permissions = {};
                if (permissionType === 'full') {
                    fullAccess = true;
                } else if (permissionType === 'limited') {
                    fullAccess = false;
                    permissions = { months:{view:true,viewDetails:true}, projects:{view:true,viewAll:false,allowedProjects:[],viewDetails:true}, employees:{view:true,viewPersonal:true}, lockedFields:{view:false}, reports:{view:true}, users:{view:false}, settings:{view:false}, dashboard:{view:true,viewStatistics:true} };
                } else {
                    fullAccess = false;
                    permissions = gatherAdvancedPermissions();
                }
                await updateDoc(doc(db, 'users', uid), { role, fullAccess, permissions });
                hideLoading();
                closeModal('editUserModal');
                showNotification('success', t('success'), t('permissionsUpdatedSuccess'));
                if (currentView === 'users') { loadUsersData(); }
            } catch (error) {
                console.error('خطأ في تحديث الصلاحيات:', error);
                hideLoading();
                showNotification('error', t('error'), t('updatePermissionsError') + ': ' + error.message);
            }
        });

        // أدوات مساعدة لواجهة الصلاحيات المتقدمة
        function toggleEditPermissionDetails() { const type=document.getElementById('editUserPermissionType').value; const details=document.getElementById('editPermissionDetails'); details.style.display = type==='custom'?'block':'none'; }
        function toggleEditProjectsList() { 
            const viewAll = document.getElementById('edit_projects_viewAll').checked; 
            const c = document.getElementById('edit_specificProjectsContainer'); 
            if (c) {
                c.style.opacity = viewAll ? '0.5' : '1'; 
                c.style.pointerEvents = viewAll ? 'none' : 'auto'; 
            }
        }
        function selectAllEditPermissions(checked) { document.querySelectorAll('#editPermissionDetails input[type="checkbox"]').forEach(cb=>cb.checked=checked); }
        function selectViewOnlyEditPermissions() { selectAllEditPermissions(false); ['edit_months_view','edit_months_viewDetails','edit_projects_view','edit_projects_viewDetails','edit_employees_view','edit_employees_viewSalary','edit_employees_viewPersonal','edit_lockedFields_view','edit_reports_view','edit_reports_viewMonthly','edit_reports_viewProject','edit_users_view','edit_users_viewDetails','edit_settings_view','edit_dashboard_view','edit_dashboard_viewStatistics','edit_dashboard_viewCharts'].forEach(id=>{const el=document.getElementById(id); if(el) el.checked=true;}); }
        function populateAdvancedPermissions(permissions){ 
            if(!permissions)return; 
            const set=(p,o,s=[])=>{Object.keys(o||{}).forEach(k=>{if(s.includes(k))return;const el=document.getElementById(`${p}_${k}`); if(el) el.checked=o[k]===true;});}; 
            set('edit_months',permissions.months||{}); 
            set('edit_projects',permissions.projects||{},['allowedProjects']); 
            
            // ملء قائمة المشاريع المسموح بها من قاعدة البيانات
            const pc=document.getElementById('edit_allowedProjectsContainer'); 
            if(pc){ 
                pc.innerHTML=''; 
                // استخدام projects من قاعدة البيانات بدلاً من window.projects
                Object.entries(projects||{}).forEach(([k,n])=>{const allowed=permissions.projects&&permissions.projects.allowedProjects&&permissions.projects.allowedProjects.includes(k); pc.innerHTML+=`<label style="display:flex;align-items:center;gap:6px;font-size:12px;padding:8px;background:${allowed?'#dbeafe':'white'};border-radius:6px;border:1px solid #e2e8f0;"><input type=\"checkbox\" class=\"edit-allowed-project\" value=\"${k}\" ${allowed?'checked':''}> ${n}</label>`;}); 
            } 
            
            // ملء قائمة الأشهر المقفلة
            populateMonthLockOptions(permissions.months?.lockedMonths || []);
            
            // تعبئة صلاحيات الموظفين (العامة)
            set('edit_employees',permissions.employees||{});
            
            // تعبئة صلاحيات الموظفين حسب النوع
            if(permissions.employees && permissions.employees.monthly) {
                set('edit_employees_monthly', permissions.employees.monthly);
            }
            if(permissions.employees && permissions.employees.daily) {
                set('edit_employees_daily', permissions.employees.daily);
            }
            if(permissions.employees && permissions.employees.vehicle) {
                set('edit_employees_vehicle', permissions.employees.vehicle);
            } 
            set('edit_lockedFields',permissions.lockedFields||{}); 
            set('edit_reports',permissions.reports||{}); 
            set('edit_users',permissions.users||{}); 
            set('edit_settings',permissions.settings||{}); 
            set('edit_dashboard',permissions.dashboard||{}); 
        }

        function populateMonthLockOptions(lockedMonths = []) {
            const container = document.getElementById('monthLockContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            // إنشاء قائمة بالسنوات المتاحة
            const years = [currentYear, currentYear - 1, currentYear + 1];
            
            years.forEach(year => {
                months.forEach(month => {
                    const monthKey = `${year}-${month}`;
                    const monthName = t('monthNames')[month];
                    const isLocked = lockedMonths.includes(monthKey);
                    
                    const label = document.createElement('label');
                    label.style.cssText = 'display: flex; align-items: center; gap: 6px; font-size: 12px; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e2e8f0; cursor: pointer;';
                    
                    label.innerHTML = `
                        <input type="checkbox" class="month-lock-checkbox" value="${monthKey}" ${isLocked ? 'checked' : ''}>
                        <span>${monthName} ${year}</span>
                    `;
                    
                    container.appendChild(label);
                });
            });
        }
        function gatherAdvancedPermissions(){ 
            const get=id=>document.getElementById(id)?.checked||false; 
            const permissions={}; 
            
            // جمع قائمة الأشهر المقفلة
            const lockedMonths = [];
            document.querySelectorAll('.month-lock-checkbox:checked').forEach(cb => {
                lockedMonths.push(cb.value);
            });
            
            permissions.months={
                view:get('edit_months_view'),
                viewDetails:get('edit_months_viewDetails'),
                add:get('edit_months_add'),
                edit:get('edit_months_edit'),
                editSalary:get('edit_months_editSalary'),
                editBonus:get('edit_months_editBonus'),
                editDeductions:get('edit_months_editDeductions'),
                editAdvance:get('edit_months_editAdvance'),
                delete:get('edit_months_delete'),
                copy:get('edit_months_copy'),
                print:get('edit_months_print'),
                export:get('edit_months_export'),
                filter:get('edit_months_filter'),
                search:get('edit_months_search'),
                lockMonths:get('edit_months_lockMonths'),
                lockedMonths: lockedMonths
            }; 
            
            const allowed=[]; 
            document.querySelectorAll('.edit-allowed-project:checked').forEach(cb=>allowed.push(cb.value)); 
            
            permissions.projects={
                view:get('edit_projects_view'),
                viewAll:get('edit_projects_viewAll'),
                allowedProjects:allowed,
                viewDetails:get('edit_projects_viewDetails'),
                add:get('edit_projects_add'),
                edit:get('edit_projects_edit'),
                delete:get('edit_projects_delete'),
                print:get('edit_projects_print'),
                export:get('edit_projects_export')
            };
            
            // صلاحيات الموظفين حسب النوع
            permissions.employees={
                // الصلاحيات العامة
                view:get('edit_employees_view'),
                viewSalary:get('edit_employees_viewSalary'),
                viewPersonal:get('edit_employees_viewPersonal'),
                add:get('edit_employees_add'),
                edit:get('edit_employees_edit'),
                delete:get('edit_employees_delete'),
                
                // صلاحيات الموظفين الشهريين
                monthly: {
                    view: get('edit_employees_monthly_view') || get('edit_employees_view'),
                    add: get('edit_employees_monthly_add') || get('edit_employees_add'),
                    edit: get('edit_employees_monthly_edit') || get('edit_employees_edit'),
                    delete: get('edit_employees_monthly_delete') || get('edit_employees_delete'),
                    editSalary: get('edit_employees_monthly_editSalary') || get('edit_employees_editSalary') || false,
                    editBonus: get('edit_employees_monthly_editBonus') || get('edit_employees_editBonus') || false,
                    editDeductions: get('edit_employees_monthly_editDeductions') || get('edit_employees_editDeductions') || false,
                    editAdvance: get('edit_employees_monthly_editAdvance') || get('edit_employees_editAdvance') || false
                },
                
                // صلاحيات الموظفين اليوميين
                daily: {
                    view: get('edit_employees_daily_view') || get('edit_employees_view'),
                    add: get('edit_employees_daily_add') || get('edit_employees_add'),
                    edit: get('edit_employees_daily_edit') || get('edit_employees_edit'),
                    delete: get('edit_employees_daily_delete') || get('edit_employees_delete'),
                    editSalary: get('edit_employees_daily_editSalary') || get('edit_employees_editSalary') || false,
                    editBonus: get('edit_employees_daily_editBonus') || get('edit_employees_editBonus') || false,
                    editDeductions: get('edit_employees_daily_editDeductions') || get('edit_employees_editDeductions') || false,
                    editAdvance: get('edit_employees_daily_editAdvance') || get('edit_employees_editAdvance') || false
                },
                
                // صلاحيات موظفي المركبات
                vehicle: {
                    view: get('edit_employees_vehicle_view') || get('edit_employees_view'),
                    add: get('edit_employees_vehicle_add') || get('edit_employees_add'),
                    edit: get('edit_employees_vehicle_edit') || get('edit_employees_edit'),
                    delete: get('edit_employees_vehicle_delete') || get('edit_employees_process'),
                    editSalary: get('edit_employees_vehicle_editSalary') || get('edit_employees_editSalary') || false,
                    editBonus: get('edit_employees_vehicle_editBonus') || get('edit_employees_editBonus') || false,
                    editDeductions: get('edit_employees_vehicle_editDeductions') || get('edit_employees_editDeductions') || false,
                    editAdvance: get('edit_employees_vehicle_editAdvance') || get('edit_employees_editAdvance') || false
                }
            }; 
            
            permissions.lockedFields={
                view:get('edit_lockedFields_view'),
                edit:get('edit_lockedFields_edit'),
                unlock:get('edit_lockedFields_unlock'),
                editSalaryIncrease:get('edit_lockedFields_editSalaryIncrease'),
                editCEOBonus:get('edit_lockedFields_editCEOBonus')
            }; 
            
            permissions.reports={
                view:get('edit_reports_view'),
                viewMonthly:get('edit_reports_viewMonthly'),
                viewProject:get('edit_reports_viewProject'),
                viewEmployee:get('edit_reports_viewEmployee'),
                viewFinancial:get('edit_reports_viewFinancial'),
                print:get('edit_reports_print'),
                printPreview:get('edit_reports_printPreview'),
                export:get('edit_reports_export'),
                exportPDF:get('edit_reports_exportPDF'),
                exportExcel:get('edit_reports_exportExcel')
            }; 
            
            permissions.users={
                view:get('edit_users_view'),
                viewDetails:get('edit_users_viewDetails'),
                add:get('edit_users_add'),
                edit:get('edit_users_edit'),
                editPermissions:get('edit_users_editPermissions'),
                editRole:get('edit_users_editRole'),
                delete:get('edit_users_delete'),
                viewActivity:get('edit_users_viewActivity')
            }; 
            
            permissions.settings={
                view:get('edit_settings_view'),
                editGeneral:get('edit_settings_editGeneral'),
                editProjects:get('edit_settings_editProjects'),
                editSignatures:get('edit_settings_editSignatures'),
                editAppearance:get('edit_settings_editAppearance'),
                editLanguage:get('edit_settings_editLanguage'),
                editBackup:get('edit_settings_editBackup'),
                viewLogs:get('edit_settings_viewLogs')
            }; 
            
            permissions.dashboard={
                view:get('edit_dashboard_view'),
                viewStatistics:get('edit_dashboard_viewStatistics'),
                viewCharts:get('edit_dashboard_viewCharts'),
                viewRecentActivity:get('edit_dashboard_viewRecentActivity'),
                viewFinancialSummary:get('edit_dashboard_viewFinancialSummary')
            }; 
            
            return permissions; 
        }
        
        // حذف صلاحيات المستخدم (لا يحذف من Authentication)
        async function deleteUserPermissions(uid, email) {
            if (!confirm(`هل أنت متأكد من حذف صلاحيات المستخدم: ${email}?\n\nملاحظة: سيتم حذف الصلاحيات من النظام فقط، الحساب في Firebase Authentication سيبقى موجوداً.`)) {
                return;
            }
            
            try {
                showLoading();
                await deleteDoc(doc(db, 'users', uid));
                hideLoading();
                showNotification('success', 'نجح', 'تم حذف صلاحيات المستخدم من النظام');
                
                // تحديث القائمة
                if (currentView === 'users') {
                    loadUsersData();
                }
                
            } catch (error) {
                console.error('خطأ في حذف الصلاحيات:', error);
                hideLoading();
                showNotification('error', 'خطأ', 'فشل حذف الصلاحيات: ' + error.message);
            }
        }

        // ========== Settings View ==========
        // دالة لعرض إعدادات قاعدة البيانات
        function renderDatabaseSettings() {
            const currentDbType = getDbType();
            const supabaseConfig = getSupabaseConfig();
            const isSupabaseConfigured = supabaseConfig && supabaseConfig.url && supabaseConfig.anonKey;
            
            let html = `
                <!-- نوع قاعدة البيانات الحالي -->
                <div style="margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, ${currentDbType === 'supabase' ? '#4f46e5' : '#ff6b6b'} 0%, ${currentDbType === 'supabase' ? '#7c3aed' : '#ee5a6f'} 100%); border-radius: 12px; color: white;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin: 0 0 5px 0; font-size: 18px; font-weight: 700;">
                                ${currentDbType === 'supabase' ? '⚡ Supabase' : '🔥 Firebase'}
                            </h4>
                            <p style="margin: 0; opacity: 0.9; font-size: 13px;">
                                ${currentDbType === 'supabase' 
                                    ? (currentLang === 'ar' ? 'قاعدة البيانات الحالية: Supabase' : 'Current Database: Supabase')
                                    : (currentLang === 'ar' ? 'قاعدة البيانات الحالية: Firebase' : 'Current Database: Firebase')}
                            </p>
                        </div>
                        <div style="font-size: 48px; opacity: 0.8;">
                            ${currentDbType === 'supabase' ? '⚡' : '🔥'}
                        </div>
                    </div>
                </div>

                <!-- التبديل بين قواعد البيانات -->
                <div style="margin-bottom: 30px;">
                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 15px; display: block;">
                        🔄 نوع قاعدة البيانات:
                    </label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="padding: 20px; border: 2px solid ${currentDbType === 'firebase' ? 'var(--primary)' : '#e5e7eb'}; border-radius: 12px; background: ${currentDbType === 'firebase' ? '#f0f9ff' : '#fff'}; cursor: pointer; transition: all 0.3s;" 
                             onclick="switchDatabaseType('firebase')"
                             onmouseover="this.style.borderColor='var(--primary)'; this.style.background='#f0f9ff';"
                             onmouseout="const dbType='${currentDbType}'; this.style.borderColor=dbType==='firebase'?'var(--primary)':'#e5e7eb'; this.style.background=dbType==='firebase'?'#f0f9ff':'#fff';">
                            <div style="text-align: center;">
                                <div style="font-size: 36px; margin-bottom: 10px;">🔥</div>
                                <div style="font-weight: 700; font-size: 16px; color: var(--primary); margin-bottom: 5px;">Firebase</div>
                                <div style="font-size: 12px; color: var(--gray);">${currentLang === 'ar' ? 'قاعدة البيانات الافتراضية' : 'Default Database'}</div>
                                ${currentDbType === 'firebase' ? `<div style="margin-top: 10px; color: var(--primary); font-weight: 600;">✓ ${currentLang === 'ar' ? 'مفعل' : 'Active'}</div>` : ''}
                            </div>
                        </div>
                        <div style="padding: 20px; border: 2px solid ${currentDbType === 'supabase' ? 'var(--primary)' : '#e5e7eb'}; border-radius: 12px; background: ${currentDbType === 'supabase' ? '#f0f9ff' : '#fff'}; cursor: pointer; transition: all 0.3s;" 
                             onclick="switchDatabaseType('supabase')"
                             onmouseover="this.style.borderColor='var(--primary)'; this.style.background='#f0f9ff';"
                             onmouseout="const dbType='${currentDbType}'; this.style.borderColor=dbType==='supabase'?'var(--primary)':'#e5e7eb'; this.style.background=dbType==='supabase'?'#f0f9ff':'#fff';">
                            <div style="text-align: center;">
                                <div style="font-size: 36px; margin-bottom: 10px;">⚡</div>
                                <div style="font-weight: 700; font-size: 16px; color: var(--primary); margin-bottom: 5px;">Supabase</div>
                                <div style="font-size: 12px; color: var(--gray);">${currentLang === 'ar' ? 'قاعدة بيانات متقدمة' : 'Advanced Database'}</div>
                                ${currentDbType === 'supabase' ? `<div style="margin-top: 10px; color: var(--primary); font-weight: 600;">✓ ${currentLang === 'ar' ? 'مفعل' : 'Active'}</div>` : ''}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- إعدادات Supabase -->
                <div id="supabaseSettingsSection" style="margin-bottom: 30px; padding: 20px; background: #f9fafb; border-radius: 12px; border: 2px solid #e5e7eb; ${currentDbType === 'supabase' || !isSupabaseConfigured ? '' : 'display: none;'}">
                    <h4 style="color: var(--primary); margin: 0 0 20px 0; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                        <span>⚡</span> ${currentLang === 'ar' ? 'إعدادات Supabase' : 'Supabase Settings'}
                    </h4>
                    
                    ${!isSupabaseConfigured ? `
                    <div style="padding: 15px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: start; gap: 10px;">
                            <span style="font-size: 20px;">⚠️</span>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">${currentLang === 'ar' ? 'Supabase غير مهيأ' : 'Supabase Not Configured'}</div>
                                <div style="font-size: 13px; color: #92400e;">
                                    ${currentLang === 'ar' 
                                        ? 'يرجى إدخال إعدادات Supabase للتبديل إلى هذه القاعدة. يمكنك الحصول على هذه الإعدادات من Supabase Dashboard.'
                                        : 'Please enter Supabase settings to switch to this database. You can get these settings from Supabase Dashboard.'}
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : `
                    <div style="padding: 15px; background: #d1fae5; border: 1px solid #10b981; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: start; gap: 10px;">
                            <span style="font-size: 20px;">✅</span>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">${currentLang === 'ar' ? 'Supabase مهيأ' : 'Supabase Configured'}</div>
                                <div style="font-size: 13px; color: #065f46;">
                                    ${currentLang === 'ar' 
                                        ? 'Supabase جاهز للاستخدام. يمكنك التبديل إليه من الأعلى.'
                                        : 'Supabase is ready to use. You can switch to it from above.'}
                                </div>
                            </div>
                        </div>
                    </div>
                    `}
                    
                    <div style="margin-bottom: 20px;">
                        <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">
                            🔗 Supabase URL:
                        </label>
                        <input 
                            type="text" 
                            id="supabaseUrl" 
                            value="${supabaseConfig?.url || ''}" 
                            placeholder="https://your-project.supabase.co"
                            style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;"
                        >
                        <p style="font-size: 12px; color: var(--gray); margin-top: 5px;">
                            ${currentLang === 'ar' ? 'يمكنك العثور على هذا في Supabase Dashboard > Settings > API' : 'You can find this in Supabase Dashboard > Settings > API'}
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">
                            🔑 Supabase Anon Key:
                        </label>
                        <input 
                            type="password" 
                            id="supabaseAnonKey" 
                            value="${supabaseConfig?.anonKey || ''}" 
                            placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                            style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px; font-family: monospace;"
                        >
                        <p style="font-size: 12px; color: var(--gray); margin-top: 5px;">
                            ${currentLang === 'ar' ? 'يمكنك العثور على هذا في Supabase Dashboard > Settings > API' : 'You can find this in Supabase Dashboard > Settings > API'}
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="saveSupabaseConfig()" style="flex: 1;">
                            💾 ${currentLang === 'ar' ? 'حفظ الإعدادات' : 'Save Settings'}
                        </button>
                        ${isSupabaseConfigured ? `
                        <button class="btn btn-danger" onclick="testSupabaseConnection()" style="flex: 1;">
                            🔍 ${currentLang === 'ar' ? 'اختبار الاتصال' : 'Test Connection'}
                        </button>
                        ` : ''}
                    </div>
                </div>

                <!-- معلومات إضافية -->
                <div style="padding: 15px; background: #f0f9ff; border-radius: 8px; border: 1px solid #bfdbfe;">
                    <div style="font-size: 13px; color: #1e40af;">
                        <div style="font-weight: 600; margin-bottom: 8px;">ℹ️ ${currentLang === 'ar' ? 'معلومات مهمة:' : 'Important Information:'}</div>
                        <ul style="margin: 0; padding-right: 20px; line-height: 1.8;">
                            <li>${currentLang === 'ar' ? 'Firebase هو الافتراضي ويعمل تلقائياً' : 'Firebase is default and works automatically'}</li>
                            <li>${currentLang === 'ar' ? 'للاستخدام مع Supabase، يجب إعداد الجداول أولاً' : 'To use Supabase, tables must be set up first'}</li>
                            <li>${currentLang === 'ar' ? 'يمكنك استخدام وظيفة "نقل إلى Supabase" لنقل البيانات' : 'You can use "Migrate to Supabase" function to transfer data'}</li>
                            <li>${currentLang === 'ar' ? 'سجل التعديلات سيتم حفظه في قاعدة البيانات المحددة' : 'Activity logs will be saved to the selected database'}</li>
                        </ul>
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderSettingsView() {
            const content = document.getElementById('mainContent');
            
            // استخدام الإعدادات المحملة من Firebase
            const companyNameAr = companySettings.companyNameAr || '';
            const companyNameEn = companySettings.companyNameEn || 'ROSEMARY COMPANY';
            const companyLogo = companySettings.companyLogo || '';
            const canEditDbSettings = canManageDatabaseSettings();
            const currentDbConfig = getActiveDatabaseConfig();
            const usingCustomDbConfig = isCustomDatabaseConfig();
            
            let html = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: var(--primary); font-size: 32px; margin-bottom: 10px;">⚙️ ${t('settingsTitle')}</h2>
                    <p style="color: var(--gray); font-size: 16px;">${t('settingsDescription')}</p>
                </div>
                
                <!-- بطاقة معلومات الشركة -->
                <div style="max-width: 900px; margin: 0 auto;">
                    <div class="card" style="margin-bottom: 30px;">
                        <div class="card-header">
                            <h3>🏢 ${t('companyInfo')}</h3>
                            <p style="font-size: 13px; color: rgba(255,255,255,0.9); margin-top: 5px;">
                                ${t('companyInfoDescription')}
                            </p>
                        </div>
                        <div class="card-body" style="padding: 30px;">
                            <!-- لوغو الشركة -->
                            <div style="margin-bottom: 30px;">
                                <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                                    🎨 ${t('companyLogo')}:
                                </label>
                                <div style="display: flex; gap: 20px; align-items: center;">
                                    <div id="logoPreview" style="width: 150px; height: 150px; border: 3px dashed var(--border); border-radius: 12px; display: flex; align-items: center; justify-content: center; background: #f9fafb; overflow: hidden;">
                                        ${companyLogo ? `<img src="${companyLogo}" style="max-width: 100%; max-height: 100%; object-fit: contain;">` : `<span style="color: var(--gray); font-size: 14px;">${t('noLogo')}</span>`}
                                    </div>
                                    <div style="flex: 1;">
                                        <input type="file" id="logoUpload" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                                        <button class="btn btn-primary" onclick="document.getElementById('logoUpload').click()">
                                            📤 ${t('uploadNewLogo')}
                                        </button>
                                        ${companyLogo ? `
                                        <button class="btn btn-danger" onclick="removeCompanyLogo()" style="margin-right: 10px;">
                                            🗑️ ${t('deleteLogo')}
                                        </button>
                                        ` : ''}
                                        <p style="font-size: 12px; color: var(--gray); margin-top: 10px;">
                                            📝 ${t('logoRecommendation')}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- اسم الشركة بالعربية -->
                            <div style="margin-bottom: 25px;">
                                <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                                    🏷️ ${t('companyNameAr')}:
                                </label>
                                <input 
                                    type="text" 
                                    id="companyNameAr" 
                                    value="${companyNameAr}" 
                                    placeholder="مثال: شركة الورد للاستشارات"
                                    style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;"
                                >
                            </div>
                            
                            <!-- اسم الشركة بالإنجليزية -->
                            <div style="margin-bottom: 25px;">
                                <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                                    🏷️ ${t('companyNameEn')}:
                                </label>
                                <input 
                                    type="text" 
                                    id="companyNameEn" 
                                    value="${companyNameEn}" 
                                    placeholder="Example: ROSEMARY COMPANY"
                                    style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;"
                                >
                            </div>
                            
                            <!-- عنوان الشركة -->
                            <div style="margin-bottom: 20px;">
                                <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">
                                    🏢 ${t('companyAddress')}:
                                </label>
                                <input 
                                    type="text" 
                                    id="companyAddress" 
                                    value="${companySettings.companyAddress || ''}" 
                                    placeholder="مثال: بغداد - العراق"
                                    style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;"
                                >
                            </div>
                            
                            <!-- هاتف الشركة -->
                            <div style="margin-bottom: 20px;">
                                <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">
                                    📞 ${t('companyPhone')}:
                                </label>
                                <input 
                                    type="text" 
                                    id="companyPhone" 
                                    value="${companySettings.companyPhone || ''}" 
                                    placeholder="مثال: +964 1 234 5678"
                                    style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;"
                                >
                            </div>
                            
                            <!-- إيميل الشركة -->
                            <div style="margin-bottom: 20px;">
                                <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">
                                    📧 ${t('companyEmail')}:
                                </label>
                                <input 
                                    type="email" 
                                    id="companyEmail" 
                                    value="${companySettings.companyEmail || ''}" 
                                    placeholder="مثال: info@company.com"
                                    style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;"
                                >
                            </div>
                            
                            <!-- زر الحفظ -->
                            <div style="text-align: center; margin-top: 30px;">
                                <button class="btn btn-success" onclick="handleSaveCompanySettings()" style="padding: 12px 40px; font-size: 16px; font-weight: 600;">
                                    💾 ${t('saveSettings')}
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- بطاقة إعدادات قاعدة البيانات -->
                    <div class="card" style="margin-bottom: 30px;">
                        <div class="card-header">
                            <h3>🗄️ إعدادات قاعدة البيانات</h3>
                            <p style="font-size: 13px; color: rgba(255,255,255,0.9); margin-top: 5px;">
                                التبديل بين Firebase و Supabase وإدارة إعدادات الاتصال
                            </p>
                        </div>
                        <div class="card-body" style="padding: 30px;">
                            ${renderDatabaseSettings()}
                        </div>
                    </div>

                    <!-- بطاقة إعدادات الحجز العامة -->
                    <div class="card" style="margin-bottom: 30px;">
                        <div class="card-header">
                            <h3>💰 إعدادات الحجز العامة</h3>
                            <p style="font-size: 13px; color: rgba(255,255,255,0.9); margin-top: 5px;">
                                تفعيل الحجز لجميع الموظفين وتحديد النسبة أو المبلغ
                            </p>
                        </div>
                        <div class="card-body" style="padding: 30px;">
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="globalReservationEnabled" ${companySettings.globalReservationEnabled ? 'checked' : ''} style="width: 20px; height: 20px; cursor: pointer;" onchange="toggleGlobalReservationSettings()">
                                    <span>تفعيل الحجز لجميع الموظفين</span>
                                </label>
                            </div>
                            
                            <div id="globalReservationSettings" style="display: ${companySettings.globalReservationEnabled ? 'block' : 'none'};">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">
                                            طريقة الحجز:
                                        </label>
                                        <select id="globalReservationType" class="form-control" onchange="toggleGlobalReservationInputs()" style="padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;">
                                            <option value="percentage" ${companySettings.globalReservationType === 'percentage' ? 'selected' : ''}>نسبة مئوية (%)</option>
                                            <option value="amount" ${companySettings.globalReservationType === 'amount' ? 'selected' : ''}>مبلغ ثابت</option>
                                        </select>
                                    </div>
                                    
                                    <div id="globalReservationPercentageContainer" style="display: ${companySettings.globalReservationType === 'percentage' ? 'block' : 'none'};">
                                        <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">
                                            نسبة الحجز (%):
                                        </label>
                                        <input 
                                            type="number" 
                                            id="globalReservationPercentage" 
                                            value="${companySettings.globalReservationPercentage || 10}" 
                                            min="0" 
                                            max="100" 
                                            step="0.1"
                                            style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;"
                                        >
                                    </div>
                                    
                                    <div id="globalReservationAmountContainer" style="display: ${companySettings.globalReservationType === 'amount' ? 'block' : 'none'};">
                                        <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">
                                            مبلغ الحجز:
                                        </label>
                                        <input 
                                            type="number" 
                                            id="globalReservationAmount" 
                                            value="${companySettings.globalReservationAmount || 0}" 
                                            min="0" 
                                            step="0.01"
                                            style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;"
                                        >
                                    </div>
                                </div>
                                
                                <div style="background: #f0f9ff; border: 2px solid #3b82f6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                    <p style="font-size: 13px; color: #1e40af; margin: 0; line-height: 1.6;">
                                        <strong>💡 ملاحظة:</strong> عند تفعيل الحجز، سيتم تطبيقه تلقائياً على جميع الموظفين عند حفظ بياناتهم.
                                        <br>الحجز التراكمي لا يتجاوز الراتب الأساسي للموظف.
                                    </p>
                                </div>
                            </div>
                            
                            <div style="text-align: center; margin-top: 20px;">
                                <button class="btn btn-success" onclick="handleSaveGlobalReservationSettings()" style="padding: 12px 40px; font-size: 16px; font-weight: 600;">
                                    💾 حفظ إعدادات الحجز
                                </button>
                            </div>
                            
                            <div style="margin-top: 30px; padding: 20px; background: #fef2f2; border: 2px solid #fecaca; border-radius: 12px;">
                                <h4 style="color: #b91c1c; margin: 0 0 15px 0; font-size: 16px; font-weight: 700;">
                                    ⚠️ منطقة خطرة - تصفير الحجوزات
                                </h4>
                                <p style="color: #7f1d1d; margin: 0 0 15px 0; line-height: 1.8; font-size: 14px;">
                                    <strong>تحذير:</strong> هذا الإجراء سيقوم بتصفير جميع الحجوزات في جميع الأشهر لجميع الموظفين.
                                    <br>سيتم تصفير:
                                    <br>• <strong>reservedAmount</strong> (المبلغ المحجوز) في جميع الأشهر
                                    <br>• <strong>previousReservedAmount</strong> (الرصيد السابق) لجميع الموظفين
                                    <br><br>
                                    <strong>💡 استخدام:</strong> استخدم هذا الزر إذا أردت إعادة تعيين جميع الحجوزات وإدخال البيانات الفعلية من جديد.
                                </p>
                                <div style="text-align: center;">
                                    <button 
                                        class="btn" 
                                        onclick="resetAllReservations()" 
                                        style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); 
                                               border: none; 
                                               color: white; 
                                               padding: 15px 40px; 
                                               font-size: 18px; 
                                               font-weight: 700;
                                               box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
                                               transition: all 0.3s;"
                                        onmouseover="this.style.transform='scale(1.05)'"
                                        onmouseout="this.style.transform='scale(1)'">
                                        🔄 تصفير جميع الحجوزات
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- بطاقة معاينة -->
                    <div class="card">
                        <div class="card-header">
                            <h3>👁️ معاينة في التقارير</h3>
                            <p style="font-size: 13px; color: rgba(255,255,255,0.9); margin-top: 5px;">
                                هكذا ستظهر معلومات الشركة في التقارير المطبوعة
                            </p>
                        </div>
                        <div class="card-body">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 12px; text-align: center; -webkit-print-color-adjust: exact; print-color-adjust: exact;">
                                ${companyLogo ? `
                                <div style="margin-bottom: 15px;">
                                    <img src="${companyLogo}" style="max-width: 100px; max-height: 100px; object-fit: contain;">
                                </div>
                                ` : ''}
                                <h2 style="color: white; margin: 10px 0; font-size: 20px; font-weight: bold;">
                                    ${companyNameEn || 'ROSEMARY COMPANY'}
                                </h2>
                                ${companyNameAr ? `
                                <h3 style="color: rgba(255,255,255,0.95); margin: 5px 0; font-size: 16px;">
                                    ${companyNameAr}
                                </h3>
                                ` : ''}
                                <h1 style="color: white; margin: 15px 0; font-size: 22px;">
                                    📊 تقرير الرواتب الشهري
                                </h1>
                                ${companySettings.companyAddress ? `
                                <p style="color: rgba(255,255,255,0.9); margin: 10px 0; font-size: 14px;">
                                    📍 ${companySettings.companyAddress}
                                </p>
                                ` : ''}
                                ${companySettings.companyPhone ? `
                                <p style="color: rgba(255,255,255,0.9); margin: 5px 0; font-size: 14px;">
                                    📞 ${companySettings.companyPhone}
                                </p>
                                ` : ''}
                                ${companySettings.companyEmail ? `
                                <p style="color: rgba(255,255,255,0.9); margin: 5px 0; font-size: 14px;">
                                    📧 ${companySettings.companyEmail}
                                </p>
                                ` : ''}
                            </div>
                            <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; text-align: center;">
                                <p style="font-size: 11px; color: #1e40af; font-weight: 500;">
                                    ✨ Powered by ROSEMARY
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- بطاقة التوقيعات -->
                    <div class="card">
                        <div class="card-header">
                            <h3>✍️ إعدادات التوقيعات</h3>
                            <p style="font-size: 13px; color: rgba(255,255,255,0.9); margin-top: 5px;">
                                إعداد التوقيعات التي ستظهر في التقارير المطبوعة
                            </p>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <!-- التوقيع الأول -->
                                <div>
                                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">
                                        التوقيع الأول:
                                    </label>
                                    <input 
                                        type="text" 
                                        id="signature1Position" 
                                        value="${printSignatures.sig1Position || ''}" 
                                        placeholder="مثال: المدير العام"
                                        style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px; margin-bottom: 10px;"
                                    >
                                    <input 
                                        type="text" 
                                        id="signature1Name" 
                                        value="${printSignatures.sig1Name || ''}" 
                                        placeholder="اسم الموقع"
                                        style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;"
                                    >
                                </div>
                                
                                <!-- التوقيع الثاني -->
                                <div>
                                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">
                                        التوقيع الثاني:
                                    </label>
                                    <input 
                                        type="text" 
                                        id="signature2Position" 
                                        value="${printSignatures.sig2Position || ''}" 
                                        placeholder="مثال: مدير الموارد البشرية"
                                        style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px; margin-bottom: 10px;"
                                    >
                                    <input 
                                        type="text" 
                                        id="signature2Name" 
                                        value="${printSignatures.sig2Name || ''}" 
                                        placeholder="اسم الموقع"
                                        style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;"
                                    >
                                </div>
                                
                                <!-- التوقيع الثالث -->
                                <div>
                                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">
                                        التوقيع الثالث:
                                    </label>
                                    <input 
                                        type="text" 
                                        id="signature3Position" 
                                        value="${printSignatures.sig3Position || ''}" 
                                        placeholder="مثال: المحاسب"
                                        style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px; margin-bottom: 10px;"
                                    >
                                    <input 
                                        type="text" 
                                        id="signature3Name" 
                                        value="${printSignatures.sig3Name || ''}" 
                                        placeholder="اسم الموقع"
                                        style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;"
                                    >
                                </div>
                                
                                <!-- التوقيع الرابع -->
                                <div>
                                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">
                                        التوقيع الرابع:
                                    </label>
                                    <input 
                                        type="text" 
                                        id="signature4Position" 
                                        value="${printSignatures.sig4Position || ''}" 
                                        placeholder="مثال: المراجع"
                                        style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px; margin-bottom: 10px;"
                                    >
                                    <input 
                                        type="text" 
                                        id="signature4Name" 
                                        value="${printSignatures.sig4Name || ''}" 
                                        placeholder="اسم الموقع"
                                        style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;"
                                    >
                                </div>
                            </div>
                            
                            <!-- زر حفظ التوقيعات -->
                            <div style="text-align: center; margin-top: 20px;">
                                <button class="btn btn-primary" onclick="saveSignatures()" style="padding: 12px 30px; font-size: 16px; font-weight: 600;">
                                    💾 حفظ التوقيعات
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- بطاقة إدارة المصطلحات -->
                    <div class="card" style="margin-bottom: 30px;">
                        <div class="card-header">
                            <h3>📚 إدارة المصطلحات والترجمات</h3>
                            <p style="font-size: 13px; color: rgba(255,255,255,0.9); margin-top: 5px;">
                                تخصيص المصطلحات المستخدمة في النظام. اترك الحقل فارغاً للاحتفاظ بالنص الافتراضي
                            </p>
                        </div>
                        <div class="card-body" style="padding: 30px;">
                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                                    <input type="text" id="termSearch" placeholder="🔍 بحث عن مصطلح..." 
                                        style="flex: 1; min-width: 250px; padding: 10px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px;"
                                        onkeyup="filterTermsTable(this.value)">
                                    <button class="btn btn-success" onclick="saveCustomTerms()" style="padding: 10px 25px; font-weight: 600;">
                                        💾 حفظ جميع التغييرات
                                    </button>
                                    <button class="btn" style="background: rgba(239,68,68,0.15); color: #dc2626; padding: 10px 20px; font-weight: 600;" onclick="resetCustomTerms()">
                                        ↺ إعادة تعيين الكل
                                    </button>
                                </div>
                            </div>
                            
                            <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
                                <table id="termsTable" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                    <thead style="position: sticky; top: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; z-index: 10;">
                                        <tr>
                                            <th style="padding: 12px; text-align: right; border: 1px solid rgba(255,255,255,0.2); font-weight: 600;">🔑 المفتاح</th>
                                            <th style="padding: 12px; text-align: right; border: 1px solid rgba(255,255,255,0.2); font-weight: 600; background: rgba(59,130,246,0.3);">📝 الافتراضي (عربي)</th>
                                            <th style="padding: 12px; text-align: right; border: 1px solid rgba(255,255,255,0.2); font-weight: 600; background: rgba(59,130,246,0.3);">📝 الافتراضي (English)</th>
                                            <th style="padding: 12px; text-align: right; border: 1px solid rgba(255,255,255,0.2); font-weight: 600; background: rgba(16,185,129,0.2);">✏️ المخصص (عربي)</th>
                                            <th style="padding: 12px; text-align: right; border: 1px solid rgba(255,255,255,0.2); font-weight: 600; background: rgba(16,185,129,0.2);">✏️ المخصص (English)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="termsTableBody" style="background: white;">
                                        <!-- سيتم ملؤها من JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-right: 4px solid #3b82f6;">
                                <p style="font-size: 12px; color: #1e40af; margin: 0; line-height: 1.6;">
                                    <strong>💡 ملاحظة:</strong> عند ترك حقل "المخصص" فارغاً، سيتم استخدام النص الافتراضي تلقائياً. 
                                    التغييرات لا تُطبق حتى تضغط على "حفظ جميع التغييرات".
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- بطاقة إعدادات قاعدة البيانات -->
                    <div class="card">
                        <div class="card-header">
                            <h3>🗃️ إعدادات قاعدة البيانات</h3>
                            <p style="font-size: 13px; color: rgba(255,255,255,0.9); margin-top: 5px;">
                                اختر وضع التخزين: Firebase (سحابي) أو Local (محلي بدون إنترنت)
                            </p>
                        </div>
                        <div class="card-body" style="padding: 30px;">
                            <!-- وضع التخزين -->
                            <div style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                                <div style="font-weight: 600; margin-bottom: 15px; color: #1e3a8a; font-size: 15px;">
                                    💾 وضع التخزين الحالي
                                </div>
                                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px 20px; background: white; border-radius: 8px; border: 2px solid #3b82f6; flex: 1; min-width: 200px;">
                                        <input type="radio" name="storageMode" value="firebase" ${getStorageMode() === 'firebase' ? 'checked' : ''} onchange="switchStorageMode('firebase')" style="width: 18px; height: 18px; cursor: pointer;">
                                        <div>
                                            <div style="font-weight: 600; color: #1e3a8a;">☁️ Firebase (سحابي)</div>
                                            <div style="font-size: 12px; color: #64748b;">يتطلب اتصال بالإنترنت</div>
                                        </div>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px 20px; background: white; border-radius: 8px; border: 2px solid #10b981; flex: 1; min-width: 200px;">
                                        <input type="radio" name="storageMode" value="local" ${getStorageMode() === 'local' ? 'checked' : ''} onchange="switchStorageMode('local')" style="width: 18px; height: 18px; cursor: pointer;">
                                        <div>
                                            <div style="font-weight: 600; color: #065f46;">💾 Local (محلي)</div>
                                            <div style="font-size: 12px; color: #64748b;">يعمل بدون إنترنت</div>
                                        </div>
                                    </label>
                                </div>
                                <div style="margin-top: 15px; padding: 12px; background: #fef3c7; border-radius: 8px; font-size: 12px; color: #92400e;">
                                    <strong>⚠️ تحذير:</strong> عند التبديل بين الأوضاع، سيتم استخدام البيانات المحفوظة في الوضع المختار. تأكد من عمل نسخة احتياطية قبل التبديل.
                                </div>
                            </div>
                            
                            ${getStorageMode() === 'firebase' ? `
                            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-bottom: 20px; font-size: 13px;">
                                <div style="font-weight: 600; margin-bottom: 12px; color: #1e3a8a;">🔎 الإعداد الحالي</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 20px;">
                                <span style="font-weight: 600; color: ${usingCustomDbConfig ? '#047857' : '#64748b'};">
                                    ${usingCustomDbConfig ? '🔄 يتم استخدام إعدادات مخصصة محفوظة محلياً' : '✅ يتم استخدام الإعداد الافتراضي المضمّن'}
                                </span>
                                ${canEditDbSettings ? `
                                <button class="btn" style="background: linear-gradient(135deg, #f97316 0%, #fb923c 100%); border: none; color: white; padding: 8px 18px; font-weight: 600;"
                                    onclick="resetDatabaseConfig()" ${usingCustomDbConfig ? '' : 'disabled title="لا توجد إعدادات مخصصة"'}>
                                    ↺ العودة للإعداد الافتراضي
                                </button>
                                ` : ''}
                            </div>
                            ${!canEditDbSettings ? `
                            <div style="background: #fef2f2; border: 1px solid #fecaca; padding: 15px; border-radius: 8px; color: #b91c1c; margin-bottom: 20px;">
                                ⚠️ ليس لديك صلاحية لتعديل إعدادات قاعدة البيانات. تواصل مع المسؤول.
                            </div>
                            ` : ''}
                            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-bottom: 20px; font-size: 13px;">
                                <div style="font-weight: 600; margin-bottom: 12px; color: #1e3a8a;">🔎 الإعداد الحالي</div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;">
                                    <div><strong>Project ID:</strong> <span dir="ltr">${sanitizeHTML(currentDbConfig.projectId || '-')}</span></div>
                                    <div><strong>Auth Domain:</strong> <span dir="ltr">${sanitizeHTML(currentDbConfig.authDomain || '-')}</span></div>
                                    <div><strong>API Key:</strong> <span dir="ltr">${sanitizeHTML(currentDbConfig.apiKey || '-')}</span></div>
                                    <div><strong>Storage Bucket:</strong> <span dir="ltr">${sanitizeHTML(currentDbConfig.storageBucket || '-')}</span></div>
                                    <div><strong>Messaging Sender ID:</strong> <span dir="ltr">${sanitizeHTML(currentDbConfig.messagingSenderId || '-')}</span></div>
                                    <div><strong>App ID:</strong> <span dir="ltr">${sanitizeHTML(currentDbConfig.appId || '-')}</span></div>
                                    <div><strong>Measurement ID:</strong> <span dir="ltr">${sanitizeHTML(currentDbConfig.measurementId || '-')}</span></div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px;">
                                <div>
                                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">Project ID</label>
                                    <input type="text" id="dbProjectId" data-label="Project ID" value="${sanitizeHTML(currentDbConfig.projectId || '')}" ${canEditDbSettings ? '' : 'disabled'}
                                        style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px; direction: ltr; text-transform: none;">
                                </div>
                                <div>
                                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">API Key</label>
                                    <input type="text" id="dbApiKey" data-label="API Key" value="${sanitizeHTML(currentDbConfig.apiKey || '')}" ${canEditDbSettings ? '' : 'disabled'}
                                        style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px; direction: ltr; text-transform: none;">
                                </div>
                                <div>
                                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">Auth Domain</label>
                                    <input type="text" id="dbAuthDomain" data-label="Auth Domain" value="${sanitizeHTML(currentDbConfig.authDomain || '')}" ${canEditDbSettings ? '' : 'disabled'}
                                        style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px; direction: ltr; text-transform: none;">
                                </div>
                                <div>
                                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">Storage Bucket</label>
                                    <input type="text" id="dbStorageBucket" data-label="Storage Bucket" value="${sanitizeHTML(currentDbConfig.storageBucket || '')}" ${canEditDbSettings ? '' : 'disabled'}
                                        style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px; direction: ltr; text-transform: none;">
                                </div>
                                <div>
                                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">Messaging Sender ID</label>
                                    <input type="text" id="dbMessagingSenderId" data-label="Messaging Sender ID" value="${sanitizeHTML(currentDbConfig.messagingSenderId || '')}" ${canEditDbSettings ? '' : 'disabled'}
                                        style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px; direction: ltr; text-transform: none;">
                                </div>
                                <div>
                                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">App ID</label>
                                    <input type="text" id="dbAppId" data-label="App ID" value="${sanitizeHTML(currentDbConfig.appId || '')}" ${canEditDbSettings ? '' : 'disabled'}
                                        style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px; direction: ltr; text-transform: none;">
                                </div>
                                <div>
                                    <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 8px; display: block;">Measurement ID</label>
                                    <input type="text" id="dbMeasurementId" data-label="Measurement ID" value="${sanitizeHTML(currentDbConfig.measurementId || '')}" ${canEditDbSettings ? '' : 'disabled'}
                                        style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px; direction: ltr; text-transform: none;">
                                </div>
                            </div>
                            <div style="margin-top: 25px; display: flex; gap: 12px; flex-wrap: wrap;">
                                <button class="btn btn-success" onclick="handleSaveDatabaseConfig()" style="padding: 12px 24px; font-weight: 600;" ${canEditDbSettings ? '' : 'disabled'}>
                                    💾 حفظ و إعادة التحميل
                                </button>
                                <button class="btn" style="background: rgba(99,102,241,0.15); color: #4338ca; padding: 12px 20px; font-weight: 600;" onclick="populateDefaultDatabaseConfig()" ${canEditDbSettings ? '' : 'disabled'}>
                                    📋 تعبئة الإعداد الافتراضي
                                </button>
                            </div>
                            <p style="font-size: 12px; color: #64748b; margin-top: 12px;">
                                يتم حفظ هذه الإعدادات في المتصفح فقط. أعد تحميل الصفحة بعد الحفظ لتطبيق الاتصال الجديد.
                            </p>
                            ` : `
                            <div style="background: #d1fae5; border: 2px solid #10b981; padding: 20px; border-radius: 12px; text-align: center;">
                                <h3 style="color: #065f46; margin-bottom: 15px;">💾 الوضع المحلي (Local Mode)</h3>
                                <p style="color: #047857; margin-bottom: 15px;">
                                    يتم حفظ جميع البيانات محلياً في المتصفح. لا حاجة لاتصال بالإنترنت.
                                </p>
                                <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                                    <p style="color: #1f2937; font-size: 14px; margin: 0;">
                                        <strong>📊 البيانات المحفوظة:</strong><br>
                                        • الموظفون: ${Object.keys(LocalData.loadAllEmployees()).length} سنة<br>
                                        • المشاريع: ${Object.keys(LocalData.loadProjects()).length} مشروع<br>
                                        • الإعدادات: ${Object.keys(LocalData.loadCompanySettings()).length > 0 ? '✅ محفوظة' : '❌ غير محفوظة'}<br>
                                        • التوقيعات: ${Object.keys(LocalData.loadSignatures()).length > 0 ? '✅ محفوظة' : '❌ غير محفوظة'}
                                    </p>
                                </div>
                            </div>
                            `}
                        </div>
                    </div>

                    <!-- بطاقة تحديث البيانات القديمة -->
                    <div class="card" style="margin-top: 30px;">
                        <div class="card-header">
                            <h3>🔄 تحديث البيانات القديمة</h3>
                            <p style="font-size: 13px; color: rgba(255,255,255,0.9); margin-top: 5px;">
                                تحديث البيانات القديمة التي تم إنشاؤها قبل إضافة نظام الحجوزات
                            </p>
                        </div>
                        <div class="card-body" style="padding: 30px;">
                            <div style="background: #fef3c7; border: 2px solid #f59e0b; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                                <h4 style="color: #92400e; margin: 0 0 10px 0; font-size: 16px; font-weight: 700;">
                                    ⚠️ ملاحظة مهمة
                                </h4>
                                <p style="color: #78350f; margin: 0; line-height: 1.8; font-size: 14px;">
                                    تقوم هذه الأداة بتحديث البيانات القديمة التي قد لا تحتوي على:
                                    <br>• <strong>month</strong> و <strong>year</strong> (الشهر والسنة)
                                    <br>• <strong>previousReservedAmount</strong> (المبلغ المحجوز سابقاً)
                                    <br>• <strong>targetReservedAmount</strong> (الهدف من الحجز)
                                    <br><br>
                                    <strong>💡 نصيحة:</strong> يُفضل تشغيل هذه الأداة مرة واحدة فقط بعد التحديث. 
                                    بعد ذلك، سيتم حفظ البيانات بشكل صحيح تلقائياً.
                                </p>
                            </div>
                            
                            <div style="background: #dbeafe; border: 2px solid #3b82f6; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                                <h4 style="color: #1e40af; margin: 0 0 10px 0; font-size: 16px; font-weight: 700;">
                                    📋 ما تفعله الأداة:
                                </h4>
                                <ul style="color: #1e3a8a; margin: 0; padding-right: 20px; line-height: 2; font-size: 14px;">
                                    <li>إضافة <strong>month</strong> و <strong>year</strong> للبيانات القديمة</li>
                                    <li>حساب <strong>previousReservedAmount</strong> من الحجوزات السابقة</li>
                                    <li>إضافة <strong>targetReservedAmount</strong> إذا كان الحجز مفعلاً</li>
                                    <li>تحديث جميع السجلات في قاعدة البيانات</li>
                                </ul>
                            </div>
                            
                            <div style="text-align: center; margin-top: 30px;">
                                <button 
                                    class="btn" 
                                    onclick="updateOldEmployeeData()" 
                                    style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
                                           border: none; 
                                           color: white; 
                                           padding: 15px 40px; 
                                           font-size: 18px; 
                                           font-weight: 700;
                                           box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
                                           transition: all 0.3s;">
                                    🔄 تحديث البيانات القديمة
                                </button>
                            </div>
                            
                            <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-right: 4px solid #3b82f6;">
                                <p style="font-size: 12px; color: #1e40af; margin: 0; line-height: 1.6;">
                                    <strong>⏱️ المدة المتوقعة:</strong> قد تستغرق العملية بضع دقائق حسب عدد الموظفين في قاعدة البيانات.
                                    <br><strong>📊 النتيجة:</strong> ستظهر رسالة تأكيد بعد اكتمال التحديث مع عدد السجلات المحدثة.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            
            // تحميل وملء جدول المصطلحات
            setTimeout(() => {
                if (document.getElementById('termsTableBody')) {
                    populateTermsTable();
                }
            }, 100);
        }
        
        // متغيرات التعديل المتعدد
        let bulkEditYear = currentYear;
        let bulkEditMonth = currentMonth;
        let bulkEditSelectedEmployees = new Set();
        let bulkEditFilterProject = 'all';
        let bulkEditFilterType = 'all';
        
        function renderBulkEditView() {
            const content = document.getElementById('mainContent');
            
            // الحصول على الموظفين للشهر والسنة المحددين
            let employees = (employeeData[bulkEditYear] && employeeData[bulkEditYear][bulkEditMonth]) 
                ? employeeData[bulkEditYear][bulkEditMonth].filter(emp => hasProjectAccess(emp.project))
                : [];
            
            // تطبيق فلاتر المشروع ونوع الموظف
            if (bulkEditFilterProject !== 'all') {
                employees = employees.filter(emp => emp.project === bulkEditFilterProject);
            }
            if (bulkEditFilterType !== 'all') {
                employees = employees.filter(emp => {
                    const empType = emp.employeeType || emp.type || '';
                    return empType === bulkEditFilterType;
                });
            }
            
            // تطبيق فلاتر الأعمدة
            employees = applyFiltersToData(employees);
            
            let html = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: var(--primary); font-size: 32px; margin-bottom: 10px;">✏️ ${t('bulkEditTitle')}</h2>
                    <p style="color: var(--gray); font-size: 16px;">${t('bulkEditDescription')}</p>
                </div>
                
                <!-- اختيار الشهر والسنة -->
                <div class="card" style="max-width: 1200px; margin: 0 auto 30px;">
                    <div class="card-header">
                        <h3>📅 ${t('selectMonthYear')}</h3>
                    </div>
                    <div class="card-body" style="padding: 30px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                            <div class="form-group">
                                <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                                    📅 ${t('year')}:
                                </label>
                                <select id="bulkEditYearSelect" class="form-control" onchange="updateBulkEditYear(this.value)" style="padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;">
                                    ${availableYears.map(y => `<option value="${y}" ${y === bulkEditYear ? 'selected' : ''}>${y}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                                    📆 ${t('month')}:
                                </label>
                                <select id="bulkEditMonthSelect" class="form-control" onchange="updateBulkEditMonth(this.value)" style="padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;">
                                    ${months.map(m => `<option value="${m}" ${m === bulkEditMonth ? 'selected' : ''}>${t('monthNames')[m]}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
                            <div class="form-group">
                                <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                                    🏗️ ${t('filterByProject')}:
                                </label>
                                <select id="bulkEditFilterProject" class="form-control" onchange="updateBulkEditFilterProject(this.value)" style="padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;">
                                    <option value="all" ${bulkEditFilterProject === 'all' ? 'selected' : ''}>${t('allProjects')}</option>
                                    ${Object.entries(projects).filter(([code]) => {
                                        const allEmployees = (employeeData[bulkEditYear] && employeeData[bulkEditYear][bulkEditMonth]) 
                                            ? employeeData[bulkEditYear][bulkEditMonth].filter(emp => hasProjectAccess(emp.project))
                                            : [];
                                        return allEmployees.some(emp => emp.project === code);
                                    }).map(([code, name]) => 
                                        `<option value="${code}" ${bulkEditFilterProject === code ? 'selected' : ''}>${code} - ${name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 10px; display: block;">
                                    👤 ${t('filterByType')}:
                                </label>
                                <select id="bulkEditFilterType" class="form-control" onchange="updateBulkEditFilterType(this.value)" style="padding: 12px; font-size: 14px; border: 2px solid var(--border); border-radius: 8px;">
                                    <option value="all" ${bulkEditFilterType === 'all' ? 'selected' : ''}>${t('allTypes')}</option>
                                    <option value="monthly" ${bulkEditFilterType === 'monthly' ? 'selected' : ''}>${t('monthly')}</option>
                                    <option value="daily" ${bulkEditFilterType === 'daily' ? 'selected' : ''}>${t('daily')}</option>
                                    <option value="vehicle" ${bulkEditFilterType === 'vehicle' ? 'selected' : ''}>${t('vehicle')}</option>
                                </select>
                            </div>
                        </div>
                        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-top: 20px; border: 2px solid #3b82f6;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <strong style="color: #1e40af;">📊 ${t('displayedEmployees')}: <span id="bulkEditEmployeeCount">${employees.length}</span></strong>
                                ${bulkEditFilterProject !== 'all' || bulkEditFilterType !== 'all' ? `
                                <button class="btn btn-secondary" onclick="resetBulkEditFilters()" style="padding: 6px 12px; font-size: 12px;">
                                    🔄 ${t('resetFilters')}
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- جدول الموظفين -->
                <div class="card" style="max-width: 1400px; margin: 0 auto 30px;">
                    <div class="card-header">
                        <h3>👥 ${t('employeesList')}</h3>
                        <p style="font-size: 13px; color: rgba(255,255,255,0.9); margin-top: 5px;">
                            ${t('employeesListDescription')}
                        </p>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="table-container" style="max-height: 600px; overflow-y: auto;">
                            <table id="bulkEditTable" style="width: 100%; border-collapse: collapse;">
                                <thead style="position: sticky; top: 0; background: var(--primary); color: white; z-index: 10;">
                                    ${createPinCheckboxRow([
                                        {dataColumn: 'nameAr'},
                                        {dataColumn: 'nameEn'},
                                        {dataColumn: 'position'},
                                        {dataColumn: 'employeeType'},
                                        {dataColumn: 'project'},
                                        {dataColumn: 'salary'},
                                        {dataColumn: 'salaryCurrency'},
                                        {dataColumn: 'paymentCurrency'},
                                        {dataColumn: 'exchangeRate'},
                                        {dataColumn: 'attendanceSystem'},
                                        {dataColumn: 'dailyWorkHours'},
                                        {dataColumn: 'overtimeMultiplier'},
                                        {dataColumn: 'monthCalculationMethod'},
                                        {dataColumn: 'paidLeaveCalculation'},
                                        {dataColumn: 'actions'}
                                    ], 'bulkEditTable', 'bulkEdit')}
                                    <tr>
                                        <th data-column="nameAr" style="padding: 12px; text-align: right; min-width: 120px;">${t('nameAr')}</th>
                                        <th data-column="nameEn" style="padding: 12px; text-align: right; min-width: 120px;">${t('nameEn')}</th>
                                        <th data-column="position" style="padding: 12px; text-align: right; min-width: 100px;">${t('position')}</th>
                                        <th data-column="employeeType" style="padding: 12px; text-align: right; min-width: 100px;">${t('employeeType')}</th>
                                        <th data-column="project" style="padding: 12px; text-align: right; min-width: 100px;">${t('project')}</th>
                                        <th data-column="salary" style="padding: 12px; text-align: right; min-width: 100px;">${t('basicSalary')}</th>
                                        <th data-column="salaryCurrency" style="padding: 12px; text-align: right; min-width: 90px;">${t('salaryCurrency')}</th>
                                        <th data-column="paymentCurrency" style="padding: 12px; text-align: right; min-width: 90px;">${t('paymentCurrency')}</th>
                                        <th data-column="exchangeRate" style="padding: 12px; text-align: right; min-width: 100px;">${t('exchangeRate')}</th>
                                        <th data-column="attendanceSystem" style="padding: 12px; text-align: right; min-width: 120px;">${t('attendanceSystem')}</th>
                                        <th data-column="dailyWorkHours" style="padding: 12px; text-align: right; min-width: 100px;">${t('dailyWorkHours')}</th>
                                        <th data-column="overtimeMultiplier" style="padding: 12px; text-align: right; min-width: 100px;">${t('overtimeMultiplier')}</th>
                                        <th data-column="monthCalculationMethod" style="padding: 12px; text-align: right; min-width: 120px;">${t('monthCalculationMethod')}</th>
                                        <th data-column="paidLeaveCalculation" style="padding: 12px; text-align: right; min-width: 120px;">${t('paidLeaveCalculation')}</th>
                                        <th data-column="actions" style="padding: 12px; text-align: center; min-width: 100px;">${t('actions')}</th>
                                    </tr>
                                </thead>
                                <tbody id="bulkEditTableBody">
                                    ${employees.length === 0 ? `
                                    <tr>
                                        <td colspan="15" style="padding: 40px; text-align: center; color: var(--gray);">
                                            ${t('noEmployeesInMonth')} ${t('monthNames')[bulkEditMonth]} ${bulkEditYear}
                                        </td>
                                    </tr>
                                    ` : employees.map((emp, idx) => {
                                        const empId = emp.firebaseId || emp.id || `emp_${idx}`;
                                        const workDays = emp.workDays || [0,1,2,3,4,6]; // الأحد إلى الخميس والسبت
                                        return `
                                    <tr data-emp-id="${empId}" data-emp-index="${idx}" style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 8px;">
                                            <input type="text" 
                                                class="bulk-edit-field" 
                                                data-field="nameAr" 
                                                data-emp-id="${empId}"
                                                value="${(emp.nameAr || emp.name || '').replace(/"/g, '&quot;')}" 
                                                style="width: 100%; padding: 8px; font-size: 12px; border: 1px solid var(--border); border-radius: 4px; background: white;">
                                        </td>
                                        <td style="padding: 8px;">
                                            <input type="text" 
                                                class="bulk-edit-field" 
                                                data-field="nameEn" 
                                                data-emp-id="${empId}"
                                                value="${(emp.nameEn || '').replace(/"/g, '&quot;')}" 
                                                style="width: 100%; padding: 8px; font-size: 12px; border: 1px solid var(--border); border-radius: 4px; background: white;">
                                        </td>
                                        <td style="padding: 8px;">
                                            <input type="text" 
                                                class="bulk-edit-field" 
                                                data-field="position" 
                                                data-emp-id="${empId}"
                                                value="${(emp.position || '').replace(/"/g, '&quot;')}" 
                                                style="width: 100%; padding: 8px; font-size: 12px; border: 1px solid var(--border); border-radius: 4px; background: white;">
                                        </td>
                                        <td style="padding: 8px;">
                                            <select 
                                                class="bulk-edit-field" 
                                                data-field="employeeType" 
                                                data-emp-id="${empId}"
                                                style="width: 100%; padding: 8px; font-size: 12px; border: 1px solid var(--border); border-radius: 4px; background: white;">
                                                <option value="monthly" ${(emp.employeeType || 'monthly') === 'monthly' ? 'selected' : ''}>${t('monthly')}</option>
                                                <option value="daily" ${emp.employeeType === 'daily' ? 'selected' : ''}>${t('daily')}</option>
                                                <option value="vehicle" ${emp.employeeType === 'vehicle' ? 'selected' : ''}>${t('vehicle')}</option>
                                            </select>
                                        </td>
                                        <td style="padding: 8px;">
                                            <select 
                                                class="bulk-edit-field" 
                                                data-field="project" 
                                                data-emp-id="${empId}"
                                                style="width: 100%; padding: 8px; font-size: 12px; border: 1px solid var(--border); border-radius: 4px; background: white;">
                                                ${Object.entries(projects).map(([code, name]) => 
                                                    `<option value="${code}" ${emp.project === code ? 'selected' : ''}>${code} - ${name}</option>`
                                                ).join('')}
                                            </select>
                                        </td>
                                        <td style="padding: 8px;">
                                            <input type="number" 
                                                class="bulk-edit-field" 
                                                data-field="salary" 
                                                data-emp-id="${empId}"
                                                value="${emp.salary || 0}" 
                                                min="0" 
                                                step="0.01"
                                                style="width: 100%; padding: 8px; font-size: 12px; border: 1px solid var(--border); border-radius: 4px; background: white; text-align: right;">
                                        </td>
                                        <td style="padding: 8px;">
                                            <select 
                                                class="bulk-edit-field" 
                                                data-field="salaryCurrency" 
                                                data-emp-id="${empId}"
                                                style="width: 100%; padding: 8px; font-size: 12px; border: 1px solid var(--border); border-radius: 4px; background: white;">
                                                <option value="USD" ${(emp.salaryCurrency || 'USD') === 'USD' ? 'selected' : ''}>USD</option>
                                                <option value="IQD" ${emp.salaryCurrency === 'IQD' ? 'selected' : ''}>IQD</option>
                                            </select>
                                        </td>
                                        <td style="padding: 8px;">
                                            <select 
                                                class="bulk-edit-field" 
                                                data-field="paymentCurrency" 
                                                data-emp-id="${empId}"
                                                style="width: 100%; padding: 8px; font-size: 12px; border: 1px solid var(--border); border-radius: 4px; background: white;">
                                                <option value="USD" ${(emp.paymentCurrency || 'USD') === 'USD' ? 'selected' : ''}>USD</option>
                                                <option value="IQD" ${emp.paymentCurrency === 'IQD' ? 'selected' : ''}>IQD</option>
                                            </select>
                                        </td>
                                        <td style="padding: 8px;">
                                            <input type="number" 
                                                class="bulk-edit-field" 
                                                data-field="exchangeRate" 
                                                data-emp-id="${empId}"
                                                value="${emp.exchangeRate || 1420}" 
                                                min="0" 
                                                step="0.01"
                                                style="width: 100%; padding: 8px; font-size: 12px; border: 1px solid var(--border); border-radius: 4px; background: white; text-align: right;">
                                        </td>
                                        <td style="padding: 8px;">
                                            <select 
                                                class="bulk-edit-field" 
                                                data-field="attendanceSystem" 
                                                data-emp-id="${empId}"
                                                style="width: 100%; padding: 8px; font-size: 12px; border: 1px solid var(--border); border-radius: 4px; background: white;">
                                                <option value="hours" ${(emp.attendanceSystem || 'hours') === 'hours' ? 'selected' : ''}>⏱️ ${t('byHours')}</option>
                                                <option value="fixed" ${emp.attendanceSystem === 'fixed' ? 'selected' : ''}>💰 ${t('fixed')}</option>
                                            </select>
                                        </td>
                                        <td style="padding: 8px;">
                                            <input type="number" 
                                                class="bulk-edit-field" 
                                                data-field="dailyWorkHours" 
                                                data-emp-id="${empId}"
                                                value="${emp.dailyWorkHours || 8}" 
                                                min="1" 
                                                max="24" 
                                                step="0.5"
                                                style="width: 100%; padding: 8px; font-size: 12px; border: 1px solid var(--border); border-radius: 4px; background: white; text-align: right;">
                                        </td>
                                        <td style="padding: 8px;">
                                            <select 
                                                class="bulk-edit-field" 
                                                data-field="overtimeMultiplier" 
                                                data-emp-id="${empId}"
                                                style="width: 100%; padding: 8px; font-size: 12px; border: 1px solid var(--border); border-radius: 4px; background: white;">
                                                <option value="1" ${(emp.overtimeMultiplier || 1.5) == 1 ? 'selected' : ''}>1× (${t('normal')})</option>
                                                <option value="1.5" ${(emp.overtimeMultiplier || 1.5) == 1.5 ? 'selected' : ''}>1.5× (${t('timeAndHalf')})</option>
                                                <option value="2" ${emp.overtimeMultiplier == 2 ? 'selected' : ''}>2× (${t('double')})</option>
                                            </select>
                                        </td>
                                        <td style="padding: 8px;">
                                            <select 
                                                class="bulk-edit-field" 
                                                data-field="monthCalculationMethod" 
                                                data-emp-id="${empId}"
                                                style="width: 100%; padding: 8px; font-size: 12px; border: 1px solid var(--border); border-radius: 4px; background: white;">
                                                <option value="30" ${(emp.monthCalculationMethod || '30') === '30' ? 'selected' : ''}>${t('always30Days')}</option>
                                                <option value="actual" ${emp.monthCalculationMethod === 'actual' ? 'selected' : ''}>${t('actualDays')}</option>
                                            </select>
                                        </td>
                                        <td style="padding: 8px;">
                                            <select 
                                                class="bulk-edit-field" 
                                                data-field="paidLeaveCalculation" 
                                                data-emp-id="${empId}"
                                                style="width: 100%; padding: 8px; font-size: 12px; border: 1px solid var(--border); border-radius: 4px; background: white;">
                                                <option value="full" ${(emp.paidLeaveCalculation || 'full') === 'full' ? 'selected' : ''}>${t('fullSalary')}</option>
                                                <option value="half" ${emp.paidLeaveCalculation === 'half' ? 'selected' : ''}>${t('halfSalary')}</option>
                                                <option value="none" ${emp.paidLeaveCalculation === 'none' ? 'selected' : ''}>${t('noSalary')}</option>
                                            </select>
                                        </td>
                                        <td style="padding: 8px; text-align: center;">
                                            <button 
                                                class="btn btn-success" 
                                                onclick="saveBulkEditRow('${empId}', ${idx})" 
                                                style="padding: 6px 12px; font-size: 12px; font-weight: 600; cursor: pointer;"
                                                title="${t('saveChanges')}">
                                                💾 ${t('save')}
                                            </button>
                                        </td>
                                    </tr>
                                    `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            
            // تفعيل التصفية وتثبيت الأعمدة بعد رسم الجدول
            setTimeout(() => {
                // إضافة أيقونات الفلتر
                addBulkEditFilterIcons();
                
                // تفعيل تغيير حجم الأعمدة
                makeColumnsResizable();
                
                // تطبيق تثبيت الأعمدة
                applyPinnedColumns('bulkEditTable', 'bulkEdit');
            }, 150);
        }
        
        // إضافة أيقونات الفلتر لجدول التعديل المتعدد
        function addBulkEditFilterIcons() {
            const filterableColumns = {
                'nameAr': '👤 الاسم بالعربية',
                'nameEn': '👤 الاسم بالإنجليزية',
                'position': '💼 المنصب',
                'employeeType': '📋 النوع',
                'project': '🏗️ المشروع',
                'salary': '💵 الراتب',
                'salaryCurrency': '💱 عملة الراتب',
                'paymentCurrency': '💳 عملة الدفع',
                'exchangeRate': '🔄 سعر الصرف',
                'attendanceSystem': '⏰ نظام الدوام',
                'dailyWorkHours': '⏱️ ساعات العمل',
                'overtimeMultiplier': '🔢 معامل الأوفر تايم',
                'monthCalculationMethod': '📊 طريقة احتساب الشهر',
                'paidLeaveCalculation': '💚 احتساب الإجازات',
                'actions': '⚙️ الإجراءات'
            };

            const table = document.querySelector('#bulkEditTable');
            if (!table) {
                console.log('⚠️ لم يتم العثور على جدول التعديل المتعدد');
                return;
            }

            const headers = table.querySelectorAll('thead tr:not(.pin-checkbox-row) th[data-column]');

            headers.forEach((th, index) => {
                const columnName = th.dataset.column;
                
                if (columnName && filterableColumns[columnName] && columnName !== 'actions') {
                    // إزالة أي أيقونة فلتر موجودة
                    const existingIcon = th.querySelector('.filter-icon');
                    if (existingIcon) existingIcon.remove();
                    
                    const filterIcon = document.createElement('span');
                    filterIcon.className = 'filter-icon';
                    filterIcon.innerHTML = ' 🔽';
                    filterIcon.dataset.column = columnName;
                    filterIcon.title = `فلتر ${filterableColumns[columnName]}`;
                    
                    if (columnFilters[columnName] && columnFilters[columnName].length > 0) {
                        filterIcon.classList.add('active');
                        th.classList.add('filtered');
                    }
                    
                    filterIcon.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showBulkEditFilterDropdown(columnName, th, index);
                    });
                    
                    th.appendChild(filterIcon);
                    th.style.position = 'relative';
                }
            });
        }
        
        // عرض نافذة الفلتر لجدول التعديل المتعدد
        function showBulkEditFilterDropdown(columnName, headerCell, columnIndex) {
            // استخدام نفس دالة showFilterDropdown ولكن مع البيانات الصحيحة
            // سنقوم بتخزين السنة والشهر الحاليين مؤقتاً
            const originalYear = currentYear;
            const originalMonth = currentMonth;
            
            // تعيين السنة والشهر للتعديل المتعدد
            currentYear = bulkEditYear;
            currentMonth = bulkEditMonth;
            
            // استدعاء دالة الفلتر العادية
            showFilterDropdown(columnName, headerCell, columnIndex);
            
            // إعادة السنة والشهر الأصليين بعد استدعاء الفلتر
            // (سيتم استعادتها تلقائياً عند renderContent)
        }
        
        function updateBulkEditYear(year) {
            bulkEditYear = parseInt(year);
            renderBulkEditView();
        }
        
        function updateBulkEditMonth(month) {
            bulkEditMonth = month;
            renderBulkEditView();
        }
        
        function updateBulkEditFilterProject(project) {
            bulkEditFilterProject = project;
            renderBulkEditView();
        }
        
        function updateBulkEditFilterType(type) {
            bulkEditFilterType = type;
            renderBulkEditView();
        }
        
        function resetBulkEditFilters() {
            bulkEditFilterProject = 'all';
            bulkEditFilterType = 'all';
            renderBulkEditView();
        }
        
        async function saveBulkEditRow(empId, index) {
            if (!currentUser) {
                showNotification('error', 'خطأ', 'يجب تسجيل الدخول أولاً');
                return;
            }
            
            if (!hasDetailedPermission('months', 'edit')) {
                showNotification('error', 'خطأ', 'ليس لديك صلاحية لتعديل الموظفين');
                return;
            }
            
            // التحقق من قفل الشهر
            if (!canEditCurrentMonth(bulkEditMonth, bulkEditYear)) {
                showNotification('warning', 'تحذير', 'الشهر مقفل ولا يمكن التعديل');
                return;
            }
            
            // الحصول على جميع الموظفين للشهر والسنة المحددين (بدون فلاتر)
            const allEmployees = (employeeData[bulkEditYear] && employeeData[bulkEditYear][bulkEditMonth]) 
                ? employeeData[bulkEditYear][bulkEditMonth].filter(emp => hasProjectAccess(emp.project))
                : [];
            
            // البحث عن الموظف باستخدام empId (firebaseId) بدلاً من index لضمان العثور على الموظف الصحيح
            let emp = null;
            if (empId && empId.startsWith('emp_')) {
                // إذا كان empId مؤقتاً، استخدم index مع تطبيق الفلاتر
                let filteredEmployees = applyFiltersToData(allEmployees);
                if (bulkEditFilterProject !== 'all') {
                    filteredEmployees = filteredEmployees.filter(e => e.project === bulkEditFilterProject);
                }
                if (bulkEditFilterType !== 'all') {
                    filteredEmployees = filteredEmployees.filter(e => {
                        const empType = e.employeeType || e.type || '';
                        return empType === bulkEditFilterType;
                    });
                }
                if (index < filteredEmployees.length) {
                    emp = filteredEmployees[index];
                }
            } else {
                // البحث عن الموظف باستخدام firebaseId من البيانات الأصلية
                emp = allEmployees.find(e => (e.firebaseId || e.id) === empId);
            }
            
            if (!emp) {
                showNotification('error', 'خطأ', 'الموظف غير موجود');
                return;
            }
            
            // جمع القيم من الحقول في الصف
            const row = document.querySelector(`tr[data-emp-id="${empId}"]`);
            if (!row) {
                showNotification('error', 'خطأ', 'لم يتم العثور على صف الموظف');
                return;
            }
            
            const updates = {};
            const nameArField = row.querySelector('[data-field="nameAr"]');
            const nameEnField = row.querySelector('[data-field="nameEn"]');
            const positionField = row.querySelector('[data-field="position"]');
            const employeeTypeField = row.querySelector('[data-field="employeeType"]');
            const projectField = row.querySelector('[data-field="project"]');
            const salaryField = row.querySelector('[data-field="salary"]');
            const salaryCurrencyField = row.querySelector('[data-field="salaryCurrency"]');
            const paymentCurrencyField = row.querySelector('[data-field="paymentCurrency"]');
            const exchangeRateField = row.querySelector('[data-field="exchangeRate"]');
            const attendanceSystemField = row.querySelector('[data-field="attendanceSystem"]');
            const dailyWorkHoursField = row.querySelector('[data-field="dailyWorkHours"]');
            const overtimeMultiplierField = row.querySelector('[data-field="overtimeMultiplier"]');
            const monthCalculationMethodField = row.querySelector('[data-field="monthCalculationMethod"]');
            const paidLeaveCalculationField = row.querySelector('[data-field="paidLeaveCalculation"]');
            
            if (nameArField) {
                const nameAr = nameArField.value.trim();
                if (nameAr) updates.nameAr = nameAr;
            }
            
            if (nameEnField) {
                const nameEn = nameEnField.value.trim();
                if (nameEn) updates.nameEn = nameEn;
            }
            
            if (positionField) {
                const position = positionField.value.trim();
                if (position) updates.position = position;
            }
            
            if (employeeTypeField) {
                const employeeType = employeeTypeField.value;
                if (employeeType) updates.employeeType = employeeType;
            }
            
            if (projectField) {
                const project = projectField.value;
                if (project) updates.project = project;
            }
            
            if (salaryField) {
                const salary = salaryField.value.trim();
                if (salary) {
                    const salaryValue = parseFloat(salary);
                    if (!isNaN(salaryValue) && salaryValue >= 0) {
                        updates.salary = salaryValue;
                    }
                }
            }
            
            if (salaryCurrencyField) {
                const salaryCurrency = salaryCurrencyField.value;
                if (salaryCurrency) updates.salaryCurrency = salaryCurrency;
            }
            
            if (paymentCurrencyField) {
                const paymentCurrency = paymentCurrencyField.value;
                if (paymentCurrency) updates.paymentCurrency = paymentCurrency;
            }
            
            if (exchangeRateField) {
                const exchangeRate = exchangeRateField.value.trim();
                if (exchangeRate) {
                    const exchangeRateValue = parseFloat(exchangeRate);
                    if (!isNaN(exchangeRateValue) && exchangeRateValue >= 0) {
                        updates.exchangeRate = exchangeRateValue;
                    }
                }
            }
            
            if (attendanceSystemField) {
                const attendanceSystem = attendanceSystemField.value;
                if (attendanceSystem) updates.attendanceSystem = attendanceSystem;
            }
            
            if (dailyWorkHoursField) {
                const dailyWorkHours = dailyWorkHoursField.value.trim();
                if (dailyWorkHours) {
                    const dailyWorkHoursValue = parseFloat(dailyWorkHours);
                    if (!isNaN(dailyWorkHoursValue) && dailyWorkHoursValue > 0) {
                        updates.dailyWorkHours = dailyWorkHoursValue;
                    }
                }
            }
            
            if (overtimeMultiplierField) {
                const overtimeMultiplier = overtimeMultiplierField.value;
                if (overtimeMultiplier) {
                    updates.overtimeMultiplier = parseFloat(overtimeMultiplier);
                }
            }
            
            if (monthCalculationMethodField) {
                const monthCalculationMethod = monthCalculationMethodField.value;
                if (monthCalculationMethod) updates.monthCalculationMethod = monthCalculationMethod;
            }
            
            if (paidLeaveCalculationField) {
                const paidLeaveCalculation = paidLeaveCalculationField.value;
                if (paidLeaveCalculation) updates.paidLeaveCalculation = paidLeaveCalculation;
            }
            
            if (Object.keys(updates).length === 0) {
                showNotification('info', 'معلومة', 'لم يتم إجراء أي تعديلات');
                return;
            }
            
            // دمج التحديثات مع بيانات الموظف
            const updatedEmp = { ...emp, ...updates };
            
            // التأكد من وجود firebaseId - هذا ضروري لمنع إنشاء موظف جديد
            if (!emp.firebaseId && !emp.id) {
                console.error('⚠️ الموظف لا يحتوي على firebaseId:', emp);
                showNotification('error', 'خطأ', 'خطأ في بيانات الموظف - لا يوجد معرف فريد. لا يمكن التعديل.');
                return;
            }
            
            // التأكد من أن firebaseId محفوظ بشكل صحيح في updatedEmp
            // هذا مهم جداً لمنع إنشاء موظف جديد عند التعديل
            if (emp.firebaseId) {
                updatedEmp.firebaseId = emp.firebaseId;
            } else if (emp.id) {
                updatedEmp.firebaseId = emp.id;
            }
            
            // التأكد مرة أخرى بعد الدمج
            if (!updatedEmp.firebaseId && !updatedEmp.id) {
                console.error('⚠️ فشل حفظ firebaseId في updatedEmp:', updatedEmp);
                showNotification('error', 'خطأ', 'خطأ في حفظ معرف الموظف. لا يمكن التعديل.');
                return;
            }
            
            // التأكد من عدم إنشاء createdAt جديد (لأن هذا موظف موجود)
            if (updatedEmp.createdAt && emp.createdAt) {
                updatedEmp.createdAt = emp.createdAt; // الحفاظ على تاريخ الإنشاء الأصلي
            }
            
            updatedEmp.updatedAt = new Date().toISOString();
            
            // تحديث زر الحفظ لإظهار التحميل
            const saveBtn = row.querySelector('button');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '⏳ جاري الحفظ...';
            }
            
            try {
                // حفظ الموظف مع الشهر والسنة الصحيحين
                console.log(`💾 حفظ الموظف ${updatedEmp.nameAr || updatedEmp.name} في ${bulkEditMonth} ${bulkEditYear}`, {
                    firebaseId: updatedEmp.firebaseId,
                    month: bulkEditMonth,
                    year: bulkEditYear,
                    updates: Object.keys(updates)
                });
                
                await saveEmployeeToFirebase(updatedEmp, bulkEditMonth, bulkEditYear);
                
                // تحديث البيانات المحلية
                await loadEmployeesFromFirebase();
                
                // إعادة رسم الواجهة
                renderBulkEditView();
                
                showNotification('success', 'نجح', `تم حفظ تعديلات الموظف "${updatedEmp.nameAr || updatedEmp.name || 'غير محدد'}" بنجاح`);
            } catch (error) {
                console.error('فشل حفظ الموظف:', error);
                showNotification('error', 'خطأ', 'فشل حفظ التعديلات');
                
                // إعادة تفعيل زر الحفظ
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '💾 حفظ';
                }
            }
        }
        
        // جعل الدوال متاحة عالمياً
        window.updateBulkEditYear = updateBulkEditYear;
        window.updateBulkEditMonth = updateBulkEditMonth;
        window.updateBulkEditFilterProject = updateBulkEditFilterProject;
        window.updateBulkEditFilterType = updateBulkEditFilterType;
        window.resetBulkEditFilters = resetBulkEditFilters;
        window.saveBulkEditRow = saveBulkEditRow;
        
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // التحقق من نوع الملف
            if (!file.type.startsWith('image/')) {
                showNotification('error', 'خطأ', 'الرجاء اختيار ملف صورة فقط');
                return;
            }
            
            // التحقق من حجم الملف (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showNotification('error', 'خطأ', 'حجم الصورة كبير جداً. الحد الأقصى 2 ميجابايت');
                return;
            }
            
            // ضغط الصورة لتناسب حد Firestore (< ~1MB للوثيقة)
            compressImage(file, 300, 300, 'image/jpeg', 0.8)
                .then((dataUrl) => {
                const logoPreview = document.getElementById('logoPreview');
                    logoPreview.innerHTML = `<img src="${dataUrl}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
                    window.tempCompanyLogo = dataUrl;

                    const bytes = estimateDataUrlBytes(dataUrl);
                    const kb = Math.round(bytes / 1024);
                    if (bytes > 900 * 1024) {
                        showNotification('warning', 'تنبيه', `تم ضغط اللوغو ولكن حجمه ${kb}KB كبير. يُفضل استخدام صورة أصغر من 900KB.`);
                    } else {
                        showNotification('success', 'تم', `تم رفع اللوغو (${kb}KB) بنجاح! اضغط "حفظ الإعدادات" للحفظ الدائم`);
                    }
                })
                .catch(() => {
                    showNotification('error', 'خطأ', 'تعذر ضغط الصورة. جرّب صورة أصغر أو مختلفة.');
                });
        }
        
        function removeCompanyLogo() {
            if (confirm('هل أنت متأكد من حذف اللوغو؟')) {
                const logoPreview = document.getElementById('logoPreview');
                logoPreview.innerHTML = '<span style="color: var(--gray); font-size: 14px;">لا يوجد لوغو</span>';
                window.tempCompanyLogo = '';
                showNotification('info', 'تم', 'تم حذف اللوغو! اضغط "حفظ الإعدادات" لتأكيد الحذف');
            }
        }
        
        async function handleSaveCompanySettings() {
            const companyNameAr = document.getElementById('companyNameAr').value.trim();
            const companyNameEn = document.getElementById('companyNameEn').value.trim();
            const companyLogo = window.tempCompanyLogo !== undefined ? window.tempCompanyLogo : companySettings.companyLogo || '';
            
            const settings = {
                companyNameAr,
                companyNameEn,
                companyLogo,
                companyAddress: document.getElementById('companyAddress')?.value || '',
                companyPhone: document.getElementById('companyPhone')?.value || '',
                companyEmail: document.getElementById('companyEmail')?.value || '',
                // الحفاظ على إعدادات الحجز العامة
                globalReservationEnabled: companySettings.globalReservationEnabled || false,
                globalReservationType: companySettings.globalReservationType || 'percentage',
                globalReservationPercentage: companySettings.globalReservationPercentage || 10,
                globalReservationAmount: companySettings.globalReservationAmount || 0
            };
            
            showLoading();
            const success = await saveCompanySettings(settings);
            hideLoading();
            
            if (success) {
            delete window.tempCompanyLogo;
                showNotification('success', '✅ تم الحفظ', 'تم حفظ إعدادات الشركة في قاعدة البيانات!');
            
            // إعادة تحميل الصفحة لتطبيق التغييرات
            setTimeout(() => {
                renderSettingsView();
            }, 1000);
            } else {
                showNotification('error', '❌ خطأ', 'فشل في حفظ الإعدادات');
            }
        }
        
        // دوال إدارة إعدادات الحجز العامة
        function toggleGlobalReservationSettings() {
            const enabled = document.getElementById('globalReservationEnabled').checked;
            const settingsDiv = document.getElementById('globalReservationSettings');
            if (settingsDiv) {
                settingsDiv.style.display = enabled ? 'block' : 'none';
            }
        }
        
        function toggleGlobalReservationInputs() {
            const type = document.getElementById('globalReservationType').value;
            const percentageContainer = document.getElementById('globalReservationPercentageContainer');
            const amountContainer = document.getElementById('globalReservationAmountContainer');
            
            if (percentageContainer) {
                percentageContainer.style.display = type === 'percentage' ? 'block' : 'none';
            }
            if (amountContainer) {
                amountContainer.style.display = type === 'amount' ? 'block' : 'none';
            }
        }
        
        async function handleSaveGlobalReservationSettings() {
            const enabled = document.getElementById('globalReservationEnabled').checked;
            const type = document.getElementById('globalReservationType').value;
            const percentage = parseFloat(document.getElementById('globalReservationPercentage').value) || 0;
            const amount = parseFloat(document.getElementById('globalReservationAmount').value) || 0;
            
            const settings = {
                ...companySettings,
                globalReservationEnabled: enabled,
                globalReservationType: type,
                globalReservationPercentage: percentage,
                globalReservationAmount: amount
            };
            
            showLoading();
            const success = await saveCompanySettings(settings);
            hideLoading();
            
            if (success) {
                companySettings = settings;
                showNotification('success', '✅ تم الحفظ', 'تم حفظ إعدادات الحجز العامة!');
                setTimeout(() => {
                    renderSettingsView();
                }, 500);
            } else {
                showNotification('error', '❌ خطأ', 'فشل في حفظ إعدادات الحجز');
            }
        }
        
        // دالة تصفير جميع الحجوزات
        async function resetAllReservations() {
            // طلب تأكيد من المستخدم
            const confirmed = confirm(
                '⚠️ تحذير: هذا الإجراء سيقوم بتصفير جميع الحجوزات في جميع الأشهر لجميع الموظفين.\n\n' +
                'سيتم تصفير:\n' +
                '• reservedAmount (المبلغ المحجوز) في جميع الأشهر\n' +
                '• previousReservedAmount (الرصيد السابق) لجميع الموظفين\n\n' +
                'هل أنت متأكد من المتابعة؟'
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                showLoading();
                console.log('🔄 بدء تصفير جميع الحجوزات...');
                
                const employeesRef = collection(db, 'employees');
                const snapshot = await getDocs(employeesRef);
                
                let resetCount = 0;
                const updates = [];
                
                console.log(`📊 إجمالي الموظفين: ${snapshot.size}`);
                
                snapshot.forEach(docSnapshot => {
                    const data = docSnapshot.data();
                    const docRef = doc(db, 'employees', docSnapshot.id);
                    
                    // تصفير الحجوزات
                    const updateData = {
                        reservedAmount: 0,
                        previousReservedAmount: 0,
                        updatedAt: new Date().toISOString(),
                        reservationsReset: true, // علامة أن الحجوزات تم تصفيرها
                        reservationsResetAt: new Date().toISOString()
                    };
                    
                    updates.push(updateDoc(docRef, updateData));
                    resetCount++;
                });
                
                // تنفيذ جميع التحديثات بشكل متوازي
                await Promise.all(updates);
                
                hideLoading();
                console.log(`✅ تم تصفير الحجوزات لـ ${resetCount} موظف`);
                
                showNotification('success', '✅ تم التصفير', `تم تصفير الحجوزات لـ ${resetCount} موظف بنجاح!`);
                
                // إعادة تحميل البيانات
                await loadEmployeesFromFirebase();
                
            } catch (error) {
                console.error('❌ خطأ في تصفير الحجوزات:', error);
                hideLoading();
                showNotification('error', '❌ خطأ', 'حدث خطأ في تصفير الحجوزات: ' + error.message);
            }
        }

        function populateDatabaseConfigForm(config) {
            if (!config) return;
            const mapping = {
                dbProjectId: 'projectId',
                dbApiKey: 'apiKey',
                dbAuthDomain: 'authDomain',
                dbStorageBucket: 'storageBucket',
                dbMessagingSenderId: 'messagingSenderId',
                dbAppId: 'appId',
                dbMeasurementId: 'measurementId'
            };

            Object.entries(mapping).forEach(([elementId, key]) => {
                const field = document.getElementById(elementId);
                if (field) {
                    field.value = config[key] || '';
                }
            });
        }

        function populateDefaultDatabaseConfig() {
            if (!canManageDatabaseSettings()) {
                showNotification('warning', 'صلاحيات', 'ليس لديك صلاحية لتعديل إعدادات قاعدة البيانات.');
                return;
            }
            const defaults = getDefaultDatabaseConfig();
            populateDatabaseConfigForm(defaults);
            showNotification('info', 'تم', 'تمت تعبئة الحقول بالقيم الافتراضية. عدّلها ثم احفظ لتطبيقها.');
        }

        function collectDatabaseConfigFromForm() {
            const fields = [
                { id: 'dbProjectId', key: 'projectId', label: 'Project ID', required: true },
                { id: 'dbApiKey', key: 'apiKey', label: 'API Key', required: true },
                { id: 'dbAuthDomain', key: 'authDomain', label: 'Auth Domain', required: true },
                { id: 'dbStorageBucket', key: 'storageBucket', label: 'Storage Bucket', required: false },
                { id: 'dbMessagingSenderId', key: 'messagingSenderId', label: 'Messaging Sender ID', required: false },
                { id: 'dbAppId', key: 'appId', label: 'App ID', required: true },
                { id: 'dbMeasurementId', key: 'measurementId', label: 'Measurement ID', required: false }
            ];

            const config = {};
            const missing = [];

            fields.forEach(({ id, key, label, required }) => {
                const field = document.getElementById(id);
                if (!field) return;
                const value = field.value.trim();
                if (!value && required) {
                    missing.push(label);
                }
                if (value) {
                    config[key] = value;
                }
            });

            return { config, missing };
        }

        function handleSaveDatabaseConfig() {
            if (!canManageDatabaseSettings()) {
                showNotification('error', '❌ صلاحيات', 'ليس لديك صلاحية لتعديل إعدادات قاعدة البيانات.');
                return;
            }

            const { config, missing } = collectDatabaseConfigFromForm();

            if (missing.length > 0) {
                showNotification('error', 'بيانات ناقصة', `الرجاء تعبئة الحقول التالية: ${missing.join(', ')}`);
                return;
            }

            try {
                saveDatabaseConfigToStorage(config);
                showNotification('success', '✅ تم الحفظ', 'تم حفظ إعدادات الاتصال. سيتم إعادة تحميل النظام لتطبيق التغييرات.');
                setTimeout(() => window.location.reload(), 1200);
            } catch (error) {
                console.error('Error saving database config:', error);
                showNotification('error', '❌ خطأ', 'تعذر حفظ إعدادات قاعدة البيانات. تحقق من إعدادات المتصفح أو حاول مرة أخرى.');
            }
        }

        function resetDatabaseConfig() {
            if (!canManageDatabaseSettings()) {
                showNotification('warning', 'صلاحيات', 'ليس لديك صلاحية لتعديل إعدادات قاعدة البيانات.');
                return;
            }

            if (!isCustomDatabaseConfig()) {
                showNotification('info', 'معلومة', 'لا توجد إعدادات مخصصة لإعادتها.');
                return;
            }

            if (!confirm('سيتم حذف الإعدادات المخصصة والعودة إلى الإعداد الافتراضي. هل أنت متأكد؟')) {
                return;
            }

            try {
                clearDatabaseConfigFromStorage();
                showNotification('success', '✅ تم', 'تمت استعادة الإعداد الافتراضي. سيتم إعادة التحميل الآن.');
                setTimeout(() => window.location.reload(), 1000);
            } catch (error) {
                console.error('Error clearing database config:', error);
                showNotification('error', '❌ خطأ', 'تعذر حذف الإعدادات المخصصة. حاول مرة أخرى.');
            }
        }

        window.populateDefaultDatabaseConfig = populateDefaultDatabaseConfig;
        window.handleSaveDatabaseConfig = handleSaveDatabaseConfig;
        window.resetDatabaseConfig = resetDatabaseConfig;

        // ========== Export/Import Functions ==========
        function exportData() {
            // عرض خيارات التصدير
            const options = confirm(currentLang === 'ar' ? 
                'اختر نوع التصدير:\n\nOK = Excel\nCancel = JSON' :
                'Choose export type:\n\nOK = Excel\nCancel = JSON'
            );
            
            if (options) {
                exportToExcel();
            } else {
                exportToJSON();
            }
        }
        
        async function exportToJSON() {
            try {
                showLoading();
                
                // التأكد من تحميل أحدث البيانات
                await loadCompanySettings();
                await loadPrintSignatures();
                
                const backupData = {
                employeeData: employeeData,
                projects: projects,
                    companySettings: companySettings,
                    printSignatures: printSignatures,
                exportDate: new Date().toISOString(),
                    exportedBy: currentUser?.email || 'unknown',
                    version: '2.1.2'
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
                const dateStr = new Date().toISOString().split('T')[0];
                link.download = `payroll_backup_${dateStr}.json`;
            link.click();
                
                // تنظيف URL
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                hideLoading();
                showNotification('success', 'تم التصدير', 'تم تصدير جميع البيانات بنجاح! ✅');
            } catch (error) {
                hideLoading();
                console.error('Export error:', error);
                showNotification('error', 'خطأ في التصدير', 'حدث خطأ أثناء تصدير البيانات! ❌');
            }
        }
        
        function exportToExcel() {
            console.log('📊 Starting Excel export...');
            console.log('Current view:', currentView);
            console.log('Current month:', currentMonth);
            console.log('Current project:', currentProject);
            
            let data = [];
            let headers = [];
            let totals = null;
            
            if (currentView === 'month') {
                // تصدير بيانات الشهر الكامل
                const monthLabel = currentLang === 'ar' ? 'الشهر' : 'Month';
                const monthName = translations[currentLang].monthNames[currentMonth];
                
                headers = ['#', 
                          currentLang === 'ar' ? 'الاسم' : 'Name', 
                          currentLang === 'ar' ? 'المنصب' : 'Position', 
                          currentLang === 'ar' ? 'النوع' : 'Type', 
                          currentLang === 'ar' ? 'المشروع' : 'Project', 
                          currentLang === 'ar' ? 'الراتب' : 'Salary', 
                          currentLang === 'ar' ? 'عملة الراتب' : 'Salary Currency', 
                          currentLang === 'ar' ? 'عملة الدفع' : 'Payment Currency', 
                          currentLang === 'ar' ? 'سعر الصرف' : 'Exchange Rate', 
                          currentLang === 'ar' ? '⏰ الدوام' : '⏰ Attendance', 
                          currentLang === 'ar' ? 'الراتب اليومي' : 'Daily Salary',
                          currentLang === 'ar' ? 'الفعلي (USD)' : 'Actual (USD)', 
                          currentLang === 'ar' ? 'الفعلي (IQD)' : 'Actual (IQD)', 
                          currentLang === 'ar' ? 'بونص' : 'Bonus', 
                          currentLang === 'ar' ? 'فواتير' : 'Phone Bills', 
                          currentLang === 'ar' ? 'خصومات' : 'Deductions', 
                          currentLang === 'ar' ? 'سلفة' : 'Advance', 
                          currentLang === 'ar' ? 'الصافي (USD)' : 'Net (USD)', 
                          currentLang === 'ar' ? 'الصافي (IQD)' : 'Net (IQD)'];
                
                let totalActualUSD = 0;
                let totalActualIQD = 0;
                let totalBonus = 0;
                let totalPhoneBills = 0;
                let totalDeductions = 0;
                let totalAdvance = 0;
                let totalNetUSD = 0;
                let totalNetIQD = 0;
                
                const employees = (employeeData[currentYear] && employeeData[currentYear][currentMonth]) ? employeeData[currentYear][currentMonth] : [];
                console.log('Employees to export:', employees.length);
                
                employees.forEach((emp, index) => {
                    // استخدام دوال الحساب الجديدة التي تعتمد على الدوام
                    const dailySalaryUSD = calculateDailySalary(emp);
                    const actualUSD = calculateActualSalary(emp);
                    const actualIQD = actualUSD * (parseFloat(emp.exchangeRate) || 1500);
                    const netSalaryValue = calculateNetSalary(emp);
                    
                    // حساب الأيام من الدوام
                    const workDaysFromAttendance = calculateWorkDaysFromAttendance(emp);
                    
                    totalActualUSD += actualUSD;
                    totalActualIQD += actualIQD;
                    totalBonus += parseFloat(emp.bonus) || 0;
                    totalPhoneBills += parseFloat(emp.phoneBills) || 0;
                    totalDeductions += parseFloat(emp.deductions) || 0;
                    totalAdvance += parseFloat(emp.advance) || 0;
                    totalNetUSD += netUSD;
                    totalNetIQD += netIQD;
                    
                    const empName = getEmployeeName(emp);
                    const typeText = getEmployeeTypeText(emp.employeeType || emp.type);
                    
                    // تنسيق عرض الدوام للتصدير
                    const attendance = emp.attendance || {};
                    const attendanceDays = Object.values(attendance);
                    const fullDays = attendanceDays.filter(d => d.type === 'full').length;
                    const halfDays = attendanceDays.filter(d => d.type === 'half').length;
                    const paidLeave = attendanceDays.filter(d => d.type === 'paid-leave').length;
                    const attendanceText = attendanceDays.length > 0 
                        ? `${workDaysFromAttendance.toFixed(1)} (✓${fullDays}${halfDays > 0 ? ` ⊕${halfDays}` : ''}${paidLeave > 0 ? ` 💚${paidLeave}` : ''})` 
                        : '--';
                    
                    data.push([
                        index + 1,
                        empName,
                        emp.position || '',
                        typeText,
                        emp.project || '',
                        emp.salary || 0,
                        emp.salaryCurrency || 'USD',
                        emp.paymentCurrency || 'IQD',
                        emp.exchangeRate || 1500,
                        attendanceText,
                        dailySalaryUSD.toFixed(2),
                        actualUSD.toFixed(2),
                        actualIQD.toFixed(0),
                        emp.bonus || 0,
                        emp.phoneBills || 0,
                        emp.deductions || 0,
                        emp.advance || 0,
                        netSalaryValue.toFixed(2),
                        (netSalaryValue * (emp.exchangeRate || 1500)).toFixed(0)
                    ]);
                });
                
                // إضافة صف المجموع
                const totalLabel = currentLang === 'ar' ? 'المجموع الكلي' : 'Grand Total';
                totals = [
                    '',
                    totalLabel,
                    '',
                    '',
                    '',
                    '',
                    '',
                    '',
                    '',
                    '',
                    '',
                    totalActualUSD.toFixed(2),
                    totalActualIQD.toFixed(0),
                    totalBonus.toFixed(2),
                    totalPhoneBills.toFixed(0),
                    totalDeductions.toFixed(2),
                    totalAdvance.toFixed(2),
                    totalNetUSD.toFixed(2),
                    totalNetIQD.toFixed(0)
                ];
                
            } else if (currentView === 'project') {
                // تصدير بيانات المشروع (للشهر المحدد في الواجهة) مع جميع الأعمدة الظاهرة في الجداول
                const monthLabel = currentLang === 'ar' ? 'الشهر' : 'Month';
                const projectLabel = currentLang === 'ar' ? 'المشروع' : 'Project';
                headers = [
                    '#',
                    currentLang === 'ar' ? 'الاسم' : 'Name',
                    currentLang === 'ar' ? 'المنصب' : 'Position',
                    currentLang === 'ar' ? 'النوع' : 'Type',
                    projectLabel,
                    currentLang === 'ar' ? 'الراتب' : 'Salary',
                    currentLang === 'ar' ? 'عملة الراتب' : 'Salary Currency',
                    currentLang === 'ar' ? 'عملة الدفع' : 'Payment Currency',
                    currentLang === 'ar' ? 'سعر الصرف' : 'Exchange Rate',
                    currentLang === 'ar' ? '⏰ الدوام' : '⏰ Attendance',
                    currentLang === 'ar' ? 'الراتب اليومي' : 'Daily Salary',
                    currentLang === 'ar' ? 'الفعلي (USD)' : 'Actual (USD)',
                    currentLang === 'ar' ? 'الفعلي (IQD)' : 'Actual (IQD)',
                    currentLang === 'ar' ? 'بونص' : 'Bonus',
                    currentLang === 'ar' ? 'عملة البونص' : 'Bonus Currency',
                    currentLang === 'ar' ? 'فواتير' : 'Phone Bills',
                    currentLang === 'ar' ? 'عملة الفواتير' : 'Phone Bills Currency',
                    currentLang === 'ar' ? 'خصومات' : 'Deductions',
                    currentLang === 'ar' ? 'عملة الخصومات' : 'Deductions Currency',
                    currentLang === 'ar' ? 'سلفة' : 'Advance',
                    currentLang === 'ar' ? 'الصافي (USD)' : 'Net (USD)',
                    currentLang === 'ar' ? 'الصافي (IQD)' : 'Net (IQD)',
                    monthLabel
                ];

                const emps = (employeeData[currentYear] && employeeData[currentYear][selectedProjectMonth] ? employeeData[currentYear][selectedProjectMonth] : []).filter(e => e.project === currentProject);
                let totalActualUSD = 0;
                let totalActualIQD = 0;
                let totalBonus = 0;
                let totalPhoneBills = 0;
                let totalDeductions = 0;
                let totalAdvance = 0;
                let totalNetUSD = 0;
                let totalNetIQD = 0;

                emps.forEach((emp, index) => {
                    const typeText = getEmployeeTypeText(emp.employeeType);
                    const empName = getEmployeeName(emp);
                    const dailySalaryUSD = typeof calculateDailySalary === 'function' ? calculateDailySalary(emp) : (emp.employeeType === 'daily' ? (parseFloat(emp.salary) || 0) : 0);
                    const actualSalaryUSD = typeof calculateActualSalary === 'function' ? calculateActualSalary(emp) : (
                        emp.employeeType === 'monthly' ? (parseFloat(emp.salary) || 0) : ((parseFloat(emp.salary) || 0) * (parseFloat(emp.workDays) || 0))
                    );
                    const actualSalaryIQD = actualSalaryUSD * (parseFloat(emp.exchangeRate) || 1500);
                    const netUSD = typeof calculateNetSalary === 'function' ? calculateNetSalary(emp) : (
                        actualSalaryUSD + (parseFloat(emp.bonus) || 0) - (parseFloat(emp.deductions) || 0) - (parseFloat(emp.advance) || 0)
                    );
                    const netIQD = netUSD * (parseFloat(emp.exchangeRate) || 1500) + (parseFloat(emp.phoneBills) || 0);

                    totalActualUSD += actualSalaryUSD;
                    totalActualIQD += actualSalaryIQD;
                    totalBonus += parseFloat(emp.bonus) || 0;
                    totalPhoneBills += parseFloat(emp.phoneBills) || 0;
                    totalDeductions += parseFloat(emp.deductions) || 0;
                    totalAdvance += parseFloat(emp.advance) || 0;
                    totalNetUSD += netUSD;
                    totalNetIQD += netIQD;

                    data.push([
                        index + 1,
                        empName,
                        emp.position || '',
                        typeText,
                        projects[currentProject] || currentProject || '',
                        emp.salary || 0,
                        emp.salaryCurrency || 'USD',
                        emp.paymentCurrency || 'IQD',
                        emp.exchangeRate || 1500,
                        emp.workDays || '-',
                        dailySalaryUSD,
                        actualSalaryUSD.toFixed(2),
                        actualSalaryIQD.toFixed(0),
                        emp.bonus || 0,
                        emp.bonusCurrency || (currentLang === 'ar' ? 'غير محدد' : 'N/A'),
                        emp.phoneBills || 0,
                        emp.phoneBillsCurrency || (currentLang === 'ar' ? 'غير محدد' : 'N/A'),
                        emp.deductions || 0,
                        emp.deductionsCurrency || (currentLang === 'ar' ? 'غير محدد' : 'N/A'),
                        emp.advance || 0,
                        netUSD.toFixed(2),
                        netIQD.toFixed(0),
                        translations[currentLang].monthNames[selectedProjectMonth]
                    ]);
                });

                // صف المجموع
                const totalLabel = currentLang === 'ar' ? 'المجموع الكلي' : 'Grand Total';
                totals = [
                    '',
                    totalLabel,
                    '',
                    '',
                    '',
                    '',
                    '',
                    '',
                    '',
                    '',
                    '',
                    totalActualUSD.toFixed(2),
                    totalActualIQD.toFixed(0),
                    totalBonus.toFixed(2),
                    '',
                    totalPhoneBills.toFixed(2),
                    '',
                    totalDeductions.toFixed(2),
                    '',
                    totalAdvance.toFixed(2),
                    totalNetUSD.toFixed(2),
                    totalNetIQD.toFixed(0),
                    translations[currentLang].monthNames[selectedProjectMonth]
                ];
            }
            
            // التحقق من وجود بيانات
            if (data.length === 0) {
                const noDataMsg = currentLang === 'ar' ? 'لا توجد بيانات للتصدير' : 'No data to export';
                showNotification('warning', currentLang === 'ar' ? 'تحذير' : 'Warning', noDataMsg);
                console.log('⚠️ No data to export');
                return;
            }
            
            console.log('📊 Exporting', data.length, 'rows');
            
            // تحويل البيانات إلى CSV
            let csv = '\uFEFF'; // BOM for UTF-8
            
            // إضافة معلومات التقرير
            const reportTitle = currentLang === 'ar' ? 'تقرير الرواتب' : 'Salary Report';
            const dateLabel = currentLang === 'ar' ? 'التاريخ' : 'Date';
            const userLabel = currentLang === 'ar' ? 'المستخدم' : 'User';
            const currentDate = new Date().toLocaleDateString(currentLang === 'ar' ? 'ar-EG' : 'en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            csv += `"${reportTitle}"\n`;
            csv += `"${dateLabel}: ${currentDate}"\n`;
            csv += `"${userLabel}: ${currentUser?.email || ''}"\n`;
            csv += '\n';
            
            // إضافة headers
            csv += headers.join(',') + '\n';
            
            // إضافة البيانات
            data.forEach(row => {
                csv += row.map(cell => {
                    // معالجة الخلايا التي تحتوي على فواصل أو علامات اقتباس
                    if (typeof cell === 'string' && (cell.includes(',') || cell.includes('"') || cell.includes('\n'))) {
                        return '"' + cell.replace(/"/g, '""') + '"';
                    }
                    return cell;
                }).join(',') + '\n';
            });
            
            // إضافة صف المجموع
            if (totals) {
                csv += '\n';
                csv += totals.map(cell => {
                    if (typeof cell === 'string' && (cell.includes(',') || cell.includes('"') || cell.includes('\n'))) {
                        return '"' + cell.replace(/"/g, '""') + '"';
                    }
                    return cell;
                }).join(',') + '\n';
            }
            
            console.log('✅ CSV generated successfully');
            
            // إنشاء ملف وتحميله
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const fileName = currentLang === 'ar' ? 
                `رواتب_${currentMonth || currentProject}_${new Date().toISOString().split('T')[0]}.csv` :
                `Salaries_${currentMonth || currentProject}_${new Date().toISOString().split('T')[0]}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            const successMsg = currentLang === 'ar' ? 
                `تم تصدير ${data.length} موظف إلى Excel بنجاح! ✅` :
                `Successfully exported ${data.length} employees to Excel! ✅`;
            
            showNotification('success', currentLang === 'ar' ? 'تم التصدير' : 'Exported', successMsg);
            console.log('✅ Export completed:', data.length, 'rows');
        }
        
        function exportToPDF() {
            // سؤال المستخدم عن اتجاه الصفحة
            const useLandscape = confirm(
                'اختر اتجاه الصفحة:\n\n' +
                'OK = أفقي (Landscape) - موصى به للجداول الكبيرة\n' +
                'Cancel = عمودي (Portrait) - للجداول الصغيرة'
            );
            
            // تطبيق اتجاه الصفحة
            const styleId = 'dynamic-print-style';
            let styleElement = document.getElementById(styleId);
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = styleId;
                document.head.appendChild(styleElement);
            }
            
            styleElement.textContent = `
                @media print {
                    @page {
                        size: ${useLandscape ? 'landscape' : 'portrait'};
                        margin: ${useLandscape ? '1cm 0.5cm' : '1.5cm 1cm'};
                    }
                }
            `;
            
            // تحضير الصفحة للطباعة
            const originalTitle = document.title;
            const currentDate = new Date().toLocaleDateString('ar-EG', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const currentTime = new Date().toLocaleTimeString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // تحديد اسم الصفحة
            const monthName = currentMonth ? translations[currentLang].monthNames[currentMonth] : '';
            const projectName = currentProject ? projects[currentProject] : '';
            const pageName = monthName || projectName || 'لوحة التحكم';
            
            document.title = `تقرير_رواتب_${pageName}_${new Date().toISOString().split('T')[0]}`;
            
            // إضافة ترويسة احترافية للطباعة
            let printHeader = document.getElementById('print-main-header');
            if (!printHeader) {
                printHeader = document.createElement('div');
                printHeader.id = 'print-main-header';
                printHeader.className = 'print-only';
                printHeader.style.cssText = `
                    text-align: center; 
                    padding: 20px; 
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                    border: 3px solid #4c5fd5; 
                    border-radius: 8px; 
                    margin-bottom: 20px;
                    -webkit-print-color-adjust: exact;
                    print-color-adjust: exact;
                `;
                printHeader.innerHTML = `
                    <h1 style="color: white; margin: 0 0 10px 0; font-size: 22px; font-weight: 700;">
                        📊 نظام إدارة الرواتب المتقدم
                    </h1>
                    <h2 style="color: rgba(255,255,255,0.95); margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">
                        ${pageName}
                    </h2>
                    <div style="color: rgba(255,255,255,0.9); font-size: 11px; display: flex; justify-content: center; gap: 30px; margin-top: 10px;">
                        <span>📅 ${currentDate}</span>
                        <span>🕐 ${currentTime}</span>
                        <span>👤 ${currentUser?.email || 'غير محدد'}</span>
                    </div>
                `;
                document.body.insertBefore(printHeader, document.body.firstChild);
            }
            
            // إضافة تذييل للطباعة مع التوقيعات - ثابت في أسفل الصفحة
            let printFooter = document.getElementById('print-main-footer');
            if (!printFooter) {
                printFooter = document.createElement('div');
                printFooter.id = 'print-main-footer';
                printFooter.className = 'print-footer print-only';
                
                // بناء قسم التوقيعات
                const sig1Position = printSignatures.sig1Position || '';
                const sig1Name = printSignatures.sig1Name || '';
                const sig2Position = printSignatures.sig2Position || '';
                const sig2Name = printSignatures.sig2Name || '';
                const sig3Position = printSignatures.sig3Position || '';
                const sig3Name = printSignatures.sig3Name || '';
                const sig4Position = printSignatures.sig4Position || '';
                const sig4Name = printSignatures.sig4Name || '';
                
                const signaturesHTML = `
                    <div class="signatures-section">
                        ${sig1Position || sig1Name ? `
                        <div class="signature-box">
                            <div class="title">${sig1Position || ''}</div>
                            <div class="line"></div>
                            <div class="name">${sig1Name || ''}</div>
                        </div>
                        ` : ''}
                        ${sig2Position || sig2Name ? `
                        <div class="signature-box">
                            <div class="title">${sig2Position || ''}</div>
                            <div class="line"></div>
                            <div class="name">${sig2Name || ''}</div>
                        </div>
                        ` : ''}
                        ${sig3Position || sig3Name ? `
                        <div class="signature-box">
                            <div class="title">${sig3Position || ''}</div>
                            <div class="line"></div>
                            <div class="name">${sig3Name || ''}</div>
                        </div>
                        ` : ''}
                        ${sig4Position || sig4Name ? `
                        <div class="signature-box">
                            <div class="title">${sig4Position || ''}</div>
                            <div class="line"></div>
                            <div class="name">${sig4Name || ''}</div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="copyright-info">
                        <strong>© نظام إدارة الرواتب المتقدم 2025</strong> | تاريخ الطباعة: ${currentDate}
                    </div>
                `;
                
                printFooter.innerHTML = signaturesHTML;
                document.body.appendChild(printFooter);
            }
            
            // الطباعة
            setTimeout(() => {
                window.print();
                
                // تنظيف بعد الطباعة
                setTimeout(() => {
                    document.title = originalTitle;
                    // إزالة العناصر المضافة
                    if (printHeader) printHeader.remove();
                    if (printFooter) printFooter.remove();
                }, 1000);
            }, 100);
            
            showNotification('info', 'تصدير PDF', 'اختر "حفظ كـ PDF" من خيارات الطابعة 📄');
        }
        
        // دالة ذكية للطباعة حسب الصفحة الحالية
        function printCurrentPage() {
            // استخدام النظام البسيط الجديد
            const settings = {
                selectedProject: 'all',
                reportType: 'all',
                paymentStatus: 'all',
                orientation: 'landscape',
                pageSize: 'A4'
            };
            printSimple(settings);
        }
        
        // دالة متقدمة لطباعة جداول المشاريع (كل جدول في صفحة منفصلة)
        // تطبع الجداول الثلاثة: شهري 📅، يومي ⏰، سيارة 🚗
        function printProjectTables() {
            console.log('🖨️ بدء طباعة جداول المشاريع (شهري، يومي، سيارة)...');
            
            // استخدام النظام البسيط الجديد
            const settings = {
                selectedProject: currentProject,
                reportType: 'all',
                paymentStatus: 'all',
                orientation: 'landscape',
                pageSize: 'A4'
            };
            printSimple(settings);
            return;
            
            // جمع كل الجداول غير الفارغة
            const tableContainers = document.querySelectorAll('.table-container');
            const nonEmptyTables = [];
            
            console.log(`📊 وجدت ${tableContainers.length} جدول(جداول) في الصفحة`);
            
            tableContainers.forEach(container => {
                const table = container.querySelector('table');
                const tbody = table?.querySelector('tbody');
                
                // تحقق من أن الجدول يحتوي على بيانات (أكثر من صف واحد - صف المجموع)
                if (tbody && tbody.querySelectorAll('tr').length > 1) {
                    // استخراج العنوان من الـ header السابق للجدول
                    const headerDiv = container.previousElementSibling;
                    const title = headerDiv?.querySelector('h3')?.textContent || 'جدول';
                    
                    // تنظيف الجدول وتحويل input/select إلى نص
                    const cleanTable = table.cloneNode(true);
                    
                    console.log('🔧 بدء تنظيف الجدول...');
                    
                    // استبدال input بقيمها النصية (بما فيها المقفولة)
                    const inputs = cleanTable.querySelectorAll('input[type="number"]');
                    console.log(`📝 وجدت ${inputs.length} حقل input`);
                    inputs.forEach((input, idx) => {
                        const value = input.value || '0';
                        const isLocked = input.disabled || input.classList.contains('locked-field');
                        const span = document.createElement('span');
                        span.textContent = value;
                        span.style.cssText = 'display: inline-block; text-align: center;';
                        if (isLocked) {
                            console.log(`🔒 حقل مقفول #${idx + 1}: ${value}`);
                        }
                        input.replaceWith(span);
                    });
                    
                    // استبدال select بقيمها المحددة (بما فيها المقفولة)
                    const selects = cleanTable.querySelectorAll('select');
                    console.log(`📝 وجدت ${selects.length} قائمة select`);
                    selects.forEach((select, idx) => {
                        const value = select.options[select.selectedIndex]?.text || select.value;
                        const isLocked = select.disabled || select.classList.contains('locked-field');
                        const span = document.createElement('span');
                        span.textContent = value;
                        span.style.cssText = 'display: inline-block; text-align: center;';
                        if (isLocked) {
                            console.log(`🔒 قائمة مقفولة #${idx + 1}: ${value}`);
                        }
                        select.replaceWith(span);
                    });
                    
                    // حذف العناصر غير الضرورية فقط
                    cleanTable.querySelectorAll('button, .resizer, input[type="checkbox"]').forEach(el => el.remove());
                    
                    console.log('✅ تم تنظيف الجدول بنجاح');
                    
                    nonEmptyTables.push({
                        table: cleanTable,
                        title: title
                    });
                }
            });
            
            if (nonEmptyTables.length === 0) {
                showNotification('warning', t('warning'), t('noTablesData'));
                return;
            }
            
            // إنشاء نافذة جديدة للطباعة
            const printWindow = window.open('', '_blank');
            
            const currentDate = new Date().toLocaleDateString('ar-EG', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const projectName = currentProject ? projects[currentProject] : '';
            const monthName = selectedProjectMonth ? translations[currentLang].monthNames[selectedProjectMonth] : '';
            
            // بناء HTML محسّن للطباعة
            let htmlContent = '<!DOCTYPE html>';
            htmlContent += '<html lang="ar" dir="rtl">';
            htmlContent += '<head>';
            htmlContent += '<meta charset="UTF-8">';
            htmlContent += '<meta name="viewport" content="width=device-width, initial-scale=1.0">';
            htmlContent += '<title>تقرير ' + projectName + ' - ' + monthName + '</title>';
            htmlContent += '<style>';
            
            // CSS بسيط وموحد للطباعة
            htmlContent += '* { margin: 0; padding: 0; box-sizing: border-box; }';
            htmlContent += '@page { size: A4 landscape; margin: 8mm; }';
            htmlContent += 'body { font-family: "Segoe UI", Tahoma, Arial, sans-serif; background: white; padding: 6px; direction: rtl; }';
            
            // رأس الصفحة - تصميم مصغّر
            htmlContent += '.page-header { text-align: center; padding: 10px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);';
            htmlContent += ' color: white; border-radius: 8px; margin-bottom: 8px;';
            htmlContent += ' -webkit-print-color-adjust: exact; print-color-adjust: exact; page-break-inside: avoid; page-break-after: avoid; }';
            htmlContent += '.page-header h1 { font-size: 13px; margin-bottom: 3px; font-weight: 800; line-height: 1.1; }';
            htmlContent += '.page-header .company { font-size: 9px; margin: 2px 0; font-weight: 700; background: rgba(255,255,255,0.2);';
            htmlContent += ' padding: 2px 10px; border-radius: 10px; display: inline-block; }';
            htmlContent += '.page-header h2 { font-size: 11px; margin: 3px 0; opacity: 0.95; font-weight: 600; }';
            htmlContent += '.page-header .info { font-size: 7px; opacity: 0.9; margin-top: 3px; font-weight: 500; }';
            
            // قسم الجدول - فصل احترافي (شهري، يومي، سيارة)
            htmlContent += '.table-section { page-break-after: always; page-break-inside: avoid; margin-bottom: 15px; }';
            htmlContent += '.table-section:last-child { page-break-after: auto; }';
            htmlContent += '.section-title { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;';
            htmlContent += ' padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; font-size: 12px; font-weight: 700;';
            htmlContent += ' text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.08);';
            htmlContent += ' -webkit-print-color-adjust: exact; print-color-adjust: exact; page-break-after: avoid; page-break-inside: avoid; }';
            htmlContent += '.section-title::before { content: "📊 "; font-size: 11px; }';
            
            // الجدول - محسّن للجداول العريضة (12+ عمود)
            htmlContent += '.project-print-table { width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 4px;';
            htmlContent += ' margin-bottom: 10px; page-break-inside: auto; border: 2px solid #64748b; max-width: 100%; }';
            htmlContent += 'thead { background: linear-gradient(135deg, #475569 0%, #334155 100%);';
            htmlContent += ' -webkit-print-color-adjust: exact; print-color-adjust: exact; display: table-header-group; }';
            htmlContent += 'thead th { background: linear-gradient(135deg, #475569 0%, #334155 100%); color: white; padding: 2px 1px;';
            htmlContent += ' border: 1px solid #1e293b; font-weight: 700; text-align: center; font-size: 3.5px; white-space: nowrap;';
            htmlContent += ' overflow: hidden; text-overflow: ellipsis; line-height: 1.0; -webkit-print-color-adjust: exact; print-color-adjust: exact; max-width: none; }';
            
            // خلايا الجدول - محسّنة للجداول العريضة
            htmlContent += 'tbody td { padding: 1px 1px; border: 1px solid #cbd5e1; text-align: center; font-size: 3.5px;';
            htmlContent += ' white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.1; color: #1e293b; max-width: none; }';
            htmlContent += 'tbody tr { page-break-inside: avoid; page-break-after: auto; }';
            htmlContent += 'tbody tr:nth-child(even) { background: #f8fafc; -webkit-print-color-adjust: exact; print-color-adjust: exact; }';
            htmlContent += 'tbody tr:nth-child(odd) { background: white; }';
            
            // جدول المجموع النهائي
            htmlContent += '.project-print-totals { width: 100%; border-collapse: collapse; margin: 6px 0 14px 0;';
            htmlContent += ' border: 2px solid #f59e0b; page-break-inside: avoid; }';
            htmlContent += '.project-print-totals td { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);';
            htmlContent += ' color: #92400e; font-weight: 800; font-size: 4px; padding: 3px 4px; border: 1px solid #f59e0b; text-align: center; }';
            
            // التذييل - معلومات إضافية مع التوقيعات (إزالة position: fixed لتظهر في كل صفحة)
            htmlContent += '.page-footer { padding: 15px 15px; margin-top: 24px;';
            htmlContent += ' background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); border-top: 2px solid #cbd5e1;';
            htmlContent += ' -webkit-print-color-adjust: exact; print-color-adjust: exact; page-break-inside: avoid; page-break-before: avoid; page-break-after: avoid; }';
            htmlContent += '.signatures-section { display: flex; justify-content: space-between; margin-bottom: 12px;';
            htmlContent += ' padding: 10px 0; border-bottom: 1px solid #cbd5e1; gap: 20px; page-break-inside: avoid; }';
            htmlContent += '.signature-box { flex: 1; text-align: center; padding: 6px; }';
            htmlContent += '.signature-box .title { font-size: 8px; font-weight: 700; color: #1e293b; margin-bottom: 15px; }';
            htmlContent += '.signature-box .line { border-top: 1.5px solid #64748b; width: 75%; margin: 15px auto 4px; }';
            htmlContent += '.signature-box .name { font-size: 7px; color: #475569; font-weight: 600; }';
            htmlContent += '.copyright-info { text-align: center; font-size: 7px; color: #475569; padding-top: 6px; }';
            htmlContent += '.copyright-info strong { color: #1e293b; font-weight: 700; }';
            
            // إخفاء العناصر التفاعلية والأزرار بشكل شامل
            htmlContent += 'button, .btn, .btn-primary, .btn-success, .btn-warning, .btn-danger, .btn-small, .resizer, .dropdown, .modal, .actions, input[type="checkbox"], select.no-print { display: none !important; visibility: hidden !important; }';
            htmlContent += 'td button, th button, .action-buttons { display: none !important; visibility: hidden !important; }';
            
            // إظهار الأعمدة المخفية إن وجدت
            htmlContent += 'th[style*="display: none"], td[style*="display: none"],';
            htmlContent += ' th[style*="display:none"], td[style*="display:none"], .hidden-column { display: table-cell !important; visibility: visible !important; }';
            
            // تحسينات الطباعة النهائية
            htmlContent += '@media print {';
            htmlContent += '  * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }';
            htmlContent += '  body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }';
            htmlContent += '  .page-header { page-break-after: avoid; page-break-inside: avoid; }';
            htmlContent += '  .section-title { page-break-after: avoid; page-break-inside: avoid; }';
            htmlContent += '  table { page-break-inside: auto; }';
            htmlContent += '  tr { page-break-inside: avoid; page-break-after: auto; }';
            htmlContent += '  tbody tr:last-child { page-break-inside: avoid; }';
            htmlContent += '  thead { display: table-header-group; }';
            htmlContent += '  tfoot { display: table-row-group; }';
            htmlContent += '  tfoot, .total-row, .total-summary { page-break-inside: avoid; page-break-before: auto; }';
            htmlContent += '  @page { margin: 8mm; }';
            htmlContent += '}';
            
            htmlContent += '</style>';
            htmlContent += '</head>';
            htmlContent += '<body>';
            
            // إضافة الرأس مرة واحدة في البداية
            htmlContent += '<div class="page-header">';
            htmlContent += '<h1>📊 نظام إدارة الرواتب المتقدم</h1>';
            htmlContent += '<div class="company">🏢 ROSEMARY COMPANY</div>';
            htmlContent += '<h2>مشروع: ' + projectName + ' | الشهر: ' + monthName + '</h2>';
            htmlContent += '<div class="info">';
            htmlContent += '📅 ' + currentDate + ' | 🕐 ' + new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) + ' | ';
            htmlContent += '👤 ' + (currentUser?.email || 'غير محدد');
            htmlContent += '</div>';
            htmlContent += '</div>';
            
            // الحصول على HTML التوقيعات مرة واحدة
            const signaturesHTML = getSignaturesHTML();
            console.log('🖨️ [printProjectTables] HTML التوقيعات:', signaturesHTML ? 'موجود (' + signaturesHTML.length + ' حرف)' : 'فارغ');
            
            // إضافة كل جدول مع التوقيعات بعده
            nonEmptyTables.forEach((item, index) => {
                htmlContent += '<div class="table-section">';
                htmlContent += '<div class="section-title">' + item.title + '</div>';

                const tableClone = item.table.cloneNode(true);
                tableClone.classList.add('project-print-table');

                let footerHTML = '';
                const tableFooter = tableClone.querySelector('tfoot');
                if (tableFooter) {
                    footerHTML = tableFooter.innerHTML;
                    tableFooter.remove();
                }

                htmlContent += tableClone.outerHTML;
                if (footerHTML) {
                    htmlContent += '<table class="project-print-totals"><tbody>' + footerHTML + '</tbody></table>';
                }
            
                // إضافة التذييل مع التوقيعات بعد كل جدول
            htmlContent += '<div class="page-footer">';
            htmlContent += signaturesHTML;
            htmlContent += '<div class="copyright-info">';
            htmlContent += '<strong>Powered by ROSEMARY</strong> - نظام إدارة الرواتب المتقدم | ';
            htmlContent += 'تاريخ الطباعة: ' + currentDate + ' | ';
                htmlContent += 'جدول ' + (index + 1) + ' من ' + nonEmptyTables.length;
                htmlContent += '</div></div>';
                
                htmlContent += '</div>'; // نهاية table-section
            });
            
            // إضافة سكريبت الطباعة التلقائية
            htmlContent += '<scr' + 'ipt>';
            htmlContent += 'window.onload = function() {';
            htmlContent += '  setTimeout(function() {';
            htmlContent += '    window.print();';
            htmlContent += '  }, 1000);';
            htmlContent += '};';
            htmlContent += '</scr' + 'ipt>';
            htmlContent += '</body>';
            htmlContent += '</html>';
            
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            // رسالة توضيحية
            const tableTypes = nonEmptyTables.map(t => t.title).join(' + ');
            console.log('✅ تم تجهيز الطباعة:', tableTypes);
            showNotification('success', '✅ جاهز للطباعة', 
                `سيتم طباعة ${nonEmptyTables.length} جدول (${tableTypes}) - كل جدول في صفحة منفصلة 📄`);
        }
        
        // دالة لتصدير جدول معين فقط
        function exportTableToPDF(tableElement) {
            if (!tableElement) {
                showNotification('error', 'خطأ', 'لم يتم العثور على الجدول');
                return;
            }
            
            // نسخ الجدول وتحويل input/select إلى نص
            const clonedTable = tableElement.cloneNode(true);
            
            console.log('🔧 [exportTableToPDF] بدء تنظيف الجدول...');
            
            // استبدال input بقيمها النصية (بما فيها المقفولة)
            const inputs = clonedTable.querySelectorAll('input[type="number"]');
            console.log(`📝 وجدت ${inputs.length} حقل input`);
            inputs.forEach((input, idx) => {
                const value = input.value || '0';
                const isLocked = input.disabled || input.classList.contains('locked-field');
                const span = document.createElement('span');
                span.textContent = value;
                span.style.cssText = 'display: block; text-align: center; font-size: 6.5px;';
                if (isLocked) {
                    console.log(`🔒 حقل مقفول #${idx + 1}: ${value}`);
                }
                input.replaceWith(span);
            });
            
            // استبدال select بقيمها المحددة (بما فيها المقفولة)
            const selects = clonedTable.querySelectorAll('select');
            console.log(`📝 وجدت ${selects.length} قائمة select`);
            selects.forEach((select, idx) => {
                const value = select.options[select.selectedIndex]?.text || select.value;
                const isLocked = select.disabled || select.classList.contains('locked-field');
                const span = document.createElement('span');
                span.textContent = value;
                span.style.cssText = 'display: block; text-align: center; font-size: 6.5px;';
                if (isLocked) {
                    console.log(`🔒 قائمة مقفولة #${idx + 1}: ${value}`);
                }
                select.replaceWith(span);
            });
            
            // حذف العناصر غير الضرورية فقط
            clonedTable.querySelectorAll('button, .resizer, input[type="checkbox"]').forEach(el => el.remove());
            
            console.log('✅ تم تنظيف الجدول بنجاح');
            
            clonedTable.classList.add('print-main-table');
            let footerHTML = '';
            const clonedFooter = clonedTable.querySelector('tfoot');
            if (clonedFooter) {
                footerHTML = clonedFooter.innerHTML;
                clonedFooter.remove();
            }
            
            // إنشاء نافذة جديدة للطباعة
            const printWindow = window.open('', '_blank');
            
            const currentDate = new Date().toLocaleDateString('ar-EG', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const monthName = currentMonth ? translations[currentLang].monthNames[currentMonth] : '';
            const projectName = currentProject ? projects[currentProject] : '';
            const pageName = monthName || projectName || 'تقرير';
            
            let htmlContent = '<!DOCTYPE html>' +
                '<html lang="ar" dir="rtl">' +
                '<head>' +
                    '<meta charset="UTF-8">' +
                    '<meta name="viewport" content="width=device-width, initial-scale=1.0">' +
                    '<title>تقرير ' + pageName + '</title>' +
                    '<style>' +
                        '* { margin: 0; padding: 0; box-sizing: border-box; }' +
                        '@page { size: A4 landscape; margin: 8mm; }' +
                        'body { font-family: "Segoe UI", Tahoma, Arial, sans-serif; background: white; padding: 8px; direction: rtl; }' +
                        '.print-header { text-align: center; padding: 10px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);' +
                        ' color: white; border-radius: 8px; margin-bottom: 8px;' +
                        ' -webkit-print-color-adjust: exact; print-color-adjust: exact; page-break-inside: avoid; page-break-after: avoid; }' +
                        '.print-header h1 { font-size: 13px; margin-bottom: 3px; font-weight: 800; line-height: 1.1; }' +
                        '.print-header h2 { font-size: 11px; margin: 3px 0; opacity: 0.95; font-weight: 600; }' +
                        '.print-header .company { font-size: 9px; margin: 2px 0; font-weight: 700; background: rgba(255,255,255,0.2);' +
                        ' padding: 2px 10px; border-radius: 10px; display: inline-block; }' +
                        '.print-header .info { font-size: 7px; opacity: 0.9; margin-top: 3px; font-weight: 500; }' +
                        'table { width: 100%; border-collapse: collapse; table-layout: auto; font-size: 7px; margin-bottom: 10px;' +
                        ' page-break-inside: auto; border: 2px solid #64748b; }' +
                        'thead { background: linear-gradient(135deg, #475569 0%, #334155 100%);' +
                        ' -webkit-print-color-adjust: exact; print-color-adjust: exact; display: table-header-group; }' +
                        'thead th { background: linear-gradient(135deg, #475569 0%, #334155 100%); color: white; padding: 7px 4px;' +
                        ' border: 1px solid #1e293b; font-weight: 700; text-align: center; font-size: 7px; white-space: normal;' +
                        ' word-wrap: break-word; line-height: 1.3; -webkit-print-color-adjust: exact; print-color-adjust: exact; }' +
                        'tbody td { padding: 5px 3px; border: 1px solid #cbd5e1; text-align: center; font-size: 6.5px;' +
                        ' white-space: normal; word-wrap: break-word; line-height: 1.4; color: #1e293b; }' +
                        '@media print { body { padding-bottom: 140px !important; } .print-footer { position: fixed; bottom: 0; left: 0; right: 0; height: 120px; background: white; border-top: 2px solid #667eea; padding: 8px; page-break-inside: avoid; } .signatures-section { position: fixed; bottom: 0; left: 0; right: 0; height: 120px; background: white; padding: 8px 15px; page-break-inside: avoid; } }' +
                        'tbody tr { page-break-inside: avoid; page-break-after: auto; }' +
                        'tbody tr:nth-child(even) { background: #f8fafc; -webkit-print-color-adjust: exact; print-color-adjust: exact; }' +
                        'tbody tr:nth-child(odd) { background: white; }' +
                        'tbody tr:last-child { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;' +
                        ' font-weight: 800; border-top: 3px solid #f59e0b !important; border-bottom: 3px solid #f59e0b !important;' +
                        ' -webkit-print-color-adjust: exact; print-color-adjust: exact; page-break-inside: avoid; }' +
                        'tbody tr:last-child td { color: #92400e !important; font-weight: 800; font-size: 8px; padding: 7px 4px;' +
                        ' background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important; }' +
                        '.print-footer { padding: 15px 15px; margin-top: 24px;' +
                        ' background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); border-top: 2px solid #cbd5e1;' +
                        ' -webkit-print-color-adjust: exact; print-color-adjust: exact; page-break-inside: avoid; page-break-before: avoid; page-break-after: avoid; }' +
                        '.signatures-section { display: flex; justify-content: space-between; margin-bottom: 12px;' +
                        ' padding: 10px 0; border-bottom: 1px solid #cbd5e1; gap: 20px; page-break-inside: avoid; }' +
                        '.signature-box { flex: 1; text-align: center; padding: 6px; }' +
                        '.signature-box .title { font-size: 8px; font-weight: 700; color: #1e293b; margin-bottom: 15px; }' +
                        '.signature-box .line { border-top: 1.5px solid #64748b; width: 75%; margin: 15px auto 4px; }' +
                        '.signature-box .name { font-size: 7px; color: #475569; font-weight: 600; }' +
                        '@media print { body { padding-bottom: 140px !important; } }' +
                        '.copyright-info { text-align: center; font-size: 7px; color: #475569; padding-top: 6px; }' +
                        '.copyright-info strong { color: #1e293b; font-weight: 700; }' +
                        'button, .btn, .resizer, .dropdown, .modal { display: none !important; visibility: hidden !important; }' +
                        'th[style*="display: none"], td[style*="display: none"], th[style*="display:none"], td[style*="display:none"], .hidden-column { display: table-cell !important; visibility: visible !important; }' +
                        '@media print {' +
                        '  * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }' +
                        '  body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }' +
                        '  .print-header { page-break-after: avoid; page-break-inside: avoid; }' +
                        '  table { page-break-inside: auto; }' +
                        '  tr { page-break-inside: avoid; page-break-after: auto; }' +
                        '  tbody tr:last-child { page-break-inside: avoid; }' +
                        '  thead { display: table-header-group; }' +
                        '  @page { margin: 8mm; }' +
                        '}' +
                '</style>' +
                '<style>.print-main-table tbody tr:last-child{background:none!important;border-top:1px solid #cbd5e1!important;border-bottom:1px solid #cbd5e1!important;color:#1e293b!important;}' +
                '.print-main-table tbody tr:last-child td{background:none!important;}' +
                '.print-total-table{width:100%;border-collapse:collapse;margin:8px 0 16px 0;border:2px solid #f59e0b;page-break-inside:avoid;}' +
                '.print-total-table td{background:linear-gradient(135deg,#fef3c7 0%,#fde68a 100%);color:#92400e;font-weight:800;font-size:8px;padding:7px 4px;border:1px solid #f59e0b;text-align:center;}' +
                '</style>' +
                '</head>' +
                '<body>' +
                    '<div class="print-header">' +
                        '<h1>📊 نظام إدارة الرواتب المتقدم</h1>' +
                        '<h2>' + pageName + '</h2>' +
                        '<div class="company">🏢 ROSEMARY COMPANY</div>' +
                    '<div class="info">' +
                        '📅 ' + currentDate + ' | 🕐 ' + new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) + ' | ' +
                        '👤 ' + (currentUser?.email || 'غير محدد') +
                    '</div>' +
                    '</div>' +
                    clonedTable.outerHTML;

            if (footerHTML) {
                htmlContent += '<table class="print-total-table"><tbody>' + footerHTML + '</tbody></table>';
            }
            
            // إضافة التوقيعات
            const signaturesHTML2 = getSignaturesHTML();
            console.log('🖨️ [exportTableToPDF] HTML التوقيعات:', signaturesHTML2 ? 'موجود (' + signaturesHTML2.length + ' حرف)' : 'فارغ');
            
            htmlContent += '<div class="print-footer">' +
                    signaturesHTML2 +
                    '<div class="copyright-info"><strong>Powered by ROSEMARY</strong> - نظام إدارة الرواتب المتقدم | تاريخ الطباعة: ' + currentDate + '</div>' +
                '</div>' +
                    '<scr' + 'ipt>' +
                        'window.onload = function() {' +
                            'setTimeout(function() {' +
                                'window.print();' +
                                'setTimeout(function() { window.close(); }, 500);' +
                            '}, 500);' +
                        '};' +
                    '</scr' + 'ipt>' +
                '</body>' +
                '</html>';
            
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            showNotification('success', '✅ جاهز للطباعة', 'تم فتح نافذة الطباعة بنجاح - يمكنك الحفظ كـ PDF أو الطباعة مباشرة 📄');
        }

        // ========================================================================
        // ======================== نظام التوقيعات ===============================
        // ========================================================================
        
        // فتح نافذة إعدادات التوقيعات وتحميل البيانات المحفوظة
        function openSignaturesModal() {
            console.log('✍️ فتح نافذة إعدادات التوقيعات');
            
            // استخدام التوقيعات المحملة من Firebase
            const signatures = printSignatures;
            
            // ملء الحقول بالبيانات المحفوظة
            document.getElementById('signature1Position').value = signatures.sig1Position || '';
            document.getElementById('signature1Name').value = signatures.sig1Name || '';
            document.getElementById('signature2Position').value = signatures.sig2Position || '';
            document.getElementById('signature2Name').value = signatures.sig2Name || '';
            document.getElementById('signature3Position').value = signatures.sig3Position || '';
            document.getElementById('signature3Name').value = signatures.sig3Name || '';
            document.getElementById('signature4Position').value = signatures.sig4Position || '';
            document.getElementById('signature4Name').value = signatures.sig4Name || '';
            
            openModal('signaturesModal');
        }
        
        // حفظ إعدادات التوقيعات
        async function saveSignatures() {
            const signatures = {
                sig1Position: document.getElementById('signature1Position').value.trim(),
                sig1Name: document.getElementById('signature1Name').value.trim(),
                sig2Position: document.getElementById('signature2Position').value.trim(),
                sig2Name: document.getElementById('signature2Name').value.trim(),
                sig3Position: document.getElementById('signature3Position').value.trim(),
                sig3Name: document.getElementById('signature3Name').value.trim(),
                sig4Position: document.getElementById('signature4Position').value.trim(),
                sig4Name: document.getElementById('signature4Name').value.trim()
            };
            
            // التحقق من أن هناك على الأقل منصب واحد
            const hasSignatures = signatures.sig1Position || signatures.sig2Position || 
                                 signatures.sig3Position || signatures.sig4Position;
            
            if (!hasSignatures) {
                showNotification('warning', 'تنبيه', 'الرجاء إدخال منصب واحد على الأقل');
                return;
            }
            
            showLoading();
            const success = await savePrintSignatures(signatures);
            hideLoading();
            
            if (success) {
            console.log('✅ تم حفظ إعدادات التوقيعات:', signatures);
            closeModal('signaturesModal');
            showNotification('success', 'تم الحفظ', 'تم حفظ ' + 
                    (Object.values(signatures).filter(v => v).length) + ' حقل(حقول) للتوقيعات في قاعدة البيانات ✅');
            } else {
                showNotification('error', '❌ خطأ', 'فشل في حفظ التوقيعات');
            }
        }
        
        // دالة للتحقق من وجود توقيعات محفوظة
        function checkSignatures() {
            const count = [printSignatures.sig1Position, printSignatures.sig2Position, 
                          printSignatures.sig3Position, printSignatures.sig4Position]
                          .filter(p => p).length;
            
            if (count > 0) {
                console.log('✅ يوجد ' + count + ' توقيع(توقيعات) محفوظة');
                return true;
            } else {
                console.log('⚠️ لا توجد توقيعات محفوظة. اضغط على زر ✍️ التوقيعات لإعدادها');
                return false;
            }
        }
        
        // إنشاء HTML التوقيعات للطباعة
        function getSignaturesHTML() {
            try {
                const signatures = printSignatures;
                
                console.log('📝 قراءة التوقيعات:', signatures);
                
                // إذا لم يكن هناك أي توقيعات محددة، لا تُرجع شيء
                if (!signatures.sig1Position && !signatures.sig2Position && 
                    !signatures.sig3Position && !signatures.sig4Position) {
                    console.log('⚠️ لا توجد توقيعات محفوظة');
                    return '';
                }
                
                let html = '<div style="margin-top: 40px; page-break-inside: avoid;">';
                html += '<div style="display: flex; justify-content: space-around; align-items: flex-start; gap: 20px; flex-wrap: wrap;">';
                console.log('✅ تم إنشاء HTML التوقيعات');
            
            // التوقيع الأول
            if (signatures.sig1Position) {
                    html += '<div style="text-align: center; min-width: 150px; flex: 1;">';
                    html += '<div style="font-size: 11px; font-weight: 600; margin-bottom: 5px; color: #333;">' + signatures.sig1Position + '</div>';
                    html += '<div style="border-top: 1px solid #000; width: 100%; margin: 40px 0 8px 0;"></div>';
                if (signatures.sig1Name) {
                        html += '<div style="font-size: 10px; color: #666;">' + signatures.sig1Name + '</div>';
                }
                html += '</div>';
            }
            
            // التوقيع الثاني
            if (signatures.sig2Position) {
                    html += '<div style="text-align: center; min-width: 150px; flex: 1;">';
                    html += '<div style="font-size: 11px; font-weight: 600; margin-bottom: 5px; color: #333;">' + signatures.sig2Position + '</div>';
                    html += '<div style="border-top: 1px solid #000; width: 100%; margin: 40px 0 8px 0;"></div>';
                if (signatures.sig2Name) {
                        html += '<div style="font-size: 10px; color: #666;">' + signatures.sig2Name + '</div>';
                }
                html += '</div>';
            }
            
            // التوقيع الثالث
            if (signatures.sig3Position) {
                    html += '<div style="text-align: center; min-width: 150px; flex: 1;">';
                    html += '<div style="font-size: 11px; font-weight: 600; margin-bottom: 5px; color: #333;">' + signatures.sig3Position + '</div>';
                    html += '<div style="border-top: 1px solid #000; width: 100%; margin: 40px 0 8px 0;"></div>';
                if (signatures.sig3Name) {
                        html += '<div style="font-size: 10px; color: #666;">' + signatures.sig3Name + '</div>';
                }
                html += '</div>';
            }
            
            // التوقيع الرابع
            if (signatures.sig4Position) {
                    html += '<div style="text-align: center; min-width: 150px; flex: 1;">';
                    html += '<div style="font-size: 11px; font-weight: 600; margin-bottom: 5px; color: #333;">' + signatures.sig4Position + '</div>';
                    html += '<div style="border-top: 1px solid #000; width: 100%; margin: 40px 0 8px 0;"></div>';
                if (signatures.sig4Name) {
                        html += '<div style="font-size: 10px; color: #666;">' + signatures.sig4Name + '</div>';
                }
                html += '</div>';
            }
            
                html += '</div></div>';
                
                return html;
            } catch (error) {
                console.error('❌ خطأ في إنشاء HTML التوقيعات:', error);
                return '';
            }
        }

        // ========================================================================
        // ==================== نظام الطباعة المحسّن والموحد ====================
        // ========================================================================
        // نظام طباعة احترافي متكامل يوفر:
        // ✅ طباعة مباشرة عبر window.print()
        // ✅ طباعة متقدمة مع خيارات مخصصة (اتجاه، حجم، قوالب)
        // ✅ معاينة قبل الطباعة
        // ✅ دعم الطباعة بالألوان والأبيض والأسود
        // ✅ تنسيقات متعددة (احترافي، بسيط، رسمي)
        // ✅ حفظ كملف PDF
        // ========================================================================
        
        // متغير لحفظ إعدادات الطباعة الحالية
        let currentPrintSettings = null;
        
        function openPrintOptionsModal() {
            console.log('🖨️ فتح نافذة الطباعة البسيطة');
            
            // ملء قائمة المشاريع
            const projectSelect = document.getElementById('printProjectSelect');
            projectSelect.innerHTML = '<option value="all">جميع المشاريع</option>';
            
            // إضافة جميع المشاريع
            Object.entries(projects).forEach(([key, name]) => {
                const isSelected = (currentView === 'project' && key === currentProject) ? 'selected' : '';
                projectSelect.innerHTML += `<option value="${key}" ${isSelected}>${name}</option>`;
            });
            
            openModal('printOptionsModal');
        }
        
        function executePrintWithOptions(showPreview) {
            console.log('⚙️ تنفيذ الطباعة البسيطة');
            
            // جمع الإعدادات البسيطة
            const settings = {
                selectedProject: document.getElementById('printProjectSelect').value,
                reportType: document.getElementById('printReportType').value,
                paymentStatus: document.getElementById('printPaymentStatus').value,
                orientation: document.querySelector('input[name="printOrientation"]:checked').value,
                pageSize: document.querySelector('input[name="printPageSize"]:checked').value
            };
            
            closeModal('printOptionsModal');
            
            // طباعة بسيطة
            printSimple(settings);
        }
        
        // دالة معاينة الطباعة مع إمكانية تعديل عرض الأعمدة
        function openPrintPreview() {
            console.log('👁️ فتح معاينة الطباعة');
            
            // جمع الإعدادات
            const settings = {
                selectedProject: document.getElementById('printProjectSelect').value,
                reportType: document.getElementById('printReportType').value,
                paymentStatus: document.getElementById('printPaymentStatus').value,
                orientation: document.querySelector('input[name="printOrientation"]:checked').value,
                pageSize: document.querySelector('input[name="printPageSize"]:checked').value
            };
            
            // إنشاء نافذة المعاينة
            const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            
            // جمع البيانات
            let employeesToPrint = [];
            if (currentView === 'project') {
                employeesToPrint = employeeData[currentYear][selectedProjectMonth || currentMonth].filter(emp => 
                    emp.project === currentProject
                );
            } else {
                if (settings.selectedProject === 'all') {
                    employeesToPrint = employeeData[currentYear][currentMonth];
                } else {
                    employeesToPrint = employeeData[currentYear][currentMonth].filter(emp => 
                        emp.project === settings.selectedProject
                    );
                }
            }
            
            // تصفية حسب نوع الموظف
            let filteredEmployees = employeesToPrint;
            if (settings.reportType !== 'all') {
                filteredEmployees = employeesToPrint.filter(emp => {
                    if (settings.reportType === 'monthly') return emp.employeeType === 'monthly';
                    if (settings.reportType === 'daily') return emp.employeeType === 'daily';
                    if (settings.reportType === 'vehicle') return emp.employeeType === 'vehicle';
                    return true;
                });
            }
            
            // تصفية حسب حالة الدفع
            if (settings.paymentStatus && settings.paymentStatus !== 'all') {
                filteredEmployees = filteredEmployees.filter(emp => {
                    if (settings.paymentStatus === 'paid') return emp.isPaid === true;
                    if (settings.paymentStatus === 'unpaid') return !emp.isPaid;
                    return true;
                });
            }
            
            if (filteredEmployees.length === 0) {
                showNotification('warning', 'تحذير', 'لا توجد بيانات للطباعة');
                return;
            }
            
            const currentDate = new Date().toLocaleDateString('ar-EG');
            
            let html = '<!DOCTYPE html><html dir="rtl"><head><meta charset="UTF-8">';
            html += '<title>معاينة الطباعة</title>';
            html += '<style>';
            html += 'body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }';
            html += '.preview-container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }';
            html += '.header { text-align: center; margin-bottom: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px; }';
            html += '.header h1 { margin: 0; font-size: 18px; color: #333; }';
            html += '.header h2 { margin: 5px 0; font-size: 14px; color: #666; }';
            html += '.controls { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }';
            html += '.controls h3 { margin: 0 0 10px 0; color: #1976d2; }';
            html += '.column-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }';
            html += '.column-control { display: flex; align-items: center; gap: 8px; }';
            html += '.column-control label { font-size: 12px; min-width: 80px; }';
            html += '.column-control input { width: 60px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; }';
            html += 'table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }';
            html += 'th, td { border: 1px solid #ccc; padding: 4px; text-align: center; font-size: 10px; }';
            html += 'th { background: #e0e0e0; font-weight: bold; }';
            html += '.section-title { background: #007bff; color: white; padding: 8px; margin: 20px 0 10px 0; font-weight: bold; }';
            html += '.signatures { margin-top: 30px; display: flex; justify-content: space-between; }';
            html += '.signature-box { text-align: center; width: 20%; }';
            html += '.signature-line { border-top: 1px solid #000; margin-top: 30px; }';
            html += '.print-btn { background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin: 10px 5px; }';
            html += '.print-btn:hover { background: #218838; }';
            html += '</style></head><body>';
            
            html += '<div class="preview-container">';
            
            // رأس التقرير من الإعدادات
            const headerInfo = getHeaderInfo();
            const isArabic = currentLang === 'ar';
            
            html += '<div class="header">';
            
            // اللوغو
            if (headerInfo.companyLogo) {
                html += '<div style="text-align: center; margin-bottom: 15px;">';
                html += '<img src="' + headerInfo.companyLogo + '" style="max-width: 100px; max-height: 100px; object-fit: contain;">';
                html += '</div>';
            }
            
            // اسم الشركة
            html += '<h1 style="margin: 10px 0; font-size: 20px; color: #333;">' + headerInfo.companyName + '</h1>';
            
            // معلومات الشركة
            if (headerInfo.companyAddress) {
                html += '<p style="font-size: 11px; margin: 5px 0;">📍 ' + headerInfo.companyAddress + '</p>';
            }
            if (headerInfo.companyPhone) {
                html += '<p style="font-size: 11px; margin: 5px 0;">📞 ' + headerInfo.companyPhone + '</p>';
            }
            if (headerInfo.companyEmail) {
                html += '<p style="font-size: 11px; margin: 5px 0;">📧 ' + headerInfo.companyEmail + '</p>';
            }
            
            // عنوان التقرير
            html += '<h2 style="margin: 15px 0 10px 0; font-size: 16px; color: #007bff;">' + headerInfo.systemName + '</h2>';
            if (settings.selectedProject !== 'all') {
                html += '<h2>مشروع: ' + projects[settings.selectedProject] + '</h2>';
            }
            const monthToShow = currentView === 'project' ? (selectedProjectMonth || currentMonth) : currentMonth;
            html += '<h2>الشهر: ' + translations[currentLang].monthNames[monthToShow] + '</h2>';
            html += '<h2>تاريخ الطباعة: ' + currentDate + '</h2>';
            html += '</div>';
            
            // أدوات التحكم في عرض الأعمدة
            html += '<div class="controls">';
            html += '<h3>🎛️ تحكم في عرض الأعمدة</h3>';
            html += '<div class="column-controls">';
            html += '<div class="column-control"><label>الرقم:</label><input type="number" value="30" min="20" max="100" onchange="adjustColumnWidth(0, this.value)"></div>';
            html += '<div class="column-control"><label>الاسم:</label><input type="number" value="120" min="80" max="200" onchange="adjustColumnWidth(1, this.value)"></div>';
            html += '<div class="column-control"><label>المنصب:</label><input type="number" value="80" min="60" max="150" onchange="adjustColumnWidth(2, this.value)"></div>';
            html += '<div class="column-control"><label>المشروع:</label><input type="number" value="80" min="60" max="150" onchange="adjustColumnWidth(3, this.value)"></div>';
            html += '<div class="column-control"><label>الراتب:</label><input type="number" value="60" min="40" max="120" onchange="adjustColumnWidth(4, this.value)"></div>';
            html += '<div class="column-control"><label>ع.راتب:</label><input type="number" value="50" min="40" max="80" onchange="adjustColumnWidth(5, this.value)"></div>';
            html += '<div class="column-control"><label>الصرف:</label><input type="number" value="50" min="40" max="100" onchange="adjustColumnWidth(6, this.value)"></div>';
            html += '<div class="column-control"><label>بونص:</label><input type="number" value="50" min="40" max="100" onchange="adjustColumnWidth(7, this.value)"></div>';
            html += '<div class="column-control"><label>ع.بونص:</label><input type="number" value="50" min="40" max="80" onchange="adjustColumnWidth(8, this.value)"></div>';
            html += '<div class="column-control"><label>فواتير:</label><input type="number" value="50" min="40" max="100" onchange="adjustColumnWidth(9, this.value)"></div>';
            html += '<div class="column-control"><label>ع.فواتير:</label><input type="number" value="50" min="40" max="80" onchange="adjustColumnWidth(10, this.value)"></div>';
            html += '<div class="column-control"><label>خصومات:</label><input type="number" value="50" min="40" max="100" onchange="adjustColumnWidth(11, this.value)"></div>';
            html += '<div class="column-control"><label>ع.خصومات:</label><input type="number" value="50" min="40" max="80" onchange="adjustColumnWidth(12, this.value)"></div>';
            html += '<div class="column-control"><label>سلفة:</label><input type="number" value="50" min="40" max="100" onchange="adjustColumnWidth(13, this.value)"></div>';
            html += '<div class="column-control"><label>ع.سلفة:</label><input type="number" value="50" min="40" max="80" onchange="adjustColumnWidth(14, this.value)"></div>';
            html += '<div class="column-control"><label>زيادة:</label><input type="number" value="50" min="40" max="100" onchange="adjustColumnWidth(15, this.value)"></div>';
            html += '<div class="column-control"><label>ع.زيادة:</label><input type="number" value="50" min="40" max="80" onchange="adjustColumnWidth(16, this.value)"></div>';
            html += '<div class="column-control"><label>مكافأة:</label><input type="number" value="50" min="40" max="100" onchange="adjustColumnWidth(17, this.value)"></div>';
            html += '<div class="column-control"><label>ع.مكافأة:</label><input type="number" value="50" min="40" max="80" onchange="adjustColumnWidth(18, this.value)"></div>';
            html += '<div class="column-control"><label>الصافي:</label><input type="number" value="80" min="60" max="120" onchange="adjustColumnWidth(19, this.value)"></div>';
            html += '</div>';
            html += '<button class="print-btn" onclick="printFromPreview()">🖨️ طباعة</button>';
            html += '<button class="print-btn" onclick="window.close()" style="background: #6c757d;">❌ إغلاق</button>';
            html += '</div>';
            
            // تقسيم الموظفين حسب النوع
            const monthlyEmps = filteredEmployees.filter(emp => emp.employeeType === 'monthly');
            const dailyEmps = filteredEmployees.filter(emp => emp.employeeType === 'daily');
            const vehicleEmps = filteredEmployees.filter(emp => emp.employeeType === 'vehicle');
            
            // طباعة الموظفين الشهريين
            if (monthlyEmps.length > 0 && (settings.reportType === 'all' || settings.reportType === 'monthly')) {
                html += '<div class="section-title">الموظفون الشهريون</div>';
                html += generatePreviewTable(monthlyEmps, 'monthly');
            }
            
            // طباعة الموظفين اليوميين
            if (dailyEmps.length > 0 && (settings.reportType === 'all' || settings.reportType === 'daily')) {
                html += '<div class="section-title">الموظفون اليوميون</div>';
                html += generatePreviewTable(dailyEmps, 'daily');
            }
            
            // طباعة السيارات
            if (vehicleEmps.length > 0 && (settings.reportType === 'all' || settings.reportType === 'vehicle')) {
                html += '<div class="section-title">السيارات</div>';
                html += generatePreviewTable(vehicleEmps, 'vehicle');
            }
            
            // التوقيعات من الإعدادات
            html += getSignaturesHTML();
            
            html += '</div></body></html>';
            
            // إضافة JavaScript للمعاينة
            html += '<scr' + 'ipt>';
            html += 'function adjustColumnWidth(columnIndex, width) {';
            html += '    const table = document.querySelector("table");';
            html += '    if (table) {';
            html += '        const rows = table.querySelectorAll("tr");';
            html += '        rows.forEach(row => {';
            html += '            const cell = row.cells[columnIndex];';
            html += '            if (cell) cell.style.width = width + "px";';
            html += '        });';
            html += '    }';
            html += '}';
            html += 'function printFromPreview() {';
            html += '    window.print();';
            html += '}';
            html += '</scr' + 'ipt>';
            
            previewWindow.document.write(html);
            previewWindow.document.close();
        }
        
        // دالة جلب معلومات رأس الصفحة من الإعدادات
        function getHeaderInfo() {
            const isArabic = currentLang === 'ar';
            const companyName = isArabic 
                ? (companySettings.companyNameAr || companySettings.companyNameEn || 'شركة غير محددة')
                : (companySettings.companyNameEn || companySettings.companyNameAr || 'Company Name');
            
            return {
                companyName: companyName,
                companyLogo: companySettings.companyLogo || '',
                companyAddress: companySettings.companyAddress || '',
                companyPhone: companySettings.companyPhone || '',
                companyEmail: companySettings.companyEmail || '',
                systemName: isArabic ? 'نظام إدارة الرواتب' : 'Salary Management System',
                additionalInfo: ''
            };
        }
        
        // دالة إنشاء جدول المعاينة مع جميع الأعمدة
        function generatePreviewTable(employees, type) {
            let html = '<table>';
            
            // رأس الجدول مع جميع الأعمدة
            html += '<thead><tr>';
            html += '<th>#</th><th>الاسم</th><th>المنصب</th><th>المشروع</th>';
            html += '<th>الراتب</th><th>ع.راتب</th>';
            
            if (type === 'daily') {
                html += '<th>سعر اليوم</th><th>عدد الأيام</th>';
            }
            
            html += '<th>الصرف</th>';
            html += '<th>بونص</th><th>ع.بونص</th>';
            html += '<th>فواتير</th><th>ع.فواتير</th>';
            html += '<th>خصومات</th><th>ع.خصومات</th>';
            html += '<th>سلفة</th><th>ع.سلفة</th>';
            html += '<th>زيادة</th><th>ع.زيادة</th>';
            html += '<th>مكافأة</th><th>ع.مكافأة</th>';
            html += '<th>الصافي</th>';
            html += '</tr></thead><tbody>';
            
            // بيانات الموظفين
            employees.forEach((emp, index) => {
                const netSalary = calculateNetSalary(emp, emp.month || currentMonth, emp.year || currentYear);
                html += '<tr>';
                html += '<td>' + (index + 1) + '</td>';
                html += '<td>' + (emp.nameAr || emp.name || '') + '</td>';
                html += '<td>' + (emp.position || '') + '</td>';
                html += '<td>' + (projects[emp.project] || emp.project || '') + '</td>';
                html += '<td>' + (emp.salary || 0) + '</td>';
                html += '<td>' + (emp.salaryCurrency || 'IQD') + '</td>';
                
                if (type === 'daily') {
                    html += '<td>' + (emp.salary || 0) + '</td>';
                    html += '<td>' + (emp.workDays || 0) + '</td>';
                }
                
                html += '<td>' + (emp.exchangeRate || 1420) + '</td>';
                html += '<td>' + (emp.bonus || 0) + '</td>';
                html += '<td>' + (emp.bonusCurrency || 'IQD') + '</td>';
                html += '<td>' + (emp.phoneBills || 0) + '</td>';
                html += '<td>' + (emp.phoneBillsCurrency || 'IQD') + '</td>';
                html += '<td>' + (emp.deductions || 0) + '</td>';
                html += '<td>' + (emp.deductionsCurrency || 'IQD') + '</td>';
                html += '<td>' + (emp.advance || 0) + '</td>';
                html += '<td>' + (emp.advanceCurrency || 'IQD') + '</td>';
                html += '<td>' + (emp.salaryIncrease || 0) + '</td>';
                html += '<td>' + (emp.salaryIncreaseCurrency || 'IQD') + '</td>';
                html += '<td>' + (emp.ceoBonus || 0) + '</td>';
                html += '<td>' + (emp.ceoBonusCurrency || 'IQD') + '</td>';
                html += '<td>' + formatCurrency(netSalary) + ' ' + (emp.paymentCurrency || 'IQD') + '</td>';
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }
        
        // دالة طباعة بسيطة وفعالة
        function printSimple(settings) {
            console.log('🖨️ طباعة بسيطة:', settings);
            
            // جمع الموظفين من البيانات الحالية
            let employeesToPrint = [];
            
            if (currentView === 'project') {
                // من عرض المشروع - جمع موظفي المشروع الحالي
                employeesToPrint = employeeData[currentYear][selectedProjectMonth || currentMonth].filter(emp => 
                    emp.project === currentProject
                );
            } else {
                // من عرض الشهر
                if (settings.selectedProject === 'all') {
                    employeesToPrint = employeeData[currentYear][currentMonth];
                } else {
                    employeesToPrint = employeeData[currentYear][currentMonth].filter(emp => 
                        emp.project === settings.selectedProject
                    );
                }
            }
            
            // تصفية حسب نوع الموظف
            let filteredEmployees = employeesToPrint;
            if (settings.reportType !== 'all') {
                filteredEmployees = employeesToPrint.filter(emp => {
                    if (settings.reportType === 'monthly') return emp.employeeType === 'monthly';
                    if (settings.reportType === 'daily') return emp.employeeType === 'daily';
                    if (settings.reportType === 'vehicle') return emp.employeeType === 'vehicle';
                    return true;
                });
            }
            
            // تصفية حسب حالة الدفع
            if (settings.paymentStatus && settings.paymentStatus !== 'all') {
                filteredEmployees = filteredEmployees.filter(emp => {
                    if (settings.paymentStatus === 'paid') return emp.isPaid === true;
                    if (settings.paymentStatus === 'unpaid') return !emp.isPaid;
                    return true;
                });
            }
            
            if (filteredEmployees.length === 0) {
                showNotification('warning', 'تحذير', 'لا توجد بيانات للطباعة');
                return;
            }
            
            // إنشاء نافذة طباعة بسيطة
            const printWindow = window.open('', '_blank');
            const currentDate = new Date().toLocaleDateString('ar-EG');
            
            let html = '<!DOCTYPE html><html dir="rtl"><head><meta charset="UTF-8">';
            html += '<title>تقرير الرواتب</title>';
            html += '<style>';
            const isA3Print = settings.pageSize === 'A3';
            const pageMarginPrint = isA3Print ? '0.5cm 0.8cm 2.5cm 0.8cm' : '10mm';
            const bodyPaddingPrint = isA3Print ? '6px' : '10px';
            const headerPaddingPrint = isA3Print ? '8px 12px' : '15px';
            const headerMarginPrint = isA3Print ? '10px' : '20px';
            const headerH1FontPrint = isA3Print ? '16px' : '18px';
            const headerH2FontPrint = isA3Print ? '12px' : '14px';
            const tableMarginPrint = isA3Print ? '15px' : '30px';
            const thTdPaddingPrint = isA3Print ? '6px' : '4px';
            const thTdFontPrint = isA3Print ? '11px' : '10px';
            const sectionTitlePadding = isA3Print ? '6px' : '8px';
            const sectionTitleMargin = isA3Print ? '12px 0 6px 0' : '20px 0 10px 0';
            const sigMarginTop = isA3Print ? '15px' : '30px';
            const sigLineMarginTop = isA3Print ? '20px' : '30px';
            const footerHeight = isA3Print ? '120px' : '130px';
            const footerPaddingBottom = isA3Print ? '250px' : '200px'; // زيادة كبيرة لـ A3 لمنع التداخل
            const tableMarginBottom = isA3Print ? '50px' : '40px'; // مسافة كبيرة بعد كل جدول
            const lastTableMarginBottom = isA3Print ? '200px' : '180px'; // مسافة أكبر للجدول الأخير
            
            html += '@page { size: ' + settings.pageSize + ' ' + settings.orientation + '; margin: ' + pageMarginPrint + '; }';
            html += 'body { font-family: Arial, sans-serif; margin: 0; padding: ' + bodyPaddingPrint + '; font-size: ' + (isA3Print ? '12px' : '10px') + '; ' + (isA3Print ? 'padding-bottom: ' + footerPaddingBottom + ' !important;' : '') + ' }';
            html += '.header { text-align: center; margin-bottom: ' + headerMarginPrint + '; padding: ' + headerPaddingPrint + '; background: #f0f0f0; page-break-inside: avoid; }';
            html += '.header h1 { margin: 0; font-size: ' + headerH1FontPrint + '; color: #333; }';
            html += '.header h2 { margin: ' + (isA3Print ? '2px' : '5px') + ' 0; font-size: ' + headerH2FontPrint + '; color: #666; }';
            html += 'table { width: 100%; border-collapse: collapse; margin-bottom: ' + tableMarginBottom + ' !important; font-size: ' + thTdFontPrint + '; }';
            html += 'table:last-of-type { margin-bottom: ' + lastTableMarginBottom + ' !important; }'; // مسافة أكبر للجدول الأخير
            html += 'th, td { border: 1px solid #ccc; padding: ' + thTdPaddingPrint + '; text-align: center; font-size: ' + thTdFontPrint + '; }';
            html += 'th { background: #e0e0e0; font-weight: bold; }';
            html += '.section-title { background: #007bff; color: white; padding: ' + sectionTitlePadding + '; margin: ' + sectionTitleMargin + '; font-weight: bold; font-size: ' + (isA3Print ? '13px' : '12px') + '; }';
            html += '.signatures { margin-top: ' + sigMarginTop + '; display: flex; justify-content: space-between; page-break-inside: avoid; }';
            html += '.signature-box { text-align: center; width: 20%; }';
            html += '.signature-line { border-top: 1px solid #000; margin-top: ' + sigLineMarginTop + '; }';
            // تقسيم الجدول: 25 صف في كل صفحة (يعمل في A4 و A3)
            // تذييل مكرر لكل صفحة عند الطباعة (يعمل في A4 و A3)
            html += '@media print { ';
            html += 'body { padding-bottom: ' + footerPaddingBottom + ' !important; min-height: 100vh !important; } ';
            html += 'table { position: relative !important; z-index: 10 !important; margin-bottom: ' + tableMarginBottom + ' !important; } ';
            html += 'table:last-of-type { margin-bottom: ' + lastTableMarginBottom + ' !important; } '; // مسافة أكبر للجدول الأخير
            html += 'table:not(:last-of-type) { margin-bottom: ' + tableMarginBottom + ' !important; } '; // مسافة بين الجداول
            html += 'tbody { position: relative !important; z-index: 10 !important; } ';
            html += 'tbody tr:last-child td { padding-bottom: ' + (isA3Print ? '20px' : '15px') + ' !important; } '; // مسافة في آخر صف
            html += '.print-footer { position: fixed !important; bottom: 0 !important; left: 0 !important; right: 0 !important; width: 100% !important; height: ' + footerHeight + '; box-sizing: border-box; padding: ' + (isA3Print ? '8px' : '12px') + '; background: white !important; border-top: ' + (isA3Print ? '3px' : '2px') + ' solid #64748b; -webkit-print-color-adjust: exact; print-color-adjust: exact; page-break-inside: avoid; z-index: 1 !important; } ';
            html += '.print-footer::before { content: ""; display: block; height: ' + (isA3Print ? '50px' : '40px') + '; background: white !important; width: 100%; position: absolute; bottom: 100%; left: 0; border-top: 2px solid #e2e8f0; z-index: 1 !important; } ';
            html += 'tbody tr { page-break-inside: avoid !important; position: relative !important; z-index: 10 !important; } ';
            html += 'tbody tr:nth-child(25n) { page-break-after: always !important; border-bottom: 2px solid #cbd5e1 !important; margin-bottom: ' + (isA3Print ? '30px' : '20px') + ' !important; } ';
            html += 'thead { display: table-header-group !important; position: relative !important; z-index: 10 !important; } ';
            html += 'thead tr { page-break-inside: avoid !important; page-break-after: avoid !important; } ';
            html += '.section-title { margin-bottom: ' + (isA3Print ? '15px' : '12px') + ' !important; } '; // مسافة بعد عنوان القسم
            html += '}';
            html += '</style></head><body>';
            
            // رأس التقرير من الإعدادات
            const headerInfo = getHeaderInfo();
            const isArabic = currentLang === 'ar';
            
            html += '<div class="header">';
            
            // اللوغو
            if (headerInfo.companyLogo) {
                html += '<div style="text-align: center; margin-bottom: 15px;">';
                html += '<img src="' + headerInfo.companyLogo + '" style="max-width: 100px; max-height: 100px; object-fit: contain;">';
                html += '</div>';
            }
            
            // اسم الشركة
            html += '<h1 style="margin: 10px 0; font-size: 20px; color: #333;">' + headerInfo.companyName + '</h1>';
            
            // معلومات الشركة
            if (headerInfo.companyAddress) {
                html += '<p style="font-size: 11px; margin: 5px 0;">📍 ' + headerInfo.companyAddress + '</p>';
            }
            if (headerInfo.companyPhone) {
                html += '<p style="font-size: 11px; margin: 5px 0;">📞 ' + headerInfo.companyPhone + '</p>';
            }
            if (headerInfo.companyEmail) {
                html += '<p style="font-size: 11px; margin: 5px 0;">📧 ' + headerInfo.companyEmail + '</p>';
            }
            
            // عنوان التقرير
            html += '<h2 style="margin: 15px 0 10px 0; font-size: 16px; color: #007bff;">' + headerInfo.systemName + '</h2>';
            
            if (settings.selectedProject !== 'all') {
                html += '<h3 style="font-size: 13px; margin: 5px 0;">' + (isArabic ? 'مشروع: ' : 'Project: ') + projects[settings.selectedProject] + '</h3>';
            }
            const monthToShow = currentView === 'project' ? (selectedProjectMonth || currentMonth) : currentMonth;
            html += '<h3 style="font-size: 13px; margin: 5px 0;">' + (isArabic ? 'الشهر: ' : 'Month: ') + translations[currentLang].monthNames[monthToShow] + ' ' + currentYear + '</h3>';
            if (settings.paymentStatus && settings.paymentStatus !== 'all') {
                const paymentStatusText = settings.paymentStatus === 'paid' 
                    ? (isArabic ? 'الموظفون المدفوعون فقط' : 'Paid Employees Only')
                    : (isArabic ? 'الموظفون غير المدفوعين فقط' : 'Unpaid Employees Only');
                html += '<h3 style="font-size: 13px; margin: 5px 0; color: #007bff;">' + (isArabic ? 'حالة الدفع: ' : 'Payment Status: ') + paymentStatusText + '</h3>';
            }
            html += '<p style="font-size: 11px; margin: 5px 0; color: #666;">' + (isArabic ? 'تاريخ الطباعة: ' : 'Print Date: ') + currentDate + '</p>';
            html += '</div>';
            
            // تقسيم الموظفين حسب النوع
            const monthlyEmps = filteredEmployees.filter(emp => emp.employeeType === 'monthly');
            const dailyEmps = filteredEmployees.filter(emp => emp.employeeType === 'daily');
            const vehicleEmps = filteredEmployees.filter(emp => emp.employeeType === 'vehicle');
            
            // طباعة الموظفين الشهريين
            if (monthlyEmps.length > 0 && (settings.reportType === 'all' || settings.reportType === 'monthly')) {
                html += '<div class="section-title">الموظفون الشهريون</div>';
                html += generateSimpleTable(monthlyEmps, 'monthly');
            }
            
            // طباعة الموظفين اليوميين
            if (dailyEmps.length > 0 && (settings.reportType === 'all' || settings.reportType === 'daily')) {
                html += '<div class="section-title">الموظفون اليوميون</div>';
                html += generateSimpleTable(dailyEmps, 'daily');
            }
            
            // طباعة السيارات
            if (vehicleEmps.length > 0 && (settings.reportType === 'all' || settings.reportType === 'vehicle')) {
                html += '<div class="section-title">السيارات</div>';
                html += generateSimpleTable(vehicleEmps, 'vehicle');
            }
            
            // تذييل مكرر بالتوقيعات في جميع الصفحات
            (function(){
                const sig = getSignaturesHTML() || '';
                html += '<div class="print-footer">' + sig + '</div>';
            })();
            
            html += '</body></html>';
            
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.print();
        }
        
        // دالة إنشاء جدول بسيط مع الحقول المطلوبة
        function generateSimpleTable(employees, type) {
            const isArabic = currentLang === 'ar';
            
            let html = '<table>';
            
            // رأس الجدول
            html += '<thead><tr>';
            html += '<th>#</th>';
            html += '<th>' + (isArabic ? 'الاسم' : 'Name') + '</th>';
            html += '<th>' + (isArabic ? 'المنصب' : 'Position') + '</th>';
            html += '<th>' + (isArabic ? 'المشروع' : 'Project') + '</th>';
            html += '<th>' + (isArabic ? 'الراتب' : 'Salary') + '</th>';
            html += '<th>' + (isArabic ? 'ع.راتب' : 'S.Curr') + '</th>';
            html += '<th>' + (isArabic ? 'الصرف' : 'Exch.') + '</th>';
            html += '<th>' + (isArabic ? 'الدوام' : 'Attendance') + '</th>';
            html += '<th>' + (isArabic ? 'راتب فعلي USD' : 'Actual USD') + '</th>';
            html += '<th>' + (isArabic ? 'راتب فعلي IQD' : 'Actual IQD') + '</th>';
            html += '<th>' + (isArabic ? 'بونص' : 'Bonus') + '</th>';
            html += '<th>' + (isArabic ? 'ع.بونص' : 'B.Curr') + '</th>';
            html += '<th>' + (isArabic ? 'فواتير' : 'Bills') + '</th>';
            html += '<th>' + (isArabic ? 'ع.فواتير' : 'Bills C.') + '</th>';
            html += '<th>' + (isArabic ? 'خصومات' : 'Ded.') + '</th>';
            html += '<th>' + (isArabic ? 'ع.خصومات' : 'Ded.C.') + '</th>';
            html += '<th>' + (isArabic ? 'سلفة' : 'Advance') + '</th>';
            html += '<th>' + (isArabic ? 'ع.سلفة' : 'Adv.C.') + '</th>';
            html += '<th>' + (isArabic ? 'زيادة' : 'Increase') + '</th>';
            html += '<th>' + (isArabic ? 'ع.زيادة' : 'Inc.C.') + '</th>';
            html += '<th>' + (isArabic ? 'مكافأة' : 'CEO Bonus') + '</th>';
            html += '<th>' + (isArabic ? 'ع.مكافأة' : 'CEO B.C.') + '</th>';
            html += '<th>' + (isArabic ? 'الصافي' : 'Net') + '</th>';
            html += '<th>' + (isArabic ? 'حالة الدفع' : 'Payment Status') + '</th>';
            html += '<th>' + (isArabic ? 'نسبة الحجز' : 'Reservation %') + '</th>';
            html += '<th>' + (isArabic ? 'المحجوز' : 'Reserved') + '</th>';
            html += '<th>' + (isArabic ? 'المحجوز تراكمي' : 'Accumulated') + '</th>';
            html += '<th>' + (isArabic ? 'الهدف' : 'Target') + '</th>';
            html += '</tr></thead><tbody>';
            
            // متغيرات المجاميع
            let totalUSD = 0;
            let totalIQD = 0;
            
            // بيانات الموظفين
            employees.forEach((emp, index) => {
                const actualSalaryUSD = calculateActualSalary(emp);
                const actualSalaryIQD = actualSalaryUSD * (emp.exchangeRate || 1420);
                const netSalary = calculateNetSalary(emp);
                const empName = isArabic ? (emp.nameAr || emp.name || '') : (emp.nameEn || emp.name || '');
                
                // تحديد قيمة الدوام حسب نوع الموظف
                let attendanceValue = '-';
                
                // تشخيص البيانات (يمكن إزالة هذا السطر لاحقاً)
                // console.log('🔍 [attendanceValue] الموظف:', emp.nameAr || emp.name, 'النوع:', emp.employeeType, 'attendance:', emp.attendance, 'workDays:', emp.workDays);
                
                if (emp.employeeType === 'daily') {
                    // للموظفين اليوميين: عدد الأيام
                    let days = 0;
                    let hasAttendanceData = false;
                    
                    if (typeof emp.workDays === 'number' && emp.workDays > 0) {
                        days = emp.workDays;
                        hasAttendanceData = true;
                    } else if (typeof emp.workDays === 'string' && !isNaN(parseInt(emp.workDays)) && parseInt(emp.workDays) > 0) {
                        days = parseInt(emp.workDays);
                        hasAttendanceData = true;
                    } else if (emp.attendance && typeof emp.attendance === 'object' && Object.keys(emp.attendance).length > 0) {
                        // إذا كان attendance كائن مع بيانات، استخدم workDays المحفوظ
                        days = emp.workDays || 0;
                        hasAttendanceData = days > 0;
                    }
                    
                    if (hasAttendanceData) {
                        attendanceValue = days.toString();
                    } else {
                        attendanceValue = isArabic ? 'لا يوجد دوام' : 'No Attendance';
                    }
                } else if (emp.employeeType === 'monthly') {
                    // للموظفين الشهريين: دوام كامل أو قيمة مخصصة
                    if (emp.attendance && typeof emp.attendance === 'string' && emp.attendance.trim() !== '') {
                        attendanceValue = emp.attendance;
                    } else if (emp.attendance && typeof emp.attendance === 'object' && Object.keys(emp.attendance).length > 0) {
                        // إذا كان attendance كائن مع بيانات، استخدم workDays المحفوظ
                        const days = emp.workDays || 0;
                        if (days > 0) {
                            attendanceValue = days.toString();
                        } else {
                            attendanceValue = isArabic ? 'دوام كامل' : 'Full Time';
                        }
                    } else {
                        // لا توجد بيانات دوام للموظف الشهري
                        attendanceValue = isArabic ? 'لا يوجد دوام' : 'No Attendance';
                    }
                } else if (emp.employeeType === 'vehicle') {
                    // لموظفي المركبات: عدد الأيام
                    let days = 0;
                    let hasAttendanceData = false;
                    
                    if (typeof emp.workDays === 'number' && emp.workDays > 0) {
                        days = emp.workDays;
                        hasAttendanceData = true;
                    } else if (typeof emp.workDays === 'string' && !isNaN(parseInt(emp.workDays)) && parseInt(emp.workDays) > 0) {
                        days = parseInt(emp.workDays);
                        hasAttendanceData = true;
                    } else if (emp.attendance && typeof emp.attendance === 'object' && Object.keys(emp.attendance).length > 0) {
                        // إذا كان attendance كائن مع بيانات، استخدم workDays المحفوظ
                        days = emp.workDays || 0;
                        hasAttendanceData = days > 0;
                    }
                    
                    if (hasAttendanceData) {
                        attendanceValue = days.toString();
                    } else {
                        attendanceValue = isArabic ? 'لا يوجد دوام' : 'No Attendance';
                    }
                }
                
                // console.log('✅ [attendanceValue] النتيجة النهائية:', attendanceValue);
                
                // حساب المجموع حسب عملة الدفع
                if (emp.paymentCurrency === 'USD') {
                    totalUSD += netSalary;
                } else {
                    totalIQD += netSalary;
                }
                
                html += '<tr>';
                html += '<td>' + (index + 1) + '</td>';
                html += '<td>' + empName + '</td>';
                html += '<td>' + (emp.position || '') + '</td>';
                html += '<td>' + (projects[emp.project] || emp.project || '') + '</td>';
                html += '<td>' + formatCurrency(emp.salary || 0) + '</td>';
                html += '<td>' + (emp.salaryCurrency || 'IQD') + '</td>';
                html += '<td>' + (emp.exchangeRate || 1420) + '</td>';
                html += '<td>' + attendanceValue + '</td>';
                html += '<td>' + formatCurrency(actualSalaryUSD) + '</td>';
                html += '<td>' + formatCurrency(actualSalaryIQD) + '</td>';
                html += '<td>' + formatCurrency(emp.bonus || 0) + '</td>';
                html += '<td>' + (emp.bonusCurrency || 'IQD') + '</td>';
                html += '<td>' + formatCurrency(emp.phoneBills || 0) + '</td>';
                html += '<td>' + (emp.phoneBillsCurrency || 'IQD') + '</td>';
                html += '<td>' + formatCurrency(emp.deductions || 0) + '</td>';
                html += '<td>' + (emp.deductionsCurrency || 'IQD') + '</td>';
                html += '<td>' + formatCurrency(emp.advance || 0) + '</td>';
                html += '<td>' + (emp.advanceCurrency || 'IQD') + '</td>';
                html += '<td>' + formatCurrency(emp.salaryIncrease || 0) + '</td>';
                html += '<td>' + (emp.salaryIncreaseCurrency || 'IQD') + '</td>';
                html += '<td>' + formatCurrency(emp.ceoBonus || 0) + '</td>';
                html += '<td>' + (emp.ceoBonusCurrency || 'IQD') + '</td>';
                html += '<td style="font-weight: bold;">' + formatCurrency(netSalary) + ' ' + (emp.paymentCurrency || 'IQD') + '</td>';
                
                // حالة الدفع
                const paymentStatusText = emp.isPaid ? (isArabic ? '✅ تم الدفع' : '✅ Paid') : (isArabic ? '⏳ لم يتم الدفع' : '⏳ Unpaid');
                html += '<td>' + paymentStatusText + '</td>';
                
                // بيانات الحجز
                const accumulatedReservation = calculateAccumulatedReservation(emp, currentMonth, currentYear);
                const currentReserved = parseFloat(emp.reservedAmount) || 0;
                const totalReserved = accumulatedReservation + currentReserved;
                const targetReserved = parseFloat(emp.targetReservedAmount) || calculateTargetReservation(emp);
                const reservationPercentage = emp.reservationPercentage || 0;
                
                html += '<td>' + (reservationPercentage > 0 ? reservationPercentage.toFixed(1) + '%' : '-') + '</td>';
                html += '<td>' + (currentReserved > 0 ? formatCurrency(currentReserved) : '-') + '</td>';
                html += '<td>' + (accumulatedReservation > 0 ? formatCurrency(accumulatedReservation) : '-') + '</td>';
                html += '<td>' + (targetReserved > 0 ? formatCurrency(targetReserved) : '-') + '</td>';
                
                html += '</tr>';
            });
            
            // إضافة صفوف المجاميع
            html += '</tbody><tfoot>';
            
            if (totalUSD > 0) {
                html += '<tr style="background: #fffbcc; font-weight: bold;">';
                html += '<td colspan="26" style="text-align: right; padding: 10px;">' + (isArabic ? 'المجموع بالدولار:' : 'Total USD:') + '</td>';
                html += '<td style="font-size: 12px; padding: 10px;">' + formatCurrency(totalUSD) + ' USD</td>';
                html += '</tr>';
            }
            
            if (totalIQD > 0) {
                html += '<tr style="background: #ccf2ff; font-weight: bold;">';
                html += '<td colspan="26" style="text-align: right; padding: 10px;">' + (isArabic ? 'المجموع بالدينار:' : 'Total IQD:') + '</td>';
                html += '<td style="font-size: 12px; padding: 10px;">' + formatCurrency(totalIQD) + ' IQD</td>';
                html += '</tr>';
            }
            
            html += '</tfoot></table>';
            return html;
        }
        
        function executePrintUnified(settings) {
            console.log('🖨️ تنفيذ طباعة موحدة مع الإعدادات:', settings);
            
            // جمع البيانات حسب العرض والفلتر
            let employeesToPrint = [];
            let pageTitle = '';
            
            if (currentView === 'month') {
                // في عرض الأشهر
                const monthData = employeeData[currentYear]?.[currentMonth] || [];
                
                if (settings.selectedProject === 'all') {
                    employeesToPrint = monthData;
                    pageTitle = `${translations[currentLang].monthNames[currentMonth]} ${currentYear} - جميع المشاريع`;
                } else {
                    employeesToPrint = monthData.filter(emp => emp.project === settings.selectedProject);
                    pageTitle = `${translations[currentLang].monthNames[currentMonth]} ${currentYear} - ${projects[settings.selectedProject]}`;
                }
            } else if (currentView === 'project') {
                // في عرض المشاريع
                const monthData = employeeData[currentYear]?.[selectedProjectMonth] || [];
                
                if (settings.selectedProject === 'all') {
                    employeesToPrint = monthData;
                    pageTitle = `${translations[currentLang].monthNames[selectedProjectMonth]} ${currentYear} - جميع المشاريع`;
                } else if (settings.selectedProject === 'current') {
                    employeesToPrint = monthData.filter(emp => emp.project === currentProject);
                    pageTitle = `${projects[currentProject]} - ${translations[currentLang].monthNames[selectedProjectMonth]}`;
                } else {
                    employeesToPrint = monthData.filter(emp => emp.project === settings.selectedProject);
                    pageTitle = `${projects[settings.selectedProject]} - ${translations[currentLang].monthNames[selectedProjectMonth]}`;
                }
            }
            
            // فلترة حسب نوع الموظف
            if (settings.reportType !== 'full') {
                if (settings.reportType === 'monthly') {
                    employeesToPrint = employeesToPrint.filter(emp => emp.employmentType === 'monthly');
                } else if (settings.reportType === 'daily') {
                    employeesToPrint = employeesToPrint.filter(emp => emp.employmentType === 'daily');
                } else if (settings.reportType === 'vehicles') {
                    employeesToPrint = employeesToPrint.filter(emp => emp.employmentType === 'vehicle');
                }
            }
            
            if (employeesToPrint.length === 0) {
                showNotification('warning', 'تحذير', 'لا توجد بيانات مطابقة للطباعة');
                return;
            }
            
            // تقسيم حسب نوع الموظف
            const monthlyEmps = employeesToPrint.filter(emp => emp.employmentType === 'monthly');
            const dailyEmps = employeesToPrint.filter(emp => emp.employmentType === 'daily');
            const vehicleEmps = employeesToPrint.filter(emp => emp.employmentType === 'vehicle');
            
            // إنشاء HTML للطباعة
            const htmlContent = generateUnifiedPrintHTML(
                { monthly: monthlyEmps, daily: dailyEmps, vehicles: vehicleEmps },
                pageTitle,
                settings
            );
            
            // فتح نافذة الطباعة
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            showNotification('success', '✅ جاهز للطباعة', 
                `سيتم طباعة ${employeesToPrint.length} موظف في ${[monthlyEmps.length > 0, dailyEmps.length > 0, vehicleEmps.length > 0].filter(x => x).length} جدول`);
        }
        
        function generateUnifiedPrintHTML(employeeGroups, pageTitle, settings) {
            const currentDate = new Date().toLocaleDateString('ar-EG', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const currentTime = new Date().toLocaleTimeString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // بناء HTML
            let html = '<!DOCTYPE html>';
            html += '<html lang="ar" dir="rtl">';
            html += '<head>';
            html += '<meta charset="UTF-8">';
            html += `<title>${pageTitle}</title>`;
            html += '<style>';
            
            // CSS محسّن
            html += '* { margin: 0; padding: 0; box-sizing: border-box; }';
            const isA3 = settings.pageSize === 'A3';
            const pageMargin = isA3 ? '0.5cm 0.8cm 2.5cm 0.8cm' : '8mm';
            const bodyFontSize = isA3 ? '12px' : '8px';
            const headerPadding = isA3 ? '8px 12px' : '12px 15px';
            const headerH1Font = isA3 ? '14px' : '16px';
            const headerCompanyFont = isA3 ? '10px' : '11px';
            const headerH2Font = isA3 ? '11px' : '13px';
            const headerInfoFont = isA3 ? '9px' : '9px';
            
            html += '@page { size: ' + settings.pageSize + ' ' + settings.orientation + '; margin: ' + pageMargin + '; }';
            html += 'body { font-family: "Segoe UI", Tahoma, Arial, sans-serif; background: white; padding: 8px; direction: rtl; font-size: ' + bodyFontSize + '; ' + (isA3 ? 'padding-bottom: 140px !important;' : '') + ' }';
            
            // الرأس
            html += '.page-header { text-align: center; padding: ' + headerPadding + '; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);';
            html += ' color: white; border-radius: ' + (isA3 ? '6px' : '10px') + '; margin-bottom: ' + (isA3 ? '6px' : '10px') + '; -webkit-print-color-adjust: exact; print-color-adjust: exact; page-break-inside: avoid; page-break-after: avoid; }';
            html += '.page-header h1 { font-size: ' + headerH1Font + '; margin-bottom: ' + (isA3 ? '2px' : '4px') + '; font-weight: 800; }';
            html += '.page-header .company { font-size: ' + headerCompanyFont + '; margin: ' + (isA3 ? '1px 0' : '3px 0') + '; font-weight: 700; background: rgba(255,255,255,0.2); padding: ' + (isA3 ? '2px 10px' : '3px 12px') + '; border-radius: 12px; display: inline-block; }';
            html += '.page-header h2 { font-size: ' + headerH2Font + '; margin: ' + (isA3 ? '2px 0' : '4px 0') + '; opacity: 0.95; font-weight: 600; }';
            html += '.page-header .info { font-size: ' + headerInfoFont + '; opacity: 0.9; margin-top: ' + (isA3 ? '2px' : '4px') + '; font-weight: 500; }';
            
            // عنوان الجدول
            html += '.table-section { page-break-after: always; page-break-inside: avoid; margin-bottom: 20px; }';
            html += '.table-section:last-child { page-break-after: auto; }';
            html += '.section-title { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;';
            html += ' padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; font-size: 14px; font-weight: 700;';
            html += ' text-align: center; -webkit-print-color-adjust: exact; print-color-adjust: exact; page-break-after: avoid; }';
            
            // الجداول - محسّن لعرض جميع الأعمدة
            const tableFontSize = isA3 ? '11px' : '5px';
            const thFontSize = isA3 ? '11px' : '4.5px';
            const tdFontSize = isA3 ? '11px' : '4.5px';
            const thPadding = isA3 ? '8px 4px' : '3px 1px';
            const tdPadding = isA3 ? '6px 3px' : '2px 1px';
            
            html += 'table { width: 100%; border-collapse: collapse; font-size: ' + tableFontSize + '; margin-bottom: ' + (isA3 ? '8px' : '12px') + '; border: 2px solid #64748b; table-layout: auto; max-width: 100%; }';
            html += 'thead { background: linear-gradient(135deg, #475569 0%, #334155 100%); -webkit-print-color-adjust: exact; print-color-adjust: exact; display: table-header-group; }';
            html += 'thead th { background: linear-gradient(135deg, #475569 0%, #334155 100%); color: white; padding: ' + thPadding + '; border: 1px solid #1e293b; font-weight: 700; text-align: center; font-size: ' + thFontSize + '; white-space: ' + (isA3 ? 'normal' : 'nowrap') + '; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; -webkit-print-color-adjust: exact; print-color-adjust: exact; }';
            html += 'tbody td { padding: ' + tdPadding + '; border: 1px solid #cbd5e1; text-align: center; font-size: ' + tdFontSize + '; white-space: ' + (isA3 ? 'normal' : 'nowrap') + '; overflow: hidden; text-overflow: ellipsis; line-height: 1.3; color: #1e293b; }';
            html += 'tbody tr { page-break-inside: avoid; }';
            html += 'tbody tr:nth-child(even) { background: #f8fafc; -webkit-print-color-adjust: exact; print-color-adjust: exact; }';
            html += 'tbody tr:nth-child(odd) { background: white; }';
            html += 'tbody tr:last-child { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important; font-weight: 800; border-top: 3px solid #f59e0b !important; border-bottom: 3px solid #f59e0b !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; page-break-inside: avoid; }';
            html += 'tbody tr:last-child td { color: #92400e !important; font-weight: 800; font-size: 5.5px; padding: 3px 1px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important; }';
            
            // التذييل والتوقيعات
            const footerPadding = isA3 ? '8px' : '15px';
            const footerMargin = isA3 ? '10px' : '24px';
            const sigTitleFont = isA3 ? '12px' : '10px';
            const sigNameFont = isA3 ? '11px' : '9px';
            const sigMarginBottom = isA3 ? '10px' : '18px';
            const sigLineMargin = isA3 ? '12px auto 3px' : '18px auto 5px';
            
            if (isA3) {
                html += '@media print { .page-footer { position: fixed; bottom: 0; left: 0; right: 0; height: 120px; background: white; border-top: 2px solid #667eea; padding: ' + footerPadding + '; -webkit-print-color-adjust: exact; print-color-adjust: exact; page-break-inside: avoid; } }';
                html += '.page-footer { padding: ' + footerPadding + '; margin-top: ' + footerMargin + '; background: transparent; border-top: 1px solid #cbd5e1; -webkit-print-color-adjust: exact; print-color-adjust: exact; page-break-inside: avoid; page-break-before: avoid; page-break-after: avoid; }';
            } else {
                html += '.page-footer { padding: ' + footerPadding + '; margin-top: ' + footerMargin + '; background: transparent; border-top: 1px solid #cbd5e1; -webkit-print-color-adjust: exact; print-color-adjust: exact; page-break-inside: avoid; page-break-before: avoid; page-break-after: avoid; }';
            }
            html += '.signatures-section { display: flex; justify-content: space-between; margin-bottom: ' + (isA3 ? '6px' : '12px') + '; padding: ' + (isA3 ? '6px 0' : '10px 0') + '; border-bottom: 1px solid #cbd5e1; gap: 20px; page-break-inside: avoid; }';
            html += '.signature-box { flex: 1; text-align: center; padding: ' + (isA3 ? '6px' : '8px') + '; }';
            html += '.signature-box .title { font-size: ' + sigTitleFont + '; font-weight: 700; color: #1e293b; margin-bottom: ' + sigMarginBottom + '; }';
            html += '.signature-box .line { border-top: 2px solid #64748b; width: 75%; margin: ' + sigLineMargin + '; }';
            html += '.signature-box .name { font-size: ' + sigNameFont + '; color: #475569; font-weight: 600; }';
            html += '.copyright-info { text-align: center; font-size: ' + (isA3 ? '11px' : '9px') + '; color: #475569; padding-top: ' + (isA3 ? '6px' : '8px') + '; }';
            html += '.copyright-info strong { color: #1e293b; font-weight: 700; }';
            html += '.print-main-table tbody tr:last-child { background: none !important; border-top: 1px solid #cbd5e1 !important; border-bottom: 1px solid #cbd5e1 !important; color: #1e293b !important; }';
            html += '.print-main-table tbody tr:last-child td { background: none !important; }';
            html += '.print-total-table { width: 100%; border-collapse: collapse; margin: 8px 0 16px 0; border: 2px solid #f59e0b; page-break-inside: avoid; }';
            html += '.print-total-table td { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e; font-weight: 800; font-size: 9px; padding: 6px 6px; border: 1px solid #f59e0b; text-align: center; }';
            
            // إخفاء العناصر التفاعلية
            html += 'button, .btn, .btn-primary, .btn-success, .btn-warning, .btn-danger, .btn-small, .resizer, .dropdown, .modal, .actions, td button, th button { display: none !important; visibility: hidden !important; }';
            
            html += '</style></head><body>';
            
            // الرأس
            html += '<div class="page-header">';
            html += '<h1>📊 نظام إدارة الرواتب المتقدم</h1>';
            html += '<div class="company">🏢 ROSEMARY COMPANY</div>';
            html += `<h2>${pageTitle}</h2>`;
            if (settings.showDateTime || settings.showUser) {
                html += '<div class="info">';
                if (settings.showDateTime) html += `📅 ${currentDate} | 🕐 ${currentTime}`;
                if (settings.showUser) html += ` | 👤 ${currentUser?.email || 'غير محدد'}`;
                html += '</div>';
            }
            html += '</div>';
            
            // الحصول على التوقيعات مرة واحدة
            const signaturesHTML = getSignaturesHTML();
            
            // إنشاء الجداول
            let tableCount = 0;
            
            // جدول الموظفين الشهريين
            if (employeeGroups.monthly.length > 0 && (settings.reportType === 'full' || settings.reportType === 'monthly')) {
                tableCount++;
                html += '<div class="table-section">';
                html += '<div class="section-title">📋 الموظفون الشهريون</div>';
                html += generateEmployeeTable(employeeGroups.monthly, 'monthly', settings);
                html += '<div class="page-footer">';
                if (signaturesHTML) html += signaturesHTML;
                html += '<div class="copyright-info"><strong>Powered by ROSEMARY</strong> - تاريخ الطباعة: ' + currentDate + ' | جدول ' + tableCount + '</div>';
                html += '</div></div>';
            }
            
            // جدول الموظفين اليوميين
            if (employeeGroups.daily.length > 0 && (settings.reportType === 'full' || settings.reportType === 'daily')) {
                tableCount++;
                html += '<div class="table-section">';
                html += '<div class="section-title">📋 الموظفون اليوميون</div>';
                html += generateEmployeeTable(employeeGroups.daily, 'daily', settings);
                html += '<div class="page-footer">';
                if (signaturesHTML) html += signaturesHTML;
                html += '<div class="copyright-info"><strong>Powered by ROSEMARY</strong> - تاريخ الطباعة: ' + currentDate + ' | جدول ' + tableCount + '</div>';
                html += '</div></div>';
            }
            
            // جدول السيارات
            if (employeeGroups.vehicles.length > 0 && (settings.reportType === 'full' || settings.reportType === 'vehicles')) {
                tableCount++;
                html += '<div class="table-section">';
                html += '<div class="section-title">📋 السيارات</div>';
                html += generateEmployeeTable(employeeGroups.vehicles, 'vehicle', settings);
                html += '<div class="page-footer">';
                if (signaturesHTML) html += signaturesHTML;
                html += '<div class="copyright-info"><strong>Powered by ROSEMARY</strong> - تاريخ الطباعة: ' + currentDate + ' | جدول ' + tableCount + '</div>';
                html += '</div></div>';
            }
            
            // سكريبت الطباعة التلقائية
            html += '<scr' + 'ipt>window.onload = function() { setTimeout(function() { window.print(); }, 1000); };</scr' + 'ipt>';
            html += '</body></html>';
            
            return html;
        }
        
        function generateEmployeeTable(employees, type, settings) {
            if (!employees || employees.length === 0) return '';
            
            let html = '<table class="print-main-table"><thead><tr>';
            
            // رأس الجدول
            html += '<th>#</th>';
            html += '<th>الاسم</th>';
            html += '<th>المنصب</th>';
            html += '<th>المشروع</th>';
            html += '<th>الراتب</th>';
            html += '<th>العملة</th>';
            
            if (type === 'daily') {
                html += '<th>سعر اليوم</th>';
                html += '<th>عدد الأيام</th>';
            }
            
            html += '<th>الصرف</th>';
            html += '<th>بونص</th>';
            html += '<th>ع.بونص</th>';
            html += '<th>فواتير</th>';
            html += '<th>ع.فواتير</th>';
            html += '<th>خصومات</th>';
            html += '<th>ع.خصومات</th>';
            html += '<th>سلفة</th>';
            html += '<th>ع.سلفة</th>';
            html += '<th>زيادة</th>';
            html += '<th>ع.زيادة</th>';
            html += '<th>مكافأة</th>';
            html += '<th>ع.مكافأة</th>';
            html += '<th>الصافي</th>';
            
            html += '</tr></thead><tbody>';
            
            // الصفوف
            let totalUSD = 0;
            let totalIQD = 0;
            
            employees.forEach((emp, index) => {
                const netSalary = calculateNetSalary(emp);
                if (emp.paymentCurrency === 'USD') {
                    totalUSD += netSalary;
            } else {
                    totalIQD += netSalary * (emp.exchangeRate || 1420);
                }
                
                html += '<tr>';
                html += `<td>${index + 1}</td>`;
                html += `<td>${emp.name || ''}</td>`;
                html += `<td>${emp.position || ''}</td>`;
                html += `<td>${projects[emp.project] || emp.project || ''}</td>`;
                html += `<td>${emp.salary || 0}</td>`;
                html += `<td>${emp.salaryCurrency || 'IQD'}</td>`;
                
                if (type === 'daily') {
                    html += `<td>${emp.dailyRate || 0}</td>`;
                    html += `<td>${emp.workDays || 0}</td>`;
                }
                
                html += `<td>${emp.exchangeRate || 1420}</td>`;
                html += `<td>${emp.bonus || 0}</td>`;
                html += `<td>${emp.bonusCurrency || 'IQD'}</td>`;
                html += `<td>${emp.phoneBills || 0}</td>`;
                html += `<td>${emp.phoneBillsCurrency || 'IQD'}</td>`;
                html += `<td>${emp.deductions || 0}</td>`;
                html += `<td>${emp.deductionsCurrency || 'IQD'}</td>`;
                html += `<td>${emp.advance || 0}</td>`;
                html += `<td>${emp.advanceCurrency || 'IQD'}</td>`;
                html += `<td>${emp.salaryIncrease || 0}</td>`;
                html += `<td>${emp.salaryIncreaseCurrency || 'IQD'}</td>`;
                html += `<td>${emp.ceoBonus || 0}</td>`;
                html += `<td>${emp.ceoBonusCurrency || 'IQD'}</td>`;
                html += `<td>${formatCurrency(netSalary)} ${emp.paymentCurrency}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';

            let totalsHtml = '';
            if (totalUSD > 0 || totalIQD > 0) {
                totalsHtml = '<table class="print-total-table"><tbody><tr>' +
                    `<td colspan="${type === 'daily' ? 4 : 2}"><strong>المجموع</strong></td>` +
                    `<td colspan="${type === 'daily' ? 17 : 19}">` +
                    `${totalUSD > 0 ? `<strong>${formatCurrency(totalUSD)} USD</strong>` : ''}` +
                    `${(totalUSD > 0 && totalIQD > 0) ? ' + ' : ''}` +
                    `${totalIQD > 0 ? `<strong>${formatCurrency(totalIQD)} IQD</strong>` : ''}` +
                    '</td></tr></tbody></table>';
            }
            
            return html + totalsHtml;
        }
        
        function generateProjectPrintHTML(tables, settings) {
            const currentDate = new Date().toLocaleDateString('ar-EG', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const currentTime = new Date().toLocaleTimeString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const projectName = currentProject ? projects[currentProject] : '';
            const monthName = selectedProjectMonth ? translations[currentLang].monthNames[selectedProjectMonth] : '';
            
            // بناء HTML
            let html = '<!DOCTYPE html>';
            html += '<html lang="ar" dir="rtl">';
            html += '<head>';
            html += '<meta charset="UTF-8">';
            html += `<title>تقرير ${projectName} - ${monthName}</title>`;
            html += '<style>';
            
            // CSS محسّن
            html += '* { margin: 0; padding: 0; box-sizing: border-box; }';
            html += `@page { size: ${settings.pageSize} ${settings.orientation}; margin: 10mm; }`;
            html += 'body { font-family: "Segoe UI", Tahoma, Arial, sans-serif; background: white; padding: 10px; direction: rtl; }';
            
            // الرأس
            html += '.page-header { text-align: center; padding: 12px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);';
            html += ' color: white; border-radius: 10px; margin-bottom: 10px; -webkit-print-color-adjust: exact; print-color-adjust: exact; page-break-inside: avoid; page-break-after: avoid; }';
            html += '.page-header h1 { font-size: 16px; margin-bottom: 4px; font-weight: 800; }';
            html += '.page-header .company { font-size: 11px; margin: 3px 0; font-weight: 700; background: rgba(255,255,255,0.2); padding: 3px 12px; border-radius: 12px; display: inline-block; }';
            html += '.page-header h2 { font-size: 13px; margin: 4px 0; opacity: 0.95; font-weight: 600; }';
            html += '.page-header .info { font-size: 9px; opacity: 0.9; margin-top: 4px; font-weight: 500; }';
            
            // عنوان الجدول
            html += '.table-section { page-break-after: always; page-break-inside: avoid; margin-bottom: 20px; }';
            html += '.table-section:last-child { page-break-after: auto; }';
            html += '.section-title { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;';
            html += ' padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; font-size: 14px; font-weight: 700;';
            html += ' text-align: center; -webkit-print-color-adjust: exact; print-color-adjust: exact; page-break-after: avoid; }';
            
            // الجداول - محسّن لعرض جميع الأعمدة بدون قطع
            html += 'table { width: 100%; border-collapse: collapse; font-size: 5px; margin-bottom: 12px; page-break-inside: auto; border: 2px solid #64748b; table-layout: auto; max-width: 100%; }';
            html += 'thead { background: linear-gradient(135deg, #475569 0%, #334155 100%); -webkit-print-color-adjust: exact; print-color-adjust: exact; display: table-header-group; }';
            html += 'thead th { background: linear-gradient(135deg, #475569 0%, #334155 100%); color: white; padding: 3px 1px; border: 1px solid #1e293b; font-weight: 700; text-align: center; font-size: 4.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.1; -webkit-print-color-adjust: exact; print-color-adjust: exact; max-width: none; }';
            html += 'tbody td { padding: 2px 1px; border: 1px solid #cbd5e1; text-align: center; font-size: 4.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; color: #1e293b; max-width: none; }';
            html += 'tbody tr { page-break-inside: avoid; page-break-after: auto; }';
            html += 'tbody tr:nth-child(even) { background: #f8fafc; -webkit-print-color-adjust: exact; print-color-adjust: exact; }';
            html += 'tbody tr:nth-child(odd) { background: white; }';
            html += 'tbody tr:last-child { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important; font-weight: 800; border-top: 3px solid #f59e0b !important; border-bottom: 3px solid #f59e0b !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; page-break-inside: avoid; }';
            html += 'tbody tr:last-child td { color: #92400e !important; font-weight: 800; font-size: 5.5px; padding: 3px 1px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important; }';
            
            // التذييل والتوقيعات
            html += '.page-footer { padding: 15px; margin-top: 25px; background: transparent; border-top: 1px solid #cbd5e1; -webkit-print-color-adjust: exact; print-color-adjust: exact; page-break-inside: avoid; page-break-before: avoid; page-break-after: avoid; }';
            html += '.signatures-section { display: flex; justify-content: space-between; margin-bottom: 12px; padding: 10px 0; border-bottom: 1px solid #cbd5e1; gap: 20px; page-break-inside: avoid; }';
            html += '.signature-box { flex: 1; text-align: center; padding: 8px; }';
            html += '.signature-box .title { font-size: 10px; font-weight: 700; color: #1e293b; margin-bottom: 18px; }';
            html += '.signature-box .line { border-top: 2px solid #64748b; width: 75%; margin: 18px auto 5px; }';
            html += '.signature-box .name { font-size: 9px; color: #475569; font-weight: 600; }';
            html += '.copyright-info { text-align: center; font-size: 9px; color: #475569; padding-top: 8px; }';
            html += '.copyright-info strong { color: #1e293b; font-weight: 700; }';
            
            // إخفاء العناصر التفاعلية والأزرار بشكل شامل
            html += 'button, .btn, .btn-primary, .btn-success, .btn-warning, .btn-danger, .btn-small, .resizer, .dropdown, .modal, .actions, input[type="checkbox"], select.no-print { display: none !important; visibility: hidden !important; }';
            html += 'td button, th button, .action-buttons { display: none !important; visibility: hidden !important; }';
            // إظهار الأعمدة المخفية
            html += 'th[style*="display: none"], td[style*="display: none"], th[style*="display:none"], td[style*="display:none"], .hidden-column { display: table-cell !important; visibility: visible !important; }';
            
            // تحسينات الطباعة
            html += '@media print {';
            html += '  * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }';
            html += '  .page-header { page-break-after: avoid; page-break-inside: avoid; }';
            html += '  .section-title { page-break-after: avoid; page-break-inside: avoid; }';
            html += '  table { page-break-inside: auto; }';
            html += '  tr { page-break-inside: avoid; page-break-after: auto; }';
            html += '  tbody tr:last-child { page-break-inside: avoid; }';
            html += '  thead { display: table-header-group; }';
            html += '}';
            
            html += '</style></head><body>';
            
            // الرأس
            html += '<div class="page-header">';
            html += '<h1>📊 نظام إدارة الرواتب المتقدم</h1>';
            html += '<div class="company">🏢 ROSEMARY COMPANY</div>';
            html += `<h2>مشروع: ${projectName} | الشهر: ${monthName}</h2>`;
            if (settings.showDateTime || settings.showUser) {
                html += '<div class="info">';
                if (settings.showDateTime) {
                    html += `📅 ${currentDate} | 🕐 ${currentTime}`;
                }
                if (settings.showUser) {
                    html += ` | 👤 ${currentUser?.email || 'غير محدد'}`;
                }
                html += '</div>';
            }
            html += '</div>';
            
            // الحصول على HTML التوقيعات مرة واحدة
            const signaturesHTML = getSignaturesHTML();
            
            // إضافة كل جدول مع التوقيعات بعده
            tables.forEach((item, index) => {
                html += '<div class="table-section">';
                html += `<div class="section-title">📋 ${item.title}</div>`;
                html += item.table.outerHTML;
                
                // إضافة التذييل مع التوقيعات بعد كل جدول
                html += '<div class="page-footer">';
                if (signaturesHTML) {
                    html += signaturesHTML;
                }
                html += '<div class="copyright-info">';
                html += '<strong>Powered by ROSEMARY</strong> - نظام إدارة الرواتب المتقدم 2025 | ';
                html += `تاريخ الطباعة: ${currentDate} | `;
                html += `جدول ${index + 1} من ${tables.length}`;
                html += '</div></div>';
                
                html += '</div>'; // نهاية table-section
            });
            
            // سكريبت الطباعة التلقائية
            html += '<scr' + 'ipt>window.onload = function() { setTimeout(function() { window.print(); }, 1000); };</scr' + 'ipt>';
            html += '</body></html>';
            
            return html;
        }
        
        function getEmployeesForPrint() {
            // جمع الموظفين حسب العرض الحالي
            if (currentView === 'month' && employeeData[currentYear] && employeeData[currentYear][currentMonth]) {
                return employeeData[currentYear][currentMonth];
            } else if (currentView === 'project' && employeeData[currentYear] && employeeData[currentYear][selectedProjectMonth]) {
                return employeeData[currentYear][selectedProjectMonth].filter(emp => emp.project === currentProject);
            }
            return [];
        }
        
        function generateProfessionalTemplate(employees, settings) {
            const currentDate = new Date().toLocaleDateString('ar-EG', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const currentTime = new Date().toLocaleTimeString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const monthName = currentMonth ? t('monthNames')[currentMonth] : '';
            const projectName = currentProject ? projects[currentProject] : '';
            const pageName = monthName || projectName || 'التقرير';
            
            // تحميل إعدادات الشركة
            const companyNameAr = companySettings.companyNameAr || '';
            const companyNameEn = companySettings.companyNameEn || 'ROSEMARY COMPANY';
            const companyLogo = companySettings.companyLogo || '';
            
            // حساب المجاميع
            let totalUSD = 0, totalIQD = 0;
            let usdCount = 0, iqdCount = 0;
            
            employees.forEach(emp => {
                const netSalary = calculateNetSalary(emp);
                if (emp.paymentCurrency === 'USD') {
                    totalUSD += netSalary;
                    usdCount++;
                } else {
                    totalIQD += netSalary * (emp.exchangeRate || 1420);
                    iqdCount++;
                }
            });
            
            // البناء HTML
            let html = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>تقرير الرواتب - ${pageName} - ${currentYear}</title>
                    <style>
                        @media print {
                            @page {
                                size: ${settings.pageSize} ${settings.orientation};
                                ${settings.pageSize === 'A3' ? 'margin: 0.5cm 0.8cm 2.5cm 0.8cm;' : 'margin: 1.5cm 1cm;'}
                            }
                            ${settings.blackAndWhite ? `
                            * {
                                color: #000 !important;
                                background: #fff !important;
                            }
                            ` : `
                            * {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                            `}
                            
                            ${settings.pageSize === 'A3' ? `
                            body {
                                padding-bottom: 140px !important;
                            }
                            .print-footer {
                                position: fixed;
                                bottom: 0;
                                left: 0;
                                right: 0;
                                height: 120px;
                                background: white;
                                border-top: 2px solid #667eea;
                                padding: 10px;
                                page-break-inside: avoid;
                            }
                            .signature-section {
                                position: fixed;
                                bottom: 0;
                                left: 0;
                                right: 0;
                                height: 120px;
                                background: white;
                                padding: 10px 20px;
                                page-break-inside: avoid;
                            }
                            ` : ''}
                        }
                        
                        body {
                            font-family: 'Arial', 'Tahoma', sans-serif;
                            font-size: ${settings.pageSize === 'A3' ? '13px' : '10px'};
                            margin: 0;
                            padding: 0;
                            direction: rtl;
                        }
                        
                        .print-header {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            padding: ${settings.pageSize === 'A3' ? '12px 15px' : '25px 20px'};
                            text-align: center;
                            border-radius: ${settings.pageSize === 'A3' ? '8px' : '12px'};
                            margin-bottom: ${settings.pageSize === 'A3' ? '10px' : '20px'};
                            ${!settings.blackAndWhite ? '-webkit-print-color-adjust: exact; print-color-adjust: exact;' : ''}
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                            page-break-inside: avoid;
                            page-break-after: avoid;
                        }
                        
                        ${settings.showLogo ? `
                        .company-logo {
                            width: 70px;
                            height: 70px;
                            background: rgba(255,255,255,0.9);
                            border-radius: 50%;
                            margin: 0 auto 15px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 35px;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                        }
                        ` : ''}
                        
                        .report-title {
                            color: white;
                            font-size: ${settings.pageSize === 'A3' ? '18px' : '22px'};
                            font-weight: bold;
                            margin: ${settings.pageSize === 'A3' ? '4px 0' : '10px 0'};
                            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
                        }
                        
                        .report-subtitle {
                            color: rgba(255,255,255,0.95);
                            font-size: ${settings.pageSize === 'A3' ? '13px' : '16px'};
                            margin: ${settings.pageSize === 'A3' ? '2px 0' : '5px 0'};
                            font-weight: 600;
                        }
                        
                        .company-name {
                            color: rgba(255,255,255,0.9);
                            font-size: ${settings.pageSize === 'A3' ? '11px' : '13px'};
                            margin: ${settings.pageSize === 'A3' ? '2px 0' : '8px 0'};
                            font-weight: 700;
                        }
                        
                        .company-info {
                            color: rgba(255,255,255,0.8);
                            font-size: ${settings.pageSize === 'A3' ? '10px' : '12px'};
                            margin: ${settings.pageSize === 'A3' ? '1px 0' : '4px 0'};
                            font-weight: 500;
                        }
                        
                        .info-bar {
                            display: flex;
                            justify-content: space-between;
                            background: #f5f7fa;
                            padding: ${settings.pageSize === 'A3' ? '8px 12px' : '15px 20px'};
                            border-radius: ${settings.pageSize === 'A3' ? '6px' : '10px'};
                            margin-bottom: ${settings.pageSize === 'A3' ? '10px' : '20px'};
                            flex-wrap: wrap;
                            gap: 8px;
                            page-break-inside: avoid;
                        }
                        
                        .info-item {
                            display: flex;
                            align-items: center;
                            gap: 6px;
                            font-size: ${settings.pageSize === 'A3' ? '12px' : '11px'};
                            font-weight: 600;
                            color: #374151;
                        }
                        
                        .info-item strong {
                            color: #1f2937;
                        }
                        
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: ${settings.pageSize === 'A3' ? '10px' : '20px'};
                            font-size: ${settings.pageSize === 'A3' ? '12px' : '9px'};
                        }
                        
                        thead {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            ${!settings.blackAndWhite ? '-webkit-print-color-adjust: exact; print-color-adjust: exact;' : ''}
                        }
                        
                        thead th {
                            color: white;
                            padding: ${settings.pageSize === 'A3' ? '10px 8px' : '12px 6px'};
                            text-align: center;
                            font-weight: 700;
                            font-size: ${settings.pageSize === 'A3' ? '12px' : '9px'};
                            border: 1px solid rgba(255,255,255,0.3);
                        }
                        
                        tbody tr {
                            border-bottom: 1px solid #e5e7eb;
                        }
                        
                        tbody tr:nth-child(even) {
                            background: #f9fafb;
                        }
                        
                        tbody td {
                            padding: ${settings.pageSize === 'A3' ? '10px 8px' : '8px 6px'};
                            text-align: center;
                            border: 1px solid #e5e7eb;
                            font-size: ${settings.pageSize === 'A3' ? '12px' : '9px'};
                        }
                        
                        tfoot tr {
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            ${!settings.blackAndWhite ? '-webkit-print-color-adjust: exact; print-color-adjust: exact;' : ''}
                        }
                        
                        tfoot td {
                            color: white;
                            font-weight: bold;
                            padding: ${settings.pageSize === 'A3' ? '10px 8px' : '12px 6px'};
                            text-align: center;
                            font-size: ${settings.pageSize === 'A3' ? '13px' : '10px'};
                            border: 1px solid rgba(255,255,255,0.3);
                        }
                        
                        .print-footer {
                            margin-top: ${settings.pageSize === 'A3' ? '15px' : '30px'};
                            text-align: center;
                            padding-top: ${settings.pageSize === 'A3' ? '8px' : '15px'};
                            border-top: 2px solid #667eea;
                            font-size: ${settings.pageSize === 'A3' ? '12px' : '10px'};
                            color: #6b7280;
                            page-break-inside: avoid;
                        }
                        
                        ${settings.showSignatures ? `
                        .signature-section {
                            display: flex;
                            justify-content: space-around;
                            margin-top: ${settings.pageSize === 'A3' ? '20px' : '50px'};
                            page-break-inside: avoid;
                            page-break-before: avoid;
                            ${settings.pageSize === 'A3' ? 'margin-bottom: 0;' : ''}
                        }
                        
                        .signature-box {
                            text-align: center;
                            width: ${settings.pageSize === 'A3' ? '200px' : '180px'};
                        }
                        
                        .signature-line {
                            border-top: 2px solid #000;
                            margin-top: ${settings.pageSize === 'A3' ? '40px' : '60px'};
                            padding-top: ${settings.pageSize === 'A3' ? '6px' : '10px'};
                            font-weight: bold;
                            font-size: ${settings.pageSize === 'A3' ? '13px' : '11px'};
                        }
                        ` : ''}
                        
                        ${settings.showPageNumbers ? `
                        @page {
                            @bottom-right {
                                content: "صفحة " counter(page);
                            }
                        }
                        ` : ''}
                    </style>
                </head>
                <body>
                    <!-- الترويسة -->
                    <div class="print-header">
                        ${settings.showLogo && companyLogo ? `<div class="company-logo"><img src="${companyLogo}" style="max-width: 100%; max-height: 100%; border-radius: 50%; object-fit: contain;"></div>` : ''}
                        <div class="company-name">${companyNameEn || 'ROSEMARY COMPANY'}</div>
                        ${companyNameAr ? `<div class="company-name" style="font-size: 14px; margin-top: 5px;">${companyNameAr}</div>` : ''}
                        <h1 class="report-title">📊 تقرير الرواتب الشهري</h1>
                        <h2 class="report-subtitle">${pageName} - ${currentYear}</h2>
                        ${companySettings.companyAddress ? `<div class="company-info">📍 ${companySettings.companyAddress}</div>` : ''}
                        ${companySettings.companyPhone ? `<div class="company-info">📞 ${companySettings.companyPhone}</div>` : ''}
                        ${companySettings.companyEmail ? `<div class="company-info">📧 ${companySettings.companyEmail}</div>` : ''}
                    </div>
                    
                    <!-- شريط المعلومات -->
                    <div class="info-bar">
                        ${settings.showDateTime ? `
                        <div class="info-item">
                            <strong>📅 التاريخ:</strong>
                            <span>${currentDate}</span>
                        </div>
                        <div class="info-item">
                            <strong>🕐 الوقت:</strong>
                            <span>${currentTime}</span>
                        </div>
                        ` : ''}
                        <div class="info-item">
                            <strong>👥 عدد الموظفين:</strong>
                            <span>${employees.length}</span>
                        </div>
                        ${settings.showUser ? `
                        <div class="info-item">
                            <strong>👤 المستخدم:</strong>
                            <span>${currentUser?.email || 'غير محدد'}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- الجدول -->
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>الاسم</th>
                                <th>المنصب</th>
                                <th>النوع</th>
                                <th>المشروع</th>
                                <th>الراتب</th>
                                <th>العملة</th>
                                <th>الدوام</th>
                                <th>الفعلي USD</th>
                                <th>الفعلي IQD</th>
                                <th>البونص</th>
                                <th>الخصومات</th>
                                <th>السلف</th>
                                <th>الصافي</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // إضافة صفوف الموظفين
            employees.forEach((emp, index) => {
                const empName = getEmployeeName(emp);
                const typeText = getEmployeeTypeText(emp.employeeType);
                const projectName = projects[emp.project] || emp.project || '-';
                const workDays = calculateWorkDaysFromAttendance(emp);
                const actualUSD = calculateActualSalary(emp);
                const actualIQD = actualUSD * (emp.exchangeRate || 1420);
                const netSalary = calculateNetSalary(emp);
                
                // التحقق من وجود دوام فعلي: إذا كان attendance موجود وليس فارغاً، أو إذا كان workDays > 0
                const hasAttendance = emp.attendance && typeof emp.attendance === 'object' && Object.keys(emp.attendance).length > 0;
                const attendanceDisplay = (workDays > 0 || (emp.attendanceSystem === 'fixed')) ? workDays.toFixed(1) : '-';
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${empName}</td>
                        <td>${emp.position || '-'}</td>
                        <td>${typeText}</td>
                        <td>${projectName}</td>
                        <td>${formatCurrency(emp.salary)}</td>
                        <td>${emp.salaryCurrency || 'USD'}</td>
                        <td>${attendanceDisplay}</td>
                        <td>${formatCurrency(actualUSD)}</td>
                        <td>${formatCurrency(actualIQD)}</td>
                        <td>${formatCurrency(emp.bonus || 0)}</td>
                        <td>${formatCurrency(emp.deductions || 0)}</td>
                        <td>${formatCurrency(emp.advance || 0)}</td>
                        <td style="font-weight: bold;">${formatCurrency(netSalary)} ${emp.paymentCurrency}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
            `;
            
            // صف المجموع
            if (settings.showTotals) {
                html += `
                        <tfoot>
                            <tr>
                                <td colspan="13" style="text-align: center; font-size: 12px;">💰 المجموع الكلي</td>
                                <td style="font-size: 12px;">
                                    ${usdCount > 0 ? `💵 ${formatCurrency(totalUSD)} USD<br>` : ''}
                                    ${iqdCount > 0 ? `💰 ${formatCurrency(totalIQD)} IQD` : ''}
                                </td>
                            </tr>
                        </tfoot>
                `;
            }
            
            html += `
                    </table>
                    
                    <!-- التذييل -->
                    <div class="print-footer">
                        <p>🔒 هذا التقرير سري ومخصص للاستخدام الداخلي فقط</p>
                        <p style="margin-top: 8px; font-size: 11px; color: #6366f1; font-weight: 600;">
                            🌿 Powered by ROSEMARY | PayRose System
                        </p>
                        <p style="margin-top: 3px; font-size: 9px; color: #9ca3af;">
                            © ${currentYear} ${companyNameEn || 'ROSEMARY COMPANY'} - نظام الرواتب الاحترافي
                        </p>
                    </div>
            `;
            
            // قسم التوقيعات
            if (settings.showSignatures) {
                html += `
                    <div class="signature-section">
                        <div class="signature-box">
                            <div class="signature-line">المحاسب</div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line">المدير المالي</div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line">المدير العام</div>
                        </div>
                    </div>
                `;
            }
            
            html += `
                </body>
                </html>
            `;
            
            return html;
        }
        
        function generateSimpleTemplate(employees, settings) {
            // قالب بسيط للطباعة السريعة
            const monthName = currentMonth ? t('monthNames')[currentMonth] : '';
            const projectName = currentProject ? projects[currentProject] : '';
            const pageName = monthName || projectName || 'التقرير';
            
            // تحميل إعدادات الشركة
            const companyNameAr = companySettings.companyNameAr || '';
            const companyNameEn = companySettings.companyNameEn || 'ROSEMARY COMPANY';
            
            let html = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>تقرير - ${pageName}</title>
                    <style>
                        @page { size: ${settings.pageSize} ${settings.orientation}; margin: 2cm; }
                        body { font-family: Arial; font-size: 11px; }
                        h1 { text-align: center; border-bottom: 3px solid #000; padding-bottom: 10px; }
                        .company-header { text-align: center; margin-bottom: 10px; }
                        .company-header h2 { margin: 5px 0; font-size: 14px; color: #333; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: center; }
                        th { background: #ddd; font-weight: bold; }
                        .total { background: #eee; font-weight: bold; }
                        .footer { text-align: center; margin-top: 20px; font-size: 9px; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="company-header">
                        <h2>${companyNameEn}</h2>
                        ${companyNameAr ? `<h2>${companyNameAr}</h2>` : ''}
                    </div>
                    <h1>تقرير الرواتب - ${pageName} - ${currentYear}</h1>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>الاسم</th>
                                <th>المنصب</th>
                                <th>النوع</th>
                                <th>الدوام</th>
                                <th>الصافي</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let total = 0;
            employees.forEach((emp, index) => {
                const netSalary = calculateNetSalary(emp);
                total += emp.paymentCurrency === 'USD' ? netSalary : (netSalary * (emp.exchangeRate || 1420));
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${getEmployeeName(emp)}</td>
                        <td>${emp.position || '-'}</td>
                        <td>${getEmployeeTypeText(emp.employeeType)}</td>
                        <td>${calculateWorkDaysFromAttendance(emp).toFixed(1)}</td>
                        <td>${formatCurrency(netSalary)} ${emp.paymentCurrency}</td>
                    </tr>
                `;
            });
            
            if (settings.showTotals) {
                html += `
                    <tr class="total">
                        <td colspan="5">المجموع</td>
                        <td>${formatCurrency(total)}</td>
                    </tr>
                `;
            }
            
            html += `
                        </tbody>
                    </table>
                    <div class="footer">
                        <p>🌿 Powered by ROSEMARY | PayRose System</p>
                        <p>© ${currentYear} ${companyNameEn} - نظام الرواتب الاحترافي</p>
                    </div>
                </body>
                </html>
            `;
            
            return html;
        }
        
        function generateFormalTemplate(employees, settings) {
            // نفس القالب الاحترافي لكن مع توقيعات إلزامية
            settings.showSignatures = true;
            return generateProfessionalTemplate(employees, settings);
        }
        
        function executePrintPayslips(settings) {
            showNotification('info', 'قريباً', 'كشوفات الرواتب الفردية قيد التطوير 🚧');
        }
        
        function executePrintSummary(settings) {
            showNotification('info', 'قريباً', 'تقرير الملخص قيد التطوير 🚧');
        }
        
        function showPrintPreview(htmlContent) {
            setHTML(document.getElementById('printPreviewContent'), htmlContent);
            openModal('printPreviewModal');
        }
        
        function printFromPreview() {
            const htmlContent = document.getElementById('printPreviewContent').innerHTML;
            executePrintNow(htmlContent, currentPrintSettings);
        }
        
        function savePDFFromPreview() {
            // سيتم استخدام window.print() مع حفظ كـ PDF
            printFromPreview();
            showNotification('info', 'نصيحة', 'اختر "حفظ كـ PDF" من نافذة الطباعة 💾');
        }
        
        function adjustPrintSettings() {
            closeModal('printPreviewModal');
            openModal('printOptionsModal');
        }
        
        // ========== طباعة قسائم ملخص الراتب ==========
        function openSalaryVouchersModal() {
            // تحديث قائمة الشهور
            const monthSelect = document.getElementById('voucherMonthSelect');
            if (monthSelect) {
                monthSelect.innerHTML = '';
                months.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m;
                    option.textContent = translations[currentLang].monthNames[m];
                    if (m === currentMonth) option.selected = true;
                    monthSelect.appendChild(option);
                });
            }
            
            // تحديث قائمة السنوات
            const yearSelect = document.getElementById('voucherYearSelect');
            if (yearSelect) {
                yearSelect.innerHTML = '';
                availableYears.forEach(y => {
                    const option = document.createElement('option');
                    option.value = y;
                    option.textContent = y;
                    if (y === currentYear) option.selected = true;
                    yearSelect.appendChild(option);
                });
            }
            
            // تحديث قائمة المشاريع
            const projectSelect = document.getElementById('voucherProjectSelect');
            if (projectSelect) {
                projectSelect.innerHTML = '<option value="all">جميع المشاريع</option>';
                Object.entries(projects).forEach(([key, name]) => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = name;
                    projectSelect.appendChild(option);
                });
            }
            
            openModal('salaryVouchersModal');
        }
        
        function printSalaryVouchers() {
            const month = document.getElementById('voucherMonthSelect')?.value || currentMonth;
            const year = parseInt(document.getElementById('voucherYearSelect')?.value || currentYear);
            const project = document.getElementById('voucherProjectSelect')?.value || 'all';
            const employeeType = document.getElementById('voucherEmployeeType')?.value || 'all';
            
            // جمع الموظفين
            let employees = [];
            if (employeeData[year] && employeeData[year][month]) {
                employees = employeeData[year][month].filter(emp => {
                    // تصفية حسب المشروع
                    if (project !== 'all' && emp.project !== project) return false;
                    // تصفية حسب نوع الموظف
                    if (employeeType !== 'all' && emp.employeeType !== employeeType) return false;
                    // تصفية حسب الصلاحيات
                    return hasProjectAccess(emp.project);
                });
            }
            
            if (employees.length === 0) {
                showNotification('warning', 'تحذير', 'لا توجد بيانات للطباعة');
                return;
            }
            
            closeModal('salaryVouchersModal');
            
            // إنشاء HTML للقسائم
            const html = generateSalaryVouchersHTML(employees, month, year);
            
            // فتح نافذة الطباعة
            const printWindow = window.open('', '_blank', 'width=1200,height=800');
            if (!printWindow) {
                showNotification('error', 'خطأ', 'تعذر فتح نافذة الطباعة. تأكد من السماح بالنوافذ المنبثقة.');
                return;
            }
            
            printWindow.document.write(html);
            printWindow.document.close();
            
            // طباعة تلقائية بعد تحميل الصفحة
            setTimeout(() => {
                printWindow.print();
            }, 1000);
            
            showNotification('success', 'جاهز', `تم فتح نافذة الطباعة لـ ${employees.length} موظف! 🖨️`);
        }
        
        function generateSalaryVouchersHTML(employees, month, year) {
            const monthName = translations[currentLang].monthNames[month];
            const companyName = companySettings.companyNameAr || companySettings.companyNameEn || 'الشركة';
            
            // تقسيم الموظفين إلى مجموعات من 24 (صفحة واحدة)
            const vouchersPerPage = 24; // 4 صفوف × 6 أعمدة
            const pages = [];
            
            for (let i = 0; i < employees.length; i += vouchersPerPage) {
                pages.push(employees.slice(i, i + vouchersPerPage));
            }
            
            let html = `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>قسائم ملخص الراتب - ${monthName} ${year}</title>
    <style>
        @page {
            size: A3 landscape;
            margin: 5mm;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            font-size: 9px;
            line-height: 1.3;
            color: #000;
            background: white;
            padding: 5mm;
        }
        
        .voucher-page {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 2mm;
            page-break-after: always;
        }
        
        .voucher-page:last-child {
            page-break-after: auto;
        }
        
        .voucher {
            border: 1.5px solid #333;
            padding: 3mm;
            background: white;
            display: flex;
            flex-direction: column;
            page-break-inside: avoid;
            position: relative;
        }
        
        .voucher-header {
            text-align: center;
            border-bottom: 1.5px solid #333;
            padding-bottom: 2mm;
            margin-bottom: 2mm;
        }
        
        .voucher-company {
            font-weight: 700;
            font-size: 10px;
            margin-bottom: 1mm;
            color: #1e40af;
        }
        
        .voucher-title {
            font-weight: 600;
            font-size: 9px;
            color: #333;
        }
        
        .voucher-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5mm;
        }
        
        .voucher-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 8px;
        }
        
        .voucher-label {
            font-weight: 600;
            color: #555;
            min-width: 35%;
        }
        
        .voucher-value {
            font-weight: 700;
            color: #000;
            text-align: left;
            flex: 1;
        }
        
        .voucher-divider {
            border-top: 1px solid #ccc;
            margin: 1mm 0;
        }
        
        .voucher-total {
            border-top: 2px solid #333;
            padding-top: 2mm;
            margin-top: 1mm;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 10px;
            background: #f0f9ff;
            padding: 2mm;
            border-radius: 2px;
        }
        
        .voucher-footer {
            text-align: center;
            border-top: 1px solid #ccc;
            padding-top: 1mm;
            margin-top: 1mm;
            font-size: 7px;
            color: #666;
        }
        
        .voucher-signature {
            margin-top: 3mm;
            padding-top: 2mm;
            border-top: 1px dashed #999;
            display: flex;
            flex-direction: column;
            gap: 1mm;
        }
        
        .signature-line {
            border-top: 1px solid #333;
            margin-top: 8mm;
            padding-top: 1mm;
            text-align: center;
            font-size: 7px;
            font-weight: 600;
        }
        
        .additions-section, .deductions-section {
            margin-top: 1mm;
        }
        
        .additions-section .voucher-row {
            color: #059669;
        }
        
        .deductions-section .voucher-row {
            color: #dc2626;
        }
        
        .work-days-info {
            background: #f0f9ff;
            padding: 1.5mm;
            border-radius: 2px;
            margin: 1mm 0;
            font-size: 8px;
        }
        
        .payment-currency-badge {
            display: inline-block;
            background: #1e40af;
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 7px;
            font-weight: 700;
            margin-right: 2px;
        }
        
        @media print {
            body {
                margin: 0;
                padding: 0;
            }
            
            .voucher {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .voucher-total {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>`;
            
            // إنشاء صفحة لكل مجموعة من 24 موظف
            pages.forEach((pageEmployees, pageIndex) => {
                html += `<div class="voucher-page">`;
                
                // إنشاء قسيمة لكل موظف
                pageEmployees.forEach((emp, index) => {
                    const netSalary = calculateNetSalary(emp, month, year);
                    const exchangeRate = parseFloat(emp.exchangeRate) || 1420;
                    const paymentCurrency = emp.paymentCurrency || 'IQD';
                    const salaryCurrency = emp.salaryCurrency || 'USD';
                    
                    // حساب أيام العمل
                    const workDays = calculateWorkDaysFromAttendance(emp);
                    const actualDaysInMonth = getActualDaysInMonth(year, month);
                    
                    // الراتب الأساسي (الراتب الأصلي المدخل) بعملة الراتب الأصلية
                    const baseSalary = parseFloat(emp.salary) || 0;
                    const basicSalary = baseSalary; // الراتب الأساسي بعملة الراتب الأصلية
                    
                    // حساب الراتب الفعلي بعد حساب أيام العمل (للاستخدام في الحسابات)
                    const actualSalaryUSD = calculateActualSalary(emp, month, year);
                    
                    // الراتب الأساسي بعملة الدفع (للاستخدام في الحسابات)
                    const basicSalaryInPaymentCurrency = convertToPaymentCurrency(actualSalaryUSD, 'USD', emp);
                    const bonus = convertToPaymentCurrency(emp.bonus || 0, emp.bonusCurrency || 'IQD', emp);
                    const phoneBills = convertToPaymentCurrency(emp.phoneBills || 0, emp.phoneBillsCurrency || 'IQD', emp);
                    const ceoBonus = convertToPaymentCurrency(emp.ceoBonus || 0, emp.ceoBonusCurrency || 'IQD', emp);
                    const deductions = convertToPaymentCurrency(emp.deductions || 0, emp.deductionsCurrency || 'IQD', emp);
                    const advance = convertToPaymentCurrency(emp.advance || 0, emp.advanceCurrency || 'IQD', emp);
                    
                    // حساب إجمالي الإضافات والخصومات
                    const totalAdditions = bonus + phoneBills + ceoBonus;
                    const totalDeductions = deductions + advance;
                    
                    // نوع الموظف
                    const employeeTypeText = emp.employeeType === 'monthly' ? 'شهري' : 
                                           emp.employeeType === 'daily' ? 'يومي' : 
                                           emp.employeeType === 'vehicle' ? 'سيارة' : 'غير محدد';
                    
                    html += '<div class="voucher">';
                    html += '<div class="voucher-header">';
                    html += '<div class="voucher-company">' + companyName + '</div>';
                    html += '<div class="voucher-title">قسيمة ملخص الراتب - ' + monthName + ' ' + year + '</div>';
                    html += '</div>';
                    html += '<div class="voucher-body">';
                    
                    // معلومات الموظف الأساسية
                    html += '<div class="voucher-row">';
                    html += '<span class="voucher-label">الاسم:</span>';
                    html += '<span class="voucher-value">' + (emp.nameAr || emp.nameEn || 'N/A') + '</span>';
                    html += '</div>';
                    html += '<div class="voucher-row">';
                    html += '<span class="voucher-label">الرمز:</span>';
                    html += '<span class="voucher-value">' + (emp.employeeCode || 'N/A') + '</span>';
                    html += '</div>';
                    html += '<div class="voucher-row">';
                    html += '<span class="voucher-label">المنصب:</span>';
                    html += '<span class="voucher-value">' + (emp.position || 'N/A') + '</span>';
                    html += '</div>';
                    html += '<div class="voucher-row">';
                    html += '<span class="voucher-label">المشروع:</span>';
                    html += '<span class="voucher-value">' + (projects[emp.project] || emp.project || 'N/A') + '</span>';
                    html += '</div>';
                    html += '<div class="voucher-row">';
                    html += '<span class="voucher-label">نوع الموظف:</span>';
                    html += '<span class="voucher-value">' + employeeTypeText + '</span>';
                    html += '</div>';
                    
                    // أيام العمل وسعر الصرف
                    html += '<div class="work-days-info">';
                    html += '<div class="voucher-row">';
                    html += '<span class="voucher-label">أيام العمل:</span>';
                    html += '<span class="voucher-value">' + workDays + ' / ' + actualDaysInMonth + ' يوم</span>';
                    html += '</div>';
                    html += '<div class="voucher-row" style="margin-top: 1mm; font-size: 7px;">';
                    html += '<span class="voucher-label">سعر الصرف:</span>';
                    html += '<span class="voucher-value">1 USD = ' + formatCurrency(exchangeRate) + ' IQD</span>';
                    html += '</div>';
                    html += '</div>';
                    
                    html += '<div class="voucher-divider"></div>';
                    
                    // الراتب الأساسي (بعملة الراتب الأصلية)
                    html += '<div class="voucher-row">';
                    html += '<span class="voucher-label">الراتب الأساسي:</span>';
                    html += '<span class="voucher-value">' + formatCurrency(basicSalary) + ' <span class="payment-currency-badge">' + salaryCurrency + '</span></span>';
                    html += '</div>';
                    
                    // الراتب الفعلي (بعد حساب أيام العمل) - فقط إذا كان مختلفاً عن الراتب الأساسي
                    if (Math.abs(actualSalaryUSD - basicSalary) > 0.01 || (salaryCurrency === 'IQD' && Math.abs(actualSalaryUSD * exchangeRate - basicSalary) > 0.01)) {
                        const actualSalaryDisplay = salaryCurrency === 'IQD' ? actualSalaryUSD * exchangeRate : actualSalaryUSD;
                        html += '<div class="voucher-row" style="font-size: 7.5px; color: #666; padding-right: 2mm;">';
                        html += '<span class="voucher-label">الراتب الفعلي (بعد حساب أيام العمل):</span>';
                        html += '<span class="voucher-value">' + formatCurrency(actualSalaryDisplay) + ' <span class="payment-currency-badge" style="background: #059669;">' + salaryCurrency + '</span></span>';
                        html += '</div>';
                    }
                    
                    // الإضافات
                    if (totalAdditions > 0) {
                        html += '<div class="additions-section">';
                        html += '<div class="voucher-row" style="font-weight: 700; margin-top: 1mm; color: #059669;">';
                        html += '<span class="voucher-label">الإضافات:</span>';
                        html += '<span class="voucher-value">' + formatCurrency(totalAdditions) + ' <span class="payment-currency-badge">' + paymentCurrency + '</span></span>';
                        html += '</div>';
                        if (bonus > 0) {
                            html += '<div class="voucher-row" style="padding-right: 3mm;">';
                            html += '<span class="voucher-label">  • العلاوة:</span>';
                            html += '<span class="voucher-value">' + formatCurrency(bonus) + ' <span class="payment-currency-badge">' + paymentCurrency + '</span></span>';
                            html += '</div>';
                        }
                        if (phoneBills > 0) {
                            html += '<div class="voucher-row" style="padding-right: 3mm;">';
                            html += '<span class="voucher-label">  • فاتورة الهاتف:</span>';
                            html += '<span class="voucher-value">' + formatCurrency(phoneBills) + ' <span class="payment-currency-badge">' + paymentCurrency + '</span></span>';
                            html += '</div>';
                        }
                        if (ceoBonus > 0) {
                            html += '<div class="voucher-row" style="padding-right: 3mm;">';
                            html += '<span class="voucher-label">  • علاوة المدير:</span>';
                            html += '<span class="voucher-value">' + formatCurrency(ceoBonus) + ' <span class="payment-currency-badge">' + paymentCurrency + '</span></span>';
                            html += '</div>';
                        }
                        html += '</div>';
                    }
                    
                    // الخصومات
                    if (totalDeductions > 0) {
                        html += '<div class="deductions-section">';
                        html += '<div class="voucher-row" style="font-weight: 700; margin-top: 1mm; color: #dc2626;">';
                        html += '<span class="voucher-label">الخصومات:</span>';
                        html += '<span class="voucher-value">-' + formatCurrency(totalDeductions) + ' <span class="payment-currency-badge">' + paymentCurrency + '</span></span>';
                        html += '</div>';
                        if (deductions > 0) {
                            html += '<div class="voucher-row" style="padding-right: 3mm;">';
                            html += '<span class="voucher-label">  • خصومات:</span>';
                            html += '<span class="voucher-value">-' + formatCurrency(deductions) + ' <span class="payment-currency-badge">' + paymentCurrency + '</span></span>';
                            html += '</div>';
                        }
                        if (advance > 0) {
                            html += '<div class="voucher-row" style="padding-right: 3mm;">';
                            html += '<span class="voucher-label">  • السلفة:</span>';
                            html += '<span class="voucher-value">-' + formatCurrency(advance) + ' <span class="payment-currency-badge">' + paymentCurrency + '</span></span>';
                            html += '</div>';
                        }
                        html += '</div>';
                    }
                    
                    html += '<div class="voucher-divider"></div>';
                    
                    // الراتب الصافي
                    html += '<div class="voucher-total">';
                    html += '<span>الراتب الصافي:</span>';
                    html += '<span style="font-size: 11px; color: #1e40af; font-weight: 800;">';
                    html += formatCurrency(netSalary) + ' <span class="payment-currency-badge" style="background: #1e40af; font-size: 8px; padding: 2px 5px;">' + paymentCurrency + '</span>';
                    html += '</span>';
                    html += '</div>';
                    html += '</div>';
                    
                    // التوقيع
                    html += '<div class="voucher-signature">';
                    html += '<div class="signature-line">';
                    html += 'توقيع الموظف';
                    html += '</div>';
                    html += '</div>';
                    
                    // التذييل
                    html += '<div class="voucher-footer">';
                    const currentDate = new Date().toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
                    html += currentDate;
                    html += '</div>';
                    html += '</div>';
                });
                
                // ملء الصفحة بالقسائم الفارغة إذا لزم الأمر
                const remaining = vouchersPerPage - pageEmployees.length;
                for (let i = 0; i < remaining; i++) {
                    html += '<div class="voucher" style="border: 1px dashed #ccc; background: #f9fafb;"></div>';
                }
                
                html += '</div>';
            });
            
            html += '<script>';
            html += 'window.onload = function() {';
            html += '    setTimeout(function() {';
            html += '        window.print();';
            html += '    }, 500);';
            html += '};';
            html += '</' + 'script>';
            html += '</body>';
            html += '</html>';
            
            return html;
        }
        
        // تصدير الوظائف للاستخدام العالمي
        window.openSalaryVouchersModal = openSalaryVouchersModal;
        window.printSalaryVouchers = printSalaryVouchers;

        function executePrintNow(htmlContent, settings) {
            const printWindow = window.open('', '_blank', 'width=1200,height=800');
            
            if (!printWindow) {
                showNotification('error', 'خطأ', 'تعذر فتح نافذة الطباعة. تأكد من السماح بالنوافذ المنبثقة.');
                return;
            }
            
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                }, 500);
            };
            
            printWindow.onafterprint = function() {
                setTimeout(() => {
                    printWindow.close();
                }, 500);
            };
            
            closeModal('printPreviewModal');
            showNotification('success', 'جاهز', 'تم فتح نافذة الطباعة! 🖨️');
        }

        function importData() {
            document.getElementById('fileInput').click();
        }

        async function handleFileImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // التحقق من نوع الملف
            if (!file.name.endsWith('.json')) {
                showNotification('error', 'خطأ', 'الملف يجب أن يكون بصيغة JSON! ❌');
                return;
            }
            
                const reader = new FileReader();
                reader.onload = async function(event) {
                    try {
                        showLoading();
                        const data = JSON.parse(event.target.result);
                        
                    // التحقق من صحة البيانات
                    if (!data) {
                        throw new Error('الملف فارغ أو غير صالح');
                    }
                    
                    let importedCount = {
                        projects: 0,
                        employees: 0,
                        settings: false,
                        signatures: false
                    };
                    
                    // استيراد المشاريع
                    if (data.projects && typeof data.projects === 'object') {
                            for (const [code, name] of Object.entries(data.projects)) {
                            if (code && name) {
                                await saveProjectToFirebase(code, name);
                                importedCount.projects++;
                            }
                            }
                        }
                        
                    // استيراد بيانات الموظفين (مع دعم البنية القديمة والجديدة)
                        if (data.employeeData) {
                        if (typeof data.employeeData === 'object') {
                            // البنية الجديدة: employeeData[year][month] = []
                            for (const [year, yearData] of Object.entries(data.employeeData)) {
                                if (yearData && typeof yearData === 'object') {
                                    for (const [month, employees] of Object.entries(yearData)) {
                                        if (Array.isArray(employees)) {
                                for (const emp of employees) {
                                                if (emp && typeof emp === 'object') {
                                    const empCopy = {...emp};
                                    delete empCopy.firebaseId;
                                                    const yearNum = parseInt(year);
                                                    if (!isNaN(yearNum) && yearNum > 2000 && yearNum < 2100) {
                                                        await saveEmployeeToFirebase(empCopy, month, yearNum);
                                                        importedCount.employees++;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    // استيراد إعدادات الشركة
                    if (data.companySettings && typeof data.companySettings === 'object') {
                        await saveCompanySettings(data.companySettings);
                        importedCount.settings = true;
                    }
                    
                    // استيراد التوقيعات
                    if (data.printSignatures && typeof data.printSignatures === 'object') {
                        await savePrintSignatures(data.printSignatures);
                        importedCount.signatures = true;
                    }
                    
                    // إعادة تحميل البيانات
                        await loadProjectsFromFirebase();
                        await loadEmployeesFromFirebase();
                    await loadCompanySettings();
                    await loadPrintSignatures();
                    
                        hideLoading();
                    
                    // رسالة نجاح مفصلة
                    const message = currentLang === 'ar' 
                        ? `✅ تم الاستيراد بنجاح!\n\n` +
                          `📊 المشاريع: ${importedCount.projects}\n` +
                          `👥 الموظفون: ${importedCount.employees}\n` +
                          `⚙️ الإعدادات: ${importedCount.settings ? '✅' : '❌'}\n` +
                          `✍️ التوقيعات: ${importedCount.signatures ? '✅' : '❌'}`
                        : `✅ Import successful!\n\n` +
                          `📊 Projects: ${importedCount.projects}\n` +
                          `👥 Employees: ${importedCount.employees}\n` +
                          `⚙️ Settings: ${importedCount.settings ? '✅' : '❌'}\n` +
                          `✍️ Signatures: ${importedCount.signatures ? '✅' : '❌'}`;
                    
                    alert(message);
                    
                    // إعادة تحميل الصفحة لعرض البيانات الجديدة
                    location.reload();
                    
                    } catch (error) {
                        hideLoading();
                        console.error('Import error:', error);
                    const errorMsg = currentLang === 'ar' 
                        ? `خطأ في استيراد البيانات! ❌\n\n${error.message || 'ملف غير صالح'}`
                        : `Error importing data! ❌\n\n${error.message || 'Invalid file'}`;
                    alert(errorMsg);
                    }
                
                // إعادة تعيين input الملف
                e.target.value = '';
                };
                reader.readAsText(file);
        }

        document.getElementById('fileInput').addEventListener('change', handleFileImport);

        // ========== Migration from Firebase to Supabase ==========
        /**
         * نقل جميع البيانات من Firebase إلى Supabase
         * هذه الوظيفة تقرأ البيانات مباشرة من Firebase وتكتبها إلى Supabase
         */
        async function migrateToSupabase() {
            try {
                // التحقق من أن المستخدم يستخدم Firebase حالياً
                if (currentDbType !== 'firebase') {
                    const msg = currentLang === 'ar' 
                        ? '⚠️ يجب أن تكون قاعدة البيانات الحالية هي Firebase لنقل البيانات إلى Supabase.\n\nيرجى التبديل إلى Firebase أولاً.'
                        : '⚠️ Current database must be Firebase to migrate to Supabase.\n\nPlease switch to Firebase first.';
                    alert(msg);
                    return;
                }

                // تأكيد من المستخدم
                const confirmMsg = currentLang === 'ar'
                    ? '🔄 نقل البيانات من Firebase إلى Supabase\n\n' +
                      'سيتم:\n' +
                      '1. قراءة جميع البيانات من Firebase\n' +
                      '2. نقلها إلى Supabase\n' +
                      '3. إنشاء نسخة احتياطية تلقائياً\n\n' +
                      '⚠️ تأكد من:\n' +
                      '• أنك قمت بإنشاء الجداول في Supabase\n' +
                      '• أن Supabase متصل ويعمل بشكل صحيح\n\n' +
                      'هل تريد المتابعة؟'
                    : '🔄 Migrate Data from Firebase to Supabase\n\n' +
                      'Will:\n' +
                      '1. Read all data from Firebase\n' +
                      '2. Transfer to Supabase\n' +
                      '3. Create automatic backup\n\n' +
                      '⚠️ Make sure:\n' +
                      '• Tables are created in Supabase\n' +
                      '• Supabase is connected and working\n\n' +
                      'Do you want to continue?';

                if (!confirm(confirmMsg)) {
                    return;
                }

                showLoading();
                console.log('🔄 بدء نقل البيانات من Firebase إلى Supabase...');

                // 1. إنشاء نسخة احتياطية أولاً
                console.log('📦 الخطوة 1: إنشاء نسخة احتياطية...');
                await createBackup();

                // 2. قراءة البيانات من Firebase مباشرة
                console.log('📖 الخطوة 2: قراءة البيانات من Firebase...');
                
                const migrationStats = {
                    projects: 0,
                    employees: 0,
                    settings: 0,
                    users: 0,
                    activityLogs: 0,
                    errors: []
                };

                // نقل المشاريع
                try {
                    console.log('📁 نقل المشاريع...');
                    const projectsSnapshot = await getDocs(collection(db, 'projects'));
                    for (const projectDoc of projectsSnapshot.docs) {
                        const data = projectDoc.data();
                        await supabase
                            .from('projects')
                            .upsert({ 
                                id: projectDoc.id, 
                                name: data.name || data,
                                createdAt: data.createdAt || new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            }, { onConflict: 'id' });
                        migrationStats.projects++;
                    }
                    console.log(`✅ تم نقل ${migrationStats.projects} مشروع`);
                } catch (error) {
                    console.error('❌ خطأ في نقل المشاريع:', error);
                    migrationStats.errors.push(`المشاريع: ${error.message}`);
                }

                // نقل الموظفين
                try {
                    console.log('👥 نقل الموظفين...');
                    const employeesSnapshot = await getDocs(collection(db, 'employees'));
                    for (const empDoc of employeesSnapshot.docs) {
                        const data = empDoc.data();
                        // تنظيف البيانات وإزالة القيم undefined
                        const cleanData = cleanDataForFirebase(data);
                        await supabase
                            .from('employees')
                            .upsert({ 
                                id: empDoc.id,
                                ...cleanData,
                                updatedAt: new Date().toISOString()
                            }, { onConflict: 'id' });
                        migrationStats.employees++;
                    }
                    console.log(`✅ تم نقل ${migrationStats.employees} موظف`);
                } catch (error) {
                    console.error('❌ خطأ في نقل الموظفين:', error);
                    migrationStats.errors.push(`الموظفين: ${error.message}`);
                }

                // نقل الإعدادات
                try {
                    console.log('⚙️ نقل الإعدادات...');
                    const settingsSnapshot = await getDocs(collection(db, 'settings'));
                    for (const settingDoc of settingsSnapshot.docs) {
                        const data = settingDoc.data();
                        await supabase
                            .from('settings')
                            .upsert({ 
                                id: settingDoc.id,
                                data: data,
                                updatedAt: new Date().toISOString()
                            }, { onConflict: 'id' });
                        migrationStats.settings++;
                    }
                    console.log(`✅ تم نقل ${migrationStats.settings} إعداد`);
                } catch (error) {
                    console.error('❌ خطأ في نقل الإعدادات:', error);
                    migrationStats.errors.push(`الإعدادات: ${error.message}`);
                }

                // نقل المستخدمين
                try {
                    console.log('👤 نقل المستخدمين...');
                    const usersSnapshot = await getDocs(collection(db, 'users'));
                    for (const userDoc of usersSnapshot.docs) {
                        const data = userDoc.data();
                        await supabase
                            .from('users')
                            .upsert({ 
                                id: userDoc.id,
                                email: data.email,
                                name: data.name,
                                role: data.role,
                                ...data,
                                updatedAt: new Date().toISOString()
                            }, { onConflict: 'id' });
                        migrationStats.users++;
                    }
                    console.log(`✅ تم نقل ${migrationStats.users} مستخدم`);
                } catch (error) {
                    console.error('❌ خطأ في نقل المستخدمين:', error);
                    migrationStats.errors.push(`المستخدمين: ${error.message}`);
                }

                // نقل سجل الأنشطة
                try {
                    console.log('📝 نقل سجل الأنشطة...');
                    const logsSnapshot = await getDocs(collection(db, 'activity_logs'));
                    for (const logDoc of logsSnapshot.docs) {
                        const data = logDoc.data();
                        await supabase
                            .from('activity_logs')
                            .upsert({ 
                                id: logDoc.id,
                                ...data,
                                timestamp: data.timestamp || new Date().toISOString()
                            }, { onConflict: 'id' });
                        migrationStats.activityLogs++;
                    }
                    console.log(`✅ تم نقل ${migrationStats.activityLogs} سجل نشاط`);
                } catch (error) {
                    console.error('❌ خطأ في نقل سجل الأنشطة:', error);
                    migrationStats.errors.push(`سجل الأنشطة: ${error.message}`);
                }

                hideLoading();

                // عرض ملخص النقل
                let summaryMsg = currentLang === 'ar'
                    ? `✅ تم نقل البيانات بنجاح!\n\n📊 الملخص:\n` +
                      `• المشاريع: ${migrationStats.projects}\n` +
                      `• الموظفين: ${migrationStats.employees}\n` +
                      `• الإعدادات: ${migrationStats.settings}\n` +
                      `• المستخدمين: ${migrationStats.users}\n` +
                      `• سجل الأنشطة: ${migrationStats.activityLogs}\n\n` +
                      `💾 تم حفظ نسخة احتياطية تلقائياً`
                    : `✅ Data migration completed successfully!\n\n📊 Summary:\n` +
                      `• Projects: ${migrationStats.projects}\n` +
                      `• Employees: ${migrationStats.employees}\n` +
                      `• Settings: ${migrationStats.settings}\n` +
                      `• Users: ${migrationStats.users}\n` +
                      `• Activity Logs: ${migrationStats.activityLogs}\n\n` +
                      `💾 Backup was automatically saved`;

                if (migrationStats.errors.length > 0) {
                    summaryMsg += `\n\n⚠️ أخطاء:\n${migrationStats.errors.join('\n')}`;
                }

                alert(summaryMsg);

                // عرض خيار التبديل إلى Supabase
                const switchMsg = currentLang === 'ar'
                    ? '🔄 هل تريد التبديل إلى Supabase الآن؟\n\nسيتم إعادة تحميل الصفحة.'
                    : '🔄 Do you want to switch to Supabase now?\n\nThe page will reload.';

                if (confirm(switchMsg)) {
                    setDbType('supabase');
                    location.reload();
                }

            } catch (error) {
                hideLoading();
                console.error('❌ خطأ في نقل البيانات:', error);
                const errorMsg = currentLang === 'ar'
                    ? `خطأ في نقل البيانات! ❌\n\n${error.message}\n\n⚠️ يرجى التحقق من:\n` +
                      `• اتصال Supabase\n` +
                      `• إنشاء الجداول في Supabase\n` +
                      `• النسخة الاحتياطية المحفوظة تلقائياً`
                    : `Migration error! ❌\n\n${error.message}\n\n⚠️ Please check:\n` +
                      `• Supabase connection\n` +
                      `• Tables created in Supabase\n` +
                      `• Automatically saved backup`;
                alert(errorMsg);
            }
        }

        // ========== Activity Logging System ==========
        // دالة لتنظيف الكائنات من القيم undefined و null غير الصالحة
        function cleanDataForFirebase(obj) {
            if (obj === null || obj === undefined) {
                return null;
            }
            
            if (Array.isArray(obj)) {
                return obj.map(item => cleanDataForFirebase(item)).filter(item => item !== undefined);
            }
            
            if (typeof obj === 'object') {
                const cleaned = {};
                for (const [key, value] of Object.entries(obj)) {
                    if (value !== undefined) {
                        const cleanedValue = cleanDataForFirebase(value);
                        if (cleanedValue !== undefined) {
                            cleaned[key] = cleanedValue;
                        }
                    }
                }
                return cleaned;
            }
            
            return obj;
        }
        
        async function logActivity(action, entityType, entityId, entityName, changes = {}, details = '') {
            try {
                const user = auth.currentUser;
                if (!user) return;
                
                // محاولة الحصول على IP (مع timeout قصير)
                let ipAddress = 'unknown';
                try {
                    const ip = await Promise.race([
                        getUserIP(),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 2000))
                    ]);
                    if (ip) ipAddress = ip;
                } catch (error) {
                    // تجاهل الأخطاء - نستخدم 'unknown' كقيمة افتراضية
                }
                
                const activityData = {
                    id: `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`, // إنشاء ID فريد
                    userId: user.uid,
                    userEmail: user.email || 'unknown',
                    userName: user.displayName || user.email || 'Unknown User',
                    action: action, // 'create', 'update', 'delete', 'view', 'export', etc.
                    entityType: entityType, // 'employee', 'project', 'settings', etc.
                    entityId: entityId || '',
                    entityName: entityName || '',
                    changes: changes, // Object containing old and new values (JSONB في Supabase)
                    description: details || '',
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString('ar-EG'),
                    time: new Date().toLocaleTimeString('ar-EG'),
                    year: currentYear,
                    ipAddress: ipAddress
                };
                
                // تحديد نوع قاعدة البيانات المستخدمة
                const dbType = getDbType();
                
                if (dbType === 'supabase' && supabase) {
                    // استخدام Supabase
                    try {
                        const { error } = await supabase
                            .from('activity_logs')
                            .upsert({
                                id: activityData.id,
                                action: activityData.action,
                                entityType: activityData.entityType,
                                entityId: activityData.entityId,
                                entityName: activityData.entityName,
                                userId: activityData.userId,
                                userEmail: activityData.userEmail,
                                userName: activityData.userName,
                                changes: activityData.changes, // JSONB
                                description: activityData.description,
                                timestamp: activityData.timestamp,
                                date: activityData.date,
                                time: activityData.time,
                                year: activityData.year,
                                ipAddress: activityData.ipAddress
                            }, { onConflict: 'id' });
                        
                        if (error) throw error;
                        
                        // تتبع استخدام Supabase
                        trackSupabaseUsage('api', JSON.stringify(activityData).length);
                        
                        console.log('✅ Activity logged to Supabase:', action, entityType, entityName);
                    } catch (supabaseError) {
                        console.error('❌ Error logging activity to Supabase:', supabaseError);
                        // إذا فشل Supabase، حاول استخدام Firebase كبديل
                        await logActivityToFirebase(activityData);
                    }
                } else {
                    // استخدام Firebase (الافتراضي)
                    await logActivityToFirebase(activityData);
                }
            } catch (error) {
                console.error('❌ Error logging activity:', error);
                // لا نوقف العملية إذا فشل التتبع
            }
        }
        
        // دالة مساعدة لتسجيل النشاط في Firebase
        async function logActivityToFirebase(activityData) {
            try {
                // تنظيف البيانات للـ Firebase
                const cleanedData = cleanDataForFirebase(activityData);
                
                const activityRef = collection(db, 'activityLogs');
                await addDoc(activityRef, cleanedData);
                
                // تتبع استخدام Firebase
                trackFirebaseUsage('write', 1);
                
                console.log('✅ Activity logged to Firebase:', activityData.action, activityData.entityType, activityData.entityName);
            } catch (error) {
                console.error('❌ Error logging activity to Firebase:', error);
                throw error;
            }
        }
        
        // دالة للحصول على IP المستخدم (اختياري)
        async function getUserIP() {
            try {
                // إضافة timeout للطلب (3 ثوانٍ)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                const response = await fetch('https://api.ipify.org?format=json', {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    return null;
                }
                
                const data = await response.json();
                return data.ip || null;
            } catch (error) {
                // تجاهل الأخطاء (timeout, network error, etc.)
                return null;
            }
        }
        
        // دالة للحصول على تغييرات قبل/بعد (للتعديلات)
        function getChanges(oldData, newData) {
            const changes = {};
            const allKeys = new Set([...Object.keys(oldData || {}), ...Object.keys(newData || {})]);
            
            allKeys.forEach(key => {
                if (key === 'lastModified' || key === 'createdAt') return;
                
                const oldValue = oldData?.[key];
                const newValue = newData?.[key];
                
                if (JSON.stringify(oldValue) !== JSON.stringify(newValue)) {
                    changes[key] = {
                        old: oldValue,
                        new: newValue
                    };
                }
            });
            
            return changes;
        }
        
        // ========== Activity Log Functions ==========
        // دالة مساعدة لتحميل سجلات Firebase
        async function loadActivityLogsFromFirebase(actionFilter, entityFilter, userFilter) {
            const logsRef = collection(db, 'activityLogs');
            let q = query(logsRef, orderBy('timestamp', 'desc'));
            
            // تطبيق الفلتر
            if (actionFilter) {
                q = query(q, orderBy('action'), orderBy('timestamp', 'desc'));
            }
            
            const snapshot = await getDocs(q);
            let firebaseLogs = [];
            
            snapshot.forEach(doc => {
                const data = doc.data();
                // تطبيق الفلاتر
                if (actionFilter && data.action !== actionFilter) return;
                if (entityFilter && data.entityType !== entityFilter) return;
                if (userFilter && !data.userEmail?.toLowerCase().includes(userFilter.toLowerCase())) return;
                
                firebaseLogs.push({ id: doc.id, ...data });
            });
            
            // تتبع استخدام Firebase
            trackFirebaseUsage('read', 1);
            
            return firebaseLogs;
        }
        
        async function loadActivityLogs() {
            try {
                const resultsDiv = document.getElementById('activityLogResults');
                const actionFilter = document.getElementById('activityActionFilter')?.value || '';
                const entityFilter = document.getElementById('activityEntityFilter')?.value || '';
                const userFilter = document.getElementById('activityUserFilter')?.value || '';
                
                setHTML(resultsDiv, '<div style="text-align: center; padding: 40px;"><div class="loading-spinner" style="margin: 0 auto;"></div><p style="margin-top: 15px; color: var(--gray);">جارٍ تحميل السجل...</p></div>');
                
                const dbType = getDbType();
                let logs = [];
                
                if (dbType === 'supabase' && supabase) {
                    // تحميل من Supabase
                    try {
                        let query = supabase
                            .from('activity_logs')
                            .select('*')
                            .order('timestamp', { ascending: false });
                        
                        // تطبيق الفلاتر
                        if (actionFilter) {
                            query = query.eq('action', actionFilter);
                        }
                        if (entityFilter) {
                            query = query.eq('entityType', entityFilter);
                        }
                        if (userFilter) {
                            query = query.ilike('userEmail', `%${userFilter}%`);
                        }
                        
                        const { data, error } = await query;
                        
                        if (error) throw error;
                        
                        logs = (data || []).map(log => ({
                            id: log.id,
                            ...log,
                            // إضافة حقول إضافية للتوافق مع Firebase
                            date: log.timestamp ? new Date(log.timestamp).toLocaleDateString('ar-EG') : '',
                            time: log.timestamp ? new Date(log.timestamp).toLocaleTimeString('ar-EG') : '',
                            userName: log.userEmail || 'Unknown',
                            details: log.description || ''
                        }));
                        
                        // تتبع استخدام Supabase
                        trackSupabaseUsage('api', JSON.stringify(data).length);
                    } catch (supabaseError) {
                        console.error('❌ Error loading activity logs from Supabase:', supabaseError);
                        // إذا فشل Supabase، حاول استخدام Firebase كبديل
                        logs = await loadActivityLogsFromFirebase(actionFilter, entityFilter, userFilter);
                    }
                } else {
                    // تحميل من Firebase (الافتراضي)
                    logs = await loadActivityLogsFromFirebase(actionFilter, entityFilter, userFilter);
                }
                
                if (logs.length === 0) {
                    setHTML(resultsDiv, '<div class="empty-state"><p>لا توجد سجلات</p></div>');
                    return;
                }
                
                let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 13px;">';
                html += '<thead><tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">';
                html += '<th style="padding: 12px; text-align: right; border: 1px solid rgba(255,255,255,0.2);">التاريخ</th>';
                html += '<th style="padding: 12px; text-align: right; border: 1px solid rgba(255,255,255,0.2);">المستخدم</th>';
                html += '<th style="padding: 12px; text-align: right; border: 1px solid rgba(255,255,255,0.2);">النشاط</th>';
                html += '<th style="padding: 12px; text-align: right; border: 1px solid rgba(255,255,255,0.2);">النوع</th>';
                html += '<th style="padding: 12px; text-align: right; border: 1px solid rgba(255,255,255,0.2);">الاسم</th>';
                html += '<th style="padding: 12px; text-align: right; border: 1px solid rgba(255,255,255,0.2);">التفاصيل</th>';
                html += '</tr></thead><tbody>';
                
                const actionLabels = {
                    create: { ar: 'إضافة', en: 'Create', color: '#10b981' },
                    update: { ar: 'تعديل', en: 'Update', color: '#3b82f6' },
                    delete: { ar: 'حذف', en: 'Delete', color: '#ef4444' },
                    view: { ar: 'عرض', en: 'View', color: '#6b7280' },
                    export: { ar: 'تصدير', en: 'Export', color: '#8b5cf6' }
                };
                
                const entityLabels = {
                    employee: { ar: 'موظف', en: 'Employee' },
                    project: { ar: 'مشروع', en: 'Project' },
                    settings: { ar: 'إعدادات', en: 'Settings' }
                };
                
                logs.forEach(log => {
                    const actionLabel = actionLabels[log.action] || { ar: log.action, en: log.action, color: '#6b7280' };
                    const entityLabel = entityLabels[log.entityType] || { ar: log.entityType, en: log.entityType };
                    
                    html += "<tr style=\"border-bottom: 1px solid #e5e7eb;\" onmouseover=\"this.style.backgroundColor='#f9fafb';\" onmouseout=\"this.style.backgroundColor='';\">";
                    html += '<td style="padding: 10px; border: 1px solid #e5e7eb;">' + (log.date || 'N/A') + '<br><small style="color: #6b7280;">' + (log.time || '') + '</small></td>';
                    html += '<td style="padding: 10px; border: 1px solid #e5e7eb;">' + (log.userName || log.userEmail || 'Unknown') + '<br><small style="color: #6b7280;">' + (log.userEmail || '') + '</small></td>';
                    const bgColor = actionLabel.color + '20';
                    const actionText = currentLang === 'ar' ? actionLabel.ar : actionLabel.en;
                    html += '<td style="padding: 10px; border: 1px solid #e5e7eb;"><span style="background: ' + bgColor + '; color: ' + actionLabel.color + '; padding: 4px 8px; border-radius: 6px; font-weight: 600;">' + actionText + '</span></td>';
                    const entityText = currentLang === 'ar' ? entityLabel.ar : entityLabel.en;
                    html += '<td style="padding: 10px; border: 1px solid #e5e7eb;">' + entityText + '</td>';
                    html += '<td style="padding: 10px; border: 1px solid #e5e7eb; font-weight: 600;">' + (log.entityName || log.entityId || 'N/A') + '</td>';
                    
                    // عرض التغييرات
                    let changesHtml = '';
                    if (log.details) {
                        changesHtml = '<div style="font-size: 11px; color: #6b7280;">' + log.details + '</div>';
                    }
                    if (log.changes && Object.keys(log.changes).length > 0) {
                        changesHtml += '<div style="margin-top: 5px; font-size: 11px;">';
                        Object.entries(log.changes).slice(0, 3).forEach(([key, value]) => {
                            changesHtml += '<div style="margin: 2px 0;"><strong>' + key + ':</strong> ';
                            if (value.old !== undefined && value.new !== undefined) {
                                changesHtml += '<span style="color: #ef4444;">' + JSON.stringify(value.old) + '</span> → <span style="color: #10b981;">' + JSON.stringify(value.new) + '</span>';
                            }
                            changesHtml += '</div>';
                        });
                        if (Object.keys(log.changes).length > 3) {
                            changesHtml += '<div style="color: #6b7280;">+ ' + (Object.keys(log.changes).length - 3) + ' أكثر</div>';
                        }
                        changesHtml += '</div>';
                    }
                    html += `<td style="padding: 10px; border: 1px solid #e5e7eb; max-width: 300px;">${changesHtml || '-'}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                setHTML(resultsDiv, html);
                
            } catch (error) {
                console.error('Error loading activity logs:', error);
                const resultsDiv = document.getElementById('activityLogResults');
                setHTML(resultsDiv, '<div class="empty-state"><p style="color: var(--danger);">حدث خطأ أثناء تحميل السجل</p></div>');
            }
        }
        
        function openActivityLogModal() {
            openModal('activityLogModal');
            loadActivityLogs();
        }
        
        // ========== Summary Functions ==========
        function generateSummary() {
            const project = document.getElementById('summaryProject').value;
            const month1 = document.getElementById('summaryMonth1').value;
            const month2 = document.getElementById('summaryMonth2').value;

            if (!project || !month1) {
                showNotification('warning', currentLang === 'ar' ? 'تحذير' : 'Warning', 
                    currentLang === 'ar' ? 'الرجاء اختيار المشروع والشهر الأول' : 'Please select project and first month');
                return;
            }

            // التحقق من أن الشهرين مختلفين إذا تم اختيار الشهر الثاني
            if (month2 && month1 === month2) {
                showNotification('warning', currentLang === 'ar' ? 'تحذير' : 'Warning', 
                    currentLang === 'ar' ? 'لا يمكن مقارنة نفس الشهر. الرجاء اختيار شهر مختلف للمقارنة.' : 'Cannot compare the same month. Please select a different month for comparison.');
                return;
            }

            const resultsDiv = document.getElementById('summaryResults');
            
            // إظهار حالة التحميل
            setHTML(resultsDiv, '<div style="text-align: center; padding: 40px;"><div class="loading-spinner" style="margin: 0 auto;"></div><p style="margin-top: 15px; color: var(--gray);">' + 
                (currentLang === 'ar' ? 'جارٍ إنشاء الملخص...' : 'Generating summary...') + '</p></div>');
            
            // إنشاء الملخص بعد تأخير بسيط لتحسين تجربة المستخدم
            setTimeout(() => {
                try {
                    let summaryHTML = '';
                    if (project === 'ALL') {
                        summaryHTML = month2 ? generateAllProjectsComparison(month1, month2) : generateAllProjectsSummary(month1);
                    } else {
                        summaryHTML = month2 ? generateComparisonSummary(project, month1, month2) : generateSingleMonthSummary(project, month1);
                    }
                    
                    setHTML(resultsDiv, summaryHTML);
                    
                    // إظهار زر الطباعة بعد إنشاء الملخص
                    const printBtn = document.getElementById('printSummaryBtn');
                    if (printBtn) {
                        printBtn.style.display = 'inline-flex';
                    }
                    
                    // حفظ البيانات للطباعة
                    window.summaryPrintData = { project, month1, month2 };
                    
                    // التمرير إلى بداية النتائج
                    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } catch (error) {
                    console.error('Error generating summary:', error);
                    setHTML(resultsDiv, '<div class="empty-state"><p style="color: var(--danger);">' + 
                        (currentLang === 'ar' ? 'حدث خطأ أثناء إنشاء الملخص. الرجاء المحاولة مرة أخرى.' : 'An error occurred while generating the summary. Please try again.') + '</p></div>');
                    showNotification('error', currentLang === 'ar' ? 'خطأ' : 'Error', 
                        currentLang === 'ar' ? 'حدث خطأ أثناء إنشاء الملخص' : 'Error generating summary');
                }
            }, 100);
        }
        
        // دالة طباعة الملخصات (محسّنة لتقارير المشاريع)
        function printSummary() {
            const project = document.getElementById('summaryProject').value;
            const month1 = document.getElementById('summaryMonth1').value;
            const month2 = document.getElementById('summaryMonth2').value;
            
            if (!project || !month1) {
                showNotification('warning', currentLang === 'ar' ? 'تحذير' : 'Warning', 
                    currentLang === 'ar' ? 'الرجاء إنشاء ملخص أولاً' : 'Please generate summary first');
                return;
            }
            
            // إنشاء تقرير محسّن للمشاريع
            const printWindow = window.open('', '_blank');
            const currentDate = new Date().toLocaleDateString('ar-EG', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const currentTime = new Date().toLocaleTimeString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit'
            });
            const headerInfo = getHeaderInfo();
            const isArabic = currentLang === 'ar';
            const companyNameAr = companySettings.companyNameAr || '';
            const companyNameEn = companySettings.companyNameEn || 'ROSEMARY COMPANY';
            const companyLogo = companySettings.companyLogo || '';
            
            // تحديد حجم الورق (A3 للتقارير الكبيرة أفضل)
            const pageSize = 'A3';
            const orientation = 'landscape';
            
            let html = '<!DOCTYPE html><html dir="rtl" lang="ar"><head><meta charset="UTF-8">';
            html += '<title>' + (isArabic ? 'تقرير ملخص المشاريع' : 'Projects Summary Report') + ' - ' + currentYear + '</title>';
            html += '<style>';
            
            // CSS محسّن للطباعة على A3
            html += '@media print {';
            html += '@page { size: ' + pageSize + ' ' + orientation + '; margin: 0.5cm 0.8cm 2.5cm 0.8cm; }';
            html += 'body { padding-bottom: 140px !important; }';
            html += '.print-footer { position: fixed; bottom: 0; left: 0; right: 0; height: 120px; background: white; border-top: 2px solid #667eea; padding: 10px; page-break-inside: avoid; }';
            html += '.signature-section { position: fixed; bottom: 0; left: 0; right: 0; height: 120px; background: white; padding: 10px 20px; page-break-inside: avoid; }';
            html += '}';
            
            html += '* { margin: 0; padding: 0; box-sizing: border-box; }';
            html += 'body { font-family: "Arial", "Tahoma", sans-serif; font-size: 13px; margin: 0; padding: 8px; direction: rtl; }';
            
            // رأس التقرير
            html += '.print-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px 15px; text-align: center; border-radius: 8px; margin-bottom: 10px; page-break-inside: avoid; page-break-after: avoid; -webkit-print-color-adjust: exact; print-color-adjust: exact; }';
            html += '.print-header h1 { color: white; font-size: 18px; font-weight: bold; margin: 4px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }';
            html += '.print-header h2 { color: rgba(255,255,255,0.95); font-size: 13px; margin: 2px 0; font-weight: 600; }';
            html += '.print-header .company-name { color: rgba(255,255,255,0.9); font-size: 11px; margin: 2px 0; font-weight: 700; }';
            html += '.print-header .company-info { color: rgba(255,255,255,0.8); font-size: 10px; margin: 1px 0; font-weight: 500; }';
            
            // الجداول
            html += 'table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 12px; page-break-inside: auto; }';
            html += 'thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-print-color-adjust: exact; print-color-adjust: exact; }';
            html += 'thead th { color: white; padding: 10px 8px; text-align: center; font-weight: 700; font-size: 12px; border: 1px solid rgba(255,255,255,0.3); }';
            html += 'tbody td { padding: 10px 8px; text-align: center; border: 1px solid #e5e7eb; font-size: 12px; }';
            html += 'tbody tr:nth-child(even) { background: #f9fafb; }';
            html += 'tfoot tr, tr[style*="background"] { background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important; font-weight: bold; -webkit-print-color-adjust: exact; print-color-adjust: exact; }';
            html += 'tfoot td { color: white; padding: 10px 8px; font-size: 13px; }';
            
            // العنوان
            html += '.section-title { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 10px 15px; border-radius: 8px; margin: 15px 0 10px 0; font-size: 14px; font-weight: 700; text-align: center; -webkit-print-color-adjust: exact; print-color-adjust: exact; page-break-after: avoid; }';
            
            // التذييل
            html += '.print-footer { margin-top: 20px; text-align: center; padding-top: 8px; border-top: 2px solid #667eea; font-size: 12px; color: #6b7280; page-break-inside: avoid; }';
            html += '.signature-section { display: flex; justify-content: space-around; margin-top: 20px; page-break-inside: avoid; page-break-before: avoid; }';
            html += '.signature-box { text-align: center; width: 200px; }';
            html += '.signature-line { border-top: 2px solid #000; margin-top: 40px; padding-top: 6px; font-weight: bold; font-size: 13px; }';
            html += '</style></head><body>';
            
            // رأس التقرير
            html += '<div class="print-header">';
            const logo = companyLogo || '';
            if (logo && typeof logo === 'string' && logo.trim() && logo !== 'undefined' && logo !== 'null' && logo.length > 0) {
                html += '<div style="margin-bottom: 8px;"><img src="' + logo + '" style="max-width: 60px; max-height: 60px; object-fit: contain; border-radius: 50%; background: rgba(255,255,255,0.9); padding: 5px;" onerror="this.style.display=\'none\'"></div>';
            }
            html += '<div class="company-name">' + companyNameEn + '</div>';
            if (companyNameAr) {
                html += '<div class="company-name" style="font-size: 10px; margin-top: 2px;">' + companyNameAr + '</div>';
            }
            html += '<h1>📊 ' + (isArabic ? 'تقرير ملخص المشاريع' : 'Projects Summary Report') + '</h1>';
            html += '<h2>';
            if (project === 'ALL') {
                html += (isArabic ? 'جميع المشاريع' : 'All Projects');
            } else {
                html += (projects[project] || project);
            }
            html += ' - ' + t('monthNames')[month1];
            if (month2) {
                html += ' ' + (isArabic ? 'مقارنة بـ ' : 'vs ') + t('monthNames')[month2];
            }
            html += ' ' + currentYear;
            html += '</h2>';
            if (companySettings.companyAddress) {
                html += '<div class="company-info">📍 ' + companySettings.companyAddress + '</div>';
            }
            if (companySettings.companyPhone) {
                html += '<div class="company-info">📞 ' + companySettings.companyPhone + '</div>';
            }
            html += '<div class="company-info">📅 ' + currentDate + ' | 🕐 ' + currentTime + '</div>';
            html += '</div>';
            
            // المحتوى - إنشاء الجدول مباشرة
            html += '<div class="section-title">' + (isArabic ? '📋 ملخص المشاريع' : '📋 Projects Summary') + '</div>';
            
            if (project === 'ALL') {
                // ملخص جميع المشاريع
                if (month2) {
                    html += generateProjectsComparisonTable(month1, month2, isArabic);
                } else {
                    html += generateProjectsSummaryTable(month1, isArabic);
                }
            } else {
                // ملخص مشروع واحد
                html += generateSingleProjectSummaryTable(project, month1, month2, isArabic);
            }
            
            // التوقيعات
            const signaturesHTML = getSignaturesHTML();
            if (signaturesHTML) {
                html += '<div class="signature-section">' + signaturesHTML + '</div>';
            }
            
            // التذييل
            html += '<div class="print-footer">';
            html += '<p>🔒 ' + (isArabic ? 'هذا التقرير سري ومخصص للاستخدام الداخلي فقط' : 'This report is confidential and for internal use only') + '</p>';
            html += '<p style="margin-top: 5px; font-size: 11px; color: #6366f1; font-weight: 600;">';
            html += '🌿 Powered by ROSEMARY | PayRose System';
            html += '</p>';
            html += '<p style="margin-top: 3px; font-size: 10px; color: #9ca3af;">';
            html += '© ' + currentYear + ' ' + companyNameEn + ' - ' + (isArabic ? 'نظام الرواتب الاحترافي' : 'Professional Payroll System');
            html += '</p>';
            html += '</div>';
            
            html += '<scr' + 'ipt>';
            html += 'window.onload = function() { setTimeout(function() { window.print(); }, 500); };';
            html += '</scr' + 'ipt>';
            html += '</body></html>';
            
            printWindow.document.write(html);
            printWindow.document.close();
            
            showNotification('success', '✅ ' + (isArabic ? 'جاهز للطباعة' : 'Ready to Print'), 
                (isArabic ? 'تم فتح نافذة الطباعة بنجاح' : 'Print window opened successfully'));
        }
        
        // دالة لإنشاء جدول ملخص المشاريع للطباعة
        function generateProjectsSummaryTable(month, isArabic) {
            let html = '<table style="width: 100%; font-size: 12px; border-collapse: collapse; margin-top: 15px;"><thead><tr style="background: #667eea; color: white;">';
            html += '<th rowspan="2" style="padding: 10px; border: 1px solid #ddd; text-align: center;">' + (isArabic ? 'المشروع' : 'Project') + '</th>';
            html += '<th rowspan="2" style="padding: 10px; border: 1px solid #ddd; text-align: center;">' + (isArabic ? 'عدد الموظفين' : 'Total Employees') + '</th>';
            html += '<th colspan="2" style="padding: 10px; border: 1px solid #ddd; text-align: center;">' + (isArabic ? 'شهري' : 'Monthly') + '</th>';
            html += '<th colspan="2" style="padding: 10px; border: 1px solid #ddd; text-align: center;">' + (isArabic ? 'يومي' : 'Daily') + '</th>';
            html += '<th colspan="2" style="padding: 10px; border: 1px solid #ddd; text-align: center;">' + (isArabic ? 'سيارات' : 'Vehicles') + '</th>';
            html += '<th colspan="2" style="padding: 10px; border: 1px solid #ddd; text-align: center;">' + (isArabic ? 'الإجمالي' : 'Total') + '</th>';
            html += '</tr><tr style="background: #667eea; color: white;">';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">USD</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">IQD</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">USD</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">IQD</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">USD</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">IQD</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">USD</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">IQD</th>';
            html += '</tr></thead><tbody>';
            
            let grandTotalUSD = 0, grandTotalIQD = 0, grandTotalEmps = 0;
            let typeTotals = {
                monthly: {USD: 0, IQD: 0, count: 0},
                daily: {USD: 0, IQD: 0, count: 0},
                vehicle: {USD: 0, IQD: 0, count: 0}
            };
            
            Object.entries(projects).forEach(([code, name]) => {
                const emps = (employeeData[currentYear] && employeeData[currentYear][month])
                    ? employeeData[currentYear][month].filter(emp => emp.project === code)
                    : [];
                
                if (emps.length === 0) return;
                
                // حساب المبالغ حسب نوع الموظف وعملة الدفع
                const projectStats = {
                    monthly: {USD: 0, IQD: 0, count: 0},
                    daily: {USD: 0, IQD: 0, count: 0},
                    vehicle: {USD: 0, IQD: 0, count: 0}
                };
                
                emps.forEach(emp => {
                    const netSalary = calculateNetSalary(emp, month, currentYear);
                    const empType = emp.employeeType;
                    const exchangeRate = emp.exchangeRate || 1420;
                    
                    if (!projectStats[empType]) projectStats[empType] = {USD: 0, IQD: 0, count: 0};
                    
                    projectStats[empType].count++;
                    if (emp.paymentCurrency === 'USD') {
                        projectStats[empType].USD += netSalary;
                        projectStats[empType].IQD += netSalary * exchangeRate;
                    } else {
                        projectStats[empType].IQD += netSalary;
                        projectStats[empType].USD += netSalary / exchangeRate;
                    }
                });
                
                const projectTotalUSD = projectStats.monthly.USD + projectStats.daily.USD + projectStats.vehicle.USD;
                const projectTotalIQD = projectStats.monthly.IQD + projectStats.daily.IQD + projectStats.vehicle.IQD;
                
                // تحديث الإجماليات
                typeTotals.monthly.USD += projectStats.monthly.USD;
                typeTotals.monthly.IQD += projectStats.monthly.IQD;
                typeTotals.monthly.count += projectStats.monthly.count;
                typeTotals.daily.USD += projectStats.daily.USD;
                typeTotals.daily.IQD += projectStats.daily.IQD;
                typeTotals.daily.count += projectStats.daily.count;
                typeTotals.vehicle.USD += projectStats.vehicle.USD;
                typeTotals.vehicle.IQD += projectStats.vehicle.IQD;
                typeTotals.vehicle.count += projectStats.vehicle.count;
                
                grandTotalUSD += projectTotalUSD;
                grandTotalIQD += projectTotalIQD;
                grandTotalEmps += emps.length;
                
                html += '<tr>';
                html += '<td style="font-weight: 600; text-align: right; border: 1px solid #e5e7eb;">' + name + '</td>';
                html += '<td style="text-align: center; border: 1px solid #e5e7eb;">' + emps.length + '</td>';
                html += '<td style="text-align: right; border: 1px solid #e5e7eb;">' + formatCurrency(projectStats.monthly.USD) + '</td>';
                html += '<td style="text-align: right; border: 1px solid #e5e7eb;">' + formatCurrency(projectStats.monthly.IQD) + '</td>';
                html += '<td style="text-align: right; border: 1px solid #e5e7eb;">' + formatCurrency(projectStats.daily.USD) + '</td>';
                html += '<td style="text-align: right; border: 1px solid #e5e7eb;">' + formatCurrency(projectStats.daily.IQD) + '</td>';
                html += '<td style="text-align: right; border: 1px solid #e5e7eb;">' + formatCurrency(projectStats.vehicle.USD) + '</td>';
                html += '<td style="text-align: right; border: 1px solid #e5e7eb;">' + formatCurrency(projectStats.vehicle.IQD) + '</td>';
                html += '<td style="text-align: right; font-weight: 600; border: 1px solid #e5e7eb;">' + formatCurrency(projectTotalUSD) + '</td>';
                html += '<td style="text-align: right; font-weight: 600; border: 1px solid #e5e7eb;">' + formatCurrency(projectTotalIQD) + '</td>';
                html += '</tr>';
            });
            
            // صفوف الإجماليات حسب النوع
            html += '<tr style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); font-weight: 700; border-top: 2px solid #f59e0b;">';
            html += '<td style="padding: 12px; border: 1px solid #f59e0b;">' + (isArabic ? 'إجمالي شهري' : 'Monthly Total') + '</td>';
            html += '<td style="padding: 12px; text-align: center; border: 1px solid #f59e0b;">' + typeTotals.monthly.count + '</td>';
            html += '<td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">' + formatCurrency(typeTotals.monthly.USD) + '</td>';
            html += '<td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">' + formatCurrency(typeTotals.monthly.IQD) + '</td>';
            html += '<td colspan="2" style="padding: 12px; text-align: center; border: 1px solid #f59e0b;">-</td>';
            html += '<td colspan="2" style="padding: 12px; text-align: center; border: 1px solid #f59e0b;">-</td>';
            html += '<td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">' + formatCurrency(typeTotals.monthly.USD) + '</td>';
            html += '<td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">' + formatCurrency(typeTotals.monthly.IQD) + '</td>';
            html += '</tr>';
            
            html += '<tr style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); font-weight: 700;">';
            html += '<td style="padding: 12px; border: 1px solid #f59e0b;">' + (isArabic ? 'إجمالي يومي' : 'Daily Total') + '</td>';
            html += '<td style="padding: 12px; text-align: center; border: 1px solid #f59e0b;">' + typeTotals.daily.count + '</td>';
            html += '<td colspan="2" style="padding: 12px; text-align: center; border: 1px solid #f59e0b;">-</td>';
            html += '<td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">' + formatCurrency(typeTotals.daily.USD) + '</td>';
            html += '<td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">' + formatCurrency(typeTotals.daily.IQD) + '</td>';
            html += '<td colspan="2" style="padding: 12px; text-align: center; border: 1px solid #f59e0b;">-</td>';
            html += '<td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">' + formatCurrency(typeTotals.daily.USD) + '</td>';
            html += '<td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">' + formatCurrency(typeTotals.daily.IQD) + '</td>';
            html += '</tr>';
            
            html += '<tr style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); font-weight: 700;">';
            html += '<td style="padding: 12px; border: 1px solid #f59e0b;">' + (isArabic ? 'إجمالي سيارات' : 'Vehicles Total') + '</td>';
            html += '<td style="padding: 12px; text-align: center; border: 1px solid #f59e0b;">' + typeTotals.vehicle.count + '</td>';
            html += '<td colspan="4" style="padding: 12px; text-align: center; border: 1px solid #f59e0b;">-</td>';
            html += '<td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">' + formatCurrency(typeTotals.vehicle.USD) + '</td>';
            html += '<td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">' + formatCurrency(typeTotals.vehicle.IQD) + '</td>';
            html += '<td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">' + formatCurrency(typeTotals.vehicle.USD) + '</td>';
            html += '<td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">' + formatCurrency(typeTotals.vehicle.IQD) + '</td>';
            html += '</tr>';

            // الإجمالي النهائي
            html += '<tr style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); font-weight: 700; border-top: 2px solid #10b981;">';
            html += '<td style="padding: 12px; color: white; font-weight: bold; border: 1px solid #10b981;">' + (isArabic ? 'الإجمالي النهائي' : 'Grand Total') + '</td>';
            html += '<td style="padding: 12px; text-align: center; color: white; font-weight: bold; border: 1px solid #10b981;">' + grandTotalEmps + '</td>';
            html += '<td colspan="6" style="padding: 12px; text-align: center; color: white; border: 1px solid #10b981;">-</td>';
            html += '<td style="padding: 12px; text-align: right; color: white; font-weight: bold; border: 1px solid #10b981;">' + formatCurrency(grandTotalUSD) + '</td>';
            html += '<td style="padding: 12px; text-align: right; color: white; font-weight: bold; border: 1px solid #10b981;">' + formatCurrency(grandTotalIQD) + '</td>';
            html += '</tr>';
            html += '</tbody></table>';
            
            return html;
        }
        
        // دالة لإنشاء جدول مقارنة المشاريع
        function generateProjectsComparisonTable(month1, month2, isArabic) {
            let html = '<table style="width: 100%; font-size: 12px; border-collapse: collapse; margin-top: 15px;"><thead><tr style="background: #667eea; color: white;">';
            html += '<th rowspan="2" style="padding: 10px; border: 1px solid #ddd; text-align: center;">' + (isArabic ? 'المشروع' : 'Project') + '</th>';
            html += '<th colspan="4" style="padding: 10px; border: 1px solid #ddd; text-align: center;">' + t('monthNames')[month1] + '</th>';
            html += '<th colspan="4" style="padding: 10px; border: 1px solid #ddd; text-align: center;">' + t('monthNames')[month2] + '</th>';
            html += '<th colspan="2" style="padding: 10px; border: 1px solid #ddd; text-align: center;">' + (isArabic ? 'الفرق' : 'Difference') + '</th>';
            html += '</tr><tr style="background: #667eea; color: white;">';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">' + (isArabic ? 'شهري' : 'Monthly') + '</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">' + (isArabic ? 'يومي' : 'Daily') + '</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">USD</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">IQD</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">' + (isArabic ? 'شهري' : 'Monthly') + '</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">' + (isArabic ? 'يومي' : 'Daily') + '</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">USD</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">IQD</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">USD</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">IQD</th>';
            html += '</tr></thead><tbody>';
            
            let grandTotal1 = {monthlyCount: 0, dailyCount: 0, totalUSD: 0, totalIQD: 0, emps: 0};
            let grandTotal2 = {monthlyCount: 0, dailyCount: 0, totalUSD: 0, totalIQD: 0, emps: 0};
            
            Object.entries(projects).forEach(([code, name]) => {
                const emps1 = (employeeData[currentYear] && employeeData[currentYear][month1])
                    ? employeeData[currentYear][month1].filter(emp => emp.project === code)
                    : [];
                const emps2 = (employeeData[currentYear] && employeeData[currentYear][month2])
                    ? employeeData[currentYear][month2].filter(emp => emp.project === code)
                    : [];
                
                const stats1 = {monthly: {USD: 0, IQD: 0, count: 0}, daily: {USD: 0, IQD: 0, count: 0}, vehicle: {USD: 0, IQD: 0, count: 0}};
                const stats2 = {monthly: {USD: 0, IQD: 0, count: 0}, daily: {USD: 0, IQD: 0, count: 0}, vehicle: {USD: 0, IQD: 0, count: 0}};
                
                emps1.forEach(emp => {
                    const netSalary = calculateNetSalary(emp, month1, currentYear);
                    const type = emp.employeeType;
                    const exchangeRate = emp.exchangeRate || 1420;
                    if (emp.paymentCurrency === 'USD') {
                        stats1[type].USD += netSalary;
                        stats1[type].IQD += netSalary * exchangeRate;
                    } else {
                        stats1[type].IQD += netSalary;
                        stats1[type].USD += netSalary / exchangeRate;
                    }
                    stats1[type].count++;
                });
                
                emps2.forEach(emp => {
                    const netSalary = calculateNetSalary(emp, month2, currentYear);
                    const type = emp.employeeType;
                    const exchangeRate = emp.exchangeRate || 1420;
                    if (emp.paymentCurrency === 'USD') {
                        stats2[type].USD += netSalary;
                        stats2[type].IQD += netSalary * exchangeRate;
                    } else {
                        stats2[type].IQD += netSalary;
                        stats2[type].USD += netSalary / exchangeRate;
                    }
                    stats2[type].count++;
                });
                
                const totalUSD1 = stats1.monthly.USD + stats1.daily.USD + stats1.vehicle.USD;
                const totalIQD1 = stats1.monthly.IQD + stats1.daily.IQD + stats1.vehicle.IQD;
                const totalUSD2 = stats2.monthly.USD + stats2.daily.USD + stats2.vehicle.USD;
                const totalIQD2 = stats2.monthly.IQD + stats2.daily.IQD + stats2.vehicle.IQD;
                
                grandTotal1.monthlyCount += stats1.monthly.count;
                grandTotal1.dailyCount += stats1.daily.count;
                grandTotal1.totalUSD += totalUSD1;
                grandTotal1.totalIQD += totalIQD1;
                grandTotal1.emps += emps1.length;
                
                grandTotal2.monthlyCount += stats2.monthly.count;
                grandTotal2.dailyCount += stats2.daily.count;
                grandTotal2.totalUSD += totalUSD2;
                grandTotal2.totalIQD += totalIQD2;
                grandTotal2.emps += emps2.length;
                
                const diffUSD = totalUSD2 - totalUSD1;
                const diffIQD = totalIQD2 - totalIQD1;
                const diffColorUSD = diffUSD >= 0 ? '#059669' : '#dc2626';
                const diffColorIQD = diffIQD >= 0 ? '#059669' : '#dc2626';
                
                html += '<tr style="border-bottom: 1px solid #e5e7eb;">';
                html += '<td style="font-weight: 600; text-align: right; border: 1px solid #e5e7eb; padding: 10px;">' + name + '</td>';
                html += '<td style="text-align: center; border: 1px solid #e5e7eb; padding: 10px;">' + stats1.monthly.count + '</td>';
                html += '<td style="text-align: center; border: 1px solid #e5e7eb; padding: 10px;">' + stats1.daily.count + '</td>';
                html += '<td style="text-align: right; border: 1px solid #e5e7eb; padding: 10px;">' + formatCurrency(totalUSD1) + '</td>';
                html += '<td style="text-align: right; border: 1px solid #e5e7eb; padding: 10px;">' + formatCurrency(totalIQD1) + '</td>';
                html += '<td style="text-align: center; border: 1px solid #e5e7eb; padding: 10px;">' + stats2.monthly.count + '</td>';
                html += '<td style="text-align: center; border: 1px solid #e5e7eb; padding: 10px;">' + stats2.daily.count + '</td>';
                html += '<td style="text-align: right; border: 1px solid #e5e7eb; padding: 10px;">' + formatCurrency(totalUSD2) + '</td>';
                html += '<td style="text-align: right; border: 1px solid #e5e7eb; padding: 10px;">' + formatCurrency(totalIQD2) + '</td>';
                html += '<td style="text-align: right; color: ' + diffColorUSD + '; font-weight: 700; border: 1px solid #e5e7eb; padding: 10px;">' + (diffUSD >= 0 ? '+' : '') + formatCurrency(Math.abs(diffUSD)) + '</td>';
                html += '<td style="text-align: right; color: ' + diffColorIQD + '; font-weight: 700; border: 1px solid #e5e7eb; padding: 10px;">' + (diffIQD >= 0 ? '+' : '') + formatCurrency(Math.abs(diffIQD)) + '</td>';
                html += '</tr>';
            });
            
            const totalDiffUSD = grandTotal2.totalUSD - grandTotal1.totalUSD;
            const totalDiffIQD = grandTotal2.totalIQD - grandTotal1.totalIQD;
            const totalDiffColorUSD = totalDiffUSD >= 0 ? '#059669' : '#dc2626';
            const totalDiffColorIQD = totalDiffIQD >= 0 ? '#059669' : '#dc2626';
            
            html += '<tr style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); font-weight: 700; border-top: 2px solid #10b981;">';
            html += '<td style="padding: 12px; color: white; font-weight: bold; border: 1px solid #10b981;">' + (isArabic ? 'المجموع الكلي' : 'Grand Total') + '</td>';
            html += '<td style="padding: 12px; text-align: center; color: white; font-weight: bold; border: 1px solid #10b981;">' + grandTotal1.monthlyCount + '</td>';
            html += '<td style="padding: 12px; text-align: center; color: white; font-weight: bold; border: 1px solid #10b981;">' + grandTotal1.dailyCount + '</td>';
            html += '<td style="padding: 12px; text-align: right; color: white; font-weight: bold; border: 1px solid #10b981;">' + formatCurrency(grandTotal1.totalUSD) + '</td>';
            html += '<td style="padding: 12px; text-align: right; color: white; font-weight: bold; border: 1px solid #10b981;">' + formatCurrency(grandTotal1.totalIQD) + '</td>';
            html += '<td style="padding: 12px; text-align: center; color: white; font-weight: bold; border: 1px solid #10b981;">' + grandTotal2.monthlyCount + '</td>';
            html += '<td style="padding: 12px; text-align: center; color: white; font-weight: bold; border: 1px solid #10b981;">' + grandTotal2.dailyCount + '</td>';
            html += '<td style="padding: 12px; text-align: right; color: white; font-weight: bold; border: 1px solid #10b981;">' + formatCurrency(grandTotal2.totalUSD) + '</td>';
            html += '<td style="padding: 12px; text-align: right; color: white; font-weight: bold; border: 1px solid #10b981;">' + formatCurrency(grandTotal2.totalIQD) + '</td>';
            html += '<td style="padding: 12px; text-align: right; color: ' + totalDiffColorUSD + '; font-weight: bold; border: 1px solid #10b981;">' + (totalDiffUSD >= 0 ? '+' : '') + formatCurrency(Math.abs(totalDiffUSD)) + '</td>';
            html += '<td style="padding: 12px; text-align: right; color: ' + totalDiffColorIQD + '; font-weight: bold; border: 1px solid #10b981;">' + (totalDiffIQD >= 0 ? '+' : '') + formatCurrency(Math.abs(totalDiffIQD)) + '</td>';
            html += '</tr>';
            html += '</tbody></table>';
            
            return html;
        }
        
        // دالة لإنشاء ملخص مشروع واحد
        function generateSingleProjectSummaryTable(projectCode, month1, month2, isArabic) {
            const projectName = projects[projectCode] || projectCode;
            let html = '<div style="overflow-x: auto; max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 20px;">';
            html += '<table style="width: 100%; font-size: 13px; border-collapse: collapse; min-width: 500px;"><thead><tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">';
            html += '<th style="padding: 12px; text-align: left; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">' + (isArabic ? 'نوع الموظف' : 'Employee Type') + '</th>';
            html += '<th style="padding: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">' + (isArabic ? 'العدد' : 'Count') + '</th>';
            html += '<th style="padding: 12px; text-align: right; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">' + (isArabic ? 'المجموع USD' : 'Total USD') + '</th>';
            html += '<th style="padding: 12px; text-align: right; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">' + (isArabic ? 'المجموع IQD' : 'Total IQD') + '</th>';
            if (month2) {
                html += '<th style="padding: 12px; text-align: right; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">' + (isArabic ? 'الفرق USD' : 'Diff USD') + '</th>';
                html += '<th style="padding: 12px; text-align: right; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">' + (isArabic ? 'الفرق IQD' : 'Diff IQD') + '</th>';
            }
            html += '</tr></thead><tbody>';
            
            const emps1 = (employeeData[currentYear] && employeeData[currentYear][month1])
                ? employeeData[currentYear][month1].filter(emp => emp.project === projectCode)
                : [];
            
            const types = ['monthly', 'daily', 'vehicle'];
            const typeLabels = {
                monthly: isArabic ? 'شهري' : 'Monthly',
                daily: isArabic ? 'يومي' : 'Daily',
                vehicle: isArabic ? 'سيارات' : 'Vehicles'
            };
            
            let totalUSD1 = 0, totalIQD1 = 0;
            let totalUSD2 = 0, totalIQD2 = 0;
            
            types.forEach(type => {
                const typeEmps1 = emps1.filter(emp => emp.employeeType === type);
                let typeUSD1 = 0, typeIQD1 = 0;
                
                typeEmps1.forEach(emp => {
                    const netSalary = calculateNetSalary(emp);
                    if (emp.paymentCurrency === 'USD') {
                        typeUSD1 += netSalary;
                        typeIQD1 += netSalary * (emp.exchangeRate || 1420);
                    } else {
                        typeIQD1 += netSalary;
                        typeUSD1 += netSalary / (emp.exchangeRate || 1420);
                    }
                });
                
                totalUSD1 += typeUSD1;
                totalIQD1 += typeIQD1;
                
                html += "<tr style=\"border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s;\" onmouseover=\"this.style.backgroundColor='#f3f4f6';\" onmouseout=\"this.style.backgroundColor='';\">";
                html += '<td style="padding: 10px; font-weight: 600; border: 1px solid #e5e7eb;">' + typeLabels[type] + '</td>';
                html += '<td style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">' + typeEmps1.length + '</td>';
                html += '<td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">' + formatCurrency(typeUSD1) + '</td>';
                html += '<td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">' + formatCurrency(typeIQD1) + '</td>';
                if (month2) {
                    const typeEmps2 = (employeeData[currentYear] && employeeData[currentYear][month2])
                        ? employeeData[currentYear][month2].filter(emp => emp.project === projectCode && emp.employeeType === type)
                        : [];
                    let typeUSD2 = 0, typeIQD2 = 0;
                    typeEmps2.forEach(emp => {
                        const netSalary = calculateNetSalary(emp, month2, currentYear);
                        if (emp.paymentCurrency === 'USD') {
                            typeUSD2 += netSalary;
                            typeIQD2 += netSalary * (emp.exchangeRate || 1420);
                        } else {
                            typeIQD2 += netSalary;
                            typeUSD2 += netSalary / (emp.exchangeRate || 1420);
                        }
                    });
                    totalUSD2 += typeUSD2;
                    totalIQD2 += typeIQD2;
                    const diffUSD = typeUSD2 - typeUSD1;
                    const diffIQD = typeIQD2 - typeIQD1;
                    html += '<td style="padding: 10px; text-align: right; color: ' + (diffUSD >= 0 ? '#059669' : '#dc2626') + '; font-weight: 700; border: 1px solid #e5e7eb;">' + (diffUSD >= 0 ? '+' : '') + formatCurrency(Math.abs(diffUSD)) + '</td>';
                    html += '<td style="padding: 10px; text-align: right; color: ' + (diffIQD >= 0 ? '#059669' : '#dc2626') + '; font-weight: 700; border: 1px solid #e5e7eb;">' + (diffIQD >= 0 ? '+' : '') + formatCurrency(Math.abs(diffIQD)) + '</td>';
                }
                html += '</tr>';
            });
            
            html += '<tr style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); font-weight: 700; border-top: 2px solid #10b981;">';
            html += '<td style="padding: 12px; color: white; font-weight: bold; border: 1px solid #10b981;">' + (isArabic ? 'المجموع' : 'Total') + '</td>';
            html += '<td style="padding: 12px; text-align: center; color: white; font-weight: bold; border: 1px solid #10b981;">' + emps1.length + '</td>';
            html += '<td style="padding: 12px; text-align: right; color: white; font-weight: bold; border: 1px solid #10b981;">' + formatCurrency(totalUSD1) + '</td>';
            html += '<td style="padding: 12px; text-align: right; color: white; font-weight: bold; border: 1px solid #10b981;">' + formatCurrency(totalIQD1) + '</td>';
            if (month2) {
                const totalDiffUSD = totalUSD2 - totalUSD1;
                const totalDiffIQD = totalIQD2 - totalIQD1;
                html += '<td style="padding: 12px; text-align: right; color: ' + (totalDiffUSD >= 0 ? '#059669' : '#dc2626') + '; font-weight: bold; border: 1px solid #10b981;">' + (totalDiffUSD >= 0 ? '+' : '') + formatCurrency(Math.abs(totalDiffUSD)) + '</td>';
                html += '<td style="padding: 12px; text-align: right; color: ' + (totalDiffIQD >= 0 ? '#059669' : '#dc2626') + '; font-weight: bold; border: 1px solid #10b981;">' + (totalDiffIQD >= 0 ? '+' : '') + formatCurrency(Math.abs(totalDiffIQD)) + '</td>';
            }
            html += '</tr>';
            html += '</tbody></table></div>';
            
            return html;
        }

        function generateAllProjectsSummary(month) {
            const isArabic = currentLang === 'ar';
            let html = `<div class="chart-container" style="margin-top: 20px;">
                <h3 style="color: var(--primary); margin-bottom: 20px;">📊 ${t('allProjects')} - ${t('monthNames')[month]}</h3>
                <div style="overflow-x: auto; max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <table id="summaryTable" style="width: 100%; font-size: 13px; border-collapse: collapse; min-width: 800px;"><thead><tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <th rowspan="2" style="padding: 12px; text-align: left; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">${t('project')}</th>
                    <th rowspan="2" style="padding: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">${t('totalEmployees')}</th>
                    <th colspan="2" style="padding: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">${isArabic ? 'شهري' : 'Monthly'}</th>
                    <th colspan="2" style="padding: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">${isArabic ? 'يومي' : 'Daily'}</th>
                    <th colspan="2" style="padding: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">${isArabic ? 'سيارات' : 'Vehicles'}</th>
                    <th colspan="2" style="padding: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">${isArabic ? 'الإجمالي' : 'Total'}</th>
                </tr><tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <th style="padding: 8px; text-align: center; font-weight: 500; font-size: 11px; border: 1px solid rgba(255,255,255,0.2);">USD</th>
                    <th style="padding: 8px; text-align: center; font-weight: 500; font-size: 11px; border: 1px solid rgba(255,255,255,0.2);">IQD</th>
                    <th style="padding: 8px; text-align: center; font-weight: 500; font-size: 11px; border: 1px solid rgba(255,255,255,0.2);">USD</th>
                    <th style="padding: 8px; text-align: center; font-weight: 500; font-size: 11px; border: 1px solid rgba(255,255,255,0.2);">IQD</th>
                    <th style="padding: 8px; text-align: center; font-weight: 500; font-size: 11px; border: 1px solid rgba(255,255,255,0.2);">USD</th>
                    <th style="padding: 8px; text-align: center; font-weight: 500; font-size: 11px; border: 1px solid rgba(255,255,255,0.2);">IQD</th>
                    <th style="padding: 8px; text-align: center; font-weight: 500; font-size: 11px; border: 1px solid rgba(255,255,255,0.2);">USD</th>
                    <th style="padding: 8px; text-align: center; font-weight: 500; font-size: 11px; border: 1px solid rgba(255,255,255,0.2);">IQD</th>
                </tr></thead><tbody>`;

            // إجماليات عامة
            let grandTotalUSD = 0, grandTotalIQD = 0, grandTotalEmps = 0;
            let typeTotals = {
                monthly: {USD: 0, IQD: 0, count: 0},
                daily: {USD: 0, IQD: 0, count: 0},
                vehicle: {USD: 0, IQD: 0, count: 0}
            };

            Object.entries(projects).forEach(([code, name]) => {
                const emps = (employeeData[currentYear] && employeeData[currentYear][month])
                    ? employeeData[currentYear][month].filter(emp => emp.project === code)
                    : [];
                
                if (emps.length === 0) return;
                
                // حساب المبالغ حسب نوع الموظف وعملة الدفع
                const projectStats = {
                    monthly: {USD: 0, IQD: 0, count: 0},
                    daily: {USD: 0, IQD: 0, count: 0},
                    vehicle: {USD: 0, IQD: 0, count: 0}
                };
                
                emps.forEach(emp => {
                    const netSalary = calculateNetSalary(emp, month, currentYear);
                    const empType = emp.employeeType;
                    
                    if (!projectStats[empType]) projectStats[empType] = {USD: 0, IQD: 0, count: 0};
                    
                    projectStats[empType].count++;
                    if (emp.paymentCurrency === 'USD') {
                        projectStats[empType].USD += netSalary;
                        projectStats[empType].IQD += netSalary * (emp.exchangeRate || 1420);
                    } else {
                        projectStats[empType].IQD += netSalary;
                        projectStats[empType].USD += netSalary / (emp.exchangeRate || 1420);
                    }
                });
                
                // تحديث الإجماليات
                ['monthly', 'daily', 'vehicle'].forEach(type => {
                    typeTotals[type].USD += projectStats[type].USD;
                    typeTotals[type].IQD += projectStats[type].IQD;
                    typeTotals[type].count += projectStats[type].count;
                });
                
                const projectTotalUSD = projectStats.monthly.USD + projectStats.daily.USD + projectStats.vehicle.USD;
                const projectTotalIQD = projectStats.monthly.IQD + projectStats.daily.IQD + projectStats.vehicle.IQD;
                grandTotalUSD += projectTotalUSD;
                grandTotalIQD += projectTotalIQD;
                grandTotalEmps += emps.length;
                
                html += `<tr style="border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s;" 
                    onmouseover="this.style.backgroundColor='#f3f4f6';" 
                    onmouseout="this.style.backgroundColor='';">
                    <td style="padding: 10px; font-weight: 600; border: 1px solid #e5e7eb;">${name}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">${emps.length}</td>
                    <td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">${formatCurrency(projectStats.monthly.USD)}</td>
                    <td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">${formatCurrency(projectStats.monthly.IQD)}</td>
                    <td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">${formatCurrency(projectStats.daily.USD)}</td>
                    <td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">${formatCurrency(projectStats.daily.IQD)}</td>
                    <td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">${formatCurrency(projectStats.vehicle.USD)}</td>
                    <td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">${formatCurrency(projectStats.vehicle.IQD)}</td>
                    <td style="padding: 10px; text-align: right; font-weight: 600; border: 1px solid #e5e7eb;">${formatCurrency(projectTotalUSD)}</td>
                    <td style="padding: 10px; text-align: right; font-weight: 600; border: 1px solid #e5e7eb;">${formatCurrency(projectTotalIQD)}</td>
                </tr>`;
            });

            // صفوف الإجماليات حسب النوع
            html += `<tr style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); font-weight: 700; border-top: 2px solid #f59e0b;">
                <td style="padding: 12px; border: 1px solid #f59e0b;">${isArabic ? 'إجمالي شهري' : 'Monthly Total'}</td>
                <td style="padding: 12px; text-align: center; border: 1px solid #f59e0b;">${typeTotals.monthly.count}</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">${formatCurrency(typeTotals.monthly.USD)}</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">${formatCurrency(typeTotals.monthly.IQD)}</td>
                <td colspan="2" style="padding: 12px; text-align: center; border: 1px solid #f59e0b;">-</td>
                <td colspan="2" style="padding: 12px; text-align: center; border: 1px solid #f59e0b;">-</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">${formatCurrency(typeTotals.monthly.USD)}</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">${formatCurrency(typeTotals.monthly.IQD)}</td>
            </tr>`;
            
            html += `<tr style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); font-weight: 700;">
                <td style="padding: 12px; border: 1px solid #f59e0b;">${isArabic ? 'إجمالي يومي' : 'Daily Total'}</td>
                <td style="padding: 12px; text-align: center; border: 1px solid #f59e0b;">${typeTotals.daily.count}</td>
                <td colspan="2" style="padding: 12px; text-align: center; border: 1px solid #f59e0b;">-</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">${formatCurrency(typeTotals.daily.USD)}</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">${formatCurrency(typeTotals.daily.IQD)}</td>
                <td colspan="2" style="padding: 12px; text-align: center; border: 1px solid #f59e0b;">-</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">${formatCurrency(typeTotals.daily.USD)}</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">${formatCurrency(typeTotals.daily.IQD)}</td>
            </tr>`;
            
            html += `<tr style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); font-weight: 700;">
                <td style="padding: 12px; border: 1px solid #f59e0b;">${isArabic ? 'إجمالي سيارات' : 'Vehicles Total'}</td>
                <td style="padding: 12px; text-align: center; border: 1px solid #f59e0b;">${typeTotals.vehicle.count}</td>
                <td colspan="4" style="padding: 12px; text-align: center; border: 1px solid #f59e0b;">-</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">${formatCurrency(typeTotals.vehicle.USD)}</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">${formatCurrency(typeTotals.vehicle.IQD)}</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">${formatCurrency(typeTotals.vehicle.USD)}</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #f59e0b;">${formatCurrency(typeTotals.vehicle.IQD)}</td>
            </tr>`;

            // الإجمالي النهائي
            html += `<tr style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); font-weight: 700; border-top: 2px solid #10b981;">
                <td style="padding: 12px; color: white; font-weight: bold; border: 1px solid #10b981;">${isArabic ? 'الإجمالي النهائي' : 'Grand Total'}</td>
                <td style="padding: 12px; text-align: center; color: white; font-weight: bold; border: 1px solid #10b981;">${grandTotalEmps}</td>
                <td colspan="6" style="padding: 12px; text-align: center; color: white; border: 1px solid #10b981;">-</td>
                <td style="padding: 12px; text-align: right; color: white; font-weight: bold; border: 1px solid #10b981;">${formatCurrency(grandTotalUSD)}</td>
                <td style="padding: 12px; text-align: right; color: white; font-weight: bold; border: 1px solid #10b981;">${formatCurrency(grandTotalIQD)}</td>
            </tr></tbody></table></div></div>`;
            return html;
        }

        function generateAllProjectsComparison(month1, month2) {
            const isArabic = currentLang === 'ar';
            let html = `<div class="chart-container" style="margin-top: 20px;">
                <h3 style="color: var(--primary); margin-bottom: 20px;">📊 ${t('allProjects')} - ${t('monthNames')[month1]} vs ${t('monthNames')[month2]}</h3>
                <div style="overflow-x: auto; max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <table id="comparisonTable" style="width: 100%; font-size: 12px; border-collapse: collapse; min-width: 900px;"><thead><tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <th rowspan="2" style="padding: 12px; text-align: left; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">${t('project')}</th>
                    <th colspan="4" style="padding: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">${t('monthNames')[month1]}</th>
                    <th colspan="4" style="padding: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">${t('monthNames')[month2]}</th>
                    <th colspan="2" style="padding: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">${isArabic ? 'الفرق' : 'Difference'}</th>
                </tr><tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <th style="padding: 8px; text-align: center; font-weight: 500; font-size: 11px; border: 1px solid rgba(255,255,255,0.2);">${isArabic ? 'شهري' : 'Monthly'}</th>
                    <th style="padding: 8px; text-align: center; font-weight: 500; font-size: 11px; border: 1px solid rgba(255,255,255,0.2);">${isArabic ? 'يومي' : 'Daily'}</th>
                    <th style="padding: 8px; text-align: center; font-weight: 500; font-size: 11px; border: 1px solid rgba(255,255,255,0.2);">USD</th>
                    <th style="padding: 8px; text-align: center; font-weight: 500; font-size: 11px; border: 1px solid rgba(255,255,255,0.2);">IQD</th>
                    <th style="padding: 8px; text-align: center; font-weight: 500; font-size: 11px; border: 1px solid rgba(255,255,255,0.2);">${isArabic ? 'شهري' : 'Monthly'}</th>
                    <th style="padding: 8px; text-align: center; font-weight: 500; font-size: 11px; border: 1px solid rgba(255,255,255,0.2);">${isArabic ? 'يومي' : 'Daily'}</th>
                    <th style="padding: 8px; text-align: center; font-weight: 500; font-size: 11px; border: 1px solid rgba(255,255,255,0.2);">USD</th>
                    <th style="padding: 8px; text-align: center; font-weight: 500; font-size: 11px; border: 1px solid rgba(255,255,255,0.2);">IQD</th>
                    <th style="padding: 8px; text-align: center; font-weight: 500; font-size: 11px; border: 1px solid rgba(255,255,255,0.2);">USD</th>
                    <th style="padding: 8px; text-align: center; font-weight: 500; font-size: 11px; border: 1px solid rgba(255,255,255,0.2);">IQD</th>
                </tr></thead><tbody>`;

            let grandTotal1 = {monthlyUSD: 0, dailyUSD: 0, totalUSD: 0, totalIQD: 0, monthlyCount: 0, dailyCount: 0, emps: 0};
            let grandTotal2 = {monthlyUSD: 0, dailyUSD: 0, totalUSD: 0, totalIQD: 0, monthlyCount: 0, dailyCount: 0, emps: 0};
            
            Object.entries(projects).forEach(([code, name]) => {
                const emps1 = (employeeData[currentYear] && employeeData[currentYear][month1])
                    ? employeeData[currentYear][month1].filter(emp => emp.project === code)
                    : [];
                const emps2 = (employeeData[currentYear] && employeeData[currentYear][month2])
                    ? employeeData[currentYear][month2].filter(emp => emp.project === code)
                    : [];
                
                const stats1 = {monthly: {USD: 0, IQD: 0, count: 0}, daily: {USD: 0, IQD: 0, count: 0}, vehicle: {USD: 0, IQD: 0, count: 0}};
                const stats2 = {monthly: {USD: 0, IQD: 0, count: 0}, daily: {USD: 0, IQD: 0, count: 0}, vehicle: {USD: 0, IQD: 0, count: 0}};
                
                emps1.forEach(emp => {
                    const netSalary = calculateNetSalary(emp, month1, currentYear);
                    const type = emp.employeeType;
                    if (emp.paymentCurrency === 'USD') {
                        stats1[type].USD += netSalary;
                        stats1[type].IQD += netSalary * (emp.exchangeRate || 1420);
                    } else {
                        stats1[type].IQD += netSalary;
                        stats1[type].USD += netSalary / (emp.exchangeRate || 1420);
                    }
                    stats1[type].count++;
                });
                
                emps2.forEach(emp => {
                    const netSalary = calculateNetSalary(emp, month2, currentYear);
                    const type = emp.employeeType;
                    if (emp.paymentCurrency === 'USD') {
                        stats2[type].USD += netSalary;
                        stats2[type].IQD += netSalary * (emp.exchangeRate || 1420);
                    } else {
                        stats2[type].IQD += netSalary;
                        stats2[type].USD += netSalary / (emp.exchangeRate || 1420);
                    }
                    stats2[type].count++;
                });
                
                const totalUSD1 = stats1.monthly.USD + stats1.daily.USD + stats1.vehicle.USD;
                const totalIQD1 = stats1.monthly.IQD + stats1.daily.IQD + stats1.vehicle.IQD;
                const totalUSD2 = stats2.monthly.USD + stats2.daily.USD + stats2.vehicle.USD;
                const totalIQD2 = stats2.monthly.IQD + stats2.daily.IQD + stats2.vehicle.IQD;
                
                grandTotal1.monthlyUSD += stats1.monthly.USD;
                grandTotal1.dailyUSD += stats1.daily.USD;
                grandTotal1.totalUSD += totalUSD1;
                grandTotal1.totalIQD += totalIQD1;
                grandTotal1.monthlyCount += stats1.monthly.count;
                grandTotal1.dailyCount += stats1.daily.count;
                grandTotal1.emps += emps1.length;
                
                grandTotal2.monthlyUSD += stats2.monthly.USD;
                grandTotal2.dailyUSD += stats2.daily.USD;
                grandTotal2.totalUSD += totalUSD2;
                grandTotal2.totalIQD += totalIQD2;
                grandTotal2.monthlyCount += stats2.monthly.count;
                grandTotal2.dailyCount += stats2.daily.count;
                grandTotal2.emps += emps2.length;
                
                const diffUSD = totalUSD2 - totalUSD1;
                const diffIQD = totalIQD2 - totalIQD1;
                const diffColorUSD = diffUSD >= 0 ? '#059669' : '#dc2626';
                const diffColorIQD = diffIQD >= 0 ? '#059669' : '#dc2626';
                
                html += `<tr style="border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s;" 
                    onmouseover="this.style.backgroundColor='#f3f4f6';" 
                    onmouseout="this.style.backgroundColor='';">
                    <td style="padding: 10px; font-weight: 600; border: 1px solid #e5e7eb;">${name}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">${stats1.monthly.count}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">${stats1.daily.count}</td>
                    <td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">${formatCurrency(totalUSD1)}</td>
                    <td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">${formatCurrency(totalIQD1)}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">${stats2.monthly.count}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">${stats2.daily.count}</td>
                    <td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">${formatCurrency(totalUSD2)}</td>
                    <td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">${formatCurrency(totalIQD2)}</td>
                    <td style="padding: 10px; text-align: right; color: ${diffColorUSD}; font-weight: 700; border: 1px solid #e5e7eb;">${diffUSD >= 0 ? '+' : ''}${formatCurrency(Math.abs(diffUSD))}</td>
                    <td style="padding: 10px; text-align: right; color: ${diffColorIQD}; font-weight: 700; border: 1px solid #e5e7eb;">${diffIQD >= 0 ? '+' : ''}${formatCurrency(Math.abs(diffIQD))}</td>
                </tr>`;
            });

            const totalDiffUSD = grandTotal2.totalUSD - grandTotal1.totalUSD;
            const totalDiffIQD = grandTotal2.totalIQD - grandTotal1.totalIQD;
            const totalDiffColorUSD = totalDiffUSD >= 0 ? '#059669' : '#dc2626';
            const totalDiffColorIQD = totalDiffIQD >= 0 ? '#059669' : '#dc2626';

            html += `<tr style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); font-weight: 700; border-top: 2px solid #10b981;">
                <td style="padding: 12px; border: 1px solid #10b981;">${t('total')}</td>
                <td style="padding: 12px; text-align: center; border: 1px solid #10b981;">${grandTotal1.monthlyCount}</td>
                <td style="padding: 12px; text-align: center; border: 1px solid #10b981;">${grandTotal1.dailyCount}</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #10b981;">${formatCurrency(grandTotal1.totalUSD)}</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #10b981;">${formatCurrency(grandTotal1.totalIQD)}</td>
                <td style="padding: 12px; text-align: center; border: 1px solid #10b981;">${grandTotal2.monthlyCount}</td>
                <td style="padding: 12px; text-align: center; border: 1px solid #10b981;">${grandTotal2.dailyCount}</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #10b981;">${formatCurrency(grandTotal2.totalUSD)}</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #10b981;">${formatCurrency(grandTotal2.totalIQD)}</td>
                <td style="padding: 12px; text-align: right; color: ${totalDiffColorUSD}; border: 1px solid #10b981;">${totalDiffUSD >= 0 ? '+' : ''}${formatCurrency(Math.abs(totalDiffUSD))}</td>
                <td style="padding: 12px; text-align: right; color: ${totalDiffColorIQD}; border: 1px solid #10b981;">${totalDiffIQD >= 0 ? '+' : ''}${formatCurrency(Math.abs(totalDiffIQD))}</td>
            </tr></tbody></table></div></div>`;
            return html;
        }

        function generateSingleMonthSummary(projectCode, month) {
            const employees = (employeeData[currentYear] && employeeData[currentYear][month])
                ? employeeData[currentYear][month].filter(emp => emp.project === projectCode)
                : [];
            if (employees.length === 0) {
                return `<div class="empty-state"><p>${currentLang === 'ar' ? 'لا يوجد موظفين في هذا المشروع' : 'No employees in this project'}</p></div>`;
            }

            let totalUSD = 0, totalIQD = 0;
            const typeCount = { monthly: 0, daily: 0, vehicle: 0 };
            employees.forEach(emp => {
                typeCount[emp.employeeType]++;
                const netSalary = calculateNetSalary(emp, month, currentYear);
                const exchangeRate = emp.exchangeRate || 1420;
                if (emp.paymentCurrency === 'USD') {
                    totalUSD += netSalary;
                    totalIQD += netSalary * exchangeRate;
                } else {
                    totalIQD += netSalary;
                    totalUSD += netSalary / exchangeRate;
                }
            });

            return `<div class="chart-container" style="margin-top: 20px;">
                <h3 style="color: var(--primary); margin-bottom: 20px;">📊 ${projects[projectCode]} - ${t('monthNames')[month]}</h3>
                <div class="total-grid">
                    <div class="total-item"><div class="label">${t('totalEmployees')}</div><div class="value">${employees.length}</div></div>
                    <div class="total-item"><div class="label">${t('monthly')}</div><div class="value">${typeCount.monthly}</div></div>
                    <div class="total-item"><div class="label">${t('daily')}</div><div class="value">${typeCount.daily}</div></div>
                    <div class="total-item"><div class="label">${t('vehicle')}</div><div class="value">${typeCount.vehicle}</div></div>
                    <div class="total-item"><div class="label">${t('total')} USD</div><div class="value">${formatCurrency(totalUSD)}</div></div>
                    <div class="total-item"><div class="label">${t('total')} IQD</div><div class="value">${formatCurrency(totalIQD)}</div></div>
                </div></div>`;
        }
function generateComparisonSummary(projectCode, month1, month2) {
            const employees1 = (employeeData[currentYear] && employeeData[currentYear][month1])
                ? employeeData[currentYear][month1].filter(emp => emp.project === projectCode)
                : [];
            const employees2 = (employeeData[currentYear] && employeeData[currentYear][month2])
                ? employeeData[currentYear][month2].filter(emp => emp.project === projectCode)
                : [];

            let stats1 = { totalUSD: 0, totalIQD: 0, count: employees1.length, monthly: 0, daily: 0, vehicle: 0 };
            let stats2 = { totalUSD: 0, totalIQD: 0, count: employees2.length, monthly: 0, daily: 0, vehicle: 0 };

            employees1.forEach(emp => {
                stats1[emp.employeeType]++;
                const netSalary = calculateNetSalary(emp, month1, currentYear);
                const exchangeRate = emp.exchangeRate || 1420;
                if (emp.paymentCurrency === 'USD') {
                    stats1.totalUSD += netSalary;
                    stats1.totalIQD += netSalary * exchangeRate;
                } else {
                    stats1.totalIQD += netSalary;
                    stats1.totalUSD += netSalary / exchangeRate;
                }
            });

            employees2.forEach(emp => {
                stats2[emp.employeeType]++;
                const netSalary = calculateNetSalary(emp, month2, currentYear);
                const exchangeRate = emp.exchangeRate || 1420;
                if (emp.paymentCurrency === 'USD') {
                    stats2.totalUSD += netSalary;
                    stats2.totalIQD += netSalary * exchangeRate;
                } else {
                    stats2.totalIQD += netSalary;
                    stats2.totalUSD += netSalary / exchangeRate;
                }
            });

            const diffUSD = stats2.totalUSD - stats1.totalUSD;
            const diffIQD = stats2.totalIQD - stats1.totalIQD;
            const diffCount = stats2.count - stats1.count;
            const diffPercent = stats1.totalUSD > 0 ? ((diffUSD / stats1.totalUSD) * 100).toFixed(1) : 0;

            const diffCountSign = diffCount >= 0 ? '+' : '';
            const diffPercentSign = diffPercent >= 0 ? '+' : '';
            const diffUSDSign = diffUSD >= 0 ? '+' : '';
            const diffIQDSign = diffIQD >= 0 ? '+' : '';
            const percentBg = diffPercent >= 0 ? '#43e97b 0%, #38f9d7' : '#f093fb 0%, #f5576c';
            const comparisonText = currentLang === 'ar' ? 'مقارنة' : 'Comparison';
            const countDiffLabel = currentLang === 'ar' ? 'الفرق في العدد' : 'Count Diff';
            const percentLabel = currentLang === 'ar' ? 'النسبة' : 'Percentage';

            const diffColorText = diffCount >= 0 ? '#059669' : '#dc2626';
            const diffColorUSD = diffUSD >= 0 ? '#059669' : '#dc2626';
            const diffColorIQD = diffIQD >= 0 ? '#059669' : '#dc2626';
            
            return `<div class="chart-container" style="margin-top: 20px;">
                <h3 style="color: var(--primary); margin-bottom: 20px;">📊 ${projects[projectCode]} - ${comparisonText}</h3>
                <div class="stats-grid">
                    <div class="stat-box"><div class="label">${countDiffLabel}</div>
                        <div class="value">${diffCountSign}${diffCount}</div></div>
                    <div class="stat-box" style="background: linear-gradient(135deg, ${percentBg} 100%);">
                        <div class="label">${percentLabel}</div>
                        <div class="value">${diffPercentSign}${diffPercent}%</div></div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="label">${currentLang === 'ar' ? 'الفرق USD' : 'USD Diff'}</div>
                        <div class="value" style="color: ${diffColorUSD};">${diffUSDSign}${formatCurrency(Math.abs(diffUSD))}</div></div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <div class="label">${currentLang === 'ar' ? 'الفرق IQD' : 'IQD Diff'}</div>
                        <div class="value" style="color: ${diffColorIQD};">${diffIQDSign}${formatCurrency(Math.abs(diffIQD))}</div></div>
                </div>
                <div class="comparison-container">
                    <div class="comparison-card">
                        <h4>${t('monthNames')[month1]}</h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <div class="comparison-stat-row"><span>${t('totalEmployees')}</span><strong>${stats1.count}</strong></div>
                            <div class="comparison-stat-row"><span>${t('monthly')}</span><strong>${stats1.monthly}</strong></div>
                            <div class="comparison-stat-row"><span>${t('daily')}</span><strong>${stats1.daily}</strong></div>
                            <div class="comparison-stat-row"><span>${t('vehicle')}</span><strong>${stats1.vehicle}</strong></div>
                            <div class="comparison-stat-row"><span>${t('total')} USD</span><strong>${formatCurrency(stats1.totalUSD)}</strong></div>
                            <div class="comparison-stat-row"><span>${t('total')} IQD</span><strong>${formatCurrency(stats1.totalIQD)}</strong></div>
                        </div>
                    </div>
                    <div class="comparison-card">
                        <h4>${t('monthNames')[month2]}</h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <div class="comparison-stat-row"><span>${t('totalEmployees')}</span><strong>${stats2.count} <span style="color: ${diffColorText}; font-size: 12px;">(${diffCountSign}${diffCount})</span></strong></div>
                            <div class="comparison-stat-row"><span>${t('monthly')}</span><strong>${stats2.monthly}</strong></div>
                            <div class="comparison-stat-row"><span>${t('daily')}</span><strong>${stats2.daily}</strong></div>
                            <div class="comparison-stat-row"><span>${t('vehicle')}</span><strong>${stats2.vehicle}</strong></div>
                            <div class="comparison-stat-row"><span>${t('total')} USD</span><strong>${formatCurrency(stats2.totalUSD)}</strong></div>
                            <div class="comparison-stat-row"><span>${t('total')} IQD</span><strong>${formatCurrency(stats2.totalIQD)}</strong></div>
                        </div>
                    </div>
                </div></div>`;
        }

        // ========== Connection Status Monitor ==========
        const checkConnection = () => {
            const syncStatus = document.getElementById('syncStatus');
            if (syncStatus) {
                const isOnline = navigator.onLine;
                if (isOnline) {
                    syncStatus.innerHTML = '<div class="sync-dot"></div><span>متصل بـ Firebase</span>';
                    syncStatus.style.background = 'rgba(16, 185, 129, 0.2)';
                } else {
                    syncStatus.innerHTML = '<div class="sync-dot" style="background: #ef4444; animation: none;"></div><span>غير متصل</span>';
                    syncStatus.style.background = 'rgba(239, 68, 68, 0.2)';
                }
            }
        };

        window.addEventListener('online', checkConnection);
        window.addEventListener('offline', checkConnection);
        setInterval(checkConnection, 5000);

        // ========== Initialize Application ==========
        
        // دالة للتحقق من وجود مستخدمين وإنشاء Admin تلقائياً
        async function checkAndCreateDefaultAdmin() {
            try {
                const usersRef = collection(db, 'users');
                const snapshot = await getDocs(usersRef);
                
                if (snapshot.empty) {
                    console.log('⚠️ لا يوجد مستخدمين، سيتم إنشاء مستخدم Admin افتراضي...');
                    
                    // إنشاء مستخدم Admin افتراضي
                    const defaultEmail = 'admin@test.com';
                    const defaultPassword = '123456';
                    
                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, defaultEmail, defaultPassword);
                        const user = userCredential.user;
                        
                        // حفظ صلاحيات Admin
                        await setDoc(doc(db, 'users', user.uid), {
                            email: defaultEmail,
                            role: 'مدير',
                            fullAccess: true,
                            permissions: {
                                employees: { view: true, add: true, edit: true, delete: true },
                                projects: { view: true, add: true, edit: true, delete: true },
                                users: { view: true, add: true, edit: true, delete: true },
                                reports: { view: true, export: true, print: true },
                                settings: true
                            },
                            appVersion: '2.0.9',
                            lastAppUpdate: new Date(),
                            createdAt: new Date().toISOString()
                        });
                        
                        console.log('✅ تم إنشاء مستخدم Admin افتراضي');
                        console.log('📧 البريد: admin@test.com');
                        console.log('🔑 كلمة المرور: 123456');
                        
                        alert('تم إنشاء مستخدم Admin افتراضي:\n\nالبريد: admin@test.com\nكلمة المرور: 123456\n\nيرجى تسجيل الدخول الآن');
                        
                    } catch (error) {
                        // قد يكون المستخدم موجوداً بالفعل في Authentication
                        console.log('ℹ️ المستخدم موجود في Authentication، استخدم: admin@test.com / 123456');
                    }
                }
            } catch (error) {
                console.error('Error checking users:', error);
            }
        }
        
        async function init() {
            try {
                initTabLock();
                showLoading();
                console.log('🚀 بدء تحميل النظام...');
                
                // تحميل إعدادات المستخدم المحفوظة
                loadLanguage();
                loadAppearanceSettings();
                // البرنامج يبدأ دائماً من لوحة التحكم
                currentView = 'dashboard';
                
                await checkAndCreateDefaultAdmin(); // التحقق من المستخدمين
                await loadYearsFromFirebase(); // تحميل السنوات أولاً
                await loadProjectsFromFirebase();
                await loadEmployeesFromFirebase();
                
                // تحميل الإعدادات والتوقيعات المشتركة
                await loadCompanySettings();
                await loadPrintSignatures();
                
                hideLoading();
                console.log('✅ النظام جاهز! بدء من لوحة التحكم');
                
                setTimeout(() => {
                    showNotification('success', 'مرحباً!', 'النظام متصل بـ Firebase بنجاح 🎉');
                }, 500);
                
            } catch (error) {
                console.error('❌ خطأ في تهيئة النظام:', error);
                hideLoading();
                showNotification('error', 'خطأ', 'حدث خطأ في الاتصال بقاعدة البيانات');
                setHTML(document.getElementById('mainContent'), `
                    <div class="empty-state">
                        <h3 style="color: var(--danger);">⚠️ خطأ في الاتصال</h3>
                        <p>حدث خطأ في الاتصال بقاعدة البيانات Firebase</p>
                        <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 20px;">
                            🔄 إعادة المحاولة
                        </button>
                    </div>
                `);
            }
        }

        // ========== Enhanced Header Functions ==========
        
        // Toggle User Menu
        function toggleUserMenu() {
            const userMenu = document.getElementById('userMenu');
            userMenu.classList.toggle('active');
        }

        // Close user menu when clicking outside
        document.addEventListener('click', function(e) {
            const userMenu = document.getElementById('userMenu');
            if (userMenu && !userMenu.contains(e.target)) {
                userMenu.classList.remove('active');
            }
        });

        // Update Navigation Active State
        function updateNavigation(tab) {
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active to current tab
            const navItem = document.getElementById('nav' + tab.charAt(0).toUpperCase() + tab.slice(1));
            if (navItem) {
                navItem.classList.add('active');
            }
            
            // Update breadcrumbs
            const breadcrumbTexts = {
                'dashboard': currentLang === 'ar' ? 'لوحة التحكم' : 'Dashboard',
                'months': currentLang === 'ar' ? 'الأشهر' : 'Months',
                'projects': currentLang === 'ar' ? 'المشاريع' : 'Projects',
                'years': currentLang === 'ar' ? 'السنوات' : 'Years',
                'users': currentLang === 'ar' ? 'المستخدمين' : 'Users',
                'settings': currentLang === 'ar' ? 'الإعدادات' : 'Settings'
            };
            
            const breadcrumbCurrent = document.getElementById('breadcrumbCurrent');
            if (breadcrumbCurrent && breadcrumbTexts[tab]) {
                breadcrumbCurrent.textContent = breadcrumbTexts[tab];
            }
        }

        // Override showTab to update navigation
        const originalShowTab = showTab;
        showTab = function(tab) {
            originalShowTab(tab);
            updateNavigation(tab);
        };

        // ========== Make Functions Global ==========
        window.logout = logout;
        window.showTab = showTab;
        window.checkPassword = checkPassword;
        window.openPasswordModal = openPasswordModal;
        window.toggleUserMenu = toggleUserMenu;
        window.updateNavigation = updateNavigation;
        window.changeDashboardMonth = changeDashboardMonth;
	window.renderContent = renderContent;
        window.renderYearsView = renderYearsView;
        window.renderSettingsView = renderSettingsView;
        window.handleLogoUpload = handleLogoUpload;
        window.removeCompanyLogo = removeCompanyLogo;
        window.handleSaveCompanySettings = handleSaveCompanySettings;
        window.toggleGlobalReservationSettings = toggleGlobalReservationSettings;
        window.toggleGlobalReservationInputs = toggleGlobalReservationInputs;
        window.handleSaveGlobalReservationSettings = handleSaveGlobalReservationSettings;
        window.resetAllReservations = resetAllReservations;
        window.toggleDropdown = toggleDropdown;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.toggleLanguage = toggleLanguage;
        window.handleSearch = handleSearch;
        window.handleProjectFilter = handleProjectFilter;
        window.handleTypeFilter = handleTypeFilter;
        window.selectMonth = selectMonth;
        window.selectYear = selectYear;
        window.changeYear = changeYear;
        window.updateYearSelector = updateYearSelector;
        window.populateYearSelector = populateYearSelector;
        window.loadYearsFromFirebase = loadYearsFromFirebase;
        window.addYearToFirebase = addYearToFirebase;
        window.deleteYearFromFirebase = deleteYearFromFirebase;
        window.openAddYearModal = openAddYearModal;
        window.selectProject = selectProject;
        window.switchProject = switchProject;
        window.openEditModal = openEditModal;
        window.openCopyModal = openCopyModal;
        window.confirmCopy = confirmCopy;
        window.openCopyAllModal = openCopyAllModal;
        window.confirmCopyAll = confirmCopyAll;
        window.openCopySelectedModal = openCopySelectedModal;
        window.confirmCopySelected = confirmCopySelected;
        window.openAttendanceModal = openAttendanceModal;
        window.renderAttendanceCalendar = renderAttendanceCalendar;
        window.updateDayAttendance = updateDayAttendance;
        window.updateCustomHours = updateCustomHours;
        window.updatePeriodTime = updatePeriodTime;
        window.addPeriod = addPeriod;
        window.removePeriod = removePeriod;
        window.toggleCountAsLeave = toggleCountAsLeave;
        window.toggleCountOvertime = toggleCountOvertime;
        window.updateAttendanceSummary = updateAttendanceSummary;
        window.calculateAttendanceSalary = calculateAttendanceSalary;
        window.fillAllWorkDays = fillAllWorkDays;
        window.clearAllDays = clearAllDays;
        window.autoCalculateAttendance = autoCalculateAttendance;
        window.saveAttendanceData = saveAttendanceData;
        window.openMultipleEmployeesModal = openMultipleEmployeesModal;
        window.addMultiEmpRow = addMultiEmpRow;
        window.removeMultiEmpRow = removeMultiEmpRow;
        window.clearAllMultiEmpRows = clearAllMultiEmpRows;
        window.fillSampleData = fillSampleData;
        window.validateMultiEmpData = validateMultiEmpData;
        window.handleSmartPaste = handleSmartPaste;
        window.openEditProjectModal = openEditProjectModal;
        window.deleteEmployee = deleteEmployee;
        window.deleteProject = deleteProject;
        window.verifyPassword = verifyPassword;
        window.updateField = updateField;
        window.openReservationModal = openReservationModal;
        window.saveReservation = saveReservation;
        window.toggleReservationEnabled = toggleReservationEnabled;
        window.updateReservationCalculation = updateReservationCalculation;
        window.openReservationReport = openReservationReport;
        window.openEmployeeReportModal = openEmployeeReportModal;
        window.printEmployeeReport = printEmployeeReport;
        window.updateReservationPercentage = updateReservationPercentage;
        window.updateReservedAmount = updateReservedAmount;
        window.enableReservationQuick = enableReservationQuick;
        window.togglePaymentStatus = togglePaymentStatus;
        window.openPaymentDetailsModal = openPaymentDetailsModal;
        window.savePaymentDetails = savePaymentDetails;
        window.setPaymentFilter = setPaymentFilter;
        window.setReservationFilter = setReservationFilter;
        window.bulkMarkAsPaid = bulkMarkAsPaid;
        window.bulkMarkAsUnpaid = bulkMarkAsUnpaid;
        window.confirmBulkPayment = confirmBulkPayment;
        window.updateProjectField = updateProjectField;
        window.changeProjectMonth = changeProjectMonth;
        window.toggleEmployeeSelection = toggleEmployeeSelection;
        window.toggleSelectAll = toggleSelectAll;
        window.deleteSelectedEmployees = deleteSelectedEmployees;
        window.moveEmployeeUp = moveEmployeeUp;
        window.moveEmployeeDown = moveEmployeeDown;
        window.handleDragStart = handleDragStart;
        window.handleDragOver = handleDragOver;
        window.handleDrop = handleDrop;
        window.handleDragEnd = handleDragEnd;
        window.exportData = exportData;
        window.exportToExcel = exportToExcel;
        window.exportToPDF = exportToPDF;
        window.exportToJSON = exportToJSON;
        window.printCurrentPage = printCurrentPage;
        window.printProjectTables = printProjectTables;
        window.exportTableToPDF = exportTableToPDF;
        window.openPrintOptionsModal = openPrintOptionsModal;
        window.executePrintWithOptions = executePrintWithOptions;
        window.printFromPreview = printFromPreview;
        window.savePDFFromPreview = savePDFFromPreview;
        window.adjustPrintSettings = adjustPrintSettings;
        window.openSignaturesModal = openSignaturesModal;
        window.saveSignatures = saveSignatures;
        window.checkSignatures = checkSignatures;
        window.getSignaturesHTML = getSignaturesHTML;
        window.importData = importData;
        window.migrateToSupabase = migrateToSupabase;

        // ========== Database Usage Statistics ==========
        /**
         * جلب إحصائيات استخدام قاعدة البيانات
         */
        /**
         * تتبع استخدام Firebase (يُستدعى تلقائياً عند العمليات)
         */
        function trackFirebaseUsage(type, count = 1) {
            try {
                const today = new Date().toDateString();
                const dailyUsageKey = `firebase_daily_usage_${today}`;
                const dailyUsage = JSON.parse(localStorage.getItem(dailyUsageKey) || '{"reads": 0, "writes": 0, "deletes": 0}');
                
                if (type === 'read') {
                    dailyUsage.reads = (dailyUsage.reads || 0) + count;
                } else if (type === 'write') {
                    dailyUsage.writes = (dailyUsage.writes || 0) + count;
                } else if (type === 'delete') {
                    dailyUsage.deletes = (dailyUsage.deletes || 0) + count;
                }
                
                localStorage.setItem(dailyUsageKey, JSON.stringify(dailyUsage));
            } catch (error) {
                console.warn('⚠️ خطأ في تتبع استخدام Firebase:', error);
            }
        }

        /**
         * تتبع استخدام Supabase (يُستدعى تلقائياً عند العمليات)
         */
        function trackSupabaseUsage(type, size = 0) {
            try {
                const currentMonth = new Date().getFullYear() + '-' + (new Date().getMonth() + 1);
                const monthlyUsageKey = `supabase_monthly_usage_${currentMonth}`;
                const monthlyUsage = JSON.parse(localStorage.getItem(monthlyUsageKey) || '{"databaseSize": 0, "bandwidth": 0, "apiRequests": 0}');
                
                if (type === 'api') {
                    monthlyUsage.apiRequests = (monthlyUsage.apiRequests || 0) + 1;
                    monthlyUsage.bandwidth = (monthlyUsage.bandwidth || 0) + size;
                } else if (type === 'bandwidth') {
                    monthlyUsage.bandwidth = (monthlyUsage.bandwidth || 0) + size;
                }
                
                localStorage.setItem(monthlyUsageKey, JSON.stringify(monthlyUsage));
            } catch (error) {
                console.warn('⚠️ خطأ في تتبع استخدام Supabase:', error);
            }
        }

        async function loadDatabaseUsageStats() {
            try {
                const statsContent = document.getElementById('databaseStatsContent');
                if (!statsContent) return;

                statsContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748b;"><div style="font-size: 48px; margin-bottom: 10px;">⏳</div><div>' + (currentLang === 'ar' ? 'جاري التحميل...' : 'Loading...') + '</div></div>';

                const stats = {
                    firebase: await getFirebaseStats(),
                    supabase: await getSupabaseStats()
                };

                renderDatabaseStats(stats);
            } catch (error) {
                console.error('❌ خطأ في جلب إحصائيات قاعدة البيانات:', error);
                const statsContent = document.getElementById('databaseStatsContent');
                if (statsContent) {
                    statsContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;"><div style="font-size: 48px; margin-bottom: 10px;">❌</div><div>' + (currentLang === 'ar' ? 'خطأ في تحميل الإحصائيات' : 'Error loading statistics') + '</div></div>';
                }
            }
        }

        /**
         * جلب إحصائيات Firebase وفق الخطة المجانية
         */
        async function getFirebaseStats() {
            try {
                const collections = ['employees', 'projects', 'settings', 'users', 'activity_logs'];
                const stats = {
                    totalDocuments: 0,
                    collections: {},
                    estimatedSize: 0
                };

                for (const collectionName of collections) {
                    try {
                        const snapshot = await getDocs(collection(db, collectionName));
                        const count = snapshot.size;
                        stats.collections[collectionName] = count;
                        stats.totalDocuments += count;
                        // تقدير الحجم: كل مستند ≈ 1 KB
                        stats.estimatedSize += count * 1024;
                    } catch (error) {
                        console.warn(`⚠️ خطأ في جلب إحصائيات ${collectionName}:`, error);
                        stats.collections[collectionName] = 0;
                    }
                }

                // الحدود اليومية (Spark Plan - Free)
                const dailyLimits = {
                    reads: 50000,      // 50,000 قراءة يومياً
                    writes: 20000,     // 20,000 كتابة يومياً
                    deletes: 20000     // 20,000 حذف يومياً
                };

                // الحدود الشهرية (Spark Plan - Free)
                const monthlyLimits = {
                    storage: 1 * 1024 * 1024 * 1024,  // 1 GB بالبايت
                    bandwidth: 10 * 1024 * 1024 * 1024  // 10 GB بالبايت
                };

                // جلب الاستخدام اليومي من localStorage
                const today = new Date().toDateString();
                const dailyUsageKey = `firebase_daily_usage_${today}`;
                const dailyUsage = JSON.parse(localStorage.getItem(dailyUsageKey) || '{"reads": 0, "writes": 0, "deletes": 0}');

                // جلب الاستخدام الشهري من localStorage
                const currentMonth = new Date().getFullYear() + '-' + (new Date().getMonth() + 1);
                const monthlyUsageKey = `firebase_monthly_usage_${currentMonth}`;
                const monthlyUsage = JSON.parse(localStorage.getItem(monthlyUsageKey) || '{"storage": 0, "bandwidth": 0}');

                // تحديث الاستخدام الشهري (التخزين)
                monthlyUsage.storage = stats.estimatedSize;

                stats.limits = {
                    daily: dailyLimits,
                    monthly: monthlyLimits
                };

                stats.usage = {
                    daily: dailyUsage,
                    monthly: monthlyUsage
                };

                stats.usagePercent = {
                    dailyReads: (dailyUsage.reads / dailyLimits.reads) * 100,
                    dailyWrites: (dailyUsage.writes / dailyLimits.writes) * 100,
                    dailyDeletes: (dailyUsage.deletes / dailyLimits.deletes) * 100,
                    monthlyStorage: (monthlyUsage.storage / monthlyLimits.storage) * 100,
                    monthlyBandwidth: (monthlyUsage.bandwidth / monthlyLimits.bandwidth) * 100
                };

                // حفظ الاستخدام الشهري
                localStorage.setItem(monthlyUsageKey, JSON.stringify(monthlyUsage));

                return stats;
            } catch (error) {
                console.error('❌ خطأ في جلب إحصائيات Firebase:', error);
                return null;
            }
        }

        /**
         * جلب إحصائيات Supabase وفق الخطة المجانية
         */
        async function getSupabaseStats() {
            try {
                const tables = ['employees', 'projects', 'settings', 'users', 'activity_logs'];
                const stats = {
                    totalRows: 0,
                    tables: {},
                    estimatedSize: 0
                };

                for (const tableName of tables) {
                    try {
                        const { count, error } = await supabase
                            .from(tableName)
                            .select('*', { count: 'exact', head: true });
                        
                        if (error) throw error;
                        
                        const countValue = count || 0;
                        stats.tables[tableName] = countValue;
                        stats.totalRows += countValue;
                        // تقدير الحجم: كل صف ≈ 2 KB
                        stats.estimatedSize += countValue * 2048;
                    } catch (error) {
                        console.warn(`⚠️ خطأ في جلب إحصائيات ${tableName}:`, error);
                        stats.tables[tableName] = 0;
                    }
                }

                // الحدود الشهرية (Free Tier)
                const monthlyLimits = {
                    databaseSize: 500 * 1024 * 1024,      // 500 MB بالبايت
                    bandwidth: 2 * 1024 * 1024 * 1024,    // 2 GB بالبايت
                    apiRequests: 50000                     // 50,000 طلب API شهرياً
                };

                // جلب الاستخدام الشهري من localStorage
                const currentMonth = new Date().getFullYear() + '-' + (new Date().getMonth() + 1);
                const monthlyUsageKey = `supabase_monthly_usage_${currentMonth}`;
                const monthlyUsage = JSON.parse(localStorage.getItem(monthlyUsageKey) || '{"databaseSize": 0, "bandwidth": 0, "apiRequests": 0}');

                // تحديث الاستخدام الشهري (حجم قاعدة البيانات)
                monthlyUsage.databaseSize = stats.estimatedSize;

                stats.limits = {
                    monthly: monthlyLimits
                };

                stats.usage = {
                    monthly: monthlyUsage
                };

                stats.usagePercent = {
                    monthlyDatabaseSize: (monthlyUsage.databaseSize / monthlyLimits.databaseSize) * 100,
                    monthlyBandwidth: (monthlyUsage.bandwidth / monthlyLimits.bandwidth) * 100,
                    monthlyApiRequests: (monthlyUsage.apiRequests / monthlyLimits.apiRequests) * 100
                };

                // حفظ الاستخدام الشهري
                localStorage.setItem(monthlyUsageKey, JSON.stringify(monthlyUsage));

                return stats;
            } catch (error) {
                console.error('❌ خطأ في جلب إحصائيات Supabase:', error);
                return null;
            }
        }

        /**
         * عرض إحصائيات قاعدة البيانات وفق الخطة المجانية
         */
        function renderDatabaseStats(stats) {
            const statsContent = document.getElementById('databaseStatsContent');
            if (!statsContent) return;

            let html = '';

            // دالة مساعدة لتنسيق الحجم
            function formatBytes(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
            }

            // دالة مساعدة للحصول على لون حسب النسبة
            function getColor(percent) {
                return percent > 80 ? '#ef4444' : percent > 60 ? '#f59e0b' : '#10b981';
            }

            if (stats.firebase) {
                const fb = stats.firebase;
                const dailyReadsPercent = Math.min(fb.usagePercent.dailyReads || 0, 100);
                const dailyWritesPercent = Math.min(fb.usagePercent.dailyWrites || 0, 100);
                const dailyDeletesPercent = Math.min(fb.usagePercent.dailyDeletes || 0, 100);
                const monthlyStoragePercent = Math.min(fb.usagePercent.monthlyStorage || 0, 100);
                const monthlyBandwidthPercent = Math.min(fb.usagePercent.monthlyBandwidth || 0, 100);
                
                html += `
                <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); padding: 25px; border-radius: 16px; box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3); color: white;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                        <span style="font-size: 32px;">🔥</span>
                        <h4 style="margin: 0; font-size: 20px; font-weight: 700;">Firebase (Spark Plan - Free)</h4>
                    </div>
                    
                    <!-- الحدود اليومية -->
                    <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                        <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px; opacity: 0.95;">📅 ${currentLang === 'ar' ? 'الحدود اليومية' : 'Daily Limits'}</div>
                        
                        <!-- القراءات اليومية -->
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                                <span style="opacity: 0.9;">📖 ${currentLang === 'ar' ? 'القراءات' : 'Reads'}</span>
                                <span style="font-weight: 600;">${formatCurrency(fb.usage.daily.reads || 0)} / ${formatCurrency(fb.limits.daily.reads)}</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="background: ${getColor(dailyReadsPercent)}; height: 100%; width: ${dailyReadsPercent}%; transition: width 0.5s;"></div>
                            </div>
                            <div style="text-align: left; margin-top: 4px; font-size: 11px; opacity: 0.8;">${dailyReadsPercent.toFixed(1)}%</div>
                        </div>
                        
                        <!-- الكتابات اليومية -->
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                                <span style="opacity: 0.9;">✍️ ${currentLang === 'ar' ? 'الكتابات' : 'Writes'}</span>
                                <span style="font-weight: 600;">${formatCurrency(fb.usage.daily.writes || 0)} / ${formatCurrency(fb.limits.daily.writes)}</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="background: ${getColor(dailyWritesPercent)}; height: 100%; width: ${dailyWritesPercent}%; transition: width 0.5s;"></div>
                            </div>
                            <div style="text-align: left; margin-top: 4px; font-size: 11px; opacity: 0.8;">${dailyWritesPercent.toFixed(1)}%</div>
                        </div>
                        
                        <!-- الحذف اليومي -->
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                                <span style="opacity: 0.9;">🗑️ ${currentLang === 'ar' ? 'الحذف' : 'Deletes'}</span>
                                <span style="font-weight: 600;">${formatCurrency(fb.usage.daily.deletes || 0)} / ${formatCurrency(fb.limits.daily.deletes)}</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="background: ${getColor(dailyDeletesPercent)}; height: 100%; width: ${dailyDeletesPercent}%; transition: width 0.5s;"></div>
                            </div>
                            <div style="text-align: left; margin-top: 4px; font-size: 11px; opacity: 0.8;">${dailyDeletesPercent.toFixed(1)}%</div>
                        </div>
                    </div>
                    
                    <!-- الحدود الشهرية -->
                    <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                        <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px; opacity: 0.95;">📆 ${currentLang === 'ar' ? 'الحدود الشهرية' : 'Monthly Limits'}</div>
                        
                        <!-- التخزين الشهري -->
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                                <span style="opacity: 0.9;">💾 ${currentLang === 'ar' ? 'التخزين' : 'Storage'}</span>
                                <span style="font-weight: 600;">${formatBytes(fb.usage.monthly.storage || 0)} / ${formatBytes(fb.limits.monthly.storage)}</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="background: ${getColor(monthlyStoragePercent)}; height: 100%; width: ${monthlyStoragePercent}%; transition: width 0.5s;"></div>
                            </div>
                            <div style="text-align: left; margin-top: 4px; font-size: 11px; opacity: 0.8;">${monthlyStoragePercent.toFixed(1)}%</div>
                        </div>
                        
                        <!-- النطاق الترددي الشهري -->
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                                <span style="opacity: 0.9;">🌐 ${currentLang === 'ar' ? 'النطاق الترددي' : 'Bandwidth'}</span>
                                <span style="font-weight: 600;">${formatBytes(fb.usage.monthly.bandwidth || 0)} / ${formatBytes(fb.limits.monthly.bandwidth)}</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="background: ${getColor(monthlyBandwidthPercent)}; height: 100%; width: ${monthlyBandwidthPercent}%; transition: width 0.5s;"></div>
                            </div>
                            <div style="text-align: left; margin-top: 4px; font-size: 11px; opacity: 0.8;">${monthlyBandwidthPercent.toFixed(1)}%</div>
                        </div>
                    </div>
                    
                    <!-- تفاصيل المجموعات -->
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">${currentLang === 'ar' ? 'إجمالي المستندات:' : 'Total Documents:'} <strong>${formatCurrency(fb.totalDocuments)}</strong></div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                            <div>👥 ${currentLang === 'ar' ? 'الموظفين' : 'Employees'}: <strong>${fb.collections.employees || 0}</strong></div>
                            <div>🏗️ ${currentLang === 'ar' ? 'المشاريع' : 'Projects'}: <strong>${fb.collections.projects || 0}</strong></div>
                            <div>⚙️ ${currentLang === 'ar' ? 'الإعدادات' : 'Settings'}: <strong>${fb.collections.settings || 0}</strong></div>
                            <div>👤 ${currentLang === 'ar' ? 'المستخدمين' : 'Users'}: <strong>${fb.collections.users || 0}</strong></div>
                            <div style="grid-column: 1 / -1;">📝 ${currentLang === 'ar' ? 'سجل الأنشطة' : 'Activity Logs'}: <strong>${fb.collections.activity_logs || 0}</strong></div>
                        </div>
                    </div>
                </div>
                `;
            } else {
                html += `<div style="background: #f3f4f6; padding: 25px; border-radius: 16px; text-align: center; color: #64748b;"><div style="font-size: 32px; margin-bottom: 10px;">🔥</div><div>${currentLang === 'ar' ? 'غير متاح' : 'Not Available'}</div></div>`;
            }

            if (stats.supabase) {
                const sb = stats.supabase;
                const monthlyDatabasePercent = Math.min(sb.usagePercent.monthlyDatabaseSize || 0, 100);
                const monthlyBandwidthPercent = Math.min(sb.usagePercent.monthlyBandwidth || 0, 100);
                const monthlyApiPercent = Math.min(sb.usagePercent.monthlyApiRequests || 0, 100);
                
                html += `
                <div style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); padding: 25px; border-radius: 16px; box-shadow: 0 10px 30px rgba(79, 70, 229, 0.3); color: white;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                        <span style="font-size: 32px;">⚡</span>
                        <h4 style="margin: 0; font-size: 20px; font-weight: 700;">Supabase (Free Tier)</h4>
                    </div>
                    
                    <!-- الحدود الشهرية -->
                    <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                        <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px; opacity: 0.95;">📆 ${currentLang === 'ar' ? 'الحدود الشهرية' : 'Monthly Limits'}</div>
                        
                        <!-- حجم قاعدة البيانات -->
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                                <span style="opacity: 0.9;">💾 ${currentLang === 'ar' ? 'حجم قاعدة البيانات' : 'Database Size'}</span>
                                <span style="font-weight: 600;">${formatBytes(sb.usage.monthly.databaseSize || 0)} / ${formatBytes(sb.limits.monthly.databaseSize)}</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="background: ${getColor(monthlyDatabasePercent)}; height: 100%; width: ${monthlyDatabasePercent}%; transition: width 0.5s;"></div>
                            </div>
                            <div style="text-align: left; margin-top: 4px; font-size: 11px; opacity: 0.8;">${monthlyDatabasePercent.toFixed(1)}%</div>
                        </div>
                        
                        <!-- النطاق الترددي الشهري -->
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                                <span style="opacity: 0.9;">🌐 ${currentLang === 'ar' ? 'النطاق الترددي' : 'Bandwidth'}</span>
                                <span style="font-weight: 600;">${formatBytes(sb.usage.monthly.bandwidth || 0)} / ${formatBytes(sb.limits.monthly.bandwidth)}</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="background: ${getColor(monthlyBandwidthPercent)}; height: 100%; width: ${monthlyBandwidthPercent}%; transition: width 0.5s;"></div>
                            </div>
                            <div style="text-align: left; margin-top: 4px; font-size: 11px; opacity: 0.8;">${monthlyBandwidthPercent.toFixed(1)}%</div>
                        </div>
                        
                        <!-- طلبات API الشهرية -->
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                                <span style="opacity: 0.9;">🔌 ${currentLang === 'ar' ? 'طلبات API' : 'API Requests'}</span>
                                <span style="font-weight: 600;">${formatCurrency(sb.usage.monthly.apiRequests || 0)} / ${formatCurrency(sb.limits.monthly.apiRequests)}</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="background: ${getColor(monthlyApiPercent)}; height: 100%; width: ${monthlyApiPercent}%; transition: width 0.5s;"></div>
                            </div>
                            <div style="text-align: left; margin-top: 4px; font-size: 11px; opacity: 0.8;">${monthlyApiPercent.toFixed(1)}%</div>
                        </div>
                    </div>
                    
                    <!-- تفاصيل الجداول -->
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">${currentLang === 'ar' ? 'إجمالي الصفوف:' : 'Total Rows:'} <strong>${formatCurrency(sb.totalRows)}</strong></div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                            <div>👥 ${currentLang === 'ar' ? 'الموظفين' : 'Employees'}: <strong>${sb.tables.employees || 0}</strong></div>
                            <div>🏗️ ${currentLang === 'ar' ? 'المشاريع' : 'Projects'}: <strong>${sb.tables.projects || 0}</strong></div>
                            <div>⚙️ ${currentLang === 'ar' ? 'الإعدادات' : 'Settings'}: <strong>${sb.tables.settings || 0}</strong></div>
                            <div>👤 ${currentLang === 'ar' ? 'المستخدمين' : 'Users'}: <strong>${sb.tables.users || 0}</strong></div>
                            <div style="grid-column: 1 / -1;">📝 ${currentLang === 'ar' ? 'سجل الأنشطة' : 'Activity Logs'}: <strong>${sb.tables.activity_logs || 0}</strong></div>
                        </div>
                    </div>
                </div>
                `;
            } else {
                html += `<div style="background: #f3f4f6; padding: 25px; border-radius: 16px; text-align: center; color: #64748b;"><div style="font-size: 32px; margin-bottom: 10px;">⚡</div><div>${currentLang === 'ar' ? 'غير متاح' : 'Not Available'}</div></div>`;
            }

            statsContent.innerHTML = html;
        }

        window.loadDatabaseUsageStats = loadDatabaseUsageStats;
        window.trackFirebaseUsage = trackFirebaseUsage;
        window.trackSupabaseUsage = trackSupabaseUsage;
        window.openSummaryModal = openSummaryModal;
        window.generateSummary = generateSummary;
        
        // ========== Local Account Functions ==========
        function openLocalAccountModal() {
            // التحقق من الوضع الحالي
            if (getStorageMode() !== 'local') {
                if (confirm('لإنشاء حساب محلي، يجب التبديل إلى الوضع المحلي أولاً.\n\nهل تريد التبديل الآن؟')) {
                    setStorageMode('local');
                    location.reload();
                }
                return;
            }
            openModal('localAccountModal');
        }
        
        function createLocalAccount() {
            const email = document.getElementById('localAccountEmail').value.trim();
            const password = document.getElementById('localAccountPassword').value;
            const passwordConfirm = document.getElementById('localAccountPasswordConfirm').value;
            const name = document.getElementById('localAccountName').value.trim();
            
            // التحقق من البيانات
            if (!email || !password || !name) {
                showNotification('error', 'خطأ', 'يرجى ملء جميع الحقول');
                return;
            }
            
            if (password.length < 6) {
                showNotification('error', 'خطأ', 'كلمة المرور يجب أن تكون 6 أحرف على الأقل');
                return;
            }
            
            if (password !== passwordConfirm) {
                showNotification('error', 'خطأ', 'كلمة المرور غير متطابقة');
                return;
            }
            
            // إنشاء الحساب
            const result = LocalAuth.register(email, password, {
                displayName: name,
                fullAccess: true, // الحساب الأول يحصل على صلاحيات كاملة
                permissions: {
                    employees: { create: true, update: true, delete: true, view: true },
                    projects: { create: true, update: true, delete: true, view: true },
                    settings: { editGeneral: true, editProjects: true, editBackup: true, viewLogs: true },
                    dashboard: { view: true },
                    reports: { view: true, export: true, print: true }
                }
            });
            
            if (result.success) {
                showNotification('success', 'تم', 'تم إنشاء الحساب بنجاح! ✅');
                closeModal('localAccountModal');
                
                // تسجيل الدخول تلقائياً
                const loginResult = LocalAuth.login(email, password);
                if (loginResult.success) {
                    // تعيين currentUser للتوافق مع باقي الكود
                    currentUser = {
                        email: loginResult.user.email,
                        uid: loginResult.user.uid,
                        displayName: loginResult.user.displayName,
                        fullAccess: true
                    };
                    
                    // إخفاء شاشة تسجيل الدخول وإظهار التطبيق
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                    
                    // تحميل البيانات
                    initializeSystem();
                }
            } else {
                showNotification('error', 'خطأ', result.error || 'فشل إنشاء الحساب');
            }
        }
        
        window.openLocalAccountModal = openLocalAccountModal;
        window.createLocalAccount = createLocalAccount;
        window.printSummary = printSummary;
        window.openActivityLogModal = openActivityLogModal;
        window.loadActivityLogs = loadActivityLogs;
        window.toggleAppearancePanel = toggleAppearancePanel;
        window.updateRowHeight = updateRowHeight;
        window.updateFontSize = updateFontSize;
        window.updatePadding = updatePadding;
        window.updateHeaderHeight = updateHeaderHeight;
        window.resetAppearance = resetAppearance;
        window.makeColumnsResizable = makeColumnsResizable;
        window.loadColumnWidths = loadColumnWidths;
        window.saveColumnWidth = saveColumnWidth;
        window.saveCurrentFormatting = saveCurrentFormatting;
        window.saveAppearanceSettings = saveAppearanceSettings;
        window.clearAllSavedSettings = clearAllSavedSettings;
        window.toggleColumnVisibilityPanel = toggleColumnVisibilityPanel;
        window.populateColumnToggles = populateColumnToggles;
        window.toggleColumnVisibility = toggleColumnVisibility;
        window.applyColumnVisibility = applyColumnVisibility;
        window.showAllColumns = showAllColumns;
        window.hideAllColumns = hideAllColumns;
        window.resetColumnVisibility = resetColumnVisibility;
        window.updateSalaryLabelByType = updateSalaryLabelByType;
        window.loadUsersData = loadUsersData;
        window.editUserPermissions = editUserPermissions;
        window.deleteUserPermissions = deleteUserPermissions;
        window.togglePermissionDetails = togglePermissionDetails;
        window.toggleLinkPermissionDetails = toggleLinkPermissionDetails;
        window.toggleEditPermissionDetails = toggleEditPermissionDetails;
        window.toggleSpecificProjects = toggleSpecificProjects;
        window.toggleLinkSpecificProjects = toggleLinkSpecificProjects;
        window.toggleEditProjectsList = toggleEditProjectsList;
        // toggleEditSpecificProjects كان غير معرف؛ نربطه بدالة القائمة الصحيحة
        window.toggleEditSpecificProjects = toggleEditProjectsList;
        window.toggleSpecificMonths = toggleSpecificMonths;
        // toggleEditSpecificMonths غير معرف؛ نربطه بنفس منطق العرض/الإخفاء للأشهر
        window.toggleEditSpecificMonths = function toggleEditSpecificMonths(){
            const viewAll = document.getElementById('edit_months_viewAll')?.checked;
            const container = document.getElementById('specificMonthsDiv');
            if (!container) return;
            container.style.opacity = viewAll ? '0.5' : '1';
            container.style.pointerEvents = viewAll ? 'none' : 'auto';
        };
        window.loadProjectsList = loadProjectsList;
        // setAllEditPermissions غير معرف؛ نضيف نسخة تبسط تحديد/إلغاء تحديد كل صلاحيات قسم التحرير
        window.setAllEditPermissions = function setAllEditPermissions(checked){
            const ids = [
                'edit_months_view','edit_months_viewDetails','edit_months_add','edit_months_edit','edit_months_editSalary','edit_months_editBonus','edit_months_editDeductions','edit_months_editAdvance','edit_months_delete','edit_months_copy','edit_months_print','edit_months_export','edit_months_filter','edit_months_search','edit_months_lockMonths',
                'edit_projects_view','edit_projects_viewDetails','edit_projects_add','edit_projects_edit','edit_projects_delete','edit_projects_print','edit_projects_export',
                'edit_employees_view','edit_employees_viewSalary','edit_employees_viewPersonal','edit_employees_add','edit_employees_edit','edit_employees_delete',
                'edit_reports_view','edit_reports_viewMonthly','edit_reports_viewProject','edit_reports_export','edit_reports_print',
                'edit_users_view','edit_users_viewDetails','edit_users_add','edit_users_edit','edit_users_delete',
                'edit_settings_view','edit_settings_editProjects',
                'edit_dashboard_view','edit_dashboard_viewStatistics','edit_dashboard_viewCharts'
            ];
            ids.forEach(id=>{ const el=document.getElementById(id); if(el) el.checked=!!checked; });
        };
        window.getEditPermissions = getEditPermissions;
        window.hasPermission = hasPermission;

        // ========== Event Listeners ==========
        
        // معالج نموذج إضافة موظف
        document.getElementById('employeeForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // التحقق من وجود المستخدم
            if (!currentUser) {
                showNotification('error', t('notAuthorized'), t('loginRequired'));
                return;
            }
            
            // التحقق من قفل الشهر
            if (!canEditCurrentMonth()) {
                showNotification('warning', t('warning'), t('monthLocked'));
                return;
            }
            
            const projectCode = document.getElementById('project').value;
            const employeeType = document.getElementById('employeeType').value || 'monthly';
            
            // التحقق من صلاحية الوصول للمشروع
            if (!hasProjectAccess(projectCode)) {
                showNotification('error', t('notAuthorized'), t('noProjectAccess'));
                return;
            }
            
            // التحقق من صلاحية إضافة الموظفين
            if (!hasDetailedPermission('employees', 'add', null, employeeType)) {
                showNotification('error', 'غير مصرح', `ليس لديك صلاحية لإضافة موظفين من نوع: ${employeeType}`);
                return;
            }
            
            const nameAr = document.getElementById('nameAr').value.trim();
            const nameEn = document.getElementById('nameEn').value.trim();
            
            // التحقق من إدخال اسم على الأقل
            if (!nameAr && !nameEn) {
                showNotification('error', t('error'), currentLang === 'ar' ? 'يجب إدخال اسم الموظف (عربي أو إنجليزي)' : 'Employee name (Arabic or English) is required');
                return;
            }
            
            // التحقق من تكرار الاسم في جميع المشاريع (في نفس الشهر فقط)
            const duplicateCheck = checkDuplicateEmployeeName(nameAr, nameEn, null, currentMonth, currentYear);
            if (duplicateCheck.duplicate) {
                showNotification('error', currentLang === 'ar' ? 'اسم مكرر' : 'Duplicate Name', duplicateCheck.message);
                return;
            }

            showLoading();

            const employeeCode = await generateEmployeeCode(projectCode);
            
            const employeeData = {
                employeeCode: employeeCode, // الرمز التلقائي
                nameAr: nameAr,
                nameEn: nameEn,
                position: document.getElementById('position').value,
                employeeType: document.getElementById('employeeType').value,
                project: projectCode,
                salary: parseFloat(document.getElementById('salary').value),
                salaryCurrency: document.getElementById('salaryCurrency').value,
                paymentCurrency: document.getElementById('paymentCurrency').value,
                exchangeRate: parseFloat(document.getElementById('exchangeRate').value),
                workDays: 30,
                bonus: 0,
                bonusCurrency: 'IQD',
                phoneBills: 0,
                phoneBillsCurrency: 'IQD',
                deductions: 0,
                deductionsCurrency: 'IQD',
                advance: 0,
                advanceCurrency: 'IQD',
                salaryIncrease: 0,
                salaryIncreaseCurrency: 'IQD',
                ceoBonus: 0,
                ceoBonusCurrency: 'IQD',
                // إعدادات الدوام
                attendanceSystem: document.getElementById('attendanceSystem').value || 'hours',
                dailyWorkHours: parseFloat(document.getElementById('dailyWorkHours').value) || 8,
                overtimeMultiplier: parseFloat(document.getElementById('overtimeMultiplier')?.value || 1.5),
                monthCalculationMethod: document.getElementById('monthCalculationMethod')?.value || '30',
                workDaysOfWeek: [
                    document.getElementById('workDay_0')?.checked !== false,
                    document.getElementById('workDay_1')?.checked !== false,
                    document.getElementById('workDay_2')?.checked !== false,
                    document.getElementById('workDay_3')?.checked !== false,
                    document.getElementById('workDay_4')?.checked !== false,
                    document.getElementById('workDay_5')?.checked || false,
                    document.getElementById('workDay_6')?.checked !== false
                ],
                paidLeaveCalculation: document.getElementById('paidLeaveCalculation').value || 'full',
                attendance: {} // بيانات الدوام فارغة في البداية
            };
            
            await saveEmployeeToFirebase(employeeData, currentMonth, currentYear);
            hideLoading();
            closeModal('employeeModal');
            document.getElementById('employeeForm').reset();
        });
        
        // معالج نموذج تعديل موظف
        document.getElementById('editForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // التحقق من وجود المستخدم
            if (!currentUser) {
                showNotification('error', t('notAuthorized'), t('loginRequired'));
                return;
            }
            
            // التحقق من قفل الشهر
            if (!canEditCurrentMonth()) {
                showNotification('warning', t('warning'), t('monthLocked'));
                return;
            }
            
            if (employeeIndexToEdit === null) return;
            
            const emp = employeeData[currentYear][currentMonth][employeeIndexToEdit];
            
            if (!emp) {
                console.error('❌ الموظف غير موجود');
                showNotification('error', t('error'), t('employeeNotFound'));
                return;
            }
            
            // التحقق من حالة الدفع - منع التعديل إذا تم الدفع
            if (emp.isPaid === true) {
                const paidDate = emp.paidDate ? new Date(emp.paidDate).toLocaleDateString(currentLang === 'ar' ? 'ar-EG' : 'en-US') : '';
                const message = currentLang === 'ar' 
                    ? `⚠️ لا يمكن تعديل بيانات الموظف الذي تم الدفع له${paidDate ? ' في ' + paidDate : ''}`
                    : `⚠️ Cannot edit employee who has been paid${paidDate ? ' on ' + paidDate : ''}`;
                showNotification('error', currentLang === 'ar' ? 'تم الدفع' : 'Paid', message);
                return;
            }
            
            if (!emp.firebaseId) {
                console.error('❌ معرّف Firebase غير موجود للموظف');
                showNotification('error', t('error'), t('firebaseIdMissing'));
                return;
            }
            
            // التحقق من صلاحية الوصول لمشروع الموظف
            if (!hasProjectAccess(emp.project)) {
                showNotification('error', t('notAuthorized'), t('noProjectAccess'));
                return;
            }
            
            // التحقق من صلاحية تعديل الموظفين
            const employeeType = emp.employeeType || 'monthly';
            if (!hasDetailedPermission('employees', 'edit', null, employeeType)) {
                showNotification('error', t('notAuthorized'), `${t('noEditPermission')} ${t('employees')} ${t('employeeType')}: ${employeeType}`);
                return;
            }
            
            const nameAr = document.getElementById('editNameAr').value.trim();
            const nameEn = document.getElementById('editNameEn').value.trim();
            
            // التحقق من إدخال اسم على الأقل
            if (!nameAr && !nameEn) {
                showNotification('error', t('error'), currentLang === 'ar' ? 'يجب إدخال اسم الموظف (عربي أو إنجليزي)' : 'Employee name (Arabic or English) is required');
                return;
            }
            
            // التحقق من تكرار الاسم في جميع المشاريع (مع استثناء الموظف الحالي - في نفس الشهر فقط)
            const duplicateCheck = checkDuplicateEmployeeName(nameAr, nameEn, emp.firebaseId, currentMonth, currentYear, employeeIndexToEdit);
            if (duplicateCheck.duplicate) {
                showNotification('error', currentLang === 'ar' ? 'اسم مكرر' : 'Duplicate Name', duplicateCheck.message);
                return;
            }
            
            const updates = {
                nameAr: nameAr,     
                nameEn: nameEn,
                position: document.getElementById('editPosition').value.trim(),
                employeeType: document.getElementById('editEmployeeType').value,
                project: document.getElementById('editProject').value,
                salary: parseFloat(document.getElementById('editSalary').value) || 0,
                salaryCurrency: document.getElementById('editSalaryCurrency').value,
                paymentCurrency: document.getElementById('editPaymentCurrency').value,
                exchangeRate: parseFloat(document.getElementById('editExchangeRate').value) || 1420,
                // إعدادات الدوام
                attendanceSystem: document.getElementById('editAttendanceSystem').value,
                dailyWorkHours: parseFloat(document.getElementById('editDailyWorkHours').value) || 8,
                overtimeMultiplier: parseFloat(document.getElementById('editOvertimeMultiplier')?.value) || 1.5,
                monthCalculationMethod: document.getElementById('editMonthCalculationMethod')?.value || '30',
                workDaysOfWeek: [
                    document.getElementById('editWorkDay_0')?.checked === true,
                    document.getElementById('editWorkDay_1')?.checked === true,
                    document.getElementById('editWorkDay_2')?.checked === true,
                    document.getElementById('editWorkDay_3')?.checked === true,
                    document.getElementById('editWorkDay_4')?.checked === true,
                    document.getElementById('editWorkDay_5')?.checked === true,
                    document.getElementById('editWorkDay_6')?.checked === true
                ],
                paidLeaveCalculation: document.getElementById('editPaidLeaveCalculation').value || 'full'
            };
            
            console.log('📤 إرسال التحديثات إلى Firebase:', updates);

            // تحديث رمز الموظف إذا تغيّر المشروع
            if (updates.project && updates.project !== emp.project) {
                try {
                    const newCode = await generateEmployeeCode(updates.project);
                    if (newCode) {
                        updates.employeeCode = newCode;
                        // تحديث العرض في الفورم فوراً
                        const codeEl = document.getElementById('editEmployeeCode');
                        if (codeEl) codeEl.textContent = newCode;
                        console.log('🔖 تم تحديث رمز الموظف ليتبع المشروع الجديد:', newCode);
                    }
                } catch (e) {
                    console.warn('⚠️ تعذّر توليد رمز جديد بعد تغيير المشروع:', e);
                }
            }
            
            // updateEmployeeInFirebase تستدعي loadEmployeesFromFirebase بداخلها
                await updateEmployeeInFirebase(emp.firebaseId, updates);
            
            closeModal('editModal');
        });
        
        // معالج نموذج إضافة مستخدم جديد
        document.getElementById('addUserForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            const permissionType = document.getElementById('newUserPermissionType').value;
            
            try {
                showLoading();
                
                // 1. إنشاء المستخدم في Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                console.log('✅ User created in Authentication:', user.uid);
                
                // 2. تحديد الصلاحيات
                let permissions = {};
                let fullAccess = false;
                
                if (permissionType === 'full') {
                    fullAccess = true;
                    permissions = {
                        employees: { view: true, add: true, edit: true, delete: true },
                        projects: { view: true, add: true, edit: true, delete: true },
                        users: { view: true, add: true, edit: true, delete: true },
                        reports: { view: true, export: true, print: true },
                        settings: true
                    };
                } else if (permissionType === 'limited') {
                    fullAccess = false;
                    permissions = {
                        employees: { view: true, add: false, edit: false, delete: false },
                        projects: { view: true, add: false, edit: false, delete: false },
                        users: { view: false, add: false, edit: false, delete: false },
                        reports: { view: true, export: false, print: false },
                        settings: false
                    };
                } else if (permissionType === 'custom') {
                    permissions = getPermissions();
                    fullAccess = permissions.users?.add && permissions.users?.edit && permissions.users?.delete;
                }
                
                // 3. حفظ الصلاحيات في Firestore باستخدام UID
                await setDoc(doc(db, 'users', user.uid), {
                    email: email,
                    role: role,
                    fullAccess: fullAccess,
                    permissions: permissions,
                    appVersion: '2.0.9',
                    lastAppUpdate: new Date(),
                    createdAt: new Date().toISOString()
                });
                
                console.log('✅ Permissions saved in Firestore');
                
                hideLoading();
                closeModal('addUserModal');
                document.getElementById('addUserForm').reset();
                
                showNotification('success', 'نجح', `تم إنشاء المستخدم ${email} وربطه بالصلاحيات ✅`);
                
                // إعادة تحميل قائمة المستخدمين
                await loadUsersData();
                
            } catch (error) {
                console.error('❌ Error creating user:', error);
                hideLoading();
                
                let errorMessage = 'فشل إنشاء المستخدم';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'البريد الإلكتروني مستخدم بالفعل';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'كلمة المرور ضعيفة جداً (يجب أن تكون 6 أحرف على الأقل)';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'البريد الإلكتروني غير صالح';
                }
                
                showNotification('error', 'خطأ', errorMessage);
            }
        });
        
        // معالج نموذج ربط مستخدم موجود
        document.getElementById('linkUserForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const uid = document.getElementById('linkUserUID').value.trim();
            const email = document.getElementById('linkUserEmail').value || 'غير محدد';
            const role = document.getElementById('linkUserRole').value;
            const permissionType = document.getElementById('linkUserPermissionType').value;
            
            if (!uid) {
                alert('الرجاء إدخال User UID');
                return;
            }
            
            try {
                showLoading();
                
                // تحديد الصلاحيات
                let permissions = {};
                let fullAccess = false;
                
                if (permissionType === 'full') {
                    fullAccess = true;
                    permissions = {
                        employees: { view: true, add: true, edit: true, delete: true },
                        projects: { view: true, add: true, edit: true, delete: true },
                        users: { view: true, add: true, edit: true, delete: true },
                        reports: { view: true, export: true, print: true },
                        settings: true
                    };
                } else if (permissionType === 'limited') {
                    fullAccess = false;
                    permissions = {
                        employees: { view: true, add: false, edit: false, delete: false },
                        projects: { view: true, add: false, edit: false, delete: false },
                        users: { view: false, add: false, edit: false, delete: false },
                        reports: { view: true, export: false, print: false },
                        settings: false
                    };
                } else if (permissionType === 'custom') {
                    permissions = getLinkPermissions();
                    fullAccess = permissions.users?.add && permissions.users?.edit && permissions.users?.delete;
                }
                
                // حفظ الصلاحيات في Firestore باستخدام UID
                await setDoc(doc(db, 'users', uid), {
                    email: email || 'غير محدد',
                    role: role,
                    fullAccess: fullAccess,
                    permissions: permissions,
                    appVersion: '2.0.9',
                    lastAppUpdate: new Date(),
                    linkedAt: new Date().toISOString()
                });
                
                console.log('✅ User linked with permissions');
                
                hideLoading();
                closeModal('linkUserModal');
                document.getElementById('linkUserForm').reset();
                
                showNotification('success', 'نجح', `تم ربط المستخدم بالصلاحيات ✅`);
                
                // إعادة تحميل قائمة المستخدمين
                await loadUsersData();
                
            } catch (error) {
                console.error('❌ Error linking user:', error);
                hideLoading();
                showNotification('error', t('error'), t('linkUserError') + ': ' + error.message);
            }
        });
        
        document.addEventListener('click', e => {
            if (!e.target.closest('.dropdown')) closeAllDropdowns();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });

        // ========== إدارة المصطلحات المخصصة ==========
        
        // دالة لملء جدول المصطلحات
        function populateTermsTable() {
            const tbody = document.getElementById('termsTableBody');
            if (!tbody) return;
            
            // تحميل المصطلحات المخصصة
            loadCustomTranslations();
            
            tbody.innerHTML = '';
            
            // جمع جميع المفاتيح من الترجمات
            const allKeys = new Set();
            Object.keys(translations.ar).forEach(key => {
                if (typeof translations.ar[key] !== 'object') {
                    allKeys.add(key);
                }
            });
            Object.keys(translations.en).forEach(key => {
                if (typeof translations.en[key] !== 'object') {
                    allKeys.add(key);
                }
            });
            
            // تحويل إلى مصفوفة وترتيبها
            const sortedKeys = Array.from(allKeys).sort();
            
            sortedKeys.forEach(key => {
                const defaultAr = translations.ar[key] || '';
                const defaultEn = translations.en[key] || '';
                const customAr = customTranslations.ar[key] || '';
                const customEn = customTranslations.en[key] || '';
                
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #e2e8f0';
                row.dataset.key = key;
                
                row.innerHTML = `
                    <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: 600; color: #4338ca; background: #f8fafc;">
                        <code style="font-size: 11px;">${key}</code>
                    </td>
                    <td style="padding: 10px; border: 1px solid #e2e8f0; background: #eff6ff; color: #1e40af; direction: rtl; text-align: right; max-width: 250px;">
                        ${defaultAr}
                    </td>
                    <td style="padding: 10px; border: 1px solid #e2e8f0; background: #eff6ff; color: #1e40af; direction: ltr; text-align: left; max-width: 250px;">
                        ${defaultEn}
                    </td>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; background: #f0fdf4;">
                        <input type="text" 
                            data-key="${key}" 
                            data-lang="ar"
                            value="${customAr}" 
                            placeholder="${defaultAr}"
                            style="width: 100%; padding: 8px; border: 2px solid ${customAr ? '#10b981' : '#d1d5db'}; border-radius: 6px; font-size: 12px; direction: rtl; text-align: right;"
                            onchange="updateCustomTerm('${key}', 'ar', this.value)"
                            title="اتركه فارغاً للاحتفاظ بالنص الافتراضي">
                    </td>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; background: #f0fdf4;">
                        <input type="text" 
                            data-key="${key}" 
                            data-lang="en"
                            value="${customEn}" 
                            placeholder="${defaultEn}"
                            style="width: 100%; padding: 8px; border: 2px solid ${customEn ? '#10b981' : '#d1d5db'}; border-radius: 6px; font-size: 12px; direction: ltr; text-align: left;"
                            onchange="updateCustomTerm('${key}', 'en', this.value)"
                            title="Leave empty to keep default text">
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // دالة لتحديث مصطلح مخصص
        function updateCustomTerm(key, lang, value) {
            if (!customTranslations[lang]) {
                customTranslations[lang] = {};
            }
            
            if (value && value.trim() !== '') {
                customTranslations[lang][key] = value.trim();
            } else {
                // إذا كان فارغاً، احذفه (ليستخدم الافتراضي)
                delete customTranslations[lang][key];
            }
            
            // تحديث لون الحد للإشارة إلى وجود تغيير
            const input = document.querySelector(`input[data-key="${key}"][data-lang="${lang}"]`);
            if (input) {
                input.style.borderColor = value && value.trim() !== '' ? '#10b981' : '#d1d5db';
            }
        }
        
        // دالة لحفظ المصطلحات المخصصة
        function saveCustomTerms() {
            // جمع جميع القيم من الحقول
            const inputs = document.querySelectorAll('#termsTableBody input[type="text"]');
            inputs.forEach(input => {
                const key = input.dataset.key;
                const lang = input.dataset.lang;
                const value = input.value.trim();
                updateCustomTerm(key, lang, value);
            });
            
            if (saveCustomTranslations()) {
                showNotification('success', t('success'), 'تم حفظ المصطلحات المخصصة بنجاح!');
                // إعادة ملء الجدول لتحديث الألوان
                setTimeout(() => {
                    populateTermsTable();
                }, 500);
            } else {
                showNotification('error', t('error'), 'فشل حفظ المصطلحات المخصصة');
            }
        }
        
        // دالة لإعادة تعيين جميع المصطلحات المخصصة
        function resetCustomTerms() {
            if (confirm('هل أنت متأكد من إعادة تعيين جميع المصطلحات المخصصة؟ سيتم حذف جميع التخصيصات.')) {
                customTranslations = { ar: {}, en: {} };
                saveCustomTranslations();
                populateTermsTable();
                showNotification('success', t('success'), 'تم إعادة تعيين جميع المصطلحات');
            }
        }
        
        // دالة لفلترة جدول المصطلحات
        function filterTermsTable(searchText) {
            const rows = document.querySelectorAll('#termsTableBody tr');
            const search = searchText.toLowerCase();
            
            rows.forEach(row => {
                const key = row.dataset.key.toLowerCase();
                const defaultAr = row.cells[1]?.textContent.toLowerCase() || '';
                const defaultEn = row.cells[2]?.textContent.toLowerCase() || '';
                const customAr = row.cells[3]?.querySelector('input')?.value.toLowerCase() || '';
                const customEn = row.cells[4]?.querySelector('input')?.value.toLowerCase() || '';
                
                if (search === '' || 
                    key.includes(search) || 
                    defaultAr.includes(search) || 
                    defaultEn.includes(search) ||
                    customAr.includes(search) ||
                    customEn.includes(search)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // ========== دالة تحديث البيانات القديمة ==========
        
        /**
         * دالة تحديث البيانات القديمة لمعالجة المشاكل التالية:
         * 1. البيانات التي لا تحتوي على month و year
         * 2. البيانات القديمة قبل إضافة نظام الحجوزات
         * 3. تحديث previousReservedAmount بناءً على الحجز التراكمي الفعلي
         */
        async function updateOldEmployeeData() {
            try {
                showLoading();
                console.log('🔄 بدء تحديث البيانات القديمة...');
                
                const employeesRef = collection(db, 'employees');
                const snapshot = await getDocs(employeesRef);
                
                let updatedCount = 0;
                let skippedCount = 0;
                const months = ['january', 'february', 'march', 'april', 'may', 'june', 
                              'july', 'august', 'september', 'october', 'november', 'december'];
                
                console.log(`📊 إجمالي الموظفين: ${snapshot.size}`);
                
                // تجميع الموظفين حسب firebaseId
                const employeesByFirebaseId = {};
                
                snapshot.forEach(docSnapshot => {
                    const data = docSnapshot.data();
                    const firebaseId = docSnapshot.id;
                    
                    if (!employeesByFirebaseId[firebaseId]) {
                        employeesByFirebaseId[firebaseId] = [];
                    }
                    
                    employeesByFirebaseId[firebaseId].push({
                        id: firebaseId,
                        data: data,
                        docSnapshot: docSnapshot
                    });
                });
                
                console.log(`📦 عدد الموظفين الفريدين: ${Object.keys(employeesByFirebaseId).length}`);
                
                // تحديث كل موظف
                for (const firebaseId of Object.keys(employeesByFirebaseId)) {
                    const employeeEntries = employeesByFirebaseId[firebaseId];
                    
                    for (const entry of employeeEntries) {
                        const data = entry.data;
                        const docRef = doc(db, 'employees', entry.id);
                        let needsUpdate = false;
                        const updates = {};
                        
                        // 1. التحقق من وجود month و year
                        if (!data.month || !data.year) {
                            // محاولة استنتاج الشهر والسنة من updatedAt أو createdAt
                            let inferredMonth = 'august';
                            let inferredYear = currentYear;
                            
                            if (data.updatedAt) {
                                const date = new Date(data.updatedAt);
                                const monthIndex = date.getMonth();
                                inferredMonth = months[monthIndex];
                                inferredYear = date.getFullYear().toString();
                            } else if (data.createdAt) {
                                const date = new Date(data.createdAt);
                                const monthIndex = date.getMonth();
                                inferredMonth = months[monthIndex];
                                inferredYear = date.getFullYear().toString();
                            }
                            
                            updates.month = inferredMonth;
                            updates.year = inferredYear;
                            needsUpdate = true;
                            
                            console.log(`  📅 إضافة month/year للموظف ${data.nameAr || entry.id}: ${inferredMonth} ${inferredYear}`);
                        }
                        
                        // 2. تحديث previousReservedAmount بناءً على الحجز التراكمي
                        if (data.salaryReservationEnabled && data.month && data.year) {
                            // حساب الحجز التراكمي من جميع السجلات السابقة لهذا الموظف
                            let accumulatedReservation = 0;
                            const currentMonthIndex = months.indexOf(data.month);
                            const currentYearInt = parseInt(data.year);
                            
                            for (const otherEntry of employeeEntries) {
                                const otherData = otherEntry.data;
                                if (!otherData.month || !otherData.year) continue;
                                
                                const otherMonthIndex = months.indexOf(otherData.month);
                                const otherYearInt = parseInt(otherData.year);
                                
                                // تخطي الشهر الحالي والأشهر اللاحقة
                                if (otherYearInt > currentYearInt || 
                                    (otherYearInt === currentYearInt && otherMonthIndex >= currentMonthIndex)) {
                                    continue;
                                }
                                
                                if (otherData.salaryReservationEnabled) {
                                    const reserved = parseFloat(otherData.reservedAmount) || 0;
                                    if (reserved > 0) {
                                        accumulatedReservation += reserved;
                                    }
                                }
                            }
                            
                            // تحديث previousReservedAmount إذا كان مختلفاً
                            const currentPrevious = parseFloat(data.previousReservedAmount) || 0;
                            if (Math.abs(accumulatedReservation - currentPrevious) > 0.01) {
                                updates.previousReservedAmount = accumulatedReservation;
                                needsUpdate = true;
                                
                                console.log(`  💰 تحديث previousReservedAmount للموظف ${data.nameAr || entry.id}: ${currentPrevious.toFixed(2)} → ${accumulatedReservation.toFixed(2)}`);
                            }
                        }
                        
                        // 3. التأكد من وجود targetReservedAmount إذا كان الحجز مفعلاً
                        if (data.salaryReservationEnabled && (!data.targetReservedAmount || data.targetReservedAmount === 0)) {
                            const basicSalary = parseFloat(data.salary) || 0;
                            if (basicSalary > 0) {
                                updates.targetReservedAmount = basicSalary;
                                needsUpdate = true;
                                
                                console.log(`  🎯 إضافة targetReservedAmount للموظف ${data.nameAr || entry.id}: ${basicSalary.toFixed(2)}`);
                            }
                        }
                        
                        // 4. تحديث البيانات في Firebase
                        if (needsUpdate) {
                            updates.updatedAt = new Date().toISOString();
                            updates.dataUpdated = true; // علامة أن البيانات تم تحديثها
                            
                            await updateDoc(docRef, updates);
                            updatedCount++;
                            
                            console.log(`  ✅ تم تحديث الموظف ${data.nameAr || entry.id}`);
                        } else {
                            skippedCount++;
                        }
                    }
                }
                
                hideLoading();
                console.log(`✅ اكتمل التحديث!`);
                console.log(`  📊 تم تحديث: ${updatedCount} سجل`);
                console.log(`  ⏭️ تم تخطي: ${skippedCount} سجل`);
                
                showNotification('success', 'نجح', `تم تحديث ${updatedCount} سجل بنجاح! ✅`);
                
                // إعادة تحميل البيانات
                await loadEmployeesFromFirebase();
                
            } catch (error) {
                console.error('❌ خطأ في تحديث البيانات القديمة:', error);
                hideLoading();
                showNotification('error', 'خطأ', 'حدث خطأ في تحديث البيانات: ' + error.message);
            }
        }
        
        // دالة تهيئة شاملة لبيانات الحجز للبيانات القديمة
        function initializeReservationDataForOldEmployees() {
            console.log('🔄 تهيئة بيانات الحجز للبيانات القديمة...');
            
            const globalReservationEnabled = companySettings.globalReservationEnabled || false;
            const globalReservationType = companySettings.globalReservationType || 'percentage';
            const globalReservationPercentage = companySettings.globalReservationPercentage || 10;
            const globalReservationAmount = companySettings.globalReservationAmount || 0;
            
            let initializedCount = 0;
            let calculatedCount = 0;
            
            // المرور على جميع السنوات والأشهر
            for (const year of Object.keys(employeeData)) {
                const yearData = employeeData[year];
                if (!yearData) continue;
                
                for (const month of months) {
                    const monthData = yearData[month];
                    if (!monthData || monthData.length === 0) continue;
                    
                    monthData.forEach(emp => {
                        let needsUpdate = false;
                        
                        // تهيئة salaryReservationEnabled
                        if (emp.salaryReservationEnabled === undefined) {
                            emp.salaryReservationEnabled = globalReservationEnabled;
                            needsUpdate = true;
                        }
                        
                        // تهيئة reservationPercentage
                        if (!emp.reservationPercentage || emp.reservationPercentage === 0) {
                            if (globalReservationEnabled) {
                                if (globalReservationType === 'percentage') {
                                    emp.reservationPercentage = globalReservationPercentage;
                                } else {
                                    // سيتم حساب النسبة من الراتب الصافي لاحقاً
                                    emp.reservationPercentage = 0;
                                }
                                needsUpdate = true;
                            } else {
                                emp.reservationPercentage = emp.reservationPercentage || 10;
                            }
                        }
                        
                        // تهيئة previousReservedAmount
                        if (emp.previousReservedAmount === undefined) {
                            emp.previousReservedAmount = 0;
                            needsUpdate = true;
                        }
                        
                        // حساب reservedAmount إذا كان الحجز مفعلاً والمبلغ = 0 أو غير محدد
                        const isReservationEnabled = emp.salaryReservationEnabled !== undefined ? 
                            emp.salaryReservationEnabled : 
                            globalReservationEnabled;
                        
                        // إذا كان الحجز مفعلاً (محلياً أو عاماً) والمبلغ = 0 أو غير محدد، نحسبه
                        if (isReservationEnabled && (emp.reservedAmount === undefined || emp.reservedAmount === 0)) {
                            try {
                                // حساب الراتب الصافي
                                const netBeforeReservation = calculateActualSalary(emp, month, year);
                                const netInPaymentCurrency = convertToPaymentCurrency(netBeforeReservation, 'USD', emp);
                                const bonus = convertToPaymentCurrency(emp.bonus || 0, emp.bonusCurrency || 'IQD', emp);
                                const phoneBills = convertToPaymentCurrency(emp.phoneBills || 0, emp.phoneBillsCurrency || 'IQD', emp);
                                const ceoBonus = convertToPaymentCurrency(emp.ceoBonus || 0, emp.ceoBonusCurrency || 'IQD', emp);
                                const deductions = convertToPaymentCurrency(emp.deductions || 0, emp.deductionsCurrency || 'IQD', emp);
                                const advance = convertToPaymentCurrency(emp.advance || 0, emp.advanceCurrency || 'IQD', emp);
                                const netSalary = netInPaymentCurrency + bonus + phoneBills + ceoBonus - deductions - advance;
                                
                                // حساب الحجز (لا نستخدم month و year هنا لأننا نريد حساب الحجز فقط لهذا الشهر)
                                // لكن نحتاج إلى حساب الحجز التراكمي من الأشهر السابقة
                                const reservation = calculateReservation(emp, netSalary, month, year);
                                if (reservation.actual > 0) {
                                    emp.reservedAmount = reservation.actual;
                                    calculatedCount++;
                                    needsUpdate = true;
                                    console.log(`  💰 تم حساب الحجز للموظف ${emp.nameAr || emp.employeeCode} في ${month} ${year}: ${reservation.actual.toFixed(2)}`);
                                }
                            } catch (error) {
                                console.warn(`⚠️ خطأ في حساب الحجز للموظف ${emp.nameAr || emp.employeeCode}:`, error);
                            }
                        } else if (emp.reservedAmount === undefined) {
                            emp.reservedAmount = 0;
                            needsUpdate = true;
                        }
                        
                        // تهيئة targetReservedAmount
                        if (!emp.targetReservedAmount || emp.targetReservedAmount === 0) {
                            emp.targetReservedAmount = calculateTargetReservation(emp);
                            needsUpdate = true;
                        }
                        
                        // تهيئة reservationCurrency
                        if (!emp.reservationCurrency) {
                            emp.reservationCurrency = emp.paymentCurrency || 'IQD';
                            needsUpdate = true;
                        }
                        
                        if (needsUpdate) {
                            initializedCount++;
                        }
                    });
                }
            }
            
            console.log(`✅ تم تهيئة ${initializedCount} موظف، تم حساب الحجز لـ ${calculatedCount} موظف`);
            return initializedCount;
        }
        
        // جعل الدالة متاحة عالمياً
        // يمكن استدعاؤها من console: updateOldEmployeeData()
        // أو من أي مكان في الكود
        window.updateOldEmployeeData = updateOldEmployeeData;
        window.initializeReservationDataForOldEmployees = initializeReservationDataForOldEmployees;
        
        // ملاحظة: يمكن استدعاء هذه الدالة مرة واحدة لتحديث جميع البيانات القديمة
        // بعد ذلك، سيتم تحديث البيانات تلقائياً عند الحفظ
        
        // جعل الدوال متاحة عالمياً
        window.saveCustomTerms = saveCustomTerms;
        window.resetCustomTerms = resetCustomTerms;
        window.updateCustomTerm = updateCustomTerm;
        window.filterTermsTable = filterTermsTable;
        window.populateTermsTable = populateTermsTable;

        // ========== Start Application ==========
        console.log(`
╔═══════════════════════════════════════╗
║   نظام إدارة الرواتب المطور          ║
║   Enhanced Salary System              ║
╠═══════════════════════════════════════╣
║   Version: 2.0.0 Complete             ║
║   Firebase: Connected ✓               ║
║   Authentication: Active              ║
║   Appearance Control: Active          ║
║   Filters: Fixed ✓                    ║
║   Status: Ready                       ║
╚═══════════════════════════════════════╝
        `);

        // checkSavedUser() - تم استبدالها بـ onAuthStateChanged
    </script>
</body>
</html>