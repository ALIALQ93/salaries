<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù | Attendance System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'cairo': ['Cairo', 'sans-serif'],
                        'inter': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Base Styles */
        * {
            font-variant-numeric: lining-nums;
            -moz-font-feature-settings: "lnum" 1;
            -webkit-font-feature-settings: "lnum" 1;
            font-feature-settings: "lnum" 1;
        }
        
        [dir="rtl"] body {
            font-family: 'Cairo', sans-serif;
        }
        
        [dir="ltr"] body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Loading Animation */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Sidebar */
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        
        .sidebar-item {
            transition: all 0.2s ease;
        }
        
        .sidebar-item:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .sidebar-item.active {
            background-color: rgba(59, 130, 246, 0.15);
            border-right: 3px solid #3b82f6;
        }
        
        [dir="ltr"] .sidebar-item.active {
            border-right: none;
            border-left: 3px solid #3b82f6;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: box-shadow 0.2s ease;
        }
        
        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        /* Status Colors */
        .status-active { color: #10b981; }
        .status-paused { color: #f59e0b; }
        .status-completed { color: #3b82f6; }
        .status-hidden { color: #6b7280; }
        
        .bg-status-active { background-color: #10b981; }
        .bg-status-paused { background-color: #f59e0b; }
        .bg-status-completed { background-color: #3b82f6; }
        .bg-status-hidden { background-color: #6b7280; }
        
        /* Attendance Colors */
        .att-full { background-color: #10b981; }
        .att-partial { background-color: #f59e0b; }
        .att-absent { background-color: #ef4444; }
        .att-excused { background-color: #f97316; }
        .att-annual { background-color: #3b82f6; }
        .att-sick { background-color: #8b5cf6; }
        .att-emergency { background-color: #ec4899; }
        .att-unpaid { background-color: #9ca3af; }
        .att-holiday { background-color: #e5e7eb; }
        .att-mission { background-color: #06b6d4; }
        
        /* Table Styles */
        .attendance-table {
            border-collapse: separate;
            border-spacing: 2px;
        }
        
        .attendance-table th,
        .attendance-table td {
            padding: 8px;
            text-align: center;
            min-width: 45px;
        }
        
        .attendance-cell {
            cursor: pointer;
            border-radius: 6px;
            transition: transform 0.1s ease;
        }
        
        .attendance-cell:hover {
            transform: scale(1.1);
        }
        
        /* ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ¸Ù - Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø­Ø«ÙŠØ© */
        .report-employee-combobox { position: relative; }
        .report-employee-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 280px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 50;
            margin-top: 2px;
        }
        .report-employee-dropdown .dropdown-group { padding: 6px 0; }
        .report-employee-dropdown .dropdown-group-title {
            padding: 4px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
        .report-employee-dropdown .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.15s;
        }
        .report-employee-dropdown .dropdown-item:hover { background: #eff6ff; }
        .report-employee-dropdown .dropdown-item.no-results { color: #9ca3af; cursor: default; }

        /* Dropdown */
        .dropdown-content {
            display: none;
            position: absolute;
            background: white;
            min-width: 200px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border-radius: 8px;
            z-index: 1000;
        }
        
        .dropdown:hover .dropdown-content,
        .dropdown-content.show {
            display: block;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content.max-w-5xl {
            max-width: 64rem;
            width: 95%;
        }
        
        .modal-content.max-w-6xl {
            max-width: 72rem;
            width: 95%;
        }
        
        .modal-content.max-w-7xl {
            max-width: 80rem;
            width: 95%;
        }
        
        @media (max-width: 1024px) {
            .modal-content.max-w-7xl,
            .modal-content.max-w-6xl,
            .modal-content.max-w-5xl {
                width: 98%;
                max-width: 98%;
            }
        }
        
        /* Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± */
        @page {
            size: A4 landscape;
            margin: 10mm;
        }
        @media print {
            header, #sidebar, #sidebar-overlay {
                display: none !important;
            }
            main {
                margin: 0 !important;
                padding: 0 !important;
            }
            main .p-6 {
                padding: 0 !important;
            }
            .no-print-stats {
                display: none !important;
            }
            #report-forms {
                display: none !important;
            }
            #report-results {
                width: 100% !important;
                max-width: 100% !important;
            }
            #report-results .card {
                box-shadow: none !important;
                border: 1px solid #e5e7eb !important;
                padding: 8mm !important;
            }
            #report-results table {
                font-size: 0.7rem !important;
            }
            #report-results th, #report-results td {
                padding: 3px 4px !important;
            }
            .no-print {
                display: none !important;
            }
        }
        
        /* Notifications Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            z-index: 10000;
            animation: slideUp 0.3s ease;
        }
        
        .toast-success { background: #10b981; }
        .toast-error { background: #ef4444; }
        .toast-warning { background: #f59e0b; }
        .toast-info { background: #3b82f6; }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        
        /* Hide scrollbar but keep functionality */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Tabs */
        .tab-btn {
            padding: 10px 20px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .tab-btn.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="loading-screen" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
        <div class="loader mb-4"></div>
        <p id="loading-text" class="text-gray-600">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>
    
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="login-screen" class="hidden fixed inset-0 bg-gradient-to-br from-primary-500 to-primary-700 flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                    </svg>
                </div>
                <h1 id="login-title" class="text-2xl font-bold text-gray-800">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</h1>
                <p id="login-subtitle" class="text-gray-500 mt-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label id="email-label" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="login-email" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition"
                           placeholder="example@email.com">
                </div>
                
                <div>
                    <label id="password-label" class="block text-sm font-medium text-gray-700 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <div class="relative">
                        <input type="password" id="login-password" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition"
                               placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        <button type="button" onclick="togglePasswordVisibility()" 
                                class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            <svg id="eye-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div id="login-error" class="hidden text-red-500 text-sm text-center"></div>
                
                <button type="submit" id="login-btn"
                        class="w-full bg-primary-600 text-white py-3 rounded-lg font-medium hover:bg-primary-700 transition flex items-center justify-center gap-2">
                    <span id="login-btn-text">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
                    <svg id="login-spinner" class="hidden animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </form>
            
            <!-- Language Toggle -->
            <div class="mt-6 text-center">
                <button onclick="toggleLanguage()" class="text-sm text-gray-500 hover:text-primary-600 transition">
                    <span id="lang-toggle-text">English</span> ğŸŒ
                </button>
            </div>
        </div>
    </div>
    
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="app" class="hidden">
        
        <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <header class="bg-white shadow-sm fixed top-0 left-0 right-0 z-40 h-16">
            <div class="flex items-center justify-between h-full px-4">
                <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù† -->
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-lg lg:hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <h1 id="page-title" class="text-xl font-bold text-gray-800">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
                </div>
                
                <!-- Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
                <div class="flex items-center gap-4">
                    <!-- ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ© -->
                    <button onclick="toggleLanguage()" class="p-2 hover:bg-gray-100 rounded-lg text-sm font-medium text-gray-600">
                        ğŸŒ <span id="current-lang">AR</span>
                    </button>
                    
                    <!-- Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
                    <div class="relative dropdown">
                        <button onclick="toggleNotifications()" class="p-2 hover:bg-gray-100 rounded-lg relative">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                            </svg>
                            <span id="notification-count" class="notification-badge hidden">0</span>
                        </button>
                        
                        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
                        <div id="notifications-dropdown" class="dropdown-content left-0 mt-2 w-80">
                            <div class="p-4 border-b">
                                <h3 id="notifications-title" class="font-bold">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
                            </div>
                            <div id="notifications-list" class="max-h-96 overflow-y-auto">
                                <p class="p-4 text-gray-500 text-center" id="no-notifications">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
                    <div class="relative dropdown">
                        <button onclick="toggleUserMenu()" class="flex items-center gap-2 p-2 hover:bg-gray-100 rounded-lg">
                            <div class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center">
                                <span id="user-avatar" class="text-primary-600 font-bold text-sm">Ù…</span>
                            </div>
                            <span id="user-name" class="hidden md:block text-sm font-medium text-gray-700">Ø§Ù„Ù…Ø¯ÙŠØ±</span>
                        </button>
                        
                        <div id="user-dropdown" class="dropdown-content left-0 mt-2 w-48">
                            <a href="#" onclick="showPage('settings')" class="block px-4 py-2 hover:bg-gray-100" data-translate="settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
                            <hr class="my-1">
                            <a href="#" onclick="logout()" class="block px-4 py-2 hover:bg-gray-100 text-red-600" data-translate="logout">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
        <aside id="sidebar" class="sidebar fixed top-16 right-0 h-[calc(100vh-4rem)] w-64 bg-white shadow-lg z-30 transform lg:translate-x-0 translate-x-full">
            <nav class="p-4 space-y-2">
                <a href="#" onclick="showPage('dashboard')" class="sidebar-item active flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-page="dashboard">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    <span data-translate="dashboard">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                </a>
                
                <a href="#" onclick="showPage('projects')" class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-page="projects">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                    <span data-translate="projects">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</span>
                </a>
                
                <a href="#" onclick="showPage('employees')" class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-page="employees">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <span data-translate="employees">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span>
                </a>
                
                <a href="#" onclick="showPage('vehicles')" class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-page="vehicles">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                    </svg>
                    <span data-translate="vehicles">Ø§Ù„Ø¢Ù„ÙŠØ§Øª</span>
                </a>
                
                <a href="#" onclick="showPage('attendance')" class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-page="attendance">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                    <span data-translate="attendance">Ø§Ù„Ø­Ø¶ÙˆØ±</span>
                </a>
                
                <a href="#" onclick="showPage('reports')" class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-page="reports">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span data-translate="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
                </a>
                
                <hr class="my-4">
                
                <!-- Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø· -->
                <div id="manager-menu" class="hidden">
                    <a href="#" onclick="showPage('users')" class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-page="users">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span data-translate="users">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                    </a>
                    <a href="#" onclick="showPage('activityLog')" class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-page="activityLog">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2v12m-6 0h6"></path>
                        </svg>
                        <span data-translate="activityLog">Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</span>
                    </a>
                    <a href="#" onclick="showPage('monthlyWageManagement')" class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-page="monthlyWageManagement">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span data-translate="monthlyWageManagement">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¬ÙˆØ± Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</span>
                    </a>
                </div>
                
                <a href="#" onclick="showPage('settings')" class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-page="settings">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span data-translate="settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
                </a>
            </nav>
        </aside>
        
        <!-- Overlay Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
        <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-20 lg:hidden" onclick="toggleSidebar()"></div>
        
        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <main class="lg:mr-64 pt-16 min-h-screen">
            <div class="p-6">
                <!-- ØµÙØ­Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
                <div id="page-dashboard" class="page-content">
                    <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </div>
                
                <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ -->
                <div id="page-projects" class="page-content hidden">
                    <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </div>
                
                <!-- ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
                <div id="page-employees" class="page-content hidden">
                    <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </div>
                
                <!-- ØµÙØ­Ø© Ø§Ù„Ø¢Ù„ÙŠØ§Øª -->
                <div id="page-vehicles" class="page-content hidden">
                    <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </div>
                
                <!-- ØµÙØ­Ø© Ø§Ù„Ø­Ø¶ÙˆØ± -->
                <div id="page-attendance" class="page-content hidden">
                    <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </div>
                
                <!-- ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
                <div id="page-reports" class="page-content hidden">
                    <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </div>
                
                <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
                <div id="page-activityLog" class="page-content hidden"></div>
                <div id="page-monthlyWageManagement" class="page-content hidden"></div>
                <div id="page-users" class="page-content hidden">
                    <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </div>
                
                <!-- ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
                <div id="page-settings" class="page-content hidden">
                    <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </div>
            </div>
        </main>
    </div>
    
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    
    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¹Ø§Ù… -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div id="modal-header" class="p-4 border-b flex items-center justify-between">
                <h3 id="modal-title" class="font-bold text-lg"></h3>
                <button onclick="closeModal()" class="p-1 hover:bg-gray-100 rounded">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="modal-body" class="p-4">
                <!-- Ù…Ø­ØªÙˆÙ‰ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ -->
            </div>
            <div id="modal-footer" class="p-4 border-t flex justify-end gap-2">
                <!-- Ø£Ø²Ø±Ø§Ø± Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© -->
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const firebaseConfig = {
        apiKey: "AIzaSyC8lUM1L9rEuPdyCA3ZHKJwl9kREteWceo",
        authDomain: "attendance-system-d1693.firebaseapp.com",
        projectId: "attendance-system-d1693",
        storageBucket: "attendance-system-d1693.firebasestorage.app",
        messagingSenderId: "200965722574",
        appId: "1:200965722574:web:dd32206ea8a702e6071b9f",
        measurementId: "G-KSLB8Q5TJS"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let currentUser = null;
    let currentUserData = null;
    let currentLanguage = localStorage.getItem('language') || 'ar';
    let currentPage = 'dashboard';

    // Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    const DEFAULT_ADMIN = {
        email: "ali.alqadre93@gmail.com",
        password: "Am9875321",
        name: "Ø§Ù„Ù…Ø¯ÙŠØ±",
        nameEn: "Admin",
        role: "manager"
    };

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø· (Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ§Øª)
    async function logActivity(action, entityType, entityId, entityLabel, details) {
        const user = auth.currentUser;
        if (!user) return;
        const userName = (typeof currentUserData !== 'undefined' && currentUserData?.name) ? currentUserData.name : (user.email || user.uid);
        try {
            await db.collection('activityLog').add({
                userId: user.uid,
                userName: userName,
                action: action,
                entityType: entityType,
                entityId: entityId || '',
                entityLabel: entityLabel || '',
                details: details || '',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (e) {
            console.error('logActivity error:', e);
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const translations = {
        ar: {
            // Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
            dashboard: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
            projects: "Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹",
            employees: "Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
            vehicles: "Ø§Ù„Ø¢Ù„ÙŠØ§Øª",
            attendance: "Ø§Ù„Ø­Ø¶ÙˆØ±",
            reports: "Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±",
            users: "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†",
            settings: "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
            logout: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            loginTitle: "Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù",
            loginSubtitle: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©",
            email: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
            password: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
            login: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
            loginError: "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
            
            // Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            save: "Ø­ÙØ¸",
            cancel: "Ø¥Ù„ØºØ§Ø¡",
            add: "Ø¥Ø¶Ø§ÙØ©",
            edit: "ØªØ¹Ø¯ÙŠÙ„",
            delete: "Ø­Ø°Ù",
            view: "Ø¹Ø±Ø¶",
            search: "Ø¨Ø­Ø«",
            filter: "ØªØµÙÙŠØ©",
            export: "ØªØµØ¯ÙŠØ±",
            print: "Ø·Ø¨Ø§Ø¹Ø©",
            close: "Ø¥ØºÙ„Ø§Ù‚",
            confirm: "ØªØ£ÙƒÙŠØ¯",
            back: "Ø±Ø¬ÙˆØ¹",
            
            // Ø§Ù„Ø­Ø§Ù„Ø§Øª
            active: "Ù†Ø´Ø·",
            inactive: "Ù…ØªÙˆÙ‚Ù",
            completed: "Ù…Ù†ØªÙ‡ÙŠ",
            hidden: "Ù…Ø®ÙÙŠ",
            
            // Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
            projectName: "Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",
            projectCode: "Ø±Ù…Ø² Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",
            contractNumber: "Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯",
            address: "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†",
            description: "Ø§Ù„ÙˆØµÙ",
            addProject: "Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹",
            editProject: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",
            noProjects: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹",
            
            // Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
            employeeName: "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù",
            employeeCode: "Ø±Ù…Ø² Ø§Ù„Ù…ÙˆØ¸Ù",
            employeeType: "Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ¸Ù",
            daily: "ÙŠÙˆÙ…ÙŠ",
            monthly: "Ø´Ù‡Ø±ÙŠ",
            phone: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ",
            jobTitle: "Ø§Ù„Ù…Ù‡Ù†Ø©/Ø§Ù„Ù…Ù†ØµØ¨",
            position: "Ø§Ù„Ù…Ù†ØµØ¨",
            profession: "Ø§Ù„Ù…Ù‡Ù†Ø©",
            positionPlaceholder: "Ù…Ø«Ø§Ù„: Ù…Ø¯ÙŠØ± Ù…Ø´Ø±ÙˆØ¹ØŒ Ù…Ø­Ø§Ø³Ø¨...",
            professionPlaceholder: "Ù…Ø«Ø§Ù„: Ø­Ø¯Ø§Ø¯ØŒ Ù†Ø¬Ø§Ø±ØŒ ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ...",
            workStart: "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…",
            workEnd: "Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…",
            addEmployee: "Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù",
            editEmployee: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù",
            noEmployees: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ†",
            employeeNameExists: "ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸Ù Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…",
            cannotDeleteEmployeeWithAttendance: "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù…ÙˆØ¸Ù Ù„Ø¯ÙŠÙ‡ Ø³Ø¬Ù„Ø§Øª Ø­Ø¶ÙˆØ±",
            
            // Ø§Ù„Ø¢Ù„ÙŠØ§Øª
            vehicleName: "Ø§Ø³Ù… Ø§Ù„Ø¢Ù„ÙŠØ©",
            vehicleCode: "Ø±Ù…Ø² Ø§Ù„Ø¢Ù„ÙŠØ©",
            vehicleType: "Ù†ÙˆØ¹ Ø§Ù„Ø¢Ù„ÙŠØ©",
            ownership: "Ø§Ù„Ù…Ù„ÙƒÙŠØ©",
            owned: "Ù…Ù…Ù„ÙˆÙƒØ©",
            rented: "Ù…Ø³ØªØ£Ø¬Ø±Ø©",
            plateNumber: "Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©",
            internalNumber: "Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ",
            driver: "Ø§Ù„Ø³Ø§Ø¦Ù‚",
            rentalCompany: "Ø¬Ù‡Ø© Ø§Ù„ØªØ£Ø¬ÙŠØ±",
            addVehicle: "Ø¥Ø¶Ø§ÙØ© Ø¢Ù„ÙŠØ©",
            editVehicle: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¢Ù„ÙŠØ©",
            noVehicles: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¢Ù„ÙŠØ§Øª",
            
            // Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¢Ù„ÙŠØ§Øª
            truck: "Ø´Ø§Ø­Ù†Ø©",
            crane: "Ø±Ø§ÙØ¹Ø©",
            excavator: "Ø­ÙØ§Ø±Ø©",
            mixer: "Ø®Ù„Ø§Ø·Ø©",
            pickup: "Ø³ÙŠØ§Ø±Ø© Ù†Ù‚Ù„",
            car: "Ø³ÙŠØ§Ø±Ø©",
            heavy: "Ù…Ø¹Ø¯Ø§Øª Ø«Ù‚ÙŠÙ„Ø©",
            other: "Ø£Ø®Ø±Ù‰",
            
            // Ø§Ù„Ø­Ø¶ÙˆØ±
            fullDay: "ÙŠÙˆÙ… ÙƒØ§Ù…Ù„",
            actualAttendance: "Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙØ¹Ù„ÙŠ",
            partialDays: "Ø£ÙŠØ§Ù… Ø¬Ø²Ø¦ÙŠØ© (Ù…Ø¹Ø§Ø¯Ù„Ø©)",
            reportEmployeeType: "Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
            equivalentDays: "Ø£ÙŠØ§Ù… Ù…Ø¹Ø§Ø¯Ù„Ø©",
            excusedAttendance: "Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¤Ø¬ÙˆØ±",
            unexcusedAttendance: "Ø§Ù„Ø­Ø¶ÙˆØ± ØºÙŠØ± Ø§Ù„Ù…Ø¤Ø¬ÙˆØ±",
            daysInPeriod: "Ø£ÙŠØ§Ù… Ø§Ù„ÙØªØ±Ø©",
            actualAttendanceNote: "Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¤Ø¬ÙˆØ± = ÙŠÙˆÙ… ÙƒØ§Ù…Ù„ + Ø£ÙŠØ§Ù… Ù…Ø¹Ø§Ø¯Ù„Ø© (Ø§Ù„Ø¬Ø²Ø¦ÙŠ). Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¤Ø¬ÙˆØ± + Ø§Ù„Ø­Ø¶ÙˆØ± ØºÙŠØ± Ø§Ù„Ù…Ø¤Ø¬ÙˆØ± = Ø£ÙŠØ§Ù… Ø§Ù„ÙØªØ±Ø©.",
            partial: "Ø¬Ø²Ø¦ÙŠ",
            absent: "ØºÙŠØ§Ø¨",
            excusedAbsent: "ØºÙŠØ§Ø¨ Ø¨Ø¹Ø°Ø±",
            annualLeave: "Ø¥Ø¬Ø§Ø²Ø© Ø³Ù†ÙˆÙŠØ©",
            sickLeave: "Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ©",
            emergencyLeave: "Ø¥Ø¬Ø§Ø²Ø© Ø·Ø§Ø±Ø¦Ø©",
            unpaidLeave: "Ø¥Ø¬Ø§Ø²Ø© Ø¨Ø¯ÙˆÙ† Ø±Ø§ØªØ¨",
            periodicLeave: "Ø¥Ø¬Ø§Ø²Ø© Ø¯ÙˆØ±ÙŠØ©",
            officialHoliday: "Ø¹Ø·Ù„Ø© Ø±Ø³Ù…ÙŠØ©",
            onMission: "ÙÙŠ Ù…Ù‡Ù…Ø©",
            lateArrival: "ØªØ£Ø®Ø± ÙÙŠ Ø§Ù„Ø­Ø¶ÙˆØ±",
            earlyLeave: "Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ±",
            breakOut: "ØºØ§Ø¯Ø± ÙˆØ¹Ø§Ø¯",
            partialDetails: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ø¬Ø²Ø¦ÙŠ",
            arrivalTime: "ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±",
            leaveTime: "ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù",
            exitTime: "ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬",
            returnTime: "ÙˆÙ‚Øª Ø§Ù„Ø¹ÙˆØ¯Ø©",
            workHours: "Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„",
            selectStatus: "Ø§Ø®ØªØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¶ÙˆØ±",
            missionDetails: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©",
            internalMission: "Ù…Ù‡Ù…Ø© Ø¯Ø§Ø®Ù„ÙŠØ© (Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¢Ø®Ø±)",
            externalMission: "Ù…Ù‡Ù…Ø© Ø®Ø§Ø±Ø¬ÙŠØ©",
            selectProject: "Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",
            missionLocation: "Ù…ÙˆÙ‚Ø¹/ÙˆØµÙ Ø§Ù„Ù…Ù‡Ù…Ø©",
            missionNotification: "Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø´Ø±Ù Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¶ÙˆØ±",
            selectMissionProject: "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",
            missionAttendanceRequest: "Ø·Ù„Ø¨ ØªØ£ÙƒÙŠØ¯ Ø­Ø¶ÙˆØ± Ù…Ù‡Ù…Ø©",
            confirmMissionAttendance: "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¶ÙˆØ±",
            rejectMissionAttendance: "Ø±ÙØ¶",
            missionFrom: "Ù…Ù† Ù…Ø´Ø±ÙˆØ¹",
            missionConfirmed: "ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¶ÙˆØ±",
            missionRejected: "ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø­Ø¶ÙˆØ±",
            
            // Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ø§Ù„Ø¬Ù…Ù„Ø©
            addMultipleEmployees: "Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø© Ù…ÙˆØ¸ÙÙŠÙ†",
            bulkAddTitle: "Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ø§Ù„Ø¬Ù…Ù„Ø©",
            pasteFromExcel: "Ù„ØµÙ‚ Ù…Ù† Excel",
            pasteInstructions: "Ø§Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Excel (Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù†ÙˆØ¹ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ù…Ù†ØµØ¨/Ø§Ù„Ù…Ù‡Ù†Ø©)",
            pasteDirectlyInCells: "ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù„ØµÙ‚ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø£ÙŠ Ø®Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„",
            addRow: "Ø¥Ø¶Ø§ÙØ© ØµÙ",
            clearAll: "Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„",
            rowNumber: "#",
            typeMonthly: "Ø´Ù‡Ø±ÙŠ",
            typeDaily: "ÙŠÙˆÙ…ÙŠ",
            saveAll: "Ø­ÙØ¸ Ø§Ù„ÙƒÙ„",
            employeesAdded: "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­",
            noDataToSave: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ÙØ¸",
            fillRequiredFields: "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù†ÙˆØ¹)",
            
            // Ø§Ù„Ø¢Ù„ÙŠØ§Øª - Ø­Ø¶ÙˆØ±
            worked: "Ø¹Ù…Ù„Øª",
            workedPartial: "Ø¹Ù…Ù„Øª Ø¬Ø²Ø¦ÙŠ",
            broken: "Ù…Ø¹Ø·Ù„Ø©",
            maintenance: "ØµÙŠØ§Ù†Ø©",
            idle: "Ù„Ù… ØªØ¹Ù…Ù„",
            
            // Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
            today: "Ø§Ù„ÙŠÙˆÙ…",
            week: "Ø£Ø³Ø¨ÙˆØ¹",
            month: "Ø´Ù‡Ø±",
            year: "Ø³Ù†Ø©",
            from: "Ù…Ù†",
            to: "Ø¥Ù„Ù‰",
            date: "Ø§Ù„ØªØ§Ø±ÙŠØ®",
            
            // Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
            saturday: "Ø§Ù„Ø³Ø¨Øª",
            sunday: "Ø§Ù„Ø£Ø­Ø¯",
            monday: "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†",
            tuesday: "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡",
            wednesday: "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡",
            thursday: "Ø§Ù„Ø®Ù…ÙŠØ³",
            friday: "Ø§Ù„Ø¬Ù…Ø¹Ø©",
            sat: "Ø³Ø¨Øª",
            sun: "Ø£Ø­Ø¯",
            mon: "Ø¥Ø«Ù†",
            tue: "Ø«Ù„Ø§",
            wed: "Ø£Ø±Ø¨",
            thu: "Ø®Ù…ÙŠ",
            fri: "Ø¬Ù…Ø¹",
            
            // Ø§Ù„Ø£Ø´Ù‡Ø±
            january: "ÙŠÙ†Ø§ÙŠØ±",
            february: "ÙØ¨Ø±Ø§ÙŠØ±",
            march: "Ù…Ø§Ø±Ø³",
            april: "Ø£Ø¨Ø±ÙŠÙ„",
            may: "Ù…Ø§ÙŠÙˆ",
            june: "ÙŠÙˆÙ†ÙŠÙˆ",
            july: "ÙŠÙˆÙ„ÙŠÙˆ",
            august: "Ø£ØºØ³Ø·Ø³",
            september: "Ø³Ø¨ØªÙ…Ø¨Ø±",
            october: "Ø£ÙƒØªÙˆØ¨Ø±",
            november: "Ù†ÙˆÙÙ…Ø¨Ø±",
            december: "Ø¯ÙŠØ³Ù…Ø¨Ø±",
            
            // Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
            loading: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...",
            saving: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...",
            saved: "ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­",
            deleted: "ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­",
            dataUpdated: "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
            error: "Ø­Ø¯Ø« Ø®Ø·Ø£",
            confirmDelete: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ",
            unsavedChanges: "ÙŠÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©",
            bulkAttendance: "ØªØ³Ø¬ÙŠÙ„ Ø¬Ù…Ø§Ø¹ÙŠ",
            bulkAttendanceTitle: "ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø¬Ù…Ø§Ø¹ÙŠ",
            selectDates: "Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø£Ùˆ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®)",
            applyTo: "Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰",
            applyToAll: "Ø§Ù„ÙƒÙ„",
            applyBulk: "ØªØ·Ø¨ÙŠÙ‚",
            bulkApplied: "ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­",
            specific: "Ù…Ø­Ø¯Ø¯",
            bulkDatesHint: "Ø§Ø®ØªØ± ÙŠÙˆÙ… Ø£Ùˆ Ø£ÙƒØ«Ø± Ù…Ù† Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶",
            bulkStatusHint: "Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡Ø§ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©",
            bulkApplyHint: "ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„ Ø£Ùˆ Ø­Ø¯Ø¯ Ø£Ø³Ù…Ø§Ø¡ Ù…Ø­Ø¯Ø¯Ø©",
            bulkSelectItems: "Ø­Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:",
            noData: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª",
            
            // Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            notifications: "Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª",
            noNotifications: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª",
            missionRequest: "Ø·Ù„Ø¨ Ù…Ù‡Ù…Ø©",
            editRequest: "Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„",
            transferRequest: "Ø·Ù„Ø¨ Ù†Ù‚Ù„",
            attended: "Ø­Ø¶Ø±",
            notAttended: "Ù„Ù… ÙŠØ­Ø¶Ø±",
            approved: "ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©",
            rejected: "ØªÙ… Ø§Ù„Ø±ÙØ¶",
            
            // Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
            projectReport: "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",
            employeeReport: "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ¸Ù",
            attendanceRate: "Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±",
            approvedRecords: "Ø³Ø¬Ù„Ø§Øª Ù…Ø¹ØªÙ…Ø¯Ø©",
            unapprovedRecords: "Ø³Ø¬Ù„Ø§Øª ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯Ø©",
            reportApprovalNote: "Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠØ´Ù…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª. Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ Ù…Ù†Ù‡Ø§ ÙŠÙÙ‚ÙÙ„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ (Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ù…Ø¯ÙŠØ±).",
            totalDays: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙŠØ§Ù…",
            workDays: "Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„",
            absentDays: "Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨",
            leaveDays: "Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©",
            
            // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            userName: "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
            userEmail: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
            userRole: "Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©",
            manager: "Ù…Ø¯ÙŠØ±",
            supervisor: "Ù…Ø´Ø±Ù",
            approver: "Ù…Ø¹ØªÙ…Ø¯",
            approve: "Ø§Ø¹ØªÙ…Ø§Ø¯",
            approveAttendance: "Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ§Ù…",
            approved: "Ù…Ø¹ØªÙ…Ø¯",
            notApproved: "ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯",
            approvedBy: "Ø§Ø¹ØªÙ…Ø¯ Ø¨ÙˆØ§Ø³Ø·Ø©",
            approvedAt: "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯",
            cannotEditAfter24h: "Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù… Ø¨Ø¹Ø¯ Ù…Ø±ÙˆØ± 24 Ø³Ø§Ø¹Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„",
            onlyManagerCanEditApproved: "Ø§Ù„Ø¯ÙˆØ§Ù… Ù…Ø¹ØªÙ…Ø¯. Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·.",
            approveConfirm: "Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¯ÙˆØ§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠØŸ",
            partialApproval: "Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¬Ø²Ø¦ÙŠ",
            unapprove: "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯",
            approvalAction: "Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡",
            approveAction: "Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯",
            unapproveAction: "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ (Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)",
            approvalConfirmApprove: "Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©ØŸ",
            approvalConfirmUnapprove: "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©ØŸ (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)",
            appliedApproval: "ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯",
            appliedUnapprove: "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯",
            assignedProjects: "Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø³Ù†Ø¯Ø©",
            addUser: "Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…",
            editUser: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
            
            // Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
            activeProjects: "Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù†Ø´Ø·Ø©",
            totalEmployees: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
            totalVehicles: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¢Ù„ÙŠØ§Øª",
            todayAttendance: "Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…",
            recentActivities: "Ø¢Ø®Ø± Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª",
            alerts: "ØªÙ†Ø¨ÙŠÙ‡Ø§Øª",
            summary: "Ù…Ù„Ø®Øµ",
            
            // Ø¹Ø§Ù…
            all: "Ø§Ù„ÙƒÙ„",
            select: "Ø§Ø®ØªØ±",
            required: "Ù…Ø·Ù„ÙˆØ¨",
            optional: "Ø§Ø®ØªÙŠØ§Ø±ÙŠ",
            notes: "Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
            status: "Ø§Ù„Ø­Ø§Ù„Ø©",
            actions: "Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª",
            details: "Ø§Ù„ØªÙØ§ØµÙŠÙ„",
            info: "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª",

            // Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·
            activityLog: "Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·",
            activityUser: "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
            activityAction: "Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡",
            activityEntity: "Ø§Ù„Ù†ÙˆØ¹",
            activityTime: "Ø§Ù„ÙˆÙ‚Øª",
            activityDescription: "Ø§Ù„ÙˆØµÙ",
            actionCreate: "Ø¥Ø¶Ø§ÙØ©",
            actionUpdate: "ØªØ¹Ø¯ÙŠÙ„",
            actionDelete: "Ø­Ø°Ù",
            entityProject: "Ù…Ø´Ø±ÙˆØ¹",
            entityEmployee: "Ù…ÙˆØ¸Ù",
            entityVehicle: "Ø¢Ù„ÙŠØ©",
            entityAttendance: "Ø­Ø¶ÙˆØ±",
            entityUser: "Ù…Ø³ØªØ®Ø¯Ù…",
            noActivityYet: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù†Ø´Ø§Ø· Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†",
            dailyWage: "Ø§Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ",
            monthlyWageManagement: "Ø¥Ø¯Ø§Ø±Ø© Ø£Ø¬ÙˆØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠÙŠÙ†",
            currentDailyWage: "Ø§Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ",
            wageHistory: "Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¬ÙˆØ±",
            setMonthlyWage: "ØªØ¹ÙŠÙŠÙ† Ø£Ø¬Ø± Ø´Ù‡Ø±ÙŠ",
            month: "Ø§Ù„Ø´Ù‡Ø±",
            year: "Ø§Ù„Ø³Ù†Ø©",
            wageAmount: "Ù…Ø¨Ù„Øº Ø§Ù„Ø£Ø¬Ø±",
            totalSalary: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø§ØªØ¨",
            salaryCalculation: "Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø§ØªØ¨"
        },
        en: {
            // Menus
            dashboard: "Dashboard",
            projects: "Projects",
            employees: "Employees",
            vehicles: "Vehicles",
            attendance: "Attendance",
            reports: "Reports",
            users: "Users",
            settings: "Settings",
            logout: "Logout",
            
            // Login
            loginTitle: "Attendance System",
            loginSubtitle: "Login to continue",
            email: "Email",
            password: "Password",
            login: "Login",
            loginError: "Invalid email or password",
            
            // Buttons
            save: "Save",
            cancel: "Cancel",
            add: "Add",
            edit: "Edit",
            delete: "Delete",
            view: "View",
            search: "Search",
            filter: "Filter",
            export: "Export",
            print: "Print",
            close: "Close",
            confirm: "Confirm",
            back: "Back",
            
            // Status
            active: "Active",
            inactive: "Inactive",
            completed: "Completed",
            hidden: "Hidden",
            
            // Projects
            projectName: "Project Name",
            projectCode: "Project Code",
            contractNumber: "Contract Number",
            address: "Address",
            description: "Description",
            addProject: "Add Project",
            editProject: "Edit Project",
            noProjects: "No projects",
            
            // Employees
            employeeName: "Employee Name",
            employeeCode: "Employee Code",
            employeeType: "Employee Type",
            daily: "Daily",
            monthly: "Monthly",
            phone: "Phone",
            jobTitle: "Job Title/Position",
            position: "Position",
            profession: "Profession",
            positionPlaceholder: "e.g., Project Manager, Accountant...",
            professionPlaceholder: "e.g., Welder, Carpenter, Electrician...",
            workStart: "Work Start",
            workEnd: "Work End",
            addEmployee: "Add Employee",
            editEmployee: "Edit Employee",
            noEmployees: "No employees",
            employeeNameExists: "An employee with this name already exists in the system",
            cannotDeleteEmployeeWithAttendance: "Cannot delete employee with attendance records",
            
            // Vehicles
            vehicleName: "Vehicle Name",
            vehicleCode: "Vehicle Code",
            vehicleType: "Vehicle Type",
            ownership: "Ownership",
            owned: "Owned",
            rented: "Rented",
            plateNumber: "Plate Number",
            internalNumber: "Internal Number",
            driver: "Driver",
            rentalCompany: "Rental Company",
            addVehicle: "Add Vehicle",
            editVehicle: "Edit Vehicle",
            noVehicles: "No vehicles",
            
            // Vehicle Types
            truck: "Truck",
            crane: "Crane",
            excavator: "Excavator",
            mixer: "Mixer",
            pickup: "Pickup",
            car: "Car",
            heavy: "Heavy Equipment",
            other: "Other",
            
            // Attendance
            fullDay: "Full Day",
            actualAttendance: "Actual Attendance",
            partialDays: "Partial (equivalent days)",
            reportEmployeeType: "Employee Type",
            equivalentDays: "Equivalent days",
            excusedAttendance: "Excused Attendance",
            unexcusedAttendance: "Unexcused Attendance",
            daysInPeriod: "Days in period",
            actualAttendanceNote: "Excused = full day + equivalent days (partial). Excused + Unexcused = days in period.",
            partial: "Partial",
            absent: "Absent",
            excusedAbsent: "Excused Absent",
            annualLeave: "Annual Leave",
            sickLeave: "Sick Leave",
            emergencyLeave: "Emergency Leave",
            unpaidLeave: "Unpaid Leave",
            periodicLeave: "Periodic Leave",
            officialHoliday: "Official Holiday",
            onMission: "On Mission",
            lateArrival: "Late Arrival",
            earlyLeave: "Early Leave",
            breakOut: "Break Out",
            partialDetails: "Partial Attendance Details",
            arrivalTime: "Arrival Time",
            leaveTime: "Leave Time",
            exitTime: "Exit Time",
            returnTime: "Return Time",
            workHours: "Work Hours",
            selectStatus: "Select attendance status",
            missionDetails: "Mission Details",
            internalMission: "Internal Mission (to another project)",
            externalMission: "External Mission",
            selectProject: "Select Project",
            missionLocation: "Mission location/description",
            missionNotification: "A notification will be sent to the supervisor to confirm attendance",
            selectMissionProject: "Please select the project",
            missionAttendanceRequest: "Mission Attendance Confirmation Request",
            confirmMissionAttendance: "Confirm Attendance",
            rejectMissionAttendance: "Reject",
            missionFrom: "From project",
            missionConfirmed: "Attendance confirmed",
            missionRejected: "Attendance rejected",
            
            // Bulk Add Employees
            addMultipleEmployees: "Add Multiple Employees",
            bulkAddTitle: "Bulk Add Employees",
            pasteFromExcel: "Paste from Excel",
            pasteInstructions: "Paste data from Excel (Columns: Name, Type, Phone, Position/Profession)",
            pasteDirectlyInCells: "You can paste directly into any cell in the table",
            addRow: "Add Row",
            clearAll: "Clear All",
            rowNumber: "#",
            typeMonthly: "Monthly",
            typeDaily: "Daily",
            saveAll: "Save All",
            employeesAdded: "Employees added successfully",
            noDataToSave: "No data to save",
            fillRequiredFields: "Please fill required fields (Name and Type)",
            
            // Vehicles - Attendance
            worked: "Worked",
            workedPartial: "Worked Partial",
            broken: "Broken",
            maintenance: "Maintenance",
            idle: "Idle",
            
            // Dates
            today: "Today",
            week: "Week",
            month: "Month",
            year: "Year",
            from: "From",
            to: "To",
            date: "Date",
            
            // Days
            saturday: "Saturday",
            sunday: "Sunday",
            monday: "Monday",
            tuesday: "Tuesday",
            wednesday: "Wednesday",
            thursday: "Thursday",
            friday: "Friday",
            sat: "Sat",
            sun: "Sun",
            mon: "Mon",
            tue: "Tue",
            wed: "Wed",
            thu: "Thu",
            fri: "Fri",
            
            // Months
            january: "January",
            february: "February",
            march: "March",
            april: "April",
            may: "May",
            june: "June",
            july: "July",
            august: "August",
            september: "September",
            october: "October",
            november: "November",
            december: "December",
            
            // Messages
            loading: "Loading...",
            saving: "Saving...",
            saved: "Saved successfully",
            deleted: "Deleted successfully",
            dataUpdated: "Data updated",
            error: "An error occurred",
            confirmDelete: "Are you sure you want to delete?",
            unsavedChanges: "Unsaved changes",
            bulkAttendance: "Bulk Register",
            bulkAttendanceTitle: "Bulk Attendance Register",
            selectDates: "Select date(s)",
            applyTo: "Apply to",
            applyToAll: "All",
            applyBulk: "Apply",
            bulkApplied: "Attendance applied successfully",
            specific: "Specific",
            bulkDatesHint: "Select one or more days from the displayed week",
            bulkStatusHint: "The status to be recorded for all selected dates",
            bulkApplyHint: "Apply to all or select specific names",
            bulkSelectItems: "Select the required names:",
            noData: "No data",
            
            // Notifications
            notifications: "Notifications",
            noNotifications: "No notifications",
            missionRequest: "Mission Request",
            editRequest: "Edit Request",
            transferRequest: "Transfer Request",
            attended: "Attended",
            notAttended: "Not Attended",
            approved: "Approved",
            rejected: "Rejected",
            
            // Reports
            projectReport: "Project Report",
            employeeReport: "Employee Report",
            attendanceRate: "Attendance Rate",
            approvedRecords: "Approved records",
            unapprovedRecords: "Unapproved records",
            reportApprovalNote: "Report includes all records. Approved records are locked for edit (except manager).",
            totalDays: "Total Days",
            workDays: "Work Days",
            absentDays: "Absent Days",
            leaveDays: "Leave Days",
            
            // Users
            userName: "User Name",
            userEmail: "Email",
            userRole: "Role",
            manager: "Manager",
            supervisor: "Supervisor",
            approver: "Approver",
            approve: "Approve",
            approveAttendance: "Approve Attendance",
            approved: "Approved",
            notApproved: "Not Approved",
            approvedBy: "Approved by",
            approvedAt: "Approved at",
            cannotEditAfter24h: "Cannot edit attendance after 24 hours from entry",
            onlyManagerCanEditApproved: "Attendance is approved. Only manager can edit.",
            approveConfirm: "Approve attendance for this week / current project?",
            partialApproval: "Partial Approval",
            unapprove: "Unapprove",
            approvalAction: "Action",
            approveAction: "Approve selected",
            unapproveAction: "Unapprove (manager only)",
            approvalConfirmApprove: "Approve selected records?",
            approvalConfirmUnapprove: "Unapprove selected records? (manager only)",
            appliedApproval: "Approved",
            appliedUnapprove: "Unapproved",
            assignedProjects: "Assigned Projects",
            addUser: "Add User",
            editUser: "Edit User",
            
            // Dashboard
            activeProjects: "Active Projects",
            totalEmployees: "Total Employees",
            totalVehicles: "Total Vehicles",
            todayAttendance: "Today's Attendance",
            recentActivities: "Recent Activities",
            alerts: "Alerts",
            summary: "Summary",
            
            // General
            all: "All",
            select: "Select",
            required: "Required",
            optional: "Optional",
            notes: "Notes",
            status: "Status",
            actions: "Actions",
            details: "Details",
            info: "Info",

            // Activity log
            activityLog: "Activity Log",
            activityUser: "User",
            activityAction: "Action",
            activityEntity: "Type",
            activityTime: "Time",
            activityDescription: "Description",
            actionCreate: "Create",
            actionUpdate: "Update",
            actionDelete: "Delete",
            entityProject: "Project",
            entityEmployee: "Employee",
            entityVehicle: "Vehicle",
            entityAttendance: "Attendance",
            entityUser: "User",
            noActivityYet: "No activity records yet",
            dailyWage: "Daily Wage",
            monthlyWageManagement: "Daily Employees Wage Management",
            currentDailyWage: "Current Daily Wage",
            wageHistory: "Wage History",
            setMonthlyWage: "Set Monthly Wage",
            month: "Month",
            year: "Year",
            wageAmount: "Wage Amount",
            totalSalary: "Total Salary",
            salaryCalculation: "Salary Calculation"
        }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Ø§Ù„ØªØ±Ø¬Ù…Ø©
    function t(key) {
        return translations[currentLanguage][key] || key;
    }
    
    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® dd-mm-yyyy
    function formatDate(date) {
        if (!date) return '';
        const d = new Date(date);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${day}-${month}-${year}`;
    }
    
    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† dd-mm-yyyy
    function parseDate(dateStr) {
        if (!dateStr) return null;
        const parts = dateStr.split('-');
        return new Date(parts[2], parts[1] - 1, parts[0]);
    }
    
    // Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
    function getCurrentDate() {
        return formatDate(new Date());
    }
    
    // Ø¹Ø±Ø¶ Toast
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
    
    // ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² ÙØ±ÙŠØ¯
    function generateCode(prefix, counter) {
        return `${prefix}-${String(counter).padStart(4, '0')}`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø¯ÙˆØ§Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ©
    function toggleLanguage() {
        currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
        localStorage.setItem('language', currentLanguage);
        
        // ØªØºÙŠÙŠØ± Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØµÙØ­Ø©
        document.documentElement.lang = currentLanguage;
        document.documentElement.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ
        updateTranslations();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        if (currentUser) {
            showPage(currentPage);
        }
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª
    function updateTranslations() {
        // ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø§ØµØ± data-translate
        document.querySelectorAll('[data-translate]').forEach(el => {
            const key = el.getAttribute('data-translate');
            el.textContent = t(key);
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ù„ØºØ©
        document.getElementById('current-lang').textContent = currentLanguage.toUpperCase();
        document.getElementById('lang-toggle-text').textContent = currentLanguage === 'ar' ? 'English' : 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©
        document.getElementById('page-title').textContent = t(currentPage);
        
        // ØªØ­Ø¯ÙŠØ« Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        document.getElementById('login-title').textContent = t('loginTitle');
        document.getElementById('login-subtitle').textContent = t('loginSubtitle');
        document.getElementById('email-label').textContent = t('email');
        document.getElementById('password-label').textContent = t('password');
        document.getElementById('login-btn-text').textContent = t('login');
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
        if (currentLanguage === 'ltr') {
            document.getElementById('sidebar').classList.remove('right-0');
            document.getElementById('sidebar').classList.add('left-0');
            document.querySelector('main').classList.remove('lg:mr-64');
            document.querySelector('main').classList.add('lg:ml-64');
        } else {
            document.getElementById('sidebar').classList.remove('left-0');
            document.getElementById('sidebar').classList.add('right-0');
            document.querySelector('main').classList.remove('lg:ml-64');
            document.querySelector('main').classList.add('lg:mr-64');
        }
    }
    
    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        
        if (currentLanguage === 'ar') {
            sidebar.classList.toggle('translate-x-full');
            sidebar.classList.toggle('translate-x-0');
        } else {
            sidebar.classList.toggle('-translate-x-full');
            sidebar.classList.toggle('translate-x-0');
        }
        
        overlay.classList.toggle('hidden');
    }
    
    // ØªØ¨Ø¯ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    function toggleNotifications() {
        const dropdown = document.getElementById('notifications-dropdown');
        dropdown.classList.toggle('show');
    }
    
    // ØªØ¨Ø¯ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function toggleUserMenu() {
        const dropdown = document.getElementById('user-dropdown');
        dropdown.classList.toggle('show');
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    function togglePasswordVisibility() {
        const input = document.getElementById('login-password');
        const icon = document.getElementById('eye-icon');
        
        if (input.type === 'password') {
            input.type = 'text';
        } else {
            input.type = 'password';
        }
    }
    
    // ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    function openModal(title, content, footer = '', widthClass = '') {
        const modalContent = document.querySelector('.modal-content');
        // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ classes Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        modalContent.classList.remove('max-w-5xl', 'max-w-6xl', 'max-w-7xl');
        // Ø¥Ø¶Ø§ÙØ© class Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ØªÙ… ØªÙˆÙÙŠØ±Ù‡
        if (widthClass) {
            modalContent.classList.add(widthClass);
        }
        
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').innerHTML = content;
        document.getElementById('modal-footer').innerHTML = footer;
        document.getElementById('modal').classList.add('show');
    }
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    function closeModal() {
        const modalContent = document.querySelector('.modal-content');
        // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ classes Ø§Ù„Ø¹Ø±Ø¶ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
        modalContent.classList.remove('max-w-5xl', 'max-w-6xl', 'max-w-7xl');
        document.getElementById('modal').classList.remove('show');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø¯ÙŠØ± ÙˆØ¥Ù†Ø´Ø§Ø¦Ù‡
    async function checkAndCreateAdmin() {
        try {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Firestore
            const usersSnapshot = await db.collection('users').limit(1).get();
            
            if (usersSnapshot.empty) {
                // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠØ±
                document.getElementById('loading-text').textContent = currentLanguage === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ±...' : 'Creating admin account...';
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙÙŠ Authentication
                const userCredential = await auth.createUserWithEmailAndPassword(
                    DEFAULT_ADMIN.email,
                    DEFAULT_ADMIN.password
                );
                
                // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙŠ Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    email: DEFAULT_ADMIN.email,
                    name: DEFAULT_ADMIN.name,
                    nameEn: DEFAULT_ADMIN.nameEn,
                    role: DEFAULT_ADMIN.role,
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
                await db.collection('settings').doc('counters').set({
                    projectCounter: 0,
                    employeeCounter: 0,
                    vehicleCounter: 0,
                    missionCounter: 0,
                    transferCounter: 0
                });
                
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                await auth.signOut();
                
                showToast(currentLanguage === 'ar' ? 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­' : 'Admin account created successfully', 'success');
            }
        } catch (error) {
            console.error('Error checking/creating admin:', error);
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Auth ÙˆÙ„ÙƒÙ† Ù„ÙŠØ³ ÙÙŠ Firestore
            if (error.code === 'auth/email-already-in-use') {
                console.log('Admin account exists in Auth');
            }
        }
    }
    
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    async function login(email, password) {
        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            
            // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firestore
            const userDoc = await db.collection('users').doc(userCredential.user.uid).get();
            
            if (!userDoc.exists) {
                throw new Error('User data not found');
            }
            
            currentUser = userCredential.user;
            currentUserData = userDoc.data();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            updateUIForUser();
            
            // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
            showPage('dashboard');
            
            return true;
        } catch (error) {
            console.error('Login error:', error);
            throw error;
        }
    }
    
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    async function logout() {
        try {
            // Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
            stopAllListeners();
            
            await auth.signOut();
            currentUser = null;
            currentUserData = null;
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            document.getElementById('app').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            
            // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            document.getElementById('login-form').reset();
        } catch (error) {
            console.error('Logout error:', error);
        }
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function updateUIForUser() {
        if (!currentUserData) return;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const name = currentLanguage === 'ar' ? currentUserData.name : (currentUserData.nameEn || currentUserData.name);
        document.getElementById('user-name').textContent = name;
        document.getElementById('user-avatar').textContent = name.charAt(0);
        
        // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯ÙŠØ±
        if (currentUserData.role === 'manager') {
            document.getElementById('manager-menu').classList.remove('hidden');
        } else {
            document.getElementById('manager-menu').classList.add('hidden');
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ
        startNotificationsListener();
    }
    
    // Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ù…Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø³ØªÙ…Ø¹
    let notificationsUnsubscribe = null;
    let attendanceUnsubscribe = null;
    
    // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ
    function startNotificationsListener() {
        // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆØ¬Ø¯
        if (notificationsUnsubscribe) {
            notificationsUnsubscribe();
        }
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ
        notificationsUnsubscribe = db.collection('notifications').onSnapshot(snapshot => {
            let notifications = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                // ØªØµÙÙŠØ©: ÙÙ‚Ø· ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
                if (data.read === false) {
                    // Ù„Ù„Ù…Ø´Ø±Ù: ÙÙ‚Ø· Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ù…Ø´Ø§Ø±ÙŠØ¹Ù‡
                    if (currentUserData?.role === 'supervisor' && currentUserData.assignedProjects?.length > 0) {
                        if (currentUserData.assignedProjects.includes(data.targetProjectId)) {
                            notifications.push({ id: doc.id, ...data });
                        }
                    } else {
                        // Ù„Ù„Ù…Ø¯ÙŠØ±: ÙƒÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                        notifications.push({ id: doc.id, ...data });
                    }
                }
            });
            
            // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
            notifications.sort((a, b) => (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0));
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            renderNotifications(notifications.slice(0, 20));
            
            // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯
            if (notifications.length > 0 && window.lastNotificationCount !== undefined && 
                notifications.length > window.lastNotificationCount) {
                playNotificationSound();
            }
            window.lastNotificationCount = notifications.length;
            
        }, error => {
            console.error('Error listening to notifications:', error);
        });
    }
    
    // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
    function playNotificationSound() {
        try {
            // Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØª Ø¨Ø³ÙŠØ· Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Audio API
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            gainNode.gain.value = 0.3;
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.2);
        } catch (e) {
            // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø®Ø·Ø£ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø¯Ø¹Ù… Ø§Ù„ØµÙˆØª
        }
    }
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
    function stopAllListeners() {
        if (notificationsUnsubscribe) {
            notificationsUnsubscribe();
            notificationsUnsubscribe = null;
        }
        if (attendanceUnsubscribe) {
            attendanceUnsubscribe();
            attendanceUnsubscribe = null;
        }
    }
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    function renderNotifications(notifications) {
        const countEl = document.getElementById('notification-count');
        const listEl = document.getElementById('notifications-list');
        const noNotifEl = document.getElementById('no-notifications');
        const titleEl = document.getElementById('notifications-title');
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        if (titleEl) titleEl.textContent = t('notifications');
        if (noNotifEl) noNotifEl.textContent = t('noNotifications');
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø¯
        if (countEl) {
            if (notifications.length > 0) {
                countEl.textContent = notifications.length;
                countEl.classList.remove('hidden');
            } else {
                countEl.classList.add('hidden');
            }
        }
        
        // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        if (listEl) {
            if (notifications.length === 0) {
                listEl.innerHTML = `<p class="p-4 text-gray-500 text-center">${t('noNotifications')}</p>`;
            } else {
                listEl.innerHTML = notifications.map(notif => {
                    if (notif.type === 'missionAttendance') {
                        const dateParts = notif.date?.split('-') || [];
                        const formattedDate = dateParts.length === 3 ? `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}` : notif.date;
                        
                        return `
                            <div class="p-4 border-b hover:bg-gray-50">
                                <div class="flex items-start gap-3">
                                    <span class="text-2xl">ğŸ“</span>
                                    <div class="flex-1">
                                        <p class="font-medium text-sm">${t('missionAttendanceRequest')}</p>
                                        <p class="text-sm text-gray-600">
                                            <strong>${notif.employeeName}</strong>
                                        </p>
                                        <p class="text-xs text-gray-500">
                                            ${t('missionFrom')}: ${notif.sourceProjectName}
                                        </p>
                                        <p class="text-xs text-gray-500">ğŸ“… ${formattedDate}</p>
                                        
                                        ${notif.status === 'pending' ? `
                                        <div class="flex gap-2 mt-2">
                                            <button onclick="confirmMissionAttendance('${notif.id}', '${notif.attendanceId}')" 
                                                    class="px-3 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600">
                                                âœ“ ${t('confirmMissionAttendance')}
                                            </button>
                                            <button onclick="rejectMissionAttendance('${notif.id}', '${notif.attendanceId}')"
                                                    class="px-3 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600">
                                                âœ— ${t('rejectMissionAttendance')}
                                            </button>
                                        </div>
                                        ` : `
                                        <p class="text-xs mt-2 ${notif.status === 'confirmed' ? 'text-green-600' : 'text-red-600'}">
                                            ${notif.status === 'confirmed' ? 'âœ“ ' + t('missionConfirmed') : 'âœ— ' + t('missionRejected')}
                                        </p>
                                        `}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    return '';
                }).join('');
            }
        }
    }
    
    // ØªØ£ÙƒÙŠØ¯ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ù‡Ù…Ø©
    async function confirmMissionAttendance(notifId, attendanceId) {
        try {
            const batch = db.batch();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
            batch.update(db.collection('notifications').doc(notifId), {
                status: 'confirmed',
                read: true,
                confirmedBy: currentUser.uid,
                confirmedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±
            batch.update(db.collection('attendance').doc(attendanceId), {
                'missionNotification.status': 'confirmed',
                'missionNotification.confirmedBy': currentUser.uid,
                'missionNotification.confirmedAt': firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await batch.commit();
            
            showToast(t('missionConfirmed'), 'success');
            // Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø³ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            
        } catch (error) {
            console.error('Error confirming mission:', error);
            showToast(t('error'), 'error');
        }
    }
    
    // Ø±ÙØ¶ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ù‡Ù…Ø©
    async function rejectMissionAttendance(notifId, attendanceId) {
        try {
            const batch = db.batch();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
            batch.update(db.collection('notifications').doc(notifId), {
                status: 'rejected',
                read: true,
                rejectedBy: currentUser.uid,
                rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±
            batch.update(db.collection('attendance').doc(attendanceId), {
                'missionNotification.status': 'rejected',
                'missionNotification.rejectedBy': currentUser.uid,
                'missionNotification.rejectedAt': firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await batch.commit();
            
            showToast(t('missionRejected'), 'success');
            // Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø³ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            
        } catch (error) {
            console.error('Error rejecting mission:', error);
            showToast(t('error'), 'error');
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function showPage(page) {
        currentPage = page;
        
        // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª
        document.querySelectorAll('.page-content').forEach(p => {
            p.classList.add('hidden');
        });
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        document.getElementById(`page-${page}`).classList.remove('hidden');
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('data-page') === page) {
                item.classList.add('active');
            }
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        document.getElementById('page-title').textContent = t(page);
        
        // ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø©
        loadPageContent(page);
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
        if (window.innerWidth < 1024) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            if (currentLanguage === 'ar') {
                sidebar.classList.add('translate-x-full');
                sidebar.classList.remove('translate-x-0');
            } else {
                sidebar.classList.add('-translate-x-full');
                sidebar.classList.remove('translate-x-0');
            }
            overlay.classList.add('hidden');
        }
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø©
    function loadPageContent(page) {
        switch(page) {
            case 'dashboard':
                loadDashboard();
                break;
            case 'projects':
                loadProjects();
                break;
            case 'employees':
                loadEmployees();
                break;
            case 'vehicles':
                loadVehicles();
                break;
            case 'attendance':
                loadAttendance();
                break;
            case 'reports':
                loadReports();
                break;
            case 'activityLog':
                loadActivityLog();
                break;
            case 'monthlyWageManagement':
                loadMonthlyWageManagement();
                break;
            case 'users':
                loadUsers();
                break;
            case 'settings':
                loadSettings();
                break;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function loadDashboard() {
        const container = document.getElementById('page-dashboard');
        container.innerHTML = `<div class="text-center py-8"><div class="loader mx-auto"></div></div>`;
        
        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            const [projectsSnap, employeesSnap, vehiclesSnap] = await Promise.all([
                db.collection('projects').where('status', '==', 'active').get(),
                db.collection('employees').where('status', '==', 'active').get(),
                db.collection('vehicles').where('status', '==', 'active').get()
            ]);
            
            const stats = {
                projects: projectsSnap.size,
                employees: employeesSnap.size,
                vehicles: vehiclesSnap.size
            };
            
            container.innerHTML = `
                <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">${t('activeProjects')}</p>
                                <p class="text-3xl font-bold text-gray-800 mt-1">${stats.projects}</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">${t('totalEmployees')}</p>
                                <p class="text-3xl font-bold text-gray-800 mt-1">${stats.employees}</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">${t('totalVehicles')}</p>
                                <p class="text-3xl font-bold text-gray-800 mt-1">${stats.vehicles}</p>
                            </div>
                            <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ -->
                <div class="card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-lg">${t('projects')}</h3>
                        <button onclick="showPage('projects')" class="text-primary-600 hover:text-primary-700 text-sm">
                            ${t('view')} ${t('all')} â†’
                        </button>
                    </div>
                    <div id="dashboard-projects" class="space-y-3">
                        ${stats.projects === 0 ? `<p class="text-gray-500 text-center py-4">${t('noProjects')}</p>` : ''}
                    </div>
                </div>
            `;
            
            // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
            if (stats.projects > 0) {
                const projectsList = document.getElementById('dashboard-projects');
                projectsSnap.forEach(doc => {
                    const project = doc.data();
                    projectsList.innerHTML += `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div>
                                <p class="font-medium">${project.name}</p>
                                <p class="text-sm text-gray-500">${project.code} ${project.contractNumber ? '| ' + project.contractNumber : ''}</p>
                            </div>
                            <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-600">${t('active')}</span>
                        </div>
                    `;
                });
            }
            
        } catch (error) {
            console.error('Error loading dashboard:', error);
            container.innerHTML = `<p class="text-red-500 text-center py-8">${t('error')}</p>`;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø¨Ù‚ÙŠØ© Ø¯ÙˆØ§Ù„ Ø§Ù„ØµÙØ­Ø§Øª (Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function loadProjects() {
        const container = document.getElementById('page-projects');
        container.innerHTML = `<div class="text-center py-8"><div class="loader mx-auto"></div></div>`;
        
        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
            let snapshot;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´Ø±ÙØŒ Ø¹Ø±Ø¶ Ù…Ø´Ø§Ø±ÙŠØ¹Ù‡ ÙÙ‚Ø·
            if (currentUserData.role === 'supervisor' && currentUserData.assignedProjects && currentUserData.assignedProjects.length > 0) {
                snapshot = await db.collection('projects').where(firebase.firestore.FieldPath.documentId(), 'in', currentUserData.assignedProjects).get();
            } else {
                snapshot = await db.collection('projects').get();
            }
            
            let projects = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø®ÙÙŠØ©
                if (data.status !== 'hidden') {
                    projects.push({ id: doc.id, ...data });
                }
            });
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
            projects.sort((a, b) => {
                // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹ (Ù†Ø´Ø· Ø£ÙˆÙ„Ø§Ù‹)
                const statusOrder = { active: 1, paused: 2, completed: 3 };
                const statusDiff = (statusOrder[a.status] || 4) - (statusOrder[b.status] || 4);
                if (statusDiff !== 0) return statusDiff;
                // Ø«Ù… Ø­Ø³Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
                return (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0);
            });
            
            container.innerHTML = `
                <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                    <div class="flex items-center gap-4">
                        <div class="relative">
                            <input type="text" id="projects-search" placeholder="${t('search')}..." 
                                   class="pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none w-64"
                                   onkeyup="filterProjects()">
                            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <select id="projects-filter" onchange="filterProjects()" class="border rounded-lg px-4 py-2 outline-none focus:ring-2 focus:ring-primary-500">
                            <option value="all">${t('all')}</option>
                            <option value="active">${t('active')}</option>
                            <option value="paused">${t('inactive')}</option>
                            <option value="completed">${t('completed')}</option>
                        </select>
                    </div>
                    ${currentUserData.role === 'manager' ? `
                    <button onclick="openProjectModal()" class="bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        ${t('addProject')}
                    </button>
                    ` : ''}
                </div>
                
                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ -->
                <div id="projects-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${projects.length === 0 ? `
                        <div class="col-span-full text-center py-12 text-gray-500">
                            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                            <p>${t('noProjects')}</p>
                        </div>
                    ` : projects.map(project => createProjectCard(project)).join('')}
                </div>
            `;
            
            // Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ù„Ù„Ø¨Ø­Ø«
            window.projectsData = projects;
            
        } catch (error) {
            console.error('Error loading projects:', error);
            container.innerHTML = `<p class="text-red-500 text-center py-8">${t('error')}</p>`;
        }
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ù…Ø´Ø±ÙˆØ¹
    function createProjectCard(project) {
        const statusColors = {
            active: 'bg-green-100 text-green-600',
            paused: 'bg-yellow-100 text-yellow-600',
            completed: 'bg-blue-100 text-blue-600'
        };
        
        const statusNames = {
            active: t('active'),
            paused: t('inactive'),
            completed: t('completed')
        };
        
        return `
            <div class="card p-5 project-card" data-id="${project.id}" data-name="${project.name}" data-code="${project.code}" data-status="${project.status}">
                <div class="flex items-start justify-between mb-3">
                    <span class="text-xs font-mono text-gray-500">${project.code}</span>
                    <span class="px-2 py-1 text-xs rounded-full ${statusColors[project.status] || 'bg-gray-100 text-gray-600'}">
                        ${statusNames[project.status] || project.status}
                    </span>
                </div>
                
                <h3 class="font-bold text-lg mb-2">${project.name}</h3>
                
                ${project.contractNumber ? `
                    <p class="text-sm text-gray-500 mb-1">
                        <span class="font-medium">${t('contractNumber')}:</span> ${project.contractNumber}
                    </p>
                ` : ''}
                
                <p class="text-sm text-gray-500 mb-3">
                    <span class="font-medium">ğŸ“</span> ${project.address || '-'}
                </p>
                
                <div class="flex items-center gap-4 text-sm text-gray-500 mb-4">
                    <span>ğŸ‘¥ ${project.employeesCount || 0}</span>
                    <span>ğŸš— ${project.vehiclesCount || 0}</span>
                </div>
                
                <div class="flex items-center gap-2 pt-3 border-t">
                    <button onclick="viewProject('${project.id}')" class="flex-1 px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                        ${t('view')}
                    </button>
                    <button onclick="showPage('attendance'); setAttendanceProject('${project.id}')" class="flex-1 px-3 py-2 text-sm bg-primary-100 text-primary-600 hover:bg-primary-200 rounded-lg transition">
                        ${t('attendance')}
                    </button>
                    ${currentUserData.role === 'manager' ? `
                    <button onclick="openProjectModal('${project.id}')" class="px-3 py-2 text-sm hover:bg-gray-100 rounded-lg transition">
                        âœï¸
                    </button>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
    function filterProjects() {
        const search = document.getElementById('projects-search').value.toLowerCase();
        const filter = document.getElementById('projects-filter').value;
        
        document.querySelectorAll('.project-card').forEach(card => {
            const name = card.dataset.name.toLowerCase();
            const code = card.dataset.code.toLowerCase();
            const status = card.dataset.status;
            
            const matchesSearch = name.includes(search) || code.includes(search);
            const matchesFilter = filter === 'all' || status === filter;
            
            card.style.display = matchesSearch && matchesFilter ? 'block' : 'none';
        });
    }
    
    // ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„)
    async function openProjectModal(projectId = null) {
        let project = null;
        let title = t('addProject');
        
        if (projectId) {
            // ØªØ¹Ø¯ÙŠÙ„ Ù…Ø´Ø±ÙˆØ¹
            const doc = await db.collection('projects').doc(projectId).get();
            if (doc.exists) {
                project = { id: doc.id, ...doc.data() };
                title = t('editProject');
            }
        }
        
        const content = `
            <form id="project-form" class="space-y-4">
                <input type="hidden" id="project-id" value="${project?.id || ''}">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('projectName')} *</label>
                    <input type="text" id="project-name" required value="${project?.name || ''}"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('contractNumber')}</label>
                    <input type="text" id="project-contract" value="${project?.contractNumber || ''}"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('address')} *</label>
                    <input type="text" id="project-address" required value="${project?.address || ''}"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('description')}</label>
                    <textarea id="project-description" rows="3"
                              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">${project?.description || ''}</textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${t('workStart')}</label>
                        <input type="time" id="project-start-time" value="${project?.defaultSchedule?.startTime || '08:00'}"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${t('workEnd')}</label>
                        <input type="time" id="project-end-time" value="${project?.defaultSchedule?.endTime || '17:00'}"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                    </div>
                </div>
                
                ${project ? `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('status')}</label>
                    <select id="project-status" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                        <option value="active" ${project.status === 'active' ? 'selected' : ''}>${t('active')}</option>
                        <option value="paused" ${project.status === 'paused' ? 'selected' : ''}>${t('inactive')}</option>
                        <option value="completed" ${project.status === 'completed' ? 'selected' : ''}>${t('completed')}</option>
                    </select>
                </div>
                ` : ''}
            </form>
        `;
        
        const footer = `
            <button onclick="closeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-100 transition">${t('cancel')}</button>
            <button onclick="saveProject()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition">${t('save')}</button>
            ${project && project.employeesCount === 0 && project.vehiclesCount === 0 ? `
                <button onclick="deleteProject('${project.id}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">${t('delete')}</button>
            ` : ''}
        `;
        
        openModal(title, content, footer);
    }
    
    // Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
    async function saveProject() {
        const form = document.getElementById('project-form');
        if (!form) {
            showToast(t('error'), 'error');
            return;
        }
        
        const nameEl = form.querySelector('#project-name');
        const contractEl = form.querySelector('#project-contract');
        const addressEl = form.querySelector('#project-address');
        const descEl = form.querySelector('#project-description');
        const startEl = form.querySelector('#project-start-time');
        const endEl = form.querySelector('#project-end-time');
        
        if (!nameEl || !addressEl) {
            showToast(t('error'), 'error');
            return;
        }
        
        const id = form.querySelector('#project-id')?.value || '';
        const name = (nameEl.value || '').trim();
        const contractNumber = (contractEl?.value || '').trim();
        const address = (addressEl.value || '').trim();
        const description = (descEl?.value || '').trim();
        const startTime = startEl?.value || '08:00';
        const endTime = endEl?.value || '17:00';
        
        if (!name || !address) {
            showToast(t('required'), 'error');
            return;
        }
        
        try {
            if (id) {
                // ØªØ¹Ø¯ÙŠÙ„
                const status = form.querySelector('#project-status')?.value || 'active';
                await db.collection('projects').doc(id).update({
                    name,
                    contractNumber,
                    address,
                    description,
                    status,
                    defaultSchedule: { startTime, endTime },
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                logActivity('update', 'project', id, name, currentLanguage === 'ar' ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø´Ø±ÙˆØ¹' : 'Project updated');
            } else {
                // Ø¥Ø¶Ø§ÙØ©
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¯Ø§Ø¯
                const counterDoc = await db.collection('settings').doc('counters').get();
                const counter = (counterDoc.data()?.projectCounter || 0) + 1;
                const code = generateCode('PRJ', counter);
                
                const projectRef = await db.collection('projects').add({
                    code,
                    name,
                    contractNumber,
                    address,
                    description,
                    status: 'active',
                    defaultSchedule: { startTime, endTime },
                    employeesCount: 0,
                    vehiclesCount: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
                await db.collection('settings').doc('counters').update({
                    projectCounter: counter
                });
                logActivity('create', 'project', projectRef.id, name, currentLanguage === 'ar' ? 'Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹' : 'Project created');
            }
            
            closeModal();
            showToast(t('saved'), 'success');
            loadProjects();
            
        } catch (error) {
            console.error('Error saving project:', error);
            showToast(t('error'), 'error');
        }
    }
    
    // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
    async function viewProject(projectId) {
        const doc = await db.collection('projects').doc(projectId).get();
        if (!doc.exists) return;
        
        const project = { id: doc.id, ...doc.data() };
        
        const statusColors = {
            active: 'bg-green-100 text-green-600',
            paused: 'bg-yellow-100 text-yellow-600',
            completed: 'bg-blue-100 text-blue-600'
        };
        
        const content = `
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-mono text-gray-500">${project.code}</span>
                    <span class="px-3 py-1 text-sm rounded-full ${statusColors[project.status]}">${t(project.status)}</span>
                </div>
                
                <div>
                    <label class="text-sm text-gray-500">${t('projectName')}</label>
                    <p class="font-medium">${project.name}</p>
                </div>
                
                ${project.contractNumber ? `
                <div>
                    <label class="text-sm text-gray-500">${t('contractNumber')}</label>
                    <p class="font-medium">${project.contractNumber}</p>
                </div>
                ` : ''}
                
                <div>
                    <label class="text-sm text-gray-500">${t('address')}</label>
                    <p class="font-medium">${project.address}</p>
                </div>
                
                ${project.description ? `
                <div>
                    <label class="text-sm text-gray-500">${t('description')}</label>
                    <p class="font-medium">${project.description}</p>
                </div>
                ` : ''}
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-500">${t('workStart')}</label>
                        <p class="font-medium">${project.defaultSchedule?.startTime || '08:00'}</p>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500">${t('workEnd')}</label>
                        <p class="font-medium">${project.defaultSchedule?.endTime || '17:00'}</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-6 pt-4 border-t">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-primary-600">${project.employeesCount || 0}</p>
                        <p class="text-sm text-gray-500">${t('employees')}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-orange-600">${project.vehiclesCount || 0}</p>
                        <p class="text-sm text-gray-500">${t('vehicles')}</p>
                    </div>
                </div>
            </div>
        `;
        
        const footer = `
            <button onclick="closeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-100 transition">${t('close')}</button>
            <button onclick="closeModal(); showPage('attendance'); setAttendanceProject('${project.id}')" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition">${t('attendance')}</button>
        `;
        
        openModal(project.name, content, footer);
    }
    
    // Ø­Ø°Ù Ù…Ø´Ø±ÙˆØ¹
    async function deleteProject(projectId) {
        if (!confirm(t('confirmDelete'))) return;
        
        try {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ÙˆØ¸ÙÙŠÙ† Ø£Ùˆ Ø¢Ù„ÙŠØ§Øª
            const [employeesSnap, vehiclesSnap] = await Promise.all([
                db.collection('employees').where('projectId', '==', projectId).limit(1).get(),
                db.collection('vehicles').where('projectId', '==', projectId).limit(1).get()
            ]);
            
            if (!employeesSnap.empty || !vehiclesSnap.empty) {
                showToast(currentLanguage === 'ar' ? 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù…Ø´Ø±ÙˆØ¹ Ù…Ø±ØªØ¨Ø· Ø¨Ù…ÙˆØ¸ÙÙŠÙ† Ø£Ùˆ Ø¢Ù„ÙŠØ§Øª' : 'Cannot delete project with employees or vehicles', 'error');
                return;
            }
            
            const projectDoc = await db.collection('projects').doc(projectId).get();
            const projectName = projectDoc.exists ? projectDoc.data().name : projectId;
            await db.collection('projects').doc(projectId).delete();
            logActivity('delete', 'project', projectId, projectName, currentLanguage === 'ar' ? 'Ø­Ø°Ù Ù…Ø´Ø±ÙˆØ¹' : 'Project deleted');
            
            closeModal();
            showToast(t('deleted'), 'success');
            loadProjects();
            
        } catch (error) {
            console.error('Error deleting project:', error);
            showToast(t('error'), 'error');
        }
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Ù…Ø´Ø±ÙˆØ¹ (Ø£Ø±Ø´ÙØ©)
    async function hideProject(projectId) {
        if (!confirm(t('confirmDelete'))) return;
        
        try {
            const projectDoc = await db.collection('projects').doc(projectId).get();
            const projectName = projectDoc.exists ? projectDoc.data().name : projectId;
            await db.collection('projects').doc(projectId).update({
                status: 'hidden',
                hiddenAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            logActivity('update', 'project', projectId, projectName, currentLanguage === 'ar' ? 'Ø¥Ø®ÙØ§Ø¡ Ù…Ø´Ø±ÙˆØ¹' : 'Project hidden');
            
            showToast(t('saved'), 'success');
            loadProjects();
            
        } catch (error) {
            console.error('Error hiding project:', error);
            showToast(t('error'), 'error');
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function loadEmployees() {
        const container = document.getElementById('page-employees');
        container.innerHTML = `<div class="text-center py-8"><div class="loader mx-auto"></div></div>`;
        
        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ù„Ù„ÙÙ„ØªØ±Ø©
            let projectsSnap;
            if (currentUserData.role === 'supervisor' && currentUserData.assignedProjects && currentUserData.assignedProjects.length > 0) {
                projectsSnap = await db.collection('projects').where(firebase.firestore.FieldPath.documentId(), 'in', currentUserData.assignedProjects).get();
            } else {
                projectsSnap = await db.collection('projects').get();
            }
            const projects = [];
            projectsSnap.forEach(doc => {
                const data = doc.data();
                if (data.status !== 'hidden') {
                    projects.push({ id: doc.id, ...data });
                }
            });
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
            let employeesSnap;
            if (currentUserData.role === 'supervisor' && currentUserData.assignedProjects && currentUserData.assignedProjects.length > 0) {
                employeesSnap = await db.collection('employees').where('projectId', 'in', currentUserData.assignedProjects).get();
            } else {
                employeesSnap = await db.collection('employees').get();
            }
            const employees = [];
            employeesSnap.forEach(doc => {
                const data = doc.data();
                if (data.status !== 'hidden') {
                    employees.push({ id: doc.id, ...data });
                }
            });
            
            container.innerHTML = `
                <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="relative">
                            <input type="text" id="employees-search" placeholder="${t('search')}..." 
                                   class="pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none w-64"
                                   onkeyup="filterEmployees()">
                            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <select id="employees-project-filter" onchange="filterEmployees()" class="border rounded-lg px-4 py-2 outline-none focus:ring-2 focus:ring-primary-500">
                            <option value="all">${t('all')} ${t('projects')}</option>
                            ${projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                        </select>
                        <select id="employees-type-filter" onchange="filterEmployees()" class="border rounded-lg px-4 py-2 outline-none focus:ring-2 focus:ring-primary-500">
                            <option value="all">${t('all')}</option>
                            <option value="daily">${t('daily')}</option>
                            <option value="monthly">${t('monthly')}</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openBulkEmployeeModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            ${t('addMultipleEmployees')}
                        </button>
                        <button onclick="openEmployeeModal()" class="bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            ${t('addEmployee')}
                        </button>
                    </div>
                </div>
                
                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
                <div class="card overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">${t('employeeCode')}</th>
                                    <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">${t('employeeName')}</th>
                                    <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">${t('employeeType')}</th>
                                    <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">${t('projects')}</th>
                                    <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">${t('phone')}</th>
                                    <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">${t('status')}</th>
                                    <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">${t('actions')}</th>
                                </tr>
                            </thead>
                            <tbody id="employees-list" class="divide-y">
                                ${employees.length === 0 ? `
                                    <tr>
                                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">${t('noEmployees')}</td>
                                    </tr>
                                ` : employees.map(emp => createEmployeeRow(emp, projects)).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            window.employeesData = employees;
            window.projectsListData = projects;
            
        } catch (error) {
            console.error('Error loading employees:', error);
            container.innerHTML = `<p class="text-red-500 text-center py-8">${t('error')}</p>`;
        }
    }
    
    function createEmployeeRow(employee, projects) {
        const project = projects.find(p => p.id === employee.projectId);
        const typeColors = {
            daily: 'bg-blue-100 text-blue-600',
            monthly: 'bg-purple-100 text-purple-600'
        };
        const statusColors = {
            active: 'bg-green-100 text-green-600',
            inactive: 'bg-gray-100 text-gray-600',
            on_mission: 'bg-cyan-100 text-cyan-600'
        };
        
        // ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ù‚Ù„ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ¸Ù
        const jobLabel = employee.type === 'monthly' ? t('position') : t('profession');
        
        return `
            <tr class="employee-row hover:bg-gray-50" data-id="${employee.id}" data-name="${employee.name}" 
                data-project="${employee.projectId}" data-type="${employee.type}" data-status="${employee.status}">
                <td class="px-4 py-3 text-sm font-mono">${employee.code}</td>
                <td class="px-4 py-3">
                    <div class="font-medium">${employee.name}</div>
                    ${employee.jobTitle ? `<div class="text-sm text-gray-500">${jobLabel}: ${employee.jobTitle}</div>` : ''}
                </td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 text-xs rounded-full ${typeColors[employee.type]}">${t(employee.type)}</span>
                </td>
                <td class="px-4 py-3 text-sm">${project?.name || '-'}</td>
                <td class="px-4 py-3 text-sm">${employee.phone || '-'}</td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 text-xs rounded-full ${statusColors[employee.status]}">${t(employee.status)}</span>
                </td>
                <td class="px-4 py-3">
                    <div class="flex items-center gap-2">
                        <button onclick="viewEmployee('${employee.id}')" class="p-1 hover:bg-gray-200 rounded" title="${t('view')}">ğŸ‘ï¸</button>
                        <button onclick="openEmployeeModal('${employee.id}')" class="p-1 hover:bg-gray-200 rounded" title="${t('edit')}">âœï¸</button>
                        <button onclick="openTransferModal('${employee.id}')" class="p-1 hover:bg-gray-200 rounded" title="${t('transferRequest')}">ğŸ”„</button>
                        ${currentUserData.role === 'manager' ? `
                        <button onclick="deleteEmployee('${employee.id}', '${employee.name}')" class="p-1 hover:bg-red-100 rounded text-red-600" title="${t('delete')}">ğŸ—‘ï¸</button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `;
    }
    
    // Ø­Ø°Ù Ù…ÙˆØ¸Ù
    async function deleteEmployee(employeeId, employeeName) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø¶ÙˆØ± ÙˆØ­Ø°ÙÙ‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)
        try {
            // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ø£ÙˆÙ„Ø§Ù‹
            const empDoc = await db.collection('employees').doc(employeeId).get();
            if (!empDoc.exists) {
                showToast(t('error'), 'error');
                return;
            }
            const empData = empDoc.data();
            const finalEmployeeName = empData?.name || employeeName || employeeId;
            const projectId = empData?.projectId;
            
            const allAttendanceSnap = await db.collection('attendance')
                .where('employeeId', '==', employeeId)
                .get();
            
            if (!allAttendanceSnap.empty && currentUserData.role === 'manager') {
                // Ù„Ù„Ù…Ø¯ÙŠØ±: Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                const deleteBatch = db.batch();
                allAttendanceSnap.forEach(doc => {
                    deleteBatch.delete(doc.ref);
                });
                await deleteBatch.commit();
            } else if (!allAttendanceSnap.empty) {
                // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†: Ù…Ù†Ø¹ Ø§Ù„Ø­Ø°Ù
                showToast(t('cannotDeleteEmployeeWithAttendance'), 'error');
                return;
            }
            
            // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù
            const confirmMsg = currentLanguage === 'ar' 
                ? `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù "${finalEmployeeName}"ØŸ`
                : `Are you sure you want to delete employee "${finalEmployeeName}"?`;
            
            if (!confirm(confirmMsg)) return;
            
            // Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù
            await db.collection('employees').doc(employeeId).delete();
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
            if (projectId) {
                await db.collection('projects').doc(projectId).update({
                    employeesCount: firebase.firestore.FieldValue.increment(-1)
                });
            }
            logActivity('delete', 'employee', employeeId, finalEmployeeName, currentLanguage === 'ar' ? 'Ø­Ø°Ù Ù…ÙˆØ¸Ù' : 'Employee deleted');
            
            showToast(t('deleted'), 'success');
            loadEmployees();
            
        } catch (error) {
            console.error('Error deleting employee:', error);
            showToast(t('error'), 'error');
        }
    }
    
    function filterEmployees() {
        const search = document.getElementById('employees-search').value.toLowerCase();
        const projectFilter = document.getElementById('employees-project-filter').value;
        const typeFilter = document.getElementById('employees-type-filter').value;
        
        document.querySelectorAll('.employee-row').forEach(row => {
            const name = row.dataset.name.toLowerCase();
            const project = row.dataset.project;
            const type = row.dataset.type;
            
            const matchesSearch = name.includes(search);
            const matchesProject = projectFilter === 'all' || project === projectFilter;
            const matchesType = typeFilter === 'all' || type === typeFilter;
            
            row.style.display = matchesSearch && matchesProject && matchesType ? '' : 'none';
        });
    }
    
    async function openEmployeeModal(employeeId = null) {
        let employee = null;
        let title = t('addEmployee');
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
        const projects = window.projectsListData || [];
        
        if (employeeId) {
            const doc = await db.collection('employees').doc(employeeId).get();
            if (doc.exists) {
                employee = { id: doc.id, ...doc.data() };
                title = t('editEmployee');
            }
        }
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ù† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
        let defaultStart = '08:00';
        let defaultEnd = '17:00';
        if (projects.length > 0) {
            const firstProject = projects[0];
            defaultStart = firstProject.defaultSchedule?.startTime || '08:00';
            defaultEnd = firstProject.defaultSchedule?.endTime || '17:00';
        }
        
        const content = `
            <form id="employee-form" class="space-y-4">
                <input type="hidden" id="employee-id" value="${employee?.id || ''}">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('employeeName')} *</label>
                    <input type="text" id="employee-name" required value="${employee?.name || ''}"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${t('employeeType')} *</label>
                        <select id="employee-type" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none" onchange="toggleJobPositionField()">
                            <option value="daily" ${employee?.type === 'daily' ? 'selected' : ''}>${t('daily')}</option>
                            <option value="monthly" ${employee?.type === 'monthly' ? 'selected' : ''}>${t('monthly')}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${t('projects')} *</label>
                        <select id="employee-project" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none" onchange="updateEmployeeSchedule()">
                            ${projects.map(p => `<option value="${p.id}" data-start="${p.defaultSchedule?.startTime || '08:00'}" data-end="${p.defaultSchedule?.endTime || '17:00'}" ${employee?.projectId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${t('workStart')} *</label>
                        <input type="time" id="employee-start" required value="${employee?.workSchedule?.startTime || defaultStart}"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${t('workEnd')} *</label>
                        <input type="time" id="employee-end" required value="${employee?.workSchedule?.endTime || defaultEnd}"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${t('phone')}</label>
                        <input type="tel" id="employee-phone" value="${employee?.phone || ''}"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                    </div>
                    <div>
                        <label id="job-position-label" class="block text-sm font-medium text-gray-700 mb-1">
                            ${employee?.type === 'monthly' ? t('position') : t('profession')}
                        </label>
                        <input type="text" id="employee-job" value="${employee?.jobTitle || ''}"
                               placeholder="${employee?.type === 'monthly' ? t('positionPlaceholder') : t('professionPlaceholder')}"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                    </div>
                </div>
                
                ${(!employee || employee.type === 'daily') ? `
                <div id="daily-wage-field">
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('dailyWage')} (${currentLanguage === 'ar' ? 'IQD' : 'IQD'})</label>
                    <input type="number" id="employee-daily-wage" step="0.01" min="0" value="${employee?.dailyWage || ''}"
                           placeholder="${currentLanguage === 'ar' ? 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ' : 'Enter daily wage'}"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                </div>
                ` : ''}
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('notes')}</label>
                    <textarea id="employee-notes" rows="2"
                              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">${employee?.note || ''}</textarea>
                </div>
                
                ${employee ? `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('status')}</label>
                    <select id="employee-status" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                        <option value="active" ${employee.status === 'active' ? 'selected' : ''}>${t('active')}</option>
                        <option value="inactive" ${employee.status === 'inactive' ? 'selected' : ''}>${t('inactive')}</option>
                    </select>
                </div>
                ` : ''}
            </form>
        `;
        
        const footer = `
            <button onclick="closeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-100 transition">${t('cancel')}</button>
            <button onclick="saveEmployee()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition">${t('save')}</button>
        `;
        
        openModal(title, content, footer);
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
        setTimeout(() => {
            toggleJobPositionField();
        }, 100);
    }
    
    function updateEmployeeSchedule() {
        const select = document.getElementById('employee-project');
        if (!select) return;
        const option = select.options[select.selectedIndex];
        const startEl = document.getElementById('employee-start');
        const endEl = document.getElementById('employee-end');
        if (startEl) startEl.value = option?.dataset?.start || '08:00';
        if (endEl) endEl.value = option?.dataset?.end || '17:00';
    }
    
    // ØªØ¨Ø¯ÙŠÙ„ Ø¹Ù†ÙˆØ§Ù† Ø­Ù‚Ù„ Ø§Ù„Ù…Ù†ØµØ¨/Ø§Ù„Ù…Ù‡Ù†Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ¸Ù
    function toggleJobPositionField() {
        const typeSelect = document.getElementById('employee-type');
        const label = document.getElementById('job-position-label');
        const input = document.getElementById('employee-job');
        const dailyWageField = document.getElementById('daily-wage-field');
        
        if (!typeSelect || !label || !input) return;
        
        const isMonthly = typeSelect.value === 'monthly';
        label.textContent = isMonthly ? t('position') : t('profession');
        input.placeholder = isMonthly ? t('positionPlaceholder') : t('professionPlaceholder');
        
        // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ
        if (dailyWageField) {
            dailyWageField.style.display = isMonthly ? 'none' : 'block';
        }
    }
    
    async function saveEmployee() {
        const form = document.getElementById('employee-form');
        if (!form) {
            showToast(t('error'), 'error');
            return;
        }
        
        const nameEl = form.querySelector('#employee-name');
        const projectEl = form.querySelector('#employee-project');
        
        if (!nameEl || !projectEl) {
            showToast(t('error'), 'error');
            return;
        }
        
        const id = form.querySelector('#employee-id')?.value || '';
        const name = (nameEl.value || '').trim();
        const type = form.querySelector('#employee-type')?.value || 'daily';
        const projectId = projectEl.value || '';
        const startTime = form.querySelector('#employee-start')?.value || '08:00';
        const endTime = form.querySelector('#employee-end')?.value || '17:00';
        const phone = (form.querySelector('#employee-phone')?.value || '').trim();
        const jobTitle = (form.querySelector('#employee-job')?.value || '').trim();
        const note = (form.querySelector('#employee-notes')?.value || '').trim();
        const dailyWageInput = form.querySelector('#employee-daily-wage');
        const dailyWage = dailyWageInput ? parseFloat(dailyWageInput.value) || null : null;
        
        if (!name || !projectId) {
            showToast(t('required'), 'error');
            return;
        }
        
        try {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø§Ø³Ù…
            const existingQuery = await db.collection('employees')
                .where('name', '==', name)
                .get();
            
            let nameExists = false;
            existingQuery.forEach(doc => {
                // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                if (doc.id !== id) {
                    nameExists = true;
                }
            });
            
            if (nameExists) {
                showToast(t('employeeNameExists'), 'error');
                return;
            }
            
            const employeeData = {
                name,
                type,
                projectId,
                workSchedule: { startTime, endTime },
                phone,
                jobTitle,
                note,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠÙŠÙ† ÙÙ‚Ø·
            if (type === 'daily' && dailyWage !== null) {
                employeeData.dailyWage = dailyWage;
            } else if (type === 'daily') {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¸Ù ÙŠÙˆÙ…ÙŠ ÙˆÙ„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£Ø¬Ø±ØŒ Ù†ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹
                employeeData.dailyWage = null;
            }
            
            if (id) {
                // ØªØ¹Ø¯ÙŠÙ„
                const status = form.querySelector('#employee-status')?.value || 'active';
                employeeData.status = status;
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (Ù†Ù‚Ù„)
                const oldDoc = await db.collection('employees').doc(id).get();
                const oldData = oldDoc.data();
                const oldProjectId = oldData?.projectId;
                const oldDailyWage = oldData?.dailyWage;
                
                // Ø¥Ø¯Ø§Ø±Ø© Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¬ÙˆØ±: Ø¥Ø°Ø§ ØªØºÙŠØ± Ø§Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠØŒ Ù†Ø¶ÙŠÙ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯
                if (type === 'daily' && dailyWage !== null && dailyWage !== oldDailyWage) {
                    const now = new Date();
                    const currentMonth = now.getMonth() + 1; // 1-12
                    const currentYear = now.getFullYear();
                    
                    const wageHistory = oldData?.wageHistory || [];
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±
                    const existingMonthIndex = wageHistory.findIndex(
                        w => w.month === currentMonth && w.year === currentYear
                    );
                    
                    if (existingMonthIndex >= 0) {
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                        wageHistory[existingMonthIndex].wage = dailyWage;
                        wageHistory[existingMonthIndex].updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                    } else {
                        // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯
                        wageHistory.push({
                            month: currentMonth,
                            year: currentYear,
                            wage: dailyWage,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    employeeData.wageHistory = wageHistory;
                }
                
                await db.collection('employees').doc(id).update(employeeData);
                
                // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¥Ø°Ø§ ØªØºÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
                if (oldProjectId && oldProjectId !== projectId) {
                    await db.collection('projects').doc(oldProjectId).update({
                        employeesCount: firebase.firestore.FieldValue.increment(-1)
                    });
                    await db.collection('projects').doc(projectId).update({
                        employeesCount: firebase.firestore.FieldValue.increment(1)
                    });
                }
                logActivity('update', 'employee', id, name, currentLanguage === 'ar' ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¸Ù' : 'Employee updated');
            } else {
                // Ø¥Ø¶Ø§ÙØ©
                const counterDoc = await db.collection('settings').doc('counters').get();
                const counter = (counterDoc.data()?.employeeCounter || 0) + 1;
                const code = generateCode('EMP', counter);
                
                employeeData.code = code;
                employeeData.status = 'active';
                employeeData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                employeeData.createdBy = currentUser.uid;
                employeeData.transferHistory = [];
                
                // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¬Ø± Ø§Ù„Ø£ÙˆÙ„ÙŠ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠÙŠÙ†
                if (type === 'daily' && dailyWage !== null) {
                    const now = new Date();
                    const currentMonth = now.getMonth() + 1; // 1-12
                    const currentYear = now.getFullYear();
                    
                    employeeData.wageHistory = [{
                        month: currentMonth,
                        year: currentYear,
                        wage: dailyWage,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }];
                } else {
                    employeeData.wageHistory = [];
                }
                
                const empRef = await db.collection('employees').add(employeeData);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
                await db.collection('settings').doc('counters').update({
                    employeeCounter: counter
                });
                await db.collection('projects').doc(projectId).update({
                    employeesCount: firebase.firestore.FieldValue.increment(1)
                });
                logActivity('create', 'employee', empRef.id, name, currentLanguage === 'ar' ? 'Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù' : 'Employee created');
            }
            
            closeModal();
            showToast(t('saved'), 'success');
            loadEmployees();
            
        } catch (error) {
            console.error('Error saving employee:', error);
            showToast(t('error'), 'error');
        }
    }
    
    async function viewEmployee(employeeId) {
        const doc = await db.collection('employees').doc(employeeId).get();
        if (!doc.exists) return;
        
        const employee = { id: doc.id, ...doc.data() };
        const project = window.projectsListData?.find(p => p.id === employee.projectId);
        
        const content = `
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-mono text-gray-500">${employee.code}</span>
                    <span class="px-3 py-1 text-sm rounded-full ${employee.type === 'daily' ? 'bg-blue-100 text-blue-600' : 'bg-purple-100 text-purple-600'}">${t(employee.type)}</span>
                </div>
                
                <div>
                    <label class="text-sm text-gray-500">${t('employeeName')}</label>
                    <p class="font-medium text-lg">${employee.name}</p>
                </div>
                
                <div>
                    <label class="text-sm text-gray-500">${t('projects')}</label>
                    <p class="font-medium">${project?.name || '-'}</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-500">${t('workStart')}</label>
                        <p class="font-medium">${employee.workSchedule?.startTime || '-'}</p>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500">${t('workEnd')}</label>
                        <p class="font-medium">${employee.workSchedule?.endTime || '-'}</p>
                    </div>
                </div>
                
                ${employee.phone ? `
                <div>
                    <label class="text-sm text-gray-500">${t('phone')}</label>
                    <p class="font-medium">${employee.phone}</p>
                </div>
                ` : ''}
                
                ${employee.jobTitle ? `
                <div>
                    <label class="text-sm text-gray-500">${employee.type === 'monthly' ? t('position') : t('profession')}</label>
                    <p class="font-medium">${employee.jobTitle}</p>
                </div>
                ` : ''}
                
                ${employee.type === 'daily' ? `
                <div>
                    <label class="text-sm text-gray-500">${t('currentDailyWage')}</label>
                    <p class="font-medium">${employee.dailyWage ? employee.dailyWage.toFixed(2) + ' ' + (currentLanguage === 'ar' ? 'IQD' : 'IQD') : '-'}</p>
                </div>
                ` : ''}
                
                ${employee.type === 'daily' && employee.wageHistory?.length > 0 ? `
                <div class="pt-4 border-t">
                    <label class="text-sm text-gray-500 mb-2 block">${t('wageHistory')}</label>
                    <div class="space-y-2 max-h-48 overflow-y-auto">
                        ${employee.wageHistory.map(wh => {
                            const monthNames = currentLanguage === 'ar' 
                                ? ['', 'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±']
                                : ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                            const date = wh.createdAt?.toDate ? wh.createdAt.toDate() : (wh.updatedAt?.toDate ? wh.updatedAt.toDate() : null);
                            return `
                                <div class="text-sm bg-gray-50 p-2 rounded">
                                    ${monthNames[wh.month]} ${wh.year}: ${wh.wage.toFixed(2)} ${currentLanguage === 'ar' ? 'IQD' : 'IQD'}
                                    ${date ? ` (${formatDate(date)})` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${employee.transferHistory?.length > 0 ? `
                <div class="pt-4 border-t">
                    <label class="text-sm text-gray-500 mb-2 block">${t('transferRequest')}</label>
                    <div class="space-y-2">
                        ${employee.transferHistory.map(tr => `
                            <div class="text-sm bg-gray-50 p-2 rounded">
                                ${tr.fromProjectName} â†’ ${tr.toProjectName} (${formatDate(tr.date?.toDate?.() || tr.date)})
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
        
        const footer = `
            <button onclick="closeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-100 transition">${t('close')}</button>
            <button onclick="closeModal(); openEmployeeModal('${employee.id}')" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition">${t('edit')}</button>
        `;
        
        openModal(employee.name, content, footer);
    }
    
    // Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù†Ù‚Ù„
    async function openTransferModal(employeeId) {
        const doc = await db.collection('employees').doc(employeeId).get();
        if (!doc.exists) return;
        
        const employee = { id: doc.id, ...doc.data() };
        
        // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        let projects = [];
        try {
            const projectsSnap = await db.collection('projects').get();
            projectsSnap.forEach(doc => {
                const data = doc.data();
                // ÙÙ‚Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù†Ø´Ø·Ø© ÙˆØºÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ù…ÙˆØ¸Ù
                if (data.status === 'active' && doc.id !== employee.projectId) {
                    projects.push({ id: doc.id, ...data });
                }
            });
        } catch (e) {
            console.error('Error loading projects for transfer:', e);
            projects = window.projectsListData?.filter(p => p.id !== employee.projectId && p.status === 'active') || [];
        }
        
        const content = `
            <form id="transfer-form" class="space-y-4">
                <input type="hidden" id="transfer-employee-id" value="${employee.id}">
                <input type="hidden" id="transfer-from-project" value="${employee.projectId}">
                
                <div class="bg-gray-50 p-3 rounded-lg">
                    <p class="text-sm text-gray-500">${t('employees')}</p>
                    <p class="font-medium">${employee.name} (${employee.code})</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('projects')} ${t('to')} *</label>
                    <select id="transfer-to-project" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                        ${projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('date')} *</label>
                    <input type="date" id="transfer-date" required value="${new Date().toISOString().split('T')[0]}"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('notes')}</label>
                    <textarea id="transfer-note" rows="2"
                              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none"></textarea>
                </div>
            </form>
        `;
        
        const footer = `
            <button onclick="closeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-100 transition">${t('cancel')}</button>
            <button onclick="executeTransfer()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition">${t('confirm')}</button>
        `;
        
        openModal(t('transferRequest'), content, footer);
    }
    
    async function executeTransfer() {
        const form = document.getElementById('transfer-form');
        if (!form) {
            showToast(t('error'), 'error');
            return;
        }
        
        const toProjectEl = form.querySelector('#transfer-to-project');
        const dateEl = form.querySelector('#transfer-date');
        
        if (!toProjectEl || !dateEl) {
            showToast(t('error'), 'error');
            return;
        }
        
        const employeeId = form.querySelector('#transfer-employee-id')?.value || '';
        const fromProjectId = form.querySelector('#transfer-from-project')?.value || '';
        const toProjectId = toProjectEl.value || '';
        const date = dateEl.value || '';
        const note = (form.querySelector('#transfer-note')?.value || '').trim();
        
        if (!toProjectId || !date) {
            showToast(t('required'), 'error');
            return;
        }
        
        try {
            const fromProject = window.projectsListData?.find(p => p.id === fromProjectId);
            const toProject = window.projectsListData?.find(p => p.id === toProjectId);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¸Ù
            await db.collection('employees').doc(employeeId).update({
                projectId: toProjectId,
                transferHistory: firebase.firestore.FieldValue.arrayUnion({
                    fromProjectId,
                    fromProjectName: fromProject?.name,
                    toProjectId,
                    toProjectName: toProject?.name,
                    date: new Date(date),
                    note,
                    transferredBy: currentUser.uid,
                    transferredAt: new Date()
                }),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ù†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
            try {
                const oldAttendanceSnap = await db.collection('attendance')
                    .where('employeeId', '==', employeeId)
                    .where('projectId', '==', fromProjectId)
                    .get();
                
                if (!oldAttendanceSnap.empty) {
                    const updateBatch = db.batch();
                    oldAttendanceSnap.forEach(doc => {
                        updateBatch.update(doc.ref, {
                            projectId: toProjectId
                        });
                    });
                    await updateBatch.commit();
                }
            } catch (attError) {
                console.error('Error updating old attendance records:', attError);
                // Ù„Ø§ Ù†ÙˆÙ‚Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¥Ø°Ø§ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
            await db.collection('projects').doc(fromProjectId).update({
                employeesCount: firebase.firestore.FieldValue.increment(-1)
            });
            await db.collection('projects').doc(toProjectId).update({
                employeesCount: firebase.firestore.FieldValue.increment(1)
            });
            
            const empSnap = await db.collection('employees').doc(employeeId).get();
            const employeeName = empSnap.exists ? empSnap.data().name : employeeId;
            logActivity('update', 'employee', employeeId, employeeName, currentLanguage === 'ar' ? 'Ù†Ù‚Ù„ Ù…ÙˆØ¸Ù Ø¨ÙŠÙ† Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹' : 'Employee transferred');
            
            closeModal();
            showToast(t('saved'), 'success');
            loadEmployees();
            
        } catch (error) {
            console.error('Error transferring employee:', error);
            showToast(t('error'), 'error');
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ø§Ù„Ø¬Ù…Ù„Ø©
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function openBulkEmployeeModal() {
        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
        let projects = [];
        if (currentUserData.role === 'manager') {
            const snap = await db.collection('projects').get();
            snap.forEach(doc => {
                const data = doc.data();
                if (data.status !== 'hidden') {
                    projects.push({ id: doc.id, ...data });
                }
            });
        } else {
            const assignedProjects = currentUserData.assignedProjects || [];
            if (assignedProjects.length > 0) {
                const snap = await db.collection('projects').get();
                snap.forEach(doc => {
                    const data = doc.data();
                    if (assignedProjects.includes(doc.id) && data.status !== 'hidden') {
                        projects.push({ id: doc.id, ...data });
                    }
                });
            }
        }
        
        projects.sort((a, b) => a.name?.localeCompare(b.name, 'ar'));
        
        const content = `
            <form id="bulk-employee-form" class="space-y-4">
                <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ -->
                <div class="flex flex-wrap items-center gap-4 p-4 bg-gray-50 rounded-lg">
                    <div class="flex-1 min-w-[200px]">
                        <label class="block text-sm font-medium text-gray-700 mb-1">${t('project')} <span class="text-red-500">*</span></label>
                        <select id="bulk-project" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-500 outline-none" required>
                            <option value="">${t('selectProject')}</option>
                            ${projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" onclick="addBulkRow()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            ${t('addRow')}
                        </button>
                        <button type="button" onclick="clearBulkRows()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                            ${t('clearAll')}
                        </button>
                    </div>
                </div>
                
                <!-- ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù„ØµÙ‚ -->
                <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm text-blue-700">
                        ğŸ’¡ <strong>${t('pasteFromExcel')}:</strong> ${t('pasteInstructions')}
                    </p>
                </div>
                
                <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
                <div class="overflow-x-auto max-h-[500px] overflow-y-auto border rounded-lg">
                    <div class="p-2 bg-blue-50 border-b text-xs text-blue-700">
                        ğŸ’¡ ${t('pasteFromExcel')}: ${t('pasteInstructions')} - ${t('pasteDirectlyInCells')}
                    </div>
                    <table class="w-full" id="bulk-employees-table">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="px-3 py-2 text-right text-sm font-medium text-gray-700 w-12">${t('rowNumber')}</th>
                                <th class="px-3 py-2 text-right text-sm font-medium text-gray-700 min-w-[180px]">${t('name')} <span class="text-red-500">*</span></th>
                                <th class="px-3 py-2 text-right text-sm font-medium text-gray-700 w-32">${t('type')} <span class="text-red-500">*</span></th>
                                <th class="px-3 py-2 text-right text-sm font-medium text-gray-700 min-w-[130px]">${t('phone')}</th>
                                <th class="px-3 py-2 text-right text-sm font-medium text-gray-700 min-w-[150px]">${t('position')}/${t('profession')}</th>
                                <th class="px-3 py-2 text-center text-sm font-medium text-gray-700 w-12"></th>
                            </tr>
                        </thead>
                        <tbody id="bulk-employees-body">
                            <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙÙˆÙ Ù‡Ù†Ø§ -->
                        </tbody>
                    </table>
                </div>
            </form>
        `;
        
        const footer = `
            <button onclick="closeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-100 transition">${t('cancel')}</button>
            <button onclick="saveBulkEmployees()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                ${t('saveAll')}
            </button>
        `;
        
        openModal(t('bulkAddTitle'), content, footer, 'max-w-7xl');
        
        // Ø¥Ø¶Ø§ÙØ© 5 ØµÙÙˆÙ ÙØ§Ø±ØºØ©
        for (let i = 0; i < 5; i++) {
            addBulkRow();
        }
        
        // Ø¥Ø¶Ø§ÙØ© event listener Ù„Ù„ØµÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        setTimeout(() => {
            setupBulkTablePaste();
        }, 100);
    }
    
    let bulkRowCounter = 0;
    
    function addBulkRow() {
        bulkRowCounter++;
        const tbody = document.getElementById('bulk-employees-body');
        if (!tbody) return;
        
        const tr = document.createElement('tr');
        tr.id = `bulk-row-${bulkRowCounter}`;
        tr.className = 'border-b hover:bg-gray-50';
        tr.innerHTML = `
            <td class="px-3 py-2 text-center text-gray-500 text-sm">${tbody.children.length + 1}</td>
            <td class="px-2 py-1">
                <input type="text" class="bulk-name w-full border rounded px-2 py-1 text-sm focus:ring-2 focus:ring-primary-500 outline-none" placeholder="${t('name')}">
            </td>
            <td class="px-2 py-1">
                <select class="bulk-type w-full border rounded px-2 py-1 text-sm focus:ring-2 focus:ring-primary-500 outline-none">
                    <option value="">${t('select')}</option>
                    <option value="monthly">${t('typeMonthly')}</option>
                    <option value="daily">${t('typeDaily')}</option>
                </select>
            </td>
            <td class="px-2 py-1">
                <input type="tel" class="bulk-phone w-full border rounded px-2 py-1 text-sm focus:ring-2 focus:ring-primary-500 outline-none" placeholder="${t('phone')}">
            </td>
            <td class="px-2 py-1">
                <input type="text" class="bulk-job w-full border rounded px-2 py-1 text-sm focus:ring-2 focus:ring-primary-500 outline-none" placeholder="${t('position')}/${t('profession')}">
            </td>
            <td class="px-2 py-1 text-center">
                <button type="button" onclick="removeBulkRow('bulk-row-${bulkRowCounter}')" class="text-red-500 hover:text-red-700 p-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
        updateBulkRowNumbers();
    }
    
    function removeBulkRow(rowId) {
        const row = document.getElementById(rowId);
        if (row) {
            row.remove();
            updateBulkRowNumbers();
        }
    }
    
    function clearBulkRows() {
        const tbody = document.getElementById('bulk-employees-body');
        if (tbody) {
            tbody.innerHTML = '';
            bulkRowCounter = 0;
            // Ø¥Ø¶Ø§ÙØ© 5 ØµÙÙˆÙ ÙØ§Ø±ØºØ© Ø¬Ø¯ÙŠØ¯Ø©
            for (let i = 0; i < 5; i++) {
                addBulkRow();
            }
        }
    }
    
    function updateBulkRowNumbers() {
        const tbody = document.getElementById('bulk-employees-body');
        if (!tbody) return;
        
        Array.from(tbody.children).forEach((row, index) => {
            const numCell = row.querySelector('td:first-child');
            if (numCell) numCell.textContent = index + 1;
        });
    }
    
    function handleBulkPaste(event) {
        event.preventDefault();
        
        const pastedText = (event.clipboardData || window.clipboardData).getData('text');
        if (!pastedText) return;
        
        const tbody = document.getElementById('bulk-employees-body');
        if (!tbody) return;
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ù…Ù† Ø£ÙŠ Ø£Ø­Ø±Ù ØºÙŠØ± Ù…Ø±Ø¦ÙŠØ©
        const cleanText = pastedText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        
        // ØªÙ‚Ø³ÙŠÙ… Ø¥Ù„Ù‰ Ø³Ø·ÙˆØ±
        const lines = cleanText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
        
        if (lines.length === 0) return;
        
        // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ù†ÙŠØ©
        // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙƒÙ„ Ø³Ø·Ø± ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ tabØŒ ÙÙ‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ Ø¬Ø¯ÙˆÙ„ (ØµÙÙˆÙ ÙˆØ£Ø¹Ù…Ø¯Ø©)
        // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙƒÙ„ Ø³Ø·Ø± Ø¨Ø¯ÙˆÙ† tabØŒ ÙÙ‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯
        const firstLineHasTabs = lines[0].includes('\t');
        const allLinesHaveTabs = lines.every(line => line.includes('\t'));
        
        let addedCount = 0;
        
        if (allLinesHaveTabs || firstLineHasTabs) {
            // Ø¬Ø¯ÙˆÙ„ ÙƒØ§Ù…Ù„ Ø£Ùˆ ØµÙÙˆÙ Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
            lines.forEach(line => {
                // ÙØµÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¨Ù€ tab (Excel ÙŠØ³ØªØ®Ø¯Ù… tab)
                const cells = line.split('\t').map(cell => cell.trim());
                
                if (cells.length > 0 && cells[0]) {
                    // Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯
                    addBulkRow();
                    addedCount++;
                    
                    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± ØµÙ ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡
                    const lastRow = tbody.lastElementChild;
                    if (lastRow) {
                        const nameInput = lastRow.querySelector('.bulk-name');
                        const typeSelect = lastRow.querySelector('.bulk-type');
                        const phoneInput = lastRow.querySelector('.bulk-phone');
                        const jobInput = lastRow.querySelector('.bulk-job');
                        
                        // Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨: Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù†ÙˆØ¹ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ù…Ù†ØµØ¨
                        if (nameInput && cells[0]) nameInput.value = cells[0];
                        
                        if (typeSelect && cells[1]) {
                            const typeValue = cells[1].toLowerCase();
                            if (typeValue.includes('Ø´Ù‡Ø±ÙŠ') || typeValue.includes('monthly') || typeValue === 'Ø´Ù‡Ø±ÙŠ' || typeValue === 'monthly') {
                                typeSelect.value = 'monthly';
                            } else if (typeValue.includes('ÙŠÙˆÙ…ÙŠ') || typeValue.includes('daily') || typeValue === 'ÙŠÙˆÙ…ÙŠ' || typeValue === 'daily') {
                                typeSelect.value = 'daily';
                            }
                        }
                        
                        if (phoneInput && cells[2]) phoneInput.value = cells[2];
                        if (jobInput && cells[3]) jobInput.value = cells[3];
                    }
                }
            });
        } else {
            // Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ - ÙƒÙ„ Ø³Ø·Ø± = Ø§Ø³Ù… Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯
            lines.forEach(line => {
                if (line.trim()) {
                    // Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯
                    addBulkRow();
                    addedCount++;
                    
                    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± ØµÙ ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡
                    const lastRow = tbody.lastElementChild;
                    if (lastRow) {
                        const nameInput = lastRow.querySelector('.bulk-name');
                        if (nameInput) {
                            nameInput.value = line.trim();
                        }
                    }
                }
            });
        }
        
        // Ù…Ø³Ø­ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù„ØµÙ‚
        const pasteArea = document.getElementById('bulk-paste-area');
        if (pasteArea) pasteArea.value = '';
        
        if (addedCount > 0) {
            showToast(`${t('added')} ${addedCount} ${t('employees')}`, 'success');
        }
    }
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù„ØµÙ‚ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙÙŠ Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    function setupBulkTablePaste() {
        const tbody = document.getElementById('bulk-employees-body');
        if (!tbody) return;
        
        // Ø¥Ø¶Ø§ÙØ© event listener Ù„Ù„ØµÙ‚ Ø¹Ù„Ù‰ tbody (Ù…Ø¹ capture phase)
        tbody.addEventListener('paste', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù
            let target = e.target;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù input Ø£Ùˆ selectØŒ Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ td
            if (target.tagName === 'INPUT' || target.tagName === 'SELECT') {
                target = target.closest('td');
            }
            
            handleTablePaste(e, target);
        }, true);
        
        // Ø¥Ø¶Ø§ÙØ© event listener Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£ÙŠØ¶Ø§Ù‹
        const table = document.getElementById('bulk-employees-table');
        if (table) {
            table.addEventListener('paste', function(e) {
                // ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡ Ø¨Ø§Ù„ÙØ¹Ù„
                if (!e.target.closest('tbody')) {
                    e.preventDefault();
                    handleTablePaste(e);
                }
            });
        }
    }
    
    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù„ØµÙ‚ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    function handleTablePaste(event, targetCell = null) {
        const pastedText = (event.clipboardData || window.clipboardData).getData('text');
        if (!pastedText) return;
        
        const tbody = document.getElementById('bulk-employees-body');
        if (!tbody) return;
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ
        const cleanText = pastedText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        const lines = cleanText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
        
        if (lines.length === 0) return;
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©
        let startRow = 0;
        let startCol = 1; // ØªØ®Ø·ÙŠ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ù‚Ù… (Ø§Ù„Ø¹Ù…ÙˆØ¯ 0)
        
        if (targetCell) {
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙ ÙˆØ§Ù„Ø¹Ù…ÙˆØ¯ Ù„Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©
            const row = targetCell.closest('tr');
            if (row && tbody.contains(row)) {
                const rowIndex = Array.from(tbody.children).indexOf(row);
                if (rowIndex >= 0) {
                    startRow = rowIndex;
                }
                
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù…ÙˆØ¯
                const cells = Array.from(row.querySelectorAll('td'));
                const cellIndex = cells.indexOf(targetCell);
                if (cellIndex >= 0) {
                    startCol = cellIndex;
                }
            }
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ tabs (Ø¬Ø¯ÙˆÙ„ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©)
        const hasTabs = lines.some(line => line.includes('\t'));
        
        if (hasTabs) {
            // Ø¬Ø¯ÙˆÙ„ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
            lines.forEach((line, lineIndex) => {
                const rowIndex = startRow + lineIndex;
                const cells = line.split('\t').map(cell => cell.trim());
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØµÙ ÙƒØ§ÙÙ
                while (tbody.children.length <= rowIndex) {
                    addBulkRow();
                }
                
                const row = tbody.children[rowIndex];
                if (row) {
                    const rowCells = Array.from(row.querySelectorAll('td'));
                    
                    // Ù…Ù„Ø¡ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø¨Ø¯Ø¡Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ø­Ø¯Ø¯
                    let colOffset = 0;
                    cells.forEach((cellValue, cellIndex) => {
                        let colIndex = startCol + colOffset;
                        
                        // ØªØ®Ø·ÙŠ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ input/select (Ù…Ø«Ù„ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„Ø­Ø°Ù)
                        while (colIndex < rowCells.length) {
                            const td = rowCells[colIndex];
                            const input = td.querySelector('input, select');
                            
                            if (input) {
                                // ÙˆØ¬Ø¯Ù†Ø§ Ø®Ù„ÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ­Ø±ÙŠØ±
                                if (input.tagName === 'SELECT' && input.classList.contains('bulk-type')) {
                                    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ¸Ù
                                    const typeValue = cellValue.toLowerCase();
                                    if (typeValue.includes('Ø´Ù‡Ø±ÙŠ') || typeValue.includes('monthly') || typeValue === 'Ø´Ù‡Ø±ÙŠ' || typeValue === 'monthly') {
                                        input.value = 'monthly';
                                    } else if (typeValue.includes('ÙŠÙˆÙ…ÙŠ') || typeValue.includes('daily') || typeValue === 'ÙŠÙˆÙ…ÙŠ' || typeValue === 'daily') {
                                        input.value = 'daily';
                                    }
                                } else {
                                    input.value = cellValue;
                                }
                                colOffset++;
                                break;
                            } else {
                                // ØªØ®Ø·ÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ù„ÙŠØ©
                                colOffset++;
                                colIndex++;
                            }
                        }
                    });
                }
            });
        } else {
            // Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ - Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©
            lines.forEach((line, lineIndex) => {
                const rowIndex = startRow + lineIndex;
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØµÙ ÙƒØ§ÙÙ
                while (tbody.children.length <= rowIndex) {
                    addBulkRow();
                }
                
                const row = tbody.children[rowIndex];
                if (row) {
                    const rowCells = Array.from(row.querySelectorAll('td'));
                    
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ Ø®Ù„ÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ­Ø±ÙŠØ± Ø¨Ø¯Ø¡Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ø­Ø¯Ø¯
                    for (let colIndex = startCol; colIndex < rowCells.length; colIndex++) {
                        const td = rowCells[colIndex];
                        const input = td.querySelector('input, select');
                        
                        if (input) {
                            if (input.tagName === 'SELECT' && input.classList.contains('bulk-type')) {
                                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ¸Ù
                                const typeValue = line.toLowerCase();
                                if (typeValue.includes('Ø´Ù‡Ø±ÙŠ') || typeValue.includes('monthly') || typeValue === 'Ø´Ù‡Ø±ÙŠ' || typeValue === 'monthly') {
                                    input.value = 'monthly';
                                } else if (typeValue.includes('ÙŠÙˆÙ…ÙŠ') || typeValue.includes('daily') || typeValue === 'ÙŠÙˆÙ…ÙŠ' || typeValue === 'daily') {
                                    input.value = 'daily';
                                }
                            } else {
                                input.value = line;
                            }
                            break; // ØªÙˆÙ‚Ù Ø¨Ø¹Ø¯ Ù…Ù„Ø¡ Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰
                        }
                    }
                }
            });
        }
        
        updateBulkRowNumbers();
        showToast(`${t('dataUpdated')}`, 'success');
    }
    
    async function saveBulkEmployees() {
        const projectId = document.getElementById('bulk-project')?.value;
        if (!projectId) {
            showToast(t('selectProject'), 'error');
            return;
        }
        
        const tbody = document.getElementById('bulk-employees-body');
        if (!tbody) return;
        
        // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
        const employees = [];
        const rows = tbody.querySelectorAll('tr');
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙˆÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const existingSnap = await db.collection('employees').get();
        const existingNames = new Set();
        existingSnap.forEach(doc => {
            const data = doc.data();
            if (data.name) existingNames.add(data.name.toLowerCase().trim());
        });
        
        const localNames = new Set();
        let hasErrors = false;
        
        rows.forEach((row, index) => {
            const name = row.querySelector('.bulk-name')?.value?.trim() || '';
            const type = row.querySelector('.bulk-type')?.value || '';
            const phone = row.querySelector('.bulk-phone')?.value?.trim() || '';
            const jobTitle = row.querySelector('.bulk-job')?.value?.trim() || '';
            
            if (name && type) {
                const nameLower = name.toLowerCase();
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø­Ù„ÙŠ
                if (localNames.has(nameLower)) {
                    showToast(`${t('employeeNameExists')}: ${name}`, 'error');
                    hasErrors = true;
                    return;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (existingNames.has(nameLower)) {
                    showToast(`${t('employeeNameExists')}: ${name}`, 'error');
                    hasErrors = true;
                    return;
                }
                
                localNames.add(nameLower);
                employees.push({ name, type, phone, jobTitle });
            } else if (name || type) {
                // ØµÙ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø²Ø¦ÙŠØ©
                showToast(`${t('fillRequiredFields')} (${t('rowNumber')} ${index + 1})`, 'error');
                hasErrors = true;
            }
        });
        
        if (hasErrors) return;
        
        if (employees.length === 0) {
            showToast(t('noDataToSave'), 'error');
            return;
        }
        
        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
            const counterDoc = await db.collection('settings').doc('counters').get();
            let employeeCounter = counterDoc.exists ? (counterDoc.data().employeeCounter || 0) : 0;
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            const projectDoc = await db.collection('projects').doc(projectId).get();
            const projectData = projectDoc.exists ? projectDoc.data() : {};
            
            const batch = db.batch();
            
            employees.forEach(emp => {
                employeeCounter++;
                const code = `EMP-${String(employeeCounter).padStart(4, '0')}`;
                
                const docRef = db.collection('employees').doc();
                batch.set(docRef, {
                    code,
                    name: emp.name,
                    type: emp.type,
                    phone: emp.phone,
                    jobTitle: emp.jobTitle,
                    projectId,
                    status: 'active',
                    workSchedule: projectData.defaultSchedule || {
                        saturday: true, sunday: true, monday: true, tuesday: true, wednesday: true,
                        thursday: false, friday: false
                    },
                    transferHistory: [],
                    createdBy: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
            batch.update(db.collection('settings').doc('counters'), {
                employeeCounter
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
            batch.update(db.collection('projects').doc(projectId), {
                employeesCount: firebase.firestore.FieldValue.increment(employees.length)
            });
            
            await batch.commit();
            
            const projectName = projectData.name || projectId;
            logActivity('create', 'employee', projectId, projectName, currentLanguage === 'ar' ? `Ø¥Ø¶Ø§ÙØ© ${employees.length} Ù…ÙˆØ¸Ù` : `${employees.length} employees added`);
            
            closeModal();
            showToast(`${t('employeesAdded')} (${employees.length})`, 'success');
            loadEmployees();
            
        } catch (error) {
            console.error('Error saving bulk employees:', error);
            showToast(t('error'), 'error');
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¢Ù„ÙŠØ§Øª
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const vehicleTypes = ['truck', 'crane', 'excavator', 'mixer', 'pickup', 'car', 'heavy', 'other'];
    const vehicleIcons = {
        truck: 'ğŸš›',
        crane: 'ğŸ—ï¸',
        excavator: 'ğŸšœ',
        mixer: 'ğŸ”„',
        pickup: 'ğŸšš',
        car: 'ğŸš—',
        heavy: 'âš™ï¸',
        other: 'ğŸ“¦'
    };
    
    async function loadVehicles() {
        const container = document.getElementById('page-vehicles');
        container.innerHTML = `<div class="text-center py-8"><div class="loader mx-auto"></div></div>`;
        
        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
            let projectsSnap;
            if (currentUserData.role === 'supervisor' && currentUserData.assignedProjects && currentUserData.assignedProjects.length > 0) {
                projectsSnap = await db.collection('projects').where(firebase.firestore.FieldPath.documentId(), 'in', currentUserData.assignedProjects).get();
            } else {
                projectsSnap = await db.collection('projects').get();
            }
            const projects = [];
            projectsSnap.forEach(doc => {
                const data = doc.data();
                if (data.status !== 'hidden') {
                    projects.push({ id: doc.id, ...data });
                }
            });
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¢Ù„ÙŠØ§Øª
            let vehiclesSnap;
            if (currentUserData.role === 'supervisor' && currentUserData.assignedProjects && currentUserData.assignedProjects.length > 0) {
                vehiclesSnap = await db.collection('vehicles').where('projectId', 'in', currentUserData.assignedProjects).get();
            } else {
                vehiclesSnap = await db.collection('vehicles').get();
            }
            const vehicles = [];
            vehiclesSnap.forEach(doc => {
                const data = doc.data();
                if (data.status !== 'hidden') {
                    vehicles.push({ id: doc.id, ...data });
                }
            });
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
            const employeesSnap = await db.collection('employees').get();
            const employees = [];
            employeesSnap.forEach(doc => employees.push({ id: doc.id, ...doc.data() }));
            
            container.innerHTML = `
                <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="relative">
                            <input type="text" id="vehicles-search" placeholder="${t('search')}..." 
                                   class="pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none w-64"
                                   onkeyup="filterVehicles()">
                            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <select id="vehicles-project-filter" onchange="filterVehicles()" class="border rounded-lg px-4 py-2 outline-none focus:ring-2 focus:ring-primary-500">
                            <option value="all">${t('all')} ${t('projects')}</option>
                            ${projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                        </select>
                        <select id="vehicles-ownership-filter" onchange="filterVehicles()" class="border rounded-lg px-4 py-2 outline-none focus:ring-2 focus:ring-primary-500">
                            <option value="all">${t('all')}</option>
                            <option value="owned">${t('owned')}</option>
                            <option value="rented">${t('rented')}</option>
                        </select>
                    </div>
                    <button onclick="openVehicleModal()" class="bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        ${t('addVehicle')}
                    </button>
                </div>
                
                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¢Ù„ÙŠØ§Øª -->
                <div id="vehicles-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${vehicles.length === 0 ? `
                        <div class="col-span-full text-center py-12 text-gray-500">
                            <p class="text-5xl mb-4">ğŸš—</p>
                            <p>${t('noVehicles')}</p>
                        </div>
                    ` : vehicles.map(v => createVehicleCard(v, projects, employees)).join('')}
                </div>
            `;
            
            window.vehiclesData = vehicles;
            window.projectsListData = projects;
            window.employeesListData = employees;
            
        } catch (error) {
            console.error('Error loading vehicles:', error);
            container.innerHTML = `<p class="text-red-500 text-center py-8">${t('error')}</p>`;
        }
    }
    
    function createVehicleCard(vehicle, projects, employees) {
        const project = projects.find(p => p.id === vehicle.projectId);
        const driver = employees.find(e => e.id === vehicle.driverId);
        const icon = vehicleIcons[vehicle.type] || 'ğŸ“¦';
        
        return `
            <div class="card p-5 vehicle-card" data-id="${vehicle.id}" data-name="${vehicle.name}" 
                 data-project="${vehicle.projectId}" data-ownership="${vehicle.ownership}" data-status="${vehicle.status}">
                <div class="flex items-start justify-between mb-3">
                    <span class="text-xs font-mono text-gray-500">${vehicle.code}</span>
                    <span class="px-2 py-1 text-xs rounded-full ${vehicle.ownership === 'owned' ? 'bg-blue-100 text-blue-600' : 'bg-orange-100 text-orange-600'}">
                        ${vehicle.ownership === 'owned' ? 'ğŸ¢ ' + t('owned') : 'ğŸ“„ ' + t('rented')}
                    </span>
                </div>
                
                <div class="flex items-center gap-3 mb-3">
                    <span class="text-3xl">${icon}</span>
                    <div>
                        <h3 class="font-bold">${vehicle.name}</h3>
                        <p class="text-sm text-gray-500">${t(vehicle.type)}</p>
                    </div>
                </div>
                
                <div class="space-y-1 text-sm text-gray-500 mb-3">
                    <p><span class="font-medium">ğŸ“</span> ${project?.name || '-'}</p>
                    ${vehicle.plateNumber ? `<p><span class="font-medium">ğŸ”¢</span> ${vehicle.plateNumber}</p>` : ''}
                    ${driver ? `<p><span class="font-medium">ğŸ‘¤</span> ${driver.name}</p>` : ''}
                    ${vehicle.rentalCompany ? `<p><span class="font-medium">ğŸ¢</span> ${vehicle.rentalCompany}</p>` : ''}
                </div>
                
                <div class="flex items-center gap-2 pt-3 border-t">
                    <button onclick="viewVehicle('${vehicle.id}')" class="flex-1 px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                        ${t('view')}
                    </button>
                    <button onclick="openVehicleModal('${vehicle.id}')" class="px-3 py-2 text-sm hover:bg-gray-100 rounded-lg transition">
                        âœï¸
                    </button>
                </div>
            </div>
        `;
    }
    
    function filterVehicles() {
        const search = document.getElementById('vehicles-search').value.toLowerCase();
        const projectFilter = document.getElementById('vehicles-project-filter').value;
        const ownershipFilter = document.getElementById('vehicles-ownership-filter').value;
        
        document.querySelectorAll('.vehicle-card').forEach(card => {
            const name = card.dataset.name.toLowerCase();
            const project = card.dataset.project;
            const ownership = card.dataset.ownership;
            
            const matchesSearch = name.includes(search);
            const matchesProject = projectFilter === 'all' || project === projectFilter;
            const matchesOwnership = ownershipFilter === 'all' || ownership === ownershipFilter;
            
            card.style.display = matchesSearch && matchesProject && matchesOwnership ? 'block' : 'none';
        });
    }
    
    async function openVehicleModal(vehicleId = null) {
        let vehicle = null;
        let title = t('addVehicle');
        
        const projects = window.projectsListData || [];
        const employees = window.employeesListData || [];
        
        if (vehicleId) {
            const doc = await db.collection('vehicles').doc(vehicleId).get();
            if (doc.exists) {
                vehicle = { id: doc.id, ...doc.data() };
                title = t('editVehicle');
            }
        }
        
        const content = `
            <form id="vehicle-form" class="space-y-4">
                <input type="hidden" id="vehicle-id" value="${vehicle?.id || ''}">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('vehicleName')} *</label>
                    <input type="text" id="vehicle-name" required value="${vehicle?.name || ''}"
                           placeholder="${currentLanguage === 'ar' ? 'Ù…Ø«Ø§Ù„: Ø´Ø§Ø­Ù†Ø© Ù‡ÙŠÙ†Ùˆ 10 Ø·Ù†' : 'e.g., Hino Truck 10 Ton'}"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${t('vehicleType')} *</label>
                        <select id="vehicle-type" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                            ${vehicleTypes.map(type => `
                                <option value="${type}" ${vehicle?.type === type ? 'selected' : ''}>${vehicleIcons[type]} ${t(type)}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${t('ownership')} *</label>
                        <select id="vehicle-ownership" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none" onchange="toggleRentalField()">
                            <option value="owned" ${vehicle?.ownership === 'owned' ? 'selected' : ''}>${t('owned')}</option>
                            <option value="rented" ${vehicle?.ownership === 'rented' ? 'selected' : ''}>${t('rented')}</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('projects')} *</label>
                    <select id="vehicle-project" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                        ${projects.map(p => `<option value="${p.id}" ${vehicle?.projectId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                    </select>
                </div>
                
                <div id="rental-field" class="${vehicle?.ownership === 'rented' ? '' : 'hidden'}">
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('rentalCompany')}</label>
                    <input type="text" id="vehicle-rental" value="${vehicle?.rentalCompany || ''}"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${t('plateNumber')}</label>
                        <input type="text" id="vehicle-plate" value="${vehicle?.plateNumber || ''}"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${t('internalNumber')}</label>
                        <input type="text" id="vehicle-internal" value="${vehicle?.internalNumber || ''}"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('driver')} (${t('optional')})</label>
                    <select id="vehicle-driver" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                        <option value="">${t('select')}...</option>
                        ${employees.map(e => `<option value="${e.id}" ${vehicle?.driverId === e.id ? 'selected' : ''}>${e.name}</option>`).join('')}
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('notes')}</label>
                    <textarea id="vehicle-notes" rows="2"
                              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">${vehicle?.note || ''}</textarea>
                </div>
                
                ${vehicle ? `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('status')}</label>
                    <select id="vehicle-status" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                        <option value="active" ${vehicle.status === 'active' ? 'selected' : ''}>${t('active')}</option>
                        <option value="inactive" ${vehicle.status === 'inactive' ? 'selected' : ''}>${t('inactive')}</option>
                    </select>
                </div>
                ` : ''}
            </form>
        `;
        
        const footer = `
            <button onclick="closeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-100 transition">${t('cancel')}</button>
            <button onclick="saveVehicle()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition">${t('save')}</button>
        `;
        
        openModal(title, content, footer);
    }
    
    function toggleRentalField() {
        const ownershipEl = document.getElementById('vehicle-ownership');
        const rentalField = document.getElementById('rental-field');
        if (ownershipEl && rentalField) {
            rentalField.classList.toggle('hidden', ownershipEl.value !== 'rented');
        }
    }
    
    async function saveVehicle() {
        const form = document.getElementById('vehicle-form');
        if (!form) {
            showToast(t('error'), 'error');
            return;
        }
        
        const nameEl = form.querySelector('#vehicle-name');
        const projectEl = form.querySelector('#vehicle-project');
        
        if (!nameEl || !projectEl) {
            showToast(t('error'), 'error');
            return;
        }
        
        const id = form.querySelector('#vehicle-id')?.value || '';
        const name = (nameEl.value || '').trim();
        const type = form.querySelector('#vehicle-type')?.value || 'pickup';
        const ownership = form.querySelector('#vehicle-ownership')?.value || 'owned';
        const projectId = projectEl.value || '';
        const rentalCompany = (form.querySelector('#vehicle-rental')?.value || '').trim();
        const plateNumber = (form.querySelector('#vehicle-plate')?.value || '').trim();
        const internalNumber = (form.querySelector('#vehicle-internal')?.value || '').trim();
        const driverId = form.querySelector('#vehicle-driver')?.value || '';
        const note = (form.querySelector('#vehicle-notes')?.value || '').trim();
        
        if (!name || !projectId) {
            showToast(t('required'), 'error');
            return;
        }
        
        try {
            const driver = window.employeesListData?.find(e => e.id === driverId);
            
            const vehicleData = {
                name,
                type,
                ownership,
                projectId,
                rentalCompany: ownership === 'rented' ? rentalCompany : '',
                plateNumber,
                internalNumber,
                driverId: driverId || null,
                driverName: driver?.name || null,
                note,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (id) {
                // ØªØ¹Ø¯ÙŠÙ„
                const status = form.querySelector('#vehicle-status')?.value || 'active';
                vehicleData.status = status;
                
                const oldDoc = await db.collection('vehicles').doc(id).get();
                const oldProjectId = oldDoc.data()?.projectId;
                
                await db.collection('vehicles').doc(id).update(vehicleData);
                
                // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
                if (oldProjectId && oldProjectId !== projectId) {
                    await db.collection('projects').doc(oldProjectId).update({
                        vehiclesCount: firebase.firestore.FieldValue.increment(-1)
                    });
                    await db.collection('projects').doc(projectId).update({
                        vehiclesCount: firebase.firestore.FieldValue.increment(1)
                    });
                }
                logActivity('update', 'vehicle', id, vehicleData.name, currentLanguage === 'ar' ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¢Ù„ÙŠØ©' : 'Vehicle updated');
            } else {
                // Ø¥Ø¶Ø§ÙØ©
                const counterDoc = await db.collection('settings').doc('counters').get();
                const counter = (counterDoc.data()?.vehicleCounter || 0) + 1;
                const code = generateCode('VEH', counter);
                
                vehicleData.code = code;
                vehicleData.status = 'active';
                vehicleData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                vehicleData.createdBy = currentUser.uid;
                vehicleData.transferHistory = [];
                
                const vehicleRef = await db.collection('vehicles').add(vehicleData);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
                await db.collection('settings').doc('counters').update({
                    vehicleCounter: counter
                });
                await db.collection('projects').doc(projectId).update({
                    vehiclesCount: firebase.firestore.FieldValue.increment(1)
                });
                logActivity('create', 'vehicle', vehicleRef.id, vehicleData.name, currentLanguage === 'ar' ? 'Ø¥Ø¶Ø§ÙØ© Ø¢Ù„ÙŠØ©' : 'Vehicle created');
            }
            
            closeModal();
            showToast(t('saved'), 'success');
            loadVehicles();
            
        } catch (error) {
            console.error('Error saving vehicle:', error);
            showToast(t('error'), 'error');
        }
    }
    
    async function viewVehicle(vehicleId) {
        const doc = await db.collection('vehicles').doc(vehicleId).get();
        if (!doc.exists) return;
        
        const vehicle = { id: doc.id, ...doc.data() };
        const project = window.projectsListData?.find(p => p.id === vehicle.projectId);
        const driver = window.employeesListData?.find(e => e.id === vehicle.driverId);
        const icon = vehicleIcons[vehicle.type] || 'ğŸ“¦';
        
        const content = `
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-mono text-gray-500">${vehicle.code}</span>
                    <span class="px-3 py-1 text-sm rounded-full ${vehicle.ownership === 'owned' ? 'bg-blue-100 text-blue-600' : 'bg-orange-100 text-orange-600'}">
                        ${t(vehicle.ownership)}
                    </span>
                </div>
                
                <div class="flex items-center gap-4">
                    <span class="text-4xl">${icon}</span>
                    <div>
                        <p class="font-medium text-lg">${vehicle.name}</p>
                        <p class="text-gray-500">${t(vehicle.type)}</p>
                    </div>
                </div>
                
                <div>
                    <label class="text-sm text-gray-500">${t('projects')}</label>
                    <p class="font-medium">${project?.name || '-'}</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    ${vehicle.plateNumber ? `
                    <div>
                        <label class="text-sm text-gray-500">${t('plateNumber')}</label>
                        <p class="font-medium">${vehicle.plateNumber}</p>
                    </div>
                    ` : ''}
                    ${vehicle.internalNumber ? `
                    <div>
                        <label class="text-sm text-gray-500">${t('internalNumber')}</label>
                        <p class="font-medium">${vehicle.internalNumber}</p>
                    </div>
                    ` : ''}
                </div>
                
                ${driver ? `
                <div>
                    <label class="text-sm text-gray-500">${t('driver')}</label>
                    <p class="font-medium">${driver.name}</p>
                </div>
                ` : ''}
                
                ${vehicle.rentalCompany ? `
                <div>
                    <label class="text-sm text-gray-500">${t('rentalCompany')}</label>
                    <p class="font-medium">${vehicle.rentalCompany}</p>
                </div>
                ` : ''}
            </div>
        `;
        
        const footer = `
            <button onclick="closeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-100 transition">${t('close')}</button>
            <button onclick="closeModal(); openVehicleModal('${vehicle.id}')" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition">${t('edit')}</button>
        `;
        
        openModal(vehicle.name, content, footer);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    let attendanceData = {};
    let attendanceChanges = {};
    let selectedProject = null;
    let selectedMonth = new Date().getMonth();
    let selectedYear = new Date().getFullYear();
    let selectedWeek = 0;
    let activeTab = 'monthly';
    
    const attendanceStatuses = {
        employee: [
            { key: 'full_day', icon: 'ğŸŸ¢', color: 'bg-green-500' },
            { key: 'partial', icon: 'ğŸŸ¡', color: 'bg-yellow-500' },
            { key: 'absent', icon: 'ğŸ”´', color: 'bg-red-500' },
            { key: 'excusedAbsent', icon: 'ğŸŸ ', color: 'bg-orange-500' },
            { key: 'annualLeave', icon: 'ğŸ”µ', color: 'bg-blue-500' },
            { key: 'sickLeave', icon: 'ğŸŸ£', color: 'bg-purple-500' },
            { key: 'emergencyLeave', icon: 'ğŸ©·', color: 'bg-pink-500' },
            { key: 'unpaidLeave', icon: 'âšª', color: 'bg-gray-400' },
            { key: 'periodicLeave', icon: 'ğŸŸ¤', color: 'bg-amber-600' },
            { key: 'officialHoliday', icon: 'â¬œ', color: 'bg-gray-200' },
            { key: 'onMission', icon: 'ğŸ”·', color: 'bg-cyan-500' }
        ],
        vehicle: [
            { key: 'worked', icon: 'ğŸŸ¢', color: 'bg-green-500' },
            { key: 'workedPartial', icon: 'ğŸŸ¡', color: 'bg-yellow-500' },
            { key: 'broken', icon: 'ğŸ”´', color: 'bg-red-500' },
            { key: 'maintenance', icon: 'ğŸŸ ', color: 'bg-orange-500' },
            { key: 'idle', icon: 'âšª', color: 'bg-gray-400' },
            { key: 'officialHoliday', icon: 'â¬œ', color: 'bg-gray-200' },
            { key: 'onMission', icon: 'ğŸ”·', color: 'bg-cyan-500' }
        ]
    };
    
    async function loadAttendance() {
        const container = document.getElementById('page-attendance');
        container.innerHTML = `<div class="text-center py-8"><div class="loader mx-auto"></div></div>`;
        
        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
            let projectsQuery = db.collection('projects').where('status', '==', 'active');
            if ((currentUserData.role === 'supervisor' || currentUserData.role === 'approver') && currentUserData.assignedProjects && currentUserData.assignedProjects.length > 0) {
                projectsQuery = db.collection('projects').where(firebase.firestore.FieldPath.documentId(), 'in', currentUserData.assignedProjects);
            }
            const projectsSnap = await projectsQuery.get();
            const projects = [];
            projectsSnap.forEach(doc => projects.push({ id: doc.id, ...doc.data() }));
            
            if (!selectedProject && projects.length > 0) {
                selectedProject = projects[0].id;
            }
            
            container.innerHTML = `
                <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
                <div class="card p-4 mb-4">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div class="flex flex-wrap items-center gap-4">
                            <div>
                                <label class="block text-sm text-gray-500 mb-1">${t('projects')}</label>
                                <select id="attendance-project" onchange="changeAttendanceProject()" class="border rounded-lg px-4 py-2 outline-none focus:ring-2 focus:ring-primary-500">
                                    ${projects.map(p => `<option value="${p.id}" ${selectedProject === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-500 mb-1">${t('month')}</label>
                                <div class="flex items-center gap-2">
                                    <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded">â—„</button>
                                    <span id="current-month" class="font-medium min-w-[120px] text-center">
                                        ${t(getMonthName(selectedMonth))} ${selectedYear}
                                    </span>
                                    <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded">â–º</button>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 flex-wrap">
                            ${(currentUserData.role === 'approver' || currentUserData.role === 'manager') ? `
                            <button onclick="approveAttendanceWeek()" class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition flex items-center gap-2 text-sm font-medium">
                                âœ“ ${t('approveAttendance')}
                            </button>
                            <button onclick="openBulkApprovalModal()" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition flex items-center gap-2 text-sm font-medium border border-amber-400">
                                ğŸ“Œ ${t('partialApproval')}
                            </button>
                            ` : ''}
                            ${(currentUserData.role === 'supervisor' || currentUserData.role === 'manager') ? `
                            <button onclick="openBulkAttendanceModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center gap-2 text-sm font-medium">
                                ğŸ“‹ ${t('bulkAttendance')}
                            </button>
                            ` : ''}
                            <div id="save-status" class="flex items-center gap-2">
                                <span class="text-green-600 text-sm">âœ… ${t('saved')}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
                <div class="card overflow-hidden">
                    <div class="flex border-b">
                        <button onclick="switchAttendanceTab('monthly')" class="tab-btn ${activeTab === 'monthly' ? 'active' : ''}" data-tab="monthly">
                            ğŸ‘¥ ${t('monthly')}
                        </button>
                        <button onclick="switchAttendanceTab('daily')" class="tab-btn ${activeTab === 'daily' ? 'active' : ''}" data-tab="daily">
                            ğŸ‘· ${t('daily')}
                        </button>
                        <button onclick="switchAttendanceTab('vehicles')" class="tab-btn ${activeTab === 'vehicles' ? 'active' : ''}" data-tab="vehicles">
                            ğŸš— ${t('vehicles')}
                        </button>
                    </div>
                    
                    <!-- Ù…Ù„Ø®Øµ -->
                    <div id="attendance-summary" class="p-4 bg-gray-50 border-b">
                        <div class="flex flex-wrap items-center gap-4 text-sm">
                            <span id="summary-count">---</span>
                        </div>
                    </div>
                    
                    <!-- Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ -->
                    <div class="p-4 border-b flex items-center justify-center gap-4">
                        <button onclick="changeWeek(-1)" class="px-3 py-1 border rounded hover:bg-gray-100">â—„â—„</button>
                        <div id="weeks-nav" class="flex gap-2">
                            <!-- Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                        </div>
                        <button onclick="changeWeek(1)" class="px-3 py-1 border rounded hover:bg-gray-100">â–ºâ–º</button>
                    </div>
                    
                    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
                    <div id="attendance-table-container" class="overflow-x-auto p-4">
                        <div class="text-center py-8"><div class="loader mx-auto"></div></div>
                    </div>
                    
                    <!-- Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø£Ù„ÙˆØ§Ù† -->
                    <div id="attendance-legend" class="p-4 border-t bg-gray-50">
                        <!-- Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                    </div>
                    
                    <!-- Ø²Ø± Ø§Ù„Ø­ÙØ¸ -->
                    <div class="p-4 border-t flex items-center justify-between flex-wrap gap-2">
                        <div id="changes-count" class="text-sm text-gray-500"></div>
                        <button onclick="saveAttendance()" id="save-btn" class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition disabled:opacity-50" disabled>
                            ğŸ’¾ ${t('save')}
                        </button>
                    </div>
                </div>
            `;
            
            window.projectsListData = projects;
            
            // ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±
            await loadAttendanceTable();
            
        } catch (error) {
            console.error('Error loading attendance:', error);
            container.innerHTML = `<p class="text-red-500 text-center py-8">${t('error')}</p>`;
        }
    }
    
    function getMonthName(month) {
        const months = ['january', 'february', 'march', 'april', 'may', 'june', 
                       'july', 'august', 'september', 'october', 'november', 'december'];
        return months[month];
    }
    
    function getDaysInMonth(year, month) {
        return new Date(year, month + 1, 0).getDate();
    }
    
    function getDayName(date) {
        const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
        return days[date.getDay()];
    }
    
    function getWeeks(year, month) {
        const daysInMonth = getDaysInMonth(year, month);
        const weeks = [];
        let currentWeek = [];
        
        for (let day = 1; day <= daysInMonth; day++) {
            currentWeek.push(day);
            if (currentWeek.length === 7 || day === daysInMonth) {
                weeks.push([...currentWeek]);
                currentWeek = [];
            }
        }
        
        return weeks;
    }
    
    // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ
    function startAttendanceListener() {
        if (!selectedProject) return;
        
        // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø³Ø§Ø¨Ù‚
        if (attendanceUnsubscribe) {
            attendanceUnsubscribe();
        }
        
        const collection = activeTab === 'vehicles' ? 'vehicleAttendance' : 'attendance';
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª
        attendanceUnsubscribe = db.collection(collection)
            .where('projectId', '==', selectedProject)
            .onSnapshot(snapshot => {
                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                const startDate = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-01`;
                const endDate = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-${getDaysInMonth(selectedYear, selectedMonth)}`;
                
                // ØªØ­Ø¯ÙŠØ« ÙÙ‚Ø· Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©
                snapshot.docChanges().forEach(change => {
                    const data = change.doc.data();
                    const key = `${data.employeeId || data.vehicleId}_${data.date}`;
                    
                    if (data.date >= startDate && data.date <= endDate) {
                        if (change.type === 'removed') {
                            delete attendanceData[key];
                        } else {
                            attendanceData[key] = { id: change.doc.id, ...data };
                        }
                    }
                });
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª Ù…Ù† Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±
                // (ØªØ¬Ù†Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©)
                const hasRemoteChanges = snapshot.docChanges().some(change => {
                    const data = change.doc.data();
                    return data.recordedBy !== currentUser?.uid;
                });
                
                if (hasRemoteChanges && Object.keys(attendanceChanges).length === 0) {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒØ§Ù…Ù„Ø©
                    refreshAttendanceTableUI();
                }
            }, error => {
                console.error('Error listening to attendance:', error);
            });
    }
    
    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒØ§Ù…Ù„Ø©
    function refreshAttendanceTableUI() {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
        document.querySelectorAll('.attendance-cell').forEach(cell => {
            const itemId = cell.dataset.itemId;
            const date = cell.dataset.date;
            if (!itemId || !date) return;
            
            const key = `${itemId}_${date}`;
            const record = attendanceChanges[key] || attendanceData[key];
            
            const statuses = activeTab === 'vehicles' ? attendanceStatuses.vehicle : attendanceStatuses.employee;
            const statusInfo = record ? statuses.find(s => s.key === record.status) : null;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ù„ÙŠØ©
            cell.className = `attendance-cell w-10 h-10 rounded-lg flex items-center justify-center mx-auto text-lg ${statusInfo ? statusInfo.color + ' text-white' : 'bg-gray-100 hover:bg-gray-200'}`;
            cell.innerHTML = statusInfo ? statusInfo.icon : '';
        });
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ«
        showToast(t('dataUpdated'), 'info');
    }
    
    async function loadAttendanceTable() {
        const container = document.getElementById('attendance-table-container');
        if (!selectedProject) {
            container.innerHTML = `<p class="text-center py-8 text-gray-500">${t('select')} ${t('projects')}</p>`;
            return;
        }
        
        container.innerHTML = `<div class="text-center py-8"><div class="loader mx-auto"></div></div>`;
        
        // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª
        startAttendanceListener();
        
        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†/Ø§Ù„Ø¢Ù„ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
            let items = [];
            if (activeTab === 'vehicles') {
                const snap = await db.collection('vehicles')
                    .where('projectId', '==', selectedProject)
                    .where('status', '==', 'active')
                    .get();
                snap.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
            } else {
                const type = activeTab === 'monthly' ? 'monthly' : 'daily';
                const snap = await db.collection('employees')
                    .where('projectId', '==', selectedProject)
                    .where('type', '==', type)
                    .where('status', '==', 'active')
                    .get();
                snap.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                
                // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                if (!window.employeesData) window.employeesData = [];
                items.forEach(emp => {
                    if (!window.employeesData.find(e => e.id === emp.id)) {
                        window.employeesData.push(emp);
                    }
                });
            }
            
            // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù„Ø´Ù‡Ø±
            const startDate = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-01`;
            const endDate = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-${getDaysInMonth(selectedYear, selectedMonth)}`;
            
            const collection = activeTab === 'vehicles' ? 'vehicleAttendance' : 'attendance';
            const attendanceSnap = await db.collection(collection)
                .where('projectId', '==', selectedProject)
                .get();
            
            attendanceData = {};
            attendanceSnap.forEach(doc => {
                const data = doc.data();
                // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
                if (data.date >= startDate && data.date <= endDate) {
                    const key = `${data.employeeId || data.vehicleId}_${data.date}`;
                    attendanceData[key] = { id: doc.id, ...data };
                }
            });
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
            const weeks = getWeeks(selectedYear, selectedMonth);
            if (selectedWeek >= weeks.length) selectedWeek = 0;
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
            const weeksNav = document.getElementById('weeks-nav');
            weeksNav.innerHTML = weeks.map((week, index) => `
                <button onclick="goToWeek(${index})" class="px-3 py-1 rounded ${selectedWeek === index ? 'bg-primary-600 text-white' : 'border hover:bg-gray-100'}">
                    ${week[0]}-${week[week.length - 1]}
                </button>
            `).join('');
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            const currentWeekDays = weeks[selectedWeek];
            
            // Ø­ÙØ¸ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ
            window.attendanceTableItems = items;
            window.attendanceCurrentWeekDays = currentWeekDays;
            window.attendanceWeeks = weeks;
            
            if (items.length === 0) {
                container.innerHTML = `
                    <p class="text-center py-8 text-gray-500">
                        ${activeTab === 'vehicles' ? t('noVehicles') : t('noEmployees')}
                    </p>
                `;
                updateAttendanceLegend();
                updateAttendanceSummary(items);
                return;
            }
            
            let tableHTML = `
                <table class="w-full attendance-table">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-4 py-3 text-right sticky right-0 bg-gray-50 min-w-[180px]">
                                ${activeTab === 'vehicles' ? t('vehicles') : t('employees')}
                            </th>
                            ${currentWeekDays.map(day => {
                                const date = new Date(selectedYear, selectedMonth, day);
                                const dayName = getDayName(date);
                                const isToday = formatDate(date) === formatDate(new Date());
                                const isFriday = date.getDay() === 5;
                                return `
                                    <th class="px-2 py-2 text-center min-w-[50px] ${isToday ? 'bg-primary-100' : ''} ${isFriday ? 'bg-gray-100' : ''}">
                                        <div class="text-xs text-gray-500">${t(dayName)}</div>
                                        <div class="font-bold">${day}</div>
                                    </th>
                                `;
                            }).join('')}
                            <th class="px-4 py-3 text-center min-w-[100px] bg-gray-100">${t('summary')}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            items.forEach(item => {
                const itemId = item.id;
                let summary = { full: 0, partial: 0, absent: 0, leave: 0 };
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù„Ø®Øµ Ù„Ù„Ø´Ù‡Ø± ÙƒØ§Ù…Ù„
                for (let d = 1; d <= getDaysInMonth(selectedYear, selectedMonth); d++) {
                    const dateStr = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const key = `${itemId}_${dateStr}`;
                    const att = attendanceData[key] || attendanceChanges[key];
                    if (att) {
                        if (att.status === 'full_day' || att.status === 'worked') summary.full++;
                        else if (att.status === 'partial' || att.status === 'workedPartial') summary.partial++;
                        else if (att.status === 'absent') summary.absent++;
                        else if (att.status?.includes('Leave') || att.status?.includes('leave')) summary.leave++;
                    }
                }
                
                const total = summary.full + summary.partial;
                const workDays = getDaysInMonth(selectedYear, selectedMonth) - 4; // ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ 4 Ø£ÙŠØ§Ù… Ø¬Ù…Ø¹Ø©
                const percentage = workDays > 0 ? Math.round((total / workDays) * 100) : 0;
                
                tableHTML += `
                    <tr class="border-t hover:bg-gray-50">
                        <td class="px-4 py-3 sticky right-0 bg-white">
                            <div class="font-medium">${activeTab === 'vehicles' ? (vehicleIcons[item.type] || 'ğŸ“¦') + ' ' : ''}${item.name}</div>
                            <div class="text-xs text-gray-500">${item.code}</div>
                        </td>
                        ${currentWeekDays.map(day => {
                            const dateStr = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const key = `${itemId}_${dateStr}`;
                            const att = attendanceChanges[key] || attendanceData[key];
                            const status = att?.status || '';
                            const statusInfo = (activeTab === 'vehicles' ? attendanceStatuses.vehicle : attendanceStatuses.employee)
                                .find(s => s.key === status);
                            const date = new Date(selectedYear, selectedMonth, day);
                            const isToday = formatDate(date) === formatDate(new Date());
                            const isFriday = date.getDay() === 5;
                            
                            return `
                                <td class="px-1 py-1 text-center ${isToday ? 'bg-primary-50' : ''} ${isFriday ? 'bg-gray-50' : ''}">
                                    <button onclick="openAttendancePopup('${itemId}', '${item.name}', '${dateStr}', '${activeTab}')"
                                            data-item-id="${itemId}" data-date="${dateStr}"
                                            class="attendance-cell w-10 h-10 rounded-lg flex items-center justify-center mx-auto text-lg
                                                   ${statusInfo ? statusInfo.color + ' text-white' : 'bg-gray-100 hover:bg-gray-200'}">
                                        ${statusInfo ? statusInfo.icon : ''}
                                    </button>
                                </td>
                            `;
                        }).join('')}
                        <td class="px-2 py-2 text-center bg-gray-50">
                            <div class="text-xs space-y-1">
                                <div>ğŸŸ¢${summary.full} ğŸŸ¡${summary.partial}</div>
                                <div>ğŸ”´${summary.absent} ğŸ”µ${summary.leave}</div>
                                <div class="font-bold text-primary-600">${percentage}%</div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            updateAttendanceLegend();
            updateAttendanceSummary(items);
            
        } catch (error) {
            console.error('Error loading attendance table:', error);
            container.innerHTML = `<p class="text-red-500 text-center py-8">${t('error')}</p>`;
        }
    }
    
    function updateAttendanceLegend() {
        const legend = document.getElementById('attendance-legend');
        const statuses = activeTab === 'vehicles' ? attendanceStatuses.vehicle : attendanceStatuses.employee;
        
        legend.innerHTML = `
            <div class="flex flex-wrap gap-3 text-sm">
                ${statuses.map(s => `
                    <span class="flex items-center gap-1">
                        <span class="w-4 h-4 rounded ${s.color}"></span>
                        ${s.icon} ${t(s.key)}
                    </span>
                `).join('')}
            </div>
        `;
    }
    
    function updateAttendanceSummary(items) {
        const summary = document.getElementById('attendance-summary');
        summary.innerHTML = `
            <div class="flex flex-wrap items-center gap-4 text-sm">
                <span class="font-medium">
                    ${activeTab === 'vehicles' ? t('vehicles') : t('employees')}: ${items.length}
                </span>
                <span>|</span>
                <span>${t('month')}: ${t(getMonthName(selectedMonth))} ${selectedYear}</span>
            </div>
        `;
    }
    
    function canEditAttendance(key) {
        const existing = attendanceData[key];
        if (!existing) return true;
        if (existing.approved === true && currentUserData.role !== 'manager') return false;
        if (currentUserData.role === 'approver') return false;
        if (currentUserData.role === 'supervisor' && existing.id) {
            const createdAt = existing.createdAt?.toMillis ? existing.createdAt.toMillis() : (existing.createdAt ? new Date(existing.createdAt).getTime() : 0);
            if (createdAt && (Date.now() - createdAt) > 24 * 60 * 60 * 1000) return false;
        }
        return true;
    }
    
    async function openAttendancePopup(itemId, itemName, dateStr, type) {
        const statuses = type === 'vehicles' ? attendanceStatuses.vehicle : attendanceStatuses.employee;
        const key = `${itemId}_${dateStr}`;
        const currentData = attendanceChanges[key] || attendanceData[key] || {};
        const existingRecord = attendanceData[key];
        const canEdit = canEditAttendance(key);
        const currentStatus = currentData.status || '';
        const currentNote = currentData.note || '';
        const partialDetails = currentData.partialDetails || {};
        const missionDetails = currentData.missionDetails || {};
        
        let readOnlyMessage = '';
        if (!canEdit && existingRecord?.approved) readOnlyMessage = t('onlyManagerCanEditApproved');
        else if (!canEdit && currentUserData.role === 'supervisor') readOnlyMessage = t('cannotEditAfter24h');
        else if (!canEdit && currentUserData.role === 'approver') readOnlyMessage = t('approver') + ' - ' + t('notApproved');
        
        const dateParts = dateStr.split('-');
        const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
        
        // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ù‡Ù…Ø©
        let otherProjects = [];
        try {
            const projectsSnap = await db.collection('projects').get();
            projectsSnap.forEach(doc => {
                const data = doc.data();
                // ÙÙ‚Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù†Ø´Ø·Ø© ÙˆØºÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
                if (data.status === 'active' && doc.id !== selectedProject) {
                    otherProjects.push({ id: doc.id, ...data });
                }
            });
        } catch (e) {
            console.error('Error loading projects for mission:', e);
            otherProjects = (window.projectsListData || []).filter(p => p.id !== selectedProject && p.status === 'active');
        }
        
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
        window.currentAttendanceData = { itemId, itemName, dateStr, type, currentStatus, partialDetails, missionDetails, otherProjects };
        
        const content = `
            <div class="space-y-4">
                <div class="text-center pb-4 border-b">
                    <p class="font-bold text-lg">${itemName}</p>
                    <p class="text-gray-500">${formattedDate}</p>
                    ${existingRecord?.approved ? `<p class="text-sm text-green-600 mt-1">âœ“ ${t('approved')}</p>` : ''}
                </div>
                ${readOnlyMessage ? `<p class="p-3 bg-amber-50 border border-amber-200 rounded-lg text-amber-800 text-sm">${readOnlyMessage}</p>` : ''}
                
                ${canEdit ? `
                <div class="grid grid-cols-2 gap-2" id="status-buttons">
                    ${statuses.map(s => `
                        <button onclick="selectAttendanceStatus('${s.key}')"
                                id="status-btn-${s.key}"
                                class="p-3 rounded-lg border-2 flex items-center gap-2 hover:bg-gray-50 transition
                                       ${currentStatus === s.key ? 'border-primary-500 bg-primary-50' : 'border-gray-200'}">
                            <span class="text-xl">${s.icon}</span>
                            <span class="text-sm">${t(s.key)}</span>
                        </button>
                    `).join('')}
                </div>
                
                <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© -->
                <div id="mission-details-section" class="${type === 'vehicles' || currentStatus !== 'onMission' ? 'hidden' : ''} p-4 bg-blue-50 rounded-lg border border-blue-200 space-y-4">
                    <p class="font-bold text-sm text-blue-800">ğŸ“ ${t('missionDetails')}</p>
                    
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 p-2 bg-white rounded border cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="mission-type" id="mission-internal" value="internal" 
                                   ${missionDetails.type !== 'external' ? 'checked' : ''} onchange="toggleMissionType()">
                            <span>${t('internalMission')}</span>
                        </label>
                        
                        <div id="mission-project-select" class="${missionDetails.type === 'external' ? 'hidden' : ''} ml-6">
                            <select id="mission-project" class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-primary-500">
                                <option value="">${t('selectProject')}</option>
                                ${otherProjects.map(p => `
                                    <option value="${p.id}" ${missionDetails.projectId === p.id ? 'selected' : ''}>${p.name}</option>
                                `).join('')}
                            </select>
                            <p class="text-xs text-blue-600 mt-2">ğŸ’¡ ${t('missionNotification')}</p>
                        </div>
                        
                        <label class="flex items-center gap-3 p-2 bg-white rounded border cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="mission-type" id="mission-external" value="external"
                                   ${missionDetails.type === 'external' ? 'checked' : ''} onchange="toggleMissionType()">
                            <span>${t('externalMission')}</span>
                        </label>
                        
                        <div id="mission-external-details" class="${missionDetails.type !== 'external' ? 'hidden' : ''} ml-6">
                            <input type="text" id="mission-location" value="${missionDetails.location || ''}"
                                   placeholder="${t('missionLocation')}"
                                   class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-primary-500">
                        </div>
                    </div>
                </div>
                
                <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ø¬Ø²Ø¦ÙŠ -->
                <div id="partial-details-section" class="${type === 'vehicles' || currentStatus !== 'partial' ? 'hidden' : ''} p-4 bg-yellow-50 rounded-lg border border-yellow-200 space-y-4">
                    <p class="font-bold text-sm text-yellow-800">â° ${t('partialDetails')}</p>
                    
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 p-2 bg-white rounded border cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="partial-late" class="rounded text-primary-600" 
                                   ${partialDetails.lateArrival ? 'checked' : ''} onchange="togglePartialTime('late')">
                            <span class="flex-1">${t('lateArrival')}</span>
                            <input type="time" id="partial-late-time" value="${partialDetails.arrivalTime || ''}"
                                   class="px-2 py-1 border rounded text-sm ${partialDetails.lateArrival ? '' : 'hidden'}"
                                   placeholder="${t('arrivalTime')}">
                        </label>
                        
                        <label class="flex items-center gap-3 p-2 bg-white rounded border cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="partial-early" class="rounded text-primary-600"
                                   ${partialDetails.earlyLeave ? 'checked' : ''} onchange="togglePartialTime('early')">
                            <span class="flex-1">${t('earlyLeave')}</span>
                            <input type="time" id="partial-early-time" value="${partialDetails.leaveTime || ''}"
                                   class="px-2 py-1 border rounded text-sm ${partialDetails.earlyLeave ? '' : 'hidden'}"
                                   placeholder="${t('leaveTime')}">
                        </label>
                        
                        <label class="flex items-center gap-3 p-2 bg-white rounded border cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="partial-break" class="rounded text-primary-600"
                                   ${partialDetails.breakOut ? 'checked' : ''} onchange="togglePartialTime('break')">
                            <span class="flex-1">${t('breakOut')}</span>
                        </label>
                        
                        <div id="break-times" class="${partialDetails.breakOut ? '' : 'hidden'} ml-6 space-y-2 p-2 bg-gray-50 rounded">
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-600">${t('exitTime')}:</span>
                                <input type="time" id="partial-break-out" value="${partialDetails.breakOutTime || ''}"
                                       class="px-2 py-1 border rounded text-sm">
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-600">${t('returnTime')}:</span>
                                <input type="time" id="partial-break-in" value="${partialDetails.breakInTime || ''}"
                                       class="px-2 py-1 border rounded text-sm">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 text-xs text-gray-500 pt-2 border-t">
                        <span class="bg-gray-100 px-2 py-1 rounded">${t('workHours')}: <span id="worked-hours">--</span></span>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('notes')}</label>
                    <textarea id="attendance-note" rows="2" class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-primary-500">${currentNote}</textarea>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="clearAttendanceStatus('${itemId}', '${dateStr}')" class="flex-1 py-2 text-red-600 hover:bg-red-50 rounded-lg transition border border-red-200">
                        âŒ ${t('delete')}
                    </button>
                    <button onclick="saveCurrentAttendance()" class="flex-1 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition">
                        âœ“ ${t('save')}
                    </button>
                </div>
                ` : ''}
            </div>
        `;
        
        openModal(t('attendance'), content, '');
    }
    
    // ØªØ¨Ø¯ÙŠÙ„ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù…Ø©
    function toggleMissionType() {
        const internalRadio = document.getElementById('mission-internal');
        const projectSelect = document.getElementById('mission-project-select');
        const externalDetails = document.getElementById('mission-external-details');
        
        if (internalRadio && projectSelect && externalDetails) {
            if (internalRadio.checked) {
                projectSelect.classList.remove('hidden');
                externalDetails.classList.add('hidden');
            } else {
                projectSelect.classList.add('hidden');
                externalDetails.classList.remove('hidden');
            }
        }
    }
    
    // ØªØ¨Ø¯ÙŠÙ„ Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙˆÙ‚Øª
    function togglePartialTime(type) {
        if (type === 'late') {
            const checkbox = document.getElementById('partial-late');
            const timeInput = document.getElementById('partial-late-time');
            if (checkbox && timeInput) {
                timeInput.classList.toggle('hidden', !checkbox.checked);
            }
        } else if (type === 'early') {
            const checkbox = document.getElementById('partial-early');
            const timeInput = document.getElementById('partial-early-time');
            if (checkbox && timeInput) {
                timeInput.classList.toggle('hidden', !checkbox.checked);
            }
        } else if (type === 'break') {
            const checkbox = document.getElementById('partial-break');
            const breakTimes = document.getElementById('break-times');
            if (checkbox && breakTimes) {
                breakTimes.classList.toggle('hidden', !checkbox.checked);
            }
        }
    }
    
    // Ø§Ø®ØªÙŠØ§Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¶ÙˆØ±
    function selectAttendanceStatus(status) {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        document.querySelectorAll('#status-buttons button').forEach(btn => {
            btn.classList.remove('border-primary-500', 'bg-primary-50');
            btn.classList.add('border-gray-200');
        });
        const selectedBtn = document.getElementById(`status-btn-${status}`);
        if (selectedBtn) {
            selectedBtn.classList.remove('border-gray-200');
            selectedBtn.classList.add('border-primary-500', 'bg-primary-50');
        }
        
        // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
        window.currentAttendanceData.selectedStatus = status;
        
        // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ø¬Ø²Ø¦ÙŠ
        const partialSection = document.getElementById('partial-details-section');
        if (partialSection && window.currentAttendanceData.type !== 'vehicles') {
            partialSection.classList.toggle('hidden', status !== 'partial');
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©
        const missionSection = document.getElementById('mission-details-section');
        if (missionSection && window.currentAttendanceData.type !== 'vehicles') {
            missionSection.classList.toggle('hidden', status !== 'onMission');
        }
    }
    
    // Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ
    async function saveCurrentAttendance() {
        const data = window.currentAttendanceData;
        if (!data) return;
        
        const status = data.selectedStatus || data.currentStatus;
        if (!status) {
            showToast(t('selectStatus'), 'error');
            return;
        }
        
        const key = `${data.itemId}_${data.dateStr}`;
        const note = document.getElementById('attendance-note')?.value || '';
        
        const attendanceRecord = {
            [data.type === 'vehicles' ? 'vehicleId' : 'employeeId']: data.itemId,
            projectId: selectedProject,
            date: data.dateStr,
            status: status,
            note: note,
            recordedBy: currentUser.uid,
            recordedAt: new Date()
        };
        
        // Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ø¬Ø²Ø¦ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø¬Ø²Ø¦ÙŠ
        if (status === 'partial' && data.type !== 'vehicles') {
            const partialDetails = {};
            
            const lateCheckbox = document.getElementById('partial-late');
            if (lateCheckbox?.checked) {
                partialDetails.lateArrival = true;
                partialDetails.arrivalTime = document.getElementById('partial-late-time')?.value || '';
            }
            
            const earlyCheckbox = document.getElementById('partial-early');
            if (earlyCheckbox?.checked) {
                partialDetails.earlyLeave = true;
                partialDetails.leaveTime = document.getElementById('partial-early-time')?.value || '';
            }
            
            const breakCheckbox = document.getElementById('partial-break');
            if (breakCheckbox?.checked) {
                partialDetails.breakOut = true;
                partialDetails.breakOutTime = document.getElementById('partial-break-out')?.value || '';
                partialDetails.breakInTime = document.getElementById('partial-break-in')?.value || '';
            }
            
            attendanceRecord.partialDetails = partialDetails;
        }
        
        // Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ù…Ù‡Ù…Ø©
        if (status === 'onMission' && data.type !== 'vehicles') {
            const internalRadio = document.getElementById('mission-internal');
            const missionDetails = {};
            
            if (internalRadio?.checked) {
                // Ù…Ù‡Ù…Ø© Ø¯Ø§Ø®Ù„ÙŠØ© - Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¢Ø®Ø±
                const missionProjectId = document.getElementById('mission-project')?.value;
                if (!missionProjectId) {
                    showToast(t('selectMissionProject'), 'error');
                    return;
                }
                
                // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø­Ù…Ù„Ø© ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø£Ùˆ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
                const missionProject = (data.otherProjects || window.projectsListData || []).find(p => p.id === missionProjectId);
                missionDetails.type = 'internal';
                missionDetails.projectId = missionProjectId;
                missionDetails.projectName = missionProject?.name || '';
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¢Ø®Ø±
                attendanceRecord.missionNotification = {
                    targetProjectId: missionProjectId,
                    status: 'pending', // pending, confirmed, rejected
                    sentAt: new Date()
                };
            } else {
                // Ù…Ù‡Ù…Ø© Ø®Ø§Ø±Ø¬ÙŠØ©
                missionDetails.type = 'external';
                missionDetails.location = document.getElementById('mission-location')?.value || '';
            }
            
            attendanceRecord.missionDetails = missionDetails;
        }
        
        attendanceChanges[key] = attendanceRecord;
        
        closeModal();
        updateSaveButton();
        loadAttendanceTable();
    }
    
    // Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…
    function setAttendanceStatus(itemId, dateStr, status, type) {
        window.currentAttendanceData = { itemId, dateStr, type, selectedStatus: status };
        selectAttendanceStatus(status);
        
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø¬Ø²Ø¦ÙŠ Ø£Ùˆ Ù…Ù‡Ù…Ø©ØŒ Ø§Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø±Ø©
        if ((status !== 'partial' && status !== 'onMission') || type === 'vehicles') {
            saveCurrentAttendance();
        }
    }
    
    function clearAttendanceStatus(itemId, dateStr) {
        const key = `${itemId}_${dateStr}`;
        attendanceChanges[key] = { _delete: true, date: dateStr, itemId };
        
        closeModal();
        updateSaveButton();
        loadAttendanceTable();
    }
    
    function updateSaveButton() {
        const changesCount = Object.keys(attendanceChanges).length;
        const btn = document.getElementById('save-btn');
        const countEl = document.getElementById('changes-count');
        const statusEl = document.getElementById('save-status');
        
        if (btn) btn.disabled = changesCount === 0;
        if (countEl) countEl.textContent = changesCount > 0 ? `âš ï¸ ${changesCount} ${t('unsavedChanges')}` : '';
        if (statusEl) statusEl.innerHTML = changesCount > 0 ? 
            `<span class="text-yellow-600 text-sm">âš ï¸ ${t('unsavedChanges')}</span>` :
            `<span class="text-green-600 text-sm">âœ… ${t('saved')}</span>`;
    }
    
    // ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø¬Ù…Ø§Ø¹ÙŠ
    function openBulkAttendanceModal() {
        const items = window.attendanceTableItems || [];
        const weekDays = window.attendanceCurrentWeekDays || [];
        
        if (items.length === 0) {
            showToast(activeTab === 'vehicles' ? t('noVehicles') : t('noEmployees'), 'error');
            return;
        }
        
        if (weekDays.length === 0) {
            showToast(t('select') + ' ' + t('week'), 'error');
            return;
        }
        
        const statuses = activeTab === 'vehicles' ? attendanceStatuses.vehicle : attendanceStatuses.employee;
        
        const content = `
            <div class="space-y-6 text-base">
                <!-- Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® -->
                <div class="p-5 bg-gray-50 rounded-xl border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <span class="text-2xl">ğŸ“…</span> ${t('selectDates')}
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">${t('bulkDatesHint')}</p>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                        ${weekDays.map(day => {
                            const dateStr = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const date = new Date(selectedYear, selectedMonth, day);
                            const dayName = getDayName(date);
                            return `
                                <label class="flex items-center gap-3 p-4 bg-white border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-400 hover:bg-primary-50 transition">
                                    <input type="checkbox" class="bulk-date-checkbox rounded w-5 h-5" value="${dateStr}" name="bulk-dates">
                                    <span class="font-medium">${day} ${t(dayName)}</span>
                                </label>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Ø§Ù„Ø­Ø§Ù„Ø© -->
                <div class="p-5 bg-gray-50 rounded-xl border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <span class="text-2xl">ğŸ“‹</span> ${t('status')}
                    </h3>
                    <p class="text-sm text-gray-600 mb-3">${t('bulkStatusHint')}</p>
                    <select id="bulk-status" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-base focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none">
                        ${statuses.map(s => `<option value="${s.key}">${s.icon} ${t(s.key)}</option>`).join('')}
                    </select>
                </div>
                
                <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ -->
                <div class="p-5 bg-gray-50 rounded-xl border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <span class="text-2xl">ğŸ‘¥</span> ${t('applyTo')}
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">${t('bulkApplyHint')}</p>
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 p-4 bg-white border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-400 hover:bg-primary-50 transition bulk-scope-label">
                            <input type="radio" name="bulk-scope" value="all" class="bulk-scope-radio w-5 h-5" checked>
                            <span class="font-semibold text-gray-800">${t('applyToAll')}</span>
                            <span class="text-gray-500">(${items.length} ${activeTab === 'vehicles' ? t('vehicles') : t('employees')})</span>
                        </label>
                        <label class="flex items-center gap-3 p-4 bg-white border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-400 hover:bg-primary-50 transition bulk-scope-label">
                            <input type="radio" name="bulk-scope" value="selected" class="bulk-scope-radio w-5 h-5">
                            <span class="font-semibold text-gray-800">${t('select')} ${t('specific')}</span>
                        </label>
                    </div>
                    <div class="mt-4 max-h-56 overflow-y-auto border-2 border-gray-200 rounded-xl p-4 bg-white" id="bulk-items-container">
                        <p class="text-sm text-gray-500 mb-2">${t('bulkSelectItems')}</p>
                        <div class="space-y-2" id="bulk-items-list">
                            ${items.map(item => `
                                <label class="flex items-center gap-3 p-3 rounded-lg cursor-pointer hover:bg-gray-100 bulk-item-label">
                                    <input type="checkbox" class="bulk-item-checkbox rounded w-4 h-4" value="${item.id}" disabled>
                                    <span class="text-base">${activeTab === 'vehicles' ? (vehicleIcons[item.type] || '') + ' ' : ''}${item.name}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const footer = `
            <button onclick="closeModal()" class="px-6 py-3 border-2 border-gray-300 rounded-xl hover:bg-gray-100 transition font-medium">${t('cancel')}</button>
            <button onclick="applyBulkAttendance()" class="px-6 py-3 bg-primary-600 text-white rounded-xl hover:bg-primary-700 transition font-semibold">
                âœ“ ${t('applyBulk')}
            </button>
        `;
        
        openModal(t('bulkAttendanceTitle'), content, footer, 'max-w-4xl');
        
        // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ checkboxes Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ø·Ø§Ù‚
        document.querySelectorAll('.bulk-scope-radio').forEach(radio => {
            radio.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.bulk-item-checkbox');
                const useSelected = this.value === 'selected';
                checkboxes.forEach(cb => {
                    cb.disabled = !useSelected;
                    if (!useSelected) cb.checked = false;
                });
            });
        });
    }
    
    function applyBulkAttendance() {
        const dateCheckboxes = document.querySelectorAll('.bulk-date-checkbox:checked');
        const status = document.getElementById('bulk-status')?.value;
        
        if (!status) {
            showToast(t('select') + ' ' + t('status'), 'error');
            return;
        }
        
        if (dateCheckboxes.length === 0) {
            showToast(t('selectDates'), 'error');
            return;
        }
        
        const dates = Array.from(dateCheckboxes).map(cb => cb.value);
        const useAll = document.querySelector('input[name="bulk-scope"][value="all"]')?.checked;
        const items = window.attendanceTableItems || [];
        
        let selectedItems = items;
        if (!useAll) {
            const selectedIds = Array.from(document.querySelectorAll('.bulk-item-checkbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) {
                showToast(t('select') + ' ' + (activeTab === 'vehicles' ? t('vehicles') : t('employees')), 'error');
                return;
            }
            selectedItems = items.filter(item => selectedIds.includes(item.id));
        }
        
        const itemIdKey = activeTab === 'vehicles' ? 'vehicleId' : 'employeeId';
        
        let applied = 0;
        dates.forEach(dateStr => {
            selectedItems.forEach(item => {
                const key = `${item.id}_${dateStr}`;
                attendanceChanges[key] = {
                    projectId: selectedProject,
                    [itemIdKey]: item.id,
                    date: dateStr,
                    status: status,
                    note: ''
                };
                applied++;
            });
        });
        
        closeModal();
        updateSaveButton();
        loadAttendanceTable();
        showToast(`${t('bulkApplied')} (${applied})`, 'success');
    }
    
    // Ø§Ø¹ØªÙ…Ø§Ø¯ / Ø¥Ù„ØºØ§Ø¡ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¬Ø²Ø¦ÙŠ (Ù…Ø«Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ)
    function openBulkApprovalModal() {
        if (currentUserData.role !== 'approver' && currentUserData.role !== 'manager') return;
        if (!selectedProject) {
            showToast(t('selectProject') || 'Select a project', 'error');
            return;
        }
        const items = window.attendanceTableItems || [];
        const weekDays = window.attendanceCurrentWeekDays || [];
        if (items.length === 0) {
            showToast(activeTab === 'vehicles' ? t('noVehicles') : t('noEmployees'), 'error');
            return;
        }
        if (weekDays.length === 0) {
            showToast(t('select') + ' ' + t('week'), 'error');
            return;
        }
        const isManager = currentUserData.role === 'manager';
        const datesHtml = weekDays.map(day => {
            const dateStr = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const date = new Date(selectedYear, selectedMonth, day);
            const dayName = getDayName(date);
            return `<label class="flex items-center gap-3 p-4 bg-white border-2 border-gray-200 rounded-xl cursor-pointer hover:border-amber-400 hover:bg-amber-50 transition"><input type="checkbox" class="bulk-approval-date-checkbox rounded w-5 h-5" value="${dateStr}" name="bulk-approval-dates"><span class="font-medium">${day} ${t(dayName)}</span></label>`;
        }).join('');
        const unapproveHtml = isManager ? `<label class="flex items-center gap-3 p-4 bg-white border-2 border-gray-200 rounded-xl cursor-pointer hover:border-amber-400 hover:bg-amber-50 transition"><input type="radio" name="bulk-approval-action" value="unapprove" class="w-5 h-5"><span class="font-semibold text-amber-700">âœ• ${t('unapproveAction')}</span></label>` : '';
        const itemsHtml = items.map(item => `<label class="flex items-center gap-3 p-3 rounded-lg cursor-pointer hover:bg-gray-100 bulk-approval-item-label"><input type="checkbox" class="bulk-approval-item-checkbox rounded w-4 h-4" value="${item.id}" disabled><span class="text-base">${activeTab === 'vehicles' ? (vehicleIcons[item.type] || '') + ' ' : ''}${item.name}</span></label>`).join('');
        const content = `
            <div class="space-y-6 text-base">
                <div class="p-5 bg-gray-50 rounded-xl border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <span class="text-2xl">ğŸ“…</span> ${t('selectDates')}
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">${t('bulkDatesHint')}</p>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                        ${datesHtml}
                    </div>
                </div>
                <div class="p-5 bg-gray-50 rounded-xl border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <span class="text-2xl">ğŸ“‹</span> ${t('approvalAction')}
                    </h3>
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 p-4 bg-white border-2 border-gray-200 rounded-xl cursor-pointer hover:border-amber-400 hover:bg-amber-50 transition">
                            <input type="radio" name="bulk-approval-action" value="approve" class="w-5 h-5" checked>
                            <span class="font-semibold text-emerald-700">âœ“ ${t('approveAction')}</span>
                        </label>
                        ${unapproveHtml}
                    </div>
                </div>
                <div class="p-5 bg-gray-50 rounded-xl border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <span class="text-2xl">ğŸ‘¥</span> ${t('applyTo')}
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">${t('bulkApplyHint')}</p>
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 p-4 bg-white border-2 border-gray-200 rounded-xl cursor-pointer hover:border-amber-400 hover:bg-amber-50 transition">
                            <input type="radio" name="bulk-approval-scope" value="all" class="bulk-approval-scope-radio w-5 h-5" checked>
                            <span class="font-semibold text-gray-800">${t('applyToAll')}</span>
                            <span class="text-gray-500">(${items.length} ${activeTab === 'vehicles' ? t('vehicles') : t('employees')})</span>
                        </label>
                        <label class="flex items-center gap-3 p-4 bg-white border-2 border-gray-200 rounded-xl cursor-pointer hover:border-amber-400 hover:bg-amber-50 transition">
                            <input type="radio" name="bulk-approval-scope" value="selected" class="bulk-approval-scope-radio w-5 h-5">
                            <span class="font-semibold text-gray-800">${t('select')} ${t('specific')}</span>
                        </label>
                    </div>
                    <div class="mt-4 max-h-56 overflow-y-auto border-2 border-gray-200 rounded-xl p-4 bg-white" id="bulk-approval-items-container">
                        <p class="text-sm text-gray-500 mb-2">${t('bulkSelectItems')}</p>
                        <div class="space-y-2" id="bulk-approval-items-list">
                            ${itemsHtml}
                        </div>
                    </div>
                </div>
            </div>
        `;
        const footer = `
            <button onclick="closeModal()" class="px-6 py-3 border-2 border-gray-300 rounded-xl hover:bg-gray-100 transition font-medium">${t('cancel')}</button>
            <button onclick="applyBulkApproval()" class="px-6 py-3 bg-amber-600 text-white rounded-xl hover:bg-amber-700 transition font-semibold">
                âœ“ ${t('applyBulk')}
            </button>
        `;
        openModal(t('partialApproval'), content, footer, 'max-w-4xl');
        document.querySelectorAll('.bulk-approval-scope-radio').forEach(radio => {
            radio.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.bulk-approval-item-checkbox');
                const useSelected = this.value === 'selected';
                checkboxes.forEach(cb => {
                    cb.disabled = !useSelected;
                    if (!useSelected) cb.checked = false;
                });
            });
        });
    }
    
    async function applyBulkApproval() {
        const dateCheckboxes = document.querySelectorAll('.bulk-approval-date-checkbox:checked');
        const action = document.querySelector('input[name="bulk-approval-action"]:checked')?.value || 'approve';
        if (dateCheckboxes.length === 0) {
            showToast(t('selectDates'), 'error');
            return;
        }
        const dates = Array.from(dateCheckboxes).map(cb => cb.value);
        const useAll = document.querySelector('input[name="bulk-approval-scope"][value="all"]')?.checked;
        const items = window.attendanceTableItems || [];
        let selectedItems = items;
        if (!useAll) {
            const selectedIds = Array.from(document.querySelectorAll('.bulk-approval-item-checkbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) {
                showToast(t('select') + ' ' + (activeTab === 'vehicles' ? t('vehicles') : t('employees')), 'error');
                return;
            }
            selectedItems = items.filter(item => selectedIds.includes(item.id));
        }
        if (action === 'unapprove' && currentUserData.role !== 'manager') return;
        const confirmMsg = action === 'approve' ? t('approvalConfirmApprove') : t('approvalConfirmUnapprove');
        if (!confirm(confirmMsg)) return;
        const selectedIds = selectedItems.map(i => i.id);
        const datesSorted = [...dates].sort();
        const minDate = datesSorted[0];
        const maxDate = datesSorted[datesSorted.length - 1];
        const dateSet = new Set(dates);
        const idSet = new Set(selectedIds);
        const collections = activeTab === 'vehicles'
            ? [{ name: 'vehicleAttendance', idField: 'vehicleId' }]
            : [{ name: 'attendance', idField: 'employeeId' }];
        try {
            const writeBatch = db.batch();
            for (const coll of collections) {
                const snap = await db.collection(coll.name)
                    .where('projectId', '==', selectedProject)
                    .where('date', '>=', minDate)
                    .where('date', '<=', maxDate)
                    .get();
                snap.docs.forEach(doc => {
                    const d = doc.data();
                    if (!dateSet.has(d.date) || !idSet.has(d[coll.idField])) return;
                    if (action === 'approve') {
                        if (d.approved !== true) {
                            writeBatch.update(doc.ref, {
                                approved: true,
                                approvedBy: currentUser.uid,
                                approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    } else {
                        if (d.approved === true) {
                            writeBatch.update(doc.ref, {
                                approved: false,
                                approvedBy: firebase.firestore.FieldValue.delete(),
                                approvedAt: firebase.firestore.FieldValue.delete()
                            });
                        }
                    }
                });
            }
            await writeBatch.commit();
            const projectLabel = window.currentAttendanceData?.projectName || selectedProject || '';
            logActivity('update', 'attendance', selectedProject || '', projectLabel, action === 'approve' ? (currentLanguage === 'ar' ? 'Ø§Ø¹ØªÙ…Ø§Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø¶ÙˆØ±' : 'Attendance approved') : (currentLanguage === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø¶ÙˆØ±' : 'Attendance unapproved'));
            closeModal();
            showToast(action === 'approve' ? t('appliedApproval') : t('appliedUnapprove'), 'success');
            await loadAttendanceTable();
        } catch (err) {
            console.error('Error bulk approval:', err);
            showToast(t('error'), 'error');
        }
    }
    
    async function saveAttendance() {
        if (Object.keys(attendanceChanges).length === 0) return;
        
        const btn = document.getElementById('save-btn');
        btn.disabled = true;
        btn.textContent = t('saving');
        
        try {
            const collection = activeTab === 'vehicles' ? 'vehicleAttendance' : 'attendance';
            const batch = db.batch();
            const missionNotifications = []; // Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            
            let hasBlocked = false;
            for (const [key, data] of Object.entries(attendanceChanges)) {
                const existing = attendanceData[key];
                if (data._delete) {
                    if (existing?.id && !canEditAttendance(key)) {
                        hasBlocked = true;
                        continue;
                    }
                    if (existing?.id) {
                        batch.delete(db.collection(collection).doc(existing.id));
                    }
                } else {
                    if (existing?.id && !canEditAttendance(key)) {
                        hasBlocked = true;
                        continue;
                    }
                    let docId;
                    if (existing?.id) {
                        docId = existing.id;
                        batch.update(db.collection(collection).doc(existing.id), {
                            ...data,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } else {
                        const newDoc = db.collection(collection).doc();
                        docId = newDoc.id;
                        batch.set(newDoc, {
                            ...data,
                            approved: false,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ù‡Ù…Ø© Ø¯Ø§Ø®Ù„ÙŠØ©
                    if (data.status === 'onMission' && data.missionDetails?.type === 'internal' && data.missionNotification) {
                        // Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø®Ø²Ù†
                        let employeeName = window.employeesData?.find(e => e.id === data.employeeId)?.name || '';
                        if (!employeeName && window.currentAttendanceData?.itemName) {
                            employeeName = window.currentAttendanceData.itemName;
                        }
                        
                        // Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…ØµØ¯Ø±
                        let sourceProjectName = window.projectsListData?.find(p => p.id === data.projectId)?.name || '';
                        if (!sourceProjectName) {
                            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                            const projectSelect = document.getElementById('attendance-project');
                            if (projectSelect) {
                                const option = Array.from(projectSelect.options).find(o => o.value === data.projectId);
                                sourceProjectName = option?.text || '';
                            }
                        }
                        
                        missionNotifications.push({
                            attendanceId: docId,
                            employeeId: data.employeeId,
                            sourceProjectId: data.projectId,
                            targetProjectId: data.missionDetails.projectId,
                            date: data.date,
                            employeeName: employeeName,
                            sourceProjectName: sourceProjectName,
                            targetProjectName: data.missionDetails.projectName
                        });
                    }
                }
            }
            
            if (hasBlocked) {
                showToast(currentUserData.role === 'supervisor' ? t('cannotEditAfter24h') : t('onlyManagerCanEditApproved'), 'error');
                btn.disabled = false;
                btn.textContent = `ğŸ’¾ ${t('save')}`;
                return;
            }
            await batch.commit();
            
            const savedCount = Object.keys(attendanceChanges).length;
            const projectLabel = window.currentAttendanceData?.projectName || selectedProject || '';
            logActivity('update', 'attendance', selectedProject || '', projectLabel, (currentLanguage === 'ar' ? 'Ø­ÙØ¸ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± â€” ' : 'Saved attendance â€” ') + savedCount + (currentLanguage === 'ar' ? ' Ø³Ø¬Ù„' : ' record(s)'));
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø§Øª
            for (const mission of missionNotifications) {
                await createMissionNotification(mission);
            }
            
            attendanceChanges = {};
            showToast(t('saved'), 'success');
            updateSaveButton();
            await loadAttendanceTable();
            
        } catch (error) {
            console.error('Error saving attendance:', error);
            showToast(t('error'), 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = `ğŸ’¾ ${t('save')}`;
        }
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø± Ù…Ù‡Ù…Ø©
    async function createMissionNotification(mission) {
        try {
            await db.collection('notifications').add({
                type: 'missionAttendance',
                attendanceId: mission.attendanceId,
                employeeId: mission.employeeId,
                employeeName: mission.employeeName,
                sourceProjectId: mission.sourceProjectId,
                sourceProjectName: mission.sourceProjectName,
                targetProjectId: mission.targetProjectId,
                targetProjectName: mission.targetProjectName,
                date: mission.date,
                status: 'pending', // pending, confirmed, rejected
                createdBy: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                read: false
            });
        } catch (error) {
            console.error('Error creating mission notification:', error);
        }
    }
    
    async function approveAttendanceWeek() {
        if (currentUserData.role !== 'approver' && currentUserData.role !== 'manager') return;
        if (!selectedProject) {
            showToast(t('selectProject') || 'Select a project', 'error');
            return;
        }
        if (!confirm(t('approveConfirm'))) return;
        const weeks = getWeeks(selectedYear, selectedMonth);
        const currentWeekDays = weeks[selectedWeek] || window.attendanceCurrentWeekDays || [];
        if (currentWeekDays.length === 0) {
            showToast(t('error') || 'Error', 'error');
            return;
        }
        const dateStrs = currentWeekDays.map(day =>
            `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`
        );
        try {
            const writeBatch = db.batch();
            const collections = ['attendance', 'vehicleAttendance'];
            for (const collName of collections) {
                const snap = await db.collection(collName)
                    .where('projectId', '==', selectedProject)
                    .where('date', 'in', dateStrs)
                    .get();
                snap.docs.forEach(doc => {
                    const d = doc.data();
                    if (d.approved !== true) {
                        writeBatch.update(doc.ref, {
                            approved: true,
                            approvedBy: currentUser.uid,
                            approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });
            }
            await writeBatch.commit();
            const projectLabel = window.currentAttendanceData?.projectName || selectedProject || '';
            logActivity('update', 'attendance', selectedProject || '', projectLabel, currentLanguage === 'ar' ? 'Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¯ÙˆØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹' : 'Week attendance approved');
            showToast(t('approved'), 'success');
            await loadAttendanceTable();
        } catch (err) {
            console.error('Error approving attendance:', err);
            showToast(t('error'), 'error');
        }
    }
    
    function changeAttendanceProject() {
        selectedProject = document.getElementById('attendance-project').value;
        attendanceChanges = {};
        updateSaveButton();
        loadAttendanceTable();
    }
    
    function setAttendanceProject(projectId) {
        selectedProject = projectId;
    }
    
    function changeMonth(delta) {
        selectedMonth += delta;
        if (selectedMonth > 11) {
            selectedMonth = 0;
            selectedYear++;
        } else if (selectedMonth < 0) {
            selectedMonth = 11;
            selectedYear--;
        }
        
        document.getElementById('current-month').textContent = `${t(getMonthName(selectedMonth))} ${selectedYear}`;
        selectedWeek = 0;
        attendanceChanges = {};
        updateSaveButton();
        loadAttendanceTable();
    }
    
    function changeWeek(delta) {
        const weeks = getWeeks(selectedYear, selectedMonth);
        selectedWeek += delta;
        if (selectedWeek >= weeks.length) selectedWeek = 0;
        if (selectedWeek < 0) selectedWeek = weeks.length - 1;
        loadAttendanceTable();
    }
    
    function goToWeek(weekIndex) {
        selectedWeek = weekIndex;
        loadAttendanceTable();
    }
    
    function switchAttendanceTab(tab) {
        activeTab = tab;
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === tab);
        });
        attendanceChanges = {};
        updateSaveButton();
        loadAttendanceTable();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function printReportInNewTab() {
        const resultsEl = document.getElementById('report-results');
        if (!resultsEl || !resultsEl.innerHTML.trim()) {
            showToast(t('error') || 'Error', 'error');
            return;
        }
        const content = resultsEl.innerHTML.replace(/onclick="[^"]*"/gi, '').replace(/class="[^"]*no-print[^"]*"/gi, 'class="hidden"');
        const w = window.open('', '_blank');
        if (!w) {
            showToast(t('error') || 'Error', 'error');
            return;
        }
        const isRtl = document.documentElement.getAttribute('dir') === 'rtl' || document.documentElement.lang === 'ar';
        const dir = isRtl ? 'rtl' : 'ltr';
        const lang = document.documentElement.lang || 'ar';
        const title = t('projectReport') + ' / ' + t('employeeReport');
        const prefix = '<!DOCTYPE html><html dir="' + dir + '" lang="' + lang + '"><head><meta charset="utf-8"><title>' + title + '</title><script src="https://cdn.tailwindcss.com"><\/script><style>@page{size:A4 landscape;margin:10mm;}@media print{body{-webkit-print-color-adjust:exact;print-color-adjust:exact;}table{font-size:0.7rem!important;}th,td{padding:3px 4px!important;}}</style></head><body class="p-4 bg-gray-100"><div class="max-w-full mx-auto bg-white rounded-xl shadow p-4">';
        const suffix = '</div><script>window.onload=function(){setTimeout(function(){window.print();},600);};<\/script></body></html>';
        w.document.write(prefix + content + suffix);
        w.document.close();
    }
    
    async function loadReports() {
        const container = document.getElementById('page-reports');
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        const projects = window.projectsListData || [];
        let projectsSnap, employeesSnap;
        
        try {
            if (projects.length === 0) {
                if (currentUserData.role === 'supervisor' && currentUserData.assignedProjects && currentUserData.assignedProjects.length > 0) {
                    projectsSnap = await db.collection('projects').where(firebase.firestore.FieldPath.documentId(), 'in', currentUserData.assignedProjects).get();
                } else {
                    projectsSnap = await db.collection('projects').get();
                }
                projectsSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.status !== 'hidden') {
                        projects.push({ id: doc.id, ...data });
                    }
                });
            }
            
            if (currentUserData.role === 'supervisor' && currentUserData.assignedProjects && currentUserData.assignedProjects.length > 0) {
                employeesSnap = await db.collection('employees').where('projectId', 'in', currentUserData.assignedProjects).get();
            } else {
                employeesSnap = await db.collection('employees').get();
            }
            const employees = [];
            employeesSnap.forEach(doc => {
                const data = doc.data();
                if (data.status !== 'hidden') {
                    employees.push({ id: doc.id, ...data });
                }
            });
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø«Ù… Ø§Ù„Ø§Ø³Ù…
            employees.sort((a, b) => {
                const pA = projects.find(p => p.id === a.projectId)?.name || '';
                const pB = projects.find(p => p.id === b.projectId)?.name || '';
                if (pA !== pB) return pA.localeCompare(pB);
                return (a.name || '').localeCompare(b.name || '');
            });
            
            // Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ±: Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
            const now = new Date();
            const firstDayCurr = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDayCurr = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            const reportProjectDefaultFrom = firstDayCurr.getFullYear() + '-' + String(firstDayCurr.getMonth() + 1).padStart(2, '0') + '-' + String(firstDayCurr.getDate()).padStart(2, '0');
            const reportProjectDefaultTo = lastDayCurr.getFullYear() + '-' + String(lastDayCurr.getMonth() + 1).padStart(2, '0') + '-' + String(lastDayCurr.getDate()).padStart(2, '0');
            
            container.innerHTML = `
                <div id="report-forms" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ -->
                    <div class="card p-6">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                            ğŸ“ ${t('projectReport')}
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">${t('projects')}</label>
                                <select id="report-project" class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-primary-500">
                                    ${currentUserData.role === 'manager' ? `<option value="all">${t('all')}</option>` : ''}
                                    ${projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">${t('reportEmployeeType')}</label>
                                <select id="report-project-type" class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-primary-500">
                                    <option value="all">${t('all')}</option>
                                    <option value="monthly">${t('monthly')}</option>
                                    <option value="daily">${t('daily')}</option>
                                    <option value="vehicles">${t('vehicles')}</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('from')}</label>
                                    <input type="date" id="report-project-from" class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-primary-500" value="${reportProjectDefaultFrom}">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('to')}</label>
                                    <input type="date" id="report-project-to" class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-primary-500" value="${reportProjectDefaultTo}">
                                </div>
                            </div>
                            <button onclick="generateProjectReport()" class="w-full py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition">
                                ${t('view')} ${t('projectReport')}
                            </button>
                        </div>
                    </div>
                    
                    <!-- ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ¸Ù -->
                    <div class="card p-6">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                            ğŸ‘¤ ${t('employeeReport')}
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">${t('employees')}</label>
                                <div class="report-employee-combobox">
                                    <input type="hidden" id="report-employee" value="">
                                    <input type="text" id="report-employee-search" autocomplete="off" placeholder="${t('search')} ${t('employeeName')} / ${t('employeeCode')}..." class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-primary-500" value="">
                                    <div id="report-employee-dropdown" class="report-employee-dropdown hidden"></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('from')}</label>
                                    <input type="date" id="report-employee-from" class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-primary-500" value="${reportProjectDefaultFrom}">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('to')}</label>
                                    <input type="date" id="report-employee-to" class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-primary-500" value="${reportProjectDefaultTo}">
                                </div>
                            </div>
                            <button onclick="generateEmployeeReport()" class="w-full py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition">
                                ${t('view')} ${t('employeeReport')}
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
                <div id="report-results" class="mt-6"></div>
            `;
            
            window.projectsListData = projects;
            window.employeesListData = employees;
            initReportEmployeeSearch();
            
        } catch (error) {
            console.error('Error loading reports:', error);
            container.innerHTML = `<p class="text-red-500 text-center py-8">${t('error')}</p>`;
        }
    }
    
    function initReportEmployeeSearch() {
        const searchInput = document.getElementById('report-employee-search');
        const hiddenInput = document.getElementById('report-employee');
        const dropdown = document.getElementById('report-employee-dropdown');
        if (!searchInput || !hiddenInput || !dropdown) return;
        
        const projects = window.projectsListData || [];
        const employees = window.employeesListData || [];
        
        function esc(s) { return (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
        
        function buildDropdownHTML(filter) {
            const q = (filter || '').trim().toLowerCase();
            const filtered = q ? employees.filter(e => 
                (e.name || '').toLowerCase().includes(q) || (e.code || '').toLowerCase().includes(q)
            ) : employees;
            const byProject = {};
            filtered.forEach(e => {
                const pid = e.projectId || '';
                if (!byProject[pid]) byProject[pid] = [];
                byProject[pid].push(e);
            });
            const projectOrder = [...new Set(employees.map(e => e.projectId))];
            let html = '';
            projectOrder.forEach(pid => {
                const list = byProject[pid] || [];
                if (list.length === 0) return;
                const projectName = pid ? (projects.find(p => p.id === pid)?.name || pid) : (currentLanguage === 'ar' ? 'Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø±ÙˆØ¹' : 'No project');
                html += '<div class="dropdown-group"><div class="dropdown-group-title">' + esc(projectName) + '</div>';
                list.forEach(e => {
                    const label = e.name + ' (' + (e.code || '') + ')';
                    html += '<div class="dropdown-item" data-employee-id="' + esc(e.id) + '" data-employee-label="' + esc(label) + '">' + esc(label) + '</div>';
                });
                html += '</div>';
            });
            if (!html) html = '<div class="dropdown-item no-results">' + (currentLanguage === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬' : 'No results') + '</div>';
            return html;
        }
        
        function showDropdown() {
            dropdown.innerHTML = buildDropdownHTML(searchInput.value);
            dropdown.classList.remove('hidden');
            dropdown.querySelectorAll('.dropdown-item:not(.no-results)').forEach(el => {
                el.addEventListener('click', function() {
                    const id = this.getAttribute('data-employee-id');
                    const label = this.getAttribute('data-employee-label');
                    hiddenInput.value = id;
                    searchInput.value = label;
                    dropdown.classList.add('hidden');
                });
            });
        }
        
        function hideDropdown() { dropdown.classList.add('hidden'); }
        
        searchInput.addEventListener('focus', showDropdown);
        searchInput.addEventListener('input', showDropdown);
        searchInput.addEventListener('blur', function() { setTimeout(hideDropdown, 200); });
        dropdown.addEventListener('mousedown', function(e) { e.preventDefault(); });
        
        if (!window._reportEmployeeSearchClickOut) {
            window._reportEmployeeSearchClickOut = true;
            document.addEventListener('click', function(e) {
                const box = document.querySelector('.report-employee-combobox');
                if (!box || box.contains(e.target)) return;
                const dd = document.getElementById('report-employee-dropdown');
                if (dd && !dd.classList.contains('hidden')) dd.classList.add('hidden');
            });
        }
    }
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ù„Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ø¬Ø²Ø¦ÙŠ (Ù…Ù† ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ø¥Ù† ÙˆØ¬Ø¯ØªØŒ ÙˆØ¥Ù„Ø§ 0.5 ÙŠÙˆÙ…)
    function getPartialEquivalentDays(record) {
        if (record.status !== 'partial' || !record.partialDetails) return 0.5;
        const pd = record.partialDetails;
        const arrival = pd.arrivalTime;
        const leave = pd.leaveTime;
        if (!arrival || !leave) return 0.5;
        const parseTime = (t) => {
            const [h, m] = (t || '0:0').split(':').map(Number);
            return (h || 0) + (m || 0) / 60;
        };
        let hours = Math.max(0, parseTime(leave) - parseTime(arrival));
        if (pd.breakOut && pd.breakOutTime && pd.breakInTime) {
            const breakOut = parseTime(pd.breakOutTime);
            const breakIn = parseTime(pd.breakInTime);
            hours -= Math.max(0, breakIn - breakOut);
        }
        const dayFraction = Math.min(1, Math.max(0, hours / 8));
        return Math.round(dayFraction * 100) / 100;
    }
    
    async function generateProjectReport() {
        const projectId = document.getElementById('report-project').value;
        const fromDate = document.getElementById('report-project-from').value;
        const toDate = document.getElementById('report-project-to').value;
        const employeeTypeFilter = document.getElementById('report-project-type')?.value || 'all';
        const resultsContainer = document.getElementById('report-results');
        
        resultsContainer.innerHTML = `<div class="text-center py-8"><div class="loader mx-auto"></div></div>`;
        
        try {
            const showAllProjects = projectId === 'all';
            const projects = showAllProjects ? (window.projectsListData || []) : [window.projectsListData?.find(p => p.id === projectId)].filter(Boolean);
            
            if (projects.length === 0) {
                resultsContainer.innerHTML = `<p class="text-red-500 text-center py-8">${currentLanguage === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹' : 'No projects found'}</p>`;
                return;
            }
            
            // Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
            let allEmployees = [];
            let allVehicles = [];
            let allAttendance = {};
            let allVehicleAttendance = {};
            
            for (const project of projects) {
                // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
                const empSnap = await db.collection('employees').where('projectId', '==', project.id).get();
                empSnap.forEach(doc => allEmployees.push({ id: doc.id, ...doc.data() }));
                
                // Ø¬Ù„Ø¨ Ø§Ù„Ø¢Ù„ÙŠØ§Øª
                const vehSnap = await db.collection('vehicles').where('projectId', '==', project.id).get();
                vehSnap.forEach(doc => allVehicles.push({ id: doc.id, ...doc.data() }));
                
                // Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†
                const attSnap = await db.collection('attendance').where('projectId', '==', project.id).get();
                attSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.date >= fromDate && data.date <= toDate) {
                        if (!allAttendance[data.employeeId]) allAttendance[data.employeeId] = [];
                        allAttendance[data.employeeId].push(data);
                    }
                });
                
                // Ø¬Ù„Ø¨ Ø­Ø¶ÙˆØ± Ø§Ù„Ø¢Ù„ÙŠØ§Øª
                const vehAttSnap = await db.collection('vehicleAttendance').where('projectId', '==', project.id).get();
                vehAttSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.date >= fromDate && data.date <= toDate) {
                        if (!allVehicleAttendance[data.vehicleId]) allVehicleAttendance[data.vehicleId] = [];
                        allVehicleAttendance[data.vehicleId].push(data);
                    }
                });
            }
            
            // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            let employees = allEmployees;
            if (employeeTypeFilter !== 'all' && employeeTypeFilter !== 'vehicles') {
                employees = employees.filter(e => e.type === employeeTypeFilter);
            }
            
            const vehicles = allVehicles;
            
            // Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„ÙØªØ±Ø© (Ù…Ù† - Ø¥Ù„Ù‰ Ø´Ø§Ù…Ù„Ø§Ù‹)
            const fromParts = fromDate.split('-').map(Number);
            const toParts = toDate.split('-').map(Number);
            const fromD = new Date(fromParts[0], fromParts[1] - 1, fromParts[2]);
            const toD = new Date(toParts[0], toParts[1] - 1, toParts[2]);
            const daysInPeriod = Math.max(1, Math.round((toD - fromD) / (24 * 60 * 60 * 1000)) + 1);
            
            // Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¤Ø¬ÙˆØ± = Ø­Ø¶ÙˆØ± ÙØ¹Ù„ÙŠ (ÙŠÙˆÙ… ÙƒØ§Ù…Ù„ + Ø¬Ø²Ø¦ÙŠ Ù…Ø¹Ø§Ø¯Ù„). Ø§Ù„Ø­Ø¶ÙˆØ± ØºÙŠØ± Ø§Ù„Ù…Ø¤Ø¬ÙˆØ± = Ø£ÙŠØ§Ù… Ø§Ù„ÙØªØ±Ø© - Ø§Ù„Ù…Ø¤Ø¬ÙˆØ± (Ø¨Ø­ÙŠØ« Ø§Ù„Ù…Ø¤Ø¬ÙˆØ± + ØºÙŠØ± Ø§Ù„Ù…Ø¤Ø¬ÙˆØ± = Ø£ÙŠØ§Ù… Ø§Ù„ÙØªØ±Ø©)
            const attendance = allAttendance;
            const vehicleAttendance = allVehicleAttendance;
            
            const employeeStats = employees.map(emp => {
                const empAtt = attendance[emp.id] || [];
                const fullDay = empAtt.filter(a => a.status === 'full_day').length;
                const partialRecords = empAtt.filter(a => a.status === 'partial');
                const partialCount = partialRecords.length;
                const partialEquivalentDays = partialRecords.reduce((sum, r) => sum + getPartialEquivalentDays(r), 0);
                
                const absent = empAtt.filter(a => a.status === 'absent').length;
                const excusedAbsent = empAtt.filter(a => a.status === 'excusedAbsent').length;
                const annualLeave = empAtt.filter(a => a.status === 'annualLeave').length;
                const sickLeave = empAtt.filter(a => a.status === 'sickLeave').length;
                const emergencyLeave = empAtt.filter(a => a.status === 'emergencyLeave').length;
                const unpaidLeave = empAtt.filter(a => a.status === 'unpaidLeave').length;
                const periodicLeave = empAtt.filter(a => a.status === 'periodicLeave').length;
                const officialHoliday = empAtt.filter(a => a.status === 'officialHoliday').length;
                const onMission = empAtt.filter(a => a.status === 'onMission').length;
                
                const approvedCount = empAtt.filter(a => a.approved === true).length;
                const unapprovedCount = empAtt.length - approvedCount;
                
                const excusedAttendanceDays = fullDay + partialEquivalentDays + annualLeave + periodicLeave + officialHoliday + onMission;
                const unexcusedAttendanceDays = Math.max(0, daysInPeriod - excusedAttendanceDays);
                const totalRecorded = empAtt.length;
                const workDaysInPeriod = totalRecorded || 1;
                const rate = daysInPeriod > 0 ? Math.round((excusedAttendanceDays / daysInPeriod) * 100) : 0;
                
                return {
                    ...emp,
                    fullDay,
                    partialCount,
                    partialEquivalentDays,
                    excusedAttendanceDays,
                    unexcusedAttendanceDays,
                    daysInPeriod,
                    absent,
                    excusedAbsent,
                    annualLeave,
                    sickLeave,
                    emergencyLeave,
                    unpaidLeave,
                    officialHoliday,
                    onMission,
                    totalRecorded,
                    approvedCount,
                    unapprovedCount,
                    rate
                };
            });
            
            const totals = employeeStats.reduce((acc, e) => ({
                fullDay: acc.fullDay + e.fullDay,
                partialCount: acc.partialCount + e.partialCount,
                partialEquivalentDays: acc.partialEquivalentDays + e.partialEquivalentDays,
                excusedAttendanceDays: acc.excusedAttendanceDays + e.excusedAttendanceDays,
                unexcusedAttendanceDays: acc.unexcusedAttendanceDays + e.unexcusedAttendanceDays,
                absent: acc.absent + e.absent,
                excusedAbsent: acc.excusedAbsent + e.excusedAbsent,
                annualLeave: acc.annualLeave + e.annualLeave,
                sickLeave: acc.sickLeave + e.sickLeave,
                emergencyLeave: acc.emergencyLeave + e.emergencyLeave,
                unpaidLeave: acc.unpaidLeave + e.unpaidLeave,
                periodicLeave: acc.periodicLeave + e.periodicLeave,
                officialHoliday: acc.officialHoliday + e.officialHoliday,
                onMission: acc.onMission + e.onMission,
                approvedRecords: acc.approvedRecords + e.approvedCount,
                unapprovedRecords: acc.unapprovedRecords + e.unapprovedCount
            }), { fullDay: 0, partialCount: 0, partialEquivalentDays: 0, excusedAttendanceDays: 0, unexcusedAttendanceDays: 0, absent: 0, excusedAbsent: 0, annualLeave: 0, sickLeave: 0, emergencyLeave: 0, unpaidLeave: 0, periodicLeave: 0, officialHoliday: 0, onMission: 0, approvedRecords: 0, unapprovedRecords: 0 });
            
            const typeLabel = employeeTypeFilter === 'all' ? '' : ` (${t(employeeTypeFilter)})`;
            
            // Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¢Ù„ÙŠØ§Øª
            const vehicleStats = vehicles.map(veh => {
                const vehAtt = vehicleAttendance[veh.id] || [];
                const worked = vehAtt.filter(a => a.status === 'worked').length;
                const workedPartial = vehAtt.filter(a => a.status === 'workedPartial').length;
                const broken = vehAtt.filter(a => a.status === 'broken').length;
                const maintenance = vehAtt.filter(a => a.status === 'maintenance').length;
                const idle = vehAtt.filter(a => a.status === 'idle').length;
                const totalDays = vehAtt.length;
                const approvedCount = vehAtt.filter(a => a.approved === true).length;
                const unapprovedCount = vehAtt.length - approvedCount;
                
                return {
                    ...veh,
                    worked,
                    workedPartial,
                    broken,
                    maintenance,
                    idle,
                    totalDays,
                    approvedCount,
                    unapprovedCount
                };
            });
            
            const vehicleTotals = vehicleStats.reduce((acc, v) => ({
                worked: acc.worked + v.worked,
                workedPartial: acc.workedPartial + v.workedPartial,
                broken: acc.broken + v.broken,
                maintenance: acc.maintenance + v.maintenance,
                idle: acc.idle + v.idle,
                approvedRecords: acc.approvedRecords + v.approvedCount,
                unapprovedRecords: acc.unapprovedRecords + v.unapprovedCount
            }), { worked: 0, workedPartial: 0, broken: 0, maintenance: 0, idle: 0, approvedRecords: 0, unapprovedRecords: 0 });
            
            const showVehiclesOnly = employeeTypeFilter === 'vehicles';
            
            const project = showAllProjects ? null : projects[0];
            const projectTitle = showAllProjects ? (currentLanguage === 'ar' ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹' : 'All Projects') : project?.name;
            const projectCode = showAllProjects ? '' : `${project?.code} | `;
            
            resultsContainer.innerHTML = `
                <div class="card p-6">
                    <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
                        <div>
                            <h3 class="font-bold text-xl">${projectTitle}</h3>
                            <p class="text-gray-500">${projectCode}${fromDate} - ${toDate}${typeLabel}</p>
                        </div>
                        <button onclick="printReportInNewTab()" class="no-print px-4 py-2 border rounded-lg hover:bg-gray-100">
                            ğŸ–¨ï¸ ${t('print')}
                        </button>
                    </div>
                    
                    ${showVehiclesOnly ? `
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6 no-print-stats">
                        <div class="bg-orange-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-orange-600">${vehicles.length}</p>
                            <p class="text-sm text-gray-500">${t('vehicles')}</p>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-gray-700">${daysInPeriod}</p>
                            <p class="text-sm text-gray-500">${t('daysInPeriod')}</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-green-600">${vehicleTotals.worked}</p>
                            <p class="text-sm text-gray-500">ğŸŸ¢ ${t('worked')}</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-yellow-700">${vehicleTotals.workedPartial}</p>
                            <p class="text-sm text-gray-500">ğŸŸ¡ ${t('workedPartial')}</p>
                        </div>
                        <div class="bg-emerald-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-emerald-600">${vehicleTotals.approvedRecords}</p>
                            <p class="text-sm text-gray-500">${t('approvedRecords')}</p>
                        </div>
                        <div class="bg-amber-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-amber-600">${vehicleTotals.unapprovedRecords}</p>
                            <p class="text-sm text-gray-500">${t('unapprovedRecords')}</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-4 no-print-stats">${t('reportApprovalNote')} âœ“ ${t('approvedRecords')}: ${vehicleTotals.approvedRecords} | ${t('unapprovedRecords')}: ${vehicleTotals.unapprovedRecords}</p>
                    ` : `
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6 no-print-stats">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-blue-600">${employees.length}</p>
                            <p class="text-sm text-gray-500">${t('employees')}${typeLabel}</p>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-gray-700">${daysInPeriod}</p>
                            <p class="text-sm text-gray-500">${t('daysInPeriod')}</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-green-600">${totals.excusedAttendanceDays.toFixed(2)}</p>
                            <p class="text-sm text-gray-500">${t('excusedAttendance')}</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-red-600">${totals.unexcusedAttendanceDays.toFixed(2)}</p>
                            <p class="text-sm text-gray-500">${t('unexcusedAttendance')}</p>
                        </div>
                        <div class="bg-green-100 p-4 rounded-lg text-center">
                            <p class="text-xl font-bold text-green-700">${totals.fullDay}</p>
                            <p class="text-xs text-gray-600">${t('fullDay')}</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg text-center">
                            <p class="text-xl font-bold text-yellow-700">${totals.partialEquivalentDays.toFixed(2)}</p>
                            <p class="text-xs text-gray-600">${t('partialDays')}</p>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-orange-600">${vehicles.length}</p>
                            <p class="text-sm text-gray-500">${t('vehicles')}</p>
                        </div>
                        <div class="bg-emerald-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-emerald-600">${totals.approvedRecords}</p>
                            <p class="text-sm text-gray-500">${t('approvedRecords')}</p>
                        </div>
                        <div class="bg-amber-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-amber-600">${totals.unapprovedRecords}</p>
                            <p class="text-sm text-gray-500">${t('unapprovedRecords')}</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-4 no-print-stats">${t('excusedAttendance')} + ${t('unexcusedAttendance')} = ${t('daysInPeriod')} (${daysInPeriod})</p>
                    <p class="text-sm text-gray-600 mb-4 no-print-stats">${t('reportApprovalNote')} âœ“ ${t('approvedRecords')}: ${totals.approvedRecords} | ${t('unapprovedRecords')}: ${totals.unapprovedRecords}</p>
                    <p class="text-sm text-gray-600 mb-4 no-print-stats">${t('actualAttendanceNote')}</p>
                    <h4 class="font-bold mb-4">${t('employees')} (${employees.length})</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-2 py-2 text-right">${t('employeeCode')}</th>
                                    <th class="px-2 py-2 text-right">${t('employeeName')}</th>
                                    <th class="px-2 py-2 text-right">${t('employeeType')}</th>
                                    <th class="px-2 py-2 text-center">ğŸŸ¢ ${t('fullDay')}</th>
                                    <th class="px-2 py-2 text-center">ğŸŸ¡ ${t('partial')}</th>
                                    <th class="px-2 py-2 text-center">ğŸ“Š ${t('equivalentDays')}</th>
                                    <th class="px-2 py-2 text-center">ğŸ”´ ${t('absent')}</th>
                                    <th class="px-2 py-2 text-center">ğŸŸ  ${t('excusedAbsent')}</th>
                                    <th class="px-2 py-2 text-center">ğŸ”µ ${t('annualLeave')}</th>
                                    <th class="px-2 py-2 text-center">ğŸŸ£ ${t('sickLeave')}</th>
                                    <th class="px-2 py-2 text-center">ğŸ©· ${t('emergencyLeave')}</th>
                                    <th class="px-2 py-2 text-center">âšª ${t('unpaidLeave')}</th>
                                    <th class="px-2 py-2 text-center">ğŸŸ¤ ${t('periodicLeave')}</th>
                                    <th class="px-2 py-2 text-center">â¬œ ${t('officialHoliday')}</th>
                                    <th class="px-2 py-2 text-center">ğŸ”· ${t('onMission')}</th>
                                    <th class="px-2 py-2 text-center">${t('daysInPeriod')}</th>
                                    <th class="px-2 py-2 text-center text-emerald-700">âœ“ ${t('approvedRecords')}</th>
                                    <th class="px-2 py-2 text-center text-amber-700">â—‹ ${t('unapprovedRecords')}</th>
                                    <th class="px-2 py-2 text-center font-semibold text-green-700">${t('excusedAttendance')}</th>
                                    <th class="px-2 py-2 text-center font-semibold text-red-700">${t('unexcusedAttendance')}</th>
                                    <th class="px-2 py-2 text-center">${t('attendanceRate')}</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${employeeStats.map(emp => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-2 py-2 font-mono">${emp.code}</td>
                                        <td class="px-2 py-2 font-medium">${emp.name}</td>
                                        <td class="px-2 py-2">${t(emp.type)}</td>
                                        <td class="px-2 py-2 text-center text-green-600">${emp.fullDay}</td>
                                        <td class="px-2 py-2 text-center text-yellow-600">${emp.partialCount}</td>
                                        <td class="px-2 py-2 text-center">${emp.partialEquivalentDays.toFixed(2)}</td>
                                        <td class="px-2 py-2 text-center text-red-600">${emp.absent}</td>
                                        <td class="px-2 py-2 text-center text-orange-600">${emp.excusedAbsent}</td>
                                        <td class="px-2 py-2 text-center text-blue-600">${emp.annualLeave}</td>
                                        <td class="px-2 py-2 text-center text-purple-600">${emp.sickLeave}</td>
                                        <td class="px-2 py-2 text-center">${emp.emergencyLeave}</td>
                                        <td class="px-2 py-2 text-center text-gray-600">${emp.unpaidLeave}</td>
                                        <td class="px-2 py-2 text-center">${emp.periodicLeave || 0}</td>
                                        <td class="px-2 py-2 text-center">${emp.officialHoliday}</td>
                                        <td class="px-2 py-2 text-center text-cyan-600">${emp.onMission}</td>
                                        <td class="px-2 py-2 text-center font-medium">${emp.daysInPeriod}</td>
                                        <td class="px-2 py-2 text-center text-emerald-600">${emp.approvedCount}</td>
                                        <td class="px-2 py-2 text-center text-amber-600">${emp.unapprovedCount}</td>
                                        <td class="px-2 py-2 text-center font-semibold text-green-700">${emp.excusedAttendanceDays.toFixed(2)}</td>
                                        <td class="px-2 py-2 text-center font-semibold text-red-700">${emp.unexcusedAttendanceDays.toFixed(2)}</td>
                                        <td class="px-2 py-2 text-center font-bold">${emp.rate}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    `}
                    
                    <h4 class="font-bold mb-4 mt-6">${t('vehicles')} (${vehicles.length})</h4>
                    ${vehicles.length > 0 ? `
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-2 py-2 text-right">${t('vehicleCode')}</th>
                                    <th class="px-2 py-2 text-right">${t('vehicleName')}</th>
                                    <th class="px-2 py-2 text-right">${t('vehicleType')}</th>
                                    <th class="px-2 py-2 text-center">ğŸŸ¢ ${t('worked')}</th>
                                    <th class="px-2 py-2 text-center">ğŸŸ¡ ${t('workedPartial')}</th>
                                    <th class="px-2 py-2 text-center">ğŸ”´ ${t('broken')}</th>
                                    <th class="px-2 py-2 text-center">ğŸŸ  ${t('maintenance')}</th>
                                    <th class="px-2 py-2 text-center">âšª ${t('idle')}</th>
                                    <th class="px-2 py-2 text-center">${t('daysInPeriod')}</th>
                                    <th class="px-2 py-2 text-center text-emerald-700">âœ“ ${t('approvedRecords')}</th>
                                    <th class="px-2 py-2 text-center text-amber-700">â—‹ ${t('unapprovedRecords')}</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${vehicleStats.map(veh => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-2 py-2 font-mono">${veh.code}</td>
                                        <td class="px-2 py-2 font-medium">${veh.name}</td>
                                        <td class="px-2 py-2">${t(veh.type)}</td>
                                        <td class="px-2 py-2 text-center text-green-600">${veh.worked}</td>
                                        <td class="px-2 py-2 text-center text-yellow-600">${veh.workedPartial}</td>
                                        <td class="px-2 py-2 text-center text-red-600">${veh.broken}</td>
                                        <td class="px-2 py-2 text-center text-orange-600">${veh.maintenance}</td>
                                        <td class="px-2 py-2 text-center text-gray-600">${veh.idle}</td>
                                        <td class="px-2 py-2 text-center font-medium">${veh.totalDays}</td>
                                        <td class="px-2 py-2 text-center text-emerald-600">${veh.approvedCount}</td>
                                        <td class="px-2 py-2 text-center text-amber-600">${veh.unapprovedCount}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : `<p class="text-gray-500 text-center py-4">${currentLanguage === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¢Ù„ÙŠØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹' : 'No vehicles in this project'}</p>`}
                </div>
            `;
            
        } catch (error) {
            console.error('Error generating project report:', error);
            resultsContainer.innerHTML = `<p class="text-red-500 text-center py-8">${t('error')}</p>`;
        }
    }
    
    async function generateEmployeeReport() {
        const employeeId = document.getElementById('report-employee').value;
        const fromDate = document.getElementById('report-employee-from').value;
        const toDate = document.getElementById('report-employee-to').value;
        const resultsContainer = document.getElementById('report-results');
        
        resultsContainer.innerHTML = `<div class="text-center py-8"><div class="loader mx-auto"></div></div>`;
        
        try {
            // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù
            const empDoc = await db.collection('employees').doc(employeeId).get();
            const employee = { id: empDoc.id, ...empDoc.data() };
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
            const projDoc = await db.collection('projects').doc(employee.projectId).get();
            const project = projDoc.exists ? projDoc.data() : null;
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø¶ÙˆØ± (ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ù…ÙˆØ¸Ù)
            const attSnap = await db.collection('attendance')
                .where('employeeId', '==', employeeId)
                .where('projectId', '==', employee.projectId)
                .get();
            
            const attendance = [];
            attSnap.forEach(doc => {
                const data = doc.data();
                // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
                if (data.date >= fromDate && data.date <= toDate) {
                    attendance.push({ id: doc.id, ...data });
                }
            });
            
            // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
            attendance.sort((a, b) => a.date.localeCompare(b.date));
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ù„Ù„Ø­Ø¶ÙˆØ± (Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯)
            // Ø§Ù„Ù…Ø¤Ø¬ÙˆØ± = 1ØŒ ØºÙŠØ± Ø§Ù„Ù…Ø¤Ø¬ÙˆØ± = 0
            let totalNumericDays = 0;
            let totalApprovedNumericDays = 0;
            attendance.forEach(att => {
                let dayValue = 0;
                if (att.status === 'full_day') {
                    dayValue = 1; // Ø­Ø¶ÙˆØ± ÙƒØ§Ù…Ù„ = 1
                } else if (att.status === 'partial') {
                    dayValue = getPartialEquivalentDays(att); // Ø­Ø¶ÙˆØ± Ø¬Ø²Ø¦ÙŠ = Ø­Ø³Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø§Øª
                } else if (att.status === 'excusedAbsent' || 
                          att.status === 'annualLeave' || 
                          att.status === 'sickLeave' || 
                          att.status === 'emergencyLeave' || 
                          att.status === 'unpaidLeave' || 
                          att.status === 'periodicLeave' ||
                          att.status === 'officialHoliday' || 
                          att.status === 'onMission') {
                    dayValue = 1; // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª (Ù…Ø¤Ø¬ÙˆØ±Ø©) = 1
                } else if (att.status === 'absent') {
                    dayValue = 0; // Ø§Ù„ØºÙŠØ§Ø¨ (ØºÙŠØ± Ù…Ø¤Ø¬ÙˆØ±) = 0
                }
                totalNumericDays += dayValue;
                if (att.approved === true) {
                    totalApprovedNumericDays += dayValue;
                }
            });
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            const stats = {
                full_day: attendance.filter(a => a.status === 'full_day').length,
                partial: attendance.filter(a => a.status === 'partial').length,
                absent: attendance.filter(a => a.status === 'absent').length,
                excused: attendance.filter(a => a.status === 'excusedAbsent').length,
                annual: attendance.filter(a => a.status === 'annualLeave').length,
                sick: attendance.filter(a => a.status === 'sickLeave').length,
                periodic: attendance.filter(a => a.status === 'periodicLeave').length,
                mission: attendance.filter(a => a.status === 'onMission').length
            };
            
            const totalWork = stats.full_day + stats.partial;
            const totalDays = attendance.length;
            const rate = totalDays > 0 ? Math.round((totalWork / totalDays) * 100) : 0;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠÙŠÙ†
            let totalSalary = null;
            let dailyWage = null;
            if (employee.type === 'daily') {
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                const fromDateObj = new Date(fromDate);
                const toDateObj = new Date(toDate);
                const reportMonth = fromDateObj.getMonth() + 1;
                const reportYear = fromDateObj.getFullYear();
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø¬Ø± ÙÙŠ wageHistory Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
                const wageHistory = employee.wageHistory || [];
                const monthWage = wageHistory.find(w => w.month === reportMonth && w.year === reportYear);
                
                if (monthWage) {
                    dailyWage = monthWage.wage;
                } else {
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø¬Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„Ù„Ø´Ù‡Ø±
                    dailyWage = employee.dailyWage || 0;
                }
                
                if (dailyWage > 0) {
                    totalSalary = dailyWage * totalApprovedNumericDays;
                }
            }
            
            resultsContainer.innerHTML = `
                <div class="card p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="font-bold text-xl">${employee.name}</h3>
                            <p class="text-gray-500">${employee.code} | ${t(employee.type)} | ${project?.name || '-'}</p>
                        </div>
                        <button onclick="printReportInNewTab()" class="no-print px-4 py-2 border rounded-lg hover:bg-gray-100">
                            ğŸ–¨ï¸ ${t('print')}
                        </button>
                    </div>
                    
                    ${employee.type === 'daily' && totalSalary !== null ? `
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 mb-1">${t('salaryCalculation')}</p>
                                <p class="text-sm text-gray-700">
                                    ${t('currentDailyWage')}: <span class="font-bold">${dailyWage.toFixed(2)} ${currentLanguage === 'ar' ? 'IQD' : 'IQD'}</span>
                                    Ã— ${totalApprovedNumericDays.toFixed(2)} ${currentLanguage === 'ar' ? 'ÙŠÙˆÙ… Ù…Ø¹ØªÙ…Ø¯' : 'approved days'}
                                </p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-600 mb-1">${t('totalSalary')}</p>
                                <p class="text-2xl font-bold text-blue-600">${totalSalary.toFixed(2)} ${currentLanguage === 'ar' ? 'IQD' : 'IQD'}</p>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-green-600">${stats.full_day}</p>
                            <p class="text-sm text-gray-500">${t('fullDay')}</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-yellow-600">${stats.partial}</p>
                            <p class="text-sm text-gray-500">${t('partial')}</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-red-600">${stats.absent}</p>
                            <p class="text-sm text-gray-500">${t('absent')}</p>
                        </div>
                        <div class="bg-primary-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-primary-600">${rate}%</p>
                            <p class="text-sm text-gray-500">${t('attendanceRate')}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 md:grid-cols-6 gap-2 mb-6 text-center text-sm">
                        <div class="p-2 bg-orange-50 rounded">ğŸŸ  ${t('excusedAbsent')}: ${stats.excused}</div>
                        <div class="p-2 bg-blue-50 rounded">ğŸ”µ ${t('annualLeave')}: ${stats.annual}</div>
                        <div class="p-2 bg-purple-50 rounded">ğŸŸ£ ${t('sickLeave')}: ${stats.sick}</div>
                        <div class="p-2 bg-cyan-50 rounded">ğŸ”· ${t('onMission')}: ${stats.mission}</div>
                    </div>
                    
                    <h4 class="font-bold mb-4">${t('details')}</h4>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-2 text-right">${t('date')}</th>
                                    <th class="px-4 py-2 text-right">${t('status')}</th>
                                    <th class="px-4 py-2 text-center">${currentLanguage === 'ar' ? 'Ø§Ù„Ø­Ø¶ÙˆØ± (Ø±Ù‚Ù…ÙŠ)' : 'Attendance (Numeric)'}</th>
                                    <th class="px-4 py-2 text-center">${t('approved')}</th>
                                    <th class="px-4 py-2 text-right">${t('notes')}</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${attendance.map(att => {
                                    const statusInfo = attendanceStatuses.employee.find(s => s.key === att.status);
                                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© (Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯)
                                    // Ø§Ù„Ù…Ø¤Ø¬ÙˆØ± = 1ØŒ ØºÙŠØ± Ø§Ù„Ù…Ø¤Ø¬ÙˆØ± = 0
                                    let numericValue = 0;
                                    if (att.status === 'full_day') {
                                        numericValue = 1; // Ø­Ø¶ÙˆØ± ÙƒØ§Ù…Ù„ = 1
                                    } else if (att.status === 'partial') {
                                        numericValue = getPartialEquivalentDays(att); // Ø­Ø¶ÙˆØ± Ø¬Ø²Ø¦ÙŠ = Ø­Ø³Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø§Øª
                                    } else if (att.status === 'excusedAbsent' || 
                                              att.status === 'annualLeave' || 
                                              att.status === 'sickLeave' || 
                                              att.status === 'emergencyLeave' || 
                                              att.status === 'unpaidLeave' || 
                                              att.status === 'periodicLeave' ||
                                              att.status === 'officialHoliday' || 
                                              att.status === 'onMission') {
                                        numericValue = 1; // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª (Ù…Ø¤Ø¬ÙˆØ±Ø©) = 1
                                    } else if (att.status === 'absent') {
                                        numericValue = 0; // Ø§Ù„ØºÙŠØ§Ø¨ (ØºÙŠØ± Ù…Ø¤Ø¬ÙˆØ±) = 0
                                    }
                                    
                                    return `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-2">${formatDate(new Date(att.date))}</td>
                                            <td class="px-4 py-2">
                                                <span class="inline-flex items-center gap-1">
                                                    ${statusInfo?.icon || ''} ${t(att.status)}
                                                </span>
                                            </td>
                                            <td class="px-4 py-2 text-center font-medium">${numericValue.toFixed(2)}</td>
                                            <td class="px-4 py-2 text-center">
                                                ${att.approved === true ? 
                                                    `<span class="text-green-600 font-medium">âœ“ ${t('approved')}</span>` : 
                                                    `<span class="text-gray-400">â—‹ ${t('notApproved')}</span>`
                                                }
                                            </td>
                                            <td class="px-4 py-2 text-gray-500">${att.note || '-'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                                <tr class="bg-gray-100 font-bold">
                                    <td class="px-4 py-2" colspan="2">${currentLanguage === 'ar' ? 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ' : 'Total'}</td>
                                    <td class="px-4 py-2 text-center text-primary-600">${totalNumericDays.toFixed(2)}</td>
                                    <td class="px-4 py-2 text-center">
                                        ${attendance.filter(a => a.approved === true).length} ${t('approved')} / ${attendance.length} ${currentLanguage === 'ar' ? 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ' : 'total'}
                                    </td>
                                    <td class="px-4 py-2"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
        } catch (error) {
            console.error('Error generating employee report:', error);
            resultsContainer.innerHTML = `<p class="text-red-500 text-center py-8">${t('error')}</p>`;
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function loadActivityLog() {
        const container = document.getElementById('page-activityLog');
        container.innerHTML = `<div class="text-center py-8"><div class="loader mx-auto"></div></div>`;
        try {
            const snap = await db.collection('activityLog').orderBy('timestamp', 'desc').limit(200).get();
            const items = [];
            snap.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
            const actionLabel = (a) => ({ create: t('actionCreate'), update: t('actionUpdate'), delete: t('actionDelete') }[a] || a);
            const entityLabel = (e) => ({ project: t('entityProject'), employee: t('entityEmployee'), vehicle: t('entityVehicle'), attendance: t('entityAttendance'), user: t('entityUser') }[e] || e);
            const formatTime = (ts) => {
                if (!ts || !ts.toDate) return 'â€”';
                const d = ts.toDate();
                return d.toLocaleString(currentLanguage === 'ar' ? 'ar-SA' : 'en-GB', { dateStyle: 'short', timeStyle: 'short' });
            };
            container.innerHTML = `
                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-4">${t('activityLog')}</h2>
                    ${items.length === 0 ? `<p class="text-gray-500 text-center py-8">${t('noActivityYet')}</p>` : `
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right border-collapse">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="py-3 px-2 font-medium text-gray-600">${t('activityTime')}</th>
                                    <th class="py-3 px-2 font-medium text-gray-600">${t('activityUser')}</th>
                                    <th class="py-3 px-2 font-medium text-gray-600">${t('activityAction')}</th>
                                    <th class="py-3 px-2 font-medium text-gray-600">${t('activityEntity')}</th>
                                    <th class="py-3 px-2 font-medium text-gray-600">${t('activityDescription')}</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(row => `
                                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                                        <td class="py-2 px-2 text-gray-600">${formatTime(row.timestamp)}</td>
                                        <td class="py-2 px-2 font-medium">${(row.userName || '').replace(/</g, '&lt;')}</td>
                                        <td class="py-2 px-2">${actionLabel(row.action)}</td>
                                        <td class="py-2 px-2">${entityLabel(row.entityType)}</td>
                                        <td class="py-2 px-2 text-gray-700">${((row.entityLabel || '') + (row.details ? ' â€” ' + row.details : '')).replace(/</g, '&lt;')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    `}
                </div>
            `;
        } catch (error) {
            console.error('Error loading activity log:', error);
            container.innerHTML = `<p class="text-red-500 text-center py-8">${t('error')}</p>`;
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¬ÙˆØ± Ø§Ù„Ø´Ù‡Ø±ÙŠØ© (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function loadMonthlyWageManagement() {
        const container = document.getElementById('page-monthlyWageManagement');
        container.innerHTML = `<div class="text-center py-8"><div class="loader mx-auto"></div></div>`;
        
        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…ØªØ§Ø­Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
            let availableProjects = [];
            if (currentUserData.role === 'supervisor' && currentUserData.assignedProjects && currentUserData.assignedProjects.length > 0) {
                const projectsSnap = await db.collection('projects').where(firebase.firestore.FieldPath.documentId(), 'in', currentUserData.assignedProjects).get();
                projectsSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.status !== 'hidden') {
                        availableProjects.push({ id: doc.id, ...data });
                    }
                });
            } else {
                const projectsSnap = await db.collection('projects').where('status', '!=', 'hidden').get();
                projectsSnap.forEach(doc => {
                    availableProjects.push({ id: doc.id, ...doc.data() });
                });
            }
            
            // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠÙŠÙ† Ù…Ø¹ ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…ØªØ§Ø­Ø©
            let employeesSnap;
            if (currentUserData.role === 'supervisor' && currentUserData.assignedProjects && currentUserData.assignedProjects.length > 0) {
                employeesSnap = await db.collection('employees')
                    .where('type', '==', 'daily')
                    .where('status', '==', 'active')
                    .where('projectId', 'in', currentUserData.assignedProjects)
                    .get();
            } else {
                employeesSnap = await db.collection('employees')
                    .where('type', '==', 'daily')
                    .where('status', '==', 'active')
                    .get();
            }
            
            const employees = [];
            employeesSnap.forEach(doc => {
                const data = doc.data();
                // Ù„Ù„Ù…Ø´Ø±Ù: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…ÙˆØ¸Ù ÙŠÙ†ØªÙ…ÙŠ Ù„Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø³Ù†Ø¯Ø© ÙÙ‚Ø·
                if (currentUserData.role === 'supervisor' && currentUserData.assignedProjects && currentUserData.assignedProjects.length > 0) {
                    if (currentUserData.assignedProjects.includes(data.projectId)) {
                        employees.push({ id: doc.id, ...data });
                    }
                } else {
                    employees.push({ id: doc.id, ...data });
                }
            });
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø«Ù… Ø§Ù„Ø§Ø³Ù…
            employees.sort((a, b) => {
                const projectA = window.projectsListData?.find(p => p.id === a.projectId)?.name || '';
                const projectB = window.projectsListData?.find(p => p.id === b.projectId)?.name || '';
                if (projectA !== projectB) return projectA.localeCompare(projectB);
                return a.name.localeCompare(b.name);
            });
            
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();
            
            const monthNames = currentLanguage === 'ar' 
                ? ['', 'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±']
                : ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            container.innerHTML = `
                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-6">${t('monthlyWageManagement')}</h2>
                    
                    <div class="mb-6 flex items-center gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${t('projects')}</label>
                            <select id="wage-project-filter" onchange="loadWageManagementData()" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                                <option value="all">${t('all')}</option>
                                ${availableProjects.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${t('month')}</label>
                            <select id="wage-month" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                                ${Array.from({ length: 12 }, (_, i) => i + 1).map(m => 
                                    `<option value="${m}" ${m === currentMonth ? 'selected' : ''}>${monthNames[m]}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${t('year')}</label>
                            <input type="number" id="wage-year" value="${currentYear}" min="2020" max="2100"
                                   class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                        </div>
                        <div class="flex items-end">
                            <button onclick="loadWageManagementData()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition">
                                ${t('search')}
                            </button>
                        </div>
                    </div>
                    
                    <div id="wage-management-table" class="overflow-x-auto">
                        ${generateWageManagementTable(employees, currentMonth, currentYear)}
                    </div>
                </div>
            `;
        } catch (error) {
            console.error('Error loading monthly wage management:', error);
            container.innerHTML = `<p class="text-red-500 text-center py-8">${t('error')}</p>`;
        }
    }
    
    function generateWageManagementTable(employees, month, year) {
        if (employees.length === 0) {
            return `<p class="text-gray-500 text-center py-8">${currentLanguage === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† ÙŠÙˆÙ…ÙŠÙŠÙ†' : 'No daily employees'}</p>`;
        }
        
        const monthNames = currentLanguage === 'ar' 
            ? ['', 'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±']
            : ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        
        return `
            <table class="w-full text-sm border-collapse">
                <thead>
                    <tr class="bg-gray-50 border-b">
                        <th class="px-4 py-3 text-right font-medium">${t('employeeName')}</th>
                        <th class="px-4 py-3 text-right font-medium">${t('projects')}</th>
                        <th class="px-4 py-3 text-center font-medium">${t('currentDailyWage')}</th>
                        <th class="px-4 py-3 text-center font-medium">${t('wageAmount')} (${currentLanguage === 'ar' ? 'IQD' : 'IQD'})</th>
                        <th class="px-4 py-3 text-center font-medium">${t('actions')}</th>
                    </tr>
                </thead>
                <tbody>
                    ${employees.map(emp => {
                        const project = window.projectsListData?.find(p => p.id === emp.projectId);
                        const currentWage = emp.dailyWage || 0;
                        const wageHistory = emp.wageHistory || [];
                        const monthWage = wageHistory.find(w => w.month === month && w.year === year);
                        const displayWage = monthWage ? monthWage.wage : currentWage;
                        
                        return `
                            <tr class="border-b hover:bg-gray-50" data-employee-id="${emp.id}">
                                <td class="px-4 py-3 font-medium">${emp.name}</td>
                                <td class="px-4 py-3">${project?.name || '-'}</td>
                                <td class="px-4 py-3 text-center">${currentWage.toFixed(2)} ${currentLanguage === 'ar' ? 'IQD' : 'IQD'}</td>
                                <td class="px-4 py-3 text-center">
                                    <input type="number" 
                                           id="wage-input-${emp.id}" 
                                           step="0.01" 
                                           min="0" 
                                           value="${displayWage.toFixed(2)}"
                                           class="w-32 px-3 py-1 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none text-center">
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <button onclick="saveMonthlyWage('${emp.id}', ${month}, ${year})" 
                                            class="px-3 py-1 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition text-sm">
                                        ${t('save')}
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
    }
    
    async function loadWageManagementData() {
        const month = parseInt(document.getElementById('wage-month').value);
        const year = parseInt(document.getElementById('wage-year').value);
        const projectFilter = document.getElementById('wage-project-filter').value;
        
        try {
            let employeesSnap;
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…ØªØ§Ø­Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
            let availableProjectIds = [];
            if (currentUserData.role === 'supervisor' && currentUserData.assignedProjects && currentUserData.assignedProjects.length > 0) {
                availableProjectIds = currentUserData.assignedProjects;
            } else {
                const projectsSnap = await db.collection('projects').where('status', '!=', 'hidden').get();
                projectsSnap.forEach(doc => {
                    availableProjectIds.push(doc.id);
                });
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
            let projectIdsToQuery = availableProjectIds;
            if (projectFilter !== 'all') {
                if (availableProjectIds.includes(projectFilter)) {
                    projectIdsToQuery = [projectFilter];
                } else {
                    projectIdsToQuery = [];
                }
            }
            
            if (projectIdsToQuery.length === 0) {
                document.getElementById('wage-management-table').innerHTML = `<p class="text-gray-500 text-center py-8">${currentLanguage === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† ÙŠÙˆÙ…ÙŠÙŠÙ†' : 'No daily employees'}</p>`;
                return;
            }
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø¹ ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…ØªØ§Ø­Ø©
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø¯ Firestore (10 Ù‚ÙŠÙ… ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ ÙÙŠ 'in')
            if (currentUserData.role === 'supervisor' && currentUserData.assignedProjects && currentUserData.assignedProjects.length > 0) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ > 10ØŒ Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø«Ù… ÙÙ„ØªØ±Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
                if (projectIdsToQuery.length > 10) {
                    employeesSnap = await db.collection('employees')
                        .where('type', '==', 'daily')
                        .where('status', '==', 'active')
                        .get();
                } else {
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† <= 10
                    employeesSnap = await db.collection('employees')
                        .where('type', '==', 'daily')
                        .where('status', '==', 'active')
                        .where('projectId', 'in', projectIdsToQuery)
                        .get();
                }
            } else {
                employeesSnap = await db.collection('employees')
                    .where('type', '==', 'daily')
                    .where('status', '==', 'active')
                    .get();
            }
            
            const employees = [];
            employeesSnap.forEach(doc => {
                const data = doc.data();
                // ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©
                if (projectFilter === 'all' || data.projectId === projectFilter) {
                    if (availableProjectIds.includes(data.projectId)) {
                        employees.push({ id: doc.id, ...data });
                    }
                }
            });
            
            employees.sort((a, b) => {
                const projectA = window.projectsListData?.find(p => p.id === a.projectId)?.name || '';
                const projectB = window.projectsListData?.find(p => p.id === b.projectId)?.name || '';
                if (projectA !== projectB) return projectA.localeCompare(projectB);
                return a.name.localeCompare(b.name);
            });
            
            document.getElementById('wage-management-table').innerHTML = generateWageManagementTable(employees, month, year);
        } catch (error) {
            console.error('Error loading wage management data:', error);
            showToast(t('error'), 'error');
        }
    }
    
    async function saveMonthlyWage(employeeId, month, year) {
        const wageInput = document.getElementById(`wage-input-${employeeId}`);
        if (!wageInput) return;
        
        const wage = parseFloat(wageInput.value);
        if (isNaN(wage) || wage < 0) {
            showToast(currentLanguage === 'ar' ? 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø©' : 'Please enter a valid value', 'error');
            return;
        }
        
        try {
            const empDoc = await db.collection('employees').doc(employeeId).get();
            if (!empDoc.exists) {
                showToast(t('error'), 'error');
                return;
            }
            
            const empData = empDoc.data();
            const wageHistory = empData.wageHistory || [];
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø¬Ù„ Ù…ÙˆØ¬ÙˆØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±
            const existingIndex = wageHistory.findIndex(w => w.month === month && w.year === year);
            
            if (existingIndex >= 0) {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                wageHistory[existingIndex].wage = wage;
                wageHistory[existingIndex].updatedAt = firebase.firestore.FieldValue.serverTimestamp();
            } else {
                // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯
                wageHistory.push({
                    month,
                    year,
                    wage,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();
            
            const updateData = {
                wageHistory,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (month === currentMonth && year === currentYear) {
                updateData.dailyWage = wage;
            }
            
            await db.collection('employees').doc(employeeId).update(updateData);
            
            showToast(t('saved'), 'success');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
            loadWageManagementData();
        } catch (error) {
            console.error('Error saving monthly wage:', error);
            showToast(t('error'), 'error');
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function loadUsers() {
        const container = document.getElementById('page-users');
        
        if (currentUserData.role !== 'manager') {
            container.innerHTML = `<p class="text-center py-8 text-red-500">ØºÙŠØ± Ù…ØµØ±Ø­</p>`;
            return;
        }
        
        container.innerHTML = `<div class="text-center py-8"><div class="loader mx-auto"></div></div>`;
        
        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            const usersSnap = await db.collection('users').get();
            const users = [];
            usersSnap.forEach(doc => users.push({ id: doc.id, ...doc.data() }));
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
            const projectsSnap = await db.collection('projects').get();
            const projects = [];
            projectsSnap.forEach(doc => {
                const data = doc.data();
                if (data.status !== 'hidden') {
                    projects.push({ id: doc.id, ...data });
                }
            });
            
            container.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold">${t('users')} (${users.length})</h2>
                    <button onclick="openUserModal()" class="bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        ${t('addUser')}
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${users.map(user => {
                        const assignedProjectNames = user.assignedProjects?.map(pid => {
                            const p = projects.find(pr => pr.id === pid);
                            return p?.name;
                        }).filter(Boolean).join(', ') || t('all');
                        
                        return `
                            <div class="card p-5">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="w-12 h-12 bg-primary-100 rounded-full flex items-center justify-center">
                                        <span class="text-primary-600 font-bold text-lg">${user.name?.charAt(0) || 'U'}</span>
                                    </div>
                                    <span class="px-2 py-1 text-xs rounded-full ${user.role === 'manager' ? 'bg-purple-100 text-purple-600' : 'bg-blue-100 text-blue-600'}">
                                        ${t(user.role)}
                                    </span>
                                </div>
                                
                                <h3 class="font-bold">${user.name}</h3>
                                <p class="text-sm text-gray-500 mb-2">${user.email}</p>
                                
                                ${user.role === 'supervisor' ? `
                                <div class="text-sm">
                                    <span class="text-gray-500">${t('assignedProjects')}:</span>
                                    <p class="font-medium">${assignedProjectNames}</p>
                                </div>
                                ` : ''}
                                
                                <div class="flex gap-2 mt-4 pt-4 border-t">
                                    <button onclick="openUserModal('${user.id}')" class="flex-1 px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                                        ${t('edit')}
                                    </button>
                                    ${user.id !== currentUser.uid ? `
                                    <button onclick="deleteUser('${user.id}')" class="px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg transition">
                                        ğŸ—‘ï¸
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            window.usersListData = users;
            window.projectsListData = projects;
            
        } catch (error) {
            console.error('Error loading users:', error);
            container.innerHTML = `<p class="text-red-500 text-center py-8">${t('error')}</p>`;
        }
    }
    
    async function openUserModal(userId = null) {
        let user = null;
        let title = t('addUser');
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ØªÙˆÙØ±Ø©
        let projects = window.projectsListData || [];
        if (projects.length === 0) {
            try {
                const projectsSnap = await db.collection('projects').get();
                projectsSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.status !== 'hidden') {
                        projects.push({ id: doc.id, ...data });
                    }
                });
                window.projectsListData = projects;
            } catch (e) {
                console.error('Error loading projects for modal:', e);
            }
        }
        
        if (userId) {
            const doc = await db.collection('users').doc(userId).get();
            if (doc.exists) {
                user = { id: doc.id, ...doc.data() };
                title = t('editUser');
            }
        }
        
        const content = `
            <form id="user-form" class="space-y-4">
                <input type="hidden" id="user-id" value="${user?.id || ''}">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('userName')} *</label>
                    <input type="text" id="user-name" required value="${user?.name || ''}"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('userEmail')} *</label>
                    <input type="email" id="user-email" required value="${user?.email || ''}" ${user ? 'readonly' : ''}
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none ${user ? 'bg-gray-100' : ''}">
                </div>
                
                ${!user ? `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('password')} *</label>
                    <input type="password" id="user-password" required minlength="6"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                </div>
                ` : ''}
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('userRole')} *</label>
                    <select id="user-role" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none" onchange="toggleProjectsField()">
                        <option value="supervisor" ${user?.role === 'supervisor' ? 'selected' : ''}>${t('supervisor')}</option>
                        <option value="approver" ${user?.role === 'approver' ? 'selected' : ''}>${t('approver')}</option>
                        <option value="manager" ${user?.role === 'manager' ? 'selected' : ''}>${t('manager')}</option>
                    </select>
                </div>
                
                <div id="projects-field" class="${user?.role === 'manager' ? 'hidden' : ''}">
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('assignedProjects')} *</label>
                    <div class="border rounded-lg p-3 max-h-48 overflow-y-auto space-y-2">
                        ${projects.map(p => `
                            <label class="flex items-center gap-2">
                                <input type="checkbox" name="user-projects" value="${p.id}" 
                                       ${user?.assignedProjects?.includes(p.id) ? 'checked' : ''}
                                       class="rounded border-gray-300">
                                ${p.name}
                            </label>
                        `).join('')}
                    </div>
                </div>
            </form>
        `;
        
        const footer = `
            <button onclick="closeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-100 transition">${t('cancel')}</button>
            <button onclick="saveUser()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition">${t('save')}</button>
        `;
        
        openModal(title, content, footer);
    }
    
    function toggleProjectsField() {
        const roleEl = document.getElementById('user-role');
        const projectsField = document.getElementById('projects-field');
        if (roleEl && projectsField) {
            projectsField.classList.toggle('hidden', roleEl.value === 'manager');
        }
    }
    
    async function saveUser() {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£ÙˆÙ„Ø§Ù‹
        const form = document.getElementById('user-form');
        if (!form) {
            console.error('User form not found - modal may not be open');
            showToast(t('error'), 'error');
            return;
        }
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        const idEl = form.querySelector('#user-id');
        const nameEl = form.querySelector('#user-name');
        const emailEl = form.querySelector('#user-email');
        const roleEl = form.querySelector('#user-role');
        
        // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±
        if (!nameEl || !emailEl || !roleEl) {
            console.error('User form elements not found:', { nameEl, emailEl, roleEl });
            showToast(t('error'), 'error');
            return;
        }
        
        const id = idEl?.value || '';
        const name = (nameEl.value || '').trim();
        const email = (emailEl.value || '').trim();
        const role = roleEl.value || 'supervisor';
        const assignedProjects = role === 'supervisor' ? 
            Array.from(document.querySelectorAll('input[name="user-projects"]:checked')).map(cb => cb.value) : null;
        
        if (!name || !email) {
            showToast(t('required'), 'error');
            return;
        }
        
        try {
            if (id) {
                // ØªØ¹Ø¯ÙŠÙ„
                await db.collection('users').doc(id).update({
                    name,
                    role,
                    assignedProjects,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                logActivity('update', 'user', id, name, currentLanguage === 'ar' ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…' : 'User updated');
            } else {
                // Ø¥Ø¶Ø§ÙØ© - Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙÙŠ Auth Ø£ÙˆÙ„Ø§Ù‹
                const passwordEl = document.getElementById('user-password');
                const password = passwordEl?.value || '';
                if (!password || password.length < 6) {
                    showToast(currentLanguage === 'ar' ? 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„' : 'Password must be at least 6 characters', 'error');
                    return;
                }
                
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                await db.collection('users').doc(userCredential.user.uid).set({
                    email,
                    name,
                    role,
                    assignedProjects,
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid
                });
                logActivity('create', 'user', userCredential.user.uid, name, currentLanguage === 'ar' ? 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…' : 'User created');
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø­Ø§Ù„ÙŠ
                await auth.signInWithEmailAndPassword(currentUser.email, prompt(currentLanguage === 'ar' ? 'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±Ùƒ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:' : 'Enter your password to re-login:'));
            }
            
            closeModal();
            showToast(t('saved'), 'success');
            loadUsers();
            
        } catch (error) {
            console.error('Error saving user:', error);
            if (error.code === 'auth/email-already-in-use') {
                showToast(currentLanguage === 'ar' ? 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„' : 'Email already in use', 'error');
            } else {
                showToast(t('error'), 'error');
            }
        }
    }
    
    async function deleteUser(userId) {
        if (!confirm(t('confirmDelete'))) return;
        
        try {
            const userDoc = await db.collection('users').doc(userId).get();
            const userName = userDoc.exists ? userDoc.data().name : userId;
            await db.collection('users').doc(userId).delete();
            logActivity('delete', 'user', userId, userName, currentLanguage === 'ar' ? 'Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…' : 'User deleted');
            showToast(t('deleted'), 'success');
            loadUsers();
        } catch (error) {
            console.error('Error deleting user:', error);
            showToast(t('error'), 'error');
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function loadSettings() {
        const container = document.getElementById('page-settings');
        
        container.innerHTML = `
            <div class="max-w-2xl mx-auto">
                <div class="card p-6 mb-6">
                    <h3 class="font-bold text-lg mb-4">ğŸ‘¤ ${t('info')}</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-500">${t('userName')}</label>
                            <p class="font-medium">${currentUserData?.name}</p>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-500">${t('userEmail')}</label>
                            <p class="font-medium">${currentUserData?.email}</p>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-500">${t('userRole')}</label>
                            <p class="font-medium">${t(currentUserData?.role)}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6 mb-6">
                    <h3 class="font-bold text-lg mb-4">ğŸŒ ${currentLanguage === 'ar' ? 'Ø§Ù„Ù„ØºØ©' : 'Language'}</h3>
                    <div class="flex gap-4">
                        <button onclick="setLanguage('ar')" class="flex-1 p-4 border-2 rounded-lg ${currentLanguage === 'ar' ? 'border-primary-500 bg-primary-50' : 'border-gray-200 hover:bg-gray-50'}">
                            <span class="text-2xl mb-2 block">ğŸ‡¸ğŸ‡¦</span>
                            <span class="font-medium">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span>
                        </button>
                        <button onclick="setLanguage('en')" class="flex-1 p-4 border-2 rounded-lg ${currentLanguage === 'en' ? 'border-primary-500 bg-primary-50' : 'border-gray-200 hover:bg-gray-50'}">
                            <span class="text-2xl mb-2 block">ğŸ‡¬ğŸ‡§</span>
                            <span class="font-medium">English</span>
                        </button>
                    </div>
                </div>
                
                <div class="card p-6">
                    <h3 class="font-bold text-lg mb-4">ğŸ” ${currentLanguage === 'ar' ? 'ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±' : 'Change Password'}</h3>
                    <form onsubmit="changePassword(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${currentLanguage === 'ar' ? 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©' : 'Current Password'}</label>
                            <input type="password" id="current-password" required
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${currentLanguage === 'ar' ? 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©' : 'New Password'}</label>
                            <input type="password" id="new-password" required minlength="6"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${currentLanguage === 'ar' ? 'ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±' : 'Confirm Password'}</label>
                            <input type="password" id="confirm-password" required
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                        </div>
                        <button type="submit" class="w-full py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition">
                            ${t('save')}
                        </button>
                    </form>
                </div>
            </div>
        `;
    }
    
    function setLanguage(lang) {
        currentLanguage = lang;
        localStorage.setItem('language', lang);
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
        updateTranslations();
        loadSettings();
    }
    
    async function changePassword(e) {
        e.preventDefault();
        
        const currentPasswordEl = document.getElementById('current-password');
        const newPasswordEl = document.getElementById('new-password');
        const confirmPasswordEl = document.getElementById('confirm-password');
        
        if (!currentPasswordEl || !newPasswordEl || !confirmPasswordEl) {
            showToast(t('error'), 'error');
            return;
        }
        
        const currentPassword = currentPasswordEl.value || '';
        const newPassword = newPasswordEl.value || '';
        const confirmPassword = confirmPasswordEl.value || '';
        
        if (newPassword !== confirmPassword) {
            showToast(currentLanguage === 'ar' ? 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©' : 'Passwords do not match', 'error');
            return;
        }
        
        try {
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
            const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, currentPassword);
            await currentUser.reauthenticateWithCredential(credential);
            
            // ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
            await currentUser.updatePassword(newPassword);
            
            showToast(t('saved'), 'success');
            e.target.reset();
            
        } catch (error) {
            console.error('Error changing password:', error);
            if (error.code === 'auth/wrong-password') {
                showToast(currentLanguage === 'ar' ? 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©' : 'Current password is incorrect', 'error');
            } else {
                showToast(t('error'), 'error');
            }
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function initializeApp() {
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        document.documentElement.lang = currentLanguage;
        document.documentElement.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';
        updateTranslations();
        
        try {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø¯ÙŠØ±
            await checkAndCreateAdmin();
            
            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
            auth.onAuthStateChanged(async (user) => {
                document.getElementById('loading-screen').classList.add('hidden');
                
                if (user) {
                    // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡
                    try {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            currentUser = user;
                            currentUserData = userDoc.data();
                            updateUIForUser();
                            document.getElementById('app').classList.remove('hidden');
                            showPage('dashboard');
                        } else {
                            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©
                            await auth.signOut();
                            document.getElementById('login-screen').classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error('Error fetching user data:', error);
                        document.getElementById('login-screen').classList.remove('hidden');
                    }
                } else {
                    // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡
                    document.getElementById('login-screen').classList.remove('hidden');
                }
            });
            
        } catch (error) {
            console.error('Error initializing app:', error);
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }
    }
    
    // Ù…Ø¹Ø§Ù„Ø¬ Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const errorDiv = document.getElementById('login-error');
        const spinner = document.getElementById('login-spinner');
        const btnText = document.getElementById('login-btn-text');
        
        // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        errorDiv.classList.add('hidden');
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        spinner.classList.remove('hidden');
        btnText.textContent = t('loading');
        
        try {
            await login(email, password);
        } catch (error) {
            errorDiv.textContent = t('loginError');
            errorDiv.classList.remove('hidden');
        } finally {
            spinner.classList.add('hidden');
            btnText.textContent = t('login');
        }
    });
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.dropdown')) {
            document.querySelectorAll('.dropdown-content').forEach(d => {
                d.classList.remove('show');
            });
        }
    });
    
    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    initializeApp();
    </script>
</body>
</html>
